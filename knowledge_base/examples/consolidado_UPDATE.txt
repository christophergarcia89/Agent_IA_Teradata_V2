UPDATE - Ejemplo 1 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: CAMBIA LOS FILTROS DE RIESGO PARA EL PO DE PROPENSOS MX					  **
--**                                                    				 				  **
--** AUTOR  : FRANCISCO PINOCHET                                               	  		    **
--** EMPRESA: FACTORIT                                   				  				                **
--** FECHA  : 03/2024                                                   				          **
--/*****************************************************************************************
--/*****************************************************************************************
--** MANTNCN: 														                                                **
--** AUTOR  : 				                                                           	        **
--** FECHA  : 			                                                  				            **
--/*****************************************************************************************
--/*****************************************************************************************
--**TABLA DE ENTRADA:	 																  
--**					MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP                
--**					MKT_JOURNEYBUILDER_TB.P_CMP_MAE_CALIF_SBIF               	  
--**					MKT_JOURNEYBUILDER_TB.P_CMP_MAE_FDR		              	  
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP			          
--**					MKT_JOURNEYBUILDER_TB.P_CMP_MAE_NO_CONTACTAR			  	  
--**					MKT_JOURNEYBUILDER_TB.P_CMP_MAE_MAPEO				      	  
--**																					  
--**TABLAS TEMPORALES:	
--**					{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PARAMETRO;
--**					{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_PO_CALIF;
--**					{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_COS_CLI;
--**					{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PO_RUT;
--**					{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_MOL;      
--**TABLA DE SALIDA:    							                	                  
--**                  	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES      	  
--**																					  
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARAMETROS									  **  
--*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PARAMETRO;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PARAMETRO
(
	 TC_CALIFICACION		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CALIFICACIONM		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PI					DECIMAL(18,8)
	,TE_FDR					INTEGER
	,TE_COS					INTEGER
) PRIMARY INDEX (TC_CALIFICACION)
;
.IF ERRORCODE <> 0 THEN .QUIT 001;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PARAMETRO
SELECT 
	 SC_CALIFICACION	AS TC_CALIFICACION	
	,SC_CALIFICACIONM	AS TC_CALIFICACIONM	
	,SD_PI				AS TD_PI				
	,SE_FDR				AS TE_FDR				
	,SE_COS				AS TE_COS				
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP
WHERE
	SC_CAMPANA = 'PROPENSOS_MX'
;
.IF ERRORCODE <> 0 THEN .QUIT 002;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_CALIFICACION)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PARAMETRO;
.IF ERRORCODE <> 0 THEN .QUIT 003;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE PROPENSOS MX P_CAMPANA_PROPENSO_MX_NEW_MES	  **  
--** CAMPOS PAR_CALIFICACION_SBIF, PAR_PI_CLIENTE, PAR_FDR Y PAR_COS_CLI  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES 
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PARAMETRO AS PAR
SET 
	 PC_PAR_CALIFICACION_SBIF = 
		CASE WHEN PAR.TC_CALIFICACION IS NULL 
				THEN 'NULL' 
				ELSE PAR.TC_CALIFICACIONM
		END
	,PD_PAR_PI_CLIENTE = PAR.TD_PI
	,PE_PAR_FDR 		= PAR.TE_FDR
	,PE_PAR_COS_CLI 	= PAR.TE_COS
;
.IF ERRORCODE <> 0 THEN .QUIT 004;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL CON PO CRUZADA CON CALIFICACIONES SBIF, SI LA **
--** CALIFICACION ES NULA, SE CAMBIA POR 0.								  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_PO_CALIF;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_PO_CALIF
(
	 TD_RUT				DECIMAL(8,0)
	,TC_CALIFICACION	VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TF_PERIODO			DATE FORMAT 'YYYY-MM-DD'
	,TC_CLASIFICACION	VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PI				DECIMAL(18,8)
) PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 5;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_PO_CALIF
SELECT
	 CFP.PD_RUT								AS TD_RUT
	,COALESCE(CAL.PC_CALIFICACION_SBIF,'0')	AS TC_CALIFICACION
	,CAL.PF_PERIODO_CALIFICACION_SBIF		AS TF_PERIODO
	,CAL.PC_CLASIFICACION_SBIF				AS TC_CLASIFICACION
	,COALESCE(CAL.PD_PI_CLIENTE,0)			AS TD_PI
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES AS CFP
	LEFT JOIN MKT_JOURNEYBUILDER_TB.P_CMP_MAE_CALIF_SBIF AS CAL
		ON CFP.PD_RUT = CAL.PE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 006;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_PO_CALIF;
.IF ERRORCODE <> 0 THEN .QUIT 007;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE PROPENSOS MX P_CAMPANA_PROPENSO_MX_NEW_MES	  **  
--** CAMPOS CALIFICACION_SBIF, PERIODO_CALIFICACION, CLASIFICACION_SBIF Y **
--** PI_CLIENTE															  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES 
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_PO_CALIF AS CAL
SET 
	PC_CALIFICACION_SBIF 	= CAL.TC_CALIFICACION
  , PF_PERIODO_CALIFICACION = CAL.TF_PERIODO
  , PC_CLASIFICACION_SBIF 	= CAL.TC_CLASIFICACION
  , PD_PI_CLIENTE 			= CAL.TD_PI
WHERE
	PD_RUT = CAL.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 008;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE PROPENSOS MX P_CAMPANA_PROPENSO_MX_NEW_MES	  **  
--** CAMPO FDR															  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES 
FROM
	MKT_JOURNEYBUILDER_TB.P_CMP_MAE_FDR AS MFR
SET 
	PE_FDR = MFR.PE_FDR 
WHERE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES.PD_RUT = MFR.PE_CLI_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 009;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA CCEE_Y_RIP CRUZADA CON PO PARA SACAR	  **  
--** INDICADOR COS_CLI													  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_COS_CLI;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_COS_CLI
(
	 TD_RUT			DECIMAL(8,0)
	,TE_COS_CLI		INTEGER
) PRIMARY INDEX (TD_RUT, TE_COS_CLI)
;
.IF ERRORCODE <> 0 THEN .QUIT 010;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_COS_CLI
SELECT
	 CFP.PD_RUT		AS TD_RUT
	,CASE WHEN RIP.SE_CLIENTE_RUT IS NULL 
			THEN 0 
			ELSE 1 
	END				AS TE_COS_CLI
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES AS CFP
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP AS RIP
		ON CFP.PD_RUT = RIP.SE_CLIENTE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 011;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT, TE_COS_CLI)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_COS_CLI;
	
.IF ERRORCODE <> 0 THEN .QUIT 012;
	
--/*************************************************************************
--** SE ACTUALIZA TABLA DE PROPENSOS MX P_CAMPANA_PROPENSO_MX_NEW_MES	  **  
--** CAMPO COS_CLI														  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES 
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_COS_CLI AS FCC
SET 
	PE_COS_CLI = FCC.TE_COS_CLI
WHERE
	PD_RUT = FCC.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 013;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL CON RUT UNICOS DE PO, DONDE ELLOS CUMPLAN     **
--** LAS CONDICIONES DE LOS FILTROS DE RIESGO. SE UTILIZA FILTRO DE		  **  
--** **CALIFICACION_SBIF**												  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PO_RUT;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PO_RUT
(
	 TD_RUT			DECIMAL(8,0)
) PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 14;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PO_RUT
SELECT
	CFP.PD_RUT	AS TD_RUT
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES AS CFP
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PARAMETRO AS PAR
		ON POSITION(PC_CALIFICACION_SBIF IN PAR.TC_CALIFICACION) > 0
			AND PD_PI_CLIENTE  <= PAR.TD_PI
			AND PE_FDR >= PAR.TE_FDR
			AND PE_COS_CLI = PAR.TE_COS
;
.IF ERRORCODE <> 0 THEN .QUIT 015;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PO_RUT;
.IF ERRORCODE <> 0 THEN .QUIT 016;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE PROPENSOS MX P_CAMPANA_PROPENSO_MX_NEW_MES	  **  
--** CAMPO FILTROS_RIESGOS.												  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES 
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PO_RUT AS POR
SET 
	PE_FILTROS_RIESGOS = 1
WHERE
	PD_RUT = POR.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 017;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA CLIENTES PO NO_CONTACTAR, REGISTRANDO 	  **  
--** INDICADOR MOLESTO													  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_MOL;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_MOL
(
	 TD_RUT			DECIMAL(8,0)
	,TE_MOLESTO		INTEGER
) PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 018;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_MOL
SELECT
	 CFP.PD_RUT	AS TD_RUT
	,CASE WHEN MOL.PE_RUT IS NULL 
			THEN 0 
			ELSE 1 
	END				AS TE_MOLESTO
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES AS CFP
	LEFT JOIN MKT_JOURNEYBUILDER_TB.P_CMP_MAE_NO_CONTACTAR AS MOL
		ON CFP.PD_RUT = MOL.PE_RUT
QUALIFY ROW_NUMBER() OVER(PARTITION BY CFP.PD_RUT ORDER BY CFP.PD_RUT  DESC) = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 019;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_MOL;
.IF ERRORCODE <> 0 THEN .QUIT 020;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE PROPENSOS MX P_CAMPANA_PROPENSO_MX_NEW_MES	  **  
--** CAMPO MOLESTO.														  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES 
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_MOL AS MOL
SET
	PE_MOLESTO = MOL.TE_MOLESTO
WHERE
	PD_RUT = MOL.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 021;
	

--/*************************************************************************
--** SE ACTUALIZA TABLA DE PROPENSOS MX P_CAMPANA_PROPENSO_MX_NEW_MES	  **  
--** CAMPO EN_PLANEAMIENTO.												  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES 
FROM
	MKT_JOURNEYBUILDER_TB.P_CMP_MAE_MAPEO AS MMP
SET
	 PE_EN_PLANEAMIENTO = 1
	,PC_RECOMENDACION_DE_CRUCE = MMP.PC_RECOMENDACION_DE_CRUCE
WHERE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES.PD_RUT = MMP.PE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 022;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES;
.IF ERRORCODE <> 0 THEN .QUIT 023;

SELECT DATE, TIME; 

.LOGOFF;
.QUIT 0;

UPDATE - Ejemplo 1 OK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: CAMBIA LOS FILTROS DE RIESGO PARA EL PO DE PROPENSOS MX					  **
--**                                                    				 				  **
--** AUTOR  : FRANCISCO PINOCHET                                               	  		  **
--** EMPRESA: FACTORIT                                   				  				  **
--** FECHA  : 03/2024                                                   				  **
--/*****************************************************************************************
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 08/2024			     	                                                  **
--/*****************************************************************************************
--/*****************************************************************************************
--**TABLA DE ENTRADA:	 																  
--**					MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP                
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CALIF_SBIF               	  
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_FDR		              	  
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP			          
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_NO_CONTACTAR			  	  
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO	 	
--**					{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_PO	  		  		      	  
--**																					  
--**TABLAS TEMPORALES:	
--**					{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_01
--** 					{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_02
--** 					{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_03    
--**			
--**TABLA DE SALIDA:    							                	                  
--**                  	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_FR      	  
--**																					  
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/*************************************************************************
--** SE CREA TABLA TEMPORAL 											  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_01
(
	 TD_RUT 							DECIMAL(8,0)
	,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PO_DEUDA						INTEGER
	,TE_CTACTE							INTEGER
	,TE_LCG_VIGENTE						INTEGER
	,TE_LME_VIGENTE 					INTEGER	
	,TE_DISPONIBLE_MX_NEW				BIGINT
	,TC_MACRO_BANCA     				VARCHAR(16) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_LCG_RENOV_SIN_DISP				INTEGER
	,TE_CURSE_ULT_3M					INTEGER
	,TE_FLG_EXCLUSION					INTEGER
	,TC_MOTIVO_EXCLUSION				VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO1							VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2  						VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3  						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_EN_PLANEAMIENTO					INTEGER 			
    ,TC_CALIFICACION_SBIF          		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,TF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,TD_PI_CLIENTE                		DECIMAL(25,10) 			
	,TC_CLASIFICACION_SBIF       		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FDR                      		INTEGER 			
	,TE_COS_CLI                 		INTEGER 			
	,TE_FILTROS_RIESGOS          		INTEGER 			
	,TC_PAR_CALIFICACION_SBIF    		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE           		DECIMAL(25,10) 		
	,TE_PAR_FDR                  		INTEGER 			
	,TE_PAR_COS_CLI             		INTEGER 		
	,TE_MOLESTO               			INTEGER 			
	,TE_CARGABLE						INTEGER
	,TC_ELIMINADO						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DISPONIBLE_OK               	INTEGER
	,TE_ENROLADO_360            		INTEGER
	,TE_HABILITADO_360           		INTEGER
	,TE_ACTIVO_360               		INTEGER
	,TE_ESTADO_MULTIPASS        		INTEGER
	,TE_MANDATO_CCL              		INTEGER
	,TE_SIN_APR                 		INTEGER
	,TE_ART85                     		INTEGER
	,TE_FYP                    			INTEGER
	,TE_READY_CCL              			INTEGER
	,TE_TOTAL_HABILITADORES       		INTEGER
	,TC_FECHA_HAB 						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC 	
	,TE_CMP_MANDATO_CCL					INTEGER
	,TE_CMP_CTO_BEX						INTEGER
	,TE_CMP_MIGRACION               	INTEGER
	,TE_CMP_PROPENSO_MX             	INTEGER
	,TE_CMP_FOGAPE_REACTIVA         	INTEGER
	,TC_EJE_CAMP						VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PRIORIDAD                   	INTEGER
	,TE_MTO_CMP    						BIGINT
	,TE_IND_BANQUERO_SOLO_MX			BYTEINT	
	,TE_IND_CAMPANA						BYTEINT
)PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 001;

--/*************************************************************************
--** SE INSERTA EN TABLA TEMPORAL PARA ACTUALIZAR LOS CAMPOS DE PROPENSOS 
--*************************************************************************/
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_01
SELECT 
	 PPE.PD_RUT 									AS TD_RUT 					
	,PPE.PC_RECOMENDACION_DE_CRUCE					AS TC_RECOMENDACION_DE_CRUCE
	,PPE.PE_PO_DEUDA 								AS TE_PO_DEUDA
	,PPE.PE_CTACTE 									AS TE_CTACTE
	,PPE.PE_LCG_VIGENTE 							AS TE_LCG_VIGENTE
	,PPE.PE_LME_VIGENTE 							AS TE_LME_VIGENTE
	,PPE.PE_DISPONIBLE_MX_NEW						AS TE_DISPONIBLE_MX_NEW
	,PPE.PC_MACRO_BANCA								AS TC_MACRO_BANCA 		
	,PPE.PE_LCG_RENOV_SIN_DISP 						AS TE_LCG_RENOV_SIN_DISP
	,PPE.PE_CURSE_ULT_3M            				AS TE_CURSE_ULT_3M
	,PPE.PE_FLG_EXCLUSION           				AS TE_FLG_EXCLUSION
	,PPE.PC_MOTIVO_EXCLUSION        				AS TC_MOTIVO_EXCLUSION
	,PPE.PC_TEXTO1                  				AS TC_TEXTO1
	,PPE.PC_TEXTO2                  				AS TC_TEXTO2
	,PPE.PC_TEXTO3                  				AS TC_TEXTO3
	,PPE.PE_EN_PLANEAMIENTO         	        	AS TE_EN_PLANEAMIENTO

    ,COALESCE(CAL.IC_CALIFICACION_SBIF,'0')         AS TC_CALIFICACION_SBIF
	,CAL.IF_PERIODO_CALIFICACION_SBIF          		AS TF_PERIODO_CALIFICACION 	
	,COALESCE(CAL.ID_PI_CLIENTE,0)             		AS TD_PI_CLIENTE 
	,CAL.IC_CLASIFICACION_SBIF              		AS TC_CLASIFICACION_SBIF 	

	,CASE WHEN MFR.IE_CLI_RUT IS NOT NULL 
			THEN MFR.IE_FDR
			ELSE 0 END 								AS TE_FDR 
              				 
	,CASE WHEN RIP.SE_CLIENTE_RUT IS NOT NULL 
			THEN 1 
			ELSE 0 END 								AS TE_COS_CLI

	,PPE.PE_FILTROS_RIESGOS         				AS TE_FILTROS_RIESGOS
	,PPE.PC_PAR_CALIFICACION_SBIF					AS TC_PAR_CALIFICACION_SBIF
	,PPE.PD_PAR_PI_CLIENTE				            AS TD_PAR_PI_CLIENTE 
	,PPE.PE_PAR_FDR		                         	AS TE_PAR_FDR 
	,PPE.PE_PAR_COS_CLI			                    AS TE_PAR_COS_CLI 	

	,CASE WHEN MOL.IE_RUT IS NOT NULL 
			THEN 1 
			ELSE 0 	END								AS TE_MOLESTO

	,PPE.PE_CARGABLE                				AS TE_CARGABLE
    ,PPE.PC_ELIMINADO	           					AS TC_ELIMINADO	
	,PPE.PE_DISPONIBLE_OK           				AS TE_DISPONIBLE_OK
	,PPE.PE_ENROLADO_360            				AS TE_ENROLADO_360
	,PPE.PE_HABILITADO_360          				AS TE_HABILITADO_360
	,PPE.PE_ACTIVO_360              				AS TE_ACTIVO_360
	,PPE.PE_ESTADO_MULTIPASS        				AS TE_ESTADO_MULTIPASS
	,PPE.PE_MANDATO_CCL             				AS TE_MANDATO_CCL
	,PPE.PE_SIN_APR                 				AS TE_SIN_APR
	,PPE.PE_ART85                   				AS TE_ART85
	,PPE.PE_FYP                     				AS TE_FYP
	,PPE.PE_READY_CCL               				AS TE_READY_CCL
	,PPE.PE_TOTAL_HABILITADORES     				AS TE_TOTAL_HABILITADORES
	,PPE.PC_FECHA_HAB 								AS TC_FECHA_HAB
	,PPE.PE_CMP_MANDATO_CCL         				AS TE_CMP_MANDATO_CCL
	,PPE.PE_CMP_CTO_BEX             				AS TE_CMP_CTO_BEX
	,PPE.PE_CMP_MIGRACION           				AS TE_CMP_MIGRACION
	,PPE.PE_CMP_PROPENSO_MX         				AS TE_CMP_PROPENSO_MX
	,PPE.PE_CMP_FOGAPE_REACTIVA     				AS TE_CMP_FOGAPE_REACTIVA
	,PPE.PC_EJE_CAMP								AS TC_EJE_CAMP
	,PPE.PE_PRIORIDAD 								AS TE_PRIORIDAD
	,PPE.PE_MTO_CMP							 		AS TE_MTO_CMP
	,PPE.PE_IND_BANQUERO_SOLO_MX					AS TE_IND_BANQUERO_SOLO_MX	
	,PPE.PE_IND_CAMPANA 							AS TE_IND_CAMPANA	
	FROM {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_PO  PPE
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CALIF_SBIF CAL
		ON PPE.PD_RUT = CAL.IE_RUT
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_FDR MFR		
		ON PPE.PD_RUT = MFR.IE_CLI_RUT
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP RIP
		ON PPE.PD_RUT = RIP.SE_CLIENTE_RUT		
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_NO_CONTACTAR MOL
		ON PPE.PD_RUT = MOL.IE_RUT
QUALIFY ROW_NUMBER() OVER(PARTITION BY PPE.PD_RUT ORDER BY PPE.PD_RUT  DESC) = 1		
;
.IF ERRORCODE <> 0 THEN .QUIT 002;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_01;
.IF ERRORCODE <> 0 THEN .QUIT 003;


--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARAMETROS									  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PARAMETRO;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PARAMETRO
(
	 TC_CALIFICACION		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CALIFICACIONM		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PI					DECIMAL(18,8)
	,TE_FDR					INTEGER
	,TE_COS					INTEGER
) PRIMARY INDEX (TC_CALIFICACION)
;
.IF ERRORCODE <> 0 THEN .QUIT 001;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PARAMETRO
SELECT 
	 SC_CALIFICACION	AS TC_CALIFICACION	
	,SC_CALIFICACIONM	AS TC_CALIFICACIONM	
	,SD_PI				AS TD_PI				
	,SE_FDR				AS TE_FDR				
	,SE_COS				AS TE_COS				
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP
WHERE
	SC_CAMPANA = 'PROPENSOS_MX'
;
.IF ERRORCODE <> 0 THEN .QUIT 002;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_CALIFICACION)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PARAMETRO;
.IF ERRORCODE <> 0 THEN .QUIT 003;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL CON RUT UNICOS DE PO, DONDE ELLOS CUMPLAN     **
--** LAS CONDICIONES DE LOS FILTROS DE RIESGO. 							  **  
--** **CALIFICACION_SBIF**												  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PO_RUT;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PO_RUT
(
	 TD_RUT			DECIMAL(8,0)
) PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 004;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PO_RUT
SELECT
	CFP.TD_RUT	AS TD_RUT
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_01 AS CFP
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PARAMETRO AS PAR
		ON POSITION(CFP.TC_CALIFICACION_SBIF IN PAR.TC_CALIFICACION) > 0
			AND CFP.TD_PI_CLIENTE  <= PAR.TD_PI 
			AND CFP.TE_FDR >= PAR.TE_FDR
			AND CFP.TE_COS_CLI = PAR.TE_COS
;
.IF ERRORCODE <> 0 THEN .QUIT 005;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_FDR_PO_RUT;
.IF ERRORCODE <> 0 THEN .QUIT 006;

--/*************************************************************************
--** SE CREA EN TABLA TEMPORAL PARA ACTUALIZAR CAMPO FILTRO DE RIESGO
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_02;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_02
(
	 TD_RUT 							DECIMAL(8,0)
	,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PO_DEUDA						INTEGER
	,TE_CTACTE							INTEGER
	,TE_LCG_VIGENTE						INTEGER
	,TE_LME_VIGENTE 					INTEGER		
	,TE_DISPONIBLE_MX_NEW				BIGINT
	,TC_MACRO_BANCA     				VARCHAR(16) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_LCG_RENOV_SIN_DISP				INTEGER
	,TE_CURSE_ULT_3M					INTEGER
	,TE_FLG_EXCLUSION					INTEGER
	,TC_MOTIVO_EXCLUSION				VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO1							VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2  						VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3  						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_EN_PLANEAMIENTO					INTEGER 			
    ,TC_CALIFICACION_SBIF          		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,TF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,TD_PI_CLIENTE                		DECIMAL(25,10) 			
	,TC_CLASIFICACION_SBIF       		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FDR                      		INTEGER 			
	,TE_COS_CLI                 		INTEGER 			
	,TE_FILTROS_RIESGOS          		INTEGER 			
	,TC_PAR_CALIFICACION_SBIF    		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE           		DECIMAL(25,10) 		
	,TE_PAR_FDR                  		INTEGER 			
	,TE_PAR_COS_CLI             		INTEGER 				
	,TE_MOLESTO               			INTEGER 			
	,TE_CARGABLE						INTEGER
	,TC_ELIMINADO						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DISPONIBLE_OK               	INTEGER
	,TE_ENROLADO_360            		INTEGER
	,TE_HABILITADO_360           		INTEGER
	,TE_ACTIVO_360               		INTEGER
	,TE_ESTADO_MULTIPASS        		INTEGER
	,TE_MANDATO_CCL              		INTEGER
	,TE_SIN_APR                 		INTEGER
	,TE_ART85                     		INTEGER
	,TE_FYP                    			INTEGER
	,TE_READY_CCL              			INTEGER
	,TE_TOTAL_HABILITADORES       		INTEGER
	,TC_FECHA_HAB 						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_CMP_MANDATO_CCL					INTEGER
	,TE_CMP_CTO_BEX						INTEGER
	,TE_CMP_MIGRACION               	INTEGER
	,TE_CMP_PROPENSO_MX             	INTEGER
	,TE_CMP_FOGAPE_REACTIVA         	INTEGER
	,TC_EJE_CAMP						VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PRIORIDAD                   	INTEGER
	,TE_MTO_CMP    						BIGINT
	,TE_IND_BANQUERO_SOLO_MX			BYTEINT	
	,TE_IND_CAMPANA						BYTEINT
	)PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 007;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_02
SELECT 
	 PPE.TD_RUT 									AS TD_RUT 					
	,PPE.TC_RECOMENDACION_DE_CRUCE					AS TC_RECOMENDACION_DE_CRUCE
	,PPE.TE_PO_DEUDA 								AS TE_PO_DEUDA
	,PPE.TE_CTACTE 									AS TE_CTACTE
	,PPE.TE_LCG_VIGENTE 							AS TE_LCG_VIGENTE
	,PPE.TE_LME_VIGENTE 							AS TE_LME_VIGENTE	
	,PPE.TE_DISPONIBLE_MX_NEW						AS TE_DISPONIBLE_MX_NEW
	,PPE.TC_MACRO_BANCA								AS TC_MACRO_BANCA 		
	,PPE.TE_LCG_RENOV_SIN_DISP 						AS TE_LCG_RENOV_SIN_DISP
	,PPE.TE_CURSE_ULT_3M            				AS TE_CURSE_ULT_3M
	,PPE.TE_FLG_EXCLUSION           				AS TE_FLG_EXCLUSION
	,PPE.TC_MOTIVO_EXCLUSION        				AS TC_MOTIVO_EXCLUSION
	,PPE.TC_TEXTO1                  				AS TC_TEXTO1
	,PPE.TC_TEXTO2                  				AS TC_TEXTO2
	,PPE.TC_TEXTO3                  				AS TC_TEXTO3
	,PPE.TE_EN_PLANEAMIENTO         	        	AS TE_EN_PLANEAMIENTO
    ,PPE.TC_CALIFICACION_SBIF        				AS TC_CALIFICACION_SBIF
	,PPE.TF_PERIODO_CALIFICACION          			AS TF_PERIODO_CALIFICACION 	
	,PPE.TD_PI_CLIENTE            					AS TD_PI_CLIENTE 
	,PPE.TC_CLASIFICACION_SBIF              		AS TC_CLASIFICACION_SBIF 	
	,PPE.TE_FDR                     				AS TE_FDR 
	,PPE.TE_COS_CLI									AS TE_COS_CLI

	,CASE WHEN POR.TD_RUT IS NOT NULL
		THEN 1
		ELSE PPE.TE_FILTROS_RIESGOS END
							         				AS TE_FILTROS_RIESGOS

	,PPE.TC_PAR_CALIFICACION_SBIF					AS TC_PAR_CALIFICACION_SBIF
	,PPE.TD_PAR_PI_CLIENTE				            AS TD_PAR_PI_CLIENTE 
	,PPE.TE_PAR_FDR		                         	AS TE_PAR_FDR 
	,PPE.TE_PAR_COS_CLI			                    AS TE_PAR_COS_CLI 	
	,PPE.TE_MOLESTO									AS TE_MOLESTO
	,PPE.TE_CARGABLE                				AS TE_CARGABLE
    ,PPE.TC_ELIMINADO	           					AS TC_ELIMINADO	
	,PPE.TE_DISPONIBLE_OK           				AS TE_DISPONIBLE_OK
	,PPE.TE_ENROLADO_360            				AS TE_ENROLADO_360
	,PPE.TE_HABILITADO_360          				AS TE_HABILITADO_360
	,PPE.TE_ACTIVO_360              				AS TE_ACTIVO_360
	,PPE.TE_ESTADO_MULTIPASS        				AS TE_ESTADO_MULTIPASS
	,PPE.TE_MANDATO_CCL             				AS TE_MANDATO_CCL
	,PPE.TE_SIN_APR                 				AS TE_SIN_APR
	,PPE.TE_ART85                   				AS TE_ART85
	,PPE.TE_FYP                     				AS TE_FYP
	,PPE.TE_READY_CCL               				AS TE_READY_CCL
	,PPE.TE_TOTAL_HABILITADORES     				AS TE_TOTAL_HABILITADORES
	,PPE.TC_FECHA_HAB 								AS TC_FECHA_HAB	
	,PPE.TE_CMP_MANDATO_CCL         				AS TE_CMP_MANDATO_CCL
	,PPE.TE_CMP_CTO_BEX             				AS TE_CMP_CTO_BEX
	,PPE.TE_CMP_MIGRACION           				AS TE_CMP_MIGRACION
	,PPE.TE_CMP_PROPENSO_MX         				AS TE_CMP_PROPENSO_MX
	,PPE.TE_CMP_FOGAPE_REACTIVA     				AS TE_CMP_FOGAPE_REACTIVA
	,PPE.TC_EJE_CAMP								AS TC_EJE_CAMP
	,PPE.TE_PRIORIDAD 								AS TE_PRIORIDAD
	,PPE.TE_MTO_CMP							 		AS TE_MTO_CMP
	,PPE.TE_IND_BANQUERO_SOLO_MX					AS TE_IND_BANQUERO_SOLO_M	
	,PPE.TE_IND_CAMPANA 							AS TE_IND_CAMPANA		 		
FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_01  PPE
	LEFT JOIN T_JNY_WSBCCMX001OB_PROP_MX_FDR_PO_RUT POR
			ON PPE.TD_RUT = POR.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 008;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_02;
.IF ERRORCODE <> 0 THEN .QUIT 009;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE PROPENSOS MX P_CAMPANA_PROPENSO_MX_NEW_MES	  **  
--** CAMPO EN_PLANEAMIENTO.												  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_03;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_03
(
	 TD_RUT 							DECIMAL(8,0)
	,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PO_DEUDA						INTEGER
	,TE_CTACTE							INTEGER
	,TE_LCG_VIGENTE						INTEGER
	,TE_LME_VIGENTE 					INTEGER		
	,TE_DISPONIBLE_MX_NEW				BIGINT
	,TC_MACRO_BANCA     				VARCHAR(16) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_LCG_RENOV_SIN_DISP				INTEGER
	,TE_CURSE_ULT_3M					INTEGER
	,TE_FLG_EXCLUSION					INTEGER
	,TC_MOTIVO_EXCLUSION				VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO1							VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2  						VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3  						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_EN_PLANEAMIENTO					INTEGER 			
    ,TC_CALIFICACION_SBIF          		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,TF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,TD_PI_CLIENTE                		DECIMAL(25,10) 			
	,TC_CLASIFICACION_SBIF       		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FDR                      		INTEGER 			
	,TE_COS_CLI                 		INTEGER 			
	,TE_FILTROS_RIESGOS          		INTEGER 			
	,TC_PAR_CALIFICACION_SBIF    		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE           		DECIMAL(25,10) 		
	,TE_PAR_FDR                  		INTEGER 			
	,TE_PAR_COS_CLI             		INTEGER 		
	,TE_MOLESTO               			INTEGER 			
	,TE_CARGABLE						INTEGER
	,TC_ELIMINADO						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DISPONIBLE_OK               	INTEGER
	,TE_ENROLADO_360            		INTEGER
	,TE_HABILITADO_360           		INTEGER
	,TE_ACTIVO_360               		INTEGER
	,TE_ESTADO_MULTIPASS        		INTEGER
	,TE_MANDATO_CCL              		INTEGER
	,TE_SIN_APR                 		INTEGER
	,TE_ART85                     		INTEGER
	,TE_FYP                    			INTEGER
	,TE_READY_CCL              			INTEGER
	,TE_TOTAL_HABILITADORES       		INTEGER
	,TC_FECHA_HAB 						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_CMP_MANDATO_CCL					INTEGER
	,TE_CMP_CTO_BEX						INTEGER
	,TE_CMP_MIGRACION               	INTEGER
	,TE_CMP_PROPENSO_MX             	INTEGER
	,TE_CMP_FOGAPE_REACTIVA         	INTEGER
	,TC_EJE_CAMP						VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PRIORIDAD                   	INTEGER
	,TE_MTO_CMP    						BIGINT
	,TE_IND_BANQUERO_SOLO_MX			BYTEINT	
	,TE_IND_CAMPANA						BYTEINT
)PRIMARY INDEX (Td_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 010;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_03
SELECT 
	 PPE.TD_RUT 									AS Td_RUT 					
	,MMP.IC_RECOMENDACION_DE_CRUCE					AS TC_RECOMENDACION_DE_CRUCE
	,PPE.TE_PO_DEUDA 								AS TE_PO_DEUDA
	,PPE.TE_CTACTE 									AS TE_CTACTE
	,PPE.TE_LCG_VIGENTE 							AS TE_LCG_VIGENTE
	,PPE.TE_LME_VIGENTE 							AS TE_LME_VIGENTE	
	,PPE.TE_DISPONIBLE_MX_NEW						AS TE_DISPONIBLE_MX_NEW
	,PPE.TC_MACRO_BANCA								AS TC_MACRO_BANCA 		
	,PPE.TE_LCG_RENOV_SIN_DISP 						AS TE_LCG_RENOV_SIN_DISP
	,PPE.TE_CURSE_ULT_3M            				AS TE_CURSE_ULT_3M
	,PPE.TE_FLG_EXCLUSION           				AS TE_FLG_EXCLUSION
	,PPE.TC_MOTIVO_EXCLUSION        				AS TC_MOTIVO_EXCLUSION
	,PPE.TC_TEXTO1                  				AS TC_TEXTO1
	,PPE.TC_TEXTO2                  				AS TC_TEXTO2
	,PPE.TC_TEXTO3                  				AS TC_TEXTO3
	,1						         	        	AS TE_EN_PLANEAMIENTO

    ,PPE.TC_CALIFICACION_SBIF         				AS TC_CALIFICACION_SBIF
	,PPE.TF_PERIODO_CALIFICACION          			AS TF_PERIODO_CALIFICACION 	
	,PPE.TD_PI_CLIENTE             					AS TD_PI_CLIENTE 
	,PPE.TC_CLASIFICACION_SBIF              		AS TC_CLASIFICACION_SBIF 	
	,PPE.TE_FDR                     				AS TE_FDR 
	,PPE.TE_COS_CLI									AS TE_COS_CLI
	,PPE.TE_FILTROS_RIESGOS		       				AS TE_FILTROS_RIESGOS

	,CASE WHEN PAR.SC_CALIFICACION IS NULL THEN 'NULL' 
				ELSE PAR.SC_CALIFICACIONM END 		AS TC_PAR_CALIFICACION_SBIF
	,PAR.SD_PI				                  		AS TD_PAR_PI_CLIENTE 
	,PAR.SE_FDR		                         		AS TE_PAR_FDR 
	,PAR.SE_COS			                     		AS TE_PAR_COS_CLI 

	,PPE.TE_MOLESTO									AS TE_MOLESTO
	,PPE.TE_CARGABLE                				AS TE_CARGABLE
    ,PPE.TC_ELIMINADO	           					AS TC_ELIMINADO	
	,PPE.TE_DISPONIBLE_OK           				AS TE_DISPONIBLE_OK
	,PPE.TE_ENROLADO_360            				AS TE_ENROLADO_360
	,PPE.TE_HABILITADO_360          				AS TE_HABILITADO_360
	,PPE.TE_ACTIVO_360              				AS TE_ACTIVO_360
	,PPE.TE_ESTADO_MULTIPASS        				AS TE_ESTADO_MULTIPASS
	,PPE.TE_MANDATO_CCL             				AS TE_MANDATO_CCL
	,PPE.TE_SIN_APR                 				AS TE_SIN_APR
	,PPE.TE_ART85                   				AS TE_ART85
	,PPE.TE_FYP                     				AS TE_FYP
	,PPE.TE_READY_CCL               				AS TE_READY_CCL
	,PPE.TE_TOTAL_HABILITADORES     				AS TE_TOTAL_HABILITADORES
	,PPE.TC_FECHA_HAB 								AS TC_FECHA_HAB	
	,PPE.TE_CMP_MANDATO_CCL         				AS TE_CMP_MANDATO_CCL
	,PPE.TE_CMP_CTO_BEX             				AS TE_CMP_CTO_BEX
	,PPE.TE_CMP_MIGRACION           				AS TE_CMP_MIGRACION
	,PPE.TE_CMP_PROPENSO_MX         				AS TE_CMP_PROPENSO_MX
	,PPE.TE_CMP_FOGAPE_REACTIVA     				AS TE_CMP_FOGAPE_REACTIVA	
	,PPE.TC_EJE_CAMP								AS TC_EJE_CAMP
	,PPE.TE_PRIORIDAD 								AS TE_PRIORIDAD
	,PPE.TE_MTO_CMP							 		AS TE_MTO_CMP
	,PPE.TE_IND_BANQUERO_SOLO_MX					AS TE_IND_BANQUERO_SOLO_MX	
	,PPE.TE_IND_CAMPANA 							AS TE_IND_CAMPANA		 		
FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_02  PPE
	INNER JOIN 	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO MMP
		ON PPE.TD_RUT = MMP.IE_RUT
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP PAR
    	ON 	PAR.SC_CAMPANA = 'PROPENSOS_MX'		
;
.IF ERRORCODE <> 0 THEN .QUIT 011;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_03;
.IF ERRORCODE <> 0 THEN .QUIT 012;

/***********************************************************************************************
    CREA TABLA PRE CALCULO PARA FILTROS DE RIESGO
************************************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_FR;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_FR
(
	 PD_RUT 							DECIMAL(8,0)
	,PC_RECOMENDACION_DE_CRUCE			VARCHAR(255) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PO_DEUDA						INTEGER
	,PE_CTACTE							INTEGER
	,PE_LCG_VIGENTE						INTEGER
	,PE_LME_VIGENTE 					INTEGER		
	,PE_DISPONIBLE_MX_NEW				BIGINT
	,PC_MACRO_BANCA     				VARCHAR(16) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_LCG_RENOV_SIN_DISP				INTEGER
	,PE_CURSE_ULT_3M					INTEGER
	,PE_FLG_EXCLUSION					INTEGER
	,PC_MOTIVO_EXCLUSION				VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO1							VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO2  						VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO3  						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_EN_PLANEAMIENTO					INTEGER 			
    ,PC_CALIFICACION_SBIF          		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,PF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,PD_PI_CLIENTE                		DECIMAL(25,10) 			
	,PC_CLASIFICACION_SBIF       		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,PE_FDR                      		INTEGER 			
	,PE_COS_CLI                 		INTEGER 			
	,PE_FILTROS_RIESGOS          		INTEGER 			
	,PC_PAR_CALIFICACION_SBIF    		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PD_PAR_PI_CLIENTE           		DECIMAL(25,10) 		
	,PE_PAR_FDR                  		INTEGER 			
	,PE_PAR_COS_CLI             		INTEGER 		
	,PE_MOLESTO               			INTEGER 			
	,PE_CARGABLE						INTEGER
	,PC_ELIMINADO						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_DISPONIBLE_OK               	INTEGER
	,PE_ENROLADO_360            		INTEGER
	,PE_HABILITADO_360           		INTEGER
	,PE_ACTIVO_360               		INTEGER
	,PE_ESTADO_MULTIPASS        		INTEGER
	,PE_MANDATO_CCL              		INTEGER
	,PE_SIN_APR                 		INTEGER
	,PE_ART85                     		INTEGER
	,PE_FYP                    			INTEGER
	,PE_READY_CCL              			INTEGER
	,PE_TOTAL_HABILITADORES       		INTEGER
	,PC_FECHA_HAB 						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,PE_CMP_MANDATO_CCL					INTEGER
	,PE_CMP_CTO_BEX						INTEGER
	,PE_CMP_MIGRACION               	INTEGER
	,PE_CMP_PROPENSO_MX             	INTEGER
	,PE_CMP_FOGAPE_REACTIVA         	INTEGER
	,PC_EJE_CAMP						VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PRIORIDAD                   	INTEGER
	,PE_MTO_CMP    						BIGINT
	,PE_IND_BANQUERO_SOLO_MX			BYTEINT	
	,PE_IND_CAMPANA						BYTEINT
)PRIMARY INDEX (PD_RUT)
;
--/*************************************************************************
--** SE INSERTA EN TABLA DE PRE CALCULO DE REGLAS DE NEGOCIO
--*************************************************************************/
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_FR
SELECT
	 PPE.PD_RUT 									AS PD_RUT 					
	,PPE.PC_RECOMENDACION_DE_CRUCE					AS PC_RECOMENDACION_DE_CRUCE
	,PPE.PE_PO_DEUDA 								AS PE_PO_DEUDA
	,PPE.PE_CTACTE 									AS PE_CTACTE
	,PPE.PE_LCG_VIGENTE 							AS PE_LCG_VIGENTE
	,PPE.PE_LME_VIGENTE 							AS PE_LME_VIGENTE	
	,PPE.PE_DISPONIBLE_MX_NEW						AS PE_DISPONIBLE_MX_NEW
	,PPE.PC_MACRO_BANCA								AS PC_MACRO_BANCA 		
	,PPE.PE_LCG_RENOV_SIN_DISP 						AS PE_LCG_RENOV_SIN_DISP
	,PPE.PE_CURSE_ULT_3M            				AS PE_CURSE_ULT_3M
	,PPE.PE_FLG_EXCLUSION           				AS PE_FLG_EXCLUSION
	,PPE.PC_MOTIVO_EXCLUSION        				AS PC_MOTIVO_EXCLUSION
	,PPE.PC_TEXTO1                  				AS PC_TEXTO1
	,PPE.PC_TEXTO2                  				AS PC_TEXTO2
	,PPE.PC_TEXTO3                  				AS PC_TEXTO3

	,T03.TE_EN_PLANEAMIENTO         	        	AS PE_EN_PLANEAMIENTO
	,T03.TC_CALIFICACION_SBIF       				AS PC_CALIFICACION_SBIF
	,T03.TF_PERIODO_CALIFICACION	          		AS PF_PERIODO_CALIFICACION 	
	,T03.TD_PI_CLIENTE             					AS PD_PI_CLIENTE 
	,T03.TC_CLASIFICACION_SBIF              		AS PC_CLASIFICACION_SBIF 	
	,T03.TE_FDR                     				AS PE_FDR       				 
	,T03.TE_COS_CLI									AS PE_COS_CLI
	,T03.TE_FILTROS_RIESGOS 						AS PE_FILTROS_RIESGOS
	,T03.TC_PAR_CALIFICACION_SBIF					AS PC_PAR_CALIFICACION_SBIF
	,T03.TD_PAR_PI_CLIENTE				            AS PD_PAR_PI_CLIENTE 
	,T03.TE_PAR_FDR		                         	AS PE_PAR_FDR 
	,T03.TE_PAR_COS_CLI			                    AS PE_PAR_COS_CLI 	
	,T03.TE_MOLESTO									AS PE_MOLESTO

	,PPE.PE_CARGABLE                				AS PE_CARGABLE
    ,PPE.PC_ELIMINADO	           					AS PC_ELIMINADO	
	,PPE.PE_DISPONIBLE_OK           				AS PE_DISPONIBLE_OK
	,PPE.PE_ENROLADO_360            				AS PE_ENROLADO_360
	,PPE.PE_HABILITADO_360          				AS PE_HABILITADO_360
	,PPE.PE_ACTIVO_360              				AS PE_ACTIVO_360
	,PPE.PE_ESTADO_MULTIPASS        				AS PE_ESTADO_MULTIPASS
	,PPE.PE_MANDATO_CCL             				AS PE_MANDATO_CCL
	,PPE.PE_SIN_APR                 				AS PE_SIN_APR
	,PPE.PE_ART85                   				AS PE_ART85
	,PPE.PE_FYP                     				AS PE_FYP
	,PPE.PE_READY_CCL               				AS PE_READY_CCL
	,PPE.PE_TOTAL_HABILITADORES     				AS PE_TOTAL_HABILITADORES
	,PPE.PC_FECHA_HAB 								AS PC_FECHA_HAB	
	,PPE.PE_CMP_MANDATO_CCL         				AS PE_CMP_MANDATO_CCL
	,PPE.PE_CMP_CTO_BEX             				AS PE_CMP_CTO_BEX
	,PPE.PE_CMP_MIGRACION           				AS PE_CMP_MIGRACION
	,PPE.PE_CMP_PROPENSO_MX         				AS PE_CMP_PROPENSO_MX
	,PPE.PE_CMP_FOGAPE_REACTIVA     				AS PE_CMP_FOGAPE_REACTIVA
	,PPE.PC_EJE_CAMP								AS PC_EJE_CAMP
	,PPE.PE_PRIORIDAD 								AS PE_PRIORIDAD
	,PPE.PE_MTO_CMP							 		AS PE_MTO_CMP
	,PPE.PE_IND_BANQUERO_SOLO_MX					AS PE_IND_BANQUERO_SOLO_MX
	,PPE.PE_IND_CAMPANA 							AS PE_IND_CAMPANA		 		
FROM
 {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_PO  PPE
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_PROP_MX_03 T03
		ON PPE.PD_RUT = T03.TD_RUT		
;
.IF ERRORCODE <> 0 THEN .QUIT 013;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_FR;
.IF ERRORCODE <> 0 THEN .QUIT 014;

SELECT DATE, TIME; 

.LOGOFF;
.QUIT 0;

UPDATE - Ejemplo 10 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: CAMBIA LOS FILTROS DE RIESGO PARA EL PO DE WHOLESALE FACTORING			  **
--**                                                    				 				  **
--** AUTOR  : CESAR ROMERO MUNOZ                                          			  	  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 07/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN:                                                           				  **
--** AUTOR  :                                                           				  **
--** FECHA  : SSAAMMDD                                                  				  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	 																  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP                 	  **
--**					MKT_JOURNEYBUILDER_TB.P_CMP_MAE_CALIF_SBIF               	  	  **
--**					MKT_JOURNEYBUILDER_TB.P_CMP_MAE_FDR		              		  	  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP			          	  **
--**					MKT_JOURNEYBUILDER_TB.P_CMP_MAE_NO_CONTACTAR			  	  	  **
--**					MKT_JOURNEYBUILDER_TB.P_CMP_MAE_MAPEO				      	  	  **
--**																					  **                 
--**TABLA DE SALIDA:    							                	                  **
--**                  	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES  	  **
--**																					  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARAMETROS									  **  
--*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PARAMETRO;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PARAMETRO
(
	 TC_CALIFICACION		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CALIFICACIONM		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PI					DECIMAL(18,8)
	,TE_FDR					INTEGER
	,TE_COS					INTEGER
) PRIMARY INDEX (TC_CALIFICACION)
;
.IF ERRORCODE <> 0 THEN .QUIT 1;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PARAMETRO
SELECT 
	 SC_CALIFICACION	AS TC_CALIFICACION	
	,SC_CALIFICACIONM	AS TC_CALIFICACIONM	
	,SD_PI				AS TD_PI				
	,SE_FDR				AS TE_FDR				
	,SE_COS				AS TE_COS				
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP
WHERE
	SC_CAMPANA = 'FACTORING_WHOLESALE'
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_CALIFICACION)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PARAMETRO;
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE WHOLESALE FACTORING 							  **
--** {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES		  **  
--** CAMPOS PAR_CALIFICACION_SBIF, PAR_PI_CLIENTE, PAR_FDR Y PAR_COS_CLI  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES  
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PARAMETRO AS PAR
SET 
	 PC_PAR_CALIFICACION_SBIF = 
		CASE WHEN PAR.TC_CALIFICACION IS NULL 
				THEN 'NULL' 
				ELSE PAR.TC_CALIFICACIONM
		END
	,PD_PAR_PI_CLIENTE = PAR.TD_PI
	,PE_PAR_FDR 		= PAR.TE_FDR
	,PE_PAR_COS_CLI 	= PAR.TE_COS
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL CON PO CRUZADA CON CALIFICACIONES SBIF, SI LA **
--** CALIFICACION ES NULA, SE CAMBIA POR 0.								  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PO_CALIF;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PO_CALIF
(
	 TE_RUT				INTEGER
	,TC_CALIFICACION	VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TF_PERIODO			DATE FORMAT 'YYYY-MM-DD'
	,TC_CLASIFICACION	VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PI				DECIMAL(18,8)
) PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 5;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PO_CALIF
SELECT
	 CFP.PE_CLI_RUT							AS TE_RUT
	,COALESCE(CAL.PC_CALIFICACION_SBIF,'0')	AS TC_CALIFICACION
	,CAL.PF_PERIODO_CALIFICACION_SBIF		AS TF_PERIODO
	,CAL.PC_CLASIFICACION_SBIF				AS TC_CLASIFICACION
	,COALESCE(CAL.PD_PI_CLIENTE,0)			AS TD_PI
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES AS CFP
	LEFT JOIN MKT_JOURNEYBUILDER_TB.P_CMP_MAE_CALIF_SBIF AS CAL
		ON CFP.PE_CLI_RUT = CAL.PE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 6;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PO_CALIF;
.IF ERRORCODE <> 0 THEN .QUIT 7;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE WHOLESALE FACTORING							  **
--** {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES		  **  
--** CAMPOS CALIFICACION_SBIF, PERIODO_CALIFICACION, CLASIFICACION_SBIF Y **
--** PI_CLIENTE															  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES  
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PO_CALIF AS CAL
SET 
	PC_CALIFICACION_SBIF 	= CAL.TC_CALIFICACION
  , PF_PERIODO_CALIFICACION = CAL.TF_PERIODO
  , PC_CLASIFICACION_SBIF 	= CAL.TC_CLASIFICACION
  , PD_PI_CLIENTE 			= CAL.TD_PI
WHERE
	PE_CLI_RUT = CAL.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE WHOLESALE FACTORING 							  **
--** {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES, CAMPO FDR**  
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES  
FROM
	MKT_JOURNEYBUILDER_TB.P_CMP_MAE_FDR AS MFR
SET 
	PE_FDR = MFR.PE_FDR 
WHERE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES.PE_CLI_RUT = MFR.PE_CLI_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA CCEE_Y_RIP CRUZADA CON PO PARA SACAR	  **  
--** INDICADOR COS_CLI													  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_COS_CLI;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_COS_CLI
(
	 TE_RUT			INTEGER
	,TE_COS_CLI		INTEGER
) PRIMARY INDEX (TE_RUT, TE_COS_CLI)
;
.IF ERRORCODE <> 0 THEN .QUIT 10;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_COS_CLI
SELECT
	 CFP.PE_CLI_RUT		AS TE_RUT
	,CASE WHEN RIP.SE_CLIENTE_RUT IS NULL 
			THEN 0 
			ELSE 1 
	END				AS TE_COS_CLI
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES  AS CFP
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP AS RIP
		ON CFP.PE_CLI_RUT = RIP.SE_CLIENTE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 11;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT, TE_COS_CLI)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_COS_CLI;
	
.IF ERRORCODE <> 0 THEN .QUIT 12;
	
--/*************************************************************************
--** SE ACTUALIZA TABLA DE WHOLESALE FACTORING 							  **
--** {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES, 		  **	
--** CAMPO COS_CLI													 	  **  
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES  
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_COS_CLI AS FCC
SET 
	PE_COS_CLI = FCC.TE_COS_CLI
WHERE
	PE_CLI_RUT = FCC.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 13;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL CON RUT UNICOS DE PO, DONDE ELLOS CUMPLAN     **
--** LAS CONDICIONES DE LOS FILTROS DE RIESGO. SE UTILIZA FILTRO DE		  **  
--** **CALIFICACION_SBIF**												  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PO_RUT;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PO_RUT
(
	 TE_RUT			INTEGER
) PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 14;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PO_RUT
SELECT
	PE_CLI_RUT	AS TE_RUT
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES AS CFP
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PARAMETRO AS PAR
		ON POSITION(PC_CALIFICACION_SBIF IN PAR.TC_CALIFICACION) > 0
			AND PD_PI_CLIENTE  <= PAR.TD_PI
			AND PE_FDR >= PAR.TE_FDR
			AND PE_COS_CLI = PAR.TE_COS
;
.IF ERRORCODE <> 0 THEN .QUIT 15;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PO_RUT;
.IF ERRORCODE <> 0 THEN .QUIT 16;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE WHOLESALE FACTORING 							  **
--** {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES		  **  
--** CAMPO FILTROS_RIESGOS.												  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES  
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PO_RUT AS POR
SET 
	PE_FILTROS_RIESGOS = 1
WHERE
	PE_CLI_RUT = POR.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 17;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA CLIENTES PO NO_CONTACTAR, REGISTRANDO 	  **  
--** INDICADOR MOLESTO													  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_MOL;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_MOL
(
	 TE_RUT			INTEGER
	,TE_MOLESTO		INTEGER
) PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 18;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_MOL
SELECT
	 CFP.PE_CLI_RUT	AS TE_RUT
	,CASE WHEN MOL.PE_RUT IS NULL 
			THEN 0 
			ELSE 1 
	END				AS TE_MOLESTO
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES  AS CFP
	LEFT JOIN MKT_JOURNEYBUILDER_TB.P_CMP_MAE_NO_CONTACTAR AS MOL
		ON CFP.PE_CLI_RUT = MOL.PE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 19;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_MOL;
.IF ERRORCODE <> 0 THEN .QUIT 20;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE WHOLESALE FACTORING 							  **
--** {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES, 		  **
--** CAMPO MOLESTO 	  													  **  
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES  
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_MOL AS MOL
SET
	PE_MOLESTO = MOL.TE_MOLESTO
WHERE
	PE_CLI_RUT = MOL.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 21;
	

--/*************************************************************************
--** SE ACTUALIZA TABLA DE WHOLESALE FACTORING 							  **
--** {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES		  **  
--** CAMPO EN_PLANEAMIENTO.												  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES  
FROM
	MKT_JOURNEYBUILDER_TB.P_CMP_MAE_MAPEO AS MMP
SET
	 PE_EN_PLANEAMIENTO = 1
	,PC_RECOMENDACION_DE_CRUCE = MMP.PC_RECOMENDACION_DE_CRUCE
WHERE
	PE_CLI_RUT = MMP.PE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 22;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES;
.IF ERRORCODE <> 0 THEN .QUIT 23;


SELECT DATE, TIME; 

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 10 OK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: CAMBIA LOS FILTROS DE RIESGO PARA EL PO DE WHOLESALE FACTORING			  **
--**                                                    				 				  **
--** AUTOR  : CESAR ROMERO MUNOZ                                          			  	  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 07/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 10/2024			     	                                                  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	 																  **
--**	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP                 				      **
--**	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CALIF_SBIF               	  				      **
--**	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_FDR		              		  				      **
--**	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP			          				      **
--**	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_NO_CONTACTAR			  	  				      **
--**	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO				      	  				      **
--**    {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_PO
--**																					  **                 
--**TABLA DE SALIDA:    							                	                  **
--**    {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_FR
--**																					  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARAMETROS									  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PARAMETRO;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PARAMETRO
(
	 TC_CALIFICACION		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CALIFICACIONM		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PI					DECIMAL(18,8)
	,TE_FDR					INTEGER
	,TE_COS					INTEGER
) UNIQUE PRIMARY INDEX (TC_CALIFICACION)
;
.IF ERRORCODE <> 0 THEN .QUIT 1;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PARAMETRO
SELECT 
	 SC_CALIFICACION	AS TC_CALIFICACION	
	,SC_CALIFICACIONM	AS TC_CALIFICACIONM	
	,SD_PI				AS TD_PI				
	,SE_FDR				AS TE_FDR				
	,SE_COS				AS TE_COS				
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP
WHERE
	SC_CAMPANA = 'FACTORING_WHOLESALE'
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_CALIFICACION)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PARAMETRO;
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE WHOLESALE FACTORING 							  **
--** CAMPOS PAR_CALIFICACION_SBIF, PAR_PI_CLIENTE, PAR_FDR Y PAR_COS_CLI, **
--** LOS DE CLASIFICACIONES Y FDR										  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_01
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F 					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TD_PROB							DECIMAL (25,10)    
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      	
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC	    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_01 
SELECT 
 FAC.PC_TPO_BANCA					AS TC_TPO_BANCA			
,FAC.PE_PERIODO_CMP_F				AS TE_PERIODO_CMP_F 			
,FAC.PD_CLI_RUT          			AS TD_CLI_RUT          			     			
,FAC.PC_MACRO_BANCA      			AS TC_MACRO_BANCA      			
,FAC.PC_NOM_CLI          			AS TC_NOM_CLI          			
,FAC.PE_PROPENSO					AS TE_PROPENSO					
,FAC.PC_TIPO 						AS TC_TIPO 		
,FAC.PD_PROB                        AS TD_PROB
,FAC.PC_TRAMO_FACT                  AS TC_TRAMO_FACT 						
,FAC.PC_MARCA_FACTORING  			AS TC_MARCA_FACTORING  			
,FAC.PE_CONVENCIMIENTO   			AS TE_CONVENCIMIENTO   				
,FAC.PC_ESTADO_FACTORING			AS TC_ESTADO_FACTORING			
,FAC.PE_PRIORIDAD					AS TE_PRIORIDAD					
,FAC.PC_TIPO_FINAL 					AS TC_TIPO_FINAL 					
,FAC.PC_ESTADO_LEAD					AS TC_ESTADO_LEAD	
,FAC.PC_CAMPANA_ANT		            AS TC_CAMPANA_ANT				
,FAC.PE_CTACTE						AS TE_CTACTE      
,FAC.PE_IS_FUGADO                   AS TE_IS_FUGADO        
,FAC.PE_CONOFERTARIESGOS    		AS TE_CONOFERTARIESGOS    
,FAC.PC_ZONA_CLIENTE	            AS TC_ZONA_CLIENTE						
,FAC.PD_VECES_VTA_PROP				AS TD_VECES_VTA_PROP						
,FAC.PC_TIPO_OFERTA_FINAL			AS TC_TIPO_OFERTA_FINAL			      	
,FAC.PC_EJE_FCT						AS TC_EJE_FCT						
,FAC.PC_BANCO						AS TC_BANCO						
,FAC.PC_EJE_FFVV					AS TC_EJE_FFVV					
,FAC.PE_VETADO_RIESGOS				AS TE_VETADO_RIESGOS				
,FAC.PE_MONTO_OFERTA				AS TE_MONTO_OFERTA				
,FAC.PC_TIPO_OFERTA 				AS TC_TIPO_OFERTA 				
,FAC.PE_MARCA_CODACTECO_FUERA 		AS TE_MARCA_CODACTECO_FUERA 		
,FAC.PC_COD_ACTECO  				AS TC_COD_ACTECO  				
,FAC.PC_ACT_ECO						AS TC_ACT_ECO						
,FAC.PC_COD_ACTECO_BCI				AS TC_COD_ACTECO_BCI				
,FAC.PC_GLOSA 						AS TC_GLOSA 						
,FAC.PC_IVA 						AS TC_IVA 						
,FAC.PC_CATEGORIA 					AS TC_CATEGORIA 					
,FAC.PC_TIPO_ACT_ECO 				AS TC_TIPO_ACT_ECO 				
,FAC.PE_MARCA_RUTGOB    			AS TE_MARCA_RUTGOB    			
,FAC.PE_ES_BCI          			AS TE_ES_BCI          			
,FAC.PE_CAPACITY_EJE    			AS TE_CAPACITY_EJE    			
,FAC.PE_CAPACITY_FFVV   			AS TE_CAPACITY_FFVV   			
,FAC.PE_CUENTA          			AS TE_CUENTA          			
,FAC.PE_FUERA_CAPACITY  			AS TE_FUERA_CAPACITY  			
,FAC.PC_TEXTO1 						AS TC_TEXTO1 						
,FAC.PC_TEXTO2                      AS TC_TEXTO2                      
,FAC.PC_CARACTERISTICAS_CLIENTE     AS TC_CARACTERISTICAS_CLIENTE     
,FAC.PC_CAMPANA_OFERTA              AS TC_CAMPANA_OFERTA   
,FAC.PE_EN_PLANEAMIENTO				AS TE_EN_PLANEAMIENTO			
,FAC.PC_RECOMENDACION_DE_CRUCE		AS TC_RECOMENDACION_DE_CRUCE	

,CASE WHEN CAL.IE_RUT IS NOT NULL
	 	THEN COALESCE(CAL.IC_CALIFICACION_SBIF,'0') 
		ELSE COALESCE(FAC.PC_CALIFICACION_SBIF,'0')  END 
									AS TC_CALIFICACION_SBIF         
,CASE WHEN CAL.IE_RUT IS NOT NULL
	 	THEN CAL.IF_PERIODO_CALIFICACION_SBIF 
		ELSE FAC.PF_PERIODO_CALIFICACION END 
									AS TF_PERIODO_CALIFICACION    	
,CASE WHEN CAL.IE_RUT IS NOT NULL
	 	THEN COALESCE(CAL.ID_PI_CLIENTE,0) 
		ELSE COALESCE(FAC.PD_PI_CLIENTE,0) END 
									AS TD_PI_CLIENTE      																			
,CASE WHEN CAL.IE_RUT IS NOT NULL
	 	THEN CAL.IC_CLASIFICACION_SBIF 
		ELSE FAC.PC_CLASIFICACION_SBIF END 
									AS TC_CLASIFICACION_SBIF    

,CASE WHEN MFR.IE_CLI_RUT IS NOT NULL
	 	THEN MFR.IE_FDR 
		ELSE FAC.PE_FDR END 
			                    	AS TE_FDR    	

,FAC.PE_COS_CLI		               	AS TE_COS_CLI  																	
,FAC.PE_FILTROS_RIESGOS     		AS TE_FILTROS_RIESGOS    

,CASE WHEN PAR.TC_CALIFICACIONM IS NULL 
		THEN 'NULL' 
		ELSE  PAR.TC_CALIFICACIONM END
							   		AS TC_PAR_CALIFICACION_SBIF    	
,PAR.TD_PI           				AS TD_PAR_PI_CLIENTE           	
,PAR.TE_FDR                  		AS TE_PAR_FDR       
,PAR.TE_COS           				AS TE_PAR_COS_CLI   
,FAC.PE_MOLESTO						AS TE_MOLESTO
,FAC.PE_CARGABLE                	AS TE_CARGABLE                	
,FAC.PC_ELIMINADO					AS TC_ELIMINADO										
,FAC.PE_DUPLAS						AS TE_DUPLAS						
,FAC.PE_ENROLADO_DTM				AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_PO FAC
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PARAMETRO PAR
		ON 1 = 1
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CALIF_SBIF CAL
		ON FAC.PD_CLI_RUT = CAL.IE_RUT	
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_FDR MFR
		ON FAC.PD_CLI_RUT = MFR.IE_CLI_RUT	
;
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_01;
.IF ERRORCODE <> 0 THEN .QUIT 6;


--/*************************************************************************
--** SE ACTUALIZA TABLA DE WHOLESALE FACTORING 2						  **
--** CAMPOS TE_EN_PLANEAMIENTO, TE_MOLESTO Y TE_COS_CLI  				  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_02;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_02
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)     
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC           
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC	        
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	        
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 7;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_02 
SELECT 
 FAC.TC_TPO_BANCA					AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F				AS TE_PERIODO_CMP_F 	 			
,FAC.TD_CLI_RUT          			AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      			AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          			AS TC_NOM_CLI          			
,FAC.TE_PROPENSO					AS TE_PROPENSO					
,FAC.TC_TIPO 						AS TC_TIPO 	
,FAC.TD_PROB                        AS TD_PROB	
,FAC.TC_TRAMO_FACT                  AS TC_TRAMO_FACT 								
,FAC.TC_MARCA_FACTORING  			AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   			AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING			AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD					AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 					AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD					AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            AS TC_CAMPANA_ANT							
,FAC.TE_CTACTE						AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    		AS TE_CONOFERTARIESGOS  
,FAC.TC_ZONA_CLIENTE	            AS TC_ZONA_CLIENTE  							
,FAC.TD_VECES_VTA_PROP				AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL			AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT						AS TC_EJE_FCT						
,FAC.TC_BANCO						AS TC_BANCO						
,FAC.TC_EJE_FFVV					AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS				AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA				AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 				AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 		AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  				AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO						AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI				AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 						AS TC_GLOSA 						
,FAC.TC_IVA 						AS TC_IVA 						
,FAC.TC_CATEGORIA 					AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 				AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    			AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          			AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    			AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   			AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          			AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  			AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 						AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              AS TC_CAMPANA_OFERTA   

,CASE WHEN MMP.IE_RUT IS NOT NULL
	THEN 1
	ELSE FAC.TE_EN_PLANEAMIENTO END
									AS TE_EN_PLANEAMIENTO			

,CASE WHEN MMP.IE_RUT IS NOT NULL
	THEN MMP.IC_RECOMENDACION_DE_CRUCE
	ELSE FAC.TC_RECOMENDACION_DE_CRUCE END
									AS TC_RECOMENDACION_DE_CRUCE	

,FAC.TC_CALIFICACION_SBIF			AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION		AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE					AS TD_PI_CLIENTE      																			
,FAC.TC_CLASIFICACION_SBIF			AS TC_CLASIFICACION_SBIF    

,FAC.TE_FDR             			AS TE_FDR    									

,CASE WHEN RIP.SE_CLIENTE_RUT IS NULL 
		THEN 0 
		ELSE 1 END
					               	AS TE_COS_CLI  
           		
,FAC.TE_FILTROS_RIESGOS     		AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF		AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           	AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  	AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           		AS TE_PAR_COS_CLI   

,CASE WHEN MOL.IE_RUT IS NULL 
			THEN 0 
			ELSE 1 END				AS TE_MOLESTO
          	            	
,FAC.TE_CARGABLE                	AS TE_CARGABLE                	
,FAC.TC_ELIMINADO					AS TC_ELIMINADO										
,FAC.TE_DUPLAS						AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM				AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_01 FAC
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP RIP 
		ON FAC.TD_CLI_RUT = RIP.SE_CLIENTE_RUT		
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_NO_CONTACTAR MOL
		ON FAC.TD_CLI_RUT = MOL.IE_RUT		
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO MMP
		ON FAC.TD_CLI_RUT = MMP.IE_RUT		
QUALIFY ROW_NUMBER() OVER(PARTITION BY FAC.TD_CLI_RUT ORDER BY FAC.TD_CLI_RUT ) =1 		        					
;
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_02;
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL CON RUT UNICOS DE PO, DONDE ELLOS CUMPLAN     **
--** LAS CONDICIONES DE LOS FILTROS DE RIESGO. SE UTILIZA FILTRO DE		  **  
--** **CALIFICACION_SBIF**												  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PO_RUT;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PO_RUT
(
	 TD_RUT			DECIMAL(8,0)
) UNIQUE PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 10;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PO_RUT
SELECT
	CFP.TD_CLI_RUT	AS TD_RUT
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_02 CFP
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PARAMETRO PAR
		ON POSITION(CFP.TC_CALIFICACION_SBIF IN PAR.TC_CALIFICACION) > 0
			AND CFP.TD_PI_CLIENTE  <= PAR.TD_PI
			AND CFP.TE_FDR >= PAR.TE_FDR
			AND CFP.TE_COS_CLI = PAR.TE_COS
;
.IF ERRORCODE <> 0 THEN .QUIT 11;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PO_RUT;
.IF ERRORCODE <> 0 THEN .QUIT 12;

/***********************************************************************************************
    CREA TABLA DE PRE CALCULO FILTROSS DE RIESGO 
************************************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_FR;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_FR
(
	 PC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,PE_PERIODO_CMP_F					INTEGER 		
    ,PD_CLI_RUT          				DECIMAL(8,0)
    ,PC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PE_PROPENSO						INTEGER
    ,PC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,PD_PROB							DECIMAL (25,10)
    ,PC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC             
    ,PC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,PE_CONVENCIMIENTO   				INTEGER
    ,PC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_PRIORIDAD						INTEGER
    ,PC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC	    
    ,PE_CTACTE							INTEGER
	,PE_IS_FUGADO                       BIGINT
    ,PE_CONOFERTARIESGOS    			INTEGER
	,PC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	    
    ,PD_VECES_VTA_PROP					DECIMAL (1,0)
    ,PC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_VETADO_RIESGOS					INTEGER
    ,PE_MONTO_OFERTA					BIGINT
    ,PC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_MARCA_CODACTECO_FUERA 			INTEGER
    ,PC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_MARCA_RUTGOB    				INTEGER
    ,PE_ES_BCI          				INTEGER
    ,PE_CAPACITY_EJE    				INTEGER
    ,PE_CAPACITY_FFVV   				INTEGER
    ,PE_CUENTA          				INTEGER
    ,PE_FUERA_CAPACITY  				INTEGER
    ,PC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_EN_PLANEAMIENTO					INTEGER
    ,PC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,PD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,PC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_FDR 							INTEGER
    ,PE_COS_CLI             			INTEGER
    ,PE_FILTROS_RIESGOS     			INTEGER
    ,PC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,PE_PAR_FDR 						INTEGER
    ,PE_PAR_COS_CLI             		INTEGER
    ,PE_MOLESTO                 		INTEGER
    ,PE_CARGABLE                		INTEGER
    ,PC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_DUPLAS							INTEGER
    ,PE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (PE_PERIODO_CMP_F,PD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 13;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE WHOLESALE FACTORING 							  **
--** CAMPO FILTROS_RIESGOS.												  **
--*************************************************************************/
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_FR 
SELECT 
 FAC.TC_TPO_BANCA						AS PC_TPO_BANCA					
,FAC.TE_PERIODO_CMP_F					AS PE_PERIODO_CMP_F					   		
,FAC.TD_CLI_RUT          				AS PD_CLI_RUT          			   			
,FAC.TC_MACRO_BANCA      				AS PC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS PC_NOM_CLI          			
,FAC.TE_PROPENSO						AS PE_PROPENSO					
,FAC.TC_TIPO 							AS PC_TIPO 	
,FAC.TD_PROB                            AS PD_PROB
,FAC.TC_TRAMO_FACT                      AS PC_TRAMO_FACT 							
,FAC.TC_MARCA_FACTORING  				AS PC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS PE_CONVENCIMIENTO   						
,FAC.TC_ESTADO_FACTORING				AS PC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS PE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS PC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS PC_ESTADO_LEAD									
,FAC.TC_CAMPANA_ANT		                AS PC_CAMPANA_ANT	
,FAC.TE_CTACTE							AS PE_CTACTE    
,FAC.TE_IS_FUGADO                      	AS PE_IS_FUGADO         
,FAC.TE_CONOFERTARIESGOS    			AS PE_CONOFERTARIESGOS    	
,FAC.TC_ZONA_CLIENTE	                AS PC_ZONA_CLIENTE							
,FAC.TD_VECES_VTA_PROP					AS PD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS PC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS PC_EJE_FCT						
,FAC.TC_BANCO							AS PC_BANCO						
,FAC.TC_EJE_FFVV						AS PC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS PE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS PE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS PC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS PE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS PC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS PC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS PC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS PC_GLOSA 						
,FAC.TC_IVA 							AS PC_IVA 						
,FAC.TC_CATEGORIA 						AS PC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS PC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS PE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS PE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS PE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS PE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS PE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS PE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS PC_TEXTO1 						
,FAC.TC_TEXTO2                         	AS PC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE        	AS PC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA                 	AS PC_CAMPANA_OFERTA              
,FAC.TE_EN_PLANEAMIENTO					AS PE_EN_PLANEAMIENTO				
,FAC.TC_RECOMENDACION_DE_CRUCE			AS PC_RECOMENDACION_DE_CRUCE		
,FAC.TC_CALIFICACION_SBIF				AS PC_CALIFICACION_SBIF			
,FAC.TF_PERIODO_CALIFICACION    		AS PF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE              		AS PD_PI_CLIENTE              	
,FAC.TC_CLASIFICACION_SBIF      		AS PC_CLASIFICACION_SBIF      	
,FAC.TE_FDR 							AS PE_FDR 						
,FAC.TE_COS_CLI             			AS PE_COS_CLI   

,CASE WHEN POR.TD_RUT IS NOT NULL 
		THEN 1
		ELSE 0 END      				AS PE_FILTROS_RIESGOS 
   		
,FAC.TC_PAR_CALIFICACION_SBIF 			AS PC_PAR_CALIFICACION_SBIF 		
,FAC.TD_PAR_PI_CLIENTE 					AS PD_PAR_PI_CLIENTE 				
,FAC.TE_PAR_FDR 						AS PE_PAR_FDR 					
,FAC.TE_PAR_COS_CLI             		AS PE_PAR_COS_CLI             	
,FAC.TE_MOLESTO                 		AS PE_MOLESTO                 	
,FAC.TE_CARGABLE                		AS PE_CARGABLE                	
,FAC.TC_ELIMINADO						AS PC_ELIMINADO										
,FAC.TE_DUPLAS							AS PE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS PE_ENROLADO_DTM				
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_02 FAC
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_FDR_PO_RUT POR
		ON FAC.TD_CLI_RUT = POR.TD_RUT	
;
.IF ERRORCODE <> 0 THEN .QUIT 14;	

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_FR;
.IF ERRORCODE <> 0 THEN .QUIT 15;

SELECT DATE, TIME; 

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 11 A OK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: REGLAS DE NEGOCIO PARA CAMPANA WHOLESALE FACTORING				 	      **
--**                                                    				 				  **
--** AUTOR  : MICHELL CUAREZ                                                			  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 04/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 10/2024			     	                                                  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	                                                                  **
--**  {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_FR **
--**                  						                    			 			  **
--**TABLA TEMPORAL:	                                                                      **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_01 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_02 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_03 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_04 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_05 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_06 **
--**                  						                    			 			  **
--******************************************************************************************
--******************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/***********************************************************
--** LOS QUE TIENEN OFERTA DE RIESGOS PERO SIN PROPENSION 	**
--**				 CARGAN EN INBOUND						**
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_01
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC         
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 1;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_01
SELECT
CASE WHEN 	FAC.PE_PROPENSO 		= 0 	AND 
    		FAC.PC_TIPO 			IS NULL AND 
			FAC.PE_CONOFERTARIESGOS > 0 THEN
			 CASE 
			 	WHEN FAC.PC_MACRO_BANCA IN ('EMPRESARIOS','EMPRENDEDORES') THEN 'PYME' 
			 	WHEN FAC.PC_MACRO_BANCA IN ('EMPRESAS','GRANDES EMPRESAS','INMOBILIARIA','CORPORATIVA') THEN 'WHOLESALE'
			 	ELSE NULL
			 END
 	  ELSE FAC.PC_TPO_BANCA END  		AS TC_TPO_BANCA   
	
,FAC.PE_PERIODO_CMP_F				    AS TE_PERIODO_CMP_F 	 		
,FAC.PD_CLI_RUT          				AS TD_CLI_RUT   
,FAC.PC_MACRO_BANCA      				AS TC_MACRO_BANCA     
,FAC.PC_NOM_CLI          				AS TC_NOM_CLI       	  

,CASE WHEN 	FAC.PE_PROPENSO 		= 0 	AND 
    		FAC.PC_TIPO 			IS NULL AND 
			FAC.PE_CONOFERTARIESGOS > 0
				THEN  99 
				ELSE FAC.PE_PROPENSO END AS TE_PROPENSO					

,CASE WHEN 	FAC.PE_PROPENSO 		= 0 	AND 
    		FAC.PC_TIPO 			IS NULL AND 
			FAC.PE_CONOFERTARIESGOS > 0
				THEN  'NUEVOS-' 
				ELSE FAC.PC_TIPO END 	AS TC_TIPO 	

,FAC.PD_PROB                            AS TD_PROB
,FAC.PC_TRAMO_FACT                      AS TC_TRAMO_FACT	
,FAC.PC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  	
,FAC.PE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   			
,FAC.PC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.PE_PRIORIDAD						AS TE_PRIORIDAD		

,CASE WHEN 	FAC.PE_PROPENSO 		= 0 	AND 
    		FAC.PC_TIPO 			IS NULL AND 
			FAC.PE_CONOFERTARIESGOS > 0
			 THEN  'NUEVOS-' 
			 ELSE FAC.PC_TIPO_FINAL END AS TC_TIPO_FINAL 	

,FAC.PC_ESTADO_LEAD						AS TC_ESTADO_LEAD
,FAC.PC_CAMPANA_ANT						AS TC_CAMPANA_ANT		      
,FAC.PE_CTACTE							AS TE_CTACTE   
,FAC.PE_IS_FUGADO                      	AS TE_IS_FUGADO       
,FAC.PE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS  
,FAC.PC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE	
,FAC.PD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.PC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.PC_EJE_FCT							AS TC_EJE_FCT						
,FAC.PC_BANCO							AS TC_BANCO						
,FAC.PC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.PE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.PE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.PC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 			  	
,FAC.PE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.PC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.PC_ACT_ECO							AS TC_ACT_ECO						
,FAC.PC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.PC_GLOSA 							AS TC_GLOSA 						
,FAC.PC_IVA 							AS TC_IVA 						
,FAC.PC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.PC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.PE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.PE_ES_BCI          				AS TE_ES_BCI     
,FAC.PE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.PE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.PE_CUENTA          				AS TE_CUENTA          			
,FAC.PE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.PC_TEXTO1 							AS TC_TEXTO1 						
,FAC.PC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.PC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.PC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.PE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.PC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.PC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.PF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.PD_PI_CLIENTE						AS TD_PI_CLIENTE      																			
,FAC.PC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.PE_FDR                   			AS TE_FDR    	
,FAC.PE_COS_CLI		               		AS TE_COS_CLI  																	
,FAC.PE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.PC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.PD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.PE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.PE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.PE_MOLESTO							AS TE_MOLESTO
,FAC.PE_CARGABLE                		AS TE_CARGABLE                	
,FAC.PC_ELIMINADO						AS TC_ELIMINADO										
,FAC.PE_DUPLAS							AS TE_DUPLAS						
,FAC.PE_ENROLADO_DTM					AS TE_ENROLADO_DTM		  
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_FR FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_01;
	
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/***********************************************************
--**				 ORDENO POR PE_PRIORIDAD WHOLESALE		**
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_02;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_02
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC         
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_02
SELECT 		
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT 	 							
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING	

,CASE WHEN 	FAC.TE_PROPENSO 		> 0 		  AND 
    		FAC.TC_TPO_BANCA 		= 'WHOLESALE' AND
			NOT (FAC.TE_PROPENSO = 99) 
			 THEN  999 
			 ELSE FAC.TE_PRIORIDAD END  AS TE_PRIORIDAD 		 			

,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    						
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI    
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE                		AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		 
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_01 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_02;
	
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/***********************************************************  
--**			 1 CON VENCIMIENTOS WHOLESALE				**
--**				 CLIENTES CON VENCIMIENTOS 				**
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_03;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_03
(
 	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC		
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 7;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_03
SELECT 		
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING

,CASE WHEN 	
	COALESCE(FAC.TC_TIPO_FINAL,'SIN ASIGNAR') = 'SIN ASIGNAR'
	AND	FAC.TC_TPO_BANCA = 'WHOLESALE' 
	AND	COALESCE(FAC.TE_CONVENCIMIENTO,0)>0 
	AND	COALESCE(FAC.TE_PRIORIDAD,0)= 999
			 THEN  1 
			 ELSE FAC.TE_PRIORIDAD END 	AS TE_PRIORIDAD 		 			

,CASE WHEN 	
	COALESCE(FAC.TC_TIPO_FINAL,'SIN ASIGNAR') = 'SIN ASIGNAR'
	AND	FAC.TC_TPO_BANCA = 'WHOLESALE' 
	AND	COALESCE(FAC.TE_CONVENCIMIENTO,0)>0 
	AND	COALESCE(FAC.TE_PRIORIDAD,0)= 999
			 THEN  'RECURRENTES'
			 ELSE FAC.TC_TIPO_FINAL END AS TC_TIPO_FINAL 				

,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE                		AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_02 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_03;
	
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/***********************************************************    
--** 2 WHOLESALE CON MARCA FACTORING ULTIMO AÑO				**
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_04;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_04
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 10;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_04
SELECT 		
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING		

,CASE WHEN 	
	FAC.TE_PROPENSO>0 
	AND	FAC.TC_TPO_BANCA = 'WHOLESALE' 
	AND COALESCE(FAC.TC_TIPO_FINAL,'SIN ASIGNAR') = 'SIN ASIGNAR' 
	AND FAC.TC_ESTADO_FACTORING = '1-CLIENTE FACTORING ULTIMO ANO' 
	AND COALESCE(FAC.TE_CONVENCIMIENTO,0)=0 
	AND COALESCE(FAC.TE_PRIORIDAD,0)=999
			 THEN  2 
			 ELSE FAC.TE_PRIORIDAD END 	AS TE_PRIORIDAD 		 			

,CASE WHEN 	
	FAC.TE_PROPENSO>0 
	AND	FAC.TC_TPO_BANCA = 'WHOLESALE' 
	AND COALESCE(FAC.TC_TIPO_FINAL,'SIN ASIGNAR') = 'SIN ASIGNAR' 
	AND FAC.TC_ESTADO_FACTORING = '1-CLIENTE FACTORING ULTIMO ANO' 
	AND COALESCE(FAC.TE_CONVENCIMIENTO,0)=0 
	AND COALESCE(FAC.TE_PRIORIDAD,0)=999
			 THEN  'RECURRENTES'
			 ELSE FAC.TC_TIPO_FINAL END AS TC_TIPO_FINAL 				

,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE                		AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		  
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_03 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_04;
	
.IF ERRORCODE <> 0 THEN .QUIT 12;

--/***********************************************************
--** 		3 WHOLESALE CON MARCA RECURRENTES				**
--************************************************************/  
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_05;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_05
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 13;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_05
SELECT 		
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING		

,CASE WHEN 	
	FAC.TE_PROPENSO>0 
	AND	FAC.TC_TPO_BANCA = 'WHOLESALE'
	AND	COALESCE(FAC.TC_TIPO,'') = 'RECURRENTES' 
	AND NOT (POSITION ('FUGA' IN COALESCE(FAC.TC_MARCA_FACTORING,'')) > 0)
	AND	COALESCE(FAC.TE_PRIORIDAD,0)=999
			 THEN  3 
			 ELSE FAC.TE_PRIORIDAD END 	AS TE_PRIORIDAD 		 			

,CASE WHEN 	
	FAC.TE_PROPENSO>0 
	AND	FAC.TC_TPO_BANCA = 'WHOLESALE'
	AND	COALESCE(FAC.TC_TIPO,'') = 'RECURRENTES' 
	AND NOT (POSITION ('FUGA' IN COALESCE(FAC.TC_MARCA_FACTORING,'')) > 0)
	AND	COALESCE(FAC.TE_PRIORIDAD,0)=999
			 THEN  'RECURRENTES'
			 ELSE FAC.TC_TIPO_FINAL END AS TC_TIPO_FINAL 				

,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE                		AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		    
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_04 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 14;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_05;
	
.IF ERRORCODE <> 0 THEN .QUIT 15;

--/***********************************************************
--** 		4 FUGADOS WHOLESALE			**
--************************************************************/ 
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_06;  
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_06
(
	 PC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,PE_PERIODO_CMP_F					INTEGER 		
    ,PD_CLI_RUT          				DECIMAL(8,0)
    ,PC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PE_PROPENSO						INTEGER
    ,PC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,PD_PROB							DECIMAL (25,10)
    ,PC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,PC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,PE_CONVENCIMIENTO   				INTEGER
    ,PC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_PRIORIDAD						INTEGER
    ,PC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,PE_CTACTE							INTEGER
	,PE_IS_FUGADO                       BIGINT
    ,PE_CONOFERTARIESGOS    			INTEGER
	,PC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,PD_VECES_VTA_PROP					DECIMAL (1,0)
    ,PC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_VETADO_RIESGOS					INTEGER
    ,PE_MONTO_OFERTA					BIGINT
    ,PC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_MARCA_CODACTECO_FUERA 			INTEGER
    ,PC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_MARCA_RUTGOB    				INTEGER
    ,PE_ES_BCI          				INTEGER
    ,PE_CAPACITY_EJE    				INTEGER
    ,PE_CAPACITY_FFVV   				INTEGER
    ,PE_CUENTA          				INTEGER
    ,PE_FUERA_CAPACITY  				INTEGER
    ,PC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_EN_PLANEAMIENTO					INTEGER
    ,PC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,PD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,PC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_FDR 							INTEGER
    ,PE_COS_CLI             			INTEGER
    ,PE_FILTROS_RIESGOS     			INTEGER
    ,PC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,PE_PAR_FDR 						INTEGER
    ,PE_PAR_COS_CLI             		INTEGER
    ,PE_MOLESTO                 		INTEGER
    ,PE_CARGABLE                		INTEGER
    ,PC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_DUPLAS							INTEGER
    ,PE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (PE_PERIODO_CMP_F,PD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 16;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_06
SELECT 		
 FAC.TC_TPO_BANCA						AS PC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS PE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS PD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS PC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS PC_NOM_CLI          			
,FAC.TE_PROPENSO						AS PE_PROPENSO					
,FAC.TC_TIPO 							AS PC_TIPO 
,FAC.TD_PROB                            AS PD_PROB
,FAC.TC_TRAMO_FACT                      AS PC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS PC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS PE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS PC_ESTADO_FACTORING		

,CASE WHEN 	
    FAC.TE_PROPENSO>0 
	AND	FAC.TC_TPO_BANCA = 'WHOLESALE' 
	AND	(POSITION ('FUGA' IN COALESCE(FAC.TC_MARCA_FACTORING,'')) > 0) 
	AND COALESCE(FAC.TE_PRIORIDAD,0)=999
			 THEN  4 
			 ELSE FAC.TE_PRIORIDAD END 	AS PE_PRIORIDAD 		 			

,CASE WHEN 	
    FAC.TE_PROPENSO>0 
	AND	FAC.TC_TPO_BANCA = 'WHOLESALE' 
	AND	(POSITION ('FUGA' IN COALESCE(FAC.TC_MARCA_FACTORING,'')) > 0) 
	AND COALESCE(FAC.TE_PRIORIDAD,0)=999
			 THEN  'FUGADOS'
			 ELSE FAC.TC_TIPO_FINAL END AS PC_TIPO_FINAL 				

,FAC.TC_ESTADO_LEAD						AS PC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS PC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS PE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS PE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS PE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS PC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS PD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS PC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS PC_EJE_FCT						
,FAC.TC_BANCO							AS PC_BANCO						
,FAC.TC_EJE_FFVV						AS PC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS PE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS PE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS PC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS PE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS PC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS PC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS PC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS PC_GLOSA 						
,FAC.TC_IVA 							AS PC_IVA 						
,FAC.TC_CATEGORIA 						AS PC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS PC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS PE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS PE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS PE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS PE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS PE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS PE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS PC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS PC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS PC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS PC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS PE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS PC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS PC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS PF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS PD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS PC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS PE_FDR    	
,FAC.TE_COS_CLI		               		AS PE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS PE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS PC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS PD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS PE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS PE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS PE_MOLESTO
,FAC.TE_CARGABLE                		AS PE_CARGABLE                	
,FAC.TC_ELIMINADO						AS PC_ELIMINADO										
,FAC.TE_DUPLAS							AS PE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS PE_ENROLADO_DTM		   
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_05 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 17;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_06;
	
.IF ERRORCODE <> 0 THEN .QUIT 18;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 11 B OK.sql


--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: REGLAS DE NEGOCIO PARA CAMPANA WHOLESALE FACTORING				 	      **
--**                                                    				 				  **
--** AUTOR  : MICHELL CUAREZ                                                			  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 04/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 10/2024			     	                                                  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	                                                                  **
--**                  						                    			 			  **
--**TABLA TEMPORAL:	                                                                      **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_07 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_08 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_09 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_10 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_11 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_12 **
--**                  						                    			 			  **
--******************************************************************************************
--******************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/***********************************************************
--** 		4 FUGADOS WHOLESALE			**
--************************************************************/ 
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_07;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_07
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 19;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_07
SELECT 		
 FAC.PC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.PE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.PD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.PC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.PC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.PE_PROPENSO						AS TE_PROPENSO					
,FAC.PC_TIPO 							AS TC_TIPO 
,FAC.PD_PROB                            AS TD_PROB
,FAC.PC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.PC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.PE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.PC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING		

,CASE WHEN 	
    FAC.PE_PROPENSO>0 
	AND	FAC.PC_TPO_BANCA = 'WHOLESALE' 
	AND FAC.PE_IS_FUGADO>0
	AND COALESCE(FAC.PE_PRIORIDAD,0)=999
			 THEN  4 
			 ELSE FAC.PE_PRIORIDAD END 	AS TE_PRIORIDAD 		 			

,CASE WHEN 	
    FAC.PE_PROPENSO>0 
	AND	FAC.PC_TPO_BANCA = 'WHOLESALE' 
	AND FAC.PE_IS_FUGADO>0
	AND COALESCE(FAC.PE_PRIORIDAD,0)=999
			 THEN  'FUGADOS'
			 ELSE FAC.PC_TIPO_FINAL END AS TC_TIPO_FINAL 				

,FAC.PC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.PC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.PE_CTACTE							AS TE_CTACTE      
,FAC.PE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.PE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.PC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.PD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.PC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.PC_EJE_FCT							AS TC_EJE_FCT						
,FAC.PC_BANCO							AS TC_BANCO						
,FAC.PC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.PE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.PE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.PC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.PE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.PC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.PC_ACT_ECO							AS TC_ACT_ECO						
,FAC.PC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.PC_GLOSA 							AS TC_GLOSA 						
,FAC.PC_IVA 							AS TC_IVA 						
,FAC.PC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.PC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.PE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.PE_ES_BCI          				AS TE_ES_BCI          			
,FAC.PE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.PE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.PE_CUENTA          				AS TE_CUENTA          			
,FAC.PE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.PC_TEXTO1 							AS TC_TEXTO1 						
,FAC.PC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.PC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.PC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.PE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.PC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.PC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.PF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.PD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.PC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.PE_FDR                   			AS TE_FDR    	
,FAC.PE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.PE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.PC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.PD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.PE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.PE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.PE_MOLESTO							AS TE_MOLESTO
,FAC.PE_CARGABLE                		AS TE_CARGABLE                	
,FAC.PC_ELIMINADO						AS TC_ELIMINADO										
,FAC.PE_DUPLAS							AS TE_DUPLAS						
,FAC.PE_ENROLADO_DTM					AS TE_ENROLADO_DTM		     
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_06 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 20;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_07;
	
.IF ERRORCODE <> 0 THEN .QUIT 21;

--/***********************************************************
--** 		5 EVIDENCIA WHOLESALE		**
--************************************************************/   
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_08;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_08
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 22;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_08
SELECT 		
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING	

,CASE WHEN 	
    FAC.TE_PROPENSO>0 
	AND	FAC.TC_TPO_BANCA = 'WHOLESALE' 
	AND	FAC.TC_TIPO = 'EVIDENCIA' 
	AND	COALESCE(FAC.TE_PRIORIDAD,0)=999
			 THEN  5 
			 ELSE FAC.TE_PRIORIDAD END 	AS TE_PRIORIDAD 		 			

,CASE WHEN 	
    FAC.TE_PROPENSO>0 
	AND	FAC.TC_TPO_BANCA = 'WHOLESALE' 
	AND	FAC.TC_TIPO = 'EVIDENCIA' 
	AND	COALESCE(FAC.TE_PRIORIDAD,0)=999
			 THEN  'EVIDENCIA'
			 ELSE FAC.TC_TIPO_FINAL END AS TC_TIPO_FINAL 				

,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE                		AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_07 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 23;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_08;
	
.IF ERRORCODE <> 0 THEN .QUIT 24;

--/*********************************************************** 
--** NUEVOS CLIENTES CON ACEPTADO / AGENDADO / RECHAZO		**
--** 6 NUEVOS PROPENSOS ACEPTADADOS                   		**
--** 7 NUEVOS PROPENSOS                               		**
--** 8 NUEVOS PROPENSOS                               		**
--** 9 NUEVOS PROPENSOS RECHAZADOS                    		**
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_09;    
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_09
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 25;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_09
SELECT 		
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING		

,CASE WHEN 	
	FAC.TE_PROPENSO>0 
	AND	FAC.TC_TPO_BANCA = 'WHOLESALE'
	AND	COALESCE(TC_TIPO,'NUEVOS') = 'NUEVOS' 
	AND FAC.TC_ESTADO_FACTORING IN (
				 '3-PROSP. BOLETA GARANTIA ULTIMO ANO'
				,'4-PROSP. PAGOS RECIBIDOS: >= MM$1.000'
				,'5-PROSP. PAGOS RECIBIDOS: MM$100 - MM$999')
	AND	COALESCE(FAC.TE_PRIORIDAD,0)=999 THEN
	     CASE 
		    WHEN FAC.TC_ESTADO_LEAD IN ('ACEPTADO','AGENDADO') 
				THEN 6
		    WHEN FAC.TC_ESTADO_LEAD IN ('RECHAZO BCO.','RECHAZO CLI.') AND NOT (POSITION ('FFVV' IN FAC.TC_CAMPANA_ANT) > 0) 
				THEN 8
	     ELSE 7 END
	 ELSE FAC.TE_PRIORIDAD END 	AS TE_PRIORIDAD 		 			

,CASE WHEN 	
	FAC.TE_PROPENSO>0 
	AND	FAC.TC_TPO_BANCA = 'WHOLESALE'
	AND	COALESCE(TC_TIPO,'NUEVOS') = 'NUEVOS' 
	AND FAC.TC_ESTADO_FACTORING IN (
				 '3-PROSP. BOLETA GARANTIA ULTIMO ANO'
				,'4-PROSP. PAGOS RECIBIDOS: >= MM$1.000'
				,'5-PROSP. PAGOS RECIBIDOS: MM$100 - MM$999')
	AND	COALESCE(FAC.TE_PRIORIDAD,0)=999
			 THEN  'NUEVOS'
			 ELSE FAC.TC_TIPO_FINAL END AS TC_TIPO_FINAL 				

,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE                		AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		   
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_08 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 26;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_09;
	
.IF ERRORCODE <> 0 THEN .QUIT 27;

--/*********************************************************** 
--** NUEVOS CLIENTES CON ACEPTADO / AGENDADO / RECHAZO		**
--** 6 NUEVOS PROPENSOS ACEPTADADOS                   		**
--** 7 NUEVOS PROPENSOS                               		**
--** 8 NUEVOS PROPENSOS                               		**
--** 9 NUEVOS PROPENSOS RECHAZADOS                    		**
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_10;  
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_10
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 28;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_10
SELECT 		
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING	

,CASE WHEN 	
	FAC.TE_PROPENSO>0 
	AND	FAC.TC_TPO_BANCA = 'WHOLESALE'
	AND	COALESCE(TC_TIPO,'NUEVOS') = 'NUEVOS' 
	AND FAC.TC_ESTADO_FACTORING IN (
				 '3-PROSP. BOLETA GARANTIA ULTIMO ANO'
				,'4-PROSP. PAGOS RECIBIDOS: >= MM$1.000'
				,'5-PROSP. PAGOS RECIBIDOS: MM$100 - MM$999')
	AND	COALESCE(FAC.TE_PRIORIDAD,0)=999 THEN
	     CASE 
		    WHEN FAC.TC_ESTADO_LEAD IN ('ACEPTADO','AGENDADO') 
				THEN 6
		    WHEN FAC.TC_ESTADO_LEAD IN ('RECHAZO BCO.','RECHAZO CLI.') AND NOT (POSITION ('FFVV' IN FAC.TC_CAMPANA_ANT) > 0) 
				THEN 8
	     ELSE 7 END
	 ELSE FAC.TE_PRIORIDAD END 	AS TE_PRIORIDAD 		 			

,CASE WHEN 	
	FAC.TE_PROPENSO>0 
	AND	FAC.TC_TPO_BANCA = 'WHOLESALE'
	AND	COALESCE(TC_TIPO,'NUEVOS') = 'NUEVOS' 
	AND FAC.TC_ESTADO_FACTORING IN (
				 '3-PROSP. BOLETA GARANTIA ULTIMO ANO'
				,'4-PROSP. PAGOS RECIBIDOS: >= MM$1.000'
				,'5-PROSP. PAGOS RECIBIDOS: MM$100 - MM$999')
	AND	COALESCE(FAC.TE_PRIORIDAD,0)=999
			 THEN  'NUEVOS'
			 ELSE FAC.TC_TIPO_FINAL END AS TC_TIPO_FINAL 				

,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE                		AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		 
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_09 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 29;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_10;
	
.IF ERRORCODE <> 0 THEN .QUIT 30;

--/*******************************************************************   
--* 7 NUEVOS RESTO WHOLESALE (ES MEJOR QUE PROSPECTOS CON RECHAZO)  **
--/*********************************************************** ******/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_11;  
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_11
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 31;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_11
SELECT 		
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING		

,CASE WHEN 	
	FAC.TE_PROPENSO>0 
	AND FAC.TC_TPO_BANCA = 'WHOLESALE' 
	AND COALESCE(FAC.TC_TIPO,'NUEVOS') = 'NUEVOS'  
	AND COALESCE(FAC.TE_PRIORIDAD,0)=999
	AND NOT (FAC.TE_PROPENSO = 99)
		THEN 7
	    ELSE FAC.TE_PRIORIDAD END 	AS TE_PRIORIDAD 		 			

,CASE WHEN 	
	FAC.TE_PROPENSO>0 
	AND FAC.TC_TPO_BANCA = 'WHOLESALE' 
	AND COALESCE(FAC.TC_TIPO,'NUEVOS') = 'NUEVOS'  
	AND COALESCE(FAC.TE_PRIORIDAD,0)=999
	AND NOT (FAC.TE_PROPENSO = 99)
			 THEN  'NUEVOS'
			 ELSE FAC.TC_TIPO_FINAL END AS TC_TIPO_FINAL 				

,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE                		AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		  
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_10 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 32;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_11;
	
.IF ERRORCODE <> 0 THEN .QUIT 33;

--/*******************************************************************      
--* 9 NUEVOS- CLIENTES WHOLESALE NO PROPENSOS CON OFERTA DE RIESGOS **
--/*******************************************************************
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_12;    
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_12
(
	 PC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,PE_PERIODO_CMP_F					INTEGER 		
    ,PD_CLI_RUT          				DECIMAL(8,0)
    ,PC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PE_PROPENSO						INTEGER
    ,PC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,PD_PROB							DECIMAL (25,10)
    ,PC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,PC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,PE_CONVENCIMIENTO   				INTEGER
    ,PC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_PRIORIDAD						INTEGER
    ,PC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,PE_CTACTE							INTEGER
	,PE_IS_FUGADO                       BIGINT
    ,PE_CONOFERTARIESGOS    			INTEGER
	,PC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,PD_VECES_VTA_PROP					DECIMAL (1,0)
    ,PC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_VETADO_RIESGOS					INTEGER
    ,PE_MONTO_OFERTA					BIGINT
    ,PC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_MARCA_CODACTECO_FUERA 			INTEGER
    ,PC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_MARCA_RUTGOB    				INTEGER
    ,PE_ES_BCI          				INTEGER
    ,PE_CAPACITY_EJE    				INTEGER
    ,PE_CAPACITY_FFVV   				INTEGER
    ,PE_CUENTA          				INTEGER
    ,PE_FUERA_CAPACITY  				INTEGER
    ,PC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_EN_PLANEAMIENTO					INTEGER
    ,PC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,PD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,PC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_FDR 							INTEGER
    ,PE_COS_CLI             			INTEGER
    ,PE_FILTROS_RIESGOS     			INTEGER
    ,PC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,PE_PAR_FDR 						INTEGER
    ,PE_PAR_COS_CLI             		INTEGER
    ,PE_MOLESTO                 		INTEGER
    ,PE_CARGABLE                		INTEGER
    ,PC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_DUPLAS							INTEGER
    ,PE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (PE_PERIODO_CMP_F,PD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 34;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_12
SELECT 		
 FAC.TC_TPO_BANCA						AS PC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS PE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS PD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS PC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS PC_NOM_CLI          			
,FAC.TE_PROPENSO						AS PE_PROPENSO			

,CASE WHEN 	
	FAC.TE_PROPENSO=99 
	AND FAC.TC_TPO_BANCA = 'WHOLESALE' 
	AND FAC.TC_TIPO_FINAL = 'NUEVOS-'  
	AND COALESCE(FAC.TE_PRIORIDAD,0)=999
			 THEN  'NUEVOS-'
			 ELSE FAC.TC_TIPO END 		AS PC_TIPO 	

,FAC.TD_PROB                            AS PD_PROB
,FAC.TC_TRAMO_FACT                      AS PC_TRAMO_FACT	 
,FAC.TC_MARCA_FACTORING  				AS PC_MARCA_FACTORING  	
,FAC.TE_CONVENCIMIENTO   				AS PE_CONVENCIMIENTO   		 			
,FAC.TC_ESTADO_FACTORING				AS PC_ESTADO_FACTORING	

,CASE WHEN 	
	FAC.TE_PROPENSO=99 
	AND FAC.TC_TPO_BANCA = 'WHOLESALE' 
	AND FAC.TC_TIPO_FINAL = 'NUEVOS-'  
	AND COALESCE(FAC.TE_PRIORIDAD,0)=999
		THEN 9
	    ELSE FAC.TE_PRIORIDAD END 		AS PE_PRIORIDAD 		 			

,CASE WHEN 	
	FAC.TE_PROPENSO=99 
	AND FAC.TC_TPO_BANCA = 'WHOLESALE' 
	AND FAC.TC_TIPO_FINAL = 'NUEVOS-'  
	AND COALESCE(FAC.TE_PRIORIDAD,0)=999
			 THEN  'NUEVOS-'
			 ELSE FAC.TC_TIPO_FINAL END AS PC_TIPO_FINAL 				

,FAC.TC_ESTADO_LEAD						AS PC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS PC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS PE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS PE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS PE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS PC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS PD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS PC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS PC_EJE_FCT						
,FAC.TC_BANCO							AS PC_BANCO						
,FAC.TC_EJE_FFVV						AS PC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS PE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS PE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS PC_TIPO_OFERTA 	

--/***********************************************************************************
--** EXCLUIR CLIENTES QUE NO CALIFICAN POR ACTIVIDAD ECONÓMICA O RUT GUBERNAMENTAL.	**
--************************************************************************************/
,0 										AS PE_MARCA_CODACTECO_FUERA 	

,FAC.TC_COD_ACTECO  					AS PC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS PC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS PC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS PC_GLOSA 						
,FAC.TC_IVA 							AS PC_IVA 						
,FAC.TC_CATEGORIA 						AS PC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS PC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS PE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS PE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS PE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS PE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS PE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS PE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS PC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS PC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS PC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS PC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS PE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS PC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS PC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS PF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS PD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS PC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS PE_FDR    	
,FAC.TE_COS_CLI		               		AS PE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS PE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS PC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS PD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS PE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS PE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS PE_MOLESTO
,FAC.TE_CARGABLE                		AS PE_CARGABLE                	
,FAC.TC_ELIMINADO						AS PC_ELIMINADO										
,FAC.TE_DUPLAS							AS PE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS PE_ENROLADO_DTM	
FROM	
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_11 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 35;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_12;
	
.IF ERRORCODE <> 0 THEN .QUIT 36;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 11 C OK.sql




--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: REGLAS DE NEGOCIO PARA CAMPANA WHOLESALE FACTORING				 	      **
--**                                                    				 				  **
--** AUTOR  : MICHELL CUAREZ                                                			  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 04/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 10/2024			     	                                                  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	                                                                  **
--**    MKT_JOURNEYBUILDER_TB.S_CMP_EXT_RUTERO_EXCLUIR_POR_ACT_ECONOMICA                  **
--**	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_BASE_SII_TOTAL					                  **
--**	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_ACTIVIDAD_ECONOMICA                               **
--**	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_ACTIVIDAD_ECONOMICA_SII                           **
--**	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_COD_ACT_COMPRADAS_NOV16                           **
--**	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_COD_ACT_COMPRADAS_DIC16                           **
--**                  						                    			 			  **
--**TABLA TEMPORAL:	                                                                      **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_13 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_14 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_15 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_16 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_17 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_18 **
--**                  						                    			 			  **
--******************************************************************************************
--******************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/*******************************************************************
--** CREA TABLA TEMPORAL PARA AUSENCIA MESA MES 			  		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_RUTERO_EXCLUIR_POR_ACT_ECONOMICA;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_RUTERO_EXCLUIR_POR_ACT_ECONOMICA
(
	TD_RUT	 	DECIMAL(8,0)
	
)UNIQUE PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 37;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_RUTERO_EXCLUIR_POR_ACT_ECONOMICA
SELECT
	SE_RUT			AS TD_RUT
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_RUTERO_EXCLUIR_POR_ACT_ECONOMICA
QUALIFY ROW_NUMBER() OVER(PARTITION BY SE_RUT ORDER BY SE_RUT DESC) = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 38;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_RUTERO_EXCLUIR_POR_ACT_ECONOMICA;
.IF ERRORCODE <> 0 THEN .QUIT 39;
 
--/***********************************************************************************
--** EXCLUIR CLIENTES QUE NO CALIFICAN POR ACTIVIDAD ECONÓMICA O RUT GUBERNAMENTAL.	**
--************************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_13;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_13
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 40;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_13
SELECT 		
 FAC.PC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.PE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.PD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.PC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.PC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.PE_PROPENSO						AS TE_PROPENSO					
,FAC.PC_TIPO 							AS TC_TIPO 
,FAC.PD_PROB                            AS TD_PROB
,FAC.PC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.PC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.PE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.PC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.PE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.PC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.PC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.PC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.PE_CTACTE							AS TE_CTACTE      
,FAC.PE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.PE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.PC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.PD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.PC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.PC_EJE_FCT							AS TC_EJE_FCT						
,FAC.PC_BANCO							AS TC_BANCO						
,FAC.PC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.PE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.PE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.PC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 	

,CASE WHEN ECO.TD_RUT IS NOT NULL 
		THEN 1
		ELSE FAC.PE_MARCA_CODACTECO_FUERA END
 										AS TE_MARCA_CODACTECO_FUERA 	

,FAC.PC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.PC_ACT_ECO							AS TC_ACT_ECO						
,FAC.PC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.PC_GLOSA 							AS TC_GLOSA 						
,FAC.PC_IVA 							AS TC_IVA 						
,FAC.PC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.PC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.PE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.PE_ES_BCI          				AS TE_ES_BCI          			
,FAC.PE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.PE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.PE_CUENTA          				AS TE_CUENTA          			
,FAC.PE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.PC_TEXTO1 							AS TC_TEXTO1 						
,FAC.PC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.PC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.PC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.PE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.PC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.PC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.PF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.PD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.PC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.PE_FDR                   			AS TE_FDR    	
,FAC.PE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.PE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.PC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.PD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.PE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.PE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.PE_MOLESTO							AS TE_MOLESTO
,FAC.PE_CARGABLE                		AS TE_CARGABLE                	
,FAC.PC_ELIMINADO						AS TC_ELIMINADO										
,FAC.PE_DUPLAS							AS TE_DUPLAS						
,FAC.PE_ENROLADO_DTM					AS TE_ENROLADO_DTM		     
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_12 FAC
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_RUTERO_EXCLUIR_POR_ACT_ECONOMICA ECO 	
		ON FAC.PD_CLI_RUT = ECO.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 41;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_13;
	
.IF ERRORCODE <> 0 THEN .QUIT 42;

--/***********************************************************************
--**ACTUALIZAR CODIGO ACTIVIDAD ECONOMICA Y ACTIVIDAD ECONOMICA 		**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_14;		
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_14
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC		
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 43;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_14
SELECT 		
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 

,CASE WHEN ACT.SE_RUT IS NOT NULL 
		THEN ACT.SC_CODIGO_GIRO
		ELSE FAC.TC_COD_ACTECO END		AS TC_COD_ACTECO 	
			
,CASE WHEN ACT.SE_RUT IS NOT NULL 
		THEN ACT.SC_GLOSA_ACT_ECONOMICA
		ELSE FAC.TC_ACT_ECO END			AS TC_ACT_ECO 	
					
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE                		AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		     
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_13 FAC
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_ACTIVIDAD_ECONOMICA ACT 	
		ON FAC.TD_CLI_RUT = ACT.SE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 44;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_14;
	
.IF ERRORCODE <> 0 THEN .QUIT 45;

--/***********************************************************************
--** ACTUALIZAR CODIGO ACTIVIDAD ECONOMICA CON LA TABLA ECONOMICA_SII **  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_15;	
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_15
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 46;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_15
SELECT 		
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 	

,CASE WHEN SII.SE_RUT IS NOT NULL 
		THEN SII.SC_GIRO
		ELSE FAC.TC_COD_ACTECO END		AS TC_COD_ACTECO 	

,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE                		AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		     
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_14 FAC
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_ACTIVIDAD_ECONOMICA_SII SII	
		ON FAC.TD_CLI_RUT = SII.SE_RUT 
;
.IF ERRORCODE <> 0 THEN .QUIT 47;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_15;
	
.IF ERRORCODE <> 0 THEN .QUIT 48;

--/****************************************************************************
--** CREA TABLA MAXIMO ANO TRIBUTARIO							** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAXANO_BASE_SII_TOTAL;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAXANO_BASE_SII_TOTAL
(
	 TD_RUT 				 DECIMAL(8,0)
	,TE_MAXANO_TRIBUTARIO 	 INTEGER
)UNIQUE PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 49;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAXANO_BASE_SII_TOTAL
SELECT 
	 SE_RUT  				 AS TD_RUT
	,MAX(SE_ANO_TRIBUTARIO)  AS TE_MAXANO_TRIBUTARIO 
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_BASE_SII_TOTAL 
GROUP BY 
	SE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 50;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAXANO_BASE_SII_TOTAL;
	
.IF ERRORCODE <> 0 THEN .QUIT 51;

--/****************************************************************************
--** CREA TABLA BASE_SII							** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_BASE_SII;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_BASE_SII
(
	 TE_ANO_TRIBUTARIO 			INTEGER 
	,TD_RUT 					DECIMAL(8,0) 
	,TC_DV 						VARCHAR(8) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_RAZON_SOCIAL 			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_TRAMO 					INTEGER 
	,TE_N_TRABAJADORES 			INTEGER 
	,TC_RUBRO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_SUBRUBRO 				VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_ACTIVIDAD_ECONOMICA 	VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CALLE 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_NRO 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_BLOQUE 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_DEPTO 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_VILLA_POBLACION 		VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_COMUNA 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_REGION 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_COD_ACT 				VARCHAR(6)   CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CODACT					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (TD_RUT);
.IF ERRORCODE <> 0 THEN .QUIT 52;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_BASE_SII
SELECT 
	 SII.SE_ANO_TRIBUTARIO 				AS TE_ANO_TRIBUTARIO 		
    ,SII.SE_RUT 				        AS TD_RUT 				
    ,SII.SC_DV 					        AS TC_DV 					
    ,SII.SC_RAZON_SOCIAL 		        AS TC_RAZON_SOCIAL 		
    ,SII.SE_TRAMO 				        AS TE_TRAMO 				
    ,SII.SE_N_TRABAJADORES 		        AS TE_N_TRABAJADORES 		
    ,SII.SC_RUBRO 				        AS TC_RUBRO 				
    ,SII.SC_SUBRUBRO 			        AS TC_SUBRUBRO 			
    ,SII.SC_ACTIVIDAD_ECONOMICA         AS TC_ACTIVIDAD_ECONOMICA 
    ,SII.SC_CALLE 				        AS TC_CALLE 				
    ,SII.SC_NRO 				        AS TC_NRO 				
    ,SII.SC_BLOQUE 				        AS TC_BLOQUE 				
    ,SII.SC_DEPTO 				        AS TC_DEPTO 				
    ,SII.SC_VILLA_POBLACION 	        AS TC_VILLA_POBLACION 	
    ,SII.SC_COMUNA 				        AS TC_COMUNA 				
    ,SII.SC_REGION 				        AS TC_REGION 				
    ,SII.SC_COD_ACT 			        AS TC_COD_ACT 	
	,LEFT(SII.SC_ACTIVIDAD_ECONOMICA,6) AS TC_CODACT 
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_BASE_SII_TOTAL SII 
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAXANO_BASE_SII_TOTAL MAXB 
		ON SII.SE_RUT = MAXB.TD_RUT 
		AND SII.SE_ANO_TRIBUTARIO = MAXB.TE_MAXANO_TRIBUTARIO
;
.IF ERRORCODE <> 0 THEN .QUIT 53;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_BASE_SII;
	
.IF ERRORCODE <> 0 THEN .QUIT 54;

--/*******************************************************************************
--**ACTUALIZAR CODIGO ACTIVIDAD ECONOMICA Y ACT ECONOMICA CON LA TABLA BASE_SII **  
--*******************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_16;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_16
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC		
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 55;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_16
SELECT 		
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 	

,CASE WHEN BASE.TD_RUT IS NOT NULL 
		THEN BASE.TC_COD_ACT
		ELSE FAC.TC_COD_ACTECO END		AS TC_COD_ACTECO 	

,CASE WHEN BASE.TD_RUT IS NOT NULL 
		THEN BASE.TC_ACTIVIDAD_ECONOMICA
		ELSE FAC.TC_ACT_ECO END		AS TC_ACT_ECO 	
					
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE                		AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		   
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_15 FAC
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_BASE_SII BASE
		ON FAC.TD_CLI_RUT = BASE.TD_RUT 
;
.IF ERRORCODE <> 0 THEN .QUIT 56;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_16;
	
.IF ERRORCODE <> 0 THEN .QUIT 57;

--/****************************************************************************
--** CREA TABLA TEMPORAL PARA LAS ACTIVIDADES ECONOMICAS COMPRADAS EN NOV16	 **
--** LA TABLA TIENE DUPLICIDAD POR QUE UN RUT PUEDE TENER MAS DE UNA ACT ECO **
--** POR LO QUE LA ACTUALIZACION EN TD NO PERMITE ESTA SITUACION			 **
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_ACT_ECO_NOV16;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_ACT_ECO_NOV16
(
	 TD_RUT 				DECIMAL(8,0)
	,TE_COD_ACT_ECO			INTEGER
	,TE_OK					INTEGER
)UNIQUE PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 58;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_ACT_ECO_NOV16
SELECT 
	 SE_RUT							AS TD_RUT
	,SD_COD_ACTIVIDAD_ECONOMICA		AS TE_COD_ACT_ECO 
	,SD_OK							AS TE_OK
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_COD_ACT_COMPRADAS_NOV16 
QUALIFY ROW_NUMBER() OVER ( PARTITION BY SE_RUT ORDER BY SD_COD_ACTIVIDAD_ECONOMICA DESC ) = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 59;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_ACT_ECO_NOV16;
	
.IF ERRORCODE <> 0 THEN .QUIT 60;

--/***********************************************************************
--**ACTUALIZAR CODIGO ACTIVIDAD ECONOMICA CON LA TABLA COMPRADAS_NOV16**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_17;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_17
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 61;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_17
SELECT 		
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 	

,CASE WHEN NOV.TD_RUT IS NOT NULL 
	AND COALESCE(FAC.TC_COD_ACTECO,'') = ''
	AND NOV.TE_OK = 0
		THEN NOV.TE_COD_ACT_ECO
		ELSE FAC.TC_COD_ACTECO END		AS TC_COD_ACTECO 	
					
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE                		AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		   
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_16 FAC
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_ACT_ECO_NOV16 NOV
		ON FAC.TD_CLI_RUT = NOV.TD_RUT  
;
.IF ERRORCODE <> 0 THEN .QUIT 62;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_17;
	
.IF ERRORCODE <> 0 THEN .QUIT 63;

--/***********************************************************************
--**ACTUALIZAR CODIGO ACTIVIDAD ECONOMICA CON LA TABLA COMPRADAS_DIC16	**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_18;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_18
(
	 PC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,PE_PERIODO_CMP_F					INTEGER 		
    ,PD_CLI_RUT          				DECIMAL(8,0)
    ,PC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PE_PROPENSO						INTEGER
    ,PC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,PD_PROB							DECIMAL (25,10)
    ,PC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,PC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,PE_CONVENCIMIENTO   				INTEGER
    ,PC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_PRIORIDAD						INTEGER
    ,PC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,PE_CTACTE							INTEGER
	,PE_IS_FUGADO                       BIGINT
    ,PE_CONOFERTARIESGOS    			INTEGER
	,PC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,PD_VECES_VTA_PROP					DECIMAL (1,0)
    ,PC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_VETADO_RIESGOS					INTEGER
    ,PE_MONTO_OFERTA					BIGINT
    ,PC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_MARCA_CODACTECO_FUERA 			INTEGER
    ,PC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_MARCA_RUTGOB    				INTEGER
    ,PE_ES_BCI          				INTEGER
    ,PE_CAPACITY_EJE    				INTEGER
    ,PE_CAPACITY_FFVV   				INTEGER
    ,PE_CUENTA          				INTEGER
    ,PE_FUERA_CAPACITY  				INTEGER
    ,PC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_EN_PLANEAMIENTO					INTEGER
    ,PC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,PD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,PC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_FDR 							INTEGER
    ,PE_COS_CLI             			INTEGER
    ,PE_FILTROS_RIESGOS     			INTEGER
    ,PC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,PE_PAR_FDR 						INTEGER
    ,PE_PAR_COS_CLI             		INTEGER
    ,PE_MOLESTO                 		INTEGER
    ,PE_CARGABLE                		INTEGER
    ,PC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_DUPLAS							INTEGER
    ,PE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (PE_PERIODO_CMP_F,PD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 64;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_18
SELECT 		
 FAC.TC_TPO_BANCA						AS PC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS PE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS PD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS PC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS PC_NOM_CLI          			
,FAC.TE_PROPENSO						AS PE_PROPENSO					
,FAC.TC_TIPO 							AS PC_TIPO 
,FAC.TD_PROB                            AS PD_PROB
,FAC.TC_TRAMO_FACT                      AS PC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS PC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS PE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS PC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS PE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS PC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS PC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS PC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS PE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS PE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS PE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS PC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS PD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS PC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS PC_EJE_FCT						
,FAC.TC_BANCO							AS PC_BANCO						
,FAC.TC_EJE_FFVV						AS PC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS PE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS PE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS PC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS PE_MARCA_CODACTECO_FUERA 

,CASE WHEN DIC.SE_RUT IS NOT NULL 
	AND COALESCE(FAC.TC_COD_ACTECO,'') = ''
		THEN DIC.SD_COD_SII_1
		ELSE FAC.TC_COD_ACTECO END		AS PC_COD_ACTECO 	
	
,FAC.TC_ACT_ECO							AS PC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS PC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS PC_GLOSA 						
,FAC.TC_IVA 							AS PC_IVA 						
,FAC.TC_CATEGORIA 						AS PC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS PC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS PE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS PE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS PE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS PE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS PE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS PE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS PC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS PC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS PC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS PC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS PE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS PC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS PC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS PF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS PD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS PC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS PE_FDR    	
,FAC.TE_COS_CLI		               		AS PE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS PE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS PC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS PD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS PE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS PE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS PE_MOLESTO
,FAC.TE_CARGABLE                		AS PE_CARGABLE                	
,FAC.TC_ELIMINADO						AS PC_ELIMINADO										
,FAC.TE_DUPLAS							AS PE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS PE_ENROLADO_DTM		   
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_17 FAC
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_COD_ACT_COMPRADAS_DIC16 DIC
		ON FAC.TD_CLI_RUT = DIC.SE_RUT  
;
.IF ERRORCODE <> 0 THEN .QUIT 65;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_18;
	
.IF ERRORCODE <> 0 THEN .QUIT 66;


SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 11 D OK.sql


--******************************************************************************************
--** DSCRPCN: REGLAS DE NEGOCIO PARA CAMPANA WHOLESALE FACTORING				 	      **
--**                                                    				 				  **
--** AUTOR  : MICHELL CUAREZ                                                			  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 04/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 10/2024			     	                                                  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	                                                                  **
--**	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_ACTIVIDADECONOCOMPRA_TERA                         **
--**	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_DATOS_DIC16                                       **
--**	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_TABLA_HOMOLOGACION                                **
--**	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_TABLA_ACT_ECO                                     **
--**                  						                    			 			  **
--**TABLA TEMPORAL:	                                                                      **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_19 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_20 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_21 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_22 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_23 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_24 **
--**                  						                    			 			  **
--******************************************************************************************
--******************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/*****************************************************************************
--**ACTUALIZAR CODIGO ACTIVIDAD ECONOMICA CON LA TABLA ACTIVIDADECONOCOMPRA	  **  
--*****************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_19;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_19
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 67;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_19
SELECT 		
 FAC.PC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.PE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.PD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.PC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.PC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.PE_PROPENSO						AS TE_PROPENSO					
,FAC.PC_TIPO 							AS TC_TIPO 
,FAC.PD_PROB                            AS TD_PROB
,FAC.PC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.PC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.PE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.PC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.PE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.PC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.PC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.PC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.PE_CTACTE							AS TE_CTACTE      
,FAC.PE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.PE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.PC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.PD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.PC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.PC_EJE_FCT							AS TC_EJE_FCT						
,FAC.PC_BANCO							AS TC_BANCO						
,FAC.PC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.PE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.PE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.PC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.PE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 	

,CASE WHEN TER.SE_CLIENTE_RUT IS NOT NULL 
	AND COALESCE(FAC.PC_COD_ACTECO,'')='' 
	AND NOT (TER.SC_CODACTIVIDAD = '') 
		THEN TER.SC_CODACTIVIDAD
		ELSE FAC.PC_COD_ACTECO END		AS TC_COD_ACTECO 	
	
,FAC.PC_ACT_ECO							AS TC_ACT_ECO						
,FAC.PC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.PC_GLOSA 							AS TC_GLOSA 						
,FAC.PC_IVA 							AS TC_IVA 						
,FAC.PC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.PC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.PE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.PE_ES_BCI          				AS TE_ES_BCI          			
,FAC.PE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.PE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.PE_CUENTA          				AS TE_CUENTA          			
,FAC.PE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.PC_TEXTO1 							AS TC_TEXTO1 						
,FAC.PC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.PC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.PC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.PE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.PC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.PC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.PF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.PD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.PC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.PE_FDR                   			AS TE_FDR    	
,FAC.PE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.PE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.PC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.PD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.PE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.PE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.PE_MOLESTO							AS TE_MOLESTO
,FAC.PE_CARGABLE                		AS TE_CARGABLE                	
,FAC.PC_ELIMINADO						AS TC_ELIMINADO										
,FAC.PE_DUPLAS							AS TE_DUPLAS						
,FAC.PE_ENROLADO_DTM					AS TE_ENROLADO_DTM		    
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_18 FAC
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_ACTIVIDADECONOCOMPRA_TERA TER
		ON FAC.PD_CLI_RUT = TER.SE_CLIENTE_RUT  
;
.IF ERRORCODE <> 0 THEN .QUIT 68;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_19;
	
.IF ERRORCODE <> 0 THEN .QUIT 69;

--/***********************************************************************
--**TABLA TEMPORAL UNE INFORMACION DE DATOS_DIC16 Y TABLA HOMOLOGACION	**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CODIGOS;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CODIGOS
(
	 TD_RUT 					DECIMAL(8,0) 
	,TC_ACT_ECONO 				VARCHAR(8) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CODIGO_SII 				VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (TD_RUT);
.IF ERRORCODE <> 0 THEN .QUIT 70;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CODIGOS
SELECT 
	 DIC.SE_RUT 		AS TD_RUT
	,DIC.SC_ACT_ECONO 	AS TC_ACT_ECONO
	,HOM.SC_CODIGO_SII	AS TC_CODIGO_SII 
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_DATOS_DIC16 DIC 
	INNER JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_TABLA_HOMOLOGACION HOM 
		ON DIC.SC_ACT_ECONO=HOM.SC_CODIGO_BCI_SGC
WHERE 
	DIC.SC_ACT_ECONO IS NOT NULL
;
.IF ERRORCODE <> 0 THEN .QUIT 71;


--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CODIGOS;
	
.IF ERRORCODE <> 0 THEN .QUIT 72;

--/***********************************************************************************************
--**ACTUALIZAR CODIGO ACTIVIDAD ECONOMICA CON LA TABLA CODIGOS MIENTRAS EL CODIGO SEA VACIO		**  
--***********************************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_20;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_20
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 73;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_20
SELECT 		
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 	

,CASE WHEN COD.TD_RUT IS NOT NULL 
	AND COALESCE(FAC.TC_COD_ACTECO,'')='' 
		THEN COD.TC_CODIGO_SII
		ELSE FAC.TC_COD_ACTECO END		AS TC_COD_ACTECO 	
	
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE                		AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		     
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_19 FAC
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CODIGOS COD
		ON FAC.TD_CLI_RUT = COD.TD_RUT  
;
.IF ERRORCODE <> 0 THEN .QUIT 74;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_20;
	
.IF ERRORCODE <> 0 THEN .QUIT 75;

--/***********************************************************************
--**ACTUALIZAR CODIGO ACTIVIDAD ECONOMICA CON LA TABLA CODIGOS		**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_21;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_21
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 76;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_21
SELECT 		
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 	

,CASE WHEN COD.TD_RUT IS NOT NULL 
		THEN COD.TC_CODIGO_SII
		ELSE FAC.TC_COD_ACTECO END		AS TC_COD_ACTECO 	
	
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE                		AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		    
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_20 FAC
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CODIGOS COD
		ON FAC.TD_CLI_RUT = COD.TD_RUT  
;
.IF ERRORCODE <> 0 THEN .QUIT 77;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_21;
	
.IF ERRORCODE <> 0 THEN .QUIT 78;

--/***********************************************************************
--**TABLA TEMPORAL NOMBRE  CLIENTE						**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FACT_PYME_NOM_CLI;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FACT_PYME_NOM_CLI
(
	TC_NOM_CLI 		VARCHAR (77) CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (TC_NOM_CLI);
.IF ERRORCODE <> 0 THEN .QUIT 79;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FACT_PYME_NOM_CLI 
SELECT 
	PC_NOM_CLI AS TC_NOM_CLI
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_PO 
WHERE 
	POSITION ('MUNICIPA' IN PC_NOM_CLI) > 0 

UNION 

SELECT 
	PC_NOM_CLI AS TC_NOM_CLI
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_PO 
WHERE 
	POSITION ('CONGREGACION' IN PC_NOM_CLI) > 0 

UNION 

SELECT 
	PC_NOM_CLI AS TC_NOM_CLI
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_PO 
WHERE
	POSITION ('CONDOMINIO' IN PC_NOM_CLI) > 0 

UNION 

SELECT 
	PC_NOM_CLI AS TC_NOM_CLI
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_PO 
WHERE 
	POSITION ('COMUNIDAD' IN PC_NOM_CLI) > 0 
;
.IF ERRORCODE <> 0 THEN .QUIT 80;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_NOM_CLI)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FACT_PYME_NOM_CLI;
	
.IF ERRORCODE <> 0 THEN .QUIT 81;

--/***********************************************************************
--**ACTUALIZA MARCA COD ACTIVIDAD ECONOMICA CON TABLA PYME_NOM_CLI	**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_22;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_22
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 82;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_22
SELECT 		
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 		

,CASE WHEN 
	FAC.TE_MARCA_CODACTECO_FUERA = 0 AND
	FAC.TC_NOM_CLI = NOM.TC_NOM_CLI 
		THEN 1
		ELSE FAC.TE_MARCA_CODACTECO_FUERA END
										AS TE_MARCA_CODACTECO_FUERA 	

,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE                		AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		  
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_21 FAC
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FACT_PYME_NOM_CLI NOM
		ON FAC.TC_NOM_CLI = NOM.TC_NOM_CLI  
;
.IF ERRORCODE <> 0 THEN .QUIT 83;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_22;
	
.IF ERRORCODE <> 0 THEN .QUIT 84;

--/***********************************************************************
--**TABLA TEMPORAL DE CODIGOS 					**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_ENSENA;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_ENSENA
(
	 TC_CODIGO 		VARCHAR (10) CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (TC_CODIGO);
.IF ERRORCODE <> 0 THEN .QUIT 85;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_ENSENA
SELECT 
	SC_CODIGO AS TC_CODIGO
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_TABLA_ACT_ECO 
WHERE 
	(POSITION ('ENSEÑA' IN SC_TIPO_ACT_ECO) > 0)
GROUP BY 
	SC_CODIGO
;
.IF ERRORCODE <> 0 THEN .QUIT 86;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_CODIGO)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_ENSENA;
	
.IF ERRORCODE <> 0 THEN .QUIT 87;

--/***********************************************************************
--**ACTUALIZA MARCA COD ACTIVIDAD ECONOMICA CON TABLA ACT_ECO_ENSENA	**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_23;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_23
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 88;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_23
SELECT 		
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 	

,CASE WHEN 
	FAC.TE_MARCA_CODACTECO_FUERA = 0 AND
	FAC.TC_COD_ACTECO = ENS.TC_CODIGO 
		THEN 1
		ELSE FAC.TE_MARCA_CODACTECO_FUERA END
										AS TE_MARCA_CODACTECO_FUERA 	

,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE                		AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_22 FAC
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_ENSENA ENS
		ON 1 = 1
QUALIFY ROW_NUMBER() OVER(PARTITION BY FAC.TD_CLI_RUT ORDER BY FAC.TD_CLI_RUT ) = 1 	        
;
.IF ERRORCODE <> 0 THEN .QUIT 89;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_23;
	
.IF ERRORCODE <> 0 THEN .QUIT 90;

--/***********************************************************************
--**TABLA TEMPORAL DE CODIGO					**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_INTER;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_INTER
(
	TC_CODIGO 			VARCHAR (10) CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (TC_CODIGO);
.IF ERRORCODE <> 0 THEN .QUIT 91;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_INTER
SELECT 
	SC_CODIGO AS TC_CODIGO
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_TABLA_ACT_ECO 
WHERE 
	(POSITION ('INTERMEDIACIÓN MONETARIA' IN SC_TIPO_ACT_ECO) > 0)
GROUP BY 
	SC_CODIGO
;
.IF ERRORCODE <> 0 THEN .QUIT 92;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_CODIGO)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_INTER;
	
.IF ERRORCODE <> 0 THEN .QUIT 93;

--/***********************************************************************
--**ACTUALIZA MARCA_CODACTECO_FUERA **  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_24;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_24
(
	 PC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,PE_PERIODO_CMP_F					INTEGER 		
    ,PD_CLI_RUT          				DECIMAL(8,0)
    ,PC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PE_PROPENSO						INTEGER
    ,PC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,PD_PROB							DECIMAL (25,10)
    ,PC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,PC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,PE_CONVENCIMIENTO   				INTEGER
    ,PC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_PRIORIDAD						INTEGER
    ,PC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,PE_CTACTE							INTEGER
	,PE_IS_FUGADO                       BIGINT
    ,PE_CONOFERTARIESGOS    			INTEGER
	,PC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,PD_VECES_VTA_PROP					DECIMAL (1,0)
    ,PC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_VETADO_RIESGOS					INTEGER
    ,PE_MONTO_OFERTA					BIGINT
    ,PC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_MARCA_CODACTECO_FUERA 			INTEGER
    ,PC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_MARCA_RUTGOB    				INTEGER
    ,PE_ES_BCI          				INTEGER
    ,PE_CAPACITY_EJE    				INTEGER
    ,PE_CAPACITY_FFVV   				INTEGER
    ,PE_CUENTA          				INTEGER
    ,PE_FUERA_CAPACITY  				INTEGER
    ,PC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_EN_PLANEAMIENTO					INTEGER
    ,PC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,PD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,PC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_FDR 							INTEGER
    ,PE_COS_CLI             			INTEGER
    ,PE_FILTROS_RIESGOS     			INTEGER
    ,PC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,PE_PAR_FDR 						INTEGER
    ,PE_PAR_COS_CLI             		INTEGER
    ,PE_MOLESTO                 		INTEGER
    ,PE_CARGABLE                		INTEGER
    ,PC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_DUPLAS							INTEGER
    ,PE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (PE_PERIODO_CMP_F,PD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 94;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_24
SELECT 	
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS PD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS PC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS PC_NOM_CLI          			
,FAC.TE_PROPENSO						AS PE_PROPENSO					
,FAC.TC_TIPO 							AS PC_TIPO 
,FAC.TD_PROB                            AS PD_PROB
,FAC.TC_TRAMO_FACT                      AS PC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS PC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS PE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS PC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS PE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS PC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS PC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS PC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS PE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS PE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS PE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS PC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS PD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS PC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS PC_EJE_FCT						
,FAC.TC_BANCO							AS PC_BANCO						
,FAC.TC_EJE_FFVV						AS PC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS PE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS PE_MONTO_OFERTA						
,FAC.TC_TIPO_OFERTA 					AS PC_TIPO_OFERTA 			

,CASE WHEN 
	FAC.TC_COD_ACTECO=ECO.SC_CODIGO
	AND COALESCE(TO_NUMBER(FAC.TC_COD_ACTECO),0) > 0
	AND FAC.TE_MARCA_CODACTECO_FUERA=0
	AND NOT (FAC.TC_COD_ACTECO = '')
	AND FAC.TC_COD_ACTECO = AEI.TC_CODIGO
		THEN 1
		ELSE FAC.TE_MARCA_CODACTECO_FUERA END
										AS PE_MARCA_CODACTECO_FUERA 	

,FAC.TC_COD_ACTECO  					AS PC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS PC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS PC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS PC_GLOSA 						
,FAC.TC_IVA 							AS PC_IVA 						
,FAC.TC_CATEGORIA 						AS PC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS PC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS PE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS PE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS PE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS PE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS PE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS PE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS PC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS PC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS PC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS PC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS PE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS PC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS PC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS PF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS PD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS PC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS PE_FDR    	
,FAC.TE_COS_CLI		               		AS PE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS PE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS PC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS PD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS PE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS PE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS PE_MOLESTO
,FAC.TE_CARGABLE                		AS PE_CARGABLE                	
,FAC.TC_ELIMINADO						AS PC_ELIMINADO										
,FAC.TE_DUPLAS							AS PE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS PE_ENROLADO_DTM		 
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_23 FAC
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_TABLA_ACT_ECO ECO
		ON 1 = 1
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_INTER AEI
		ON 1 = 1
QUALIFY ROW_NUMBER() OVER(PARTITION BY FAC.TD_CLI_RUT ORDER BY FAC.TD_CLI_RUT ) = 1 		        
;
.IF ERRORCODE <> 0 THEN .QUIT 95;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_24;
	
.IF ERRORCODE <> 0 THEN .QUIT 96;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 11 E OK.sql



--******************************************************************************************
--** DSCRPCN: REGLAS DE NEGOCIO PARA CAMPANA WHOLESALE FACTORING				 	      **
--**                                                    				 				  **
--** AUTOR  : MICHELL CUAREZ                                                			  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 04/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 10/2024			     	                                                  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	                                                                  **
--**	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_NO_POTENCIAL_LYF                                  **
--**                  						                    			 			  **
--**TABLA TEMPORAL:	                                                                      **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_25 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_26 **
--**                  						                    			 			  **
--**TABLA DE SALIDA:	                                                                  **
--**  {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_RN **
--**                  						                    			 			  **
--******************************************************************************************
--******************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/*******************************************************************
--** EJECUTIVO ESPECIALISTA FACTORING					    		**
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF
(
	TD_RUT			DECIMAL(8,0)
) UNIQUE PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 98;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF
SELECT 
	 SE_RUT AS TD_RUT
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_NO_POTENCIAL_LYF 
WHERE 
	SC_PRODUCTO = 'FACTORING'
QUALIFY ROW_NUMBER() OVER(PARTITION BY SE_RUT ORDER BY SE_RUT ) = 1 	    
;
.IF ERRORCODE <> 0 THEN .QUIT 99;

--/* *********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF;
.IF ERRORCODE <> 0 THEN .QUIT 100;

--/***********************************************************************
--**ACTUALIZA MARCA_CODACTECO_FUERA	CON TABLA NO_POTENCIAL_LYF			**  
--**ACTUALIZA MARCA_RUTGOB												**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_25;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_25
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 101;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_25
SELECT 		
 FAC.PC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.PE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.PD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.PC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.PC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.PE_PROPENSO						AS TE_PROPENSO					
,FAC.PC_TIPO 							AS TC_TIPO 
,FAC.PD_PROB                            AS TD_PROB
,FAC.PC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.PC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.PE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.PC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.PE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.PC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.PC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.PC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.PE_CTACTE							AS TE_CTACTE      
,FAC.PE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.PE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.PC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.PD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.PC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.PC_EJE_FCT							AS TC_EJE_FCT						
,FAC.PC_BANCO							AS TC_BANCO						
,FAC.PC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.PE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.PE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.PC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 		

,CASE WHEN 
	POT.TD_RUT IS NOT NULL 
	AND FAC.PE_MARCA_CODACTECO_FUERA=0
		THEN 1
		ELSE FAC.PE_MARCA_CODACTECO_FUERA END
										AS TE_MARCA_CODACTECO_FUERA 	

,FAC.PC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.PC_ACT_ECO							AS TC_ACT_ECO						
,FAC.PC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.PC_GLOSA 							AS TC_GLOSA 						
,FAC.PC_IVA 							AS TC_IVA 						
,FAC.PC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.PC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 			

,CASE WHEN 
	FAC.PD_CLI_RUT     >= 60000000 
	AND FAC.PD_CLI_RUT <  70000000 
		THEN 1
		ELSE FAC.PE_MARCA_RUTGOB END
										AS TE_MARCA_RUTGOB    			

,FAC.PE_ES_BCI          				AS TE_ES_BCI          			
,FAC.PE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.PE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.PE_CUENTA          				AS TE_CUENTA          			
,FAC.PE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.PC_TEXTO1 							AS TC_TEXTO1 						
,FAC.PC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.PC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.PC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.PE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.PC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.PC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.PF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.PD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.PC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.PE_FDR                   			AS TE_FDR    	
,FAC.PE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.PE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.PC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.PD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.PE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.PE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.PE_MOLESTO							AS TE_MOLESTO
,FAC.PE_CARGABLE                		AS TE_CARGABLE                	
,FAC.PC_ELIMINADO						AS TC_ELIMINADO										
,FAC.PE_DUPLAS							AS TE_DUPLAS						
,FAC.PE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_24 FAC
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF POT
		ON FAC.PD_CLI_RUT = POT.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 102;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_25;
	
.IF ERRORCODE <> 0 THEN .QUIT 103;

--/*******************************************************************************
--**ACTUALIZA GLOSA, IVA CATEGORIA Y TIPO ACTIVIDAD ECONOMICA CON TABLA ACT_ECO	**  
--*******************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_26;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_26
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 104;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_26
SELECT 		
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS    
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI					

,CASE WHEN 
	FAC.TC_COD_ACTECO = ACT.SC_CODIGO
	AND COALESCE(TO_NUMBER(FAC.TC_COD_ACTECO),0) > 0
		THEN ACT.SC_GLOSA
		ELSE FAC.TC_GLOSA END			AS TC_GLOSA 	
 						
,CASE WHEN 
	FAC.TC_COD_ACTECO = ACT.SC_CODIGO
	AND COALESCE(TO_NUMBER(FAC.TC_COD_ACTECO),0) > 0
		THEN ACT.SC_IVA
		ELSE FAC.TC_IVA END				AS TC_IVA 	

,CASE WHEN 
	FAC.TC_COD_ACTECO = ACT.SC_CODIGO
	AND COALESCE(TO_NUMBER(FAC.TC_COD_ACTECO),0) > 0
		THEN ACT.SC_CATEGORIA
		ELSE FAC.TC_CATEGORIA END		AS TC_CATEGORIA 			

,CASE WHEN 
	FAC.TC_COD_ACTECO = ACT.SC_CODIGO
	AND COALESCE(TO_NUMBER(FAC.TC_COD_ACTECO),0) > 0
		THEN ACT.SC_TIPO_ACT_ECO
		ELSE FAC.TC_TIPO_ACT_ECO END	AS TC_TIPO_ACT_ECO 		

,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE                		AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		    
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_25 FAC
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_TABLA_ACT_ECO ACT
		ON 1 = 1
QUALIFY ROW_NUMBER() OVER(PARTITION BY FAC.TD_CLI_RUT ORDER BY FAC.TD_CLI_RUT ) = 1         
;
.IF ERRORCODE <> 0 THEN .QUIT 105;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_26;
	
.IF ERRORCODE <> 0 THEN .QUIT 106;

--/***********************************************************************
--**ACTUALIZA ES_BCI Y GENERA TABLA DE PRE CALCULO DE REGLA DE NEGOCIO
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_RN;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_RN
(
	 PC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,PE_PERIODO_CMP_F					INTEGER 		
    ,PD_CLI_RUT          				DECIMAL(8,0)
    ,PC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PE_PROPENSO						INTEGER
    ,PC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,PD_PROB							DECIMAL (25,10)
    ,PC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC            
    ,PC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,PE_CONVENCIMIENTO   				INTEGER
    ,PC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_PRIORIDAD						INTEGER
    ,PC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,PE_CTACTE							INTEGER
	,PE_IS_FUGADO                       BIGINT
    ,PE_CONOFERTARIESGOS    			INTEGER
	,PC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,PD_VECES_VTA_PROP					DECIMAL (1,0)
    ,PC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_VETADO_RIESGOS					INTEGER
    ,PE_MONTO_OFERTA					BIGINT
    ,PC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_MARCA_CODACTECO_FUERA 			INTEGER
    ,PC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_MARCA_RUTGOB    				INTEGER
    ,PE_ES_BCI          				INTEGER
    ,PE_CAPACITY_EJE    				INTEGER
    ,PE_CAPACITY_FFVV   				INTEGER
    ,PE_CUENTA          				INTEGER
    ,PE_FUERA_CAPACITY  				INTEGER
    ,PC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_EN_PLANEAMIENTO					INTEGER
    ,PC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,PD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,PC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_FDR 							INTEGER
    ,PE_COS_CLI             			INTEGER
    ,PE_FILTROS_RIESGOS     			INTEGER
    ,PC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,PE_PAR_FDR 						INTEGER
    ,PE_PAR_COS_CLI             		INTEGER
    ,PE_MOLESTO                 		INTEGER
    ,PE_CARGABLE                		INTEGER
    ,PC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_DUPLAS							INTEGER
    ,PE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (PE_PERIODO_CMP_F,PD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 107;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_RN
SELECT 		
 FAC.TC_TPO_BANCA						AS PC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS PE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS PD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS PC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS PC_NOM_CLI          			
,FAC.TE_PROPENSO						AS PE_PROPENSO					
,FAC.TC_TIPO 							AS PC_TIPO 	
,FAC.TD_PROB                            AS PD_PROB
,FAC.TC_TRAMO_FACT                      AS PC_TRAMO_FACT 									
,FAC.TC_MARCA_FACTORING  				AS PC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS PE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS PC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS PE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS PC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS PC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS PC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS PE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS PE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS PE_CONOFERTARIESGOS  
,FAC.TC_ZONA_CLIENTE	                AS PC_ZONA_CLIENTE	  							
,FAC.TD_VECES_VTA_PROP					AS PD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS PC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS PC_EJE_FCT						
,FAC.TC_BANCO							AS PC_BANCO						
,FAC.TC_EJE_FFVV						AS PC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS PE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS PE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS PC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS PE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS PC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS PC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS PC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS PC_GLOSA 						
,FAC.TC_IVA 							AS PC_IVA 						
,FAC.TC_CATEGORIA 						AS PC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS PC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS PE_MARCA_RUTGOB      

,CASE WHEN 
	POSITION('BCI' IN FAC.TC_NOM_CLI) > 0
		THEN 1
		ELSE FAC.TE_ES_BCI END			AS PE_ES_BCI 		

,FAC.TE_CAPACITY_EJE    				AS PE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS PE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS PE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS PE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS PC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS PC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS PC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS PC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS PE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS PC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS PC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS PF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS PD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS PC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS PE_FDR    	
,FAC.TE_COS_CLI		               		AS PE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS PE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS PC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS PD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS PE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS PE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS PE_MOLESTO
,FAC.TE_CARGABLE                		AS PE_CARGABLE                	
,FAC.TC_ELIMINADO						AS PC_ELIMINADO										
,FAC.TE_DUPLAS							AS PE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS PE_ENROLADO_DTM		           
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_RDN_26 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 108;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_RN;
	
.IF ERRORCODE <> 0 THEN .QUIT 109;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 11 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: REGLAS DE NEGOCIO PARA CAMPANA WHOLESALE FACTORING				 	      **
--**                                                    				 				  **
--** AUTOR  : MICHELL CUAREZ                                                			  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 04/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN:                                                           				  **
--** AUTOR  :                                                           				  **
--** FECHA  : SSAAMMDD                                                  				  **
--/********************************************************************************************
--**TABLA DE ENTRADA:	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_RUTERO_EXCLUIR_POR_ACT_ECONOMICA  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_BASE_SII_TOTAL					  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_ACTIVIDAD_ECONOMICA               **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_ACTIVIDAD_ECONOMICA_SII           **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_COD_ACT_COMPRADAS_NOV16           **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_COD_ACT_COMPRADAS_DIC16           **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_ACTIVIDADECONOCOMPRA_TERA         **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_DATOS_DIC16                       **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_TABLA_HOMOLOGACION                **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_TABLA_ACT_ECO                     **
--**					{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_NO_POTENCIAL_LYF                 **
--**TABLA DE SALIDA:   						                			 				 **
--**                  	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
--**                  						                    			 			  	 **
--*********************************************************************************************
--********************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/***********************************************************
--** LOS QUE TIENEN OFERTA DE RIESGOS PERO SIN PROPENSION 	**
--**				 CARGAN EN INBOUND						**
--************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET	
	 PC_TIPO_FINAL = 'NUEVOS-'
	,PC_TIPO = 'NUEVOS-'
	,PE_PROPENSO = 99
	,PC_TPO_BANCA = CASE 
						WHEN PC_MACRO_BANCA IN ('EMPRESARIOS','EMPRENDEDORES') THEN 'PYME' 
						WHEN PC_MACRO_BANCA IN ('EMPRESAS','GRANDES EMPRESAS','INMOBILIARIA','CORPORATIVA') THEN 'WHOLESALE'
						ELSE NULL
					END 
WHERE 
	PE_PROPENSO=0 
	AND PC_TIPO IS NULL
	AND PE_CONOFERTARIESGOS>0
;
.IF ERRORCODE <> 0 THEN .QUIT 1;

--/***********************************************************
--**				 ORDENO POR PE_PRIORIDAD WHOLESALE		**
--************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	PE_PRIORIDAD = 999
WHERE
	PE_PROPENSO>0 
	AND	PC_TPO_BANCA = 'WHOLESALE'
	AND NOT (PE_PROPENSO = 99)
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************  
--**			 1 CON VENCIMIENTOS WHOLESALE				**
--**				 CLIENTES CON VENCIMIENTOS 				**
--************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	 PE_PRIORIDAD = 1
	,PC_TIPO_FINAL = 'RECURRENTES'
WHERE 
	COALESCE(PC_TIPO_FINAL,'SIN ASIGNAR') = 'SIN ASIGNAR'
	AND	PC_TPO_BANCA = 'WHOLESALE' 
	AND	COALESCE(PE_CONVENCIMIENTO,0)>0 
	AND	COALESCE(PE_PRIORIDAD,0)= 999
;
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/***********************************************************    
--** 2 WHOLESALE CON MARCA FACTORING ULTIMO AÑO				**
--************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	 PE_PRIORIDAD = 2
	,PC_TIPO_FINAL = 'RECURRENTES'
WHERE 
	PE_PROPENSO>0 
	AND	PC_TPO_BANCA = 'WHOLESALE' 
	AND COALESCE(PC_TIPO_FINAL,'SIN ASIGNAR') = 'SIN ASIGNAR' 
	AND PC_ESTADO_FACTORING = '1-CLIENTE FACTORING ULTIMO ANO' 
	AND COALESCE(PE_CONVENCIMIENTO,0)=0 
	AND COALESCE(PE_PRIORIDAD,0)=999
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

--/***********************************************************
--** 		3 WHOLESALE CON MARCA RECURRENTES				**
--************************************************************/  
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	 PE_PRIORIDAD = 3
	,PC_TIPO_FINAL = 'RECURRENTES'
WHERE 
	PE_PROPENSO>0 
	AND	PC_TPO_BANCA = 'WHOLESALE'
	AND	COALESCE(PC_TIPO,'') = 'RECURRENTES' 
	AND NOT (POSITION ('FUGA' IN COALESCE(PC_MARCA_FACTORING,'')) > 0)
	AND	COALESCE(PE_PRIORIDAD,0)=999
;
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/***********************************************************
--** 		4 FUGADOS WHOLESALE			**
--************************************************************/    
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	 PE_PRIORIDAD = 4
	,PC_TIPO_FINAL = 'FUGADOS'
WHERE 
    PE_PROPENSO>0 
	AND	PC_TPO_BANCA = 'WHOLESALE' 
	AND	(POSITION ('FUGA' IN COALESCE(PC_MARCA_FACTORING,'')) > 0) 
	AND COALESCE(PE_PRIORIDAD,0)=999
;

UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	 PE_PRIORIDAD = 4
	,PC_TIPO_FINAL = 'FUGADOS'
WHERE 
    PE_PROPENSO>0 
	AND	PC_TPO_BANCA = 'WHOLESALE' 
	AND	PE_IS_FUGADO>0
	AND COALESCE(PE_PRIORIDAD,0)=999
;
.IF ERRORCODE <> 0 THEN .QUIT 6;
--/***********************************************************
--** 		5 EVIDENCIA WHOLESALE		**
--************************************************************/   
   
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	 PE_PRIORIDAD = 5
	,PC_TIPO_FINAL = 'EVIDENCIA'
WHERE 
    PE_PROPENSO>0 
	AND	PC_TPO_BANCA = 'WHOLESALE' 
	AND	PC_TIPO = 'EVIDENCIA' 
	AND	COALESCE(PE_PRIORIDAD,0)=999
;
.IF ERRORCODE <> 0 THEN .QUIT 7;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES;
	
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/****************************************************************************
--** CREA TABLA  PARA ESTADO FACTORING										 ** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_ESTADO_FACTORING;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_ESTADO_FACTORING
(
	TC_ESTADO_FACTORING VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC 
	
)PRIMARY INDEX (TC_ESTADO_FACTORING)
;
.IF ERRORCODE <> 0 THEN .QUIT 9;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_ESTADO_FACTORING VALUES('3-PROSP. BOLETA GARANTIA ULTIMO ANO');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_ESTADO_FACTORING VALUES('4-PROSP. PAGOS RECIBIDOS: >= MM$1.000');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_ESTADO_FACTORING VALUES('5-PROSP. PAGOS RECIBIDOS: MM$100 - MM$999');

.IF ERRORCODE <> 0 THEN .QUIT 10;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_ESTADO_FACTORING)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_ESTADO_FACTORING;
	
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/*********************************************************** 
--** NUEVOS CLIENTES CON ACEPTADO / AGENDADO / RECHAZO		**
--** 6 NUEVOS PROPENSOS ACEPTADADOS                   		**
--** 7 NUEVOS PROPENSOS                               		**
--** 8 NUEVOS PROPENSOS                               		**
--** 9 NUEVOS PROPENSOS RECHAZADOS                    		**
--************************************************************/    
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
--FROM 
--	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_ESTADO_FACTORING AS EFA
SET 
	PE_PRIORIDAD = 
	     CASE 
		    WHEN PC_ESTADO_LEAD IN ('ACEPTADO','AGENDADO') THEN 6
		    WHEN PC_ESTADO_LEAD IN ('RECHAZO BCO.','RECHAZO CLI.') AND NOT (POSITION ('FFVV' IN PC_CAMPANA_ANT) > 0) THEN 8
	     ELSE 7
	END
	,PC_TIPO_FINAL = 'NUEVOS'
WHERE 
	PE_PROPENSO>0 
	AND	PC_TPO_BANCA = 'WHOLESALE'
	AND	COALESCE(PC_TIPO,'NUEVOS') = 'NUEVOS' 
--	AND PC_ESTADO_FACTORING = EFA.TC_ESTADO_FACTORING
	AND PC_ESTADO_FACTORING IN (SEL TC_ESTADO_FACTORING FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_ESTADO_FACTORING)
	AND	COALESCE(PE_PRIORIDAD,0)=999
;
.IF ERRORCODE <> 0 THEN .QUIT 12;
--/*******************************************************************   
--* 7 NUEVOS RESTO WHOLESALE (ES MEJOR QUE PROSPECTOS CON RECHAZO)  **
--/*********************************************************** ******/  
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	 PE_PRIORIDAD = 7
	,PC_TIPO_FINAL = 'NUEVOS'
WHERE 
	PE_PROPENSO>0 
	AND PC_TPO_BANCA = 'WHOLESALE' 
	AND COALESCE(PC_TIPO,'NUEVOS') = 'NUEVOS'  
	AND COALESCE(PE_PRIORIDAD,0)=999
	AND NOT (PE_PROPENSO = 99)
;
.IF ERRORCODE <> 0 THEN .QUIT 13;
--/*******************************************************************      
--* 9 NUEVOS- CLIENTES WHOLESALE NO PROPENSOS CON OFERTA DE RIESGOS **
--/*******************************************************************      
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	 PE_PRIORIDAD = 9
	,PC_TIPO_FINAL = 'NUEVOS-'
    ,PC_TIPO = 'NUEVOS-'
WHERE 
	PE_PROPENSO=99 
	AND PC_TPO_BANCA = 'WHOLESALE' 
	AND PC_TIPO_FINAL = 'NUEVOS-'  
	AND COALESCE(PE_PRIORIDAD,0)=999
;
.IF ERRORCODE <> 0 THEN .QUIT 14;
--/***********************************************************************************
--** EXCLUIR CLIENTES QUE NO CALIFICAN POR ACTIVIDAD ECONÓMICA O RUT GUBERNAMENTAL.	**
--************************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
SET 
	PE_MARCA_CODACTECO_FUERA=0  -- YA VIENE CERO XQ VOLVERLO A PONER? RSP: ES UNA DOBLE VALIDACION, ESTAR OJO EN LAS PRUBAS
;
.IF ERRORCODE <> 0 THEN .QUIT 15;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES ;
	
.IF ERRORCODE <> 0 THEN .QUIT 56;

--/*******************************************************************
--** CREA TABLA TEMPORAL PARA AUSENCIA MESA MES 			  		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_RUTERO_EXCLUIR_POR_ACT_ECONOMICA;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_RUTERO_EXCLUIR_POR_ACT_ECONOMICA
(
	TE_RUT	 	INTEGER
	
)PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 10;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_RUTERO_EXCLUIR_POR_ACT_ECONOMICA
SELECT
	SE_RUT			AS TE_RUT
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_RUTERO_EXCLUIR_POR_ACT_ECONOMICA
QUALIFY ROW_NUMBER() OVER(PARTITION BY SE_RUT ORDER BY SE_RUT DESC) = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_RUTERO_EXCLUIR_POR_ACT_ECONOMICA;
.IF ERRORCODE <> 0 THEN .QUIT 12;
 
 --/***********************************************************************************
--** EXCLUIR CLIENTES QUE NO CALIFICAN POR ACTIVIDAD ECONÓMICA O RUT GUBERNAMENTAL.	**
--************************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_RUTERO_EXCLUIR_POR_ACT_ECONOMICA AS ECO 
SET 
	PE_MARCA_CODACTECO_FUERA = 1 
WHERE
	 PE_CLI_RUT=ECO.TE_RUT

;
.IF ERRORCODE <> 0 THEN .QUIT 16;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES;
	
.IF ERRORCODE <> 0 THEN .QUIT 17;

--/****************************************************************************
--** CREA TABLA MAXIMO ANO TRIBUTARIO							** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAXANO_BASE_SII_TOTAL;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAXANO_BASE_SII_TOTAL
(
	 TE_RUT 				 INTEGER
	,TE_MAXANO_TRIBUTARIO 	 INTEGER
)PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 18;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAXANO_BASE_SII_TOTAL
SELECT 
	 SE_RUT  				 AS TE_RUT
	,MAX(SE_ANO_TRIBUTARIO)  AS TE_MAXANO_TRIBUTARIO 
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_BASE_SII_TOTAL 
GROUP BY 
	SE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 19;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAXANO_BASE_SII_TOTAL;
	
.IF ERRORCODE <> 0 THEN .QUIT 20;

--/****************************************************************************
--** CREA TABLA BASE_SII							** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_BASE_SII;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_BASE_SII
(
	 TE_ANO_TRIBUTARIO 			INTEGER 
	,TE_RUT 					INTEGER 
	,TC_DV 						VARCHAR(8) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_RAZON_SOCIAL 			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_TRAMO 					INTEGER 
	,TE_N_TRABAJADORES 			INTEGER 
	,TC_RUBRO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_SUBRUBRO 				VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_ACTIVIDAD_ECONOMICA 	VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CALLE 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_NRO 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_BLOQUE 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_DEPTO 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_VILLA_POBLACION 		VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_COMUNA 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_REGION 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_COD_ACT 				VARCHAR(6)   CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CODACT					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
)
PRIMARY INDEX (TE_RUT);
.IF ERRORCODE <> 0 THEN .QUIT 21;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_BASE_SII
SELECT 
	 SII.SE_ANO_TRIBUTARIO 				AS TE_ANO_TRIBUTARIO 		
    ,SII.SE_RUT 				        AS TE_RUT 				
    ,SII.SC_DV 					        AS TC_DV 					
    ,SII.SC_RAZON_SOCIAL 		        AS TC_RAZON_SOCIAL 		
    ,SII.SE_TRAMO 				        AS TE_TRAMO 				
    ,SII.SE_N_TRABAJADORES 		        AS TE_N_TRABAJADORES 		
    ,SII.SC_RUBRO 				        AS TC_RUBRO 				
    ,SII.SC_SUBRUBRO 			        AS TC_SUBRUBRO 			
    ,SII.SC_ACTIVIDAD_ECONOMICA         AS TC_ACTIVIDAD_ECONOMICA 
    ,SII.SC_CALLE 				        AS TC_CALLE 				
    ,SII.SC_NRO 				        AS TC_NRO 				
    ,SII.SC_BLOQUE 				        AS TC_BLOQUE 				
    ,SII.SC_DEPTO 				        AS TC_DEPTO 				
    ,SII.SC_VILLA_POBLACION 	        AS TC_VILLA_POBLACION 	
    ,SII.SC_COMUNA 				        AS TC_COMUNA 				
    ,SII.SC_REGION 				        AS TC_REGION 				
    ,SII.SC_COD_ACT 			        AS TC_COD_ACT 	
	,LEFT(SII.SC_ACTIVIDAD_ECONOMICA,6) AS TC_CODACT 
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_BASE_SII_TOTAL AS SII 
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAXANO_BASE_SII_TOTAL AS MAXB 
		ON SII.SE_RUT = MAXB.TE_RUT 
		AND SII.SE_ANO_TRIBUTARIO = MAXB.TE_MAXANO_TRIBUTARIO
;
.IF ERRORCODE <> 0 THEN .QUIT 22;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_BASE_SII;
	
.IF ERRORCODE <> 0 THEN .QUIT 23;

--/***********************************************************************
--**ACTUALIZAR CODIGO ACTIVIDAD ECONOMICA Y ACTIVIDAD ECONOMICA 		**  
--***********************************************************************/		
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_ACTIVIDAD_ECONOMICA AS ACT
SET 
	 PC_COD_ACTECO = ACT.SC_CODIGO_GIRO
	,PC_ACT_ECO = ACT.SC_GLOSA_ACT_ECONOMICA
WHERE 
	PE_CLI_RUT=ACT.SE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 24;


--/***********************************************************************
--** ACTUALIZAR CODIGO ACTIVIDAD ECONOMICA CON LA TABLA ECONOMICA_SII **  
--***********************************************************************/		

UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_ACTIVIDAD_ECONOMICA_SII AS SII
SET 
	PC_COD_ACTECO = SII.SC_GIRO 
WHERE 
	PE_CLI_RUT = SII.SE_RUT 
;	
.IF ERRORCODE <> 0 THEN .QUIT 25;


--/*******************************************************************************
--**ACTUALIZAR CODIGO ACTIVIDAD ECONOMICA Y ACT ECONOMICA CON LA TABLA BASE_SII **  
--*******************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_BASE_SII AS BASE
SET 
	 PC_COD_ACTECO=BASE.TC_COD_ACT
	,PC_ACT_ECO = BASE.TC_ACTIVIDAD_ECONOMICA
WHERE 
	PE_CLI_RUT=TE_RUT 
;
.IF ERRORCODE <> 0 THEN .QUIT 26;

--/****************************************************************************
--** CREA TABLA TEMPORAL PARA LAS ACTIVIDADES ECONOMICAS COMPRADAS EN NOV16	 **
--** LA TABLA TIENE DUPLICIDAD POR QUE UN RUT PUEDE TENER MAS DE UNA ACT ECO **
--** POR LO QUE LA ACTUALIZACION EN TD NO PERMITE ESTA SITUACION			 **
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_ACT_ECO_NOV16;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_ACT_ECO_NOV16
(
	 TE_RUT 				INTEGER
	,TE_COD_ACT_ECO			INTEGER
	,TE_OK					INTEGER
)PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 22;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_ACT_ECO_NOV16
SELECT 
	 SE_RUT							AS TE_RUT
	,SD_COD_ACTIVIDAD_ECONOMICA		AS TE_COD_ACT_ECO 
	,SD_OK							AS TE_OK
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_COD_ACT_COMPRADAS_NOV16 
QUALIFY ROW_NUMBER() OVER ( PARTITION BY SE_RUT ORDER BY SD_COD_ACTIVIDAD_ECONOMICA DESC ) = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 23;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_ACT_ECO_NOV16;
	
.IF ERRORCODE <> 0 THEN .QUIT 24;


--/***********************************************************************
--**ACTUALIZAR CODIGO ACTIVIDAD ECONOMICA CON LA TABLA COMPRADAS_NOV16**  
--***********************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_ACT_ECO_NOV16 AS NOV
SET 
	PC_COD_ACTECO = NOV.TE_COD_ACT_ECO
WHERE 
	PE_CLI_RUT = NOV.TE_RUT 
	AND COALESCE(PC_COD_ACTECO,'') = ''
	AND NOV.TE_OK = 0
;
.IF ERRORCODE <> 0 THEN .QUIT 27;

--/***********************************************************************
--**ACTUALIZAR CODIGO ACTIVIDAD ECONOMICA CON LA TABLA COMPRADAS_DIC16	**  
--***********************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_COD_ACT_COMPRADAS_DIC16 AS DIC
SET 
	PC_COD_ACTECO=DIC.SD_COD_SII_1 
WHERE
	PE_CLI_RUT=DIC.SE_RUT 
	AND COALESCE(PC_COD_ACTECO,'')=''
;
.IF ERRORCODE <> 0 THEN .QUIT 28;


--/*****************************************************************************
--**ACTUALIZAR CODIGO ACTIVIDAD ECONOMICA CON LA TABLA ACTIVIDADECONOCOMPRA	  **  
--*****************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_ACTIVIDADECONOCOMPRA_TERA AS TER
SET 
	PC_COD_ACTECO=TER.SC_CODACTIVIDAD
WHERE
	PE_CLI_RUT=TER.SE_CLIENTE_RUT 
	AND COALESCE(PC_COD_ACTECO,'')='' 
	AND NOT (TER.SC_CODACTIVIDAD = '')
;
.IF ERRORCODE <> 0 THEN .QUIT 29;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES ;
	
.IF ERRORCODE <> 0 THEN .QUIT 30;

--/***********************************************************************
--**TABLA TEMPORAL UNE INFORMACION DE DATOS_DIC16 Y TABLA HOMOLOGACION	**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CODIGOS;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CODIGOS
(
	 TE_RUT 					INTEGER 
	,TC_ACT_ECONO 				VARCHAR(8) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CODIGO_SII 				VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
)
PRIMARY INDEX (TE_RUT);
.IF ERRORCODE <> 0 THEN .QUIT 31;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CODIGOS
SELECT 
	 DIC.SE_RUT 		AS TE_RUT
	,DIC.SC_ACT_ECONO 	AS TC_ACT_ECONO
	,HOM.SC_CODIGO_SII	AS TC_CODIGO_SII 
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_DATOS_DIC16 AS DIC 
	INNER JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_TABLA_HOMOLOGACION AS HOM 
		ON DIC.SC_ACT_ECONO=HOM.SC_CODIGO_BCI_SGC
WHERE 
	DIC.SC_ACT_ECONO IS NOT NULL
;
.IF ERRORCODE <> 0 THEN .QUIT 32;


--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CODIGOS;
	
.IF ERRORCODE <> 0 THEN .QUIT 33;

--/***********************************************************************************************
--**ACTUALIZAR CODIGO ACTIVIDAD ECONOMICA CON LA TABLA CODIGOS MIENTRAS EL CODIGO SEA VACIO		**  
--***********************************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CODIGOS AS COD
SET 
	PC_COD_ACTECO=COD.TC_CODIGO_SII
WHERE
	PE_CLI_RUT=COD.TE_RUT 
	AND COALESCE(PC_COD_ACTECO,'')='' 
;
.IF ERRORCODE <> 0 THEN .QUIT 34;
--/***********************************************************************
--**ACTUALIZAR CODIGO ACTIVIDAD ECONOMICA CON LA TABLA CODIGOS		**  
--***********************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CODIGOS AS COD
SET 
	PC_COD_ACTECO_BCI=COD.TC_CODIGO_SII
WHERE
	PE_CLI_RUT=COD.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 35;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES ;
	
.IF ERRORCODE <> 0 THEN .QUIT 36;

--/***********************************************************************
--**TABLA TEMPORAL DE CODIGOS 					**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_ENSENA;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_ENSENA
(
	 TC_CODIGO 		VARCHAR (10) CHARACTER SET LATIN NOT CASESPECIFIC
)
PRIMARY INDEX (TC_CODIGO);
.IF ERRORCODE <> 0 THEN .QUIT 37;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_ENSENA
SELECT 
	SC_CODIGO AS TC_CODIGO
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_TABLA_ACT_ECO 
WHERE 
	(POSITION ('ENSEÑA' IN SC_TIPO_ACT_ECO) > 0)
GROUP BY 
	SC_CODIGO
;
.IF ERRORCODE <> 0 THEN .QUIT 38;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_CODIGO)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_ENSENA;
	
.IF ERRORCODE <> 0 THEN .QUIT 39;
--/***********************************************************************
--**TABLA TEMPORAL NOMBRE  CLIENTE						**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FACT_PYME_NOM_CLI;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FACT_PYME_NOM_CLI
(
	TC_NOM_CLI 		VARCHAR (77) CHARACTER SET LATIN NOT CASESPECIFIC
)
PRIMARY INDEX (TC_NOM_CLI);
.IF ERRORCODE <> 0 THEN .QUIT 40;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FACT_PYME_NOM_CLI 
SELECT 
	PC_NOM_CLI AS TC_NOM_CLI
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
WHERE 
	POSITION ('MUNICIPA' IN PC_NOM_CLI) > 0 

UNION ALL

SELECT 
	PC_NOM_CLI AS TC_NOM_CLI
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
WHERE 
	POSITION ('CONGREGACION' IN PC_NOM_CLI) > 0 

UNION ALL

SELECT 
	PC_NOM_CLI AS TC_NOM_CLI
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
WHERE
	POSITION ('CONDOMINIO' IN PC_NOM_CLI) > 0 

UNION ALL

SELECT 
	PC_NOM_CLI AS TC_NOM_CLI
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
WHERE 
	POSITION ('COMUNIDAD' IN PC_NOM_CLI) > 0 
;
.IF ERRORCODE <> 0 THEN .QUIT 41;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_NOM_CLI)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FACT_PYME_NOM_CLI;
	
.IF ERRORCODE <> 0 THEN .QUIT 42;
--/***********************************************************************
--**ACTUALIZA MARCA COD ACTIVIDAD ECONOMICA CON TABLA PYME_NOM_CLI	**  
--***********************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FACT_PYME_NOM_CLI AS NOM
SET 
	PE_MARCA_CODACTECO_FUERA = 1
WHERE 
	PE_MARCA_CODACTECO_FUERA=0 
	AND	PC_NOM_CLI = NOM.TC_NOM_CLI 
;

--/***********************************************************************
--**ACTUALIZA MARCA COD ACTIVIDAD ECONOMICA CON TABLA ACT_ECO_ENSENA	**  
--***********************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_ENSENA AS ENS
SET 
	PE_MARCA_CODACTECO_FUERA = 1
WHERE 	
	PE_MARCA_CODACTECO_FUERA=0 
	AND PC_COD_ACTECO = ENS.TC_CODIGO  
;

.IF ERRORCODE <> 0 THEN .QUIT 43;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES ;
	
.IF ERRORCODE <> 0 THEN .QUIT 44;

--/***********************************************************************
--**TABLA TEMPORAL DE CODIGO					**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_INTER;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_INTER
(
	TC_CODIGO 			VARCHAR (10) CHARACTER SET LATIN NOT CASESPECIFIC
)
PRIMARY INDEX (TC_CODIGO);
.IF ERRORCODE <> 0 THEN .QUIT 45;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_INTER
SELECT 
	SC_CODIGO AS TC_CODIGO
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_TABLA_ACT_ECO 
WHERE 
	(POSITION ('INTERMEDIACIÓN MONETARIA' IN SC_TIPO_ACT_ECO) > 0)
GROUP BY 
	SC_CODIGO
;
.IF ERRORCODE <> 0 THEN .QUIT 46;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_CODIGO)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_INTER;
	
.IF ERRORCODE <> 0 THEN .QUIT 47;

--/***********************************************************************
--**ACTUALIZA MARCA_CODACTECO_FUERA **  
--***********************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
FROM
	 MKT_JOURNEYBUILDER_TB.S_CMP_EXT_TABLA_ACT_ECO AS ECO
	,{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_TABLA_ACT_ECO_INTER AS AEI
SET
	PE_MARCA_CODACTECO_FUERA = 1
WHERE
	PC_COD_ACTECO=ECO.SC_CODIGO
	AND COALESCE(TO_NUMBER(PC_COD_ACTECO),0) > 0
	AND PE_MARCA_CODACTECO_FUERA=0
	AND NOT (PC_COD_ACTECO = '')
	AND PC_COD_ACTECO = AEI.TC_CODIGO
;
.IF ERRORCODE <> 0 THEN .QUIT 48;

--/*******************************************************************
--** EJECUTIVO ESPECIALISTA FACTORING					    		**
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF
(
	TE_RUT			INTEGER
) PRIMARY INDEX ( TE_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 49;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF
SELECT 
	 SE_RUT AS TE_RUT
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_NO_POTENCIAL_LYF 
WHERE 
	SC_PRODUCTO = 'FACTORING'
;
.IF ERRORCODE <> 0 THEN .QUIT 50;

--/* *********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF;
.IF ERRORCODE <> 0 THEN .QUIT 51;

--/***********************************************************************
--**ACTUALIZA MARCA_CODACTECO_FUERA	CON TABLA NO_POTENCIAL_LYF			**  
--***********************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF AS POT
SET 
	PE_MARCA_CODACTECO_FUERA=1 
WHERE
	PE_CLI_RUT = POT.TE_RUT
	AND PE_MARCA_CODACTECO_FUERA=0
;
.IF ERRORCODE <> 0 THEN .QUIT 52;
--/***********************************************************************
--**ACTUALIZA MARCA_RUTGOB					**  
--***********************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
SET
	PE_MARCA_RUTGOB=1  
WHERE 
	PE_CLI_RUT>=60000000 
	AND PE_CLI_RUT<70000000 
;
.IF ERRORCODE <> 0 THEN .QUIT 53;
--/*******************************************************************************
--**ACTUALIZA GLOSA, IVA CATEGORIA Y TIPO ACTIVIDAD ECONOMICA CON TABLA ACT_ECO	**  
--*******************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_TABLA_ACT_ECO AS ACT
SET 
	 PC_GLOSA=ACT.SC_GLOSA
	,PC_IVA=ACT.SC_IVA
	,PC_CATEGORIA=ACT.SC_CATEGORIA
	,PC_TIPO_ACT_ECO=ACT.SC_TIPO_ACT_ECO
WHERE
	PC_COD_ACTECO=ACT.SC_CODIGO
	AND COALESCE(TO_NUMBER(PC_COD_ACTECO),0) > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 54;
--/***********************************************************************
--**ACTUALIZA ES_BCI **  
--***********************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
SET 
	PE_ES_BCI=1
WHERE 
	POSITION('BCI' IN PC_NOM_CLI) > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 55;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES ;
	
.IF ERRORCODE <> 0 THEN .QUIT 56;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 12 A OK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: PARA CAMPANA WHOLESALE FACTORING SE APLICA REGLA PARA MARCA CLIENTE		  **
--**                                                    				 				  **
--** AUTOR  : MICHELL CUAREZ                                                			  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 04/2022                                                   				  **
--*****************************************************************************************/
--** MANTNCN: FILTRO CLIENTE NO DESEADOS                                                  **
--** AUTOR  : IGNACIO LAGOS                                                          	  **
--** FECHA  : 02/2024                                                  				      **
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 10/2024			     	                                                  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	                                                                  **
--**  MKT_JOURNEYBUILDER_TB.S_CMP_MACRO_BANCA			  			                      **
--**  MKT_JOURNEYBUILDER_TB.S_CMP_EXT_EJECUTIVO_FACT_ESPECIALISTAS                        **
--**  MKT_JOURNEYBUILDER_TB.S_CMP_EXT_DOTACION_FACT_LEA			                          **
--**  MKT_JOURNEYBUILDER_TB.S_CMP_EXT_NO_POTENCIAL_LYF                                    **
--**  {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_RN **
--**																					  **     
--**TABLA TEMPORAL:	                                                                      **    
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_01 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_02 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_03 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_04 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAX_USER_ESPECIALISTAS         **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_DIST_NO_POTENCIAL_LYF          **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_01       **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_01       **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_TIPO_FINAL                     **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF_RUT_UNI       **
--**																					  **     
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/***********************************************************
--** MARCO CLIENTES FINALMENTE CAMPANABLES					**
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_01
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC		  
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC   
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 1;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_01
SELECT
 FAC.PC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.PE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.PD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.PC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.PC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.PE_PROPENSO						AS TE_PROPENSO					
,FAC.PC_TIPO 							AS TC_TIPO 
,FAC.PD_PROB                            AS TD_PROB
,FAC.PC_TRAMO_FACT                      AS TC_TRAMO_FACT 										
,FAC.PC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.PE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.PC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.PE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.PC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.PC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.PC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.PE_CTACTE							AS TE_CTACTE      
,FAC.PE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.PE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.PC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.PD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.PC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.PC_EJE_FCT							AS TC_EJE_FCT						
,FAC.PC_BANCO							AS TC_BANCO						
,FAC.PC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.PE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.PE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.PC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.PE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.PC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.PC_ACT_ECO							AS TC_ACT_ECO						
,FAC.PC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.PC_GLOSA 							AS TC_GLOSA 						
,FAC.PC_IVA 							AS TC_IVA 						
,FAC.PC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.PC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.PE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.PE_ES_BCI          				AS TE_ES_BCI          			
,FAC.PE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.PE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.PE_CUENTA          				AS TE_CUENTA          			
,FAC.PE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.PC_TEXTO1 							AS TC_TEXTO1 						
,FAC.PC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.PC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.PC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.PE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.PC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.PC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.PF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.PD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.PC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.PE_FDR                   			AS TE_FDR    	
,FAC.PE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.PE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.PC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.PD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.PE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.PE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.PE_MOLESTO							AS TE_MOLESTO

,CASE WHEN 	FAC.PE_FILTROS_RIESGOS > 0          
	AND FAC.PE_PROPENSO > 0                 
	AND FAC.PE_MARCA_RUTGOB = 0              
	AND FAC.PE_MARCA_CODACTECO_FUERA = 0     
	AND FAC.PE_ES_BCI = 0                  
	AND NOT (COALESCE(FAC.PC_EJE_FCT,'0') = '0')
	AND MACR.SC_MACRO_BANCA IS NOT NULL
	AND FAC.PE_MOLESTO = 0      
	AND COALESCE(FAC.PE_CTACTE,0) > 0   
	AND COALESCE(FAC.PE_VETADO_RIESGOS,0) = 0
	THEN 1
	ELSE FAC.PE_CARGABLE END       		AS TE_CARGABLE                	

,FAC.PC_ELIMINADO						AS TC_ELIMINADO										
,FAC.PE_DUPLAS							AS TE_DUPLAS						
,FAC.PE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_RN FAC
    LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_MACRO_BANCA MACR
            ON FAC.PC_MACRO_BANCA = MACR.SC_MACRO_BANCA
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_01;
	
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/******************************************************************************
--**SUBO CLIENTES POR CAMPANA DUPLAS QUE QUEDAN FUERA POR ALGUNA RAZON		   **
--*******************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_02;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_02
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC    		
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 4;


INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_02
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT							
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE   							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO

,CASE WHEN 	FAC.TE_DUPLAS = 1 
	AND FAC.TE_CARGABLE = 0 
	THEN 1
	ELSE FAC.TE_CARGABLE END       		AS TE_CARGABLE                	

,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_01 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_02;
	
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/*****************************************************************************
--** CREA TABLA MAXIMO USER 												  ** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAX_USER_ESPECIALISTAS;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAX_USER_ESPECIALISTAS
(
	 TE_RUT 		 INTEGER
	,TC_EJE_FCT 	 VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
)UNIQUE PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 7;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAX_USER_ESPECIALISTAS
SELECT 
	 ESP.SE_RUT AS TE_RUT
	,MAX(ESP.SC_USER) AS TC_EJE_FCT 
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_EJECUTIVO_FACT_ESPECIALISTAS ESP
	INNER JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_DOTACION_FACT_LEA LEA 
		ON ESP.SC_USER = LEA.SC_EJE_FCT 
		AND NOT (COALESCE(LEA.SC_BANCO,'') = 'RETAIL')
GROUP BY 
	TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 8;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAX_USER_ESPECIALISTAS;
	
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/******************************************************************************
--** 			EJECUTIVO PARA CLIENTES SIN ESPECIALISTA	   					**
--*******************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_03;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_03
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC		
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 10;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_03
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			

,CASE WHEN ESP.TE_RUT IS NOT NULL 
	AND COALESCE(FAC.TC_EJE_FCT,'') = ''
	AND FAC.TC_TPO_BANCA IS NOT NULL
	THEN ESP.TC_EJE_FCT
	ELSE FAC.TC_EJE_FCT END       		AS TC_EJE_FCT      

,CASE WHEN ESP.TE_RUT IS NOT NULL 
	AND COALESCE(FAC.TC_EJE_FCT,'') = ''
	AND FAC.TC_TPO_BANCA IS NOT NULL
	THEN CASE WHEN 
			FAC.TC_TPO_BANCA = 'PYME' THEN 'RETAIL' 
			ELSE 'WHOLESALE' 
		 END
	ELSE FAC.TC_BANCO END       		AS TC_BANCO      							

,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO

,CASE WHEN ESP.TE_RUT IS NOT NULL 
	AND COALESCE(FAC.TC_EJE_FCT,'') = ''
	AND FAC.TC_TPO_BANCA IS NOT NULL
	THEN 1
	ELSE FAC.TE_CARGABLE END       		AS TE_CARGABLE                	

,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_02 FAC
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAX_USER_ESPECIALISTAS ESP
		ON FAC.TD_CLI_RUT = ESP.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_03;
	
.IF ERRORCODE <> 0 THEN .QUIT 12;

--/****************************************************************************
--** CREA TABLA UNICO RUT CUANDO PRODUCTO SEA FACTORING						** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_DIST_NO_POTENCIAL_LYF;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_DIST_NO_POTENCIAL_LYF
(
	TE_RUT 		 INTEGER
	
)UNIQUE PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 13;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_DIST_NO_POTENCIAL_LYF
SELECT 
	LYF.SE_RUT AS TE_RUT
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_03 FACT
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_NO_POTENCIAL_LYF LYF
		ON FACT.TD_CLI_RUT = LYF.SE_RUT 
WHERE 
	LYF.SC_PRODUCTO = 'FACTORING'
GROUP BY 
	LYF.SE_RUT
;	
.IF ERRORCODE <> 0 THEN .QUIT 14;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_DIST_NO_POTENCIAL_LYF;
	
.IF ERRORCODE <> 0 THEN .QUIT 15;

--/*****************************************************************************
--** CREA TABLA SACAR DARLE VALOR AL CAMPO EN CASO DE...					  ** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_01
(
	 TD_CLI_RUT		 DECIMAL(8,0)
	,TE_CASO 		 INTEGER
	
)UNIQUE PRIMARY INDEX (TD_CLI_RUT,TE_CASO)
;
.IF ERRORCODE <> 0 THEN .QUIT 16;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_01
SELECT
	 TD_CLI_RUT										AS TD_CLI_RUT
	,CASE 
		WHEN TE_MOLESTO>0 THEN 1 
		WHEN COALESCE(TE_VETADO_RIESGOS,0) > 0  THEN 1
	ELSE 0
	END 											AS TE_CASO
FROM 	
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_03
GROUP BY
	 TD_CLI_RUT
	,TE_CASO
;
.IF ERRORCODE <> 0 THEN .QUIT 17;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_CLI_RUT,TE_CASO)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_01;
	
.IF ERRORCODE <> 0 THEN .QUIT 18;

--/***********************************************************************
--**			 SUBO CLIENTES RECURRENTES								**
--************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_04;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_04
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC		
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 19;


INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_04
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			
,FAC.TC_EJE_FCT   						AS TC_EJE_FCT      
,FAC.TC_BANCO      						AS TC_BANCO      							
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV	

,CASE 
     WHEN FAC.TD_CLI_RUT = LYF.TE_RUT
     AND FAC.TD_CLI_RUT = PM1.TD_CLI_RUT 
     AND COALESCE(FAC.TC_TIPO_FINAL,'') = 'RECURRENTES'
     AND FAC.TE_CARGABLE = 0
     AND PM1.TE_CASO = 1
     AND LYF.TE_RUT IS NULL
     THEN 0
     ELSE FAC.TE_VETADO_RIESGOS
 END                                    AS TE_VETADO_RIESGOS

,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  	

,CASE 
     WHEN FAC.TD_CLI_RUT = LYF.TE_RUT
     AND FAC.TD_CLI_RUT = PM1.TD_CLI_RUT 
     AND COALESCE(FAC.TC_TIPO_FINAL,'') = 'RECURRENTES'
     AND FAC.TE_CARGABLE = 0
     AND PM1.TE_CASO = 1
     AND LYF.TE_RUT IS NULL
     THEN 1
     ELSE FAC.TE_FILTROS_RIESGOS
 END                                    AS TE_FILTROS_RIESGOS

,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   

,CASE 
     WHEN FAC.TD_CLI_RUT = LYF.TE_RUT
     AND FAC.TD_CLI_RUT = PM1.TD_CLI_RUT 
     AND COALESCE(FAC.TC_TIPO_FINAL,'') = 'RECURRENTES'
     AND FAC.TE_CARGABLE = 0
     AND PM1.TE_CASO = 1
     AND LYF.TE_RUT IS NULL
     THEN 0
     ELSE FAC.TE_MOLESTO
 END                                    AS TE_MOLESTO

,CASE 
     WHEN FAC.TD_CLI_RUT = LYF.TE_RUT
     AND FAC.TD_CLI_RUT = PM1.TD_CLI_RUT 
     AND COALESCE(FAC.TC_TIPO_FINAL,'') = 'RECURRENTES'
     AND FAC.TE_CARGABLE = 0
     AND PM1.TE_CASO = 1
     AND LYF.TE_RUT IS NULL
     THEN 1
     ELSE FAC.TE_CARGABLE
 END                                    AS TE_CARGABLE           	

,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_03 FAC
	 LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_DIST_NO_POTENCIAL_LYF LYF  
		ON FAC.TD_CLI_RUT =  LYF.TE_RUT
	 LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_01 PM1
		ON FAC.TD_CLI_RUT = PM1.TD_CLI_RUT  
;
.IF ERRORCODE <> 0 THEN .QUIT 20;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_04;
	
.IF ERRORCODE <> 0 THEN .QUIT 21;

--/****************************************************************************
--** CREA TABLA TIPO FINAL													** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_TIPO_FINAL;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_TIPO_FINAL
(
	TC_TIPO_FINAL 		 VARCHAR (100) CHARACTER SET LATIN NOT CASESPECIFIC
	
)UNIQUE PRIMARY INDEX (TC_TIPO_FINAL)
;
.IF ERRORCODE <> 0 THEN .QUIT 22;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_TIPO_FINAL VALUES('EVIDENCIA');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_TIPO_FINAL VALUES('FUGADOS');

.IF ERRORCODE <> 0 THEN .QUIT 23;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_TIPO_FINAL)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_TIPO_FINAL;
	
.IF ERRORCODE <> 0 THEN .QUIT 24;

--/****************************************************************************
--** CREA TABLA SACAR DARLE VALOR AL CAMPO EN CASO DE...							  ** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_02;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_02
(
	 TD_CLI_RUT			DECIMAL(8,0)
	,TE_CASO 		 	INTEGER
	
)UNIQUE PRIMARY INDEX (TD_CLI_RUT,TE_CASO)
;
.IF ERRORCODE <> 0 THEN .QUIT 25;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_02
SELECT
	 TD_CLI_RUT										AS TD_CLI_RUT
	,CASE 
		WHEN TE_MOLESTO>0 THEN 1 
		WHEN COALESCE(TE_VETADO_RIESGOS,0) > 0  THEN 1
			ELSE 0
		END 											AS TE_CASO
FROM 	
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_04
GROUP BY
	 TD_CLI_RUT
	,TE_CASO
;
.IF ERRORCODE <> 0 THEN .QUIT 26;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_CLI_RUT,TE_CASO)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_02;
	
.IF ERRORCODE <> 0 THEN .QUIT 27;

--/***********************************************************************
--** SUBO CLIENTES EVIDENCIA Y FUGADOS 									** 
--************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_05;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_05
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC		
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 28;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_05
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			
,FAC.TC_EJE_FCT   						AS TC_EJE_FCT      
,FAC.TC_BANCO      						AS TC_BANCO      							
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV	

,CASE WHEN
	FAC.TD_CLI_RUT = LYF.TE_RUT
	AND FAC.TD_CLI_RUT = PM2.TD_CLI_RUT
	AND COALESCE(FAC.TC_TIPO_FINAL,'') = FIN.TC_TIPO_FINAL 
	AND FAC.TE_CARGABLE = 0
	AND PM2.TE_CASO = 1
	AND LYF.TE_RUT IS NULL
	THEN 0
	ELSE FAC.TE_VETADO_RIESGOS END  	AS TE_VETADO_RIESGOS         

,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  	
,FAC.TE_FILTROS_RIESGOS 				AS TE_FILTROS_RIESGOS  
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   

,CASE WHEN
	FAC.TD_CLI_RUT = LYF.TE_RUT
	AND FAC.TD_CLI_RUT = PM2.TD_CLI_RUT
	AND COALESCE(FAC.TC_TIPO_FINAL,'') = FIN.TC_TIPO_FINAL 
	AND FAC.TE_CARGABLE = 0
	AND PM2.TE_CASO = 1
	AND LYF.TE_RUT IS NULL
	THEN 0
	ELSE FAC.TE_MOLESTO END       		AS TE_MOLESTO     

,CASE WHEN
	FAC.TD_CLI_RUT = LYF.TE_RUT
	AND FAC.TD_CLI_RUT = PM2.TD_CLI_RUT
	AND COALESCE(FAC.TC_TIPO_FINAL,'') = FIN.TC_TIPO_FINAL 
	AND FAC.TE_CARGABLE = 0
	AND PM2.TE_CASO = 1
	AND LYF.TE_RUT IS NULL
	THEN 1
	ELSE FAC.TE_CARGABLE END       		AS TE_CARGABLE                	

,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_04 FAC
	 LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_DIST_NO_POTENCIAL_LYF LYF  
		ON FAC.TD_CLI_RUT =  LYF.TE_RUT
	 LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_TIPO_FINAL  FIN	
	 	ON COALESCE(FAC.TC_TIPO_FINAL,'') = FIN.TC_TIPO_FINAL         
	 LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_02 PM2
		ON FAC.TD_CLI_RUT = PM2.TD_CLI_RUT  
;
.IF ERRORCODE <> 0 THEN .QUIT 29;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_05;
	
.IF ERRORCODE <> 0 THEN .QUIT 30;


--/****************************************************************************
--** CREA TABLA RUT UNICOS CUANDO PRODUCTO SEA FACTORING					 **
--****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF_RUT_UNI;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF_RUT_UNI
(
	TE_RUT_UNI 		 INTEGER
)UNIQUE PRIMARY INDEX (TE_RUT_UNI)
;
.IF ERRORCODE <> 0 THEN .QUIT 31;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF_RUT_UNI
SELECT 
	LYF.SE_RUT AS TE_RUT_UNI
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_05 FACT
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_NO_POTENCIAL_LYF LYF
		ON FACT.TD_CLI_RUT = LYF.SE_RUT 
WHERE 
	LYF.SC_PRODUCTO = 'FACTORING'
GROUP BY 
	LYF.SE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 32;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TE_RUT_UNI )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF_RUT_UNI;
.IF ERRORCODE <> 0 THEN .QUIT 33;

SELECT DATE, TIME; 

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 12 B OK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: PARA CAMPANA WHOLESALE FACTORING SE APLICA REGLA PARA MARCA CLIENTE		  **
--**                                                    				 				  **
--** AUTOR  : MICHELL CUAREZ                                                			  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 04/2022                                                   				  **
--*****************************************************************************************/
--** MANTNCN: FILTRO CLIENTE NO DESEADOS                                                  **
--** AUTOR  : IGNACIO LAGOS                                                          	  **
--** FECHA  : 02/2024                                                  				      **
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 10/2024			     	                                                  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	                                                                  **
--**  MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CLIENTE_EJECUTIVO			                          **
--**																					  **   
--**TABLA TEMPORAL:	                                                                      **    
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_06 **  
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_07 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_08 **  
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_09 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_10 **  
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_11 **
--**  {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_FAC_D   **
--**                  	                     											  **            
--**TABLA DE SALIDA:                                                                      **
--** {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_MCL **	 	                 											  **
--**                  	                     											  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/***********************************************************************
--** VERIFICO QUE NO PASE NINGUN NO POTENCIAL SEGUN INSUMO				**
--************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_06;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_06
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC		
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 1;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_06
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			
,FAC.TC_EJE_FCT   						AS TC_EJE_FCT      
,FAC.TC_BANCO      						AS TC_BANCO      							
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV	

,CASE WHEN LYF.TE_RUT_UNI IS NOT NULL 
	AND FAC.TE_CARGABLE = 1
	THEN 2
	ELSE FAC.TE_VETADO_RIESGOS END     	AS TE_VETADO_RIESGOS      

,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  	
,FAC.TE_FILTROS_RIESGOS 				AS TE_FILTROS_RIESGOS  
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO    						AS TE_MOLESTO     

,CASE WHEN LYF.TE_RUT_UNI IS NOT NULL 
	AND FAC.TE_CARGABLE = 1
	THEN 0
	ELSE FAC.TE_CARGABLE END       		AS TE_CARGABLE                	

,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_05 FAC
	 LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF_RUT_UNI LYF  
		ON FAC.TD_CLI_RUT =  LYF.TE_RUT_UNI
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_06;
	
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/*******************************************
--**CASCADA, ACTUALIZO ELIMINADO**
--*******************************************/   
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_07;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_07
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC		
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_07
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			
,FAC.TC_EJE_FCT   						AS TC_EJE_FCT      
,FAC.TC_BANCO      						AS TC_BANCO      							
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV	
,FAC.TE_VETADO_RIESGOS   				AS TE_VETADO_RIESGOS      
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  	
,FAC.TE_FILTROS_RIESGOS 				AS TE_FILTROS_RIESGOS  
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO    						AS TE_MOLESTO     
,FAC.TE_CARGABLE						AS TE_CARGABLE                	

,CASE 
   WHEN FAC.TE_CARGABLE = 0 THEN
	CASE
		WHEN FAC.TE_FILTROS_RIESGOS = 0        THEN '01.- FILTROS RIESGOS'
		WHEN FAC.TE_MARCA_RUTGOB    >0         THEN '02.- RUT GUBERNAMENTAL'
		WHEN FAC.TE_MARCA_CODACTECO_FUERA > 0  THEN '03.- ACTIVIDAD ECONIMICA RESTINGIDA'
		WHEN FAC.TE_ES_BCI                > 0  THEN '03.- ACTIVIDAD ECONIMICA RESTINGIDA'
		WHEN COALESCE(FAC.TC_EJE_FCT,'0')='0'    THEN '04.- SIN EJECUTIVO'
		WHEN FAC.TC_MACRO_BANCA NOT IN ('EMPRESARIOS','EMPRENDEDORES','EMPRESAS','GRANDES EMPRESAS','INMOBILIARIA','CORPORATIVA') THEN '05.- BANCA NO CORRESPONDE'
		WHEN COALESCE(FAC.TE_MOLESTO,0) > 0      THEN '06.- MOLESTOS'
		WHEN COALESCE(FAC.TE_CTACTE,0)=0         THEN '09.- SIN CUENTA CORRIENTE'
		WHEN COALESCE(FAC.TE_VETADO_RIESGOS,0)=1 THEN '10.- VETADO X RIESGOS'
		WHEN COALESCE(FAC.TE_VETADO_RIESGOS,0)=2 THEN '11.- NO POTENCIAL INSUMO ENVIADO'
	ELSE '' END
 ELSE FAC.TC_ELIMINADO  END 			AS TC_ELIMINADO		

,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_06 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_07;
	
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/*******************************************
--**CASCADA, ACTUALIZO CARGABLE, ELIMINADO**
--*******************************************/  
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_08;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_08
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC		
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 7;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_08
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			
,FAC.TC_EJE_FCT   						AS TC_EJE_FCT      
,FAC.TC_BANCO      						AS TC_BANCO      							
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV	
,FAC.TE_VETADO_RIESGOS   				AS TE_VETADO_RIESGOS      
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  	
,FAC.TE_FILTROS_RIESGOS 				AS TE_FILTROS_RIESGOS  
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO    						AS TE_MOLESTO    

,CASE WHEN 	FAC.TE_PROPENSO > 0 
	AND FAC.TC_TPO_BANCA = 'PYME' 
	AND NOT (COALESCE(FAC.TC_BANCO,'') = 'RETAIL') 
	AND FAC.TE_CARGABLE = 1
	THEN 0
	ELSE FAC.TE_CARGABLE END       		AS TE_CARGABLE         	            	

,CASE WHEN 	FAC.TE_PROPENSO > 0 
	AND FAC.TC_TPO_BANCA = 'PYME' 
	AND NOT (COALESCE(FAC.TC_BANCO,'') = 'RETAIL') 
	AND FAC.TE_CARGABLE = 1
	THEN '11.- SIN EJECUTIVO RETAIL'
	ELSE FAC.TC_ELIMINADO END       	AS TC_ELIMINADO    

,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_07 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_08;
	
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/*******************************************
--** NUEVO CODIGO
--*******************************************/  
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_09;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_09
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC		
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 10;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_09
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			
,FAC.TC_EJE_FCT   						AS TC_EJE_FCT      
,FAC.TC_BANCO      						AS TC_BANCO      							
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV	
,FAC.TE_VETADO_RIESGOS   				AS TE_VETADO_RIESGOS      
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  	
,FAC.TE_FILTROS_RIESGOS 				AS TE_FILTROS_RIESGOS  
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO    						AS TE_MOLESTO    

,CASE WHEN FAC.TE_PROPENSO > 0 
	AND FAC.TC_TPO_BANCA = 'WHOLESALE' 
	AND COALESCE(FAC.TC_BANCO,'RETAIL') = 'RETAIL'
	AND FAC.TE_CARGABLE = 1
	THEN 0
	ELSE FAC.TE_CARGABLE END       		AS TE_CARGABLE         	            	

,CASE WHEN FAC.TE_PROPENSO > 0 
	AND FAC.TC_TPO_BANCA = 'WHOLESALE' 
	AND COALESCE(FAC.TC_BANCO,'RETAIL') = 'RETAIL'
	AND FAC.TE_CARGABLE = 1
	THEN '11.- SIN EJECUTIVO WHOLESALE'
	ELSE FAC.TC_ELIMINADO END       	AS TC_ELIMINADO        

,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_08 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_09;
	
.IF ERRORCODE <> 0 THEN .QUIT 12;

--/***********************************************************************
--** 		EXCLUYE NO PROPENSOS CON OFERTA DE RIESGOS					**
--************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_10;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_10
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC		
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 13;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_10
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			
,FAC.TC_EJE_FCT   						AS TC_EJE_FCT      
,FAC.TC_BANCO      						AS TC_BANCO      							
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV	
,FAC.TE_VETADO_RIESGOS   				AS TE_VETADO_RIESGOS      
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  	
,FAC.TE_FILTROS_RIESGOS 				AS TE_FILTROS_RIESGOS  
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO    						AS TE_MOLESTO    

,CASE WHEN FAC.TE_CARGABLE = 1 
	AND FAC.TC_TIPO_FINAL = 'NUEVOS-'  
	THEN 0
	ELSE FAC.TE_CARGABLE END       		AS TE_CARGABLE         	            	

,CASE WHEN FAC.TE_CARGABLE = 1 
	AND FAC.TC_TIPO_FINAL = 'NUEVOS-'  
	THEN '15.- SIN PROPENSION FCT CON OFERTA RIESGOS'
	ELSE FAC.TC_ELIMINADO END       	AS TC_ELIMINADO        

,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_09 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 14;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_10;
	
.IF ERRORCODE <> 0 THEN .QUIT 15;

--/***********************************************************************
--**				 NO PROPENSOS										**
--************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_11;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_11
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC		
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 16;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_11
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO 
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			
,FAC.TC_EJE_FCT   						AS TC_EJE_FCT      
,FAC.TC_BANCO      						AS TC_BANCO      							
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV	
,FAC.TE_VETADO_RIESGOS   				AS TE_VETADO_RIESGOS      
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS TE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  	
,FAC.TE_FILTROS_RIESGOS 				AS TE_FILTROS_RIESGOS  
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO    						AS TE_MOLESTO    

,CASE WHEN FAC.TE_CARGABLE = 1 
	AND FAC.TE_PROPENSO = 0  
	THEN 0
	ELSE FAC.TE_CARGABLE END       		AS TE_CARGABLE         	            	

,CASE WHEN FAC.TE_CARGABLE = 1 
	AND FAC.TE_PROPENSO = 0  
	THEN '15.- SIN PROPENSION FCT'
	ELSE FAC.TC_ELIMINADO END       	AS TC_ELIMINADO        

,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_10 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 17;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_11;
	
.IF ERRORCODE <> 0 THEN .QUIT 18;

--/*************************************************************************
--** Se APLICAN FILTROS DE EMPRESAS NO DESEADAS A CARGAR 		 		  **  
--*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_FAC_D;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_FAC_D
(
 TD_RUT DECIMAL(8,0)
)UNIQUE PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 19;


INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_FAC_D
SELECT 
    IE_CLI_RUT AS TD_RUT
FROM MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CLIENTE_EJECUTIVO
WHERE 
    IC_NOM_CLI = 'EMPRESAS JUAN YARUR SPA'
;
.IF ERRORCODE <> 0 THEN .QUIT 20;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_FAC_D
SELECT 
    IE_CLI_RUT AS TD_RUT
FROM MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CLIENTE_EJECUTIVO
WHERE 
    IC_NOM_CLI = 'EMPRESAS JY S A'
;
.IF ERRORCODE <> 0 THEN .QUIT 21;

COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_FAC_D;
	
.IF ERRORCODE <> 0 THEN .QUIT 22;


--/***********************************************************************
--** 							UPDATE NO DESEADO					    **  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_MCL;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_MCL
(
	 PC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,PE_PERIODO_CMP_F					INTEGER 		
    ,PD_CLI_RUT          				DECIMAL(8,0)
    ,PC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PE_PROPENSO						INTEGER
    ,PC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,PD_PROB							DECIMAL (25,10)
    ,PC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC            
    ,PC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,PE_CONVENCIMIENTO   				INTEGER
    ,PC_ESTADO_FACTORING				VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_PRIORIDAD						INTEGER
    ,PC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,PE_CTACTE							INTEGER
	,PE_IS_FUGADO                       BIGINT
    ,PE_CONOFERTARIESGOS    			INTEGER
	,PC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,PD_VECES_VTA_PROP					DECIMAL (1,0)
    ,PC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_VETADO_RIESGOS					INTEGER
    ,PE_MONTO_OFERTA					BIGINT
    ,PC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_MARCA_CODACTECO_FUERA 			INTEGER
    ,PC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_MARCA_RUTGOB    				INTEGER
    ,PE_ES_BCI          				INTEGER
    ,PE_CAPACITY_EJE    				INTEGER
    ,PE_CAPACITY_FFVV   				INTEGER
    ,PE_CUENTA          				INTEGER
    ,PE_FUERA_CAPACITY  				INTEGER
    ,PC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_EN_PLANEAMIENTO					INTEGER
    ,PC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,PD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,PC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_FDR 							INTEGER
    ,PE_COS_CLI             			INTEGER
    ,PE_FILTROS_RIESGOS     			INTEGER
    ,PC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,PE_PAR_FDR 						INTEGER
    ,PE_PAR_COS_CLI             		INTEGER
    ,PE_MOLESTO                 		INTEGER
    ,PE_CARGABLE                		INTEGER
    ,PC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_DUPLAS							INTEGER
    ,PE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (PE_PERIODO_CMP_F,PD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 23;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_MCL
SELECT
 FAC.TC_TPO_BANCA						AS PC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS PE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS PD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS PC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS PC_NOM_CLI          			
,FAC.TE_PROPENSO						AS PE_PROPENSO					
,FAC.TC_TIPO 							AS PC_TIPO 
,FAC.TD_PROB                            AS PD_PROB	
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT									
,FAC.TC_MARCA_FACTORING  				AS PC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS PE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS PC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS PE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS PC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS PC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS PC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS PE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS PE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS PE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS PC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS PD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS PC_TIPO_OFERTA_FINAL			
,FAC.TC_EJE_FCT   						AS PC_EJE_FCT      
,FAC.TC_BANCO      						AS PC_BANCO      							
,FAC.TC_EJE_FFVV						AS PC_EJE_FFVV	
,FAC.TE_VETADO_RIESGOS   				AS PE_VETADO_RIESGOS      
,FAC.TE_MONTO_OFERTA					AS PE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS PC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS PE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS PC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS PC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS PC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS PC_GLOSA 						
,FAC.TC_IVA 							AS PC_IVA 						
,FAC.TC_CATEGORIA 						AS PC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS PC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS PE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS PE_ES_BCI          			
,FAC.TE_CAPACITY_EJE    				AS PE_CAPACITY_EJE    			
,FAC.TE_CAPACITY_FFVV   				AS PE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS PE_CUENTA          			
,FAC.TE_FUERA_CAPACITY  				AS PE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS PC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS PC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS PC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS PC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS PE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS PC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS PC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS PF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS PD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS PC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS PE_FDR    	
,FAC.TE_COS_CLI		               		AS PE_COS_CLI  	
,FAC.TE_FILTROS_RIESGOS 				AS PE_FILTROS_RIESGOS  
,FAC.TC_PAR_CALIFICACION_SBIF			AS PC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS PD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS PE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS PE_PAR_COS_CLI   
,FAC.TE_MOLESTO    						AS PE_MOLESTO    

,CASE WHEN FLT.TD_RUT IS NOT NULL 
	THEN 0
	ELSE FAC.TE_CARGABLE END       		AS PE_CARGABLE         	            	

,CASE WHEN FLT.TD_RUT IS NOT NULL 
	THEN 'CLIENTE EMPRESA YARUR'
	ELSE FAC.TC_ELIMINADO END       	AS PC_ELIMINADO        

,FAC.TE_DUPLAS							AS PE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS PE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MCL_11 FAC
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_FAC_D FLT
		ON FAC.TD_CLI_RUT = FLT.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 24;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_MCL;
	
.IF ERRORCODE <> 0 THEN .QUIT 25;

SELECT DATE, TIME; 

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 12 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: PARA CAMPANA WHOLESALE FACTORING SE APLICA REGLA PARA MARCA CLIENTE		  **
--**                                                    				 				  **
--** AUTOR  : MICHELL CUAREZ                                                			  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 04/2022                                                   				  **
--*****************************************************************************************/
--** MANTNCN: FILTRO CLIENTE NO DESEADOS                                                  **
--** AUTOR  : IGNACIO LAGOS                                                          	  **
--** FECHA  : 02/2024                                                  				      **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	MKT_JOURNEYBUILDER_TB.S_CMP_MACRO_BANCA			  			  	  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_EJECUTIVO_FACT_ESPECIALISTAS  	  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_DOTACION_FACT_LEA			  	  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_NO_POTENCIAL_LYF              	  **
--**					{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
--**					MKT_JOURNEYBUILDER_TB.P_CMP_MAE_CLIENTE_EJECUTIVO			  	  **
--**																					  **                 
--**TABLA DE SALIDA:   {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
--**                  	                     											  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/***********************************************************
--** UPDATE CARGABLE Y ELIMINADO							**
--***********************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	 PE_CARGABLE = 0 
	,PC_ELIMINADO = ''
;
.IF ERRORCODE <> 0 THEN .QUIT 1;

--/***********************************************************
--** MARCO CLIENTES FINALMENTE CAMPANABLES					**
--************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
--FROM 
--	MKT_JOURNEYBUILDER_TB.S_CMP_MACRO_BANCA AS MACR
SET 
	PE_CARGABLE = 1
WHERE 
	PE_FILTROS_RIESGOS > 0          
	AND PE_PROPENSO> 0                 
	AND PE_MARCA_RUTGOB=0              
	AND PE_MARCA_CODACTECO_FUERA=0     
	AND PE_ES_BCI = 0                  
	AND NOT (COALESCE(PC_EJE_FCT,'0') = '0')
--	AND PC_MACRO_BANCA = MACR.SC_MACRO_BANCA  	
	AND EXISTS (
        SELECT 1 
        FROM MKT_JOURNEYBUILDER_TB.S_CMP_MACRO_BANCA AS MACR
        WHERE PC_MACRO_BANCA = MACR.SC_MACRO_BANCA
    )
	AND PE_MOLESTO=0      
	AND COALESCE(PE_CTACTE,0) > 0   
	AND COALESCE(PE_VETADO_RIESGOS,0) = 0
;
.IF ERRORCODE <> 0 THEN .QUIT 1;

--/******************************************************************************
--**SUBO CLIENTES POR CAMPANA DUPLAS QUE QUEDAN FUERA POR ALGUNA RAZON		   **
--*******************************************************************************/

UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	PE_CARGABLE=1
WHERE 
	PE_DUPLAS=1 
	AND PE_CARGABLE=0  
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES;
	
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/*****************************************************************************
--** CREA TABLA MAXIMO USER 												  ** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAX_USER_ESPECIALISTAS;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAX_USER_ESPECIALISTAS
(
	 TE_RUT 		 INTEGER
	,TC_EJE_FCT 	 VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
)PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAX_USER_ESPECIALISTAS
SELECT 
	 ESP.SE_RUT AS TE_RUT
	,MAX(ESP.SC_USER) AS TC_EJE_FCT 
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_EJECUTIVO_FACT_ESPECIALISTAS AS ESP
	INNER JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_DOTACION_FACT_LEA AS LEA 
		ON ESP.SC_USER = LEA.SC_EJE_FCT 
		AND NOT (COALESCE(LEA.SC_BANCO,'') = 'RETAIL')
GROUP BY 
	TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 5;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAX_USER_ESPECIALISTAS;
	
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/******************************************************************************
--** 			EJECUTIVO PARA CLIENTES SIN ESPECIALISTA	   					**
--*******************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_MAX_USER_ESPECIALISTAS AS ESP
SET 
	 PE_CARGABLE = 1
	,PC_EJE_FCT = ESP.TC_EJE_FCT
	,PC_BANCO = CASE WHEN PC_TPO_BANCA = 'PYME' THEN 'RETAIL' ELSE 'WHOLESALE' END
WHERE 
	PE_CLI_RUT = ESP.TE_RUT
	AND COALESCE(PC_EJE_FCT,'') = ''
	AND PC_TPO_BANCA IS NOT NULL 
;
.IF ERRORCODE <> 0 THEN .QUIT 7;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES;
	
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/****************************************************************************
--** CREA TABLA UNICO RUT CUANDO PRODUCTO SEA FACTORING						** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_DIST_NO_POTENCIAL_LYF;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_DIST_NO_POTENCIAL_LYF
(
	TE_RUT 		 INTEGER
	
)PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 9;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_DIST_NO_POTENCIAL_LYF
SELECT 
	LYF.SE_RUT AS TE_RUT
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES AS FACT
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_NO_POTENCIAL_LYF AS LYF
		ON FACT.PE_CLI_RUT = LYF.SE_RUT 
WHERE 
	LYF.SC_PRODUCTO = 'FACTORING'
GROUP BY 
	LYF.SE_RUT
;	
.IF ERRORCODE <> 0 THEN .QUIT 10;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_DIST_NO_POTENCIAL_LYF;
	
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/*****************************************************************************
--** CREA TABLA SACAR DARLE VALOR AL CAMPO EN CASO DE...					  ** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_01;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_01
(
	 TE_CLI_RUT		 INTEGER
	,TE_CASO 		 INTEGER
	
)PRIMARY INDEX (TE_CLI_RUT,TE_CASO)
;
.IF ERRORCODE <> 0 THEN .QUIT 12;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_01
SELECT
	 PE_CLI_RUT										AS TE_CLI_RUT
	,CASE 
		WHEN PE_MOLESTO>0 THEN 1 
		WHEN COALESCE(PE_VETADO_RIESGOS,0) > 0  THEN 1
	ELSE 0
	END 											AS TE_CASO
FROM 	
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
GROUP BY
	 TE_CLI_RUT
	,TE_CASO
;
.IF ERRORCODE <> 0 THEN .QUIT 13;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_CLI_RUT,TE_CASO)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_01;
	
.IF ERRORCODE <> 0 THEN .QUIT 14;
--/***********************************************************************
--**			 SUBO CLIENTES RECURRENTES								**
--************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
FROM 
	 {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_DIST_NO_POTENCIAL_LYF AS LYF  
	,{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_01 AS PM1
SET 
	 PE_CARGABLE=1
	,PE_MOLESTO=0
	,PE_VETADO_RIESGOS=0
	,PE_FILTROS_RIESGOS=1
WHERE
	PE_CLI_RUT = LYF.TE_RUT
	AND PE_CLI_RUT = PM1.TE_CLI_RUT 
	AND COALESCE(PC_TIPO_FINAL,'') ='RECURRENTES'
	AND PE_CARGABLE=0
	AND PM1.TE_CASO = 1
	AND LYF.TE_RUT IS NULL
;
.IF ERRORCODE <> 0 THEN .QUIT 15;

--/****************************************************************************
--** CREA TABLA TIPO FINAL													** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_TIPO_FINAL;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_TIPO_FINAL
(
	TC_TIPO_FINAL 		 VARCHAR (100) CHARACTER SET LATIN NOT CASESPECIFIC
	
)PRIMARY INDEX (TC_TIPO_FINAL)
;
.IF ERRORCODE <> 0 THEN .QUIT 16;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_TIPO_FINAL VALUES('EVIDENCIA');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_TIPO_FINAL VALUES('FUGADOS');

.IF ERRORCODE <> 0 THEN .QUIT 17;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_TIPO_FINAL)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_TIPO_FINAL;
	
.IF ERRORCODE <> 0 THEN .QUIT 18;

--/****************************************************************************
--** CREA TABLA SACAR DARLE VALOR AL CAMPO EN CASO DE...							  ** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_02;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_02
(
	 TE_CLI_RUT			INTEGER
	,TE_CASO 		 	INTEGER
	
)PRIMARY INDEX (TE_CLI_RUT,TE_CASO)
;
.IF ERRORCODE <> 0 THEN .QUIT 19;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_02
SELECT
	 PE_CLI_RUT										AS TE_CLI_RUT
	,CASE 
		WHEN PE_MOLESTO>0 THEN 1 
		WHEN COALESCE(PE_VETADO_RIESGOS,0) > 0  THEN 1
			ELSE 0
		END 											AS TE_CASO
FROM 	
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
GROUP BY
	 TE_CLI_RUT
	,TE_CASO
;
.IF ERRORCODE <> 0 THEN .QUIT 20;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_CLI_RUT,TE_CASO)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_02;
	
.IF ERRORCODE <> 0 THEN .QUIT 21;

--/***********************************************************************
--** SUBO CLIENTES EVIDENCIA Y FUGADOS 									** 
--************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
FROM
	 {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_DIST_NO_POTENCIAL_LYF AS LYF 
	,{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_TIPO_FINAL AS FIN
	,{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WSB_MES_02 AS PM2
SET 
	 PE_CARGABLE=1
	,PE_MOLESTO=0
	,PE_VETADO_RIESGOS=0
WHERE 
	PE_CLI_RUT = LYF.TE_RUT
	AND PE_CLI_RUT = PM2.TE_CLI_RUT
	AND COALESCE(PC_TIPO_FINAL,'') = FIN.TC_TIPO_FINAL 
	AND PE_CARGABLE = 0
	AND PM2.TE_CASO = 1
	AND LYF.TE_RUT IS NULL
;
.IF ERRORCODE <> 0 THEN .QUIT 22;

--/****************************************************************************
--** CREA TABLA RUT UNICOS CUANDO PRODUCTO SEA FACTORING					 **
--****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF_RUT_UNI;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF_RUT_UNI
(
	TE_RUT_UNI 		 INTEGER
)PRIMARY INDEX (TE_RUT_UNI)
;
.IF ERRORCODE <> 0 THEN .QUIT 23;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF_RUT_UNI
SELECT 
	LYF.SE_RUT AS TE_RUT_UNI
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES AS FACT
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_NO_POTENCIAL_LYF AS LYF
		ON FACT.PE_CLI_RUT = LYF.SE_RUT 
WHERE 
	LYF.SC_PRODUCTO = 'FACTORING'
GROUP BY 
	LYF.SE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 24;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TE_RUT_UNI )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF_RUT_UNI;
.IF ERRORCODE <> 0 THEN .QUIT 25;

--/***********************************************************************
--** VERIFICO QUE NO PASE NINGUN NO POTENCIAL SEGUN INSUMO				**
--************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_NO_POTENCIAL_LYF_RUT_UNI AS LYF  
SET 
	 PE_VETADO_RIESGOS = 2
	,PE_CARGABLE = 0
WHERE 
	PE_CLI_RUT = LYF.TE_RUT_UNI
	AND PE_CARGABLE = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 26;

--/*******************************************
--**CASCADA, ACTUALIZO ELIMINADO**
--*******************************************/   
UPDATE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
SET 
	PC_ELIMINADO = CASE
					WHEN PE_FILTROS_RIESGOS = 0        THEN '01.- FILTROS RIESGOS'
					WHEN PE_MARCA_RUTGOB    >0         THEN '02.- RUT GUBERNAMENTAL'
					WHEN PE_MARCA_CODACTECO_FUERA > 0  THEN '03.- ACTIVIDAD ECONIMICA RESTINGIDA'
					WHEN PE_ES_BCI                > 0  THEN '03.- ACTIVIDAD ECONIMICA RESTINGIDA'
					WHEN COALESCE(PC_EJE_FCT,'0')='0'    THEN '04.- SIN EJECUTIVO'
					WHEN PC_MACRO_BANCA NOT IN ('EMPRESARIOS','EMPRENDEDORES','EMPRESAS','GRANDES EMPRESAS','INMOBILIARIA','CORPORATIVA') THEN '05.- BANCA NO CORRESPONDE'
					WHEN COALESCE(PE_MOLESTO,0) > 0      THEN '06.- MOLESTOS'
					WHEN COALESCE(PE_CTACTE,0)=0         THEN '09.- SIN CUENTA CORRIENTE'
					WHEN COALESCE(PE_VETADO_RIESGOS,0)=1 THEN '10.- VETADO X RIESGOS'
					WHEN COALESCE(PE_VETADO_RIESGOS,0)=2 THEN '11.- NO POTENCIAL INSUMO ENVIADO'
				ELSE '' 
				END
WHERE PE_CARGABLE =0
;
.IF ERRORCODE <> 0 THEN .QUIT 27;

--/*******************************************
--**CASCADA, ACTUALIZO CARGABLE, ELIMINADO**
--*******************************************/  
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	 PE_CARGABLE = 0
	,PC_ELIMINADO = '11.- SIN EJECUTIVO RETAIL'
WHERE 
	PE_PROPENSO>0 
	AND PC_TPO_BANCA = 'PYME' 
	AND NOT (COALESCE(PC_BANCO,'') = 'RETAIL') 
	AND PE_CARGABLE=1
;
.IF ERRORCODE <> 0 THEN .QUIT 28;

--NUEVO_CODIGO
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	 PE_CARGABLE = 0
	,PC_ELIMINADO = '11.- SIN EJECUTIVO WHOLESALE'
WHERE 
	PE_PROPENSO > 0 
	AND PC_TPO_BANCA = 'WHOLESALE' 
	AND COALESCE(PC_BANCO,'RETAIL') = 'RETAIL'
	AND PE_CARGABLE = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 29;
--NUEVO_CODIGO

--/***********************************************************************
--** 		EXCLUYE NO PROPENSOS CON OFERTA DE RIESGOS					**
--************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	 PE_CARGABLE = 0
	,PC_ELIMINADO = '15.- SIN PROPENSION FCT CON OFERTA RIESGOS'
WHERE 
	PE_CARGABLE = 1 
	AND PC_TIPO_FINAL = 'NUEVOS-'  
;
.IF ERRORCODE <> 0 THEN .QUIT 30;

--/***********************************************************************
--**				 NO PROPENSOS										**
--************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	 PE_CARGABLE = 0
	,PC_ELIMINADO = '15.- SIN PROPENSION FCT'
WHERE 
	PE_CARGABLE = 1 
	AND PE_PROPENSO = 0
;
.IF ERRORCODE <> 0 THEN .QUIT 31;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES;
	
.IF ERRORCODE <> 0 THEN .QUIT 32;

--/*************************************************************************
--** Se APLICAN FILTROS DE EMPRESAS NO DESEADAS A CARGAR 		 		  **  
--*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_FAC_D;

CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_FAC_D
(
 TD_RUT DECIMAL(8,0)
)PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 13;


INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_FAC_D
SELECT PE_CLI_RUT AS TD_RUT
FROM MKT_JOURNEYBUILDER_TB.P_CMP_MAE_CLIENTE_EJECUTIVO
WHERE PC_NOM_CLI = 'EMPRESAS JUAN YARUR SPA'
;
.IF ERRORCODE <> 0 THEN .QUIT 14;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_FAC_D
SELECT PE_CLI_RUT AS TD_RUT
FROM MKT_JOURNEYBUILDER_TB.P_CMP_MAE_CLIENTE_EJECUTIVO
WHERE PC_NOM_CLI = 'EMPRESAS JY S A'
;
.IF ERRORCODE <> 0 THEN .QUIT 15;

COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_FAC_D;
	
.IF ERRORCODE <> 0 THEN .QUIT 16;


--/***********************************************************************
--** 							UPDATE NO DESEADO					    **  
--***********************************************************************/

UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_FAC_D AS FLT

SET 
	 PE_CARGABLE = 0
	,PC_ELIMINADO ='CLIENTE EMPRESA YARUR'
WHERE
	PE_CLI_RUT = FLT.TD_RUT
;

.IF ERRORCODE <> 0 THEN .QUIT 017;

SELECT DATE, TIME; 

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 13 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: PARA CAMPANA WHOLESALE FACTORING SE APLICA REGLA PARA ASIGNACION			  **
--**                                                    				 				  **
--** AUTOR  : MICHELL CUAREZ                                                			  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 04/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN:                                                           				  **
--** AUTOR  :                                                           				  **
--** FECHA  : SSAAMMDD                                                  				  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS				  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_VACACIONES_FACT_LEA			  **
--**					{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES  	  **
--**TABLA DE SALIDA:    	                 											  **
--**                  {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 	  	  **
--**                  	                     											  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARAMETROS	  								  **  
--*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_ASIG_PARAMETRO;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_ASIG_PARAMETRO
(
	 TE_PERIODO_CMP			INTEGER
	,TF_FECHA_CMP			DATE 	FORMAT 'YYYY-MM-DD'
	,TE_PERIODO_MENOS_1M	INTEGER
	,TF_FECHA_CRG 			DATE 	FORMAT 'YYYY-MM-DD'
	,TE_CAP_PYME 			INTEGER
	,TE_CAP_WLS             INTEGER
	,TE_CAP_FFVV            INTEGER
) PRIMARY INDEX (TE_PERIODO_CMP)

;
.IF ERRORCODE <> 0 THEN .QUIT 1;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_ASIG_PARAMETRO
SELECT 
	 PFE.SE_PERIODO_CMP  		AS TE_PERIODO_CMP
	,PFE.SF_FECHA_REF_DIA 		AS TF_FECHA_CMP
	,PFE.SE_PERIODO_MENOS_1M 	AS TE_PERIODO_MENOS_1M
	,PFE.SF_FECHA_CARGA			AS TF_FECHA_CRG	
	,PCP.SE_CAPACITY_PYME		AS TE_CAP_PYME     
	,PCP.SE_CAPACITY_WSB		AS TE_CAP_WLS 
	,PCP.SE_CAPACITY_FFVV		AS TE_CAP_FFVV
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS AS PFE
	INNER JOIN MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_CMP AS PCP
		ON PCP.SC_CAMPANA = 'FACTORING_WHOLESALE'
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_ASIG_PARAMETRO;
	
.IF ERRORCODE <> 0 THEN .QUIT 3;
	

--/***********************************************************************
--** 		CAPACITY MAXIMO POR EJECUTIVO				**
--************************************************************************/

UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_ASIG_PARAMETRO AS PAR
SET 
	PE_CAPACITY_EJE = CASE 
						WHEN COALESCE(PC_TPO_BANCA,'') = 'PYME' THEN PAR.TE_CAP_PYME
						WHEN COALESCE(PC_TPO_BANCA,'') = 'WHOLESALE' THEN PAR.TE_CAP_WLS
					ELSE 0 
					END
	,PE_CAPACITY_FFVV = PAR.TE_CAP_FFVV 
	,PE_CUENTA=1
;
.IF ERRORCODE <> 0 THEN .QUIT 4;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES;
	
.IF ERRORCODE <> 0 THEN .QUIT 5;
--/****************************************************************************
--** CREA TABLA TEMPORAL MIENTRAS EL PRODUCTO_BANCO SEA FACTORING			** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_VACACIONES_FACT_LEA;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_VACACIONES_FACT_LEA
(
	 TE_PERIODO_CMP 	INTEGER 
	,TC_USER 			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_CAPACITY_MAXIMO INTEGER 	
)PRIMARY INDEX (TE_PERIODO_CMP)
;
.IF ERRORCODE <> 0 THEN .QUIT 6;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_VACACIONES_FACT_LEA
SELECT 
	 SE_PERIODO_CMP 	 AS TE_PERIODO_CMP 	
	,SC_USER 			 AS TC_USER 			
	,SE_CAPACITY_MAXIMO  AS TE_CAPACITY_MAXIMO 	
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_VACACIONES_FACT_LEA
WHERE 
	(POSITION ('FACTORING' IN SC_PRODUCTO_BANCO) > 0)
;
.IF ERRORCODE <> 0 THEN .QUIT 7;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_VACACIONES_FACT_LEA;
	
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/***********************************************************************
--** ACTUALIZA	CAPACITY_EJE CON TABLA VACACIONES_FACT_LEA**
--************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_VACACIONES_FACT_LEA AS LEA
SET 
	PE_CAPACITY_EJE = LEA.TE_CAPACITY_MAXIMO  
WHERE 
	PC_EJE_FCT = LEA.TC_USER
	AND COALESCE(PC_TPO_BANCA,'') = 'WHOLESALE'
;	
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/***********************************************************************
--**  ACTUALIZA	CAPACITY_EJE CON TABLA VACACIONES_FACT_LEA**
--************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_VACACIONES_FACT_LEA AS LEA
SET 
	PE_CAPACITY_EJE = LEA.TE_CAPACITY_MAXIMO
WHERE 
	PC_EJE_FFVV = LEA.TC_USER
	AND COALESCE(PC_TPO_BANCA,'') = 'WHOLESALE'
;	
.IF ERRORCODE <> 0 THEN .QUIT 10;

--/***********************************************************************
--**	ACTUALIZA CARGABLE 	ASIGNACION FACTORING WSB					**  
--***********************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	 PE_CARGABLE=1
	,PC_CAMPANA_OFERTA = PC_TIPO_FINAL 
WHERE 
	PE_CARGABLE=0 
	AND PC_TPO_BANCA = 'WHOLESALE'
	AND PC_ELIMINADO = ''
;
.IF ERRORCODE <> 0 THEN .QUIT 11;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES;
	
.IF ERRORCODE <> 0 THEN .QUIT 12;

--/****************************************************************************
--** ASIGNACION FACTORING WHOLESALE -- CMP_FACT_WHOLESALE			** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE
(
	 TE_PERIODO_CMP_F					INTEGER       
	,TE_CLI_RUT          				INTEGER
	,TE_CAPACITY_EJE    				INTEGER
	,TE_FUERA_CAPACITY  				INTEGER
	,TC_TIPO_FINAL						VARCHAR (100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_FCT							VARCHAR (255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TIPO 							VARCHAR (100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_DUPLAS							INTEGER	
	,TE_N_ORDEN							INTEGER
)PRIMARY INDEX (TE_PERIODO_CMP_F,TE_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 13;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE
SELECT 				
	 PE_PERIODO_CMP_F					AS 	TE_PERIODO_CMP_F					  				
	,PE_CLI_RUT          				AS 	TE_CLI_RUT          				     				
	,PE_CAPACITY_EJE    				AS 	TE_CAPACITY_EJE    				  				
	,PE_FUERA_CAPACITY  				AS 	TE_FUERA_CAPACITY  
	,PC_TIPO_FINAL 						AS  TC_TIPO_FINAL 	
	,PC_EJE_FCT							AS  TC_EJE_FCT 
	,PC_TIPO 							AS  TC_TIPO
	,PE_DUPLAS 							AS  TE_DUPLAS
    ,ROW_NUMBER() OVER (PARTITION BY PE_CUENTA ORDER BY PE_PRIORIDAD, PC_ESTADO_FACTORING, PC_TIPO_OFERTA, PE_MONTO_OFERTA DESC,PD_PROB DESC) AS TE_N_ORDEN 
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
WHERE 
	PC_TPO_BANCA = 'WHOLESALE'
	AND NOT (POSITION ('NUEVOS' IN PC_TIPO_FINAL) > 0)
	AND NOT (POSITION ('NUEVOS-' IN PC_TIPO_FINAL) > 0)
	AND PC_ELIMINADO = ''
;
.IF ERRORCODE <> 0 THEN .QUIT 14;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE;
	
.IF ERRORCODE <> 0 THEN .QUIT 15;

--/****************************************************************************
--** ASIGNACION FACTORING WHOLESALE -- CMP_FACT_WSB_CAPACITY	T2	 ** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WSB_CAPACITY;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WSB_CAPACITY
(
	 TE_PERIODO_CMP_F					INTEGER      
	,TE_CLI_RUT          				INTEGER 
	,TE_CAPACITY_EJE    				INTEGER 
	,TE_FUERA_CAPACITY  				INTEGER 
	,TC_TIPO_FINAL						VARCHAR (100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_N_ORDEN							INTEGER 
	,TE_N_FILA							INTEGER
)PRIMARY INDEX (TE_PERIODO_CMP_F,TE_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 16;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WSB_CAPACITY
SELECT 
	 TE_PERIODO_CMP_F					AS 	TE_PERIODO_CMP_F					    				
	,TE_CLI_RUT          				AS 	TE_CLI_RUT          				        				   				
	,TE_CAPACITY_EJE    				AS  PE_CAPACITY_EJE 
	,TE_FUERA_CAPACITY  				AS 	TE_FUERA_CAPACITY  				
	,TC_TIPO_FINAL 						AS  TC_TIPO_FINAL 	
	,TE_N_ORDEN							AS  TE_N_ORDEN
    ,ROW_NUMBER() OVER (PARTITION BY TC_EJE_FCT ORDER BY TC_EJE_FCT,TE_N_ORDEN ASC) AS TE_N_FILA 
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE
;
.IF ERRORCODE <> 0 THEN .QUIT 17;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WSB_CAPACITY;
	
.IF ERRORCODE <> 0 THEN .QUIT 18;

--/***********************************************************************
--**	ASIGNACION FACTORING WHOLESALE --UPDATE							**  
--***********************************************************************/	
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WSB_CAPACITY
SET 
	TE_FUERA_CAPACITY = CASE WHEN TE_N_FILA>TE_CAPACITY_EJE THEN 1 ELSE 0 END 
;
.IF ERRORCODE <> 0 THEN .QUIT 19;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WSB_CAPACITY;
	
.IF ERRORCODE <> 0 THEN .QUIT 20;

--/***********************************************************************
--**	MARCO FINALMENTE LOS ASIGNADOS A EJECUTIVOS FACTORING			**  
--***********************************************************************/	
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
SET 
	 PE_FUERA_CAPACITY = 0
	,PC_CAMPANA_OFERTA = NULL

;
.IF ERRORCODE <> 0 THEN .QUIT 21;

--/***********************************************************************
--**	MARCO FINALMENTE LOS ASIGNADOS A EJECUTIVOS FACTORING			**  
--***********************************************************************/	

UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WSB_CAPACITY AS CAP
SET 
	 PE_FUERA_CAPACITY = CAP.TE_FUERA_CAPACITY
	,PC_CAMPANA_OFERTA = CASE WHEN CAP.TE_FUERA_CAPACITY=0
								THEN  CAP.TC_TIPO_FINAL 
							ELSE NULL 
						END
WHERE 
	PE_CLI_RUT = CAP.TE_CLI_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 22;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES;
	
.IF ERRORCODE <> 0 THEN .QUIT 23;

--/****************************************************************************
--** CREAR TABLA TEMPORAL PARA TIPO FINAL NUEVOS Y NUEVOS-					** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_TIPO_FINAL;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_TIPO_FINAL
(
	TC_TIPO_FINAL VARCHAR (100) CHARACTER SET LATIN NOT CASESPECIFIC

)PRIMARY INDEX (TC_TIPO_FINAL)
;
.IF ERRORCODE <> 0 THEN .QUIT 24;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_TIPO_FINAL VALUES ('NUEVOS');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_TIPO_FINAL VALUES ('NUEVOS-');

.IF ERRORCODE <> 0 THEN .QUIT 25;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_TIPO_FINAL)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_TIPO_FINAL;
	
.IF ERRORCODE <> 0 THEN .QUIT 26;


--/***********************************************************************
--**				TABLA TEMPORAL DE ELIMINADOS					**  
--***********************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO
(
	TC_ELIMINADO				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	
)PRIMARY INDEX (TC_ELIMINADO)
;
.IF ERRORCODE <> 0 THEN .QUIT 27;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO VALUES('04.- SIN EJECUTIVO');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO VALUES('05.- BANCA NO CORRESPONDE');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO VALUES('06.- MOLESTOS');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO VALUES('07.- SIN PLATAFORMA');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO VALUES('08.- SIN REGIONAL');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO VALUES('09.- SIN EJECUTIVO WHOLESALE');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO VALUES('09.- SIN EJECUTIVO RETAIL') ;

.IF ERRORCODE <> 0 THEN .QUIT 28;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_ELIMINADO)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO ;
	
.IF ERRORCODE <> 0 THEN .QUIT 29;

--/****************************************************************************
--** CREA TABLA DARLE VALOR AL CAMPO EN CASO DE...							  ** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE_MES_03;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE_MES_03
(
	 TE_CLI_RUT		INTEGER
	,TE_CASO 		 INTEGER
	
)PRIMARY INDEX (TE_CLI_RUT,TE_CASO)
;
.IF ERRORCODE <> 0 THEN .QUIT 30;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE_MES_03
SELECT
	 PE_CLI_RUT							AS TE_CLI_RUT
	,CASE 
	   WHEN FACT.PE_CARGABLE=1 AND FACT.PC_TPO_BANCA = 'WHOLESALE' AND FACT.PC_TIPO_FINAL = FIN.TC_TIPO_FINAL THEN 1
	   WHEN FACT.PE_CARGABLE=0 AND FACT.PC_TPO_BANCA = 'WHOLESALE' AND FACT.PC_TIPO_FINAL = FIN.TC_TIPO_FINAL THEN 1
	   WHEN FACT.PE_CARGABLE=1 AND FACT.PC_TPO_BANCA = 'WHOLESALE' AND FACT.PE_FUERA_CAPACITY=1 THEN 1
	   WHEN FACT.PE_CARGABLE=1 AND FACT.PC_TPO_BANCA = 'WHOLESALE' AND FACT.PC_TIPO_FINAL = FIN.TC_TIPO_FINAL AND FACT.PE_FUERA_CAPACITY=0 AND FACT.PE_PROPENSO>0 AND FACT.PC_ELIMINADO = '' THEN 1 
	   WHEN FACT.PE_CARGABLE=0 AND FACT.PE_PROPENSO>0 AND FACT.PC_TPO_BANCA = 'WHOLESALE' AND FACT.PC_ELIMINADO = ELI.TC_ELIMINADO THEN 1
    ELSE 0
	END										AS TE_CASO
FROM 	
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES AS FACT
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO AS ELI
		ON FACT.PC_ELIMINADO = ELI.TC_ELIMINADO
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_TIPO_FINAL AS FIN 
		ON FACT.PC_TIPO_FINAL = FIN.TC_TIPO_FINAL
GROUP BY 
	 TE_CLI_RUT
	,TE_CASO
;
.IF ERRORCODE <> 0 THEN .QUIT 31;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_CLI_RUT,TE_CASO)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE_MES_03;
	
.IF ERRORCODE <> 0 THEN .QUIT 32;

--/***********************************************************************
--**				ASIGNACION INBOUND WHOLESALE						**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_INBOUND_WHOLESALE;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_INBOUND_WHOLESALE
(
	 TE_PERIODO_CMP_F               INTEGER
	,TE_CLI_RUT                     INTEGER
	,TE_FUERA_CAPACITY				INTEGER
	,TE_N_ORDEN						INTEGER
	
)PRIMARY INDEX (TE_PERIODO_CMP_F,TE_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 33;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_INBOUND_WHOLESALE
SELECT 
	 PE_PERIODO_CMP_F       AS  TE_PERIODO_CMP_F       
	,PE_CLI_RUT             AS  TE_CLI_RUT             
	,PE_FUERA_CAPACITY		AS  TE_FUERA_CAPACITY		
    ,ROW_NUMBER() OVER (PARTITION BY PE_CUENTA ORDER BY PE_PRIORIDAD,PC_TIPO_OFERTA, PC_ZONA_CLIENTE) AS TE_N_ORDEN 
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES AS FACT
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE_MES_03 AS PM3
		ON FACT.PE_CLI_RUT = PM3.TE_CLI_RUT
		AND PM3.TE_CASO = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 34;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_INBOUND_WHOLESALE ;
	
.IF ERRORCODE <> 0 THEN .QUIT 35;

--/***********************************************************************
--**						UPDATE 	INBOUND PYME						**  
--***********************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_INBOUND_WHOLESALE
SET
	TE_FUERA_CAPACITY = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 36;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_INBOUND_WHOLESALE; 
	
.IF ERRORCODE <> 0 THEN .QUIT 37;
--/************************************************************************
--**	ACTUALIZA CAPACITY Y CAMPANA OFERTA DESDE FACTORING_INBOUND_PYME **  
--************************************************************************/	
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_INBOUND_WHOLESALE AS INB
SET 
	 PE_FUERA_CAPACITY = INB.TE_FUERA_CAPACITY
	,PC_CAMPANA_OFERTA = 'INBOUND'
	,PC_ELIMINADO = ''
	,PE_CARGABLE = 1

WHERE 
	PE_CLI_RUT = INB.TE_CLI_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 38;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES;
	
.IF ERRORCODE <> 0 THEN .QUIT 39;


	
SELECT DATE, TIME; 
.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 13 OK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: PARA CAMPANA WHOLESALE FACTORING SE APLICA REGLA PARA ASIGNACION			  **
--**                                                    				 				  **
--** AUTOR  : MICHELL CUAREZ                                                			  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 04/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 10/2024			     	                                                  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	                                                                  **
--**    MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS				                      **
--**	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_VACACIONES_FACT_LEA                               **
--**	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_MCL
--**TABLA DE SALIDA:    	                 											  **
--**    {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_MCL
--**                  	                     											  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARAMETROS	  								  **  
--*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_ASIG_PARAMETRO;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_ASIG_PARAMETRO
(
	 TE_PERIODO_CMP			INTEGER
	,TF_FECHA_CMP			DATE 	FORMAT 'YYYY-MM-DD'
	,TE_PERIODO_MENOS_1M	INTEGER
	,TF_FECHA_CRG 			DATE 	FORMAT 'YYYY-MM-DD'
	,TE_CAP_PYME 			INTEGER
	,TE_CAP_WLS             INTEGER
	,TE_CAP_FFVV            INTEGER
) UNIQUE PRIMARY INDEX (TE_PERIODO_CMP)

;
.IF ERRORCODE <> 0 THEN .QUIT 1;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_ASIG_PARAMETRO
SELECT 
	 PFE.SE_PERIODO_CMP  		AS TE_PERIODO_CMP
	,PFE.SF_FECHA_REF_DIA 		AS TF_FECHA_CMP
	,PFE.SE_PERIODO_MENOS_1M 	AS TE_PERIODO_MENOS_1M
	,PFE.SF_FECHA_CARGA			AS TF_FECHA_CRG	
	,PCP.SE_CAPACITY_PYME		AS TE_CAP_PYME     
	,PCP.SE_CAPACITY_WSB		AS TE_CAP_WLS 
	,PCP.SE_CAPACITY_FFVV		AS TE_CAP_FFVV
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS  PFE
	INNER JOIN MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_CMP PCP
		ON PCP.SC_CAMPANA = 'FACTORING_WHOLESALE'
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_ASIG_PARAMETRO;
	
.IF ERRORCODE <> 0 THEN .QUIT 3;
	

--/***********************************************************************
--** 		CAPACITY MAXIMO POR EJECUTIVO				**
--************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_01
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC       	
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC  
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_01
SELECT
 FAC.PC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.PE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.PD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.PC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.PC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.PE_PROPENSO						AS TE_PROPENSO					
,FAC.PC_TIPO 							AS TC_TIPO
,FAC.PD_PROB                            AS TD_PROB
,FAC.PC_TRAMO_FACT                      AS TC_TRAMO_FACT 	 									
,FAC.PC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.PE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.PC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.PE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.PC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.PC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.PC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.PE_CTACTE							AS TE_CTACTE      
,FAC.PE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.PE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.PC_ZONA_CLIENTE	                AS TC_ZONA_CLIENT    							
,FAC.PD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.PC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.PC_EJE_FCT							AS TC_EJE_FCT						
,FAC.PC_BANCO							AS TC_BANCO						
,FAC.PC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.PE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.PE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.PC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.PE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.PC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.PC_ACT_ECO							AS TC_ACT_ECO						
,FAC.PC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.PC_GLOSA 							AS TC_GLOSA 						
,FAC.PC_IVA 							AS TC_IVA 						
,FAC.PC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.PC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.PE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.PE_ES_BCI          				AS TE_ES_BCI     

,CASE 
	WHEN COALESCE(FAC.PC_TPO_BANCA,'') = 'PYME' 	 THEN PAR.TE_CAP_PYME
	WHEN COALESCE(FAC.PC_TPO_BANCA,'') = 'WHOLESALE' THEN PAR.TE_CAP_WLS
	ELSE 0  
 END									AS TE_CAPACITY_EJE 

,PAR.TE_CAP_FFVV    					AS TE_CAPACITY_FFVV   			
,1          							AS TE_CUENTA      

,FAC.PE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.PC_TEXTO1 							AS TC_TEXTO1 						
,FAC.PC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.PC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.PC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.PE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.PC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.PC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.PF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.PD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.PC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.PE_FDR                   			AS TE_FDR    	
,FAC.PE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.PE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.PC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.PD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.PE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.PE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.PE_MOLESTO							AS TE_MOLESTO
,FAC.PE_CARGABLE 						AS TE_CARGABLE                	
,FAC.PC_ELIMINADO						AS TC_ELIMINADO										
,FAC.PE_DUPLAS							AS TE_DUPLAS						
,FAC.PE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_MCL FAC
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_ASIG_PARAMETRO PAR
		ON 1 = 1  
;
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_01;
	
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/****************************************************************************
--** CREA TABLA TEMPORAL MIENTRAS EL PRODUCTO_BANCO SEA FACTORING			** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_VACACIONES_FACT_LEA;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_VACACIONES_FACT_LEA
(
	 TE_PERIODO_CMP 	INTEGER 
	,TC_USER 			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_CAPACITY_MAXIMO INTEGER 	
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP, TC_USER)
;
.IF ERRORCODE <> 0 THEN .QUIT 7;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_VACACIONES_FACT_LEA
SELECT 
	 SE_PERIODO_CMP 	 AS TE_PERIODO_CMP 	
	,SC_USER 			 AS TC_USER 			
	,SE_CAPACITY_MAXIMO  AS TE_CAPACITY_MAXIMO 	
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_VACACIONES_FACT_LEA
WHERE 
	(POSITION ('FACTORING' IN SC_PRODUCTO_BANCO) > 0)
;
.IF ERRORCODE <> 0 THEN .QUIT 8;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP, TC_USER)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_VACACIONES_FACT_LEA;
	
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/***********************************************************************
--** ACTUALIZA	CAPACITY_EJE CON TABLA VACACIONES_FACT_LEA**
--************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_02;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_02
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC       		
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 10;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_02
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT								
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE   							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI     

,CASE 
	WHEN FAC.TC_EJE_FCT = LEA.TC_USER
	AND COALESCE(FAC.TC_TPO_BANCA,'') = 'WHOLESALE'
	THEN LEA.TE_CAPACITY_MAXIMO 
	ELSE FAC.TE_CAPACITY_EJE  
 END									AS TE_CAPACITY_EJE 

,FAC.TE_CAPACITY_FFVV    				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA     						AS TE_CUENTA      
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE 						AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_01 FAC
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_VACACIONES_FACT_LEA LEA
        ON FAC.TC_EJE_FFVV = LEA.TC_USER  
;
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_02;
	
.IF ERRORCODE <> 0 THEN .QUIT 12;

--/***********************************************************************
--**  ACTUALIZA	CAPACITY_EJE CON TABLA VACACIONES_FACT_LEA**
--************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_03;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_03
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC		
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 13;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_03
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI     

,CASE 
	WHEN FAC.TC_EJE_FFVV = LEA.TC_USER
	AND COALESCE(FAC.TC_TPO_BANCA,'') = 'WHOLESALE'
	THEN LEA.TE_CAPACITY_MAXIMO 
	ELSE FAC.TE_CAPACITY_EJE  
 END									AS TE_CAPACITY_EJE 

,FAC.TE_CAPACITY_FFVV    				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA     						AS TE_CUENTA      
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE 						AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_02 FAC
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_VACACIONES_FACT_LEA LEA
        ON FAC.TC_EJE_FFVV = LEA.TC_USER    
;
.IF ERRORCODE <> 0 THEN .QUIT 14;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_03;
	
.IF ERRORCODE <> 0 THEN .QUIT 15;

--/***********************************************************************
--**	ACTUALIZA CARGABLE 	ASIGNACION FACTORING WSB					**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_04;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_04
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC		
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 16;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_04
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI     
,FAC.TE_CAPACITY_EJE					AS TE_CAPACITY_EJE 
,FAC.TE_CAPACITY_FFVV    				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA     						AS TE_CUENTA      
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  			
,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     

,CASE WHEN 	FAC.TE_CARGABLE=0 
	AND FAC.TC_TPO_BANCA = 'WHOLESALE'
	AND FAC.TC_ELIMINADO = ''
	THEN FAC.TC_TIPO_FINAL
	ELSE FAC.TC_CAMPANA_OFERTA END 			AS TC_CAMPANA_OFERTA        

,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO

,CASE WHEN 	FAC.TE_CARGABLE=0 
	AND FAC.TC_TPO_BANCA = 'WHOLESALE'
	AND FAC.TC_ELIMINADO = ''
	THEN 1
	ELSE FAC.TE_CARGABLE END 			AS TE_CARGABLE                	

,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_03 FAC
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_VACACIONES_FACT_LEA LEA
        ON FAC.TC_EJE_FFVV = LEA.TC_USER  
;
.IF ERRORCODE <> 0 THEN .QUIT 17;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_04;
	
.IF ERRORCODE <> 0 THEN .QUIT 18;

--/****************************************************************************
--** ASIGNACION FACTORING WHOLESALE -- CMP_FACT_WHOLESALE			** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE
(
	 TE_PERIODO_CMP_F					INTEGER       
	,TD_CLI_RUT          				DECIMAL(8,0)
	,TE_CAPACITY_EJE    				INTEGER
	,TE_FUERA_CAPACITY  				INTEGER
	,TC_TIPO_FINAL						VARCHAR (100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_FCT							VARCHAR (255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TIPO 							VARCHAR (100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_DUPLAS							INTEGER	
	,TE_N_ORDEN							INTEGER
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 19;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE
SELECT 				
	 TE_PERIODO_CMP_F					AS 	TE_PERIODO_CMP_F					  				
	,TD_CLI_RUT          				AS 	TD_CLI_RUT          				     				
	,TE_CAPACITY_EJE    				AS 	TE_CAPACITY_EJE    				  				
	,TE_FUERA_CAPACITY  				AS 	TE_FUERA_CAPACITY  
	,TC_TIPO_FINAL 						AS  TC_TIPO_FINAL 	
	,TC_EJE_FCT							AS  TC_EJE_FCT 
	,TC_TIPO 							AS  TC_TIPO
	,TE_DUPLAS 							AS  TE_DUPLAS
    ,ROW_NUMBER() OVER (PARTITION BY TE_CUENTA 
	                    ORDER BY TE_PRIORIDAD, TC_ESTADO_FACTORING, TC_TIPO_OFERTA, TE_MONTO_OFERTA DESC,TD_PROB DESC) AS TE_N_ORDEN 
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_04
WHERE 
	TC_TPO_BANCA = 'WHOLESALE'
	AND NOT (POSITION ('NUEVOS' IN TC_TIPO_FINAL) > 0)
	AND NOT (POSITION ('NUEVOS-' IN TC_TIPO_FINAL) > 0)
	AND TC_ELIMINADO = ''
;
.IF ERRORCODE <> 0 THEN .QUIT 20;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE;
	
.IF ERRORCODE <> 0 THEN .QUIT 21;

--/****************************************************************************
--** ASIGNACION FACTORING WHOLESALE -- CMP_FACT_WSB_CAPACITY	T2	 ** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WSB_CAPACITY;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WSB_CAPACITY
(
	 TE_PERIODO_CMP_F					INTEGER      
	,TD_CLI_RUT          				DECIMAL(8,0) 
	,TE_CAPACITY_EJE    				INTEGER 
	,TE_FUERA_CAPACITY  				INTEGER 
	,TC_TIPO_FINAL						VARCHAR (100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_N_ORDEN							INTEGER 
	,TE_N_FILA							INTEGER
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 22;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WSB_CAPACITY
SELECT 
	 TE_PERIODO_CMP_F					AS 	TE_PERIODO_CMP_F					    				
	,TD_CLI_RUT          				AS 	TD_CLI_RUT          				        				   				
	,TE_CAPACITY_EJE    				AS  PE_CAPACITY_EJE 
	,TE_FUERA_CAPACITY  				AS 	TE_FUERA_CAPACITY  				
	,TC_TIPO_FINAL 						AS  TC_TIPO_FINAL 	
	,TE_N_ORDEN							AS  TE_N_ORDEN
    ,ROW_NUMBER() OVER (PARTITION BY TC_EJE_FCT ORDER BY TC_EJE_FCT,TE_N_ORDEN ASC) AS TE_N_FILA 
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE
;
.IF ERRORCODE <> 0 THEN .QUIT 23;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WSB_CAPACITY;
	
.IF ERRORCODE <> 0 THEN .QUIT 24;

--/***********************************************************************
--**	ASIGNACION FACTORING WHOLESALE --UPDATE							**  
--***********************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WSB_CAPACITY_UPD;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WSB_CAPACITY_UPD
(
	 TE_PERIODO_CMP_F					INTEGER      
	,TD_CLI_RUT          				DECIMAL(8,0) 
	,TE_CAPACITY_EJE    				INTEGER 
	,TE_FUERA_CAPACITY  				INTEGER 
	,TC_TIPO_FINAL						VARCHAR (100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_N_ORDEN							INTEGER 
	,TE_N_FILA							INTEGER
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 25;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WSB_CAPACITY_UPD
SELECT 
	 TE_PERIODO_CMP_F					AS 	TE_PERIODO_CMP_F					    				
	,TD_CLI_RUT          				AS 	TD_CLI_RUT          				        				   				
	,TE_CAPACITY_EJE    				AS  PE_CAPACITY_EJE 

	, CASE WHEN TE_N_FILA > TE_CAPACITY_EJE 
		THEN 1 
		ELSE 0 END 		  				AS 	TE_FUERA_CAPACITY  				

	,TC_TIPO_FINAL 						AS  TC_TIPO_FINAL 	
	,TE_N_ORDEN							AS  TE_N_ORDEN
    ,TE_N_FILA							AS TE_N_FILA 
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WSB_CAPACITY 
;
.IF ERRORCODE <> 0 THEN .QUIT 26;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WSB_CAPACITY_UPD;
	
.IF ERRORCODE <> 0 THEN .QUIT 27;

--/***********************************************************************
--**	MARCO FINALMENTE LOS ASIGNADOS A EJECUTIVOS FACTORING			**  
--***********************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_05;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_05
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC		
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 28;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_05
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                         AS TC_TRAMO_FACT 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENTE    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI     
,FAC.TE_CAPACITY_EJE					AS TE_CAPACITY_EJE 
,FAC.TE_CAPACITY_FFVV    				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA     						AS TE_CUENTA   

,CASE WHEN CAP.TD_CLI_RUT IS NOT NULL
	THEN CAP.TE_FUERA_CAPACITY
	ELSE 0 END 		                    AS TE_FUERA_CAPACITY  	

,FAC.TC_TEXTO1 							AS TC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     

,CASE WHEN CAP.TD_CLI_RUT IS NOT NULL
	THEN 
	  CASE WHEN CAP.TE_FUERA_CAPACITY = 0
		THEN  CAP.TC_TIPO_FINAL 
		ELSE NULL 	
	  END	
    ELSE NULL END    	                AS TC_CAMPANA_OFERTA  	 

,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE						AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_04 FAC
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WSB_CAPACITY_UPD CAP
		ON 	FAC.TD_CLI_RUT = CAP.TD_CLI_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 29;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_05;
	
.IF ERRORCODE <> 0 THEN .QUIT 30;

--/****************************************************************************
--** CREAR TABLA TEMPORAL PARA TIPO FINAL NUEVOS Y NUEVOS-					** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_TIPO_FINAL;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_TIPO_FINAL
(
	TC_TIPO_FINAL VARCHAR (100) CHARACTER SET LATIN NOT CASESPECIFIC

)UNIQUE PRIMARY INDEX (TC_TIPO_FINAL)
;
.IF ERRORCODE <> 0 THEN .QUIT 31;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_TIPO_FINAL VALUES ('NUEVOS');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_TIPO_FINAL VALUES ('NUEVOS-');

.IF ERRORCODE <> 0 THEN .QUIT 32;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_TIPO_FINAL)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_TIPO_FINAL;
	
.IF ERRORCODE <> 0 THEN .QUIT 33;


--/***********************************************************************
--**				TABLA TEMPORAL DE ELIMINADOS					**  
--***********************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO
(
	TC_ELIMINADO				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	
)UNIQUE PRIMARY INDEX (TC_ELIMINADO)
;
.IF ERRORCODE <> 0 THEN .QUIT 34;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO VALUES('04.- SIN EJECUTIVO');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO VALUES('05.- BANCA NO CORRESPONDE');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO VALUES('06.- MOLESTOS');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO VALUES('07.- SIN PLATAFORMA');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO VALUES('08.- SIN REGIONAL');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO VALUES('09.- SIN EJECUTIVO WHOLESALE');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO VALUES('09.- SIN EJECUTIVO RETAIL') ;

.IF ERRORCODE <> 0 THEN .QUIT 35;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_ELIMINADO)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO ;
	
.IF ERRORCODE <> 0 THEN .QUIT 36;

--/****************************************************************************
--** CREA TABLA DARLE VALOR AL CAMPO EN CASO DE...							  ** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE_MES_03;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE_MES_03
(
	 TD_CLI_RUT		DECIMAL(8,0)
	,TE_CASO 		 INTEGER
	
)UNIQUE PRIMARY INDEX (TD_CLI_RUT,TE_CASO)
;
.IF ERRORCODE <> 0 THEN .QUIT 37;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE_MES_03
SELECT
	 TD_CLI_RUT							AS TD_CLI_RUT
	,CASE 
	   WHEN FACT.TE_CARGABLE=1 AND FACT.TC_TPO_BANCA = 'WHOLESALE' AND FACT.TC_TIPO_FINAL = FIN.TC_TIPO_FINAL THEN 1
	   WHEN FACT.TE_CARGABLE=0 AND FACT.TC_TPO_BANCA = 'WHOLESALE' AND FACT.TC_TIPO_FINAL = FIN.TC_TIPO_FINAL THEN 1
	   WHEN FACT.TE_CARGABLE=1 AND FACT.TC_TPO_BANCA = 'WHOLESALE' AND FACT.TE_FUERA_CAPACITY=1 THEN 1
	   WHEN FACT.TE_CARGABLE=1 AND FACT.TC_TPO_BANCA = 'WHOLESALE' AND FACT.TC_TIPO_FINAL = FIN.TC_TIPO_FINAL AND FACT.TE_FUERA_CAPACITY=0 AND FACT.TE_PROPENSO>0 AND FACT.TC_ELIMINADO = '' THEN 1 
	   WHEN FACT.TE_CARGABLE=0 AND FACT.TE_PROPENSO>0 AND FACT.TC_TPO_BANCA = 'WHOLESALE' AND FACT.TC_ELIMINADO = ELI.TC_ELIMINADO THEN 1
    ELSE 0
	END										AS TE_CASO
FROM 	
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_05 FACT
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_ELIMINADO ELI
		ON FACT.TC_ELIMINADO = ELI.TC_ELIMINADO
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_TIPO_FINAL FIN 
		ON FACT.TC_TIPO_FINAL = FIN.TC_TIPO_FINAL
GROUP BY 
	 TD_CLI_RUT
	,TE_CASO
;
.IF ERRORCODE <> 0 THEN .QUIT 38;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_CLI_RUT,TE_CASO)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE_MES_03;
	
.IF ERRORCODE <> 0 THEN .QUIT 39;

--/***********************************************************************
--**				ASIGNACION INBOUND WHOLESALE						**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_INBOUND_WHOLESALE;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_INBOUND_WHOLESALE
(
	 TE_PERIODO_CMP_F               INTEGER
	,TD_CLI_RUT                     DECIMAL(8,0)
	,TE_FUERA_CAPACITY				INTEGER
	,TE_N_ORDEN						INTEGER
	
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 40;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_INBOUND_WHOLESALE
SELECT 
	 FACT.TE_PERIODO_CMP_F       AS  TE_PERIODO_CMP_F       
	,FACT.TD_CLI_RUT             AS  TD_CLI_RUT             	
	,1                  		AS  TE_FUERA_CAPACITY		
    ,ROW_NUMBER() OVER (PARTITION BY FACT.TE_CUENTA ORDER BY FACT.TE_PRIORIDAD,FACT.TC_TIPO_OFERTA, FACT.TC_ZONA_CLIENTE) AS TE_N_ORDEN 
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_05 FACT
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_WHOLESALE_MES_03 PM3
		ON FACT.TD_CLI_RUT = PM3.TD_CLI_RUT
		AND PM3.TE_CASO = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 41;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_INBOUND_WHOLESALE ;
	
.IF ERRORCODE <> 0 THEN .QUIT 42;

--/**********************************************************************************
--**	ACTUALIZA CAPACITY Y CAMPANA OFERTA DESDE FACTORING_INBOUND_PYME 
--**    SE CREA TAMBIÉN A TABLA DE PRE CALCULO PARA SER UTILIZADA EN SIGUIENTE BTEQ
--***********************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_ASG;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_ASG
(
	 PC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,PE_PERIODO_CMP_F					INTEGER 		
    ,PD_CLI_RUT          				DECIMAL(8,0)
    ,PC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PE_PROPENSO						INTEGER
    ,PC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,PD_PROB							DECIMAL (25,10)
    ,PC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC     		    
    ,PC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,PE_CONVENCIMIENTO   				INTEGER
    ,PC_ESTADO_FACTORING				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_PRIORIDAD						INTEGER
    ,PC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,PE_CTACTE							INTEGER
	,PE_IS_FUGADO                       BIGINT
    ,PE_CONOFERTARIESGOS    			INTEGER
	,PC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC    
    ,PD_VECES_VTA_PROP					DECIMAL (1,0)
    ,PC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_VETADO_RIESGOS					INTEGER
    ,PE_MONTO_OFERTA					BIGINT
    ,PC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_MARCA_CODACTECO_FUERA 			INTEGER
    ,PC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_MARCA_RUTGOB    				INTEGER
    ,PE_ES_BCI          				INTEGER
    ,PE_CAPACITY_EJE    				INTEGER
    ,PE_CAPACITY_FFVV   				INTEGER
    ,PE_CUENTA          				INTEGER
    ,PE_FUERA_CAPACITY  				INTEGER
    ,PC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_EN_PLANEAMIENTO					INTEGER
    ,PC_RECOMENDACION_DE_CRUCE			VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,PD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,PC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_FDR 							INTEGER
    ,PE_COS_CLI             			INTEGER
    ,PE_FILTROS_RIESGOS     			INTEGER
    ,PC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,PE_PAR_FDR 						INTEGER
    ,PE_PAR_COS_CLI             		INTEGER
    ,PE_MOLESTO                 		INTEGER
    ,PE_CARGABLE                		INTEGER
    ,PC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_DUPLAS							INTEGER
    ,PE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (PE_PERIODO_CMP_F,PD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 43;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_ASG
SELECT
 FAC.TC_TPO_BANCA						AS PC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS PE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS PD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS PC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS PC_NOM_CLI          			
,FAC.TE_PROPENSO						AS PE_PROPENSO					
,FAC.TC_TIPO 							AS PC_TIPO
,FAC.TD_PROB                            AS PD_PROB
,FAC.TC_TRAMO_FACT                      AS PC_TRAMO_FACT  									
,FAC.TC_MARCA_FACTORING  				AS PC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS PE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS PC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS PE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS PC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS PC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS PC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS PE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS PE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS PE_CONOFERTARIESGOS 
,FAC.TC_ZONA_CLIENTE	                AS PC_ZONA_CLIENTE   							
,FAC.TD_VECES_VTA_PROP					AS PD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS PC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS PC_EJE_FCT						
,FAC.TC_BANCO							AS PC_BANCO						
,FAC.TC_EJE_FFVV						AS PC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS PE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS PE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS PC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS PE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS PC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS PC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS PC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS PC_GLOSA 						
,FAC.TC_IVA 							AS PC_IVA 						
,FAC.TC_CATEGORIA 						AS PC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS PC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS PE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS PE_ES_BCI     
,FAC.TE_CAPACITY_EJE					AS PE_CAPACITY_EJE 
,FAC.TE_CAPACITY_FFVV    				AS PE_CAPACITY_FFVV   			
,FAC.TE_CUENTA     						AS PE_CUENTA   

,CASE WHEN INB.TD_CLI_RUT IS NOT NULL
	THEN INB.TE_FUERA_CAPACITY
	ELSE FAC.TE_FUERA_CAPACITY  END 	AS PE_FUERA_CAPACITY  	

,FAC.TC_TEXTO1 							AS PC_TEXTO1 						
,FAC.TC_TEXTO2                      	AS PC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS PC_CARACTERISTICAS_CLIENTE     

,CASE WHEN INB.TD_CLI_RUT IS NOT NULL
	THEN 'INBOUND'
	ELSE FAC.TC_CAMPANA_OFERTA END    	AS PC_CAMPANA_OFERTA  	 

,FAC.TE_EN_PLANEAMIENTO					AS PE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS PC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS PC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS PF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS PD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS PC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS PE_FDR    	
,FAC.TE_COS_CLI		               		AS PE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS PE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS PC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS PD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS PE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS PE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS PE_MOLESTO

,CASE WHEN INB.TD_CLI_RUT IS NOT NULL
	THEN 1
	ELSE FAC.TE_CARGABLE END    		AS PE_CARGABLE  
              	
,CASE WHEN INB.TD_CLI_RUT IS NOT NULL
	THEN ''
	ELSE FAC.TC_ELIMINADO END    		AS PC_ELIMINADO  
              													
,FAC.TE_DUPLAS							AS PE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS PE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_ASG_05 FAC
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CMP_FACT_INBOUND_WHOLESALE INB
		ON 	FAC.TD_CLI_RUT = INB.TD_CLI_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 44;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_ASG;
	
.IF ERRORCODE <> 0 THEN .QUIT 45;
	
SELECT DATE, TIME; 
.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 14 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: PARA CAMPANA WHOLESALE FACTORING SE APLICA REGLA PARA MARCA LITERAL 		  **
--**                                                    				 				  **
--** AUTOR  : MICHELL CUAREZ                                                			  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 04/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN:                                                           				  **
--** AUTOR  :                                                           				  **
--** FECHA  : SSAAMMDD                                                  				  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES  	  **
--**					                              									  **               
--**TABLA DE SALIDA:	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES  	  **
--**                  	                   												  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/*************************************************************************
--** ARMO LITERALES	  													  **  
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
SET 
	 PC_TEXTO1 = NULL
	,PC_TEXTO2 = NULL
	,PC_CARACTERISTICAS_CLIENTE = NULL 
;
.IF ERRORCODE <> 0 THEN .QUIT 1;
--/*************************************************************************
--** ACTUALIZO TEXTO1 CUANDO PROPENSO SEA MAYOR A CERO	  				  **  
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
SET 
	PC_TEXTO1 =  'CLIENTE PERFIL ' || UPPER(PC_TIPO_FINAL)
WHERE 
	PE_PROPENSO>0
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES;
	
.IF ERRORCODE <> 0 THEN .QUIT 3;


--/*************************************************************************
--** ACTUALIZO TEXTO1 CUANDO PROPENSO CON LA TABLA MARCA_FACTORING	  **  
--*************************************************************************/

UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
SET 
	PC_TEXTO1 = PC_TEXTO1 || 
		CASE 
			WHEN NOT (UPPER(COALESCE(LTRIM(RTRIM(PC_MARCA_FACTORING)),'')) = '') THEN ', '||UPPER(PC_MARCA_FACTORING)
		 ELSE '' 
		 END 
WHERE 
	PE_PROPENSO>=0 

;
.IF ERRORCODE <> 0 THEN .QUIT 4;

--/*************************************************************************
--** ACTUALIZO TEXTO1 CUANDO PROPENSO CON LA TABLA MARCA_FACTORING	  **  
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES 
SET
	PC_TEXTO1 = PC_TEXTO1 || 
	    CASE 
		      WHEN PE_CONVENCIMIENTO>0 AND NOT (PC_TIPO_FINAL = 'FUGADOS') THEN ', CON VENCIMIENTO'
		  ELSE '' 
		  END 
WHERE 
	PE_PROPENSO>=0 
;
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/*************************************************************************
--** ACTUALIZO TEXTO2 CUANDO PROPENSO SEA IGUAL A CERO	  **  
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	PC_TEXTO2 = 
	    CASE 
           WHEN COALESCE(PC_TRAMO_FACT,'')  IN ('1. ALTA - TEF/LBRT','1. ALTA') OR COALESCE(PC_ESTADO_FACTORING,'') = ('2-PROSP. CLIENTE TEF_LBTR') THEN 'CLIENTE ALTAMENTE PROPENSO AL FACTORING'
		   ELSE 'CLIENTE PROPENSO AL FACTORING' 
		 END 
WHERE 
	PE_PROPENSO>=0 
;
.IF ERRORCODE <> 0 THEN .QUIT 6;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES;
	
.IF ERRORCODE <> 0 THEN .QUIT 7;

--/****************************************************************************
--** CREAR TABLA TEMPORAL PARA ESTADO_LEAD					** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CMP_ESTADO_LEAD;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CMP_ESTADO_LEAD
(
	TC_ESTADO_LEAD VARCHAR (100) CHARACTER SET LATIN NOT CASESPECIFIC

)PRIMARY INDEX (TC_ESTADO_LEAD)
;
.IF ERRORCODE <> 0 THEN .QUIT 8;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CMP_ESTADO_LEAD VALUES ('ACEPTADO');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CMP_ESTADO_LEAD VALUES ('AGENDADO');


.IF ERRORCODE <> 0 THEN .QUIT 9;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_ESTADO_LEAD)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CMP_ESTADO_LEAD;
	
.IF ERRORCODE <> 0 THEN .QUIT 10;

--/*************************************************************************
--** ACTUALIZO TEXTO2 CON TABLA CMP_ESTADO_LEAD **  
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES FAC
--FROM 
--	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CMP_ESTADO_LEAD AS LEA
SET 
	PC_TEXTO2 = PC_TEXTO2||' , '||COALESCE(UPPER(PC_ESTADO_LEAD),'') 
WHERE
	PE_PROPENSO>=0 
--	AND COALESCE(PC_ESTADO_LEAD,'') = LEA.TC_ESTADO_LEAD 	
	AND EXISTS (SELECT 1 
        FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CMP_ESTADO_LEAD LEA
        WHERE COALESCE(FAC.PC_ESTADO_LEAD,'') = LEA.TC_ESTADO_LEAD
    )
;
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/*************************************************************************
--** ACTUALIZO TEXTO1 MIENTRAS PROPENSO SEA MAYOR A CERO **  
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	PC_TEXTO1 = PC_TEXTO1||
	      CASE 
		      WHEN PC_TIPO_OFERTA = '1 APROBADO'        THEN ', CON OFERTA APROBADA FACTORING POR $M'||OREPLACE(OREPLACE(OREPLACE(CAST(CAST(PE_MONTO_OFERTA AS FORMAT 'ZZZ,ZZZ,ZZ9.99' ) AS VARCHAR(50)) ,',','Q'),'.',','),'Q','.')
              WHEN PC_TIPO_OFERTA = '2 CUPO DISPONIBLE' THEN ', CON CUPO DISPONIBLE (REFERENCIAL) POR$M'||OREPLACE(OREPLACE(OREPLACE(CAST(CAST(PE_MONTO_OFERTA AS FORMAT 'ZZZ,ZZZ,ZZ9.99' ) AS VARCHAR(50)) ,',','Q'),'.',','),'Q','.') 
              WHEN PC_TIPO_OFERTA = '3 VECES VENTAS'    THEN ', CON OFERTA PRE-APROBADA FACTORING POR '||OREPLACE(CAST(PD_VECES_VTA_PROP AS VARCHAR(3)), '.',',') || ' MESES VENTAS'
              WHEN PC_TIPO_OFERTA = '4 SIN OFERTA'      THEN ''
          END
WHERE 
	PE_PROPENSO>=0 
;
.IF ERRORCODE <> 0 THEN .QUIT 12;

--/*************************************************************************
--** ACTUALIZO CARACTERISTICAS_CLIENTE MIENTRAS PROPENSO SEA MAYOR A CERO **  
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET PC_CARACTERISTICAS_CLIENTE = 
	      CASE 
		      WHEN PC_TIPO_OFERTA = '1 APROBADO'        THEN 'CON OFERTA APROBADA FACTORING POR $M'||OREPLACE(OREPLACE(OREPLACE(CAST(CAST(PE_MONTO_OFERTA AS FORMAT 'ZZZ,ZZZ,ZZ9.99' ) AS VARCHAR(50)) ,',','Q'),'.',','),'Q','.')
              WHEN PC_TIPO_OFERTA = '2 CUPO DISPONIBLE' THEN 'CON CUPO DISPONIBLE (REFERENCIAL) POR$M'||OREPLACE(OREPLACE(OREPLACE(CAST(CAST(PE_MONTO_OFERTA AS FORMAT 'ZZZ,ZZZ,ZZ9.99' ) AS VARCHAR(50)) ,',','Q'),'.',','),'Q','.') 
              WHEN PC_TIPO_OFERTA = '3 VECES VENTAS'    THEN ', CON OFERTA PRE-APROBADA FACTORING POR '||OREPLACE(CAST(PD_VECES_VTA_PROP AS VARCHAR(3)), '.',',') || ' MESES VENTAS'
              WHEN PC_TIPO_OFERTA = '4 SIN OFERTA'      THEN ''
          END
WHERE 
	PE_PROPENSO>=0 
;
.IF ERRORCODE <> 0 THEN .QUIT 13;
--/*************************************************************************
--** ACTUALIZO CARACTERISTICAS_CLIENTE MIENTRAS PROPENSO SEA MAYOR A CERO **  
--*************************************************************************/

UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	PC_CARACTERISTICAS_CLIENTE = PC_CARACTERISTICAS_CLIENTE||
              CASE 
				 WHEN PC_TIPO_OFERTA_FINAL IS NOT NULL THEN ' DATO RIESGO : '||RTRIM(LTRIM(PC_TIPO_OFERTA_FINAL))
			  ELSE '' END
WHERE 
	PE_PROPENSO>=0 
;
.IF ERRORCODE <> 0 THEN .QUIT 14;

--/*************************************************************************
--** ACTUALIZO CARACTERISTICAS_CLIENTE MIENTRAS PROPENSO SEA MAYOR A CERO **  
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	PC_CARACTERISTICAS_CLIENTE = PC_CARACTERISTICAS_CLIENTE||
              CASE WHEN PC_TIPO_FINAL='NUEVOS' AND (COALESCE(PC_TRAMO_FACT,'')  IN ('1. ALTA - TEF/LBRT','1. ALTA') OR COALESCE(PC_ESTADO_FACTORING,'') IN ('2-PROSP. CLIENTE TEF_LBTR')) THEN '' --', OPERA FACTORING EN COMPETENCIA'
  			  ELSE '' END
WHERE 
	PE_PROPENSO>=0 
;
.IF ERRORCODE <> 0 THEN .QUIT 15;

--/*************************************************************************************
--** ACTUALIZO CARACTERISTICAS_CLIENTE MIENTRAS BANCA SEA PYME Y DUPLAS MAYOR A CERO **  
--*************************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	PC_CARACTERISTICAS_CLIENTE = 'CLIENTE EN CAMPANA DUPLAS, COORDINAR VISITA EJECUTIVO COMERCIAL'
WHERE 
	PC_TPO_BANCA = 'PYME'
	AND PE_DUPLAS>0
;
.IF ERRORCODE <> 0 THEN .QUIT 16;

--/*************************************************************************************
--** ACTUALIZO TEXTO1 MIENTRAS PROPENSO SEA MAYOR A CERO 							**  
--*************************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES
SET 
	PC_TEXTO1 = COALESCE(PC_TEXTO1,'')||', ENROLADO EN DATAMART ('||CASE WHEN PE_ENROLADO_DTM>0 THEN 'SI' ELSE 'NO' END||')'
WHERE 
	PE_PROPENSO>=0
;
.IF ERRORCODE <> 0 THEN .QUIT 17;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES;
	
.IF ERRORCODE <> 0 THEN .QUIT 18;


SELECT DATE, TIME; 

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 14 OK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: PARA CAMPANA WHOLESALE FACTORING SE APLICA REGLA PARA MARCA LITERAL 		  **
--**                                                    				 				  **
--** AUTOR  : MICHELL CUAREZ                                                			  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 04/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 10/2024			     	                                                  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	                                                                  **
--** {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_ASG **
--**					                              									  **               
--**TABLA DE SALIDA:	                                                                  **
--** {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_ASG **
--**                  	                   												  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8'; 
SELECT DATE, TIME;  

--/*************************************************************************
--** ARMO LITERALES	  													  **  
--** ACTUALIZO TEXTO1 CUANDO PROPENSO SEA MAYOR A CERO	  				  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_00;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_00
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC     	
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC  
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 1;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_00
SELECT
 FAC.PC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.PE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.PD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.PC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.PC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.PE_PROPENSO						AS TE_PROPENSO					
,FAC.PC_TIPO 							AS TC_TIPO
,FAC.PD_PROB                            AS TD_PROB
,FAC.PC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.PC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.PE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.PC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.PE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.PC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.PC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.PC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.PE_CTACTE							AS TE_CTACTE      
,FAC.PE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.PE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.PC_ZONA_CLIENTE	                AS TC_ZONA_CLIENT    							
,FAC.PD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.PC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.PC_EJE_FCT							AS TC_EJE_FCT						
,FAC.PC_BANCO							AS TC_BANCO						
,FAC.PC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.PE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.PE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.PC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.PE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.PC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.PC_ACT_ECO							AS TC_ACT_ECO						
,FAC.PC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.PC_GLOSA 							AS TC_GLOSA 						
,FAC.PC_IVA 							AS TC_IVA 						
,FAC.PC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.PC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.PE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.PE_ES_BCI          				AS TE_ES_BCI     
,FAC.PE_CAPACITY_EJE					AS TE_CAPACITY_EJE 
,FAC.PE_CAPACITY_FFVV    				AS TE_CAPACITY_FFVV   			
,FAC.PE_CUENTA          				AS TE_CUENTA      
,FAC.PE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  	

,CASE WHEN FAC.PE_PROPENSO > 0 
	THEN 'CLIENTE PERFIL ' || UPPER(FAC.PC_TIPO_FINAL) 
    ELSE NULL 
 END 				                    AS TC_TEXTO1 					

,NULL                      	            AS TC_TEXTO2                      
,NULL     	                            AS TC_CARACTERISTICAS_CLIENTE     
,FAC.PC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.PE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.PC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.PC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.PF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.PD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.PC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.PE_FDR                   			AS TE_FDR    	
,FAC.PE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.PE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.PC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.PD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.PE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.PE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.PE_MOLESTO							AS TE_MOLESTO
,FAC.PE_CARGABLE 						AS TE_CARGABLE                	
,FAC.PC_ELIMINADO						AS TC_ELIMINADO										
,FAC.PE_DUPLAS							AS TE_DUPLAS						
,FAC.PE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_ASG FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_00;
	
.IF ERRORCODE <> 0 THEN .QUIT 3;


--/*************************************************************************
--** ACTUALIZO TEXTO1 CUANDO PROPENSO CON LA TABLA MARCA_FACTORING	  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_01
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC     	
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC  
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_01
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENT    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI     
,FAC.TE_CAPACITY_EJE					AS TE_CAPACITY_EJE 
,FAC.TE_CAPACITY_FFVV    				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA      
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  	

,CASE WHEN FAC.TE_PROPENSO >= 0 
	THEN FAC.TC_TEXTO1 ||
		 CASE 
			WHEN NOT (UPPER(COALESCE(LTRIM(RTRIM(FAC.TC_MARCA_FACTORING)),'')) = '') THEN ', '||UPPER(FAC.TC_MARCA_FACTORING)
		 	ELSE '' 
		 END 
  ELSE FAC.TC_TEXTO1 END 				AS TC_TEXTO1 					

,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE 						AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_00 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_01;
	
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/*************************************************************************
--** ACTUALIZO TEXTO1 CUANDO PROPENSO CON LA TABLA MARCA_FACTORING	  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_02;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_02
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC        	
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC  
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 7;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_02
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENT    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI     
,FAC.TE_CAPACITY_EJE					AS TE_CAPACITY_EJE 
,FAC.TE_CAPACITY_FFVV    				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA      
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  	

,CASE WHEN FAC.TE_PROPENSO >= 0 
	THEN FAC.TC_TEXTO1 ||
		 CASE 
			WHEN FAC.TE_CONVENCIMIENTO>0 AND NOT (FAC.TC_TIPO_FINAL = 'FUGADOS') THEN ', CON VENCIMIENTO'
		 	ELSE '' 
		 END 
 ELSE FAC.TC_TEXTO1 END 				AS TC_TEXTO1 						

,FAC.TC_TEXTO2                      	AS TC_TEXTO2                      
,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE 						AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_01 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_02;
	
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/*************************************************************************
--** ACTUALIZO TEXTO2 CUANDO PROPENSO SEA IGUAL A CERO	  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_03;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_03
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      	
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC  
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 10;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_03
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT 	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENT    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI     
,FAC.TE_CAPACITY_EJE					AS TE_CAPACITY_EJE 
,FAC.TE_CAPACITY_FFVV    				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA      
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  	
,FAC.TC_TEXTO1							AS TC_TEXTO1 						

,CASE WHEN FAC.TE_PROPENSO >= 0 
	THEN 
	    CASE 
           WHEN COALESCE(FAC.TC_TRAMO_FACT,'')  IN ('1. ALTA - TEF/LBRT','1. ALTA') OR COALESCE(FAC.TC_ESTADO_FACTORING,'') = ('2-PROSP. CLIENTE TEF_LBTR') 
           THEN 'CLIENTE ALTAMENTE PROPENSO AL FACTORING'
		   ELSE 'CLIENTE PROPENSO AL FACTORING' 
		 END 
    ELSE FAC.TC_TEXTO2 END 				AS TC_TEXTO2 

,FAC.TC_CARACTERISTICAS_CLIENTE     	AS TC_CARACTERISTICAS_CLIENTE     
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE 						AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_02 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_03;
	
.IF ERRORCODE <> 0 THEN .QUIT 12;

--/****************************************************************************
--** CREAR TABLA TEMPORAL PARA ESTADO_LEAD					** 
--*****************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CMP_ESTADO_LEAD;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CMP_ESTADO_LEAD
(
	TC_ESTADO_LEAD VARCHAR (100) CHARACTER SET LATIN NOT CASESPECIFIC

)UNIQUE PRIMARY INDEX (TC_ESTADO_LEAD)
;
.IF ERRORCODE <> 0 THEN .QUIT 13;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CMP_ESTADO_LEAD VALUES ('ACEPTADO');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CMP_ESTADO_LEAD VALUES ('AGENDADO');


.IF ERRORCODE <> 0 THEN .QUIT 14;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_ESTADO_LEAD)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CMP_ESTADO_LEAD;
	
.IF ERRORCODE <> 0 THEN .QUIT 15;

--/*************************************************************************
--** ACTUALIZO TEXTO1 MIENTRAS PROPENSO SEA MAYOR A CERO 
--** ACTUALIZO TEXTO2 CON TABLA CMP_ESTADO_LEAD 
--** ACTUALIZO CARACTERISTICAS_CLIENTE MIENTRAS PROPENSO SEA MAYOR A CERO 
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_04;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_04
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC    	
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC  
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 16;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_04
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT 	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENT    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI     
,FAC.TE_CAPACITY_EJE					AS TE_CAPACITY_EJE 
,FAC.TE_CAPACITY_FFVV    				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA      
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  						

,CASE WHEN FAC.TE_PROPENSO >= 0 
	THEN FAC.TC_TEXTO1 ||	
	      CASE 
		      WHEN FAC.TC_TIPO_OFERTA = '1 APROBADO'        THEN ', CON OFERTA APROBADA FACTORING POR $M'||OREPLACE(OREPLACE(OREPLACE(CAST(CAST(FAC.TE_MONTO_OFERTA AS FORMAT 'ZZZ,ZZZ,ZZ9.99' ) AS VARCHAR(50)) ,',','Q'),'.',','),'Q','.')
              WHEN FAC.TC_TIPO_OFERTA = '2 CUPO DISPONIBLE' THEN ', CON CUPO DISPONIBLE (REFERENCIAL) POR$M'||OREPLACE(OREPLACE(OREPLACE(CAST(CAST(FAC.TE_MONTO_OFERTA AS FORMAT 'ZZZ,ZZZ,ZZ9.99' ) AS VARCHAR(50)) ,',','Q'),'.',','),'Q','.') 
              WHEN FAC.TC_TIPO_OFERTA = '3 VECES VENTAS'    THEN ', CON OFERTA PRE-APROBADA FACTORING POR '||OREPLACE(CAST(FAC.TD_VECES_VTA_PROP AS VARCHAR(3)), '.',',') || ' MESES VENTAS'
              WHEN FAC.TC_TIPO_OFERTA = '4 SIN OFERTA'      THEN ''
          END
 ELSE FAC.TC_TEXTO1 END 				AS TC_TEXTO1 

,CASE WHEN FAC.TE_PROPENSO >= 0 
	AND LEA.TC_ESTADO_LEAD IS NOT NULL
	THEN FAC.TC_TEXTO2||' , '||COALESCE(UPPER(FAC.TC_ESTADO_LEAD),'') 
 ELSE FAC.TC_TEXTO2 END 				AS TC_TEXTO2 

,CASE WHEN FAC.TE_PROPENSO >= 0 
	THEN CASE 
		      WHEN FAC.TC_TIPO_OFERTA = '1 APROBADO'        THEN 'CON OFERTA APROBADA FACTORING POR $M'||OREPLACE(OREPLACE(OREPLACE(CAST(CAST(FAC.TE_MONTO_OFERTA AS FORMAT 'ZZZ,ZZZ,ZZ9.99' ) AS VARCHAR(50)) ,',','Q'),'.',','),'Q','.')
              WHEN FAC.TC_TIPO_OFERTA = '2 CUPO DISPONIBLE' THEN 'CON CUPO DISPONIBLE (REFERENCIAL) POR$M'||OREPLACE(OREPLACE(OREPLACE(CAST(CAST(FAC.TE_MONTO_OFERTA AS FORMAT 'ZZZ,ZZZ,ZZ9.99' ) AS VARCHAR(50)) ,',','Q'),'.',','),'Q','.') 
              WHEN FAC.TC_TIPO_OFERTA = '3 VECES VENTAS'    THEN ', CON OFERTA PRE-APROBADA FACTORING POR '||OREPLACE(CAST(FAC.TD_VECES_VTA_PROP AS VARCHAR(3)), '.',',') || ' MESES VENTAS'
              WHEN FAC.TC_TIPO_OFERTA = '4 SIN OFERTA'      THEN ''
          END
 ELSE FAC.TC_CARACTERISTICAS_CLIENTE END AS TC_CARACTERISTICAS_CLIENTE 
   
,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE 						AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_03 FAC
    LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_FAC_CMP_ESTADO_LEAD LEA
            ON COALESCE(FAC.TC_ESTADO_LEAD,'') = LEA.TC_ESTADO_LEAD
;
.IF ERRORCODE <> 0 THEN .QUIT 17;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_04;
	
.IF ERRORCODE <> 0 THEN .QUIT 18;

--/*************************************************************************
--** ACTUALIZO CARACTERISTICAS_CLIENTE MIENTRAS PROPENSO SEA MAYOR A CERO **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_05;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_05
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC    	
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC  
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 19;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_05
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENT    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI     
,FAC.TE_CAPACITY_EJE					AS TE_CAPACITY_EJE 
,FAC.TE_CAPACITY_FFVV    				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA      
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  
,FAC.TC_TEXTO1  						AS TC_TEXTO1 
,FAC.TC_TEXTO2							AS TC_TEXTO2 							

,CASE WHEN FAC.TE_PROPENSO >= 0 
	THEN FAC.TC_CARACTERISTICAS_CLIENTE||
        CASE 
		  WHEN FAC.TC_TIPO_OFERTA_FINAL IS NOT NULL THEN ' DATO RIESGO : '||RTRIM(LTRIM(FAC.TC_TIPO_OFERTA_FINAL))
		  ELSE '' 
        END
 ELSE FAC.TC_CARACTERISTICAS_CLIENTE END AS TC_CARACTERISTICAS_CLIENTE 

,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE 						AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_04 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 20;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_05;
	
.IF ERRORCODE <> 0 THEN .QUIT 21;

--/*************************************************************************
--** ACTUALIZO CARACTERISTICAS_CLIENTE MIENTRAS PROPENSO SEA MAYOR A CERO **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_06;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_06
(
	 TC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,TE_PERIODO_CMP_F					INTEGER 		
    ,TD_CLI_RUT          				DECIMAL(8,0)
    ,TC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TE_PROPENSO						INTEGER
    ,TC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PROB							DECIMAL (25,10)
    ,TC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC    	
    ,TC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,TE_CONVENCIMIENTO   				INTEGER
    ,TC_ESTADO_FACTORING				VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_PRIORIDAD						INTEGER
    ,TC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,TE_CTACTE							INTEGER
	,TE_IS_FUGADO                       BIGINT
    ,TE_CONOFERTARIESGOS    			INTEGER
	,TC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC  
    ,TD_VECES_VTA_PROP					DECIMAL (1,0)
    ,TC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,TC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_VETADO_RIESGOS					INTEGER
    ,TE_MONTO_OFERTA					BIGINT
    ,TC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_CODACTECO_FUERA 			INTEGER
    ,TC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MARCA_RUTGOB    				INTEGER
    ,TE_ES_BCI          				INTEGER
    ,TE_CAPACITY_EJE    				INTEGER
    ,TE_CAPACITY_FFVV   				INTEGER
    ,TE_CUENTA          				INTEGER
    ,TE_FUERA_CAPACITY  				INTEGER
    ,TC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO					INTEGER
    ,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,TD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,TC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR 							INTEGER
    ,TE_COS_CLI             			INTEGER
    ,TE_FILTROS_RIESGOS     			INTEGER
    ,TC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,TE_PAR_FDR 						INTEGER
    ,TE_PAR_COS_CLI             		INTEGER
    ,TE_MOLESTO                 		INTEGER
    ,TE_CARGABLE                		INTEGER
    ,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS							INTEGER
    ,TE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 22;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_06
SELECT
 FAC.TC_TPO_BANCA						AS TC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS TE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS TD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS TC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS TC_NOM_CLI          			
,FAC.TE_PROPENSO						AS TE_PROPENSO					
,FAC.TC_TIPO 							AS TC_TIPO
,FAC.TD_PROB                            AS TD_PROB
,FAC.TC_TRAMO_FACT                      AS TC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS TC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS TE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS TC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS TE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS TC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS TC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS TC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS TE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS TE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS TE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS TC_ZONA_CLIENT    							
,FAC.TD_VECES_VTA_PROP					AS TD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS TC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS TC_EJE_FCT						
,FAC.TC_BANCO							AS TC_BANCO						
,FAC.TC_EJE_FFVV						AS TC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS TE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS TE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS TC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS TE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS TC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS TC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS TC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS TC_GLOSA 						
,FAC.TC_IVA 							AS TC_IVA 						
,FAC.TC_CATEGORIA 						AS TC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS TC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS TE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS TE_ES_BCI     
,FAC.TE_CAPACITY_EJE					AS TE_CAPACITY_EJE 
,FAC.TE_CAPACITY_FFVV    				AS TE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS TE_CUENTA      
,FAC.TE_FUERA_CAPACITY  				AS TE_FUERA_CAPACITY  
,FAC.TC_TEXTO1  						AS TC_TEXTO1 
,FAC.TC_TEXTO2							AS TC_TEXTO2 							

,CASE WHEN FAC.TE_PROPENSO >= 0 
	THEN  FAC.TC_CARACTERISTICAS_CLIENTE||
       CASE WHEN FAC.TC_TIPO_FINAL='NUEVOS' AND (COALESCE(FAC.TC_TRAMO_FACT,'')  IN ('1. ALTA - TEF/LBRT','1. ALTA') OR COALESCE(FAC.TC_ESTADO_FACTORING,'') IN ('2-PROSP. CLIENTE TEF_LBTR')) 
          THEN '' 
		  ELSE '' END
    ELSE FAC.TC_CARACTERISTICAS_CLIENTE 
 END                                    AS TC_CARACTERISTICAS_CLIENTE 

,FAC.TC_CAMPANA_OFERTA              	AS TC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS TE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS TC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS TC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS TF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS TD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS TC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS TE_FDR    	
,FAC.TE_COS_CLI		               		AS TE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS TE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS TC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS TD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS TE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS TE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS TE_MOLESTO
,FAC.TE_CARGABLE 						AS TE_CARGABLE                	
,FAC.TC_ELIMINADO						AS TC_ELIMINADO										
,FAC.TE_DUPLAS							AS TE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS TE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_05 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 23;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP_F,TD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_06;
	
.IF ERRORCODE <> 0 THEN .QUIT 24;

--/************************************************************************************
--** ACTUALIZO TEXTO1 MIENTRAS PROPENSO SEA MAYOR A CERO 						      **  
--** ACTUALIZO CARACTERISTICAS_CLIENTE MIENTRAS BANCA SEA PYME Y DUPLAS MAYOR A CERO 
--************************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_LIT;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_LIT
(
	 PC_TPO_BANCA						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC   
	,PE_PERIODO_CMP_F					INTEGER 		
    ,PD_CLI_RUT          				DECIMAL(8,0)
    ,PC_MACRO_BANCA      				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_NOM_CLI          				VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PE_PROPENSO						INTEGER
    ,PC_TIPO 							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PD_PROB							DECIMAL (25,10)
    ,PC_TRAMO_FACT 						VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC      	
    ,PC_MARCA_FACTORING  				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
    ,PE_CONVENCIMIENTO   				INTEGER
    ,PC_ESTADO_FACTORING				VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_PRIORIDAD						INTEGER
    ,PC_TIPO_FINAL 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PC_ESTADO_LEAD						VARCHAR(50)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_ANT						VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC    
    ,PE_CTACTE							INTEGER
	,PE_IS_FUGADO                       BIGINT
    ,PE_CONOFERTARIESGOS    			INTEGER
	,PC_ZONA_CLIENTE					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC  
    ,PD_VECES_VTA_PROP					DECIMAL (1,0)
    ,PC_TIPO_OFERTA_FINAL				VARCHAR(22) CHARACTER SET LATIN NOT CASESPECIFIC	
    ,PC_EJE_FCT							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_BANCO							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_EJE_FFVV						VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_VETADO_RIESGOS					INTEGER
    ,PE_MONTO_OFERTA					BIGINT
    ,PC_TIPO_OFERTA 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_MARCA_CODACTECO_FUERA 			INTEGER
    ,PC_COD_ACTECO  					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_ACT_ECO							VARCHAR(150) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_COD_ACTECO_BCI					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_GLOSA 							VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_IVA 							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CATEGORIA 						VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TIPO_ACT_ECO 					VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_MARCA_RUTGOB    				INTEGER
    ,PE_ES_BCI          				INTEGER
    ,PE_CAPACITY_EJE    				INTEGER
    ,PE_CAPACITY_FFVV   				INTEGER
    ,PE_CUENTA          				INTEGER
    ,PE_FUERA_CAPACITY  				INTEGER
    ,PC_TEXTO1 							CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TEXTO2                          CHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CARACTERISTICAS_CLIENTE         VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_OFERTA                  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_EN_PLANEAMIENTO					INTEGER
    ,PC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CALIFICACION_SBIF				VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PF_PERIODO_CALIFICACION    		DATE FORMAT 'YYYY-MM-DD' 	
    ,PD_PI_CLIENTE              		DECIMAL (25,10)  		
    ,PC_CLASIFICACION_SBIF      		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_FDR 							INTEGER
    ,PE_COS_CLI             			INTEGER
    ,PE_FILTROS_RIESGOS     			INTEGER
    ,PC_PAR_CALIFICACION_SBIF 			VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_PAR_PI_CLIENTE 					DECIMAL (25,10)
    ,PE_PAR_FDR 						INTEGER
    ,PE_PAR_COS_CLI             		INTEGER
    ,PE_MOLESTO                 		INTEGER
    ,PE_CARGABLE                		INTEGER
    ,PC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_DUPLAS							INTEGER
    ,PE_ENROLADO_DTM					INTEGER		
)UNIQUE PRIMARY INDEX (PE_PERIODO_CMP_F,PD_CLI_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 25;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_LIT
SELECT
 FAC.TC_TPO_BANCA						AS PC_TPO_BANCA			
,FAC.TE_PERIODO_CMP_F					AS PE_PERIODO_CMP_F 			
,FAC.TD_CLI_RUT          				AS PD_CLI_RUT          			     			
,FAC.TC_MACRO_BANCA      				AS PC_MACRO_BANCA      			
,FAC.TC_NOM_CLI          				AS PC_NOM_CLI          			
,FAC.TE_PROPENSO						AS PE_PROPENSO					
,FAC.TC_TIPO 							AS PC_TIPO
,FAC.TD_PROB                            AS PD_PROB
,FAC.TC_TRAMO_FACT                      AS PC_TRAMO_FACT	 									
,FAC.TC_MARCA_FACTORING  				AS PC_MARCA_FACTORING  			
,FAC.TE_CONVENCIMIENTO   				AS PE_CONVENCIMIENTO   				
,FAC.TC_ESTADO_FACTORING				AS PC_ESTADO_FACTORING			
,FAC.TE_PRIORIDAD						AS PE_PRIORIDAD					
,FAC.TC_TIPO_FINAL 						AS PC_TIPO_FINAL 					
,FAC.TC_ESTADO_LEAD						AS PC_ESTADO_LEAD	
,FAC.TC_CAMPANA_ANT		            	AS PC_CAMPANA_ANT				
,FAC.TE_CTACTE							AS PE_CTACTE      
,FAC.TE_IS_FUGADO                   	AS PE_IS_FUGADO        
,FAC.TE_CONOFERTARIESGOS    			AS PE_CONOFERTARIESGOS
,FAC.TC_ZONA_CLIENTE	                AS PC_ZONA_CLIENT    							
,FAC.TD_VECES_VTA_PROP					AS PD_VECES_VTA_PROP						
,FAC.TC_TIPO_OFERTA_FINAL				AS PC_TIPO_OFERTA_FINAL			      	
,FAC.TC_EJE_FCT							AS PC_EJE_FCT						
,FAC.TC_BANCO							AS PC_BANCO						
,FAC.TC_EJE_FFVV						AS PC_EJE_FFVV					
,FAC.TE_VETADO_RIESGOS					AS PE_VETADO_RIESGOS				
,FAC.TE_MONTO_OFERTA					AS PE_MONTO_OFERTA				
,FAC.TC_TIPO_OFERTA 					AS PC_TIPO_OFERTA 				
,FAC.TE_MARCA_CODACTECO_FUERA 			AS PE_MARCA_CODACTECO_FUERA 		
,FAC.TC_COD_ACTECO  					AS PC_COD_ACTECO  				
,FAC.TC_ACT_ECO							AS PC_ACT_ECO						
,FAC.TC_COD_ACTECO_BCI					AS PC_COD_ACTECO_BCI				
,FAC.TC_GLOSA 							AS PC_GLOSA 						
,FAC.TC_IVA 							AS PC_IVA 						
,FAC.TC_CATEGORIA 						AS PC_CATEGORIA 					
,FAC.TC_TIPO_ACT_ECO 					AS PC_TIPO_ACT_ECO 				
,FAC.TE_MARCA_RUTGOB    				AS PE_MARCA_RUTGOB    			
,FAC.TE_ES_BCI          				AS PE_ES_BCI     
,FAC.TE_CAPACITY_EJE					AS PE_CAPACITY_EJE 
,FAC.TE_CAPACITY_FFVV    				AS PE_CAPACITY_FFVV   			
,FAC.TE_CUENTA          				AS PE_CUENTA      
,FAC.TE_FUERA_CAPACITY  				AS PE_FUERA_CAPACITY  

,CASE WHEN FAC.TE_PROPENSO >= 0 
	THEN COALESCE(FAC.TC_TEXTO1,'')||', ENROLADO EN DATAMART ('||CASE WHEN FAC.TE_ENROLADO_DTM>0 THEN 'SI' ELSE 'NO' END||')'
	ELSE FAC.TC_TEXTO1  END 			AS PC_TEXTO1 

,FAC.TC_TEXTO2							AS PC_TEXTO2 							

,CASE WHEN FAC.TC_TPO_BANCA = 'PYME'
	  AND FAC.TE_DUPLAS > 0
	   THEN 'CLIENTE EN CAMPANA DUPLAS, COORDINAR VISITA EJECUTIVO COMERCIAL'
       ELSE FAC.TC_CARACTERISTICAS_CLIENTE 
 END                                    AS PC_CARACTERISTICAS_CLIENTE 

,FAC.TC_CAMPANA_OFERTA              	AS PC_CAMPANA_OFERTA   
,FAC.TE_EN_PLANEAMIENTO					AS PE_EN_PLANEAMIENTO			
,FAC.TC_RECOMENDACION_DE_CRUCE			AS PC_RECOMENDACION_DE_CRUCE	
,FAC.TC_CALIFICACION_SBIF				AS PC_CALIFICACION_SBIF         
,FAC.TF_PERIODO_CALIFICACION			AS PF_PERIODO_CALIFICACION    	
,FAC.TD_PI_CLIENTE						AS PD_PI_CLIENTE      		
,FAC.TC_CLASIFICACION_SBIF				AS PC_CLASIFICACION_SBIF    
,FAC.TE_FDR                   			AS PE_FDR    	
,FAC.TE_COS_CLI		               		AS PE_COS_CLI  				
,FAC.TE_FILTROS_RIESGOS     			AS PE_FILTROS_RIESGOS    
,FAC.TC_PAR_CALIFICACION_SBIF			AS PC_PAR_CALIFICACION_SBIF    	
,FAC.TD_PAR_PI_CLIENTE           		AS PD_PAR_PI_CLIENTE           	
,FAC.TE_PAR_FDR                  		AS PE_PAR_FDR       
,FAC.TE_PAR_COS_CLI           			AS PE_PAR_COS_CLI   
,FAC.TE_MOLESTO							AS PE_MOLESTO
,FAC.TE_CARGABLE 						AS PE_CARGABLE                	
,FAC.TC_ELIMINADO						AS PC_ELIMINADO										
,FAC.TE_DUPLAS							AS PE_DUPLAS						
,FAC.TE_ENROLADO_DTM					AS PE_ENROLADO_DTM		
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_LIT_06 FAC
;
.IF ERRORCODE <> 0 THEN .QUIT 26;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP_F,PD_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBFCT001OB_CAMPANA_FACTORING_WHOLESALE_MES_LIT;
	
.IF ERRORCODE <> 0 THEN .QUIT 27;

SELECT DATE, TIME; 

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 15 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: CAMBIA LOS FILTROS DE RIESGO PARA EL PO DE WHOLESALE LEASING				  **
--**                                                    				 				  **
--** AUTOR  : CESAR ROMERO MUNOZ                                          			  	  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 07/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN:                                                           				  **
--** AUTOR  :                                                           				  **
--** FECHA  : SSAAMMDD                                                  				  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP				  **
--**					MKT_JOURNEYBUILDER_TB.P_CMP_MAE_CALIF_SBIF                 	  **
--**					MKT_JOURNEYBUILDER_TB.P_CMP_MAE_FDR                        	  **
--**					{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES      	  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP                   	  **
--**					MKT_JOURNEYBUILDER_TB.P_CMP_MAE_NO_CONTACTAR               	  **
--**					MKT_JOURNEYBUILDER_TB.P_CMP_MAE_MAPEO                      	  **
--**																					  **                 
--**TABLA DE SALIDA:    {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES 		  **
--**                  					 	  											  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARAMETROS DE EJECUCION						  **  
--*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PARAMETRO;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PARAMETRO
(
	 TC_CALIFICACION		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CALIFICACIONM		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PI					DECIMAL(18,8)
	,TE_FDR					INTEGER
	,TE_COS					INTEGER
) PRIMARY INDEX (TC_CALIFICACION)
;
.IF ERRORCODE <> 0 THEN .QUIT 1;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PARAMETRO
SELECT 
	 SC_CALIFICACION	AS TC_CALIFICACION	
	,SC_CALIFICACIONM	AS TC_CALIFICACIONM	
	,SD_PI				AS TD_PI				
	,SE_FDR				AS TE_FDR				
	,SE_COS				AS TE_COS				
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP
WHERE
	SC_CAMPANA = 'LEASING_WHOLESALE'
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_CALIFICACION)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PARAMETRO;
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE WHOLESALE LEASING 							  **
--** {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES		      **  
--** CAMPOS PAR_CALIFICACION_SBIF, PAR_PI_CLIENTE, PAR_FDR Y PAR_COS_CLI  **
--*************************************************************************/
UPDATE 																				 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES  
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PARAMETRO AS PAR
SET 
	 PC_PAR_CALIFICACION_SBIF = 
		CASE WHEN PAR.TC_CALIFICACION IS NULL 
				THEN 'NULL' 
				ELSE PAR.TC_CALIFICACIONM
		END
	,PD_PAR_PI_CLIENTE = PAR.TD_PI
	,PE_PAR_FDR 		= PAR.TE_FDR
	,PE_PAR_COS_CLI 	= PAR.TE_COS
;
.IF ERRORCODE <> 0 THEN .QUIT 4;					

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES;
.IF ERRORCODE <> 0 THEN .QUIT 5;


--/*************************************************************************
--** SE CREA TABLA TEMPORAL CON PO CRUZADA CON CALIFICACIONES SBIF, SI LA **
--** CALIFICACION ES NULA, SE CAMBIA POR 0.								  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_CALIF;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_CALIF
(
	 TE_RUT				INTEGER
	,TC_CALIFICACION	VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TF_PERIODO			DATE FORMAT 'YYYY-MM-DD'
	,TC_CLASIFICACION	VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PI				DECIMAL(18,8)
) PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 6;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_CALIF
SELECT
	 CFP.PE_CLI_RUT							AS TE_RUT
	,COALESCE(CAL.PC_CALIFICACION_SBIF,'0')	AS TC_CALIFICACION
	,CAL.PF_PERIODO_CALIFICACION_SBIF		AS TF_PERIODO
	,CAL.PC_CLASIFICACION_SBIF				AS TC_CLASIFICACION
	,COALESCE(CAL.PD_PI_CLIENTE,0)			AS TD_PI
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES AS CFP
	LEFT JOIN MKT_JOURNEYBUILDER_TB.P_CMP_MAE_CALIF_SBIF AS CAL
		ON CFP.PE_CLI_RUT = CAL.PE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 7;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_CALIF;
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE WHOLESALE LEASING							  **
--** {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES			  **  
--** CAMPOS CALIFICACION_SBIF, PERIODO_CALIFICACION, CLASIFICACION_SBIF Y **
--** PI_CLIENTE															  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES  
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_CALIF AS CAL
SET 
	PC_CALIFICACION_SBIF 	= CAL.TC_CALIFICACION
  , PT_PERIODO_CALIFICACION = CAL.TF_PERIODO
  , PC_CLASIFICACION_SBIF 	= CAL.TC_CLASIFICACION
  , PD_PI_CLIENTE 			= CAL.TD_PI
WHERE
	PE_CLI_RUT = CAL.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE WHOLESALE LEASING 							  **
--** {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES, CAMPO FDR **  
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES  
FROM
	MKT_JOURNEYBUILDER_TB.P_CMP_MAE_FDR AS MFR
SET 
	PE_FDR = MFR.PE_FDR 
WHERE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES.PE_CLI_RUT = MFR.PE_CLI_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 10;								

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES;
.IF ERRORCODE <> 0 THEN .QUIT 11;


--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA CCEE_Y_RIP CRUZADA CON PO PARA SACAR	  **  
--** INDICADOR COS_CLI													  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_COS_CLI;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_COS_CLI
(
	 TE_RUT			INTEGER
	,TE_COS_CLI		INTEGER
) PRIMARY INDEX (TE_RUT, TE_COS_CLI)
;
.IF ERRORCODE <> 0 THEN .QUIT 12;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_COS_CLI
SELECT
	 CFP.PE_CLI_RUT	AS TE_RUT
	,CASE WHEN RIP.SE_CLIENTE_RUT IS NULL 
			THEN 0 
			ELSE 1 
	 END			AS TE_COS_CLI
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES  AS CFP
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP AS RIP
		ON CFP.PE_CLI_RUT = RIP.SE_CLIENTE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 13;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT, TE_COS_CLI)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_COS_CLI;
	
.IF ERRORCODE <> 0 THEN .QUIT 14;
	
--/*************************************************************************
--** SE ACTUALIZA TABLA DE WHOLESALE LEASING 							  **
--** {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES, CAMPO COS_CLI**  
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES  
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_COS_CLI AS FCC
SET 
	PE_COS_CLI = FCC.TE_COS_CLI
WHERE
	PE_CLI_RUT = FCC.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 15;									

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES;
.IF ERRORCODE <> 0 THEN .QUIT 16;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL CON RUT UNICOS DE PO, DONDE ELLOS CUMPLAN     **
--** LAS CONDICIONES DE LOS FILTROS DE RIESGO. SE UTILIZA FILTRO DE		  **  
--** **CALIFICACION_SBIF**												  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_RUT;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_RUT
(
	 TE_RUT			INTEGER
) PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 17;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_RUT
SELECT
	PE_CLI_RUT	AS TE_RUT
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES AS CFP
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PARAMETRO AS PAR
		ON POSITION(PC_CALIFICACION_SBIF IN PAR.TC_CALIFICACION) > 0
			AND PD_PI_CLIENTE  <= PAR.TD_PI
			AND PE_FDR >= PAR.TE_FDR
			AND PE_COS_CLI = PAR.TE_COS
;
.IF ERRORCODE <> 0 THEN .QUIT 18;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_RUT;
.IF ERRORCODE <> 0 THEN .QUIT 19;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE WHOLESALE LEASING 							  **
--** {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES			  **
--** CAMPO FILTROS_RIESGOS.												  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES  
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_RUT AS POR
SET 
	PE_FILTROS_RIESGOS = 1
WHERE
	PE_CLI_RUT = POR.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 20;							

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES;
.IF ERRORCODE <> 0 THEN .QUIT 21;


--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA CLIENTES PO NO_CONTACTAR, REGISTRANDO 	  **  
--** INDICADOR MOLESTO													  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_MOL;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_MOL
(
	 TE_RUT			INTEGER
	,TE_MOLESTO		INTEGER
) PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 22;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_MOL
SELECT
	 CFP.PE_CLI_RUT	AS TE_RUT
	,CASE WHEN MOL.PE_RUT IS NULL 
			THEN 0 
			ELSE 1 
	 END				AS TE_MOLESTO
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES  AS CFP
	LEFT JOIN MKT_JOURNEYBUILDER_TB.P_CMP_MAE_NO_CONTACTAR AS MOL
		ON CFP.PE_CLI_RUT = MOL.PE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 23;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_MOL;
.IF ERRORCODE <> 0 THEN .QUIT 24;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE WHOLESALE LEASING 							  **
--** {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES, CAMPO MOLESTO**  
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES  
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_MOL AS MOL
SET
	PE_MOLESTO = MOL.TE_MOLESTO
WHERE
	PE_CLI_RUT = MOL.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 25;
	

--/*************************************************************************
--** SE ACTUALIZA TABLA DE WHOLESALE LEASING 							  **
--** {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES			  **  
--** CAMPO EN_PLANEAMIENTO.												  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES  
FROM
	MKT_JOURNEYBUILDER_TB.P_CMP_MAE_MAPEO AS MMP
SET
	 PE_EN_PLANEAMIENTO = 1
	,PC_RECOMENDACION_DE_CRUCE = MMP.PC_RECOMENDACION_DE_CRUCE
WHERE
	PE_CLI_RUT = MMP.PE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 26;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_CLI_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES;
.IF ERRORCODE <> 0 THEN .QUIT 27;

SELECT DATE, TIME; 

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 15 OK.sql

--/*******************************************************************************************************
--********************************************************************************************************
--** DSCRPCN: CAMBIA LOS FILTROS DE RIESGO PARA EL PO DE WHOLESALE LEASING				  				**
--**                                                    				 				  				**
--** AUTOR  : CESAR ROMERO MUNOZ                                          			  	  				**
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  				**
--** FECHA  : 07/2022                                                   				  				**
--*******************************************************************************************************/
--/*******************************************************************************************************
--** MANTNCN: Normalización BTEQ														  				**
--** AUTOR  : MATIAS JORQUERA																			**
--** EMPRESA: FACTOR IT																  					**
--** FECHA  : 12/2024																					**
--/*******************************************************************************************************
--** TABLA DE ENTRADA:																					**
--**				   MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP											**
--**				   MKT_JOURNEYBUILDER_TB.I_CMP_MAE_NO_CONTACTAR										**
--**				   MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CALIF_SBIF										**
--**				   MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP									**
--**				   MKT_JOURNEYBUILDER_TB.I_CMP_MAE_FDR												**
--**				   MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO											**
--**				  {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_PO **
--** TABLA DE SALIDA: {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_FR **
--**                  					 	  											  				**
--*******************************************************************************************************/
--*******************************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARAMETROS DE EJECUCION						  **  
--*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PARAMETRO;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PARAMETRO
(
	 TC_CALIFICACION		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CALIFICACIONM		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PI					DECIMAL(18,8)
	,TE_FDR					INTEGER
	,TE_COS					INTEGER
) UNIQUE PRIMARY INDEX (TC_CALIFICACION)
;
.IF ERRORCODE <> 0 THEN .QUIT 1;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PARAMETRO
SELECT 
	 SC_CALIFICACION	AS TC_CALIFICACION	
	,SC_CALIFICACIONM	AS TC_CALIFICACIONM	
	,SD_PI				AS TD_PI				
	,SE_FDR				AS TE_FDR				
	,SE_COS				AS TE_COS				
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP
WHERE
	SC_CAMPANA = 'LEASING_WHOLESALE'
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_CALIFICACION)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PARAMETRO;
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL CON PO CRUZADA CON CALIFICACIONES SBIF, SI LA **
--** CALIFICACION ES NULA, SE CAMBIA POR 0.								  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_CALIF;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_CALIF
(
	 TD_RUT				DECIMAL(8,0)
	,TC_CALIFICACION	VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TF_PERIODO			DATE FORMAT 'YYYY-MM-DD'
	,TC_CLASIFICACION	VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PI				DECIMAL(18,8)
) UNIQUE PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 4;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_CALIF
SELECT
	 CFP.PD_CLI_RUT							AS TD_RUT
	,COALESCE(CAL.IC_CALIFICACION_SBIF,'0')	AS TC_CALIFICACION
	,CAL.IF_PERIODO_CALIFICACION_SBIF		AS TF_PERIODO
	,CAL.IC_CLASIFICACION_SBIF				AS TC_CLASIFICACION
	,COALESCE(CAL.ID_PI_CLIENTE,0)			AS TD_PI
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_PO AS CFP
LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CALIF_SBIF AS CAL
	ON CFP.PD_CLI_RUT = CAL.IE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 5;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_CALIF;
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA CCEE_Y_RIP CRUZADA CON PO PARA SACAR	  **  
--** INDICADOR COS_CLI													  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_COS_CLI;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_COS_CLI
(
	 TD_RUT			DECIMAL(8,0)
	,TE_COS_CLI		INTEGER
) UNIQUE PRIMARY INDEX (TD_RUT, TE_COS_CLI)
;
.IF ERRORCODE <> 0 THEN .QUIT 7;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_COS_CLI
SELECT
	 CFP.PD_CLI_RUT	AS TD_RUT
	,CASE WHEN RIP.SE_CLIENTE_RUT IS NULL 
			THEN 0 
			ELSE 1 
	 END			AS TE_COS_CLI
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_PO  AS CFP
LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP AS RIP
	ON CFP.PD_CLI_RUT = RIP.SE_CLIENTE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT, TE_COS_CLI)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_COS_CLI;
	
.IF ERRORCODE <> 0 THEN .QUIT 9;

/*************************************************************************
** SE ACTUALIZA TABLA DE WHOLESALE LEASING                              **
** CAMPOS ACTUALIZADOS:                                                 **
** - PAR_CALIFICACION_SBIF, PAR_PI_CLIENTE, PAR_FDR Y PAR_COS_CLI       **
** - CALIFICACION_SBIF, PERIODO_CALIFICACION, CLASIFICACION_SBIF Y      **
**   PI_CLIENTE, CAMPOS FDR Y COS_CLI                                   **
*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_01
(
     TD_CLI_RUT 						    DECIMAL(8,0)
    ,TC_NOM_CLI 						    VARCHAR (77)  CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_MACRO_BANCA 			            VARCHAR (16)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE 				  	            VARCHAR (12)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_IND_CTAS_CORRIENTES 	            INTEGER
    ,TE_COTIZA 						        INTEGER
    ,TD_PROB							    DECIMAL(25,10)
    ,TC_ESTADO_RECURRENCIA_LEASING	        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_OFERTA_REGLA					    DECIMAL(18,0)
    ,TD_MONTO_OFERTA     				    DECIMAL(18,0)
    ,TC_CAMPANA						        VARCHAR(50)	  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_POTENCIAL						    INTEGER
    ,TC_TIPO_BCA						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TRAMO_LEASING_MOB				    VARCHAR(255)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_LEASING					        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_NO_POTENCIAL					    INTEGER
    ,TE_PRIO                                INTEGER
    ,TE_ES_BCI                              INTEGER
    ,TE_MARCA_RUTGOB                        INTEGER
    ,TC_TEXTO1						        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2						        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE		        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA				        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO				        INTEGER
    ,TC_RECOMENDACION_DE_CRUCE 		        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TT_PERIODO_CALIFICACION			    TIMESTAMP(6) FORMAT 'YYYY-MM-DDBHH:MI:SS.S(6)'
    ,TD_PI_CLIENTE					        DECIMAL(25,10)
    ,TC_CLASIFICACION_SBIF			        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR							        INTEGER
    ,TE_COS_CLI						        INTEGER
    ,TE_FILTROS_RIESGOS 				    INTEGER
    ,TC_PAR_CALIFICACION_SBIF			    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE				        DECIMAL(25,10)
    ,TE_PAR_FDR						        INTEGER
    ,TE_PAR_COS_CLI					        INTEGER
    ,TE_MOLESTO						        BIGINT
    ,TE_CARGABLE 						    BIGINT
    ,TC_ELIMINADO						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS 						        BIGINT
    ,TE_PLAN_INVERSION 				        BIGINT
	,TE_NRO_OPT_PLAN_INVERSION  		    BIGINT
    ,TE_MTO_OPT_PLAN_INVERSION  		    BIGINT
    ,TC_PROD_1_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PROD_2_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MIN_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MAX_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CON_VENTAS 					        BIGINT
    ,TE_CON_VENTAS_ANT 				        BIGINT
    ,TE_LEASING_DATAMART 				    BIGINT
    ,TE_OPC_COMPRA 					        BIGINT
    ,TC_PER_OPC_COMPRA				        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ESTRATEGIA					        VARCHAR(9)    CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PERFIL			 			        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (TD_CLI_RUT)
;

.IF ERRORCODE <> 0 THEN .QUIT 10;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_01
SELECT
	 LEA.PD_CLI_RUT     						AS TD_CLI_RUT     		                  
	,LEA.PC_NOM_CLI                             AS TC_NOM_CLI                   
	,LEA.PC_MACRO_BANCA                         AS TC_MACRO_BANCA               
	,LEA.PC_EJE                                 AS TC_EJE                       
	,LEA.PE_IND_CTAS_CORRIENTES                 AS TE_IND_CTAS_CORRIENTES       
	,LEA.PE_COTIZA                              AS TE_COTIZA                    
	,LEA.PD_PROB                                AS TD_PROB                      
	,LEA.PC_ESTADO_RECURRENCIA_LEASING          AS TC_ESTADO_RECURRENCIA_LEASING
	,LEA.PD_OFERTA_REGLA                        AS TD_OFERTA_REGLA              
	,LEA.PD_MONTO_OFERTA                        AS TD_MONTO_OFERTA              
	,LEA.PC_CAMPANA                             AS TC_CAMPANA                   
	,LEA.PE_POTENCIAL                           AS TE_POTENCIAL                 
	,LEA.PC_TIPO_BCA                            AS TC_TIPO_BCA                  
	,LEA.PC_TRAMO_LEASING_MOB                   AS TC_TRAMO_LEASING_MOB         
	,LEA.PC_EJE_LEASING                         AS TC_EJE_LEASING               
	,LEA.PE_NO_POTENCIAL                        AS TE_NO_POTENCIAL              
	,LEA.PE_PRIO                                AS TE_PRIO                      
	,LEA.PE_ES_BCI                              AS TE_ES_BCI                    
	,LEA.PE_MARCA_RUTGOB                        AS TE_MARCA_RUTGOB              
	,LEA.PC_TEXTO1                              AS TC_TEXTO1                    
	,LEA.PC_TEXTO2                              AS TC_TEXTO2                    
	,LEA.PC_CARACTERISTICAS_CLIENTE             AS TC_CARACTERISTICAS_CLIENTE   
	,LEA.PC_CAMPANA_OFERTA                      AS TC_CAMPANA_OFERTA            
	,LEA.PE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO           
	,LEA.PC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE    
	,CASE WHEN CAL.TD_RUT IS NOT NULL 
		THEN CAL.TC_CALIFICACION
		ELSE LEA.PC_CALIFICACION_SBIF END 		AS TC_CALIFICACION_SBIF

	,CASE WHEN CAL.TD_RUT IS NOT NULL 
		THEN CAL.TF_PERIODO
		ELSE LEA.PT_PERIODO_CALIFICACION END 	AS TT_PERIODO_CALIFICACION
			
	,CASE WHEN CAL.TD_RUT IS NOT NULL 
		THEN CAL.TD_PI
		ELSE LEA.PD_PI_CLIENTE END 				AS TD_PI_CLIENTE
			
	,CASE WHEN CAL.TD_RUT IS NOT NULL 
		THEN CAL.TC_CLASIFICACION
		ELSE LEA.PC_CLASIFICACION_SBIF END 		AS TC_CLASIFICACION_SBIF

    ,CASE WHEN MFR.IE_CLI_RUT IS NOT NULL 
		THEN MFR.IE_FDR
    	ELSE LEA.PE_FDR END 					AS TE_FDR 

    ,CASE WHEN FCC.TD_RUT IS NOT NULL
		THEN FCC.TE_COS_CLI
    	ELSE LEA.PE_COS_CLI END 				AS TE_COS_CLI

	,LEA.PE_FILTROS_RIESGOS						AS TE_FILTROS_RIESGOS           
	,CASE WHEN PAR.TC_CALIFICACION IS NULL
			THEN 'NULL' 
    	ELSE PAR.TC_CALIFICACIONM
 	END							 				AS TC_PAR_CALIFICACION_SBIF
    ,PAR.TD_PI 									AS TD_PAR_PI_CLIENTE 		
    ,PAR.TE_FDR 								AS TE_PAR_FDR 		
    ,PAR.TE_COS 								AS TE_PAR_COS_CLI 	
	,LEA.PE_MOLESTO                             AS TE_MOLESTO                   
	,LEA.PE_CARGABLE                            AS TE_CARGABLE                  
	,LEA.PC_ELIMINADO                           AS TC_ELIMINADO                 
	,LEA.PE_DUPLAS                              AS TE_DUPLAS                    
	,LEA.PE_PLAN_INVERSION                      AS TE_PLAN_INVERSION
	,LEA.PE_NRO_OPT_PLAN_INVERSION				AS TE_NRO_OPT_PLAN_INVERSION            
	,LEA.PE_MTO_OPT_PLAN_INVERSION              AS TE_MTO_OPT_PLAN_INVERSION    
	,LEA.PC_PROD_1_PLAN_INVERSION               AS TC_PROD_1_PLAN_INVERSION     
	,LEA.PC_PROD_2_PLAN_INVERSION               AS TC_PROD_2_PLAN_INVERSION     
	,LEA.PC_PER_MIN_PLAN_INVERSION              AS TC_PER_MIN_PLAN_INVERSION    
	,LEA.PC_PER_MAX_PLAN_INVERSION              AS TC_PER_MAX_PLAN_INVERSION    
	,LEA.PE_CON_VENTAS                          AS TE_CON_VENTAS                
	,LEA.PE_CON_VENTAS_ANT                      AS TE_CON_VENTAS_ANT            
	,LEA.PE_LEASING_DATAMART                    AS TE_LEASING_DATAMART          
	,LEA.PE_OPC_COMPRA                          AS TE_OPC_COMPRA                
	,LEA.PC_PER_OPC_COMPRA                      AS TC_PER_OPC_COMPRA            
	,LEA.PC_ESTRATEGIA                          AS TC_ESTRATEGIA                
	,LEA.PC_PERFIL                              AS TC_PERFIL         
FROM 
    {{ var.value.BD_TEMP_JOURNEY }}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_PO AS LEA
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PARAMETRO AS PAR
    ON 1 = 1
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_CALIF AS CAL
    ON LEA.PD_CLI_RUT = CAL.TD_RUT
LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_FDR AS MFR
    ON LEA.PD_CLI_RUT = MFR.IE_CLI_RUT
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_COS_CLI AS FCC
    ON LEA.PD_CLI_RUT = FCC.TD_RUT
;

.IF ERRORCODE <> 0 THEN .QUIT 11;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_01;

.IF ERRORCODE <> 0 THEN .QUIT 12;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL CON RUT UNICOS DE PO, DONDE ELLOS CUMPLAN     **
--** LAS CONDICIONES DE LOS FILTROS DE RIESGO. SE UTILIZA FILTRO DE		  **  
--** **CALIFICACION_SBIF**												  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_RUT;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_RUT
(
	 TD_RUT			DECIMAL(8,0)
) UNIQUE PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 13;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_RUT
SELECT
	CFP.TD_CLI_RUT	AS TD_RUT
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_01 AS CFP
INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PARAMETRO AS PAR
	ON POSITION(CFP.TC_CALIFICACION_SBIF IN PAR.TC_CALIFICACION) > 0
		AND CFP.TD_PI_CLIENTE  <= PAR.TD_PI
		AND CFP.TE_FDR >= PAR.TE_FDR
		AND CFP.TE_COS_CLI = PAR.TE_COS
;
.IF ERRORCODE <> 0 THEN .QUIT 14;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_RUT;
.IF ERRORCODE <> 0 THEN .QUIT 15;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA CLIENTES PO NO_CONTACTAR, REGISTRANDO 	  **  
--** INDICADOR MOLESTO													  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_MOL;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_MOL
(
	 TD_RUT			DECIMAL(8,0)
	,TE_MOLESTO		INTEGER
) UNIQUE PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 16;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_MOL
SELECT
     CFP.PD_CLI_RUT 				AS TD_RUT
    ,CASE WHEN MOL.IE_RUT IS NULL 
            THEN 0 
            ELSE 1 
     END 							AS TE_MOLESTO
FROM
    {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_PO  AS CFP
LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_NO_CONTACTAR AS MOL
    ON CFP.PD_CLI_RUT = MOL.IE_RUT
QUALIFY ROW_NUMBER() OVER (PARTITION BY CFP.PD_CLI_RUT ORDER BY CFP.PD_CLI_RUT) = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 17;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_MOL;
.IF ERRORCODE <> 0 THEN .QUIT 18;

/*************************************************************************
** SE ACTUALIZAN CAMPOS EN LA TABLA DE WHOLESALE LEASING                **
** CAMPOS ACTUALIZADOS:                                                 **
** - FILTROS_RIESGOS                                                    **
** - MOLESTO                                                            **
** - EN_PLANEAMIENTO                                                    **
** - RECOMENDACION_DE_CRUCE                                             **
*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_FR;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_FR
(
     PD_CLI_RUT 						    DECIMAL(8,0)
    ,PC_NOM_CLI 						    VARCHAR (77)  CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_MACRO_BANCA 			            VARCHAR (16)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_EJE 				  	            VARCHAR (12)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_IND_CTAS_CORRIENTES 	            INTEGER
    ,PE_COTIZA 						        INTEGER
    ,PD_PROB							    DECIMAL(25,10)
    ,PC_ESTADO_RECURRENCIA_LEASING	        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_OFERTA_REGLA					    DECIMAL(18,0)
    ,PD_MONTO_OFERTA     				    DECIMAL(18,0)
    ,PC_CAMPANA						        VARCHAR(50)	  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_POTENCIAL						    INTEGER
    ,PC_TIPO_BCA						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TRAMO_LEASING_MOB				    VARCHAR(255)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_EJE_LEASING					        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_NO_POTENCIAL					    INTEGER
    ,PE_PRIO                                INTEGER
    ,PE_ES_BCI                              INTEGER
    ,PE_MARCA_RUTGOB                        INTEGER
    ,PC_TEXTO1						        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TEXTO2						        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CARACTERISTICAS_CLIENTE		        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_OFERTA				        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_EN_PLANEAMIENTO				        INTEGER
    ,PC_RECOMENDACION_DE_CRUCE 		        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CALIFICACION_SBIF				    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PT_PERIODO_CALIFICACION			    TIMESTAMP(6) FORMAT 'YYYY-MM-DDBHH:MI:SS.S(6)'
    ,PD_PI_CLIENTE					        DECIMAL(25,10)
    ,PC_CLASIFICACION_SBIF			        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_FDR							        INTEGER
    ,PE_COS_CLI						        INTEGER
    ,PE_FILTROS_RIESGOS 				    INTEGER
    ,PC_PAR_CALIFICACION_SBIF			    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_PAR_PI_CLIENTE				        DECIMAL(25,10)
    ,PE_PAR_FDR						        INTEGER
    ,PE_PAR_COS_CLI					        INTEGER
    ,PE_MOLESTO						        BIGINT
    ,PE_CARGABLE 						    BIGINT
    ,PC_ELIMINADO						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_DUPLAS 						        BIGINT
    ,PE_PLAN_INVERSION 				        BIGINT
	,PE_NRO_OPT_PLAN_INVERSION  		    BIGINT
    ,PE_MTO_OPT_PLAN_INVERSION  		    BIGINT
    ,PC_PROD_1_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_PROD_2_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_PER_MIN_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_PER_MAX_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_CON_VENTAS 					        BIGINT
    ,PE_CON_VENTAS_ANT 				        BIGINT
    ,PE_LEASING_DATAMART 				    BIGINT
    ,PE_OPC_COMPRA 					        BIGINT
    ,PC_PER_OPC_COMPRA				        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_ESTRATEGIA					        VARCHAR(9)    CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_PERFIL			 			        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (PD_CLI_RUT)
;

.IF ERRORCODE <> 0 THEN .QUIT 19;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_FR
SELECT
	 L01.TD_CLI_RUT								AS		PD_CLI_RUT
	,L01.TC_NOM_CLI                     		AS 		PC_NOM_CLI
	,L01.TC_MACRO_BANCA                 		AS 		PC_MACRO_BANCA
	,L01.TC_EJE                         		AS 		PC_EJE
	,L01.TE_IND_CTAS_CORRIENTES         		AS 		PE_IND_CTAS_CORRIENTES
	,L01.TE_COTIZA                      		AS 		PE_COTIZA
	,L01.TD_PROB                        		AS 		PD_PROB
	,L01.TC_ESTADO_RECURRENCIA_LEASING  		AS 		PC_ESTADO_RECURRENCIA_LEASING
	,L01.TD_OFERTA_REGLA                		AS 		PD_OFERTA_REGLA
	,L01.TD_MONTO_OFERTA                		AS 		PD_MONTO_OFERTA
	,L01.TC_CAMPANA                     		AS 		PC_CAMPANA
	,L01.TE_POTENCIAL                   		AS 		PE_POTENCIAL
	,L01.TC_TIPO_BCA                    		AS 		PC_TIPO_BCA
	,L01.TC_TRAMO_LEASING_MOB           		AS 		PC_TRAMO_LEASING_MOB
	,L01.TC_EJE_LEASING                 		AS 		PC_EJE_LEASING
	,L01.TE_NO_POTENCIAL                		AS 		PE_NO_POTENCIAL
	,L01.TE_PRIO                        		AS 		PE_PRIO
	,L01.TE_ES_BCI                      		AS 		PE_ES_BCI
	,L01.TE_MARCA_RUTGOB                		AS 		PE_MARCA_RUTGOB
	,L01.TC_TEXTO1                      		AS 		PC_TEXTO1
	,L01.TC_TEXTO2                      		AS 		PC_TEXTO2
	,L01.TC_CARACTERISTICAS_CLIENTE     		AS 		PC_CARACTERISTICAS_CLIENTE
	,L01.TC_CAMPANA_OFERTA              		AS 		PC_CAMPANA_OFERTA
    ,CASE WHEN MMP.IE_RUT IS NOT NULL
		THEN 1
		ELSE L01.TE_EN_PLANEAMIENTO	END 		AS 		PE_EN_PLANEAMIENTO 	

    ,CASE WHEN MMP.IE_RUT IS NOT NULL 
		THEN MMP.IC_RECOMENDACION_DE_CRUCE 
		ELSE L01.TC_RECOMENDACION_DE_CRUCE END 	AS 		PC_RECOMENDACION_DE_CRUCE 
	,L01.TC_CALIFICACION_SBIF           		AS 		PC_CALIFICACION_SBIF
	,L01.TT_PERIODO_CALIFICACION        		AS 		PT_PERIODO_CALIFICACION
	,L01.TD_PI_CLIENTE                  		AS 		PD_PI_CLIENTE
	,L01.TC_CLASIFICACION_SBIF          		AS 		PC_CLASIFICACION_SBIF
	,L01.TE_FDR                         		AS 		PE_FDR
	,L01.TE_COS_CLI                     		AS 		PE_COS_CLI
    ,CASE WHEN POR.TD_RUT IS NOT NULL
		THEN 1
		ELSE L01.TE_FILTROS_RIESGOS END			AS 		PE_FILTROS_RIESGOS 
	,L01.TC_PAR_CALIFICACION_SBIF       		AS 		PC_PAR_CALIFICACION_SBIF
	,L01.TD_PAR_PI_CLIENTE              		AS 		PD_PAR_PI_CLIENTE
	,L01.TE_PAR_FDR                     		AS 		PE_PAR_FDR
	,L01.TE_PAR_COS_CLI                 		AS 		PE_PAR_COS_CLI
    ,CASE WHEN MOL.TD_RUT IS NOT NULL 
		THEN MOL.TE_MOLESTO
		ELSE L01.TE_MOLESTO END    				AS 		PE_MOLESTO 		
	,L01.TE_CARGABLE                    		AS 		PE_CARGABLE
	,L01.TC_ELIMINADO                   		AS 		PC_ELIMINADO
	,L01.TE_DUPLAS                      		AS 		PE_DUPLAS
	,L01.TE_PLAN_INVERSION              		AS 		PE_PLAN_INVERSION
	,L01.TE_NRO_OPT_PLAN_INVERSION				AS		PE_NRO_OPT_PLAN_INVERSION
	,L01.TE_MTO_OPT_PLAN_INVERSION      		AS 		PE_MTO_OPT_PLAN_INVERSION
	,L01.TC_PROD_1_PLAN_INVERSION       		AS 		PC_PROD_1_PLAN_INVERSION
	,L01.TC_PROD_2_PLAN_INVERSION       		AS 		PC_PROD_2_PLAN_INVERSION
	,L01.TC_PER_MIN_PLAN_INVERSION      		AS 		PC_PER_MIN_PLAN_INVERSION
	,L01.TC_PER_MAX_PLAN_INVERSION      		AS 		PC_PER_MAX_PLAN_INVERSION
	,L01.TE_CON_VENTAS                  		AS 		PE_CON_VENTAS
	,L01.TE_CON_VENTAS_ANT              		AS 		PE_CON_VENTAS_ANT
	,L01.TE_LEASING_DATAMART            		AS 		PE_LEASING_DATAMART
	,L01.TE_OPC_COMPRA                  		AS 		PE_OPC_COMPRA
	,L01.TC_PER_OPC_COMPRA              		AS 		PC_PER_OPC_COMPRA
	,L01.TC_ESTRATEGIA                  		AS 		PC_ESTRATEGIA
	,L01.TC_PERFIL                      		AS 		PC_PERFIL
FROM 
    {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_01 AS L01
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_PO_RUT AS POR
    ON L01.TD_CLI_RUT = POR.TD_RUT
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_FDR_MOL AS MOL
    ON L01.TD_CLI_RUT = MOL.TD_RUT
LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO AS MMP
    ON L01.TD_CLI_RUT = MMP.IE_RUT
;

.IF ERRORCODE <> 0 THEN .QUIT 20;


--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PD_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_FR;
.IF ERRORCODE <> 0 THEN .QUIT 21;

SELECT DATE, TIME; 
.LOGOFF;
.QUIT 0;

UPDATE - Ejemplo 16 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: REGLAS DE NEGOCIO DE CAMPANIA Y FILTROS PRODUCTOS							  **
--**																			          **
--** AUTOR  : RODRIGO CASTILLO                                             				  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 05/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN:                                                           				  **
--** AUTOR  :                                                           				  **
--** FECHA  : SSAAMMDD                                                  				  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_COTIZACIONES_LEA			  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_OFERTA_REGLA_NEGOCIO   		  **
--**					{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_OFERTA_REGLA_NEGOCIO           		  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_DOTACION_FACT_LEA      		  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_NO_POTENCIAL_LYF			  **                         
--**                  	                                                                  **
--** TABLA DE SALIDA: 	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_OFERTA_REGLA_NEGOCIO      			  **
--**					{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES		  **
--**                                      	                                              **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA COTIZACIONES_LEA PARA SACAR	  		  **  
--** EL RUT DEL CLIENTE													  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_COTIZACIONES_LEA;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_COTIZACIONES_LEA
(
    TE_RUT_CLIENTE 						INTEGER
) PRIMARY INDEX ( TE_RUT_CLIENTE )
;
.IF ERRORCODE <> 0 THEN .QUIT 1;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_COTIZACIONES_LEA
SELECT
	SE_RUT_CLIENTE             AS TE_RUT_CLIENTE 				
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_COTIZACIONES_LEA
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TE_RUT_CLIENTE )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_COTIZACIONES_LEA;
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_LEASING_WHOLESALE_MES					  **  
--** CAMPO COTIZA, FILTRANDO POR TIPO_BCA = 'WSB'						  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_COTIZACIONES_LEA AS LEA
SET 
	PE_COTIZA = 1
WHERE
	PE_CLI_RUT = LEA.TE_RUT_CLIENTE
	AND PC_TIPO_BCA = 'WSB'
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES;
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA OFERTA_REGLA_NEGOCIO PARA SACAR	  	  **  
--** EL RUT Y EL MONTO DE LA OFERTA										  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_OFERTA_REGLA_NEGOCIO;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_OFERTA_REGLA_NEGOCIO
(
	 PE_RUT					INTEGER
	,PD_MONTO_OFERTA		DECIMAL (25,10))
PRIMARY INDEX ( PE_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 6;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_OFERTA_REGLA_NEGOCIO
SELECT
	 SE_RUT				AS PE_RUT			
	,SD_MONTO_OFERTA	AS PD_MONTO_OFERTA
	
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_OFERTA_REGLA_NEGOCIO
;
.IF ERRORCODE <> 0 THEN .QUIT 7;

--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_OFERTA_REGLA_NEGOCIO;
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE P_CAMPANA_LEASING_WHOLESALE_MES				  **  
--** CAMPO OFERTA_REGLA Y MONTO_OFERTA, FILTRANDO POR TIPO_BCA = 'WSB'	  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_OFERTA_REGLA_NEGOCIO AS RNEG
SET 
	 PD_OFERTA_REGLA = RNEG.PD_MONTO_OFERTA
	,PD_MONTO_OFERTA = RNEG.PD_MONTO_OFERTA
WHERE
	PE_CLI_RUT = RNEG.PE_RUT
	AND PC_TIPO_BCA = 'WSB'
;
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_LEASING_WHOLESALE_MES					  **  
--** CAMPO CAMPANA, FILTRANDO POR TIPO_BCA = 'WSB'						  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
SET 
	PC_CAMPANA = CASE WHEN PC_ESTADO_RECURRENCIA_LEASING = 'RECURRENTE' 
					THEN  '1 RECURRENTE' 
					ELSE '2 NUEVO' 
			  END
WHERE 
	PC_TIPO_BCA = 'WSB'
;
.IF ERRORCODE <> 0 THEN .QUIT 10;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES;
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/*******************************************************************
--** TABLA TEMPORAL DE EJECUTIVO ESPECIALISTA LEASING	    		**
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_DOTACION;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_DOTACION
(
	 TC_BANCO				VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_BANCO			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_LEA 			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TIPO_BCA			VARCHAR(4) CHARACTER SET LATIN NOT CASESPECIFIC
) PRIMARY INDEX ( TC_BANCO )
;
.IF ERRORCODE <> 0 THEN .QUIT 12;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_DOTACION
SELECT 
	 SC_BANCO		AS TC_BANCO		
	,SC_EJE_BANCO   AS TC_EJE_BANCO	
	,SC_EJE_LEA     AS TC_EJE_LEA 	
	,CASE WHEN SC_BANCO IN ('RETAIL') 
			THEN 'PYME' 
			ELSE 'WSB' 
	 END			AS TC_TIPO_BCA
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_DOTACION_FACT_LEA
GROUP BY 
	 SC_BANCO
	,SC_EJE_BANCO
	,SC_EJE_LEA
;
.IF ERRORCODE <> 0 THEN .QUIT 13;

--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TC_BANCO )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_DOTACION;
.IF ERRORCODE <> 0 THEN .QUIT 14;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_LEASING_WHOLESALE_MES					  **  
--** CAMPO EJE_LEASING, FILTRANDO EJE = EJE_BANCO Y						  **
--** TIPO_BCA = TIPO_BCA												  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_DOTACION AS DTN
SET 
	PC_EJE_LEASING = DTN.TC_EJE_LEA
WHERE
	PC_EJE = DTN.TC_EJE_BANCO
	AND PC_TIPO_BCA = DTN.TC_TIPO_BCA
;
.IF ERRORCODE <> 0 THEN .QUIT 15;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES;
.IF ERRORCODE <> 0 THEN .QUIT 16;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA NO_POTENCIAL_LYF_01, AGRUPADO POR RUT	  **
--** Y FILTRANDO POR PRODUCTO = 'LEASING'								  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_NO_POTENCIAL_LYF_01;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_NO_POTENCIAL_LYF_01
(
	TE_RUT			INTEGER)
PRIMARY INDEX ( TE_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 17;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_NO_POTENCIAL_LYF_01
SELECT 
	 SE_RUT AS TE_RUT
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_NO_POTENCIAL_LYF 
WHERE 
	SC_PRODUCTO = 'LEASING'
;
.IF ERRORCODE <> 0 THEN .QUIT 18;

--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_NO_POTENCIAL_LYF_01;
.IF ERRORCODE <> 0 THEN .QUIT 19;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_LEASING_WHOLESALE_MES					  **  
--** CAMPO NO_POTENCIAL												 	  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_NO_POTENCIAL_LYF_01 AS LYF01
SET 
	PE_NO_POTENCIAL = 1
WHERE
	PE_CLI_RUT = LYF01.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 20;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_LEASING_WHOLESALE_MES	 			  	  ** 
--** CREAR PRIORIZACION WHOLESALE, CAMPO PRIO							  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
SET 
	PE_PRIO = 0
;
.IF ERRORCODE <> 0 THEN .QUIT 21;

UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
SET 
	PE_PRIO = 
		CASE 
			WHEN PE_PLAN_INVERSION = 1 
				THEN 1 	     	    
			WHEN PE_OPC_COMPRA = 1 
				THEN 2 	    
			WHEN PE_LEASING_DATAMART = 1 
				THEN 3
			WHEN PE_COTIZA > 0 
				THEN 4
			WHEN COALESCE(PC_TRAMO_LEASING_MOB,'') = 'MIXTO' 
				THEN 5
			WHEN COALESCE(PC_TRAMO_LEASING_MOB,'') = 'BCI' 
				THEN 6
			WHEN COALESCE(PC_TRAMO_LEASING_MOB,'') = 'OTROS_BANCOS' 
				THEN 7
			WHEN COALESCE(PC_TRAMO_LEASING_MOB,'') = 'NUEVO' 
				THEN 8
			WHEN COALESCE(PC_TRAMO_LEASING_MOB,'') in  ('5 - NO LEASING','') 
				THEN  88
			ELSE 99
		END
WHERE 
	PC_TIPO_BCA = 'WSB'
;
.IF ERRORCODE <> 0 THEN .QUIT 22;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_LEASING_WHOLESALE_MES		  			  **  
--** CAMPO ES_BCI, FILTRANDO POR NOM_CLI = 'BCI'						  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
SET 
	PE_ES_BCI = 1
WHERE
	POSITION ('BCI' IN PC_NOM_CLI) > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 23;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_LEASING_WHOLESALE_MES		  			  **  
--** CAMPO MARCA_RUTGOB, FILTRADO POR CLI_RUT MAYOR IGUAL 60000000		  **
--** Y MENOR 70000000													  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
SET 
	PE_MARCA_RUTGOB = 1
WHERE 
	PE_CLI_RUT >= 60000000 
	AND PE_CLI_RUT < 70000000
;
.IF ERRORCODE <> 0 THEN .QUIT 24;

--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES;
.IF ERRORCODE <> 0 THEN .QUIT 25;


--/*************************************************************************
--** SE ACTUALIZA TABLA DE PYME LEASING P_CAMPANA_LEASING_WHOLESALE_MES	  **  
--** PRIORIZA a CLIENTES CON MARGEN INYECTADO Y/0 CON OPCION DE COMPRA	  **
--*************************************************************************/

UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
SET PD_PROB = 1000000
WHERE PE_OPC_COMPRA > 0
;
--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES;
.IF ERRORCODE <> 0 THEN .QUIT 26;


SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;



UPDATE - Ejemplo 16 OK.sql

--/***********************************************************************************************************
--************************************************************************************************************
--** DSCRPCN: REGLAS DE NEGOCIO DE CAMPANIA Y FILTROS PRODUCTOS							  					**
--**																			          					**
--** AUTOR  : RODRIGO CASTILLO                                             				  					**
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  					**
--** FECHA  : 05/2022                                                   				  					**
--***********************************************************************************************************/
--/***********************************************************************************************************
--** MANTNCN: Normalización BTEQ														  					**
--** AUTOR  : MATIAS JORQUERA																				**
--** EMPRESA: FACTOR IT																  						**
--** FECHA  : 12/2024																						**
--/***********************************************************************************************************
--**TABLA DE ENTRADA:	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_OFERTA_REGLA_NEGOCIO			  	  				**
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_NO_POTENCIAL_LYF   		  	  						**
--**					{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_FR   **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_DOTACION_FACT_LEA      		  	  					**
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_COTIZACIONES_LEA			  	  					**
--**                  	                                                                  					**
--** TABLA DE SALIDA: 	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_RN   **
--**                                      	                                              					**
--************************************************************************************************************
--************************************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA COTIZACIONES_LEA PARA SACAR	  		  **  
--** EL RUT DEL CLIENTE													  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_COTIZACIONES_LEA;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_COTIZACIONES_LEA
(
    TD_RUT_CLIENTE 						DECIMAL(8,0)
) UNIQUE PRIMARY INDEX ( TD_RUT_CLIENTE )
;
.IF ERRORCODE <> 0 THEN .QUIT 1;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_COTIZACIONES_LEA
SELECT
    SE_RUT_CLIENTE AS TD_RUT_CLIENTE 				
FROM 
    MKT_JOURNEYBUILDER_TB.S_CMP_EXT_COTIZACIONES_LEA
QUALIFY ROW_NUMBER() OVER (PARTITION BY SE_RUT_CLIENTE ORDER BY SE_RUT_CLIENTE) = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_RUT_CLIENTE )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_COTIZACIONES_LEA;
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA OFERTA_REGLA_NEGOCIO PARA SACAR	  	  **  
--** EL RUT Y EL MONTO DE LA OFERTA										  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_OFERTA_REGLA_NEGOCIO;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_OFERTA_REGLA_NEGOCIO
(
	 TD_RUT					DECIMAL(8,0)
	,TD_MONTO_OFERTA		DECIMAL (25,10))
UNIQUE PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_OFERTA_REGLA_NEGOCIO
SELECT
	 SE_RUT				AS TD_RUT			
	,SD_MONTO_OFERTA	AS TD_MONTO_OFERTA
	
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_OFERTA_REGLA_NEGOCIO
;
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_OFERTA_REGLA_NEGOCIO;
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/*******************************************************************
--** TABLA TEMPORAL DE EJECUTIVO ESPECIALISTA LEASING	    		**
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_DOTACION;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_DOTACION
(
	 TC_BANCO				VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_BANCO			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_LEA 			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TIPO_BCA			VARCHAR(4) CHARACTER SET LATIN NOT CASESPECIFIC
) PRIMARY INDEX ( TC_BANCO )
;
.IF ERRORCODE <> 0 THEN .QUIT 7;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_DOTACION
SELECT 
     SC_BANCO       AS TC_BANCO     
    ,SC_EJE_BANCO   AS TC_EJE_BANCO 
    ,SC_EJE_LEA     AS TC_EJE_LEA   
    ,CASE WHEN SC_BANCO IN ('RETAIL') 
            THEN 'PYME' 
            ELSE 'WSB' 
     END            AS TC_TIPO_BCA
FROM 
    MKT_JOURNEYBUILDER_TB.S_CMP_EXT_DOTACION_FACT_LEA
GROUP BY 
	 SC_BANCO
	,SC_EJE_BANCO
	,SC_EJE_LEA
;
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TC_BANCO )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_DOTACION;
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA NO_POTENCIAL_LYF_01, AGRUPADO POR RUT	  **
--** Y FILTRANDO POR PRODUCTO = 'LEASING'								  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_NO_POTENCIAL_LYF_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_NO_POTENCIAL_LYF_01
(
	TD_RUT			DECIMAL(8,0)
	
) UNIQUE PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 10;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_NO_POTENCIAL_LYF_01
SELECT 
	 SE_RUT AS TD_RUT
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_NO_POTENCIAL_LYF 
WHERE 
	SC_PRODUCTO = 'LEASING'
;
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_NO_POTENCIAL_LYF_01;
.IF ERRORCODE <> 0 THEN .QUIT 12;

/*************************************************************************
** SE ACTUALIZAN CAMPOS EN LA TABLA P_CAMPANA_LEASING_WHOLESALE_MES     **
** CAMPOS ACTUALIZADOS:                                                 **
** - COTIZA (FILTRANDO POR TIPO_BCA = 'WSB')                            **
** - OFERTA_REGLA Y MONTO_OFERTA (FILTRANDO POR TIPO_BCA = 'WSB')       **
** - CAMPANA (FILTRANDO POR TIPO_BCA = 'WSB')                           **
** - EJE_LEASING (FILTRANDO POR EJE = EJE_BANCO Y TIPO_BCA = TIPO_BCA)  **
** - NO_POTENCIAL                                                       **
*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_RN_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_RN_01
(
     TD_CLI_RUT 						    DECIMAL(8,0)
    ,TC_NOM_CLI 						    VARCHAR (77)  CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_MACRO_BANCA 			            VARCHAR (16)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE 				  	            VARCHAR (12)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_IND_CTAS_CORRIENTES 	            INTEGER
    ,TE_COTIZA 						        INTEGER
    ,TD_PROB							    DECIMAL(25,10)
    ,TC_ESTADO_RECURRENCIA_LEASING	        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_OFERTA_REGLA					    DECIMAL(18,0)
    ,TD_MONTO_OFERTA     				    DECIMAL(18,0)
    ,TC_CAMPANA						        VARCHAR(50)	  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_POTENCIAL						    INTEGER
    ,TC_TIPO_BCA						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TRAMO_LEASING_MOB				    VARCHAR(255)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_LEASING					        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_NO_POTENCIAL					    INTEGER
    ,TE_PRIO                                INTEGER
    ,TE_ES_BCI                              INTEGER
    ,TE_MARCA_RUTGOB                        INTEGER
    ,TC_TEXTO1						        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2						        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE		        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA				        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO				        INTEGER
    ,TC_RECOMENDACION_DE_CRUCE 		        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TT_PERIODO_CALIFICACION			    TIMESTAMP(6) FORMAT 'YYYY-MM-DDBHH:MI:SS.S(6)'
    ,TD_PI_CLIENTE					        DECIMAL(25,10)
    ,TC_CLASIFICACION_SBIF			        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR							        INTEGER
    ,TE_COS_CLI						        INTEGER
    ,TE_FILTROS_RIESGOS 				    INTEGER
    ,TC_PAR_CALIFICACION_SBIF			    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE				        DECIMAL(25,10)
    ,TE_PAR_FDR						        INTEGER
    ,TE_PAR_COS_CLI					        INTEGER
    ,TE_MOLESTO						        BIGINT
    ,TE_CARGABLE 						    BIGINT
    ,TC_ELIMINADO						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS 						        BIGINT
    ,TE_PLAN_INVERSION 				        BIGINT
	,TE_NRO_OPT_PLAN_INVERSION				BIGINT
    ,TE_MTO_OPT_PLAN_INVERSION  		    BIGINT
    ,TC_PROD_1_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PROD_2_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MIN_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MAX_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CON_VENTAS 					        BIGINT
    ,TE_CON_VENTAS_ANT 				        BIGINT
    ,TE_LEASING_DATAMART 				    BIGINT
    ,TE_OPC_COMPRA 					        BIGINT
    ,TC_PER_OPC_COMPRA				        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ESTRATEGIA					        VARCHAR(9)    CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PERFIL			 			        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (TD_CLI_RUT)
;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_RN_01
SELECT
	 LRN.PD_CLI_RUT     						AS TD_CLI_RUT     		                  
	,LRN.PC_NOM_CLI                             AS TC_NOM_CLI                   
	,LRN.PC_MACRO_BANCA                         AS TC_MACRO_BANCA               
	,LRN.PC_EJE                                 AS TC_EJE                       
	,LRN.PE_IND_CTAS_CORRIENTES                 AS TE_IND_CTAS_CORRIENTES       
    ,CASE 
        WHEN LRN.PC_TIPO_BCA = 'WSB' AND COT.TD_RUT_CLIENTE IS NOT NULL
		THEN 1
        ELSE LRN.PE_COTIZA
     END                                        AS TE_COTIZA
	,LRN.PD_PROB                                AS TD_PROB                      
	,LRN.PC_ESTADO_RECURRENCIA_LEASING          AS TC_ESTADO_RECURRENCIA_LEASING
	,CASE 
    	WHEN LRN.PC_TIPO_BCA = 'WSB' AND RNEG.TD_RUT IS NOT NULL
		THEN RNEG.TD_MONTO_OFERTA
    	ELSE LRN.PD_OFERTA_REGLA
	END 										AS TD_OFERTA_REGLA
	,CASE 
    	WHEN LRN.PC_TIPO_BCA = 'WSB' AND RNEG.TD_RUT IS NOT NULL 
		THEN RNEG.TD_MONTO_OFERTA
    	ELSE LRN.PD_MONTO_OFERTA
 	END 										AS TD_MONTO_OFERTA              
	,CASE 
    	WHEN LRN.PC_TIPO_BCA = 'WSB' 
		THEN
        	CASE 
            	WHEN LRN.PC_ESTADO_RECURRENCIA_LEASING = 'RECURRENTE' 
				THEN '1 RECURRENTE'
            	ELSE '2 NUEVO'
        	END
    	ELSE LRN.PC_CAMPANA
 	END 										AS TC_CAMPANA                   
	,LRN.PE_POTENCIAL                           AS TE_POTENCIAL                 
	,LRN.PC_TIPO_BCA                            AS TC_TIPO_BCA                  
	,LRN.PC_TRAMO_LEASING_MOB                   AS TC_TRAMO_LEASING_MOB         
	,CASE 
    	WHEN DTN.TC_EJE_LEA IS NOT NULL
			THEN DTN.TC_EJE_LEA
    		ELSE LRN.PC_EJE_LEASING
 	END 										AS TC_EJE_LEASING               
	,CASE 
    	WHEN LYF01.TD_RUT IS NOT NULL 
		THEN 1
    	ELSE LRN.PE_NO_POTENCIAL
 	END 										AS TE_NO_POTENCIAL              
	,LRN.PE_PRIO                                AS TE_PRIO                      
	,LRN.PE_ES_BCI                              AS TE_ES_BCI                    
	,LRN.PE_MARCA_RUTGOB                        AS TE_MARCA_RUTGOB              
	,LRN.PC_TEXTO1                              AS TC_TEXTO1                    
	,LRN.PC_TEXTO2                              AS TC_TEXTO2                    
	,LRN.PC_CARACTERISTICAS_CLIENTE             AS TC_CARACTERISTICAS_CLIENTE   
	,LRN.PC_CAMPANA_OFERTA                      AS TC_CAMPANA_OFERTA            
	,LRN.PE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO           
	,LRN.PC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE    
	,LRN.PC_CALIFICACION_SBIF                   AS TC_CALIFICACION_SBIF         
	,LRN.PT_PERIODO_CALIFICACION                AS TT_PERIODO_CALIFICACION      
	,LRN.PD_PI_CLIENTE                          AS TD_PI_CLIENTE                
	,LRN.PC_CLASIFICACION_SBIF                  AS TC_CLASIFICACION_SBIF        
	,LRN.PE_FDR                                 AS TE_FDR                       
	,LRN.PE_COS_CLI                             AS TE_COS_CLI                   
	,LRN.PE_FILTROS_RIESGOS                     AS TE_FILTROS_RIESGOS           
	,LRN.PC_PAR_CALIFICACION_SBIF               AS TC_PAR_CALIFICACION_SBIF     
	,LRN.PD_PAR_PI_CLIENTE                      AS TD_PAR_PI_CLIENTE            
	,LRN.PE_PAR_FDR                             AS TE_PAR_FDR                   
	,LRN.PE_PAR_COS_CLI                         AS TE_PAR_COS_CLI               
	,LRN.PE_MOLESTO                             AS TE_MOLESTO                   
	,LRN.PE_CARGABLE                            AS TE_CARGABLE                  
	,LRN.PC_ELIMINADO                           AS TC_ELIMINADO                 
	,LRN.PE_DUPLAS                              AS TE_DUPLAS                    
	,LRN.PE_PLAN_INVERSION                      AS TE_PLAN_INVERSION
	,LRN.PE_NRO_OPT_PLAN_INVERSION            	AS TE_NRO_OPT_PLAN_INVERSION
	,LRN.PE_MTO_OPT_PLAN_INVERSION              AS TE_MTO_OPT_PLAN_INVERSION    
	,LRN.PC_PROD_1_PLAN_INVERSION               AS TC_PROD_1_PLAN_INVERSION     
	,LRN.PC_PROD_2_PLAN_INVERSION               AS TC_PROD_2_PLAN_INVERSION     
	,LRN.PC_PER_MIN_PLAN_INVERSION              AS TC_PER_MIN_PLAN_INVERSION    
	,LRN.PC_PER_MAX_PLAN_INVERSION              AS TC_PER_MAX_PLAN_INVERSION    
	,LRN.PE_CON_VENTAS                          AS TE_CON_VENTAS                
	,LRN.PE_CON_VENTAS_ANT                      AS TE_CON_VENTAS_ANT            
	,LRN.PE_LEASING_DATAMART                    AS TE_LEASING_DATAMART          
	,LRN.PE_OPC_COMPRA                          AS TE_OPC_COMPRA                
	,LRN.PC_PER_OPC_COMPRA                      AS TC_PER_OPC_COMPRA            
	,LRN.PC_ESTRATEGIA                          AS TC_ESTRATEGIA                
	,LRN.PC_PERFIL                              AS TC_PERFIL
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_FR AS LRN
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_COTIZACIONES_LEA AS COT
		ON 	LRN.PD_CLI_RUT = COT.TD_RUT_CLIENTE
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_OFERTA_REGLA_NEGOCIO AS RNEG
		ON LRN.PD_CLI_RUT = RNEG.TD_RUT
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_DOTACION AS DTN
		ON LRN.PC_EJE = DTN.TC_EJE_BANCO
		AND LRN.PC_TIPO_BCA = DTN.TC_TIPO_BCA
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_NO_POTENCIAL_LYF_01 AS LYF01
		ON LRN.PD_CLI_RUT = LYF01.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 13;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_RN_01;
.IF ERRORCODE <> 0 THEN .QUIT 14;

/*************************************************************************
** SE ACTUALIZAN CAMPOS EN LA TABLA P_CAMPANA_LEASING_WHOLESALE_MES     **
** CAMPOS ACTUALIZADOS:                                                 **
** - PRIO (CREAR PRIORIZACIÓN WHOLESALE)                                **
** - ES_BCI (FILTRANDO POR NOM_CLI = 'BCI')                             **
** - MARCA_RUTGOB (FILTRANDO POR CLI_RUT >= 60000000 Y < 70000000)      **
** - PRIORIZACIÓN DE CLIENTES CON MARGEN INYECTADO Y/O OPCIÓN DE COMPRA **
*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_RN;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_RN
(
     PD_CLI_RUT 						    DECIMAL(8,0)
    ,PC_NOM_CLI 						    VARCHAR (77)  CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_MACRO_BANCA 			            VARCHAR (16)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_EJE 				  	            VARCHAR (12)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_IND_CTAS_CORRIENTES 	            INTEGER
    ,PE_COTIZA 						        INTEGER
    ,PD_PROB							    DECIMAL(25,10)
    ,PC_ESTADO_RECURRENCIA_LEASING	        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_OFERTA_REGLA					    DECIMAL(18,0)
    ,PD_MONTO_OFERTA     				    DECIMAL(18,0)
    ,PC_CAMPANA						        VARCHAR(50)	  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_POTENCIAL						    INTEGER
    ,PC_TIPO_BCA						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TRAMO_LEASING_MOB				    VARCHAR(255)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_EJE_LEASING					        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_NO_POTENCIAL					    INTEGER
    ,PE_PRIO                                INTEGER
    ,PE_ES_BCI                              INTEGER
    ,PE_MARCA_RUTGOB                        INTEGER
    ,PC_TEXTO1						        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TEXTO2						        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CARACTERISTICAS_CLIENTE		        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_OFERTA				        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_EN_PLANEAMIENTO				        INTEGER
    ,PC_RECOMENDACION_DE_CRUCE 		        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CALIFICACION_SBIF				    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PT_PERIODO_CALIFICACION			    TIMESTAMP(6) FORMAT 'YYYY-MM-DDBHH:MI:SS.S(6)'
    ,PD_PI_CLIENTE					        DECIMAL(25,10)
    ,PC_CLASIFICACION_SBIF			        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_FDR							        INTEGER
    ,PE_COS_CLI						        INTEGER
    ,PE_FILTROS_RIESGOS 				    INTEGER
    ,PC_PAR_CALIFICACION_SBIF			    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_PAR_PI_CLIENTE				        DECIMAL(25,10)
    ,PE_PAR_FDR						        INTEGER
    ,PE_PAR_COS_CLI					        INTEGER
    ,PE_MOLESTO						        BIGINT
    ,PE_CARGABLE 						    BIGINT
    ,PC_ELIMINADO						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_DUPLAS 						        BIGINT
    ,PE_PLAN_INVERSION 				        BIGINT
	,PE_NRO_OPT_PLAN_INVERSION  		    BIGINT
    ,PE_MTO_OPT_PLAN_INVERSION  		    BIGINT
    ,PC_PROD_1_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_PROD_2_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_PER_MIN_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_PER_MAX_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_CON_VENTAS 					        BIGINT
    ,PE_CON_VENTAS_ANT 				        BIGINT
    ,PE_LEASING_DATAMART 				    BIGINT
    ,PE_OPC_COMPRA 					        BIGINT
    ,PC_PER_OPC_COMPRA				        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_ESTRATEGIA					        VARCHAR(9)    CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_PERFIL			 			        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (PD_CLI_RUT)
;

.IF ERRORCODE <> 0 THEN .QUIT 15;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_RN
SELECT
	 L02.TD_CLI_RUT     						AS PD_CLI_RUT     		                  
	,L02.TC_NOM_CLI                             AS PC_NOM_CLI                   
	,L02.TC_MACRO_BANCA                         AS PC_MACRO_BANCA               
	,L02.TC_EJE                                 AS PC_EJE                       
	,L02.TE_IND_CTAS_CORRIENTES                 AS PE_IND_CTAS_CORRIENTES       
	,L02.TE_COTIZA                              AS PE_COTIZA                    
	,CASE 
    	WHEN L02.TE_OPC_COMPRA > 0
			THEN 1000000
    	ELSE L02.TD_PROB
 	END 										AS PD_PROB                      
	,L02.TC_ESTADO_RECURRENCIA_LEASING          AS PC_ESTADO_RECURRENCIA_LEASING
	,L02.TD_OFERTA_REGLA                        AS PD_OFERTA_REGLA              
	,L02.TD_MONTO_OFERTA                        AS PD_MONTO_OFERTA              
	,L02.TC_CAMPANA                             AS PC_CAMPANA                   
	,L02.TE_POTENCIAL                           AS PE_POTENCIAL                 
	,L02.TC_TIPO_BCA                            AS PC_TIPO_BCA                  
	,L02.TC_TRAMO_LEASING_MOB                   AS PC_TRAMO_LEASING_MOB         
	,L02.TC_EJE_LEASING                         AS PC_EJE_LEASING               
	,L02.TE_NO_POTENCIAL                        AS PE_NO_POTENCIAL              
	,CASE 
    	WHEN L02.TC_TIPO_BCA = 'WSB' THEN
        	CASE 
            	WHEN L02.TE_PLAN_INVERSION = 1 
					THEN 1
            	WHEN L02.TE_OPC_COMPRA = 1 
					THEN 2
            	WHEN L02.TE_LEASING_DATAMART = 1 
					THEN 3
            	WHEN L02.TE_COTIZA > 0 
					THEN 4
            	WHEN COALESCE(L02.TC_TRAMO_LEASING_MOB,'') = 'MIXTO' 
					THEN 5
            	WHEN COALESCE(L02.TC_TRAMO_LEASING_MOB,'') = 'BCI' 
					THEN 6
            	WHEN COALESCE(L02.TC_TRAMO_LEASING_MOB,'') = 'OTROS_BANCOS' 
					THEN 7
            	WHEN COALESCE(L02.TC_TRAMO_LEASING_MOB,'') = 'NUEVO' 
					THEN 8
            	WHEN COALESCE(L02.TC_TRAMO_LEASING_MOB,'') IN ('5 - NO LEASING','') 
					THEN 88
            	ELSE 99
        	END
    	ELSE 0
 	END 										AS PE_PRIO                      
	,CASE
    	WHEN POSITION('BCI' IN L02.TC_NOM_CLI) > 0 
			THEN 1
    	ELSE 0
	END 										AS PE_ES_BCI                    
	,CASE 
    	WHEN L02.TD_CLI_RUT >= 60000000 AND L02.TD_CLI_RUT < 70000000
			THEN 1
    	ELSE 0
 	END 										AS PE_MARCA_RUTGOB              
	,L02.TC_TEXTO1                              AS PC_TEXTO1                    
	,L02.TC_TEXTO2                              AS PC_TEXTO2                    
	,L02.TC_CARACTERISTICAS_CLIENTE             AS PC_CARACTERISTICAS_CLIENTE   
	,L02.TC_CAMPANA_OFERTA                      AS PC_CAMPANA_OFERTA            
	,L02.TE_EN_PLANEAMIENTO                     AS PE_EN_PLANEAMIENTO           
	,L02.TC_RECOMENDACION_DE_CRUCE              AS PC_RECOMENDACION_DE_CRUCE    
	,L02.TC_CALIFICACION_SBIF                   AS PC_CALIFICACION_SBIF         
	,L02.TT_PERIODO_CALIFICACION                AS PT_PERIODO_CALIFICACION      
	,L02.TD_PI_CLIENTE                          AS PD_PI_CLIENTE                
	,L02.TC_CLASIFICACION_SBIF                  AS PC_CLASIFICACION_SBIF        
	,L02.TE_FDR                                 AS PE_FDR                       
	,L02.TE_COS_CLI                             AS PE_COS_CLI                   
	,L02.TE_FILTROS_RIESGOS                     AS PE_FILTROS_RIESGOS           
	,L02.TC_PAR_CALIFICACION_SBIF               AS PC_PAR_CALIFICACION_SBIF     
	,L02.TD_PAR_PI_CLIENTE                      AS PD_PAR_PI_CLIENTE            
	,L02.TE_PAR_FDR                             AS PE_PAR_FDR                   
	,L02.TE_PAR_COS_CLI                         AS PE_PAR_COS_CLI               
	,L02.TE_MOLESTO                             AS PE_MOLESTO                   
	,L02.TE_CARGABLE                            AS PE_CARGABLE                  
	,L02.TC_ELIMINADO                           AS PC_ELIMINADO                 
	,L02.TE_DUPLAS                              AS PE_DUPLAS                    
	,L02.TE_PLAN_INVERSION                      AS PE_PLAN_INVERSION
	,L02.TE_NRO_OPT_PLAN_INVERSION				AS PE_NRO_OPT_PLAN_INVERSION            
	,L02.TE_MTO_OPT_PLAN_INVERSION              AS PE_MTO_OPT_PLAN_INVERSION    
	,L02.TC_PROD_1_PLAN_INVERSION               AS PC_PROD_1_PLAN_INVERSION     
	,L02.TC_PROD_2_PLAN_INVERSION               AS PC_PROD_2_PLAN_INVERSION     
	,L02.TC_PER_MIN_PLAN_INVERSION              AS PC_PER_MIN_PLAN_INVERSION    
	,L02.TC_PER_MAX_PLAN_INVERSION              AS PC_PER_MAX_PLAN_INVERSION    
	,L02.TE_CON_VENTAS                          AS PE_CON_VENTAS                
	,L02.TE_CON_VENTAS_ANT                      AS PE_CON_VENTAS_ANT            
	,L02.TE_LEASING_DATAMART                    AS PE_LEASING_DATAMART          
	,L02.TE_OPC_COMPRA                          AS PE_OPC_COMPRA                
	,L02.TC_PER_OPC_COMPRA                      AS PC_PER_OPC_COMPRA            
	,L02.TC_ESTRATEGIA                          AS PC_ESTRATEGIA                
	,L02.TC_PERFIL                              AS PC_PERFIL
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_RN_01 AS L02
;

.IF ERRORCODE <> 0 THEN .QUIT 16;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PD_CLI_RUT)
	ON  {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_RN;
.IF ERRORCODE <> 0 THEN .QUIT 17;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;

UPDATE - Ejemplo 17 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: LEASING MARCA DE CLIENTES CAMPANIABLES 									  **
--**																			          **
--** AUTOR  : RODRIGO CASTILLO                                             				  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 05/2022	                                                  				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN: FILTRO CLIENTE NO DESEADOS                                                  **
--** AUTOR  : IGNACIO LAGOS                                                          	  **
--** FECHA  : 02/2024                                                  				      **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS				  **
--**					MKT_CRM_EMP_TB.CMP_LEASING                          			  **
--**					{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES		  **  
--**					MKT_JOURNEYBUILDER_TB.P_CMP_MAE_CLIENTE_EJECUTIVO			  **                     
--**                  	                                                                  **
--** TABLA DE SALIDA: 	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES		  **
--**                                      	                                              **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/*******************************************************************
--** CREA TABLA TEMPORAL CON PARAMETROS DE EJECUCION	    		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_CMP_LEA_WSB_MRC_PARAMETRO;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_CMP_LEA_WSB_MRC_PARAMETRO
(
	 TE_PERIODO_CMP			INTEGER
	,TF_FECHA_CMP			DATE FORMAT 'YYYY-MM-DD'
	,TF_FECHA_CRG 			DATE FORMAT 'YYYY-MM-DD'
	,TE_PERIODO_MENOS_1M	INTEGER
	,TE_PERIODO_MENOS_2M	INTEGER
) PRIMARY INDEX (TE_PERIODO_CMP)
;
.IF ERRORCODE <> 0 THEN .QUIT 1;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_CMP_LEA_WSB_MRC_PARAMETRO
SELECT 
	 SE_PERIODO_CMP  		AS TE_PERIODO_CMP
	,SF_FECHA_REF_DIA 		AS TF_FECHA_CMP
	,SF_FECHA_CARGA			AS TF_FECHA_CRG	
	,SE_PERIODO_MENOS_1M 	AS TE_PERIODO_MENOS_1M
	,SE_PERIODO_MENOS_2M 	AS TE_PERIODO_MENOS_2M
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_CMP_LEA_WSB_MRC_PARAMETRO;
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_LEASING_WHOLESALE_MES					  **  
--** CAMPO CAMPANA_OFERTA, FILTRADO QUE EL TIPO_BCA = 'WSB'				  **
--*************************************************************************/	
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
SET 
	PC_CAMPANA_OFERTA = 
		CASE WHEN PC_CAMPANA LIKE '%RECURRENTE%' 
			THEN '1 RECURRENTE' 
			ELSE '2 NUEVO' 
		END
WHERE 
	PC_TIPO_BCA = 'WSB'
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

--/* *********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/
COLLECT STATS INDEX ( PE_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES;
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA VTAS_LEASING_01 PARA SACAR EL 		 	  **
--** EL RUT DEL CLIENTE CRUZADA CON PARAMETRO EN UN RANGO DE PERIODO	  **  
--** PERIODO_MENOS_2M Y Y EL PERIODO DE CAMPANIA (PERIODO_CMP)			  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_01;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_01
(
	 TE_CLIENTE_RUT 			INTEGER)
PRIMARY INDEX ( TE_CLIENTE_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 6;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_01
SELECT 
	LEA.CLIENTE_RUT 	AS TE_CLIENTE_RUT
FROM 
	MKT_CRM_EMP_TB.CMP_LEASING AS LEA
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_CMP_LEA_WSB_MRC_PARAMETRO AS PAR
		ON LEA.PERIODO_APE BETWEEN PAR.TE_PERIODO_MENOS_2M
			AND PAR.TE_PERIODO_CMP				
GROUP BY
	LEA.CLIENTE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 7;

--/* *********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TE_CLIENTE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_01;
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_LEASING_WHOLESALE_MES					  **  
--** CAMPO CON_VENTAS Y ASIGNANDO EL VALOR 1							  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_01 AS VTL
SET 
	PE_CON_VENTAS = 0
WHERE
	PE_CLI_RUT = VTL.TE_CLIENTE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/* *********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/
COLLECT STATS INDEX ( PE_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES;
.IF ERRORCODE <> 0 THEN .QUIT 10;

--/****************************************************************************
--** SE CREA TABLA TEMPORAL PARA LEASING_02 CRUZADA CON PARAMETRO PARA 	  	 **  
--** SACAR EL RUT UNICOS EN UN RANGO, PERIODO DE APERTURA Y PERIODO_MENOS_1M **
--****************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_02;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_02
(
	 TE_CLIENTE_RUT 			INTEGER)
PRIMARY INDEX ( TE_CLIENTE_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 11;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_02
SELECT 
	 CLIENTE_RUT 	AS TE_CLIENTE_RUT
FROM 
	MKT_CRM_EMP_TB.CMP_LEASING
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_CMP_LEA_WSB_MRC_PARAMETRO AS PAR
		ON PERIODO_APE = PAR.TE_PERIODO_MENOS_1M			
GROUP BY
	CLIENTE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 12;

--/* *********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TE_CLIENTE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_02;
.IF ERRORCODE <> 0 THEN .QUIT 13;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_LEASING_WHOLESALE_MES					  **  
--** CAMPO CON_VENTAS_ANT ASIGNANDO EL VALOR 1							  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_02 AS VTL
SET 
	PE_CON_VENTAS_ANT = 0
WHERE
	PE_CLI_RUT = VTL.TE_CLIENTE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 14;

--/* *********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES;
.IF ERRORCODE <> 0 THEN .QUIT 15;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA MACRO_BANCA, EMPRESARIOS, EMPRENDEDORES  **  
--** EMPRESAS, GRANDES EMPRESAS	Y INMOBILIARIA							  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MACRO_BANCA_01;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MACRO_BANCA_01
(
	TC_MACRO_BANCA		VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC)
PRIMARY INDEX ( TC_MACRO_BANCA )
;
.IF ERRORCODE <> 0 THEN .QUIT 16;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MACRO_BANCA_01 VALUES ('EMPRESARIOS');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MACRO_BANCA_01 VALUES ('EMPRENDEDORES');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MACRO_BANCA_01 VALUES ('EMPRESAS');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MACRO_BANCA_01 VALUES ('GRANDES EMPRESAS');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MACRO_BANCA_01 VALUES ('INMOBILIARIA');
.IF ERRORCODE <> 0 THEN .QUIT 17;

--/* *********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TC_MACRO_BANCA )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MACRO_BANCA_01;
.IF ERRORCODE <> 0 THEN .QUIT 18;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_LEASING_WHOLESALE_MES		  			  **  
--** CAMPO CARGABLE = 1, CUANDO SE CUMPLEN ESTAS CONDICIONES			  **
--** FILTROS_RIESGOS > 0, PRIORIDAD = 0, MARCA_RUTGOB = 0, ES_BCI = 0,	  **
--** EJE_LEASING <> '0', MOLESTO = 0, IND_CTAS_CORRIENTES > 0			  **
--** Y CON_VENTAS = 0													  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MACRO_BANCA_01 AS MBC
SET 
	PE_CARGABLE = 1
WHERE
	PC_MACRO_BANCA = MBC.TC_MACRO_BANCA
	AND PE_FILTROS_RIESGOS > 0          
    AND PE_PRIO > 0                       
	AND PE_MARCA_RUTGOB = 0                
	AND PE_ES_BCI = 0                    
	AND NOT (COALESCE(PC_EJE_LEASING,'0') = '0')
	AND PE_MOLESTO = 0
	AND COALESCE(PE_IND_CTAS_CORRIENTES,0) > 0
	AND COALESCE(PE_CON_VENTAS,0) = 0
;
.IF ERRORCODE <> 0 THEN .QUIT 19;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_LEASING_WHOLESALE_MES					  **  
--** CAMPO CARGABLE CON EL VALOR 1, CUANDO DUPLAS = 1 Y CARGABLE = 0	  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
SET 
	PE_CARGABLE = 1
WHERE 
	PE_DUPLAS = 1 
	AND PE_CARGABLE = 0
;
.IF ERRORCODE <> 0 THEN .QUIT 20;

--/* *********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/
COLLECT STATS INDEX ( PE_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES;
.IF ERRORCODE <> 0 THEN .QUIT 21;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL RGO_CCT_EJE_VTA_OF_INV 						  **
--** P_CAMPANA_LEASING_WHOLESALE_MES, SELECCIONA EL INDICADOR 0 O 1 BAJO  **
--** CIERTAS CONDICONES													  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_RGO_CCT_EJE_VTA_OF_INV;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_RGO_CCT_EJE_VTA_OF_INV
(
	 TE_RUT				INTEGER
	,TE_LEA_WSB			INTEGER)
PRIMARY INDEX ( TE_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 22;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_RGO_CCT_EJE_VTA_OF_INV
SELECT
	 PE_CLI_RUT 	AS TE_RUT
	,CASE 
		WHEN PE_FILTROS_RIESGOS = 0 
			THEN 1
		WHEN COALESCE(PE_IND_CTAS_CORRIENTES,0) = 0 
			THEN 1
		WHEN NOT (COALESCE(PC_EJE_LEASING,'0') = '0') 
			THEN 1
		WHEN COALESCE(PE_CON_VENTAS,0) > 0  
			THEN 1
		WHEN PD_MONTO_OFERTA > 0 
			THEN 1
		WHEN PE_PLAN_INVERSION>0 
			THEN 1
		ELSE 0
	 END AS TE_LEA_WSB
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
;
.IF ERRORCODE <> 0 THEN .QUIT 23;

--/* *********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_RGO_CCT_EJE_VTA_OF_INV;
.IF ERRORCODE <> 0 THEN .QUIT 24;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_LEASING_WHOLESALE_MES					  **
--** SUBO A CLIENTES CON OPCION DE COMPRA, QUE NO QUEDE NINGUNO FUERA,	  ** 
--** CAMPO CARGABLE, FILTRANDO POR (OPC_COMPRA + PLAN_INVERSION) > 0,	  **
--** CARGABLE = 0 Y LEA_WSB = 1											  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_RGO_CCT_EJE_VTA_OF_INV AS LWSB
SET 
	PE_CARGABLE = 1
WHERE
	PE_CLI_RUT = LWSB.TE_RUT
	AND (PE_OPC_COMPRA + PE_PLAN_INVERSION) > 0
	AND PE_CARGABLE = 0 
	AND LWSB.TE_LEA_WSB = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 25;

--/**************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_LEASING_WHOLESALE_MES CAMPO CARGABLE = 1 **  
--** BAJO A CLIENTES CON OPCION DE COMPRA, QUE YA CURSARON				   **
--** RECIENTEMENTE O NO TIENEN EJECUTIVO ESPECIALISTA 	    			   **
--**************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_CMP_LEA_WSB_MRC_PARAMETRO AS PAR
SET 
	PE_CARGABLE = 0
WHERE
	PE_OPC_COMPRA > 0 
	AND COALESCE(PE_CON_VENTAS,0) > 0
	AND PC_PER_OPC_COMPRA < PAR.TE_PERIODO_CMP 
	AND PE_CARGABLE = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 26;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_LEASING_WHOLESALE_MES					  **  
--** CAMPO CARGABLE, FILTRANDO POR OPC_COMPRA > 0, EJE_LEASING IS NULL	  **
--** Y QUE CARGABLE SEA IGUAL A 1										  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
SET 
	PE_CARGABLE = 0
WHERE 
	PE_OPC_COMPRA > 0 
	AND PC_EJE_LEASING IS NULL
	AND PE_CARGABLE = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 27;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_LEASING_WHOLESALE_MES		  			  **  
--** CAMPO CARGABLE, FILTRADO POR EJE_LEASING IS NULL Y CARGABLE = 1	  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
SET 
	PE_CARGABLE = 0
WHERE 
	PC_EJE_LEASING IS NULL
	AND PE_CARGABLE = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 28;

--/***************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_LEASING_WHOLESALE_MES					  	**  
--** CAMPO ELIMINADO, BAJO CIERTAS CONDICIONES Y FILTRANDO POR CARGABLE = 0	**
--***************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
SET 
	PC_ELIMINADO = 
		CASE
			WHEN PE_FILTROS_RIESGOS = 0              
				THEN '01.- FILTROS RIESGOS'
			WHEN PE_MARCA_RUTGOB    >0               
				THEN '02.- RUT GUBERNAMENTAL'
			WHEN PE_ES_BCI                > 0        
				THEN '03.- CLIENTE ES BCI'
			WHEN COALESCE(PC_EJE_LEASING,'0')='0'      
				THEN '04.- SIN EJECUTIVO'
			WHEN PC_MACRO_BANCA NOT IN ('EMPRESARIOS','EMPRENDEDORES','EMPRESAS','GRANDES EMPRESAS','INMOBILIARIA') 
				THEN '05.- BANCA NO CORRESPONDE'
			WHEN COALESCE(PE_MOLESTO,0) > 0            
				THEN '06.- MOLESTOS'
			WHEN COALESCE(PE_IND_CTAS_CORRIENTES,0)=0  
				THEN '09.- SIN CUENTA CORRIENTE'
			WHEN PE_PRIO = 0                         
				THEN '10.- SIN PROP/PRIOR.'
			WHEN COALESCE(PE_CON_VENTAS,0) > 0           
				THEN '12.- CON VENTA LEASING ULTIMO TRIMESTRE'
			ELSE '' 
		END
WHERE 
	PE_CARGABLE = 0
;
.IF ERRORCODE <> 0 THEN .QUIT 29;

--/* *********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES;
.IF ERRORCODE <> 0 THEN .QUIT 30;

--/*************************************************************************
--** Se APLICAN FILTROS DE EMPRESAS NO DESEADAS A CARGAR 		 		  **  
--*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_LS;

CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_LS
(
 TD_RUT DECIMAL(8,0)
)PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 31;


INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_LS
SELECT PE_CLI_RUT AS TD_RUT
FROM MKT_JOURNEYBUILDER_TB.P_CMP_MAE_CLIENTE_EJECUTIVO
WHERE PC_NOM_CLI = 'EMPRESAS JUAN YARUR SPA'
;
.IF ERRORCODE <> 0 THEN .QUIT 32;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_LS
SELECT PE_CLI_RUT AS TD_RUT
FROM MKT_JOURNEYBUILDER_TB.P_CMP_MAE_CLIENTE_EJECUTIVO
WHERE PC_NOM_CLI = 'EMPRESAS JY S A'
;
.IF ERRORCODE <> 0 THEN .QUIT 33;

COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_LS;
	
.IF ERRORCODE <> 0 THEN .QUIT 34;


--/***********************************************************************
--** 							UPDATE NO DESEADO					    **  
--***********************************************************************/

UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_LS AS FLT

SET 
	 PE_CARGABLE = 0
	,PC_ELIMINADO ='CLIENTE EMPRESA YARUR'
WHERE
	PE_CLI_RUT = FLT.TD_RUT
;

.IF ERRORCODE <> 0 THEN .QUIT 035;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 17 OK.sql

--/***********************************************************************************************************
--************************************************************************************************************
--** DSCRPCN: LEASING MARCA DE CLIENTES CAMPANIABLES 									  					**
--**																			          					**
--** AUTOR  : RODRIGO CASTILLO                                             				  					**
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  					**
--** FECHA  : 05/2022	                                                  				  					**
--***********************************************************************************************************/
--/***********************************************************************************************************
--** MANTNCN: FILTRO CLIENTE NO DESEADOS                                                  					**
--** AUTOR  : IGNACIO LAGOS                                                          	  					**
--** FECHA  : 02/2024                                                  				      					**
--/***********************************************************************************************************
--** MANTNCN: Normalización BTEQ														  					**
--** AUTOR  : MATIAS JORQUERA															  					**
--** EMPRESA: FACTOR IT																  	  					**
--** FECHA  : 12/2024																	  					**
--/***********************************************************************************************************
--**TABLA DE ENTRADA:	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS				  	  					**
--**					MKT_CRM_EMP_TB.CMP_LEASING                          			  					**
--**					{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_RN	**
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CLIENTE_EJECUTIVO			 	  					**
--**                  	                                                                  					**
--** TABLA DE SALIDA: 	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_MC	**
--**                                      	                                              					**
--************************************************************************************************************
--***********************************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/*******************************************************************
--** CREA TABLA TEMPORAL CON PARAMETROS DE EJECUCION	    		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_CMP_LEA_WSB_MRC_PARAMETRO;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_CMP_LEA_WSB_MRC_PARAMETRO
(
	 TE_PERIODO_CMP			INTEGER
	,TF_FECHA_CMP			DATE FORMAT 'YYYY-MM-DD'
	,TF_FECHA_CRG 			DATE FORMAT 'YYYY-MM-DD'
	,TE_PERIODO_MENOS_1M	INTEGER
	,TE_PERIODO_MENOS_2M	INTEGER
) UNIQUE PRIMARY INDEX (TE_PERIODO_CMP)
;
.IF ERRORCODE <> 0 THEN .QUIT 1;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_CMP_LEA_WSB_MRC_PARAMETRO
SELECT 
	 SE_PERIODO_CMP  		AS TE_PERIODO_CMP
	,SF_FECHA_REF_DIA 		AS TF_FECHA_CMP
	,SF_FECHA_CARGA			AS TF_FECHA_CRG	
	,SE_PERIODO_MENOS_1M 	AS TE_PERIODO_MENOS_1M
	,SE_PERIODO_MENOS_2M 	AS TE_PERIODO_MENOS_2M
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_CMP_LEA_WSB_MRC_PARAMETRO;
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA VTAS_LEASING_01 PARA SACAR EL 		 	  **
--** EL RUT DEL CLIENTE CRUZADA CON PARAMETRO EN UN RANGO DE PERIODO	  **  
--** PERIODO_MENOS_2M Y Y EL PERIODO DE CAMPANIA (PERIODO_CMP)			  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_01
(
	 TD_CLIENTE_RUT 			DECIMAL(8,0))
UNIQUE PRIMARY INDEX ( TD_CLIENTE_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_01
SELECT 
	LEA.CLIENTE_RUT 	AS TD_CLIENTE_RUT
FROM 
	MKT_CRM_EMP_TB.CMP_LEASING AS LEA
INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_CMP_LEA_WSB_MRC_PARAMETRO AS PAR
	ON LEA.PERIODO_APE BETWEEN PAR.TE_PERIODO_MENOS_2M
	AND PAR.TE_PERIODO_CMP				
GROUP BY
	LEA.CLIENTE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/* *********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_CLIENTE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_01;
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/****************************************************************************
--** SE CREA TABLA TEMPORAL PARA LEASING_02 CRUZADA CON PARAMETRO PARA 	  	 **  
--** SACAR EL RUT UNICOS EN UN RANGO, PERIODO DE APERTURA Y PERIODO_MENOS_1M **
--****************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_02;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_02
(
	 TD_CLIENTE_RUT 			DECIMAL(8,0))
UNIQUE PRIMARY INDEX ( TD_CLIENTE_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 7;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_02
SELECT 
	 CLIENTE_RUT 	AS TD_CLIENTE_RUT
FROM 
	MKT_CRM_EMP_TB.CMP_LEASING
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_CMP_LEA_WSB_MRC_PARAMETRO AS PAR
		ON PERIODO_APE = PAR.TE_PERIODO_MENOS_1M			
GROUP BY
	CLIENTE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/* *********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_CLIENTE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_02;
.IF ERRORCODE <> 0 THEN .QUIT 9;


/*************************************************************************
** SE ACTUALIZAN CAMPOS EN LA TABLA P_CAMPANA_LEASING_WHOLESALE_MES     **
** CAMPOS ACTUALIZADOS:                                                 **
** - CAMPANA_OFERTA (FILTRANDO POR TIPO_BCA = 'WSB')                    **
** - CON_VENTAS (ASIGNANDO EL VALOR 1)                                  **
** - CON_VENTAS_ANT (ASIGNANDO EL VALOR 1)                              **
*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_03;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_03
(
     TD_CLI_RUT 						    DECIMAL(8,0)
    ,TC_NOM_CLI 						    VARCHAR (77)  CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_MACRO_BANCA 			            VARCHAR (16)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE 				  	            VARCHAR (12)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_IND_CTAS_CORRIENTES 	            INTEGER
    ,TE_COTIZA 						        INTEGER
    ,TD_PROB							    DECIMAL(25,10)
    ,TC_ESTADO_RECURRENCIA_LEASING	        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_OFERTA_REGLA					    DECIMAL(18,0)
    ,TD_MONTO_OFERTA     				    DECIMAL(18,0)
    ,TC_CAMPANA						        VARCHAR(50)	  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_POTENCIAL						    INTEGER
    ,TC_TIPO_BCA						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TRAMO_LEASING_MOB				    VARCHAR(255)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_LEASING					        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_NO_POTENCIAL					    INTEGER
    ,TE_PRIO                                INTEGER
    ,TE_ES_BCI                              INTEGER
    ,TE_MARCA_RUTGOB                        INTEGER
    ,TC_TEXTO1						        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2						        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE		        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA				        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO				        INTEGER
    ,TC_RECOMENDACION_DE_CRUCE 		        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TT_PERIODO_CALIFICACION			    TIMESTAMP(6) FORMAT 'YYYY-MM-DDBHH:MI:SS.S(6)'
    ,TD_PI_CLIENTE					        DECIMAL(25,10)
    ,TC_CLASIFICACION_SBIF			        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR							        INTEGER
    ,TE_COS_CLI						        INTEGER
    ,TE_FILTROS_RIESGOS 				    INTEGER
    ,TC_PAR_CALIFICACION_SBIF			    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE				        DECIMAL(25,10)
    ,TE_PAR_FDR						        INTEGER
    ,TE_PAR_COS_CLI					        INTEGER
    ,TE_MOLESTO						        BIGINT
    ,TE_CARGABLE 						    BIGINT
    ,TC_ELIMINADO						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS 						        BIGINT
    ,TE_PLAN_INVERSION 				        BIGINT
	,TE_NRO_OPT_PLAN_INVERSION  		    BIGINT
    ,TE_MTO_OPT_PLAN_INVERSION  		    BIGINT
    ,TC_PROD_1_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PROD_2_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MIN_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MAX_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CON_VENTAS 					        BIGINT
    ,TE_CON_VENTAS_ANT 				        BIGINT
    ,TE_LEASING_DATAMART 				    BIGINT
    ,TE_OPC_COMPRA 					        BIGINT
    ,TC_PER_OPC_COMPRA				        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ESTRATEGIA					        VARCHAR(9)    CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PERFIL			 			        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (TD_CLI_RUT)
;

.IF ERRORCODE <> 0 THEN .QUIT 10;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_03
SELECT 
	 LEA.PD_CLI_RUT     						AS TD_CLI_RUT     		                  
	,LEA.PC_NOM_CLI                             AS TC_NOM_CLI                   
	,LEA.PC_MACRO_BANCA                         AS TC_MACRO_BANCA               
	,LEA.PC_EJE                                 AS TC_EJE                       
	,LEA.PE_IND_CTAS_CORRIENTES                 AS TE_IND_CTAS_CORRIENTES       
	,LEA.PE_COTIZA                              AS TE_COTIZA                    
	,LEA.PD_PROB                                AS TD_PROB                      
	,LEA.PC_ESTADO_RECURRENCIA_LEASING          AS TC_ESTADO_RECURRENCIA_LEASING
	,LEA.PD_OFERTA_REGLA                        AS TD_OFERTA_REGLA              
	,LEA.PD_MONTO_OFERTA                        AS TD_MONTO_OFERTA              
	,LEA.PC_CAMPANA                             AS TC_CAMPANA                   
	,LEA.PE_POTENCIAL                           AS TE_POTENCIAL                 
	,LEA.PC_TIPO_BCA                            AS TC_TIPO_BCA                  
	,LEA.PC_TRAMO_LEASING_MOB                   AS TC_TRAMO_LEASING_MOB         
	,LEA.PC_EJE_LEASING                         AS TC_EJE_LEASING               
	,LEA.PE_NO_POTENCIAL                        AS TE_NO_POTENCIAL              
	,LEA.PE_PRIO                                AS TE_PRIO                      
	,LEA.PE_ES_BCI                              AS TE_ES_BCI                    
	,LEA.PE_MARCA_RUTGOB                        AS TE_MARCA_RUTGOB              
	,LEA.PC_TEXTO1                              AS TC_TEXTO1                    
	,LEA.PC_TEXTO2                              AS TC_TEXTO2                    
	,LEA.PC_CARACTERISTICAS_CLIENTE             AS TC_CARACTERISTICAS_CLIENTE   
	,CASE 
    	WHEN LEA.PC_TIPO_BCA = 'WSB' THEN
        	CASE 
           	 WHEN LEA.PC_CAMPANA LIKE '%RECURRENTE%' 
			 	THEN '1 RECURRENTE'
           	 ELSE '2 NUEVO'
        	END
    ELSE LEA.PC_CAMPANA_OFERTA
 	END 										AS TC_CAMPANA_OFERTA            
	,LEA.PE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO           
	,LEA.PC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE    
	,LEA.PC_CALIFICACION_SBIF                   AS TC_CALIFICACION_SBIF         
	,LEA.PT_PERIODO_CALIFICACION                AS TT_PERIODO_CALIFICACION      
	,LEA.PD_PI_CLIENTE                          AS TD_PI_CLIENTE                
	,LEA.PC_CLASIFICACION_SBIF                  AS TC_CLASIFICACION_SBIF        
	,LEA.PE_FDR                                 AS TE_FDR                       
	,LEA.PE_COS_CLI                             AS TE_COS_CLI                   
	,LEA.PE_FILTROS_RIESGOS                     AS TE_FILTROS_RIESGOS           
	,LEA.PC_PAR_CALIFICACION_SBIF               AS TC_PAR_CALIFICACION_SBIF     
	,LEA.PD_PAR_PI_CLIENTE                      AS TD_PAR_PI_CLIENTE            
	,LEA.PE_PAR_FDR                             AS TE_PAR_FDR                   
	,LEA.PE_PAR_COS_CLI                         AS TE_PAR_COS_CLI               
	,LEA.PE_MOLESTO                             AS TE_MOLESTO                   
	,LEA.PE_CARGABLE                            AS TE_CARGABLE                  
	,LEA.PC_ELIMINADO                           AS TC_ELIMINADO                 
	,LEA.PE_DUPLAS                              AS TE_DUPLAS                    
	,LEA.PE_PLAN_INVERSION                      AS TE_PLAN_INVERSION
	,LEA.PE_NRO_OPT_PLAN_INVERSION            	AS TE_NRO_OPT_PLAN_INVERSION
	,LEA.PE_MTO_OPT_PLAN_INVERSION              AS TE_MTO_OPT_PLAN_INVERSION    
	,LEA.PC_PROD_1_PLAN_INVERSION               AS TC_PROD_1_PLAN_INVERSION     
	,LEA.PC_PROD_2_PLAN_INVERSION               AS TC_PROD_2_PLAN_INVERSION     
	,LEA.PC_PER_MIN_PLAN_INVERSION              AS TC_PER_MIN_PLAN_INVERSION    
	,LEA.PC_PER_MAX_PLAN_INVERSION              AS TC_PER_MAX_PLAN_INVERSION    
	,CASE 
    	WHEN VTL1.TD_CLIENTE_RUT IS NOT NULL 
			THEN 0
    	ELSE LEA.PE_CON_VENTAS
 	END 										AS TE_CON_VENTAS               
	,CASE 
    WHEN VTL2.TD_CLIENTE_RUT IS NOT NULL 
		THEN 0
    ELSE LEA.PE_CON_VENTAS_ANT
 	END 										AS TE_CON_VENTAS_ANT            
	,LEA.PE_LEASING_DATAMART                    AS TE_LEASING_DATAMART          
	,LEA.PE_OPC_COMPRA                          AS TE_OPC_COMPRA                
	,LEA.PC_PER_OPC_COMPRA                      AS TC_PER_OPC_COMPRA            
	,LEA.PC_ESTRATEGIA                          AS TC_ESTRATEGIA                
	,LEA.PC_PERFIL                              AS TC_PERFIL	
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_RN AS LEA
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_01 AS VTL1
	ON LEA.PD_CLI_RUT = VTL1.TD_CLIENTE_RUT
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_VTAS_LEASING_02 AS VTL2
	ON LEA.PD_CLI_RUT = VTL2.TD_CLIENTE_RUT
;

--/* *********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/
COLLECT STATS INDEX ( TD_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_03;
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA MACRO_BANCA, EMPRESARIOS, EMPRENDEDORES  **  
--** EMPRESAS, GRANDES EMPRESAS	Y INMOBILIARIA							  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MACRO_BANCA_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MACRO_BANCA_01
(
	TC_MACRO_BANCA		VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC)
UNIQUE PRIMARY INDEX ( TC_MACRO_BANCA )
;
.IF ERRORCODE <> 0 THEN .QUIT 12;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MACRO_BANCA_01 VALUES ('EMPRESARIOS');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MACRO_BANCA_01 VALUES ('EMPRENDEDORES');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MACRO_BANCA_01 VALUES ('EMPRESAS');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MACRO_BANCA_01 VALUES ('GRANDES EMPRESAS');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MACRO_BANCA_01 VALUES ('INMOBILIARIA');
.IF ERRORCODE <> 0 THEN .QUIT 13;

--/* *********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TC_MACRO_BANCA )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MACRO_BANCA_01;
.IF ERRORCODE <> 0 THEN .QUIT 14;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL RGO_CCT_EJE_VTA_OF_INV 						  **
--** P_CAMPANA_LEASING_WHOLESALE_MES, SELECCIONA EL INDICADOR 0 O 1 BAJO  **
--** CIERTAS CONDICONES													  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_RGO_CCT_EJE_VTA_OF_INV;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_RGO_CCT_EJE_VTA_OF_INV
(
	 TD_RUT				DECIMAL(8,0)
	,TE_LEA_WSB			INTEGER)
UNIQUE PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 15;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_RGO_CCT_EJE_VTA_OF_INV
SELECT
	 PD_CLI_RUT 	AS TD_RUT
	,CASE 
		WHEN PE_FILTROS_RIESGOS = 0 
			THEN 1
		WHEN COALESCE(PE_IND_CTAS_CORRIENTES,0) = 0 
			THEN 1
		WHEN NOT (COALESCE(PC_EJE_LEASING,'0') = '0') 
			THEN 1
		WHEN COALESCE(PE_CON_VENTAS,0) > 0  
			THEN 1
		WHEN PD_MONTO_OFERTA > 0 
			THEN 1
		WHEN PE_PLAN_INVERSION>0 
			THEN 1
		ELSE 0
	 END AS TE_LEA_WSB
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_RN
;
.IF ERRORCODE <> 0 THEN .QUIT 16;

--/* *********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_RGO_CCT_EJE_VTA_OF_INV;
.IF ERRORCODE <> 0 THEN .QUIT 17;

/*************************************************************************
** ACTUALIZACIÓN PARA LA TABLA P_CAMPANA_LEASING_WHOLESALE_MES          **
** RESUMEN DE LOS CAMBIOS REALIZADOS:                                   **
** - Se marca como "Cargable" a clientes que cumplen criterios como:    **
**   riesgos > 0, sin prioridad, no "RUT Gobierno", no BCI, eje leasing **
**   distinto de "0", no molestos, cuentas corrientes activas > 0 y sin **
**   ventas registradas.                                                **
** - Se asigna "Cargable" a combinaciones específicas (duplas activas)  **
**   aún no marcadas como tal.                                          **
** - Se incluyen clientes con opción de compra o planes de inversión    **
**   activos, siempre que no sean ya "Cargables" y pertenezcan al       **
**   segmento leasing wholesale (LEA).                                  **
*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_04;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_04
(
     TD_CLI_RUT 						    DECIMAL(8,0)
    ,TC_NOM_CLI 						    VARCHAR (77)  CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_MACRO_BANCA 			            VARCHAR (16)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE 				  	            VARCHAR (12)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_IND_CTAS_CORRIENTES 	            INTEGER
    ,TE_COTIZA 						        INTEGER
    ,TD_PROB							    DECIMAL(25,10)
    ,TC_ESTADO_RECURRENCIA_LEASING	        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_OFERTA_REGLA					    DECIMAL(18,0)
    ,TD_MONTO_OFERTA     				    DECIMAL(18,0)
    ,TC_CAMPANA						        VARCHAR(50)	  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_POTENCIAL						    INTEGER
    ,TC_TIPO_BCA						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TRAMO_LEASING_MOB				    VARCHAR(255)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_LEASING					        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_NO_POTENCIAL					    INTEGER
    ,TE_PRIO                                INTEGER
    ,TE_ES_BCI                              INTEGER
    ,TE_MARCA_RUTGOB                        INTEGER
    ,TC_TEXTO1						        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2						        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE		        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA				        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO				        INTEGER
    ,TC_RECOMENDACION_DE_CRUCE 		        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TT_PERIODO_CALIFICACION			    TIMESTAMP(6) FORMAT 'YYYY-MM-DDBHH:MI:SS.S(6)'
    ,TD_PI_CLIENTE					        DECIMAL(25,10)
    ,TC_CLASIFICACION_SBIF			        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR							        INTEGER
    ,TE_COS_CLI						        INTEGER
    ,TE_FILTROS_RIESGOS 				    INTEGER
    ,TC_PAR_CALIFICACION_SBIF			    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE				        DECIMAL(25,10)
    ,TE_PAR_FDR						        INTEGER
    ,TE_PAR_COS_CLI					        INTEGER
    ,TE_MOLESTO						        BIGINT
    ,TE_CARGABLE 						    BIGINT
    ,TC_ELIMINADO						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS 						        BIGINT
    ,TE_PLAN_INVERSION 				        BIGINT
	,TE_NRO_OPT_PLAN_INVERSION				BIGINT
    ,TE_MTO_OPT_PLAN_INVERSION  		    BIGINT
    ,TC_PROD_1_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PROD_2_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MIN_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MAX_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CON_VENTAS 					        BIGINT
    ,TE_CON_VENTAS_ANT 				        BIGINT
    ,TE_LEASING_DATAMART 				    BIGINT
    ,TE_OPC_COMPRA 					        BIGINT
    ,TC_PER_OPC_COMPRA				        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ESTRATEGIA					        VARCHAR(9)    CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PERFIL			 			        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (TD_CLI_RUT)
;

.IF ERRORCODE <> 0 THEN .QUIT 18;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_04
SELECT 
	 LEA.TD_CLI_RUT     						AS TD_CLI_RUT     		                  
	,LEA.TC_NOM_CLI                             AS TC_NOM_CLI                   
	,LEA.TC_MACRO_BANCA                         AS TC_MACRO_BANCA               
	,LEA.TC_EJE                                 AS TC_EJE                       
	,LEA.TE_IND_CTAS_CORRIENTES                 AS TE_IND_CTAS_CORRIENTES       
	,LEA.TE_COTIZA                              AS TE_COTIZA                    
	,LEA.TD_PROB                                AS TD_PROB                      
	,LEA.TC_ESTADO_RECURRENCIA_LEASING          AS TC_ESTADO_RECURRENCIA_LEASING
	,LEA.TD_OFERTA_REGLA                        AS TD_OFERTA_REGLA              
	,LEA.TD_MONTO_OFERTA                        AS TD_MONTO_OFERTA              
	,LEA.TC_CAMPANA                             AS TC_CAMPANA                   
	,LEA.TE_POTENCIAL                           AS TE_POTENCIAL                 
	,LEA.TC_TIPO_BCA                            AS TC_TIPO_BCA                  
	,LEA.TC_TRAMO_LEASING_MOB                   AS TC_TRAMO_LEASING_MOB         
	,LEA.TC_EJE_LEASING                         AS TC_EJE_LEASING               
	,LEA.TE_NO_POTENCIAL                        AS TE_NO_POTENCIAL              
	,LEA.TE_PRIO                                AS TE_PRIO                      
	,LEA.TE_ES_BCI                              AS TE_ES_BCI                    
	,LEA.TE_MARCA_RUTGOB                        AS TE_MARCA_RUTGOB              
	,LEA.TC_TEXTO1                              AS TC_TEXTO1                    
	,LEA.TC_TEXTO2                              AS TC_TEXTO2                    
	,LEA.TC_CARACTERISTICAS_CLIENTE             AS TC_CARACTERISTICAS_CLIENTE   
	,LEA.TC_CAMPANA_OFERTA                      AS TC_CAMPANA_OFERTA            
	,LEA.TE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO           
	,LEA.TC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE    
	,LEA.TC_CALIFICACION_SBIF                   AS TC_CALIFICACION_SBIF         
	,LEA.TT_PERIODO_CALIFICACION                AS TT_PERIODO_CALIFICACION      
	,LEA.TD_PI_CLIENTE                          AS TD_PI_CLIENTE                
	,LEA.TC_CLASIFICACION_SBIF                  AS TC_CLASIFICACION_SBIF        
	,LEA.TE_FDR                                 AS TE_FDR                       
	,LEA.TE_COS_CLI                             AS TE_COS_CLI                   
	,LEA.TE_FILTROS_RIESGOS                     AS TE_FILTROS_RIESGOS           
	,LEA.TC_PAR_CALIFICACION_SBIF               AS TC_PAR_CALIFICACION_SBIF     
	,LEA.TD_PAR_PI_CLIENTE                      AS TD_PAR_PI_CLIENTE            
	,LEA.TE_PAR_FDR                             AS TE_PAR_FDR                   
	,LEA.TE_PAR_COS_CLI                         AS TE_PAR_COS_CLI               
	,LEA.TE_MOLESTO                             AS TE_MOLESTO                   
	,CASE 
    	WHEN LEA.TC_MACRO_BANCA = MBC.TC_MACRO_BANCA
         	AND LEA.TE_FILTROS_RIESGOS > 0
         	AND LEA.TE_PRIO > 0
         	AND LEA.TE_MARCA_RUTGOB = 0
         	AND LEA.TE_ES_BCI = 0
         	AND NOT (COALESCE(LEA.TC_EJE_LEASING,'0') = '0')
         	AND LEA.TE_MOLESTO = 0
         	AND COALESCE(LEA.TE_IND_CTAS_CORRIENTES,0) > 0
         	AND COALESCE(LEA.TE_CON_VENTAS,0) = 0
    	THEN 1
    		WHEN LEA.TE_DUPLAS = 1
			AND LEA.TE_CARGABLE = 0
    		THEN 1
    			WHEN (LEA.TE_OPC_COMPRA + LEA.TE_PLAN_INVERSION) > 0
         		AND LEA.TE_CARGABLE = 0 
         		AND LWSB.TE_LEA_WSB = 1
    			THEN 1
    ELSE 0
 	END 										AS TE_CARGABLE              
	,LEA.TC_ELIMINADO                           AS TC_ELIMINADO                 
	,LEA.TE_DUPLAS                              AS TE_DUPLAS                    
	,LEA.TE_PLAN_INVERSION                      AS TE_PLAN_INVERSION
	,LEA.TE_NRO_OPT_PLAN_INVERSION				AS TE_NRO_OPT_PLAN_INVERSION            
	,LEA.TE_MTO_OPT_PLAN_INVERSION              AS TE_MTO_OPT_PLAN_INVERSION    
	,LEA.TC_PROD_1_PLAN_INVERSION               AS TC_PROD_1_PLAN_INVERSION     
	,LEA.TC_PROD_2_PLAN_INVERSION               AS TC_PROD_2_PLAN_INVERSION     
	,LEA.TC_PER_MIN_PLAN_INVERSION              AS TC_PER_MIN_PLAN_INVERSION    
	,LEA.TC_PER_MAX_PLAN_INVERSION              AS TC_PER_MAX_PLAN_INVERSION    
	,LEA.TE_CON_VENTAS                          AS TE_CON_VENTAS                
	,LEA.TE_CON_VENTAS_ANT                      AS TE_CON_VENTAS_ANT            
	,LEA.TE_LEASING_DATAMART                    AS TE_LEASING_DATAMART          
	,LEA.TE_OPC_COMPRA                          AS TE_OPC_COMPRA                
	,LEA.TC_PER_OPC_COMPRA                      AS TC_PER_OPC_COMPRA            
	,LEA.TC_ESTRATEGIA                          AS TC_ESTRATEGIA                
	,LEA.TC_PERFIL                              AS TC_PERFIL	
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_03 AS LEA
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MACRO_BANCA_01 AS MBC
	ON LEA.TC_MACRO_BANCA = MBC.TC_MACRO_BANCA
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_RGO_CCT_EJE_VTA_OF_INV AS LWSB
	ON LEA.TD_CLI_RUT = LWSB.TD_RUT
	
;

.IF ERRORCODE <> 0 THEN .QUIT 19;


/*************************************************************************
** ACTUALIZACIÓN PARA LA TABLA P_CAMPANA_LEASING_WHOLESALE_MES          **
** RESUMEN DE LOS CAMBIOS REALIZADOS:                                   **
** - Se marca como "Cargable" a clientes con opción de compra que:      **
**   1. Ya cursaron recientemente.                                      **
**   2. No tienen asignado un ejecutivo especialista.                   **
** - Se asigna "Cargable" a clientes cuando:                            **
**   1. El campo EJE_LEASING está vacío (NULL).                         **
**   2. Cumplen con condiciones adicionales como tener opción de        **
**      compra activa y ya estar marcados como "Cargable".              **
*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_05;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_05
(
     TD_CLI_RUT 						    DECIMAL(8,0)
    ,TC_NOM_CLI 						    VARCHAR (77)  CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_MACRO_BANCA 			            VARCHAR (16)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE 				  	            VARCHAR (12)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_IND_CTAS_CORRIENTES 	            INTEGER
    ,TE_COTIZA 						        INTEGER
    ,TD_PROB							    DECIMAL(25,10)
    ,TC_ESTADO_RECURRENCIA_LEASING	        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_OFERTA_REGLA					    DECIMAL(18,0)
    ,TD_MONTO_OFERTA     				    DECIMAL(18,0)
    ,TC_CAMPANA						        VARCHAR(50)	  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_POTENCIAL						    INTEGER
    ,TC_TIPO_BCA						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TRAMO_LEASING_MOB				    VARCHAR(255)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_LEASING					        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_NO_POTENCIAL					    INTEGER
    ,TE_PRIO                                INTEGER
    ,TE_ES_BCI                              INTEGER
    ,TE_MARCA_RUTGOB                        INTEGER
    ,TC_TEXTO1						        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2						        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE		        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA				        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO				        INTEGER
    ,TC_RECOMENDACION_DE_CRUCE 		        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TT_PERIODO_CALIFICACION			    TIMESTAMP(6) FORMAT 'YYYY-MM-DDBHH:MI:SS.S(6)'
    ,TD_PI_CLIENTE					        DECIMAL(25,10)
    ,TC_CLASIFICACION_SBIF			        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR							        INTEGER
    ,TE_COS_CLI						        INTEGER
    ,TE_FILTROS_RIESGOS 				    INTEGER
    ,TC_PAR_CALIFICACION_SBIF			    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE				        DECIMAL(25,10)
    ,TE_PAR_FDR						        INTEGER
    ,TE_PAR_COS_CLI					        INTEGER
    ,TE_MOLESTO						        BIGINT
    ,TE_CARGABLE 						    BIGINT
    ,TC_ELIMINADO						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS 						        BIGINT
    ,TE_PLAN_INVERSION 				        BIGINT
	,TE_NRO_OPT_PLAN_INVERSION				BIGINT
    ,TE_MTO_OPT_PLAN_INVERSION  		    BIGINT
    ,TC_PROD_1_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PROD_2_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MIN_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MAX_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CON_VENTAS 					        BIGINT
    ,TE_CON_VENTAS_ANT 				        BIGINT
    ,TE_LEASING_DATAMART 				    BIGINT
    ,TE_OPC_COMPRA 					        BIGINT
    ,TC_PER_OPC_COMPRA				        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ESTRATEGIA					        VARCHAR(9)    CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PERFIL			 			        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (TD_CLI_RUT)
;

.IF ERRORCODE <> 0 THEN .QUIT 20;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_05
SELECT 
	 LEA.TD_CLI_RUT     						AS TD_CLI_RUT     		                  
	,LEA.TC_NOM_CLI                             AS TC_NOM_CLI                   
	,LEA.TC_MACRO_BANCA                         AS TC_MACRO_BANCA               
	,LEA.TC_EJE                                 AS TC_EJE                       
	,LEA.TE_IND_CTAS_CORRIENTES                 AS TE_IND_CTAS_CORRIENTES       
	,LEA.TE_COTIZA                              AS TE_COTIZA                    
	,LEA.TD_PROB                                AS TD_PROB                      
	,LEA.TC_ESTADO_RECURRENCIA_LEASING          AS TC_ESTADO_RECURRENCIA_LEASING
	,LEA.TD_OFERTA_REGLA                        AS TD_OFERTA_REGLA              
	,LEA.TD_MONTO_OFERTA                        AS TD_MONTO_OFERTA              
	,LEA.TC_CAMPANA                             AS TC_CAMPANA                   
	,LEA.TE_POTENCIAL                           AS TE_POTENCIAL                 
	,LEA.TC_TIPO_BCA                            AS TC_TIPO_BCA                  
	,LEA.TC_TRAMO_LEASING_MOB                   AS TC_TRAMO_LEASING_MOB         
	,LEA.TC_EJE_LEASING                         AS TC_EJE_LEASING               
	,LEA.TE_NO_POTENCIAL                        AS TE_NO_POTENCIAL              
	,LEA.TE_PRIO                                AS TE_PRIO                      
	,LEA.TE_ES_BCI                              AS TE_ES_BCI                    
	,LEA.TE_MARCA_RUTGOB                        AS TE_MARCA_RUTGOB              
	,LEA.TC_TEXTO1                              AS TC_TEXTO1                    
	,LEA.TC_TEXTO2                              AS TC_TEXTO2                    
	,LEA.TC_CARACTERISTICAS_CLIENTE             AS TC_CARACTERISTICAS_CLIENTE   
	,LEA.TC_CAMPANA_OFERTA                      AS TC_CAMPANA_OFERTA            
	,LEA.TE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO           
	,LEA.TC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE    
	,LEA.TC_CALIFICACION_SBIF                   AS TC_CALIFICACION_SBIF         
	,LEA.TT_PERIODO_CALIFICACION                AS TT_PERIODO_CALIFICACION      
	,LEA.TD_PI_CLIENTE                          AS TD_PI_CLIENTE                
	,LEA.TC_CLASIFICACION_SBIF                  AS TC_CLASIFICACION_SBIF        
	,LEA.TE_FDR                                 AS TE_FDR                       
	,LEA.TE_COS_CLI                             AS TE_COS_CLI                   
	,LEA.TE_FILTROS_RIESGOS                     AS TE_FILTROS_RIESGOS           
	,LEA.TC_PAR_CALIFICACION_SBIF               AS TC_PAR_CALIFICACION_SBIF     
	,LEA.TD_PAR_PI_CLIENTE                      AS TD_PAR_PI_CLIENTE            
	,LEA.TE_PAR_FDR                             AS TE_PAR_FDR                   
	,LEA.TE_PAR_COS_CLI                         AS TE_PAR_COS_CLI               
	,LEA.TE_MOLESTO                             AS TE_MOLESTO                   
	,CASE 
    	WHEN LEA.TE_OPC_COMPRA > 0 
         	AND COALESCE(LEA.TE_CON_VENTAS,0) > 0
         	AND LEA.TC_PER_OPC_COMPRA < PAR.TE_PERIODO_CMP 
         	AND LEA.TE_CARGABLE = 1
    	THEN 0
    	WHEN LEA.TE_OPC_COMPRA > 0 
         	AND LEA.TC_EJE_LEASING IS NULL
         	AND LEA.TE_CARGABLE = 1
    THEN 0
    WHEN LEA.TC_EJE_LEASING IS NULL
         AND LEA.TE_CARGABLE = 1
    THEN 0
    ELSE LEA.TE_CARGABLE
 	END 										AS TE_CARGABLE                                                           
	,LEA.TC_ELIMINADO                           AS TC_ELIMINADO                 
	,LEA.TE_DUPLAS                              AS TE_DUPLAS                    
	,LEA.TE_PLAN_INVERSION                      AS TE_PLAN_INVERSION
	,LEA.TE_NRO_OPT_PLAN_INVERSION				AS TE_NRO_OPT_PLAN_INVERSION            
	,LEA.TE_MTO_OPT_PLAN_INVERSION              AS TE_MTO_OPT_PLAN_INVERSION    
	,LEA.TC_PROD_1_PLAN_INVERSION               AS TC_PROD_1_PLAN_INVERSION     
	,LEA.TC_PROD_2_PLAN_INVERSION               AS TC_PROD_2_PLAN_INVERSION     
	,LEA.TC_PER_MIN_PLAN_INVERSION              AS TC_PER_MIN_PLAN_INVERSION    
	,LEA.TC_PER_MAX_PLAN_INVERSION              AS TC_PER_MAX_PLAN_INVERSION    
	,LEA.TE_CON_VENTAS                          AS TE_CON_VENTAS                
	,LEA.TE_CON_VENTAS_ANT                      AS TE_CON_VENTAS_ANT            
	,LEA.TE_LEASING_DATAMART                    AS TE_LEASING_DATAMART          
	,LEA.TE_OPC_COMPRA                          AS TE_OPC_COMPRA                
	,LEA.TC_PER_OPC_COMPRA                      AS TC_PER_OPC_COMPRA            
	,LEA.TC_ESTRATEGIA                          AS TC_ESTRATEGIA                
	,LEA.TC_PERFIL                              AS TC_PERFIL	
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_04 AS LEA
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_LEA_CMP_LEA_WSB_MRC_PARAMETRO AS PAR
	ON 1 = 1  
;

.IF ERRORCODE <> 0 THEN .QUIT 21;


--/*************************************************************************
--** Se APLICAN FILTROS DE EMPRESAS NO DESEADAS A CARGAR 		 		  **  
--*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_LS;

CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_LS
(
 TD_RUT DECIMAL(8,0)
)UNIQUE PRIMARY INDEX (TD_RUT)
;

.IF ERRORCODE <> 0 THEN .QUIT 22;


INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_LS
SELECT IE_CLI_RUT AS TD_RUT
FROM MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CLIENTE_EJECUTIVO
WHERE IC_NOM_CLI = 'EMPRESAS JUAN YARUR SPA'
;
.IF ERRORCODE <> 0 THEN .QUIT 23;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_LS
SELECT IE_CLI_RUT AS TD_RUT
FROM MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CLIENTE_EJECUTIVO
WHERE IC_NOM_CLI = 'EMPRESAS JY S A'
;
.IF ERRORCODE <> 0 THEN .QUIT 24;

COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_LS;
	
.IF ERRORCODE <> 0 THEN .QUIT 25;

--/***************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_LEASING_WHOLESALE_MES					  	**  
--** CAMPO ELIMINADO, BAJO CIERTAS CONDICIONES Y FILTRANDO POR CARGABLE = 0	**
--***************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_MC;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_MC
(
     PD_CLI_RUT 						    DECIMAL(8,0)
    ,PC_NOM_CLI 						    VARCHAR (77)  CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_MACRO_BANCA 			            VARCHAR (16)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_EJE 				  	            VARCHAR (12)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_IND_CTAS_CORRIENTES 	            INTEGER
    ,PE_COTIZA 						        INTEGER
    ,PD_PROB							    DECIMAL(25,10)
    ,PC_ESTADO_RECURRENCIA_LEASING	        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_OFERTA_REGLA					    DECIMAL(18,0)
    ,PD_MONTO_OFERTA     				    DECIMAL(18,0)
    ,PC_CAMPANA						        VARCHAR(50)	  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_POTENCIAL						    INTEGER
    ,PC_TIPO_BCA						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TRAMO_LEASING_MOB				    VARCHAR(255)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_EJE_LEASING					        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_NO_POTENCIAL					    INTEGER
    ,PE_PRIO                                INTEGER
    ,PE_ES_BCI                              INTEGER
    ,PE_MARCA_RUTGOB                        INTEGER
    ,PC_TEXTO1						        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TEXTO2						        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CARACTERISTICAS_CLIENTE		        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_OFERTA				        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_EN_PLANEAMIENTO				        INTEGER
    ,PC_RECOMENDACION_DE_CRUCE 		        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CALIFICACION_SBIF				    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PT_PERIODO_CALIFICACION			    TIMESTAMP(6) FORMAT 'YYYY-MM-DDBHH:MI:SS.S(6)'
    ,PD_PI_CLIENTE					        DECIMAL(25,10)
    ,PC_CLASIFICACION_SBIF			        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_FDR							        INTEGER
    ,PE_COS_CLI						        INTEGER
    ,PE_FILTROS_RIESGOS 				    INTEGER
    ,PC_PAR_CALIFICACION_SBIF			    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_PAR_PI_CLIENTE				        DECIMAL(25,10)
    ,PE_PAR_FDR						        INTEGER
    ,PE_PAR_COS_CLI					        INTEGER
    ,PE_MOLESTO						        BIGINT
    ,PE_CARGABLE 						    BIGINT
    ,PC_ELIMINADO						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_DUPLAS 						        BIGINT
    ,PE_PLAN_INVERSION 				        BIGINT
	,PE_NRO_OPT_PLAN_INVERSION				BIGINT
    ,PE_MTO_OPT_PLAN_INVERSION  		    BIGINT
    ,PC_PROD_1_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_PROD_2_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_PER_MIN_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_PER_MAX_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_CON_VENTAS 					        BIGINT
    ,PE_CON_VENTAS_ANT 				        BIGINT
    ,PE_LEASING_DATAMART 				    BIGINT
    ,PE_OPC_COMPRA 					        BIGINT
    ,PC_PER_OPC_COMPRA				        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_ESTRATEGIA					        VARCHAR(9)    CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_PERFIL			 			        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (PD_CLI_RUT)
;

.IF ERRORCODE <> 0 THEN .QUIT 26;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_MC
SELECT
	 LEA.TD_CLI_RUT     						AS PD_CLI_RUT     		                  
	,LEA.TC_NOM_CLI                             AS PC_NOM_CLI                   
	,LEA.TC_MACRO_BANCA                         AS PC_MACRO_BANCA               
	,LEA.TC_EJE                                 AS PC_EJE                       
	,LEA.TE_IND_CTAS_CORRIENTES                 AS PE_IND_CTAS_CORRIENTES       
	,LEA.TE_COTIZA                              AS PE_COTIZA                    
	,LEA.TD_PROB                                AS PD_PROB                      
	,LEA.TC_ESTADO_RECURRENCIA_LEASING          AS PC_ESTADO_RECURRENCIA_LEASING
	,LEA.TD_OFERTA_REGLA                        AS PD_OFERTA_REGLA              
	,LEA.TD_MONTO_OFERTA                        AS PD_MONTO_OFERTA              
	,LEA.TC_CAMPANA                             AS PC_CAMPANA                   
	,LEA.TE_POTENCIAL                           AS PE_POTENCIAL                 
	,LEA.TC_TIPO_BCA                            AS PC_TIPO_BCA                  
	,LEA.TC_TRAMO_LEASING_MOB                   AS PC_TRAMO_LEASING_MOB         
	,LEA.TC_EJE_LEASING                         AS PC_EJE_LEASING               
	,LEA.TE_NO_POTENCIAL                        AS PE_NO_POTENCIAL              
	,LEA.TE_PRIO                                AS PE_PRIO                      
	,LEA.TE_ES_BCI                              AS PE_ES_BCI                    
	,LEA.TE_MARCA_RUTGOB                        AS PE_MARCA_RUTGOB              
	,LEA.TC_TEXTO1                              AS PC_TEXTO1                    
	,LEA.TC_TEXTO2                              AS PC_TEXTO2                    
	,LEA.TC_CARACTERISTICAS_CLIENTE             AS PC_CARACTERISTICAS_CLIENTE   
	,LEA.TC_CAMPANA_OFERTA                      AS PC_CAMPANA_OFERTA            
	,LEA.TE_EN_PLANEAMIENTO                     AS PE_EN_PLANEAMIENTO           
	,LEA.TC_RECOMENDACION_DE_CRUCE              AS PC_RECOMENDACION_DE_CRUCE    
	,LEA.TC_CALIFICACION_SBIF                   AS PC_CALIFICACION_SBIF         
	,LEA.TT_PERIODO_CALIFICACION                AS PT_PERIODO_CALIFICACION      
	,LEA.TD_PI_CLIENTE                          AS PD_PI_CLIENTE                
	,LEA.TC_CLASIFICACION_SBIF                  AS PC_CLASIFICACION_SBIF        
	,LEA.TE_FDR                                 AS PE_FDR                       
	,LEA.TE_COS_CLI                             AS PE_COS_CLI                   
	,LEA.TE_FILTROS_RIESGOS                     AS PE_FILTROS_RIESGOS           
	,LEA.TC_PAR_CALIFICACION_SBIF               AS PC_PAR_CALIFICACION_SBIF     
	,LEA.TD_PAR_PI_CLIENTE                      AS PD_PAR_PI_CLIENTE            
	,LEA.TE_PAR_FDR                             AS PE_PAR_FDR                   
	,LEA.TE_PAR_COS_CLI                         AS PE_PAR_COS_CLI               
	,LEA.TE_MOLESTO                             AS PE_MOLESTO                   
	,CASE
    WHEN FLT.TD_RUT IS NOT NULL THEN 0
    ELSE LEA.TE_CARGABLE
 	END 										AS PE_CARGABLE

,CASE 
    WHEN FLT.TD_RUT IS NOT NULL THEN 'CLIENTE EMPRESA YARUR'
    WHEN LEA.TE_CARGABLE = 0 THEN
        CASE
            WHEN LEA.TE_FILTROS_RIESGOS = 0 
				THEN '01.- FILTROS RIESGOS'
            WHEN LEA.TE_MARCA_RUTGOB > 0
				THEN '02.- RUT GUBERNAMENTAL'
            WHEN LEA.TE_ES_BCI > 0 
				THEN '03.- CLIENTE ES BCI'
            WHEN COALESCE(LEA.TC_EJE_LEASING,'0') = '0' 
				THEN '04.- SIN EJECUTIVO'
            WHEN LEA.TC_MACRO_BANCA NOT IN ('EMPRESARIOS','EMPRENDEDORES','EMPRESAS','GRANDES EMPRESAS','INMOBILIARIA') 
                THEN '05.- BANCA NO CORRESPONDE'
            WHEN COALESCE(LEA.TE_MOLESTO,0) > 0 
				THEN '06.- MOLESTOS'
            WHEN COALESCE(LEA.TE_IND_CTAS_CORRIENTES,0) = 0 
				THEN '09.- SIN CUENTA CORRIENTE'
            WHEN LEA.TE_PRIO = 0 
				THEN '10.- SIN PROP/PRIOR.'
            WHEN COALESCE(LEA.TE_CON_VENTAS,0) > 0 
				THEN '12.- CON VENTA LEASING ULTIMO TRIMESTRE'
            ELSE '' 
        END
    ELSE LEA.TC_ELIMINADO
	END 										AS PC_ELIMINADO                 
	,LEA.TE_DUPLAS                              AS PE_DUPLAS                    
	,LEA.TE_PLAN_INVERSION                      AS PE_PLAN_INVERSION
	,LEA.TE_NRO_OPT_PLAN_INVERSION				AS PE_NRO_OPT_PLAN_INVERSION            
	,LEA.TE_MTO_OPT_PLAN_INVERSION              AS PE_MTO_OPT_PLAN_INVERSION    
	,LEA.TC_PROD_1_PLAN_INVERSION               AS PC_PROD_1_PLAN_INVERSION     
	,LEA.TC_PROD_2_PLAN_INVERSION               AS PC_PROD_2_PLAN_INVERSION     
	,LEA.TC_PER_MIN_PLAN_INVERSION              AS PC_PER_MIN_PLAN_INVERSION    
	,LEA.TC_PER_MAX_PLAN_INVERSION              AS PC_PER_MAX_PLAN_INVERSION    
	,LEA.TE_CON_VENTAS                          AS PE_CON_VENTAS                
	,LEA.TE_CON_VENTAS_ANT                      AS PE_CON_VENTAS_ANT            
	,LEA.TE_LEASING_DATAMART                    AS PE_LEASING_DATAMART          
	,LEA.TE_OPC_COMPRA                          AS PE_OPC_COMPRA                
	,LEA.TC_PER_OPC_COMPRA                      AS PC_PER_OPC_COMPRA            
	,LEA.TC_ESTRATEGIA                          AS PC_ESTRATEGIA                
	,LEA.TC_PERFIL                              AS PC_PERFIL
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_05 AS LEA
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_LS AS FLT
	ON LEA.TD_CLI_RUT = FLT.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 27;

SELECT DATE, TIME;
.LOGOFF;
.QUIT 0;

UPDATE - Ejemplo 18 A OK.sql

--/***********************************************************************************************************
--************************************************************************************************************
--** DSCRPCN: PROCESO DE CAMPANA LEASING WHOLESALE QUE ACTUALIZA LOS LITERALES (ETAPA A)                    **
--**                                                    				 				                    **
--** AUTOR  : CESAR ROMERO MUNOZ                                               			                    **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				                    **
--** FECHA  : 05/2022                                                   				                    **
--***********************************************************************************************************/
--/***********************************************************************************************************
--** MANTNCN: Normalización BTEQ														                    **
--** AUTOR  : MATIAS JORQUERA															                    **
--** EMPRESA: FACTOR IT																  	                    **
--** FECHA  : 12/2024																	                    **
--/***********************************************************************************************************
--**TABLA DE ENTRADA:	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_MC	**
--**                                        											                    **
--**                  											                                            **
--** TABLA DE SALIDA:	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_05         	**
--**                  					  												                    **
--************************************************************************************************************
--***********************************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/***********************************************************************
--** ACTUALIZACION DE LITERALES - CAMPANA_LEASING_WHOLESALE_MES			**
--** SE ACTUALIZA VALORES PARA TEXTO1, TEXTO2 Y CARACTERISTICAS_CLIENTE **  
--***********************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_01
(
     TD_CLI_RUT 						    DECIMAL(8,0)
    ,TC_NOM_CLI 						    VARCHAR (77)  CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_MACRO_BANCA 			            VARCHAR (16)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE 				  	            VARCHAR (12)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_IND_CTAS_CORRIENTES 	            INTEGER
    ,TE_COTIZA 						        INTEGER
    ,TD_PROB							    DECIMAL(25,10)
    ,TC_ESTADO_RECURRENCIA_LEASING	        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_OFERTA_REGLA					    DECIMAL(18,0)
    ,TD_MONTO_OFERTA     				    DECIMAL(18,0)
    ,TC_CAMPANA						        VARCHAR(50)	  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_POTENCIAL						    INTEGER
    ,TC_TIPO_BCA						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TRAMO_LEASING_MOB				    VARCHAR(255)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_LEASING					        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_NO_POTENCIAL					    INTEGER
    ,TE_PRIO                                INTEGER
    ,TE_ES_BCI                              INTEGER
    ,TE_MARCA_RUTGOB                        INTEGER
    ,TC_TEXTO1						        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2						        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE		        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA				        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO				        INTEGER
    ,TC_RECOMENDACION_DE_CRUCE 		        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TT_PERIODO_CALIFICACION			    TIMESTAMP(6) FORMAT 'YYYY-MM-DDBHH:MI:SS.S(6)'
    ,TD_PI_CLIENTE					        DECIMAL(25,10)
    ,TC_CLASIFICACION_SBIF			        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR							        INTEGER
    ,TE_COS_CLI						        INTEGER
    ,TE_FILTROS_RIESGOS 				    INTEGER
    ,TC_PAR_CALIFICACION_SBIF			    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE				        DECIMAL(25,10)
    ,TE_PAR_FDR						        INTEGER
    ,TE_PAR_COS_CLI					        INTEGER
    ,TE_MOLESTO						        BIGINT
    ,TE_CARGABLE 						    BIGINT
    ,TC_ELIMINADO						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS 						        BIGINT
    ,TE_PLAN_INVERSION 				        BIGINT
    ,TE_NRO_OPT_PLAN_INVERSION              BIGINT
    ,TE_MTO_OPT_PLAN_INVERSION  		    BIGINT
    ,TC_PROD_1_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PROD_2_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MIN_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MAX_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CON_VENTAS 					        BIGINT
    ,TE_CON_VENTAS_ANT 				        BIGINT
    ,TE_LEASING_DATAMART 				    BIGINT
    ,TE_OPC_COMPRA 					        BIGINT
    ,TC_PER_OPC_COMPRA				        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ESTRATEGIA					        VARCHAR(9)    CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PERFIL			 			        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (TD_CLI_RUT)
;

.IF ERRORCODE <> 0 THEN .QUIT 1;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_01
SELECT
	 MC1.PD_CLI_RUT     						AS TD_CLI_RUT     		                  
	,MC1.PC_NOM_CLI                             AS TC_NOM_CLI                   
	,MC1.PC_MACRO_BANCA                         AS TC_MACRO_BANCA               
	,MC1.PC_EJE                                 AS TC_EJE                       
	,MC1.PE_IND_CTAS_CORRIENTES                 AS TE_IND_CTAS_CORRIENTES       
	,MC1.PE_COTIZA                              AS TE_COTIZA                    
	,MC1.PD_PROB                                AS TD_PROB                      
	,MC1.PC_ESTADO_RECURRENCIA_LEASING          AS TC_ESTADO_RECURRENCIA_LEASING
	,MC1.PD_OFERTA_REGLA                        AS TD_OFERTA_REGLA              
	,MC1.PD_MONTO_OFERTA                        AS TD_MONTO_OFERTA              
	,MC1.PC_CAMPANA                             AS TC_CAMPANA                   
	,MC1.PE_POTENCIAL                           AS TE_POTENCIAL                 
	,MC1.PC_TIPO_BCA                            AS TC_TIPO_BCA                  
	,MC1.PC_TRAMO_LEASING_MOB                   AS TC_TRAMO_LEASING_MOB         
	,MC1.PC_EJE_LEASING                         AS TC_EJE_LEASING               
	,MC1.PE_NO_POTENCIAL                        AS TE_NO_POTENCIAL              
	,MC1.PE_PRIO                                AS TE_PRIO                      
	,MC1.PE_ES_BCI                              AS TE_ES_BCI                    
	,MC1.PE_MARCA_RUTGOB                        AS TE_MARCA_RUTGOB              
	,CASE 
    WHEN MC1.PC_TIPO_BCA = 'WSB'
		 THEN
        	CASE
			WHEN MC1.PD_MONTO_OFERTA > 0 
            	THEN 'CLIENTE CON LINEA VIGENTE LEASING POR UF$' ||
                 OREPLACE(OREPLACE(OREPLACE(
                 CAST(CAST(CAST(MC1.PD_MONTO_OFERTA AS BIGINT) AS FORMAT 'G-(18)9') AS VARCHAR(50))
                 ,',','Q'),'.',','),'Q','.')|| ' (VALIDAR MARGENES)'
            ELSE '' 
        	END
    ELSE MC1.PC_TEXTO1
 	END 										AS TC_TEXTO1

	,CASE 
    WHEN MC1.PC_TIPO_BCA = 'WSB'
		THEN
        	CASE
			WHEN MC1.PE_COTIZA = 1 
            	THEN ', COTIZO Y NO COMPRO LEASING EN EL MES ANTERIOR' 
            ELSE ', CON PROPENSION LEASING ' 
        END
    ELSE MC1.PC_TEXTO2
 	END 										AS TC_TEXTO2

	,CASE 
    WHEN PC_TIPO_BCA = 'WSB'
		THEN
        	CASE
			WHEN MC1.PE_COTIZA = 1  
            	THEN 'COTIZA EN EL MES ANTERIOR Y NO COMPRA ' 
            ELSE '' 
        END
    ELSE MC1.PC_CARACTERISTICAS_CLIENTE
 	END 										AS TC_CARACTERISTICAS_CLIENTE   
	,MC1.PC_CAMPANA_OFERTA                      AS TC_CAMPANA_OFERTA            
	,MC1.PE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO           
	,MC1.PC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE    
	,MC1.PC_CALIFICACION_SBIF                   AS TC_CALIFICACION_SBIF         
	,MC1.PT_PERIODO_CALIFICACION                AS TT_PERIODO_CALIFICACION      
	,MC1.PD_PI_CLIENTE                          AS TD_PI_CLIENTE                
	,MC1.PC_CLASIFICACION_SBIF                  AS TC_CLASIFICACION_SBIF        
	,MC1.PE_FDR                                 AS TE_FDR                       
	,MC1.PE_COS_CLI                             AS TE_COS_CLI                   
	,MC1.PE_FILTROS_RIESGOS                     AS TE_FILTROS_RIESGOS           
	,MC1.PC_PAR_CALIFICACION_SBIF               AS TC_PAR_CALIFICACION_SBIF     
	,MC1.PD_PAR_PI_CLIENTE                      AS TD_PAR_PI_CLIENTE            
	,MC1.PE_PAR_FDR                             AS TE_PAR_FDR                   
	,MC1.PE_PAR_COS_CLI                         AS TE_PAR_COS_CLI               
	,MC1.PE_MOLESTO                             AS TE_MOLESTO                   
	,MC1.PE_CARGABLE                            AS TE_CARGABLE                  
	,MC1.PC_ELIMINADO                           AS TC_ELIMINADO                 
	,MC1.PE_DUPLAS                              AS TE_DUPLAS                    
	,MC1.PE_PLAN_INVERSION                      AS TE_PLAN_INVERSION
	,MC1.PE_NRO_OPT_PLAN_INVERSION				AS TE_NRO_OPT_PLAN_INVERSION
	,MC1.PE_MTO_OPT_PLAN_INVERSION              AS TE_MTO_OPT_PLAN_INVERSION    
	,MC1.PC_PROD_1_PLAN_INVERSION               AS TC_PROD_1_PLAN_INVERSION     
	,MC1.PC_PROD_2_PLAN_INVERSION               AS TC_PROD_2_PLAN_INVERSION     
	,MC1.PC_PER_MIN_PLAN_INVERSION              AS TC_PER_MIN_PLAN_INVERSION    
	,MC1.PC_PER_MAX_PLAN_INVERSION              AS TC_PER_MAX_PLAN_INVERSION    
	,MC1.PE_CON_VENTAS                          AS TE_CON_VENTAS                
	,MC1.PE_CON_VENTAS_ANT                      AS TE_CON_VENTAS_ANT            
	,MC1.PE_LEASING_DATAMART                    AS TE_LEASING_DATAMART          
	,MC1.PE_OPC_COMPRA                          AS TE_OPC_COMPRA                
	,MC1.PC_PER_OPC_COMPRA                      AS TC_PER_OPC_COMPRA            
	,MC1.PC_ESTRATEGIA                          AS TC_ESTRATEGIA                
	,MC1.PC_PERFIL                              AS TC_PERFIL
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_MC AS MC1
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_01;

.IF ERRORCODE <> 0 THEN .QUIT 3;

--/***********************************************************************
--** ACTUALIZACION DE LITERALES - CAMPANA_LEASING_WHOLESALE_MES			**
--** SE ACTUALIZA VALORES PARA TEXTO1 - ESTRATEGIA 						**  
--***********************************************************************/	

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_02;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_02
(
     TD_CLI_RUT 						    DECIMAL(8,0)
    ,TC_NOM_CLI 						    VARCHAR (77)  CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_MACRO_BANCA 			            VARCHAR (16)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE 				  	            VARCHAR (12)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_IND_CTAS_CORRIENTES 	            INTEGER
    ,TE_COTIZA 						        INTEGER
    ,TD_PROB							    DECIMAL(25,10)
    ,TC_ESTADO_RECURRENCIA_LEASING	        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_OFERTA_REGLA					    DECIMAL(18,0)
    ,TD_MONTO_OFERTA     				    DECIMAL(18,0)
    ,TC_CAMPANA						        VARCHAR(50)	  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_POTENCIAL						    INTEGER
    ,TC_TIPO_BCA						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TRAMO_LEASING_MOB				    VARCHAR(255)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_LEASING					        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_NO_POTENCIAL					    INTEGER
    ,TE_PRIO                                INTEGER
    ,TE_ES_BCI                              INTEGER
    ,TE_MARCA_RUTGOB                        INTEGER
    ,TC_TEXTO1						        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2						        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE		        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA				        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO				        INTEGER
    ,TC_RECOMENDACION_DE_CRUCE 		        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TT_PERIODO_CALIFICACION			    TIMESTAMP(6) FORMAT 'YYYY-MM-DDBHH:MI:SS.S(6)'
    ,TD_PI_CLIENTE					        DECIMAL(25,10)
    ,TC_CLASIFICACION_SBIF			        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR							        INTEGER
    ,TE_COS_CLI						        INTEGER
    ,TE_FILTROS_RIESGOS 				    INTEGER
    ,TC_PAR_CALIFICACION_SBIF			    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE				        DECIMAL(25,10)
    ,TE_PAR_FDR						        INTEGER
    ,TE_PAR_COS_CLI					        INTEGER
    ,TE_MOLESTO						        BIGINT
    ,TE_CARGABLE 						    BIGINT
    ,TC_ELIMINADO						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS 						        BIGINT
    ,TE_PLAN_INVERSION 				        BIGINT
    ,TE_NRO_OPT_PLAN_INVERSION              BIGINT
    ,TE_MTO_OPT_PLAN_INVERSION  		    BIGINT
    ,TC_PROD_1_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PROD_2_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MIN_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MAX_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CON_VENTAS 					        BIGINT
    ,TE_CON_VENTAS_ANT 				        BIGINT
    ,TE_LEASING_DATAMART 				    BIGINT
    ,TE_OPC_COMPRA 					        BIGINT
    ,TC_PER_OPC_COMPRA				        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ESTRATEGIA					        VARCHAR(9)    CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PERFIL			 			        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (TD_CLI_RUT)
;

.IF ERRORCODE <> 0 THEN .QUIT 4;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_02
SELECT
	 LIT1.TD_CLI_RUT     						 AS TD_CLI_RUT     		                  
	,LIT1.TC_NOM_CLI                             AS TC_NOM_CLI                   
	,LIT1.TC_MACRO_BANCA                         AS TC_MACRO_BANCA               
	,LIT1.TC_EJE                                 AS TC_EJE                       
	,LIT1.TE_IND_CTAS_CORRIENTES                 AS TE_IND_CTAS_CORRIENTES       
	,LIT1.TE_COTIZA                              AS TE_COTIZA                    
	,LIT1.TD_PROB                                AS TD_PROB                      
	,LIT1.TC_ESTADO_RECURRENCIA_LEASING          AS TC_ESTADO_RECURRENCIA_LEASING
	,LIT1.TD_OFERTA_REGLA                        AS TD_OFERTA_REGLA              
	,LIT1.TD_MONTO_OFERTA                        AS TD_MONTO_OFERTA              
	,LIT1.TC_CAMPANA                             AS TC_CAMPANA                   
	,LIT1.TE_POTENCIAL                           AS TE_POTENCIAL                 
	,LIT1.TC_TIPO_BCA                            AS TC_TIPO_BCA                  
	,LIT1.TC_TRAMO_LEASING_MOB                   AS TC_TRAMO_LEASING_MOB         
	,LIT1.TC_EJE_LEASING                         AS TC_EJE_LEASING               
	,LIT1.TE_NO_POTENCIAL                        AS TE_NO_POTENCIAL              
	,LIT1.TE_PRIO                                AS TE_PRIO                      
	,LIT1.TE_ES_BCI                              AS TE_ES_BCI                    
	,LIT1.TE_MARCA_RUTGOB                        AS TE_MARCA_RUTGOB              
	,CASE 
    WHEN LIT1.TC_TIPO_BCA = 'WSB' 
	THEN
        'CLIENTE CON ESTRATEGIA : (' ||
        CASE WHEN LIT1.TC_ESTRATEGIA = '' 
            THEN 'S/I' 
            ELSE RTRIM(LIT1.TC_ESTRATEGIA) 
        END ||
        CASE WHEN LIT1.TC_PERFIL = 'POTENCIADO' 
            THEN '+' 
            ELSE '' 
        END ||
        '). ' || RTRIM(LIT1.TC_TEXTO1)
    ELSE LIT1.TC_TEXTO1
 	END 										 AS TC_TEXTO1                    
	,LIT1.TC_TEXTO2                              AS TC_TEXTO2                    
	,LIT1.TC_CARACTERISTICAS_CLIENTE             AS TC_CARACTERISTICAS_CLIENTE   
	,LIT1.TC_CAMPANA_OFERTA                      AS TC_CAMPANA_OFERTA            
	,LIT1.TE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO           
	,LIT1.TC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE    
	,LIT1.TC_CALIFICACION_SBIF                   AS TC_CALIFICACION_SBIF         
	,LIT1.TT_PERIODO_CALIFICACION                AS TT_PERIODO_CALIFICACION      
	,LIT1.TD_PI_CLIENTE                          AS TD_PI_CLIENTE                
	,LIT1.TC_CLASIFICACION_SBIF                  AS TC_CLASIFICACION_SBIF        
	,LIT1.TE_FDR                                 AS TE_FDR                       
	,LIT1.TE_COS_CLI                             AS TE_COS_CLI                   
	,LIT1.TE_FILTROS_RIESGOS                     AS TE_FILTROS_RIESGOS           
	,LIT1.TC_PAR_CALIFICACION_SBIF               AS TC_PAR_CALIFICACION_SBIF     
	,LIT1.TD_PAR_PI_CLIENTE                      AS TD_PAR_PI_CLIENTE            
	,LIT1.TE_PAR_FDR                             AS TE_PAR_FDR                   
	,LIT1.TE_PAR_COS_CLI                         AS TE_PAR_COS_CLI               
	,LIT1.TE_MOLESTO                             AS TE_MOLESTO                   
	,LIT1.TE_CARGABLE                            AS TE_CARGABLE                  
	,LIT1.TC_ELIMINADO                           AS TC_ELIMINADO                 
	,LIT1.TE_DUPLAS                              AS TE_DUPLAS                    
	,LIT1.TE_PLAN_INVERSION                      AS TE_PLAN_INVERSION
	,LIT1.TE_NRO_OPT_PLAN_INVERSION				 AS TE_NRO_OPT_PLAN_INVERSION
	,LIT1.TE_MTO_OPT_PLAN_INVERSION              AS TE_MTO_OPT_PLAN_INVERSION    
	,LIT1.TC_PROD_1_PLAN_INVERSION               AS TC_PROD_1_PLAN_INVERSION     
	,LIT1.TC_PROD_2_PLAN_INVERSION               AS TC_PROD_2_PLAN_INVERSION     
	,LIT1.TC_PER_MIN_PLAN_INVERSION              AS TC_PER_MIN_PLAN_INVERSION    
	,LIT1.TC_PER_MAX_PLAN_INVERSION              AS TC_PER_MAX_PLAN_INVERSION    
	,LIT1.TE_CON_VENTAS                          AS TE_CON_VENTAS                
	,LIT1.TE_CON_VENTAS_ANT                      AS TE_CON_VENTAS_ANT            
	,LIT1.TE_LEASING_DATAMART                    AS TE_LEASING_DATAMART          
	,LIT1.TE_OPC_COMPRA                          AS TE_OPC_COMPRA                
	,LIT1.TC_PER_OPC_COMPRA                      AS TC_PER_OPC_COMPRA            
	,LIT1.TC_ESTRATEGIA                          AS TC_ESTRATEGIA                
	,LIT1.TC_PERFIL                              AS TC_PERFIL
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_01 AS LIT1
;

.IF ERRORCODE <> 0 THEN .QUIT 5;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_02;

.IF ERRORCODE <> 0 THEN .QUIT 6;

--/***********************************************************************
--** ACTUALIZACION DE LITERALES - CAMPANA_LEASING_WHOLESALE_MES			**
--** SE ACTUALIZA VALORES PARA TEXTO1 - ESTRATEGIA 						**  
--***********************************************************************/	

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_03;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_03
(
     TD_CLI_RUT 						    DECIMAL(8,0)
    ,TC_NOM_CLI 						    VARCHAR (77)  CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_MACRO_BANCA 			            VARCHAR (16)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE 				  	            VARCHAR (12)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_IND_CTAS_CORRIENTES 	            INTEGER
    ,TE_COTIZA 						        INTEGER
    ,TD_PROB							    DECIMAL(25,10)
    ,TC_ESTADO_RECURRENCIA_LEASING	        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_OFERTA_REGLA					    DECIMAL(18,0)
    ,TD_MONTO_OFERTA     				    DECIMAL(18,0)
    ,TC_CAMPANA						        VARCHAR(50)	  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_POTENCIAL						    INTEGER
    ,TC_TIPO_BCA						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TRAMO_LEASING_MOB				    VARCHAR(255)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_LEASING					        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_NO_POTENCIAL					    INTEGER
    ,TE_PRIO                                INTEGER
    ,TE_ES_BCI                              INTEGER
    ,TE_MARCA_RUTGOB                        INTEGER
    ,TC_TEXTO1						        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2						        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE		        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA				        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO				        INTEGER
    ,TC_RECOMENDACION_DE_CRUCE 		        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TT_PERIODO_CALIFICACION			    TIMESTAMP(6) FORMAT 'YYYY-MM-DDBHH:MI:SS.S(6)'
    ,TD_PI_CLIENTE					        DECIMAL(25,10)
    ,TC_CLASIFICACION_SBIF			        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR							        INTEGER
    ,TE_COS_CLI						        INTEGER
    ,TE_FILTROS_RIESGOS 				    INTEGER
    ,TC_PAR_CALIFICACION_SBIF			    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE				        DECIMAL(25,10)
    ,TE_PAR_FDR						        INTEGER
    ,TE_PAR_COS_CLI					        INTEGER
    ,TE_MOLESTO						        BIGINT
    ,TE_CARGABLE 						    BIGINT
    ,TC_ELIMINADO						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS 						        BIGINT
    ,TE_PLAN_INVERSION 				        BIGINT
    ,TE_NRO_OPT_PLAN_INVERSION              BIGINT
    ,TE_MTO_OPT_PLAN_INVERSION  		    BIGINT
    ,TC_PROD_1_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PROD_2_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MIN_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MAX_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CON_VENTAS 					        BIGINT
    ,TE_CON_VENTAS_ANT 				        BIGINT
    ,TE_LEASING_DATAMART 				    BIGINT
    ,TE_OPC_COMPRA 					        BIGINT
    ,TC_PER_OPC_COMPRA				        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ESTRATEGIA					        VARCHAR(9)    CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PERFIL			 			        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (TD_CLI_RUT)
;

.IF ERRORCODE <> 0 THEN .QUIT 7;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_03
SELECT
	 LIT2.TD_CLI_RUT     						 AS TD_CLI_RUT     		                  
	,LIT2.TC_NOM_CLI                             AS TC_NOM_CLI                   
	,LIT2.TC_MACRO_BANCA                         AS TC_MACRO_BANCA               
	,LIT2.TC_EJE                                 AS TC_EJE                       
	,LIT2.TE_IND_CTAS_CORRIENTES                 AS TE_IND_CTAS_CORRIENTES       
	,LIT2.TE_COTIZA                              AS TE_COTIZA                    
	,LIT2.TD_PROB                                AS TD_PROB                      
	,LIT2.TC_ESTADO_RECURRENCIA_LEASING          AS TC_ESTADO_RECURRENCIA_LEASING
	,LIT2.TD_OFERTA_REGLA                        AS TD_OFERTA_REGLA              
	,LIT2.TD_MONTO_OFERTA                        AS TD_MONTO_OFERTA              
	,LIT2.TC_CAMPANA                             AS TC_CAMPANA                   
	,LIT2.TE_POTENCIAL                           AS TE_POTENCIAL                 
	,LIT2.TC_TIPO_BCA                            AS TC_TIPO_BCA                  
	,LIT2.TC_TRAMO_LEASING_MOB                   AS TC_TRAMO_LEASING_MOB         
	,LIT2.TC_EJE_LEASING                         AS TC_EJE_LEASING               
	,LIT2.TE_NO_POTENCIAL                        AS TE_NO_POTENCIAL              
	,LIT2.TE_PRIO                                AS TE_PRIO                      
	,LIT2.TE_ES_BCI                              AS TE_ES_BCI                    
	,LIT2.TE_MARCA_RUTGOB                        AS TE_MARCA_RUTGOB              
	,CASE 
    WHEN LIT2.TC_TIPO_BCA = 'WSB' THEN
        RTRIM(LIT2.TC_TEXTO1) || ' ' ||
        CASE WHEN LIT2.TE_PLAN_INVERSION > 0 
            THEN ', EN PLAN INVERSION ' ||
                CASE WHEN LIT2.TC_PER_MIN_PLAN_INVERSION = LIT2.TC_PER_MAX_PLAN_INVERSION 
                    THEN 'EN ' || RTRIM(LIT2.TC_PER_MIN_PLAN_INVERSION) 
                    ELSE 'ENTRE ' || RTRIM(LIT2.TC_PER_MIN_PLAN_INVERSION) ||
                         ' Y ' || RTRIM(LIT2.TC_PER_MAX_PLAN_INVERSION) 
                END ||
                ', (TOTAL OPT. ' || RTRIM(LIT2.TE_NRO_OPT_PLAN_INVERSION) ||
                '), (EN ' || RTRIM(LIT2.TC_PROD_1_PLAN_INVERSION) || ' ' ||
                RTRIM(LIT2.TC_PROD_2_PLAN_INVERSION) || ',POR $' ||
                OREPLACE(OREPLACE(OREPLACE(
                CAST(CAST(LIT2.TE_MTO_OPT_PLAN_INVERSION AS FORMAT 'G-(18)D9(2)') AS VARCHAR(100))
                ,',','Q'),'.',','),'Q','.') || ')' 
            ELSE '' 
        END
    ELSE LIT2.TC_TEXTO1
 	END 										 AS TC_TEXTO1                    
	,LIT2.TC_TEXTO2                              AS TC_TEXTO2                    
	,LIT2.TC_CARACTERISTICAS_CLIENTE             AS TC_CARACTERISTICAS_CLIENTE   
	,LIT2.TC_CAMPANA_OFERTA                      AS TC_CAMPANA_OFERTA            
	,LIT2.TE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO           
	,LIT2.TC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE    
	,LIT2.TC_CALIFICACION_SBIF                   AS TC_CALIFICACION_SBIF         
	,LIT2.TT_PERIODO_CALIFICACION                AS TT_PERIODO_CALIFICACION      
	,LIT2.TD_PI_CLIENTE                          AS TD_PI_CLIENTE                
	,LIT2.TC_CLASIFICACION_SBIF                  AS TC_CLASIFICACION_SBIF        
	,LIT2.TE_FDR                                 AS TE_FDR                       
	,LIT2.TE_COS_CLI                             AS TE_COS_CLI                   
	,LIT2.TE_FILTROS_RIESGOS                     AS TE_FILTROS_RIESGOS           
	,LIT2.TC_PAR_CALIFICACION_SBIF               AS TC_PAR_CALIFICACION_SBIF     
	,LIT2.TD_PAR_PI_CLIENTE                      AS TD_PAR_PI_CLIENTE            
	,LIT2.TE_PAR_FDR                             AS TE_PAR_FDR                   
	,LIT2.TE_PAR_COS_CLI                         AS TE_PAR_COS_CLI               
	,LIT2.TE_MOLESTO                             AS TE_MOLESTO                   
	,LIT2.TE_CARGABLE                            AS TE_CARGABLE                  
	,LIT2.TC_ELIMINADO                           AS TC_ELIMINADO                 
	,LIT2.TE_DUPLAS                              AS TE_DUPLAS                    
	,LIT2.TE_PLAN_INVERSION                      AS TE_PLAN_INVERSION
	,LIT2.TE_NRO_OPT_PLAN_INVERSION				 AS TE_NRO_OPT_PLAN_INVERSION
	,LIT2.TE_MTO_OPT_PLAN_INVERSION              AS TE_MTO_OPT_PLAN_INVERSION    
	,LIT2.TC_PROD_1_PLAN_INVERSION               AS TC_PROD_1_PLAN_INVERSION     
	,LIT2.TC_PROD_2_PLAN_INVERSION               AS TC_PROD_2_PLAN_INVERSION     
	,LIT2.TC_PER_MIN_PLAN_INVERSION              AS TC_PER_MIN_PLAN_INVERSION    
	,LIT2.TC_PER_MAX_PLAN_INVERSION              AS TC_PER_MAX_PLAN_INVERSION    
	,LIT2.TE_CON_VENTAS                          AS TE_CON_VENTAS                
	,LIT2.TE_CON_VENTAS_ANT                      AS TE_CON_VENTAS_ANT            
	,LIT2.TE_LEASING_DATAMART                    AS TE_LEASING_DATAMART          
	,LIT2.TE_OPC_COMPRA                          AS TE_OPC_COMPRA                
	,LIT2.TC_PER_OPC_COMPRA                      AS TC_PER_OPC_COMPRA            
	,LIT2.TC_ESTRATEGIA                          AS TC_ESTRATEGIA                
	,LIT2.TC_PERFIL                              AS TC_PERFIL
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_02 AS LIT2
;

.IF ERRORCODE <> 0 THEN .QUIT 8;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_03;

.IF ERRORCODE <> 0 THEN .QUIT 9;


/*************************************************************************
** ACTUALIZACIÓN DE DATOS PARA LA TABLA CAMPANA_LEASING_WHOLESALE_MES:   **
** - Se actualizan los valores del campo "Texto1" para incluir clientes **
**   que no tienen ofertas activas pero presentan propensión.           **
** - Se modifica campo CARACTERISTICAS_CLIENTE en función de            **
**   los criterios establecidos para la campaña.                        **
*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_04;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_04
(
     TD_CLI_RUT 						    DECIMAL(8,0)
    ,TC_NOM_CLI 						    VARCHAR (77)  CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_MACRO_BANCA 			            VARCHAR (16)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE 				  	            VARCHAR (12)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_IND_CTAS_CORRIENTES 	            INTEGER
    ,TE_COTIZA 						        INTEGER
    ,TD_PROB							    DECIMAL(25,10)
    ,TC_ESTADO_RECURRENCIA_LEASING	        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_OFERTA_REGLA					    DECIMAL(18,0)
    ,TD_MONTO_OFERTA     				    DECIMAL(18,0)
    ,TC_CAMPANA						        VARCHAR(50)	  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_POTENCIAL						    INTEGER
    ,TC_TIPO_BCA						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TRAMO_LEASING_MOB				    VARCHAR(255)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_LEASING					        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_NO_POTENCIAL					    INTEGER
    ,TE_PRIO                                INTEGER
    ,TE_ES_BCI                              INTEGER
    ,TE_MARCA_RUTGOB                        INTEGER
    ,TC_TEXTO1						        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2						        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE		        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA				        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO				        INTEGER
    ,TC_RECOMENDACION_DE_CRUCE 		        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TT_PERIODO_CALIFICACION			    TIMESTAMP(6) FORMAT 'YYYY-MM-DDBHH:MI:SS.S(6)'
    ,TD_PI_CLIENTE					        DECIMAL(25,10)
    ,TC_CLASIFICACION_SBIF			        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR							        INTEGER
    ,TE_COS_CLI						        INTEGER
    ,TE_FILTROS_RIESGOS 				    INTEGER
    ,TC_PAR_CALIFICACION_SBIF			    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE				        DECIMAL(25,10)
    ,TE_PAR_FDR						        INTEGER
    ,TE_PAR_COS_CLI					        INTEGER
    ,TE_MOLESTO						        BIGINT
    ,TE_CARGABLE 						    BIGINT
    ,TC_ELIMINADO						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS 						        BIGINT
    ,TE_PLAN_INVERSION 				        BIGINT
    ,TE_NRO_OPT_PLAN_INVERSION              BIGINT
    ,TE_MTO_OPT_PLAN_INVERSION  		    BIGINT
    ,TC_PROD_1_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PROD_2_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MIN_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MAX_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CON_VENTAS 					        BIGINT
    ,TE_CON_VENTAS_ANT 				        BIGINT
    ,TE_LEASING_DATAMART 				    BIGINT
    ,TE_OPC_COMPRA 					        BIGINT
    ,TC_PER_OPC_COMPRA				        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ESTRATEGIA					        VARCHAR(9)    CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PERFIL			 			        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (TD_CLI_RUT)
;

.IF ERRORCODE <> 0 THEN .QUIT 10;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_04
SELECT
	 LIT3.TD_CLI_RUT     						 AS TD_CLI_RUT     		                  
	,LIT3.TC_NOM_CLI                             AS TC_NOM_CLI                   
	,LIT3.TC_MACRO_BANCA                         AS TC_MACRO_BANCA               
	,LIT3.TC_EJE                                 AS TC_EJE                       
	,LIT3.TE_IND_CTAS_CORRIENTES                 AS TE_IND_CTAS_CORRIENTES       
	,LIT3.TE_COTIZA                              AS TE_COTIZA                    
	,LIT3.TD_PROB                                AS TD_PROB                      
	,LIT3.TC_ESTADO_RECURRENCIA_LEASING          AS TC_ESTADO_RECURRENCIA_LEASING
	,LIT3.TD_OFERTA_REGLA                        AS TD_OFERTA_REGLA              
	,LIT3.TD_MONTO_OFERTA                        AS TD_MONTO_OFERTA              
	,LIT3.TC_CAMPANA                             AS TC_CAMPANA                   
	,LIT3.TE_POTENCIAL                           AS TE_POTENCIAL                 
	,LIT3.TC_TIPO_BCA                            AS TC_TIPO_BCA                  
	,LIT3.TC_TRAMO_LEASING_MOB                   AS TC_TRAMO_LEASING_MOB         
	,LIT3.TC_EJE_LEASING                         AS TC_EJE_LEASING               
	,LIT3.TE_NO_POTENCIAL                        AS TE_NO_POTENCIAL              
	,LIT3.TE_PRIO                                AS TE_PRIO                      
	,LIT3.TE_ES_BCI                              AS TE_ES_BCI                    
	,LIT3.TE_MARCA_RUTGOB                        AS TE_MARCA_RUTGOB              
	,CASE 
    WHEN LIT3.TC_TIPO_BCA = 'WSB'
		AND LIT3.TC_ELIMINADO = ''
		AND LIT3.TC_TEXTO1 = ''
			THEN LIT3.TC_TEXTO2
    ELSE LIT3.TC_TEXTO1
 	END 										 AS TC_TEXTO1                    
	,LIT3.TC_TEXTO2                              AS TC_TEXTO2                    
	,CASE 
    WHEN LIT3.TC_TIPO_BCA = 'WSB'
		AND LIT3.TC_ELIMINADO = '' 
    		THEN SUBSTRING(RTRIM(LIT3.TC_CARACTERISTICAS_CLIENTE), 1, 100)
    ELSE LIT3.TC_CARACTERISTICAS_CLIENTE
 	END											 AS TC_CARACTERISTICAS_CLIENTE   
	,LIT3.TC_CAMPANA_OFERTA                      AS TC_CAMPANA_OFERTA            
	,LIT3.TE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO           
	,LIT3.TC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE    
	,LIT3.TC_CALIFICACION_SBIF                   AS TC_CALIFICACION_SBIF         
	,LIT3.TT_PERIODO_CALIFICACION                AS TT_PERIODO_CALIFICACION      
	,LIT3.TD_PI_CLIENTE                          AS TD_PI_CLIENTE                
	,LIT3.TC_CLASIFICACION_SBIF                  AS TC_CLASIFICACION_SBIF        
	,LIT3.TE_FDR                                 AS TE_FDR                       
	,LIT3.TE_COS_CLI                             AS TE_COS_CLI                   
	,LIT3.TE_FILTROS_RIESGOS                     AS TE_FILTROS_RIESGOS           
	,LIT3.TC_PAR_CALIFICACION_SBIF               AS TC_PAR_CALIFICACION_SBIF     
	,LIT3.TD_PAR_PI_CLIENTE                      AS TD_PAR_PI_CLIENTE            
	,LIT3.TE_PAR_FDR                             AS TE_PAR_FDR                   
	,LIT3.TE_PAR_COS_CLI                         AS TE_PAR_COS_CLI               
	,LIT3.TE_MOLESTO                             AS TE_MOLESTO                   
	,LIT3.TE_CARGABLE                            AS TE_CARGABLE                  
	,LIT3.TC_ELIMINADO                           AS TC_ELIMINADO                 
	,LIT3.TE_DUPLAS                              AS TE_DUPLAS                    
	,LIT3.TE_PLAN_INVERSION                      AS TE_PLAN_INVERSION
	,LIT3.TE_NRO_OPT_PLAN_INVERSION				 AS TE_NRO_OPT_PLAN_INVERSION
	,LIT3.TE_MTO_OPT_PLAN_INVERSION              AS TE_MTO_OPT_PLAN_INVERSION    
	,LIT3.TC_PROD_1_PLAN_INVERSION               AS TC_PROD_1_PLAN_INVERSION     
	,LIT3.TC_PROD_2_PLAN_INVERSION               AS TC_PROD_2_PLAN_INVERSION     
	,LIT3.TC_PER_MIN_PLAN_INVERSION              AS TC_PER_MIN_PLAN_INVERSION    
	,LIT3.TC_PER_MAX_PLAN_INVERSION              AS TC_PER_MAX_PLAN_INVERSION    
	,LIT3.TE_CON_VENTAS                          AS TE_CON_VENTAS                
	,LIT3.TE_CON_VENTAS_ANT                      AS TE_CON_VENTAS_ANT            
	,LIT3.TE_LEASING_DATAMART                    AS TE_LEASING_DATAMART          
	,LIT3.TE_OPC_COMPRA                          AS TE_OPC_COMPRA                
	,LIT3.TC_PER_OPC_COMPRA                      AS TC_PER_OPC_COMPRA            
	,LIT3.TC_ESTRATEGIA                          AS TC_ESTRATEGIA                
	,LIT3.TC_PERFIL                              AS TC_PERFIL
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_03 AS LIT3
;

.IF ERRORCODE <> 0 THEN .QUIT 11;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_04;

.IF ERRORCODE <> 0 THEN .QUIT 12;


/*************************************************************************
** ACTUALIZACIÓN DE CARACTERÍSTICAS DE CLIENTES PARA LA TABLA           **
** CAMPANA_LEASING_WHOLESALE_MES                                        **
** - Se actualizan las variables "OPC_COMPRA" y "LEASING_DATAMART" para **
**   reflejar las características específicas de los clientes según     **
**   los criterios establecidos para la campaña.                        **
*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_05;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_05
(
     TD_CLI_RUT 						    DECIMAL(8,0)
    ,TC_NOM_CLI 						    VARCHAR (77)  CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_MACRO_BANCA 			            VARCHAR (16)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE 				  	            VARCHAR (12)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_IND_CTAS_CORRIENTES 	            INTEGER
    ,TE_COTIZA 						        INTEGER
    ,TD_PROB							    DECIMAL(25,10)
    ,TC_ESTADO_RECURRENCIA_LEASING	        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_OFERTA_REGLA					    DECIMAL(18,0)
    ,TD_MONTO_OFERTA     				    DECIMAL(18,0)
    ,TC_CAMPANA						        VARCHAR(50)	  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_POTENCIAL						    INTEGER
    ,TC_TIPO_BCA						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TRAMO_LEASING_MOB				    VARCHAR(255)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_LEASING					        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_NO_POTENCIAL					    INTEGER
    ,TE_PRIO                                INTEGER
    ,TE_ES_BCI                              INTEGER
    ,TE_MARCA_RUTGOB                        INTEGER
    ,TC_TEXTO1						        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2						        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE		        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA				        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO				        INTEGER
    ,TC_RECOMENDACION_DE_CRUCE 		        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TT_PERIODO_CALIFICACION			    TIMESTAMP(6) FORMAT 'YYYY-MM-DDBHH:MI:SS.S(6)'
    ,TD_PI_CLIENTE					        DECIMAL(25,10)
    ,TC_CLASIFICACION_SBIF			        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR							        INTEGER
    ,TE_COS_CLI						        INTEGER
    ,TE_FILTROS_RIESGOS 				    INTEGER
    ,TC_PAR_CALIFICACION_SBIF			    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE				        DECIMAL(25,10)
    ,TE_PAR_FDR						        INTEGER
    ,TE_PAR_COS_CLI					        INTEGER
    ,TE_MOLESTO						        BIGINT
    ,TE_CARGABLE 						    BIGINT
    ,TC_ELIMINADO						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS 						        BIGINT
    ,TE_PLAN_INVERSION 				        BIGINT
    ,TE_NRO_OPT_PLAN_INVERSION              BIGINT
    ,TE_MTO_OPT_PLAN_INVERSION  		    BIGINT
    ,TC_PROD_1_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PROD_2_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MIN_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MAX_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CON_VENTAS 					        BIGINT
    ,TE_CON_VENTAS_ANT 				        BIGINT
    ,TE_LEASING_DATAMART 				    BIGINT
    ,TE_OPC_COMPRA 					        BIGINT
    ,TC_PER_OPC_COMPRA				        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ESTRATEGIA					        VARCHAR(9)    CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PERFIL			 			        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (TD_CLI_RUT)
;

.IF ERRORCODE <> 0 THEN .QUIT 13;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_05
SELECT
	 LIT4.TD_CLI_RUT     						 AS TD_CLI_RUT     		                  
	,LIT4.TC_NOM_CLI                             AS TC_NOM_CLI                   
	,LIT4.TC_MACRO_BANCA                         AS TC_MACRO_BANCA               
	,LIT4.TC_EJE                                 AS TC_EJE                       
	,LIT4.TE_IND_CTAS_CORRIENTES                 AS TE_IND_CTAS_CORRIENTES       
	,LIT4.TE_COTIZA                              AS TE_COTIZA                    
	,LIT4.TD_PROB                                AS TD_PROB                      
	,LIT4.TC_ESTADO_RECURRENCIA_LEASING          AS TC_ESTADO_RECURRENCIA_LEASING
	,LIT4.TD_OFERTA_REGLA                        AS TD_OFERTA_REGLA              
	,LIT4.TD_MONTO_OFERTA                        AS TD_MONTO_OFERTA              
	,LIT4.TC_CAMPANA                             AS TC_CAMPANA                   
	,LIT4.TE_POTENCIAL                           AS TE_POTENCIAL                 
	,LIT4.TC_TIPO_BCA                            AS TC_TIPO_BCA                  
	,LIT4.TC_TRAMO_LEASING_MOB                   AS TC_TRAMO_LEASING_MOB         
	,LIT4.TC_EJE_LEASING                         AS TC_EJE_LEASING               
	,LIT4.TE_NO_POTENCIAL                        AS TE_NO_POTENCIAL              
	,LIT4.TE_PRIO                                AS TE_PRIO                      
	,LIT4.TE_ES_BCI                              AS TE_ES_BCI                    
	,LIT4.TE_MARCA_RUTGOB                        AS TE_MARCA_RUTGOB              
	,LIT4.TC_TEXTO1                              AS TC_TEXTO1                    
	,CASE 
    WHEN LIT4.TC_TIPO_BCA = 'WSB'
		AND LIT4.TE_CON_VENTAS_ANT > 0 
    		THEN LIT4.TC_TEXTO2 || ' / ' || 'CLIENTES CON CURSE'
    ELSE LIT4.TC_TEXTO2
 	END											 AS TC_TEXTO2                    
	,CASE 
    WHEN LIT4.TC_TIPO_BCA = 'WSB'
		THEN
        CASE 
            WHEN (LIT4.TE_OPC_COMPRA + LIT4.TE_LEASING_DATAMART) >= 2  
                THEN 'Propenso Datamart y Con Opc. Compra en : ' || LIT4.TC_PER_OPC_COMPRA
            WHEN LIT4.TE_OPC_COMPRA = 1 
                THEN 'Con Opc. Compra en : ' || LIT4.TC_PER_OPC_COMPRA
            WHEN LIT4.TE_LEASING_DATAMART = 1 
                THEN 'Propenso Datamart '
            ELSE LIT4.TC_CARACTERISTICAS_CLIENTE
        END
    ELSE LIT4.TC_CARACTERISTICAS_CLIENTE
 	END 										 AS TC_CARACTERISTICAS_CLIENTE   
	,LIT4.TC_CAMPANA_OFERTA                      AS TC_CAMPANA_OFERTA            
	,LIT4.TE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO           
	,LIT4.TC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE    
	,LIT4.TC_CALIFICACION_SBIF                   AS TC_CALIFICACION_SBIF         
	,LIT4.TT_PERIODO_CALIFICACION                AS TT_PERIODO_CALIFICACION      
	,LIT4.TD_PI_CLIENTE                          AS TD_PI_CLIENTE                
	,LIT4.TC_CLASIFICACION_SBIF                  AS TC_CLASIFICACION_SBIF        
	,LIT4.TE_FDR                                 AS TE_FDR                       
	,LIT4.TE_COS_CLI                             AS TE_COS_CLI                   
	,LIT4.TE_FILTROS_RIESGOS                     AS TE_FILTROS_RIESGOS           
	,LIT4.TC_PAR_CALIFICACION_SBIF               AS TC_PAR_CALIFICACION_SBIF     
	,LIT4.TD_PAR_PI_CLIENTE                      AS TD_PAR_PI_CLIENTE            
	,LIT4.TE_PAR_FDR                             AS TE_PAR_FDR                   
	,LIT4.TE_PAR_COS_CLI                         AS TE_PAR_COS_CLI               
	,LIT4.TE_MOLESTO                             AS TE_MOLESTO                   
	,LIT4.TE_CARGABLE                            AS TE_CARGABLE                  
	,LIT4.TC_ELIMINADO                           AS TC_ELIMINADO                 
	,LIT4.TE_DUPLAS                              AS TE_DUPLAS                    
	,LIT4.TE_PLAN_INVERSION                      AS TE_PLAN_INVERSION
	,LIT4.TE_NRO_OPT_PLAN_INVERSION				 AS TE_NRO_OPT_PLAN_INVERSION
	,LIT4.TE_MTO_OPT_PLAN_INVERSION              AS TE_MTO_OPT_PLAN_INVERSION    
	,LIT4.TC_PROD_1_PLAN_INVERSION               AS TC_PROD_1_PLAN_INVERSION     
	,LIT4.TC_PROD_2_PLAN_INVERSION               AS TC_PROD_2_PLAN_INVERSION     
	,LIT4.TC_PER_MIN_PLAN_INVERSION              AS TC_PER_MIN_PLAN_INVERSION    
	,LIT4.TC_PER_MAX_PLAN_INVERSION              AS TC_PER_MAX_PLAN_INVERSION    
	,LIT4.TE_CON_VENTAS                          AS TE_CON_VENTAS                
	,LIT4.TE_CON_VENTAS_ANT                      AS TE_CON_VENTAS_ANT            
	,LIT4.TE_LEASING_DATAMART                    AS TE_LEASING_DATAMART          
	,LIT4.TE_OPC_COMPRA                          AS TE_OPC_COMPRA                
	,LIT4.TC_PER_OPC_COMPRA                      AS TC_PER_OPC_COMPRA            
	,LIT4.TC_ESTRATEGIA                          AS TC_ESTRATEGIA                
	,LIT4.TC_PERFIL                              AS TC_PERFIL
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_04 AS LIT4
;

.IF ERRORCODE <> 0 THEN .QUIT 14;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_05;

.IF ERRORCODE <> 0 THEN .QUIT 15;

SELECT DATE, TIME;
.LOGOFF;
.QUIT 0;

UPDATE - Ejemplo 18 B OK.sql

--/***********************************************************************************************************
--************************************************************************************************************
--** DSCRPCN: PROCESO DE CAMPANA LEASING WHOLESALE QUE ACTUALIZA LOS LITERALES  (ETAPA B)                   **
--**                                                    				 				                    **
--** AUTOR  : CESAR ROMERO MUNOZ                                               			                    **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				                    **
--** FECHA  : 05/2022                                                   				                    **
--***********************************************************************************************************/
--/***********************************************************************************************************
--** MANTNCN: Normalización BTEQ														                    **
--** AUTOR  : MATIAS JORQUERA															                    **
--** EMPRESA: FACTOR IT																  	                    **
--** FECHA  : 12/2024																	                    **
--/***********************************************************************************************************
--**TABLA DE ENTRADA:	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_05				**
--**                                        											                    **
--**                  											                                            **
--** TABLA DE SALIDA:	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_LIT	**
--**                  					  												                    **
--************************************************************************************************************
--***********************************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/***********************************************************************
--** ACTUALIZACION DE LITERALES - CAMPANA_LEASING_WHOLESALE_MES			**
--** SE ACTUALIZA VALORES PARA TEXTO1 - ESTRATEGIA 						**
--***********************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_06;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_06
(
     TD_CLI_RUT 						    DECIMAL(8,0)
    ,TC_NOM_CLI 						    VARCHAR (77)  CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_MACRO_BANCA 			            VARCHAR (16)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE 				  	            VARCHAR (12)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_IND_CTAS_CORRIENTES 	            INTEGER
    ,TE_COTIZA 						        INTEGER
    ,TD_PROB							    DECIMAL(25,10)
    ,TC_ESTADO_RECURRENCIA_LEASING	        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_OFERTA_REGLA					    DECIMAL(18,0)
    ,TD_MONTO_OFERTA     				    DECIMAL(18,0)
    ,TC_CAMPANA						        VARCHAR(50)	  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_POTENCIAL						    INTEGER
    ,TC_TIPO_BCA						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TRAMO_LEASING_MOB				    VARCHAR(255)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_LEASING					        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_NO_POTENCIAL					    INTEGER
    ,TE_PRIO                                INTEGER
    ,TE_ES_BCI                              INTEGER
    ,TE_MARCA_RUTGOB                        INTEGER
    ,TC_TEXTO1						        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2						        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE		        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA				        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO				        INTEGER
    ,TC_RECOMENDACION_DE_CRUCE 		        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TT_PERIODO_CALIFICACION			    TIMESTAMP(6) FORMAT 'YYYY-MM-DDBHH:MI:SS.S(6)'
    ,TD_PI_CLIENTE					        DECIMAL(25,10)
    ,TC_CLASIFICACION_SBIF			        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR							        INTEGER
    ,TE_COS_CLI						        INTEGER
    ,TE_FILTROS_RIESGOS 				    INTEGER
    ,TC_PAR_CALIFICACION_SBIF			    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE				        DECIMAL(25,10)
    ,TE_PAR_FDR						        INTEGER
    ,TE_PAR_COS_CLI					        INTEGER
    ,TE_MOLESTO						        BIGINT
    ,TE_CARGABLE 						    BIGINT
    ,TC_ELIMINADO						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS 						        BIGINT
    ,TE_PLAN_INVERSION 				        BIGINT
    ,TE_NRO_OPT_PLAN_INVERSION              BIGINT
    ,TE_MTO_OPT_PLAN_INVERSION  		    BIGINT
    ,TC_PROD_1_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PROD_2_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MIN_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MAX_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CON_VENTAS 					        BIGINT
    ,TE_CON_VENTAS_ANT 				        BIGINT
    ,TE_LEASING_DATAMART 				    BIGINT
    ,TE_OPC_COMPRA 					        BIGINT
    ,TC_PER_OPC_COMPRA				        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ESTRATEGIA					        VARCHAR(9)    CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PERFIL			 			        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (TD_CLI_RUT)
;

.IF ERRORCODE <> 0 THEN .QUIT 16;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_06
SELECT
	 LIT5.TD_CLI_RUT     						 AS TD_CLI_RUT     		                  
	,LIT5.TC_NOM_CLI                             AS TC_NOM_CLI                   
	,LIT5.TC_MACRO_BANCA                         AS TC_MACRO_BANCA               
	,LIT5.TC_EJE                                 AS TC_EJE                       
	,LIT5.TE_IND_CTAS_CORRIENTES                 AS TE_IND_CTAS_CORRIENTES       
	,LIT5.TE_COTIZA                              AS TE_COTIZA                    
	,LIT5.TD_PROB                                AS TD_PROB                      
	,LIT5.TC_ESTADO_RECURRENCIA_LEASING          AS TC_ESTADO_RECURRENCIA_LEASING
	,LIT5.TD_OFERTA_REGLA                        AS TD_OFERTA_REGLA              
	,LIT5.TD_MONTO_OFERTA                        AS TD_MONTO_OFERTA              
	,LIT5.TC_CAMPANA                             AS TC_CAMPANA                   
	,LIT5.TE_POTENCIAL                           AS TE_POTENCIAL                 
	,LIT5.TC_TIPO_BCA                            AS TC_TIPO_BCA                  
	,LIT5.TC_TRAMO_LEASING_MOB                   AS TC_TRAMO_LEASING_MOB         
	,LIT5.TC_EJE_LEASING                         AS TC_EJE_LEASING               
	,LIT5.TE_NO_POTENCIAL                        AS TE_NO_POTENCIAL              
	,LIT5.TE_PRIO                                AS TE_PRIO                      
	,LIT5.TE_ES_BCI                              AS TE_ES_BCI                    
	,LIT5.TE_MARCA_RUTGOB                        AS TE_MARCA_RUTGOB              
	,LIT5.TC_TEXTO1                              AS TC_TEXTO1                    
	,LIT5.TC_TEXTO2                              AS TC_TEXTO2                    
	,CASE 
    WHEN LIT5.TC_TIPO_BCA = 'WSB'
		THEN
        SUBSTRING(
            'Cliente con Estrategia : (' ||
            CASE 
                WHEN LIT5.TC_ESTRATEGIA IN ('', 'Nuevos', 'nuevo') 
					THEN 'Nuevos'
                ELSE RTRIM(LIT5.TC_ESTRATEGIA)
            END ||
            CASE 
                WHEN LIT5.TC_PERFIL IN ('potenciar', 'potenciado')
					THEN '+'
                ELSE ''
            END ||
            ') ' || RTRIM(LIT5.TC_CARACTERISTICAS_CLIENTE),
            1, 100
        )
    ELSE LIT5.TC_CARACTERISTICAS_CLIENTE
 	END											 AS TC_CARACTERISTICAS_CLIENTE   
	,LIT5.TC_CAMPANA_OFERTA                      AS TC_CAMPANA_OFERTA            
	,LIT5.TE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO           
	,LIT5.TC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE    
	,LIT5.TC_CALIFICACION_SBIF                   AS TC_CALIFICACION_SBIF         
	,LIT5.TT_PERIODO_CALIFICACION                AS TT_PERIODO_CALIFICACION      
	,LIT5.TD_PI_CLIENTE                          AS TD_PI_CLIENTE                
	,LIT5.TC_CLASIFICACION_SBIF                  AS TC_CLASIFICACION_SBIF        
	,LIT5.TE_FDR                                 AS TE_FDR                       
	,LIT5.TE_COS_CLI                             AS TE_COS_CLI                   
	,LIT5.TE_FILTROS_RIESGOS                     AS TE_FILTROS_RIESGOS           
	,LIT5.TC_PAR_CALIFICACION_SBIF               AS TC_PAR_CALIFICACION_SBIF     
	,LIT5.TD_PAR_PI_CLIENTE                      AS TD_PAR_PI_CLIENTE            
	,LIT5.TE_PAR_FDR                             AS TE_PAR_FDR                   
	,LIT5.TE_PAR_COS_CLI                         AS TE_PAR_COS_CLI               
	,LIT5.TE_MOLESTO                             AS TE_MOLESTO                   
	,LIT5.TE_CARGABLE                            AS TE_CARGABLE                  
	,LIT5.TC_ELIMINADO                           AS TC_ELIMINADO                 
	,LIT5.TE_DUPLAS                              AS TE_DUPLAS                    
	,LIT5.TE_PLAN_INVERSION                      AS TE_PLAN_INVERSION
	,LIT5.TE_NRO_OPT_PLAN_INVERSION				 AS TE_NRO_OPT_PLAN_INVERSION
	,LIT5.TE_MTO_OPT_PLAN_INVERSION              AS TE_MTO_OPT_PLAN_INVERSION    
	,LIT5.TC_PROD_1_PLAN_INVERSION               AS TC_PROD_1_PLAN_INVERSION     
	,LIT5.TC_PROD_2_PLAN_INVERSION               AS TC_PROD_2_PLAN_INVERSION     
	,LIT5.TC_PER_MIN_PLAN_INVERSION              AS TC_PER_MIN_PLAN_INVERSION    
	,LIT5.TC_PER_MAX_PLAN_INVERSION              AS TC_PER_MAX_PLAN_INVERSION    
	,LIT5.TE_CON_VENTAS                          AS TE_CON_VENTAS                
	,LIT5.TE_CON_VENTAS_ANT                      AS TE_CON_VENTAS_ANT            
	,LIT5.TE_LEASING_DATAMART                    AS TE_LEASING_DATAMART          
	,LIT5.TE_OPC_COMPRA                          AS TE_OPC_COMPRA                
	,LIT5.TC_PER_OPC_COMPRA                      AS TC_PER_OPC_COMPRA            
	,LIT5.TC_ESTRATEGIA                          AS TC_ESTRATEGIA                
	,LIT5.TC_PERFIL                              AS TC_PERFIL
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_05 AS LIT5
;

.IF ERRORCODE <> 0 THEN .QUIT 17;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_06;

.IF ERRORCODE <> 0 THEN .QUIT 18;

/*************************************************************************
** ACTUALIZACIÓN DE CARACTERÍSTICAS DE CLIENTE PARA LA TABLA            **
** CAMPANA_LEASING_WHOLESALE_MES                                        **
** - Se ajusta el campo "CARACTERISTICAS_CLIENTE" para incluir una      **
**   sugerencia de visita presencial cuando el cliente pertenece al     **
**   segmento "WSB" y su perfil es "potenciar" o "potenciado".          **
** - En los demás casos, se mantienen las características originales    **
**   del cliente sin modificaciones.                                    **
*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_07;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_07
(
     TD_CLI_RUT 						    DECIMAL(8,0)
    ,TC_NOM_CLI 						    VARCHAR (77)  CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_MACRO_BANCA 			            VARCHAR (16)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE 				  	            VARCHAR (12)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_IND_CTAS_CORRIENTES 	            INTEGER
    ,TE_COTIZA 						        INTEGER
    ,TD_PROB							    DECIMAL(25,10)
    ,TC_ESTADO_RECURRENCIA_LEASING	        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_OFERTA_REGLA					    DECIMAL(18,0)
    ,TD_MONTO_OFERTA     				    DECIMAL(18,0)
    ,TC_CAMPANA						        VARCHAR(50)	  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_POTENCIAL						    INTEGER
    ,TC_TIPO_BCA						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TRAMO_LEASING_MOB				    VARCHAR(255)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_LEASING					        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_NO_POTENCIAL					    INTEGER
    ,TE_PRIO                                INTEGER
    ,TE_ES_BCI                              INTEGER
    ,TE_MARCA_RUTGOB                        INTEGER
    ,TC_TEXTO1						        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2						        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE		        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA				        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO				        INTEGER
    ,TC_RECOMENDACION_DE_CRUCE 		        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TT_PERIODO_CALIFICACION			    TIMESTAMP(6) FORMAT 'YYYY-MM-DDBHH:MI:SS.S(6)'
    ,TD_PI_CLIENTE					        DECIMAL(25,10)
    ,TC_CLASIFICACION_SBIF			        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR							        INTEGER
    ,TE_COS_CLI						        INTEGER
    ,TE_FILTROS_RIESGOS 				    INTEGER
    ,TC_PAR_CALIFICACION_SBIF			    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE				        DECIMAL(25,10)
    ,TE_PAR_FDR						        INTEGER
    ,TE_PAR_COS_CLI					        INTEGER
    ,TE_MOLESTO						        BIGINT
    ,TE_CARGABLE 						    BIGINT
    ,TC_ELIMINADO						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS 						        BIGINT
    ,TE_PLAN_INVERSION 				        BIGINT
    ,TE_NRO_OPT_PLAN_INVERSION              BIGINT
    ,TE_MTO_OPT_PLAN_INVERSION  		    BIGINT
    ,TC_PROD_1_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PROD_2_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MIN_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MAX_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CON_VENTAS 					        BIGINT
    ,TE_CON_VENTAS_ANT 				        BIGINT
    ,TE_LEASING_DATAMART 				    BIGINT
    ,TE_OPC_COMPRA 					        BIGINT
    ,TC_PER_OPC_COMPRA				        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ESTRATEGIA					        VARCHAR(9)    CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PERFIL			 			        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (TD_CLI_RUT)
;

.IF ERRORCODE <> 0 THEN .QUIT 19;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_07
SELECT
	 LIT6.TD_CLI_RUT     						 AS TD_CLI_RUT     		                  
	,LIT6.TC_NOM_CLI                             AS TC_NOM_CLI                   
	,LIT6.TC_MACRO_BANCA                         AS TC_MACRO_BANCA               
	,LIT6.TC_EJE                                 AS TC_EJE                       
	,LIT6.TE_IND_CTAS_CORRIENTES                 AS TE_IND_CTAS_CORRIENTES       
	,LIT6.TE_COTIZA                              AS TE_COTIZA                    
	,LIT6.TD_PROB                                AS TD_PROB                      
	,LIT6.TC_ESTADO_RECURRENCIA_LEASING          AS TC_ESTADO_RECURRENCIA_LEASING
	,LIT6.TD_OFERTA_REGLA                        AS TD_OFERTA_REGLA              
	,LIT6.TD_MONTO_OFERTA                        AS TD_MONTO_OFERTA              
	,LIT6.TC_CAMPANA                             AS TC_CAMPANA                   
	,LIT6.TE_POTENCIAL                           AS TE_POTENCIAL                 
	,LIT6.TC_TIPO_BCA                            AS TC_TIPO_BCA                  
	,LIT6.TC_TRAMO_LEASING_MOB                   AS TC_TRAMO_LEASING_MOB         
	,LIT6.TC_EJE_LEASING                         AS TC_EJE_LEASING               
	,LIT6.TE_NO_POTENCIAL                        AS TE_NO_POTENCIAL              
	,LIT6.TE_PRIO                                AS TE_PRIO                      
	,LIT6.TE_ES_BCI                              AS TE_ES_BCI                    
	,LIT6.TE_MARCA_RUTGOB                        AS TE_MARCA_RUTGOB              
	,LIT6.TC_TEXTO1                              AS TC_TEXTO1                    
	,LIT6.TC_TEXTO2                              AS TC_TEXTO2                    
	,CASE 
    WHEN LIT6.TC_TIPO_BCA = 'WSB'
		AND LIT6.TC_PERFIL IN ('potenciar', 'potenciado')
			THEN SUBSTRING(RTRIM(LIT6.TC_CARACTERISTICAS_CLIENTE) || ', Se Sugiere Visita Presencial', 1, 100)
    ELSE LIT6.TC_CARACTERISTICAS_CLIENTE
 	END 										 AS TC_CARACTERISTICAS_CLIENTE   
	,LIT6.TC_CAMPANA_OFERTA                      AS TC_CAMPANA_OFERTA            
	,LIT6.TE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO           
	,LIT6.TC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE    
	,LIT6.TC_CALIFICACION_SBIF                   AS TC_CALIFICACION_SBIF         
	,LIT6.TT_PERIODO_CALIFICACION                AS TT_PERIODO_CALIFICACION      
	,LIT6.TD_PI_CLIENTE                          AS TD_PI_CLIENTE                
	,LIT6.TC_CLASIFICACION_SBIF                  AS TC_CLASIFICACION_SBIF        
	,LIT6.TE_FDR                                 AS TE_FDR                       
	,LIT6.TE_COS_CLI                             AS TE_COS_CLI                   
	,LIT6.TE_FILTROS_RIESGOS                     AS TE_FILTROS_RIESGOS           
	,LIT6.TC_PAR_CALIFICACION_SBIF               AS TC_PAR_CALIFICACION_SBIF     
	,LIT6.TD_PAR_PI_CLIENTE                      AS TD_PAR_PI_CLIENTE            
	,LIT6.TE_PAR_FDR                             AS TE_PAR_FDR                   
	,LIT6.TE_PAR_COS_CLI                         AS TE_PAR_COS_CLI               
	,LIT6.TE_MOLESTO                             AS TE_MOLESTO                   
	,LIT6.TE_CARGABLE                            AS TE_CARGABLE                  
	,LIT6.TC_ELIMINADO                           AS TC_ELIMINADO                 
	,LIT6.TE_DUPLAS                              AS TE_DUPLAS                    
	,LIT6.TE_PLAN_INVERSION                      AS TE_PLAN_INVERSION
	,LIT6.TE_NRO_OPT_PLAN_INVERSION				 AS TE_NRO_OPT_PLAN_INVERSION
	,LIT6.TE_MTO_OPT_PLAN_INVERSION              AS TE_MTO_OPT_PLAN_INVERSION    
	,LIT6.TC_PROD_1_PLAN_INVERSION               AS TC_PROD_1_PLAN_INVERSION     
	,LIT6.TC_PROD_2_PLAN_INVERSION               AS TC_PROD_2_PLAN_INVERSION     
	,LIT6.TC_PER_MIN_PLAN_INVERSION              AS TC_PER_MIN_PLAN_INVERSION    
	,LIT6.TC_PER_MAX_PLAN_INVERSION              AS TC_PER_MAX_PLAN_INVERSION    
	,LIT6.TE_CON_VENTAS                          AS TE_CON_VENTAS                
	,LIT6.TE_CON_VENTAS_ANT                      AS TE_CON_VENTAS_ANT            
	,LIT6.TE_LEASING_DATAMART                    AS TE_LEASING_DATAMART          
	,LIT6.TE_OPC_COMPRA                          AS TE_OPC_COMPRA                
	,LIT6.TC_PER_OPC_COMPRA                      AS TC_PER_OPC_COMPRA            
	,LIT6.TC_ESTRATEGIA                          AS TC_ESTRATEGIA                
	,LIT6.TC_PERFIL                              AS TC_PERFIL
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_06 AS LIT6
;

.IF ERRORCODE <> 0 THEN .QUIT 20;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_07;

.IF ERRORCODE <> 0 THEN .QUIT 21;


/*************************************************************************
** ACTUALIZACIÓN DE CARACTERÍSTICAS DE CLIENTES PARA LA TABLA           **
** CAMPANA_LEASING_WHOLESALE_MES                                        **
** - Se ajusta el campo "CARACTERISTICAS_CLIENTE" para incluir una   **
**   sugerencia de contacto telefónico cuando el cliente pertenece al   **
**   segmento "WSB" y su perfil NO es "potenciar" ni "potenciado".      **
** - En los demás casos, se mantienen las características originales    **
**   del cliente sin modificaciones.                                    **
*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_08;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_08
(
     TD_CLI_RUT 						    DECIMAL(8,0)
    ,TC_NOM_CLI 						    VARCHAR (77)  CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_MACRO_BANCA 			            VARCHAR (16)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE 				  	            VARCHAR (12)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_IND_CTAS_CORRIENTES 	            INTEGER
    ,TE_COTIZA 						        INTEGER
    ,TD_PROB							    DECIMAL(25,10)
    ,TC_ESTADO_RECURRENCIA_LEASING	        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_OFERTA_REGLA					    DECIMAL(18,0)
    ,TD_MONTO_OFERTA     				    DECIMAL(18,0)
    ,TC_CAMPANA						        VARCHAR(50)	  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_POTENCIAL						    INTEGER
    ,TC_TIPO_BCA						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TRAMO_LEASING_MOB				    VARCHAR(255)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_EJE_LEASING					        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_NO_POTENCIAL					    INTEGER
    ,TE_PRIO                                INTEGER
    ,TE_ES_BCI                              INTEGER
    ,TE_MARCA_RUTGOB                        INTEGER
    ,TC_TEXTO1						        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_TEXTO2						        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CARACTERISTICAS_CLIENTE		        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CAMPANA_OFERTA				        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_EN_PLANEAMIENTO				        INTEGER
    ,TC_RECOMENDACION_DE_CRUCE 		        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_CALIFICACION_SBIF				    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TT_PERIODO_CALIFICACION			    TIMESTAMP(6) FORMAT 'YYYY-MM-DDBHH:MI:SS.S(6)'
    ,TD_PI_CLIENTE					        DECIMAL(25,10)
    ,TC_CLASIFICACION_SBIF			        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_FDR							        INTEGER
    ,TE_COS_CLI						        INTEGER
    ,TE_FILTROS_RIESGOS 				    INTEGER
    ,TC_PAR_CALIFICACION_SBIF			    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_PAR_PI_CLIENTE				        DECIMAL(25,10)
    ,TE_PAR_FDR						        INTEGER
    ,TE_PAR_COS_CLI					        INTEGER
    ,TE_MOLESTO						        BIGINT
    ,TE_CARGABLE 						    BIGINT
    ,TC_ELIMINADO						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_DUPLAS 						        BIGINT
    ,TE_PLAN_INVERSION 				        BIGINT
    ,TE_NRO_OPT_PLAN_INVERSION              BIGINT
    ,TE_MTO_OPT_PLAN_INVERSION  		    BIGINT
    ,TC_PROD_1_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PROD_2_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MIN_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PER_MAX_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CON_VENTAS 					        BIGINT
    ,TE_CON_VENTAS_ANT 				        BIGINT
    ,TE_LEASING_DATAMART 				    BIGINT
    ,TE_OPC_COMPRA 					        BIGINT
    ,TC_PER_OPC_COMPRA				        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ESTRATEGIA					        VARCHAR(9)    CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PERFIL			 			        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (TD_CLI_RUT)
;

.IF ERRORCODE <> 0 THEN .QUIT 22;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_08
SELECT
	 LIT7.TD_CLI_RUT     						 AS TD_CLI_RUT     		                  
	,LIT7.TC_NOM_CLI                             AS TC_NOM_CLI                   
	,LIT7.TC_MACRO_BANCA                         AS TC_MACRO_BANCA               
	,LIT7.TC_EJE                                 AS TC_EJE                       
	,LIT7.TE_IND_CTAS_CORRIENTES                 AS TE_IND_CTAS_CORRIENTES       
	,LIT7.TE_COTIZA                              AS TE_COTIZA                    
	,LIT7.TD_PROB                                AS TD_PROB                      
	,LIT7.TC_ESTADO_RECURRENCIA_LEASING          AS TC_ESTADO_RECURRENCIA_LEASING
	,LIT7.TD_OFERTA_REGLA                        AS TD_OFERTA_REGLA              
	,LIT7.TD_MONTO_OFERTA                        AS TD_MONTO_OFERTA              
	,LIT7.TC_CAMPANA                             AS TC_CAMPANA                   
	,LIT7.TE_POTENCIAL                           AS TE_POTENCIAL                 
	,LIT7.TC_TIPO_BCA                            AS TC_TIPO_BCA                  
	,LIT7.TC_TRAMO_LEASING_MOB                   AS TC_TRAMO_LEASING_MOB         
	,LIT7.TC_EJE_LEASING                         AS TC_EJE_LEASING               
	,LIT7.TE_NO_POTENCIAL                        AS TE_NO_POTENCIAL              
	,LIT7.TE_PRIO                                AS TE_PRIO                      
	,LIT7.TE_ES_BCI                              AS TE_ES_BCI                    
	,LIT7.TE_MARCA_RUTGOB                        AS TE_MARCA_RUTGOB              
	,LIT7.TC_TEXTO1                              AS TC_TEXTO1                    
	,LIT7.TC_TEXTO2                              AS TC_TEXTO2                    
	,CASE 
    WHEN LIT7.TC_TIPO_BCA = 'WSB'
		AND LIT7.TC_PERFIL NOT IN ('potenciar', 'potenciado')
		THEN SUBSTRING(RTRIM(LIT7.TC_CARACTERISTICAS_CLIENTE) || ', Se Sugiere Contacto Telefonico', 1, 100)
    ELSE LIT7.TC_CARACTERISTICAS_CLIENTE
 	END 										 AS TC_CARACTERISTICAS_CLIENTE   
	,LIT7.TC_CAMPANA_OFERTA                      AS TC_CAMPANA_OFERTA            
	,LIT7.TE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO           
	,LIT7.TC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE    
	,LIT7.TC_CALIFICACION_SBIF                   AS TC_CALIFICACION_SBIF         
	,LIT7.TT_PERIODO_CALIFICACION                AS TT_PERIODO_CALIFICACION      
	,LIT7.TD_PI_CLIENTE                          AS TD_PI_CLIENTE                
	,LIT7.TC_CLASIFICACION_SBIF                  AS TC_CLASIFICACION_SBIF        
	,LIT7.TE_FDR                                 AS TE_FDR                       
	,LIT7.TE_COS_CLI                             AS TE_COS_CLI                   
	,LIT7.TE_FILTROS_RIESGOS                     AS TE_FILTROS_RIESGOS           
	,LIT7.TC_PAR_CALIFICACION_SBIF               AS TC_PAR_CALIFICACION_SBIF     
	,LIT7.TD_PAR_PI_CLIENTE                      AS TD_PAR_PI_CLIENTE            
	,LIT7.TE_PAR_FDR                             AS TE_PAR_FDR                   
	,LIT7.TE_PAR_COS_CLI                         AS TE_PAR_COS_CLI               
	,LIT7.TE_MOLESTO                             AS TE_MOLESTO                   
	,LIT7.TE_CARGABLE                            AS TE_CARGABLE                  
	,LIT7.TC_ELIMINADO                           AS TC_ELIMINADO                 
	,LIT7.TE_DUPLAS                              AS TE_DUPLAS                    
	,LIT7.TE_PLAN_INVERSION                      AS TE_PLAN_INVERSION
	,LIT7.TE_NRO_OPT_PLAN_INVERSION				 AS TE_NRO_OPT_PLAN_INVERSION
	,LIT7.TE_MTO_OPT_PLAN_INVERSION              AS TE_MTO_OPT_PLAN_INVERSION    
	,LIT7.TC_PROD_1_PLAN_INVERSION               AS TC_PROD_1_PLAN_INVERSION     
	,LIT7.TC_PROD_2_PLAN_INVERSION               AS TC_PROD_2_PLAN_INVERSION     
	,LIT7.TC_PER_MIN_PLAN_INVERSION              AS TC_PER_MIN_PLAN_INVERSION    
	,LIT7.TC_PER_MAX_PLAN_INVERSION              AS TC_PER_MAX_PLAN_INVERSION    
	,LIT7.TE_CON_VENTAS                          AS TE_CON_VENTAS                
	,LIT7.TE_CON_VENTAS_ANT                      AS TE_CON_VENTAS_ANT            
	,LIT7.TE_LEASING_DATAMART                    AS TE_LEASING_DATAMART          
	,LIT7.TE_OPC_COMPRA                          AS TE_OPC_COMPRA                
	,LIT7.TC_PER_OPC_COMPRA                      AS TC_PER_OPC_COMPRA            
	,LIT7.TC_ESTRATEGIA                          AS TC_ESTRATEGIA                
	,LIT7.TC_PERFIL                              AS TC_PERFIL
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_07 AS LIT7
;

.IF ERRORCODE <> 0 THEN .QUIT 23;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_08;
	
.IF ERRORCODE <> 0 THEN .QUIT 24;

/*************************************************************************
** ACTUALIZACIÓN DE CARACTERÍSTICAS DE CLIENTES PARA LA TABLA           **
** CAMPANA_LEASING_WHOLESALE_MES                                        **
** - Se actualiza el campo "CARACTERISTICAS_CLIENTE" para incluir un    **
**   mensaje que indique la necesidad de coordinar una visita con un    **
**   ejecutivo comercial cuando el cliente pertenece al segmento "WSB"  **
**   y tiene duplas activas.                                            **
** - En los demás casos, se mantienen las características originales    **
**   del cliente sin modificaciones.                                    **
*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_LIT;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_LIT
(
     PD_CLI_RUT 						    DECIMAL(8,0)
    ,PC_NOM_CLI 						    VARCHAR (77)  CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_MACRO_BANCA 			            VARCHAR (16)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_EJE 				  	            VARCHAR (12)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_IND_CTAS_CORRIENTES 	            INTEGER
    ,PE_COTIZA 						        INTEGER
    ,PD_PROB							    DECIMAL(25,10)
    ,PC_ESTADO_RECURRENCIA_LEASING	        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_OFERTA_REGLA					    DECIMAL(18,0)
    ,PD_MONTO_OFERTA     				    DECIMAL(18,0)
    ,PC_CAMPANA						        VARCHAR(50)	  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_POTENCIAL						    INTEGER
    ,PC_TIPO_BCA						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TRAMO_LEASING_MOB				    VARCHAR(255)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_EJE_LEASING					        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_NO_POTENCIAL					    INTEGER
    ,PE_PRIO                                INTEGER
    ,PE_ES_BCI                              INTEGER
    ,PE_MARCA_RUTGOB                        INTEGER
    ,PC_TEXTO1						        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_TEXTO2						        VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CARACTERISTICAS_CLIENTE		        VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CAMPANA_OFERTA				        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_EN_PLANEAMIENTO				        INTEGER
    ,PC_RECOMENDACION_DE_CRUCE 		        VARCHAR(1000) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_CALIFICACION_SBIF				    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PT_PERIODO_CALIFICACION			    TIMESTAMP(6) FORMAT 'YYYY-MM-DDBHH:MI:SS.S(6)'
    ,PD_PI_CLIENTE					        DECIMAL(25,10)
    ,PC_CLASIFICACION_SBIF			        VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_FDR							        INTEGER
    ,PE_COS_CLI						        INTEGER
    ,PE_FILTROS_RIESGOS 				    INTEGER
    ,PC_PAR_CALIFICACION_SBIF			    VARCHAR(200)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_PAR_PI_CLIENTE				        DECIMAL(25,10)
    ,PE_PAR_FDR						        INTEGER
    ,PE_PAR_COS_CLI					        INTEGER
    ,PE_MOLESTO						        BIGINT
    ,PE_CARGABLE 						    BIGINT
    ,PC_ELIMINADO						    VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_DUPLAS 						        BIGINT
    ,PE_PLAN_INVERSION 				        BIGINT
    ,PE_NRO_OPT_PLAN_INVERSION              BIGINT
    ,PE_MTO_OPT_PLAN_INVERSION  		    BIGINT
    ,PC_PROD_1_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_PROD_2_PLAN_INVERSION  		        VARCHAR (200) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_PER_MIN_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_PER_MAX_PLAN_INVERSION 		        VARCHAR (10)  CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_CON_VENTAS 					        BIGINT
    ,PE_CON_VENTAS_ANT 				        BIGINT
    ,PE_LEASING_DATAMART 				    BIGINT
    ,PE_OPC_COMPRA 					        BIGINT
    ,PC_PER_OPC_COMPRA				        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_ESTRATEGIA					        VARCHAR(9)    CHARACTER SET LATIN NOT CASESPECIFIC
    ,PC_PERFIL			 			        VARCHAR(10)   CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (PD_CLI_RUT)
;

.IF ERRORCODE <> 0 THEN .QUIT 25;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_LIT
SELECT
	 LIT8.TD_CLI_RUT     						 AS PD_CLI_RUT     		                  
	,LIT8.TC_NOM_CLI                             AS PC_NOM_CLI                   
	,LIT8.TC_MACRO_BANCA                         AS PC_MACRO_BANCA               
	,LIT8.TC_EJE                                 AS PC_EJE                       
	,LIT8.TE_IND_CTAS_CORRIENTES                 AS PE_IND_CTAS_CORRIENTES       
	,LIT8.TE_COTIZA                              AS PE_COTIZA                    
	,LIT8.TD_PROB                                AS PD_PROB                      
	,LIT8.TC_ESTADO_RECURRENCIA_LEASING          AS PC_ESTADO_RECURRENCIA_LEASING
	,LIT8.TD_OFERTA_REGLA                        AS PD_OFERTA_REGLA              
	,LIT8.TD_MONTO_OFERTA                        AS PD_MONTO_OFERTA              
	,LIT8.TC_CAMPANA                             AS PC_CAMPANA                   
	,LIT8.TE_POTENCIAL                           AS PE_POTENCIAL                 
	,LIT8.TC_TIPO_BCA                            AS PC_TIPO_BCA                  
	,LIT8.TC_TRAMO_LEASING_MOB                   AS PC_TRAMO_LEASING_MOB         
	,LIT8.TC_EJE_LEASING                         AS PC_EJE_LEASING               
	,LIT8.TE_NO_POTENCIAL                        AS PE_NO_POTENCIAL              
	,LIT8.TE_PRIO                                AS PE_PRIO                      
	,LIT8.TE_ES_BCI                              AS PE_ES_BCI                    
	,LIT8.TE_MARCA_RUTGOB                        AS PE_MARCA_RUTGOB              
	,LIT8.TC_TEXTO1                              AS PC_TEXTO1                    
	,LIT8.TC_TEXTO2                              AS PC_TEXTO2                    
	,CASE 
    WHEN LIT8.TC_TIPO_BCA = 'WSB'
		AND LIT8.TE_DUPLAS > 0
		THEN 'Cliente en Campana Duplas, Coordinar Visita Ejecutivo Comercial'
    ELSE LIT8.TC_CARACTERISTICAS_CLIENTE
 	END 										 AS PC_CARACTERISTICAS_CLIENTE   
	,LIT8.TC_CAMPANA_OFERTA                      AS PC_CAMPANA_OFERTA            
	,LIT8.TE_EN_PLANEAMIENTO                     AS PE_EN_PLANEAMIENTO           
	,LIT8.TC_RECOMENDACION_DE_CRUCE              AS PC_RECOMENDACION_DE_CRUCE    
	,LIT8.TC_CALIFICACION_SBIF                   AS PC_CALIFICACION_SBIF         
	,LIT8.TT_PERIODO_CALIFICACION                AS PT_PERIODO_CALIFICACION      
	,LIT8.TD_PI_CLIENTE                          AS PD_PI_CLIENTE                
	,LIT8.TC_CLASIFICACION_SBIF                  AS PC_CLASIFICACION_SBIF        
	,LIT8.TE_FDR                                 AS PE_FDR                       
	,LIT8.TE_COS_CLI                             AS PE_COS_CLI                   
	,LIT8.TE_FILTROS_RIESGOS                     AS PE_FILTROS_RIESGOS           
	,LIT8.TC_PAR_CALIFICACION_SBIF               AS PC_PAR_CALIFICACION_SBIF     
	,LIT8.TD_PAR_PI_CLIENTE                      AS PD_PAR_PI_CLIENTE            
	,LIT8.TE_PAR_FDR                             AS PE_PAR_FDR                   
	,LIT8.TE_PAR_COS_CLI                         AS PE_PAR_COS_CLI               
	,LIT8.TE_MOLESTO                             AS PE_MOLESTO                   
	,LIT8.TE_CARGABLE                            AS PE_CARGABLE                  
	,LIT8.TC_ELIMINADO                           AS PC_ELIMINADO                 
	,LIT8.TE_DUPLAS                              AS PE_DUPLAS                    
	,LIT8.TE_PLAN_INVERSION                      AS PE_PLAN_INVERSION
	,LIT8.TE_NRO_OPT_PLAN_INVERSION				 AS PE_NRO_OPT_PLAN_INVERSION
	,LIT8.TE_MTO_OPT_PLAN_INVERSION              AS PE_MTO_OPT_PLAN_INVERSION    
	,LIT8.TC_PROD_1_PLAN_INVERSION               AS PC_PROD_1_PLAN_INVERSION     
	,LIT8.TC_PROD_2_PLAN_INVERSION               AS PC_PROD_2_PLAN_INVERSION     
	,LIT8.TC_PER_MIN_PLAN_INVERSION              AS PC_PER_MIN_PLAN_INVERSION    
	,LIT8.TC_PER_MAX_PLAN_INVERSION              AS PC_PER_MAX_PLAN_INVERSION    
	,LIT8.TE_CON_VENTAS                          AS PE_CON_VENTAS                
	,LIT8.TE_CON_VENTAS_ANT                      AS PE_CON_VENTAS_ANT            
	,LIT8.TE_LEASING_DATAMART                    AS PE_LEASING_DATAMART          
	,LIT8.TE_OPC_COMPRA                          AS PE_OPC_COMPRA                
	,LIT8.TC_PER_OPC_COMPRA                      AS PC_PER_OPC_COMPRA            
	,LIT8.TC_ESTRATEGIA                          AS PC_ESTRATEGIA                
	,LIT8.TC_PERFIL                              AS PC_PERFIL
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBLEA001OB_CAMPANA_LEASING_LIT_08 AS LIT8
;

.IF ERRORCODE <> 0 THEN .QUIT 26;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PD_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES_LIT;

.IF ERRORCODE <> 0 THEN .QUIT 27;

SELECT DATE, TIME;
.LOGOFF;
.QUIT 0;

UPDATE - Ejemplo 18 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: PROCESO DE CAMPANA LEASING WHOLESALE QUE ACTUALIZA LOS LITERALES			  **
--**                                                    				 				  **
--** AUTOR  : CESAR ROMERO MUNOZ                                               			  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 05/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN:                                                           				  **
--** AUTOR  :                                                           				  **
--** FECHA  : SSAAMMDD                                                  				  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES	      **
--**                                        											  **
--**                  											                          **
--** TABLA DE SALIDA:	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES		  **
--**                  					  												  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/***********************************************************************
--** ACTUALIZACION DE LITERALES - CAMPANA_LEASING_WHOLESALE_MES			**
--** SE ACTUALIZA VALORES PARA TEXTO1, TEXTO2 Y CARACTERISTICAS_CLIENTE **  
--***********************************************************************/	
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
SET
	PC_TEXTO1 = 
		CASE WHEN PD_MONTO_OFERTA > 0 
				THEN 'CLIENTE CON LINEA VIGENTE LEASING POR UF$' ||
					 OREPLACE(OREPLACE(OREPLACE(
					 CAST(CAST(CAST(PD_MONTO_OFERTA AS BIGINT) AS FORMAT 'G-(18)9') AS VARCHAR(50))
					 ,',','Q'),'.',','),'Q','.')|| ' (VALIDAR MARGENES)'
				ELSE '' 
		END
	,PC_TEXTO2 = 
		CASE WHEN PE_COTIZA = 1 
				THEN ', COTIZO Y NO COMPRO LEASING EN EL MES ANTERIOR' 
				ELSE ', CON PROPENSION LEASING ' 
		END
	,PC_CARACTERISTICAS_CLIENTE =
		CASE WHEN PE_COTIZA = 1  
				THEN 'COTIZA EN EL MES ANTERIOR Y NO COMPRA ' 
				ELSE '' 
		END 
WHERE 
	PC_TIPO_BCA = 'WSB'
;
.IF ERRORCODE <> 0 THEN .QUIT 1;

--/***********************************************************************
--** ACTUALIZACION DE LITERALES - CAMPANA_LEASING_WHOLESALE_MES			**
--** SE ACTUALIZA VALORES PARA TEXTO1 - ESTRATEGIA 						**  
--***********************************************************************/	
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
SET
	PC_TEXTO1 = 'CLIENTE CON ESTRATEGIA : (' ||
		CASE WHEN PC_ESTRATEGIA = '' 
				THEN 'S/I' 
				ELSE RTRIM(PC_ESTRATEGIA) 
		END ||
		CASE WHEN PC_PERFIL = 'POTENCIADO' 
				THEN '+' 
				ELSE '' 
		END ||
		'). ' || RTRIM(PC_TEXTO1)
WHERE 
	PC_TIPO_BCA = 'WSB'
;
.IF ERRORCODE <> 0 THEN .QUIT 2;
  
--/***********************************************************************
--** ACTUALIZACION DE LITERALES - CAMPANA_LEASING_WHOLESALE_MES			**
--** SE ACTUALIZA VALORES PARA TEXTO1 - ESTRATEGIA 						**  
--***********************************************************************/	
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
SET
	PC_TEXTO1 = RTRIM(PC_TEXTO1) || ' ' ||
		CASE WHEN PE_PLAN_INVERSION > 0 
				THEN ', EN PLAN INVERSION ' ||
					CASE WHEN PC_PER_MIN_PLAN_INVERSION=PC_PER_MAX_PLAN_INVERSION 
							THEN 'EN ' || RTRIM(PC_PER_MIN_PLAN_INVERSION) 
							ELSE 'ENTRE ' || RTRIM(PC_PER_MIN_PLAN_INVERSION) ||
								 ' Y ' || RTRIM(PC_PER_MAX_PLAN_INVERSION) 
					END ||
					', (TOTAL OPT. ' || RTRIM(PE_NRO_OPT_PLAN_INVERSION) ||
					'), (EN ' || RTRIM(PC_PROD_1_PLAN_INVERSION) || ' ' ||
					RTRIM(PC_PROD_2_PLAN_INVERSION) || ',POR $' ||
					OREPLACE(OREPLACE(OREPLACE(
					CAST(CAST(PE_MTO_OPT_PLAN_INVERSION AS FORMAT 'G-(18)D9(2)') AS VARCHAR(100))
					,',','Q'),'.',','),'Q','.') || ')' 
				ELSE '' 
		END
WHERE 
	PC_TIPO_BCA = 'WSB'
;
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/***********************************************************************
--** ACTUALIZACION DE LITERALES - CAMPANA_LEASING_WHOLESALE_MES			**
--** SE ACTUALIZA VALORES PARA TEXTO1 - INCORPORADO POR CLIENTES SIN 	**
--** OFERTA PERO CON PROPENSION 										**  
--***********************************************************************/	
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
SET
	PC_TEXTO1 = PC_TEXTO2
WHERE 
	PC_TIPO_BCA = 'WSB'
	AND PC_ELIMINADO = '' 
	AND PC_TEXTO1 = ''
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

--/***********************************************************************
--** ACTUALIZACION CARACTERISTICAS_CLIENTE-CAMPANA_LEASING_WHOLESALE_MES**
--***********************************************************************/	
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
SET
	PC_CARACTERISTICAS_CLIENTE = SUBSTRING(RTRIM(PC_CARACTERISTICAS_CLIENTE),1,100)
WHERE 
	PC_TIPO_BCA = 'WSB'
	AND PC_ELIMINADO = '' 
;
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/***********************************************************************
--** ACTUALIZACION CARACTERISTICAS_CLIENTE-CAMPANA_LEASING_WHOLESALE_MES**
--** PARA LAS VARIABLES OPC_COMPRA Y LEASING_DATAMART 					**
--***********************************************************************/	
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
SET
	PC_CARACTERISTICAS_CLIENTE = 
		CASE WHEN (PE_OPC_COMPRA + PE_LEASING_DATAMART) >= 2  
				THEN 'Propenso Datamart y Con Opc. Compra en : ' ||
					PC_PER_OPC_COMPRA
			 WHEN PE_OPC_COMPRA = 1 
				THEN 'Con Opc. Compra en : ' || PC_PER_OPC_COMPRA
			 WHEN PE_LEASING_DATAMART = 1 
				THEN 'Propenso Datamart '
		END
WHERE 
	PC_TIPO_BCA = 'WSB'
	AND (PE_OPC_COMPRA + PE_LEASING_DATAMART) > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/***********************************************************************
--** ACTUALIZACION CARACTERISTICAS_CLIENTE-CAMPANA_LEASING_WHOLESALE_MES**
--***********************************************************************/	
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES
SET
	PC_TEXTO2 = PC_TEXTO2 || ' / ' || 'CLIENTES CON CURSE'
WHERE 
	PC_TIPO_BCA = 'WSB'
	AND PE_CON_VENTAS_ANT > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 7;

;
UPDATE A
	FROM  {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES A
	SET PC_CARACTERISTICAS_CLIENTE = substring('Cliente con Estrategia : ('||case when pc_estrategia in ('','Nuevos','nuevo') then 'Nuevos' else RTRIM(pc_estrategia) end  
		||case when pc_perfil in ('potenciar','potenciado') then '+' else '' end||') '
		||rtrim(PC_CARACTERISTICAS_CLIENTE),1,100)
	WHERE PC_TIPO_BCA = 'WSB'
; 
.IF ERRORCODE <> 0 THEN .QUIT 8;
UPDATE A
	FROM  {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES A
	SET PC_CARACTERISTICAS_CLIENTE = substring(rtrim(PC_CARACTERISTICAS_CLIENTE)||', Se Sugiere Visita Presencial',1,100)	
	WHERE PC_TIPO_BCA = 'WSB'
	and pc_perfil in ('potenciar','potenciado')
;
.IF ERRORCODE <> 0 THEN .QUIT 9;
UPDATE A
	FROM  {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES A
	SET PC_CARACTERISTICAS_CLIENTE = substring(rtrim(PC_CARACTERISTICAS_CLIENTE)||', Se Sugiere Contacto Telefonico',1,100)	
	WHERE PC_TIPO_BCA = 'WSB'
	and pc_perfil  not in ('potenciar','potenciado')
;
.IF ERRORCODE <> 0 THEN .QUIT 10;
	UPDATE A
	FROM {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES A 
	SET PC_CARACTERISTICAS_CLIENTE = 'Cliente en Campana Duplas, Coordinar Visita Ejecutivo Comercial'	
	WHERE PC_TIPO_BCA = 'WSB'
	AND PE_DUPLAS>0	
;
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_CLI_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBLEA001OB_CAMPANA_LEASING_WHOLESALE_MES;
.IF ERRORCODE <> 0 THEN .QUIT 12;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 19 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: CAMBIA LOS FILTROS DE RIESGO PARA EL PO DE CAMPANA ONBOARDING MANDATOS	  **
--**          BTG WSB                                          				 			  **
--** AUTOR  : CESAR ROMERO MUNOZ                                          			  	  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 07/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN:                                                           				  **
--** AUTOR  :                                                           				  **
--** FECHA  : SSAAMMDD                                                  				  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	 																  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP                 **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CALIF_SBIF               	  **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_FDR		              		  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP			          **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_NO_CONTACTAR			  	  **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO				      	  **
--**																					  **                 
--**TABLA DE SALIDA:    							                	                  **
--**                  	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES**
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARAMETROS									  **  
--*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PARAMETRO;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PARAMETRO
(
	 TC_CALIFICACION		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CALIFICACIONM		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PI					DECIMAL(18,8)
	,TE_FDR					INTEGER
	,TE_COS					INTEGER
) PRIMARY INDEX (TC_CALIFICACION)
;
.IF ERRORCODE <> 0 THEN .QUIT 1;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PARAMETRO
SELECT 
	 SC_CALIFICACION	AS TC_CALIFICACION	
	,SC_CALIFICACIONM	AS TC_CALIFICACIONM	
	,SD_PI				AS TD_PI				
	,SE_FDR				AS TE_FDR				
	,SE_COS				AS TE_COS				
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP
WHERE
	SC_CAMPANA = 'MESA_BLINDAR_ACTIVAR_CAPTAR'
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_CALIFICACION)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PARAMETRO;
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE CAMPANA MESA BLINDAR ACTIVAR CAPTAR            **
--** P_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES                            **  
--** CAMPOS PAR_CALIFICACION_SBIF, PAR_PI_CLIENTE, PAR_FDR Y PAR_COS_CLI  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES 
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PARAMETRO AS PAR
SET 
	 PC_PAR_CALIFICACION_SBIF = 
		CASE WHEN PAR.TC_CALIFICACIONM IS NULL 
				THEN 'NULL' 
				ELSE TC_CALIFICACIONM
		END
	,PD_PAR_PI_CLIENTE  = PAR.TD_PI
	,PE_PAR_FDR 		= PAR.TE_FDR
	,PE_PAR_COS_CLI 	= PAR.TE_COS
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL CON PO CRUZADA CON CALIFICACIONES SBIF, SI LA **
--** CALIFICACION ES NULA, SE CAMBIA POR 0.								  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_CALIF;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_CALIF
(
	 TE_RUT				INTEGER
	,TC_CALIFICACION	VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TF_PERIODO			DATE FORMAT 'YYYY-MM-DD'
	,TC_CLASIFICACION	VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PI				DECIMAL(18,8)
) PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 5;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_CALIF
SELECT
	 ACA.PE_RUT							AS TE_RUT
	,COALESCE(CAL.IC_CALIFICACION_SBIF,'0')	AS TC_CALIFICACION
	,CAL.IF_PERIODO_CALIFICACION_SBIF		AS TF_PERIODO
	,CAL.IC_CLASIFICACION_SBIF				AS TC_CLASIFICACION
	,COALESCE(CAL.ID_PI_CLIENTE,0)			AS TD_PI
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES AS ACA
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CALIF_SBIF AS CAL
		ON ACA.PE_RUT = CAL.IE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_CALIF;
.IF ERRORCODE <> 0 THEN .QUIT 7;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE CAMPANA MESA BLINDAR ACTIVAR CAPTAR            **
--** P_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES	                          **  
--** CAMPOS CALIFICACION_SBIF, PERIODO_CALIFICACION, CLASIFICACION_SBIF Y **
--** PI_CLIENTE															  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES 
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_CALIF AS CAL
SET 
	PC_CALIFICACION_SBIF 	= CAL.TC_CALIFICACION
  , PF_PERIODO_CALIFICACION = CAL.TF_PERIODO
  , PC_CLASIFICACION_SBIF 	= CAL.TC_CLASIFICACION
  , PD_PI_CLIENTE 			= CAL.TD_PI
WHERE
	PE_RUT = CAL.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE CAMPANA MESA BLINDAR ACTIVAR CAPTAR            **
--** P_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES	CAMPO FDR                 **  
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES 
FROM
	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_FDR AS MFR
SET 
	PE_FDR = MFR.IE_FDR 
WHERE
	PE_RUT = MFR.IE_CLI_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA CCEE_Y_RIP CRUZADA CON PO PARA SACAR	  **  
--** INDICADOR COS_CLI													  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_COS_CLI;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_COS_CLI
(
	 TE_RUT			INTEGER
	,TE_COS_CLI		INTEGER
) PRIMARY INDEX (TE_RUT, TE_COS_CLI)
;
.IF ERRORCODE <> 0 THEN .QUIT 10;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_COS_CLI
SELECT
	MBA.PE_RUT	AS TE_RUT
	,CASE WHEN RIP.SE_CLIENTE_RUT IS NULL 
			THEN 0 
			ELSE 1 
	END				AS TE_COS_CLI
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES AS MBA
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP AS RIP
		ON MBA.PE_RUT = RIP.SE_CLIENTE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT, TE_COS_CLI)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_COS_CLI;
.IF ERRORCODE <> 0 THEN .QUIT 12;
	
--/*************************************************************************
--** SE ACTUALIZA TABLA DE CAMPANA MESA BLINDAR ACTIVAR CAPTAR            **
--** P_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES	CAMPO  COS_CLI            **  
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES 
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_COS_CLI AS FCC
SET 
	PE_COS_CLI = FCC.TE_COS_CLI
WHERE
	PE_RUT = FCC.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 13;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL CON RUT UNICOS DE PO, DONDE ELLOS CUMPLAN     **
--** LAS CONDICIONES DE LOS FILTROS DE RIESGO. SIN FILTRO DE			  **  
--** **CALIFICACION_SBIF**												  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_RUT;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_RUT
(
	 TE_RUT			INTEGER
) PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 14;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_RUT
SELECT
	ACM.PE_RUT	AS TE_RUT
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES AS ACM
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PARAMETRO AS PAR
		ON ACM.PD_PI_CLIENTE  <= PAR.TD_PI
			AND ACM.PE_FDR >= PAR.TE_FDR
			AND ACM.PE_COS_CLI = PAR.TE_COS
;
.IF ERRORCODE <> 0 THEN .QUIT 15;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_RUT;
.IF ERRORCODE <> 0 THEN .QUIT 16;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE CAMPANA MESA BLINDAR ACTIVAR CAPTAR            **
--** P_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES	CAMPO FILTROS_RIESGOS     **  
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES 
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_RUT AS POR
SET 
	PE_FILTROS_RIESGOS = 1
WHERE
	PE_RUT = POR.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 17;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA CLIENTES PO NO_CONTACTAR, REGISTRANDO 	  **  
--** INDICADOR MOLESTO													  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_MOL;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_MOL
(
	 TE_RUT			INTEGER
	,TE_MOLESTO		INTEGER
) PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 18;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_MOL
SELECT
	BAC.PE_RUT	AS TE_RUT
	,CASE WHEN MOL.IE_RUT IS NULL 
			THEN 0 
			ELSE 1 
	END				AS TE_MOLESTO
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES AS BAC
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_NO_CONTACTAR AS MOL
		ON BAC.PE_RUT = MOL.IE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 19;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_MOL;
.IF ERRORCODE <> 0 THEN .QUIT 20;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE CAMPANA MESA BLINDAR ACTIVAR CAPTAR            **
--** P_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES	CAMPO MOLESTO             **  
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES 
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_MOL AS MOL
SET
	PE_MOLESTO = MOL.TE_MOLESTO
WHERE
	PE_RUT = MOL.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 21;
	
--/*************************************************************************
--** SE ACTUALIZA TABLA DE CAMPANA MESA BLINDAR ACTIVAR CAPTAR            **
--** P_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES	CAMPOS EN_PLANEAMIENTO,   **
--** RECOMENDACION_DE_CRUCE                                               **  
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES 
FROM
	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO AS MMP
SET
	 PE_EN_PLANEAMIENTO = 1
	,PC_RECOMENDACION_DE_CRUCE = MMP.IC_RECOMENDACION_DE_CRUCE
WHERE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES.PE_RUT = MMP.IE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 22;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP,PE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES;
.IF ERRORCODE <> 0 THEN .QUIT 23;



SELECT DATE, TIME; 

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 19 OK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: CAMBIA LOS FILTROS DE RIESGO PARA EL PO DE CAMPANA ONBOARDING MANDATOS	  **
--**          BTG WSB                                          				 			  **
--** AUTOR  : CESAR ROMERO MUNOZ                                          			  	  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 07/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 12/2024			     	                                                  **
--*****************************************************************************************/
--**TABLA DE ENTRADA:	 																  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP                 	  **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CALIF_SBIF               	  	  **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_FDR		              		  	  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP			          	  **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_NO_CONTACTAR			  	  	  **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO				      	  	  **
--**																					  **                 
--**TABLA DE SALIDA:    							                	                  **
--**   {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES_PO**
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARAMETROS									  **  
--*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PARAMETRO;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PARAMETRO
(
	 TC_CALIFICACION		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CALIFICACIONM		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PI					DECIMAL(18,8)
	,TE_FDR					INTEGER
	,TE_COS					INTEGER
) UNIQUE PRIMARY INDEX (TC_CALIFICACION)
;
.IF ERRORCODE <> 0 THEN .QUIT 1;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PARAMETRO
SELECT 
	 SC_CALIFICACION	AS TC_CALIFICACION	
	,SC_CALIFICACIONM	AS TC_CALIFICACIONM	
	,SD_PI				AS TD_PI				
	,SE_FDR				AS TE_FDR				
	,SE_COS				AS TE_COS				
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP
WHERE
	SC_CAMPANA = 'MESA_BLINDAR_ACTIVAR_CAPTAR'
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_CALIFICACION)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PARAMETRO;
.IF ERRORCODE <> 0 THEN .QUIT 3;


--/*************************************************************************
--** SE CREA TABLA TEMPORAL CON PO CRUZADA CON CALIFICACIONES SBIF, SI LA **
--** CALIFICACION ES NULA, SE CAMBIA POR 0.								  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_CALIF;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_CALIF
(
	 TD_RUT				DECIMAL(8,0)
	,TC_CALIFICACION	VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TF_PERIODO			DATE FORMAT 'YYYY-MM-DD'
	,TC_CLASIFICACION	VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PI				DECIMAL(18,8)
) UNIQUE PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 4;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_CALIF
SELECT
	 ACA.PD_RUT								AS TD_RUT
	,COALESCE(CAL.IC_CALIFICACION_SBIF,'0')	AS TC_CALIFICACION
	,CAL.IF_PERIODO_CALIFICACION_SBIF		AS TF_PERIODO
	,CAL.IC_CLASIFICACION_SBIF				AS TC_CLASIFICACION
	,COALESCE(CAL.ID_PI_CLIENTE,0)			AS TD_PI
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES_PO AS ACA
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CALIF_SBIF AS CAL
		ON ACA.PD_RUT = CAL.IE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_CALIF;
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA CCEE_Y_RIP CRUZADA CON PO PARA SACAR	  **  
--** INDICADOR COS_CLI													  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_COS_CLI;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_COS_CLI
(
	 TD_RUT			DECIMAL(8,0)
	,TE_COS_CLI		INTEGER
) UNIQUE PRIMARY INDEX (TD_RUT, TE_COS_CLI)
;
.IF ERRORCODE <> 0 THEN .QUIT 7;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_COS_CLI
SELECT
	MBA.PD_RUT	AS TD_RUT
	,CASE WHEN RIP.SE_CLIENTE_RUT IS NULL 
			THEN 0 
			ELSE 1 
	END				AS TE_COS_CLI
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES_PO AS MBA
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP AS RIP
		ON MBA.PD_RUT = RIP.SE_CLIENTE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT, TE_COS_CLI)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_COS_CLI;
.IF ERRORCODE <> 0 THEN .QUIT 9;
	
--/*************************************************************************
--** SE ACTUALIZA CAMPOS										          **
--** CAMPOS PAR_CALIFICACION_SBIF, PAR_PI_CLIENTE, PAR_FDR Y PAR_COS_CLI  **
--** PI_CLIENTE, FDR, COS_CLI            								  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_FR_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_FR_01
(
	 TE_PERIODO_CMP							INTEGER
	,TC_TIPO_CMP							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CAMPANA_BLINDAR                   	INTEGER
    ,TC_CAUSA_BLINDAR                     	VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_RUT 							 	DECIMAL(8,0)	
	,TE_VALOR							 	BIGINT
	,TE_VALOR_FIJO  						BIGINT
	,TC_FUENTE_POTENCIAL					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_POTENCIAL_MOVIL_PARA_EXCLUIR		BIGINT
	,TE_OPERA_CHINA							INTEGER
	,TE_MTO_CHINA_USD						BIGINT
	,TE_YA_CAMPANADO						INTEGER
	,TC_MACRO_BANCA							VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_REGIONAL    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_CTA_CTE								INTEGER
	,TC_EJE_CMP								VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_COMEX    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_MESA    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_IQUIQUE_DESCARTAR					INTEGER	
	,TE_EN_LISTA_NEGRA						INTEGER	
	,TC_TEXTO1 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3 								VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CALIFICACION_SBIF 					VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TF_PERIODO_CALIFICACION  				DATE FORMAT	'YYYY-MM-DD'
	,TD_PI_CLIENTE  						DECIMAL (25,10)
	,TC_CLASIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_FDR 								INTEGER
	,TE_COS_CLI         					INTEGER
	,TE_FILTROS_RIESGOS 					INTEGER
	,TC_PAR_CALIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE 						DECIMAL (25,10)
	,TE_PAR_FDR 							INTEGER
	,TE_PAR_COS_CLI   						INTEGER
	,TE_MOLESTO 							INTEGER
	,TE_CARGABLE							INTEGER
	,TC_ELIMINADO  							VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_NO_CUMPLE_POTENCIAL                 INTEGER
	,TE_EN_PLANEAMIENTO 					INTEGER
	,TC_RECOMENDACION_DE_CRUCE 				VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FLG_EXCLUSION						INTEGER
	,TC_MOTIVO_EXCLUSION					VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CANAL_ASIGNACION                    VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
) UNIQUE PRIMARY INDEX (TE_PERIODO_CMP,TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 10;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_FR_01
SELECT 
	 WPO.PE_PERIODO_CMP							AS TE_PERIODO_CMP                 
	,WPO.PC_TIPO_CMP                            AS TC_TIPO_CMP                    
	,WPO.PE_CAMPANA_BLINDAR						AS TE_CAMPANA_BLINDAR             
	,WPO.PC_CAUSA_BLINDAR                       AS TC_CAUSA_BLINDAR               
	,WPO.PD_RUT                                 AS TD_RUT                         
	,WPO.PE_VALOR                               AS TE_VALOR                       
	,WPO.PE_VALOR_FIJO                          AS TE_VALOR_FIJO                  
	,WPO.PC_FUENTE_POTENCIAL                    AS TC_FUENTE_POTENCIAL            
	,WPO.PE_POTENCIAL_MOVIL_PARA_EXCLUIR        AS TE_POTENCIAL_MOVIL_PARA_EXCLUIR
	,WPO.PE_OPERA_CHINA                         AS TE_OPERA_CHINA                 
	,WPO.PE_MTO_CHINA_USD                       AS TE_MTO_CHINA_USD               
	,WPO.PE_YA_CAMPANADO                        AS TE_YA_CAMPANADO                
	,WPO.PC_MACRO_BANCA                         AS TC_MACRO_BANCA                 
	,WPO.PC_REGIONAL                            AS TC_REGIONAL                    
	,WPO.PE_CTA_CTE                             AS TE_CTA_CTE                     
	,WPO.PC_EJE_CMP                             AS TC_EJE_CMP      
	,WPO.PC_EJE_COMEX							AS TC_EJE_COMEX 
	,WPO.PC_EJE_MESA							AS TC_EJE_MESA   	
	,WPO.PE_IQUIQUE_DESCARTAR                   AS TE_IQUIQUE_DESCARTAR           
	,WPO.PE_EN_LISTA_NEGRA                      AS TE_EN_LISTA_NEGRA              
	,WPO.PC_TEXTO1                              AS TC_TEXTO1                      
	,WPO.PC_TEXTO2                              AS TC_TEXTO2                      
	,WPO.PC_TEXTO3                              AS TC_TEXTO3                              

	,CASE WHEN CAL.TD_RUT IS NOT NULL 
		THEN CAL.TC_CALIFICACION
		ELSE WPO.PC_CALIFICACION_SBIF END 		AS TC_CALIFICACION_SBIF 	

	,CASE WHEN CAL.TD_RUT IS NOT NULL 
		THEN CAL.TF_PERIODO
		ELSE WPO.PF_PERIODO_CALIFICACION END 	AS TF_PERIODO_CALIFICACION 	
			
	,CASE WHEN CAL.TD_RUT IS NOT NULL 
		THEN CAL.TD_PI
		ELSE WPO.PD_PI_CLIENTE END 				AS TD_PI_CLIENTE 	
			
	,CASE WHEN CAL.TD_RUT IS NOT NULL 
		THEN CAL.TC_CLASIFICACION
		ELSE WPO.PC_CLASIFICACION_SBIF END 		AS TC_CLASIFICACION_SBIF 	

    ,CASE WHEN MFR.IE_CLI_RUT IS NOT NULL 
		THEN MFR.IE_FDR
		ELSE WPO.PE_FDR	END        				AS TE_FDR 

    ,CASE WHEN FCC.TD_RUT IS NOT NULL
		THEN FCC.TE_COS_CLI
		ELSE WPO.PE_COS_CLI END    				AS TE_COS_CLI 	
                 
	,WPO.PE_FILTROS_RIESGOS                     AS TE_FILTROS_RIESGOS             

	,CASE WHEN PAR.TC_CALIFICACIONM IS NULL 
			THEN 'NULL' 
			ELSE PAR.TC_CALIFICACIONM  END		AS TC_PAR_CALIFICACION_SBIF 	
    ,PAR.TD_PI 	       							AS TD_PAR_PI_CLIENTE  	
    ,PAR.TE_FDR 		       					AS TE_PAR_FDR 		
    ,PAR.TE_COS 		       					AS TE_PAR_COS_CLI             

	,WPO.PE_MOLESTO                             AS TE_MOLESTO                     
	,WPO.PE_CARGABLE                            AS TE_CARGABLE                    
	,WPO.PC_ELIMINADO                           AS TC_ELIMINADO                   
	,WPO.PE_NO_CUMPLE_POTENCIAL                 AS TE_NO_CUMPLE_POTENCIAL         
	,WPO.PE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO             
	,WPO.PC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE      
	,WPO.PE_FLG_EXCLUSION                       AS TE_FLG_EXCLUSION               
	,WPO.PC_MOTIVO_EXCLUSION                    AS TC_MOTIVO_EXCLUSION            
	,WPO.PC_CANAL_ASIGNACION                    AS TC_CANAL_ASIGNACION            
FROM {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES_PO WPO
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PARAMETRO AS PAR
	ON 1 = 1 
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_CALIF AS CAL
	ON WPO.PD_RUT = CAL.TD_RUT
LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_FDR AS MFR
	ON WPO.PD_RUT = MFR.IE_CLI_RUT
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_COS_CLI AS FCC
	ON WPO.PD_RUT = FCC.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP,TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_FR_01;
.IF ERRORCODE <> 0 THEN .QUIT 12;


--/*************************************************************************
--** SE CREA TABLA TEMPORAL CON RUT UNICOS DE PO, DONDE ELLOS CUMPLAN     **
--** LAS CONDICIONES DE LOS FILTROS DE RIESGO. SIN FILTRO DE			  **  
--** **CALIFICACION_SBIF**												  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_RUT;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_RUT
(
	 TD_RUT			DECIMAL(8,0)
) UNIQUE PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 13;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_RUT
SELECT
	T01.TD_RUT	AS TD_RUT
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_FR_01 AS T01
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PARAMETRO AS PAR
		ON T01.TD_PI_CLIENTE  <= PAR.TD_PI
			AND T01.TE_FDR >= PAR.TE_FDR
			AND T01.TE_COS_CLI = PAR.TE_COS
;
.IF ERRORCODE <> 0 THEN .QUIT 14;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_RUT;
.IF ERRORCODE <> 0 THEN .QUIT 15;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA CLIENTES PO NO_CONTACTAR, REGISTRANDO 	  **  
--** INDICADOR MOLESTO													  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_MOL;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_MOL
(
	 TD_RUT			DECIMAL(8,0)
	,TE_MOLESTO		INTEGER
) UNIQUE PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 16;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_MOL
SELECT
	T01.TD_RUT	AS TD_RUT
	,CASE WHEN MOL.IE_RUT IS NULL 
			THEN 0 
			ELSE 1 
	END				AS TE_MOLESTO
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_FR_01 AS T01
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_NO_CONTACTAR AS MOL
		ON T01.TD_RUT = MOL.IE_RUT
QUALIFY ROW_NUMBER() OVER(PARTITION BY T01.TD_RUT ORDER BY T01.TE_PERIODO_CMP DESC ) = 1  		
;
.IF ERRORCODE <> 0 THEN .QUIT 17;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_MOL;
.IF ERRORCODE <> 0 THEN .QUIT 18;

--/*************************************************************************
--** SE ACTUALIZA CAMPOS										          **
--** 	FILTROS_RIESGOS, CAMPO MOLESTO, CAMPOS EN_PLANEAMIENTO,    		  **
--** 	RECOMENDACION_DE_CRUCE                                            **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES_FR;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES_FR
(
	 PE_PERIODO_CMP							INTEGER
	,PC_TIPO_CMP							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_CAMPANA_BLINDAR                   	INTEGER
    ,PC_CAUSA_BLINDAR                     	VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_RUT 							 	DECIMAL(8,0)	
	,PE_VALOR							 	BIGINT
	,PE_VALOR_FIJO  						BIGINT
	,PC_FUENTE_POTENCIAL					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_POTENCIAL_MOVIL_PARA_EXCLUIR		BIGINT
	,PE_OPERA_CHINA							INTEGER
	,PE_MTO_CHINA_USD						BIGINT
	,PE_YA_CAMPANADO						INTEGER
	,PC_MACRO_BANCA							VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_REGIONAL    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_CTA_CTE								INTEGER
	,PC_EJE_CMP								VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_EJE_COMEX    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_EJE_MESA    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC		
	,PE_IQUIQUE_DESCARTAR					INTEGER	
	,PE_EN_LISTA_NEGRA						INTEGER	
	,PC_TEXTO1 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO2 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO3 								VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_CALIFICACION_SBIF 					VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,PF_PERIODO_CALIFICACION  				DATE FORMAT	'YYYY-MM-DD'
	,PD_PI_CLIENTE  						DECIMAL (25,10)
	,PC_CLASIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_FDR 								INTEGER
	,PE_COS_CLI         					INTEGER
	,PE_FILTROS_RIESGOS 					INTEGER
	,PC_PAR_CALIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,PD_PAR_PI_CLIENTE 						DECIMAL (25,10)
	,PE_PAR_FDR 							INTEGER
	,PE_PAR_COS_CLI   						INTEGER
	,PE_MOLESTO 							INTEGER
	,PE_CARGABLE							INTEGER
	,PC_ELIMINADO  							VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC	
	,PE_NO_CUMPLE_POTENCIAL                 INTEGER
	,PE_EN_PLANEAMIENTO 					INTEGER
	,PC_RECOMENDACION_DE_CRUCE 				VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC	
	,PE_FLG_EXCLUSION						INTEGER
	,PC_MOTIVO_EXCLUSION					VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_CANAL_ASIGNACION                    VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
) UNIQUE PRIMARY INDEX (PE_PERIODO_CMP,PD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 19;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES_FR
SELECT 
	 T01.TE_PERIODO_CMP							AS PE_PERIODO_CMP                 
	,T01.TC_TIPO_CMP                            AS PC_TIPO_CMP                    
	,T01.TE_CAMPANA_BLINDAR						AS PE_CAMPANA_BLINDAR             
	,T01.TC_CAUSA_BLINDAR                       AS PC_CAUSA_BLINDAR               
	,T01.TD_RUT                                 AS PD_RUT                         
	,T01.TE_VALOR                               AS PE_VALOR                       
	,T01.TE_VALOR_FIJO                          AS PE_VALOR_FIJO                  
	,T01.TC_FUENTE_POTENCIAL                    AS PC_FUENTE_POTENCIAL            
	,T01.TE_POTENCIAL_MOVIL_PARA_EXCLUIR        AS PE_POTENCIAL_MOVIL_PARA_EXCLUIR
	,T01.TE_OPERA_CHINA                         AS PE_OPERA_CHINA                 
	,T01.TE_MTO_CHINA_USD                       AS PE_MTO_CHINA_USD               
	,T01.TE_YA_CAMPANADO                        AS PE_YA_CAMPANADO                
	,T01.TC_MACRO_BANCA                         AS PC_MACRO_BANCA                 
	,T01.TC_REGIONAL                            AS PC_REGIONAL                    
	,T01.TE_CTA_CTE                             AS PE_CTA_CTE                     
	,T01.TC_EJE_CMP                             AS PC_EJE_CMP     
	,T01.TC_EJE_COMEX							AS PC_EJE_COMEX 
	,T01.TC_EJE_MESA							AS PC_EJE_MESA   	                
	,T01.TE_IQUIQUE_DESCARTAR                   AS PE_IQUIQUE_DESCARTAR           
	,T01.TE_EN_LISTA_NEGRA                      AS PE_EN_LISTA_NEGRA              
	,T01.TC_TEXTO1                              AS PC_TEXTO1                      
	,T01.TC_TEXTO2                              AS PC_TEXTO2                      
	,T01.TC_TEXTO3                              AS PC_TEXTO3                              
	,T01.TC_CALIFICACION_SBIF 					AS PC_CALIFICACION_SBIF 	
	,T01.TF_PERIODO_CALIFICACION 				AS PF_PERIODO_CALIFICACION 	
	,T01.TD_PI_CLIENTE							AS PD_PI_CLIENTE 	
	,T01.TC_CLASIFICACION_SBIF 					AS PC_CLASIFICACION_SBIF 	
    ,T01.TE_FDR    								AS PE_FDR 
    ,T01.TE_COS_CLI   							AS PE_COS_CLI 	         

	,CASE WHEN POR.TD_RUT IS NOT NULL
		THEN 1
		ELSE T01.TE_FILTROS_RIESGOS END			AS PE_FILTROS_RIESGOS 	
            
	,T01.TC_PAR_CALIFICACION_SBIF				AS PC_PAR_CALIFICACION_SBIF 	
    ,T01.TD_PAR_PI_CLIENTE 	       				AS PD_PAR_PI_CLIENTE  	
    ,T01.TE_PAR_FDR 		       				AS PE_PAR_FDR 		
    ,T01.TE_PAR_COS_CLI 		       			AS PE_PAR_COS_CLI             

    ,CASE WHEN MOL.TD_RUT IS NOT NULL 
		THEN MOL.TE_MOLESTO
		ELSE T01.TE_MOLESTO END    				AS PE_MOLESTO 	

	,T01.TE_CARGABLE                            AS PE_CARGABLE                    
	,T01.TC_ELIMINADO                           AS PC_ELIMINADO                   
	,T01.TE_NO_CUMPLE_POTENCIAL                 AS PE_NO_CUMPLE_POTENCIAL   

    ,CASE WHEN MMP.IE_RUT IS NOT NULL
		THEN 1
		ELSE T01.TE_EN_PLANEAMIENTO	END 	AS PE_EN_PLANEAMIENTO 	

    ,CASE WHEN MMP.IE_RUT IS NOT NULL 
		THEN MMP.IC_RECOMENDACION_DE_CRUCE 
		ELSE T01.TC_RECOMENDACION_DE_CRUCE 
		END 								AS PC_RECOMENDACION_DE_CRUCE 
 
	,T01.TE_FLG_EXCLUSION                       AS PE_FLG_EXCLUSION               
	,T01.TC_MOTIVO_EXCLUSION                    AS PC_MOTIVO_EXCLUSION            
	,T01.TC_CANAL_ASIGNACION                    AS PC_CANAL_ASIGNACION            
FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_FR_01 T01
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_PO_RUT AS POR
	ON T01.TD_RUT = POR.TD_RUT
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MES_BLIN_ACTV_CAP_FDR_MOL AS MOL
	ON 	T01.TD_RUT = MOL.TD_RUT
LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO AS MMP
	ON 	T01.TD_RUT = MMP.IE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 20;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP,PD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES_FR;
.IF ERRORCODE <> 0 THEN .QUIT 21;

SELECT DATE, TIME; 

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 2 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: HABILITADORES 360															  **
--**                                                    				 				  **
--** AUTOR  : FRANCISCO PINOCHET                                               	  		    **
--** EMPRESA: FACTORIT                                   				  				                **
--** FECHA  : 03/2024                                                   				          **
--/*****************************************************************************************
--/*****************************************************************************************
--** MANTNCN: 														                                                **
--** AUTOR  : 				                                                           	        **
--** FECHA  : 			                                                  				            **
--/*****************************************************************************************
--/*****************************************************************************************
--**TABLA DE ENTRADA:	MKT_JOURNEY_TB.WHOLESALE_HABILITADORES							  
--**					MKT_JOURNEYBUILDER_TB.S_CMP_PERIODO_CAMPANA                  
--**					{{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADORES_MX                 	  
--**					MKT_EXPLORER_TB.WHOLESALE_ENROLADOS_360_HIST        			  
--**					{{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADO_360_MX                	  
--**																					  
--**TABLAS TEMPORALES:	
--**					{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_HABILITADORES_01_MX
--**
--** TABLA DE SALIDA:	{{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADORES_MX				  	  
--**					{{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADO_360_MX				  	  
--**                                      												  
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/***********************************************************************
--**			CREA TABLA DE SALIDA									**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADORES_MX;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADORES_MX
(
	 PF_FECHA 				DATE FORMAT 'YYYY-MM-DD'
	,PD_RUT 				DECIMAL(8,0)
	,PE_ART85 				INTEGER
	,PE_SIN_APR 			INTEGER
	,PE_MANDATO_CCL 		INTEGER
	,PE_ESTADO_MULTIPASS 	INTEGER
	,PE_FYP_2 				INTEGER
	,PE_FYP_52 				INTEGER
	,PE_FYP_53 				INTEGER
	,PE_FYP_8 				INTEGER)
PRIMARY INDEX ( PD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 001;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADORES_MX
SELECT
	 HBL.FECHA				AS PF_FECHA
	,HBL.RUT 				AS PD_RUT 				
    ,HBL.ART85 			    AS PE_ART85 			
    ,HBL.SIN_APR 		    AS PE_SIN_APR 		
    ,HBL.MANDATO_CCL 	    AS PE_MANDATO_CCL 	
    ,HBL.ESTADO_MULTIPASS   AS PE_ESTADO_MULTIPASS
    ,HBL.FYP_2 			    AS PE_FYP_2 			
    ,HBL.FYP_52 			AS PE_FYP_52 			
    ,HBL.FYP_53 			AS PE_FYP_53 			
    ,HBL.FYP_8              AS PE_FYP_8 			
FROM 
	MKT_JOURNEY_TB.WHOLESALE_HABILITADORES AS HBL
	INNER JOIN MKT_JOURNEYBUILDER_TB.S_CMP_PERIODO_CAMPANA AS PAR
		ON HBL.FECHA = PAR.SF_FECHA_REF_HB
GROUP BY
	 HBL.FECHA
	,HBL.RUT 			
    ,HBL.ART85 			
    ,HBL.SIN_APR 		
    ,HBL.MANDATO_CCL 	
    ,HBL.ESTADO_MULTIPASS
    ,HBL.FYP_2 			
    ,HBL.FYP_52 			
    ,HBL.FYP_53 			
    ,HBL.FYP_8
;
.IF ERRORCODE <> 0 THEN .QUIT 002;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADORES_MX;
.IF ERRORCODE <> 0 THEN .QUIT 003;

--/***********************************************************************
--**						UPDATE				 						**  
--***********************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADORES_MX AS HBT
	SET 
	 PE_ESTADO_MULTIPASS = HBT.PE_ESTADO_MULTIPASS
	,PE_MANDATO_CCL= HBT.PE_MANDATO_CCL
	,PE_SIN_APR=HBT.PE_SIN_APR
	,PE_ART85 = HBT.PE_ART85
	,PC_FECHA_HAB = CAST(HBT.PF_fecha AS VARCHAR(100))
WHERE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES.PD_RUT = HBT.PD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 004;

--/************************************************************
--** CREA TABLA TEMPORAL AGRUPAR RUT DE LOS HABILITADORES    **  
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_HABILITADORES_01_MX;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_HABILITADORES_01_MX
(
	 TD_RUT 			DECIMAL(8,0)
	,TE_IND_HAB			INTEGER)
PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 005;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_HABILITADORES_01_MX
SELECT 
	 PD_RUT AS TD_RUT
	,CASE 
			WHEN PE_FYP_2=1 AND PE_FYP_52=1 AND PE_FYP_8=1 THEN 1
			WHEN PE_FYP_2=1 AND PE_FYP_53=1 AND PE_FYP_8=1 THEN 1
		ELSE 0 
	 END 	AS TE_IND_HAB
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADORES_MX
;
.IF ERRORCODE <> 0 THEN .QUIT 006;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_HABILITADORES_01_MX;
.IF ERRORCODE <> 0 THEN .QUIT 007;

--/***********************************************************************
--**						UPDATE				 						**  
--***********************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_HABILITADORES_01_MX AS HBL
SET
	PE_FYP = 1
WHERE
	PD_RUT = HBL.TD_RUT
	AND HBL.TE_IND_HAB = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 008;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES;
.IF ERRORCODE <> 0 THEN .QUIT 009;

--/***************************************************************
--** CREA TABLA DE SALIDA HABILITADORES 360						**  
--***************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADO_360_MX;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADO_360_MX
(
	 PD_RUT 				DECIMAL(8,0)
    ,PE_HABILITADO 			INTEGER
    ,PE_ACTIVO_360 			INTEGER)
PRIMARY INDEX ( PD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 010;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADO_360_MX
SELECT 
	 ENRH.EMP_NUM_RUT 	AS PD_RUT 
	,MAX(ENRH.EMP_HAB) 	AS PE_HABILITADO
	,MAX(ENRH.EMP_ACT) 	AS PE_ACTIVO_360
FROM 
	MKT_EXPLORER_TB.WHOLESALE_ENROLADOS_360_HIST AS ENRH
	INNER JOIN MKT_JOURNEYBUILDER_TB.S_CMP_PERIODO_CAMPANA AS PAR
		ON ENRH.FECHA = PAR.SF_FECHA_REF_ENR_360
GROUP BY 
	ENRH.EMP_NUM_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 011;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADO_360_MX;
.IF ERRORCODE <> 0 THEN .QUIT 012;

--/***********************************************************************
--**						UPDATE				 						**  
--***********************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADO_360_MX AS HBL
SET
	 PE_HABILITADO_360 = HBL.PE_HABILITADO
	,PE_ACTIVO_360 = HBL.PE_ACTIVO_360
	,PE_ENROLADO_360=1
WHERE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES.PD_RUT = HBL.PD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 013;

--/***********************************************************************
--**						UPDATE				 						**  
--***********************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES	
SET 
	PE_TOTAL_HABILITADORES = PE_TOTAL_HABILITADORES +1
WHERE 
	PE_SIN_APR > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 014;

--/***********************************************************************
--**						UPDATE				 						**  
--***********************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
SET 
	PE_TOTAL_HABILITADORES = PE_TOTAL_HABILITADORES +1
WHERE 
	PE_ART85 > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 015;

--/***********************************************************************
--**						UPDATE				 						**  
--***********************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
SET 
	PE_TOTAL_HABILITADORES = PE_TOTAL_HABILITADORES +1
WHERE 
	PE_FYP > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 016;

--/***********************************************************************
--**						UPDATE MULTIPASS	 						**  
--***********************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
SET 
	PE_TOTAL_HABILITADORES = PE_TOTAL_HABILITADORES +1
WHERE 
	PE_ESTADO_MULTIPASS > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 017;

--/***********************************************************************
--**						UPDATE HABILITADO 360 						**  
--***********************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
SET 
	PE_TOTAL_HABILITADORES = PE_TOTAL_HABILITADORES +1
WHERE 
	PE_HABILITADO_360 > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 018;

--/***********************************************************************
--**						UPDATE ENROLADO 360 						**  
--***********************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
SET 
	PE_TOTAL_HABILITADORES = PE_TOTAL_HABILITADORES +1
WHERE 
	PE_ENROLADO_360 > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 019;

--/***********************************************************************
--**						UPDATE MANDATO_CCL	 						**  
--***********************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
SET 
	PE_TOTAL_HABILITADORES = PE_TOTAL_HABILITADORES +1
WHERE 
	PE_MANDATO_CCL > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 020;

--/***********************************************************************
--**						UPDATE READY CCL	 						**  
--***********************************************************************/
UPDATE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
SET 
	PE_READY_CCL=1
WHERE 
	PE_ENROLADO_360 = 1 
	AND  PE_HABILITADO_360 = 1 
	AND PE_ACTIVO_360 = 1 
	AND PE_ESTADO_MULTIPASS  = 1  
	AND PE_MANDATO_CCL = 1  
	AND PE_SIN_APR  = 1  
	AND PE_ART85 = 1  
	AND PE_FYP = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 021;

--/***********************************************************************
--**						UPDATE DISPONIBLE OK 						**  
--***********************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
SET 
	PE_DISPONIBLE_OK = 1
WHERE 
	COALESCE(PE_DISPONIBLE_MX_NEW,0) >= 30000000
	AND PC_MACRO_BANCA = 'EMPRESAS'
;
.IF ERRORCODE <> 0 THEN .QUIT 022;

UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
SET 
	PE_DISPONIBLE_OK = 1
WHERE 
	COALESCE(PE_DISPONIBLE_MX_NEW,0) >= 70000000
	AND PC_MACRO_BANCA = 'GRANDES EMPRESAS'
;
.IF ERRORCODE <> 0 THEN .QUIT 023;

--/***********************************************************************
--**						UPDATE LEAD EN OTRAS CAMPANAS 				**  
--***********************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
SET 
	 PE_CMP_MANDATO_CCL = 0
	,PE_CMP_CTO_BEX = 0
	,PE_CMP_PROPENSO_MX = 0
	,PE_CMP_MIGRACION = 0
	,PE_CMP_FOGAPE_REACTIVA = 0
;
.IF ERRORCODE <> 0 THEN .QUIT 024;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES;
.IF ERRORCODE <> 0 THEN .QUIT 025;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;

UPDATE - Ejemplo 2 OK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: HABILITADORES 360															  **
--**                                                    				 				  **
--** AUTOR  : FRANCISCO PINOCHET                                               	  		  **
--** EMPRESA: FACTORIT                                   				  				  **
--** FECHA  : 03/2024                                                   				  **
--/*****************************************************************************************
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 08/2024			     	                                                  **
--/*****************************************************************************************
--/*****************************************************************************************
--**TABLA DE ENTRADA:	MKT_JOURNEY_TB.WHOLESALE_HABILITADORES							  
--**					MKT_JOURNEYBUILDER_TB.S_CMP_PERIODO_CAMPANA                  
--**					MKT_EXPLORER_TB.WHOLESALE_ENROLADOS_360_HIST  
--**                  	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_FR
--**																					  
--**TABLAS TEMPORALES:	
--**					{{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADORES_MX     
--**					{{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADO_360_MX        
--**					{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_HAB_01
--**
--** TABLA DE SALIDA:				  	  			  	  
--**                    {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_HAB      			  
--**                                      												  
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/***********************************************************************
--**			CREA TABLA DE SALIDA									**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADORES_MX;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADORES_MX
(
	 PF_FECHA 				DATE FORMAT 'YYYY-MM-DD'
	,PD_RUT 				DECIMAL(8,0)
	,PE_ART85 				INTEGER
	,PE_SIN_APR 			INTEGER
	,PE_MANDATO_CCL 		INTEGER
	,PE_ESTADO_MULTIPASS 	INTEGER
	,PE_FYP_2 				INTEGER
	,PE_FYP_52 				INTEGER
	,PE_FYP_53 				INTEGER
	,PE_FYP_8 				INTEGER)
PRIMARY INDEX ( PD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 001;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADORES_MX
SELECT
	 HBL.FECHA				AS PF_FECHA
	,HBL.RUT 				AS PD_RUT 				
    ,HBL.ART85 			    AS PE_ART85 			
    ,HBL.SIN_APR 		    AS PE_SIN_APR 		
    ,HBL.MANDATO_CCL 	    AS PE_MANDATO_CCL 	
    ,HBL.ESTADO_MULTIPASS   AS PE_ESTADO_MULTIPASS
    ,HBL.FYP_2 			    AS PE_FYP_2 			
    ,HBL.FYP_52 			AS PE_FYP_52 			
    ,HBL.FYP_53 			AS PE_FYP_53 			
    ,HBL.FYP_8              AS PE_FYP_8 			
FROM 
	MKT_JOURNEY_TB.WHOLESALE_HABILITADORES HBL
	INNER JOIN MKT_JOURNEYBUILDER_TB.S_CMP_PERIODO_CAMPANA PAR
		ON HBL.FECHA = PAR.SF_FECHA_REF_HB
GROUP BY
	 HBL.FECHA
	,HBL.RUT 			
    ,HBL.ART85 			
    ,HBL.SIN_APR 		
    ,HBL.MANDATO_CCL 	
    ,HBL.ESTADO_MULTIPASS
    ,HBL.FYP_2 			
    ,HBL.FYP_52 			
    ,HBL.FYP_53 			
    ,HBL.FYP_8
;
.IF ERRORCODE <> 0 THEN .QUIT 002;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADORES_MX;
.IF ERRORCODE <> 0 THEN .QUIT 003;

--/***************************************************************
--** CREA TABLA DE SALIDA HABILITADORES 360						**  
--***************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADO_360_MX;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADO_360_MX
(
	 PD_RUT 				DECIMAL(8,0)
    ,PE_HABILITADO 			INTEGER
    ,PE_ACTIVO_360 			INTEGER)
PRIMARY INDEX ( PD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 004;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADO_360_MX
SELECT 
	 ENRH.EMP_NUM_RUT 	AS PD_RUT 
	,MAX(ENRH.EMP_HAB) 	AS PE_HABILITADO
	,MAX(ENRH.EMP_ACT) 	AS PE_ACTIVO_360
FROM 
	MKT_EXPLORER_TB.WHOLESALE_ENROLADOS_360_HIST ENRH
	INNER JOIN MKT_JOURNEYBUILDER_TB.S_CMP_PERIODO_CAMPANA PAR
		ON ENRH.FECHA = PAR.SF_FECHA_REF_ENR_360
GROUP BY 
	ENRH.EMP_NUM_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 005;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADO_360_MX;
.IF ERRORCODE <> 0 THEN .QUIT 006;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL 											  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_HAB_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_HAB_01
(
	 TD_RUT 							DECIMAL(8,0)
	,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PO_DEUDA						INTEGER
	,TE_CTACTE							INTEGER
	,TE_LCG_VIGENTE						INTEGER
	,TE_LME_VIGENTE 					INTEGER		
	,TE_DISPONIBLE_MX_NEW				BIGINT
	,TC_MACRO_BANCA     				VARCHAR(16) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_LCG_RENOV_SIN_DISP				INTEGER
	,TE_CURSE_ULT_3M					INTEGER
	,TE_FLG_EXCLUSION					INTEGER
	,TC_MOTIVO_EXCLUSION				VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO1							VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2  						VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3  						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_EN_PLANEAMIENTO					INTEGER 			
    ,TC_CALIFICACION_SBIF          		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,TF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,TD_PI_CLIENTE                		DECIMAL(25,10) 			
	,TC_CLASIFICACION_SBIF       		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FDR                      		INTEGER 			
	,TE_COS_CLI                 		INTEGER 			
	,TE_FILTROS_RIESGOS          		INTEGER 			
	,TC_PAR_CALIFICACION_SBIF    		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE           		DECIMAL(25,10) 		
	,TE_PAR_FDR                  		INTEGER 			
	,TE_PAR_COS_CLI             		INTEGER 		
	,TE_MOLESTO               			INTEGER 			
	,TE_CARGABLE						INTEGER
	,TC_ELIMINADO						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DISPONIBLE_OK               	INTEGER
	,TE_ENROLADO_360            		INTEGER
	,TE_HABILITADO_360           		INTEGER
	,TE_ACTIVO_360               		INTEGER
	,TE_ESTADO_MULTIPASS        		INTEGER
	,TE_MANDATO_CCL              		INTEGER
	,TE_SIN_APR                 		INTEGER
	,TE_ART85                     		INTEGER
	,TE_FYP                    			INTEGER
	,TE_READY_CCL              			INTEGER
	,TE_TOTAL_HABILITADORES       		INTEGER
	,TC_FECHA_HAB 						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC 	
	,TE_CMP_MANDATO_CCL					INTEGER
	,TE_CMP_CTO_BEX						INTEGER
	,TE_CMP_MIGRACION               	INTEGER
	,TE_CMP_PROPENSO_MX             	INTEGER
	,TE_CMP_FOGAPE_REACTIVA         	INTEGER
	,TC_EJE_CAMP						VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PRIORIDAD                   	INTEGER
	,TE_MTO_CMP    						BIGINT
	,TE_IND_BANQUERO_SOLO_MX			BYTEINT	
	,TE_IND_CAMPANA						BYTEINT
)PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 007;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_HAB_01
SELECT 
	 PPE.PD_RUT 									AS TD_RUT 					
	,PPE.PC_RECOMENDACION_DE_CRUCE					AS TC_RECOMENDACION_DE_CRUCE
	,PPE.PE_PO_DEUDA 								AS TE_PO_DEUDA
	,PPE.PE_CTACTE 									AS TE_CTACTE
	,PPE.PE_LCG_VIGENTE 							AS TE_LCG_VIGENTE
	,PPE.PE_LME_VIGENTE 							AS TE_LME_VIGENTE	
	,PPE.PE_DISPONIBLE_MX_NEW						AS TE_DISPONIBLE_MX_NEW
	,PPE.PC_MACRO_BANCA 							AS TC_MACRO_BANCA 		
	,PPE.PE_LCG_RENOV_SIN_DISP 						AS TE_LCG_RENOV_SIN_DISP
	,PPE.PE_CURSE_ULT_3M            				AS TE_CURSE_ULT_3M
	,PPE.PE_FLG_EXCLUSION           				AS TE_FLG_EXCLUSION
	,PPE.PC_MOTIVO_EXCLUSION        				AS TC_MOTIVO_EXCLUSION
	,PPE.PC_TEXTO1                  				AS TC_TEXTO1
	,PPE.PC_TEXTO2                  				AS TC_TEXTO2
	,PPE.PC_TEXTO3                  				AS TC_TEXTO3
	,PPE.PE_EN_PLANEAMIENTO         	        	AS TE_EN_PLANEAMIENTO
    ,PPE.PC_CALIFICACION_SBIF        				AS TC_CALIFICACION_SBIF
	,PPE.PF_PERIODO_CALIFICACION	          		AS TF_PERIODO_CALIFICACION 	
	,PPE.PD_PI_CLIENTE            					AS TD_PI_CLIENTE 
	,PPE.PC_CLASIFICACION_SBIF              		AS TC_CLASIFICACION_SBIF 	
	,PPE.PE_FDR                     				AS TE_FDR 
	,PPE.PE_COS_CLI									AS TE_COS_CLI
	,PPE.PE_FILTROS_RIESGOS         				AS TE_FILTROS_RIESGOS
	,PPE.PC_PAR_CALIFICACION_SBIF					AS TC_PAR_CALIFICACION_SBIF
	,PPE.PD_PAR_PI_CLIENTE				            AS TD_PAR_PI_CLIENTE 
	,PPE.PE_PAR_FDR		                         	AS TE_PAR_FDR 
	,PPE.PE_PAR_COS_CLI			                    AS TE_PAR_COS_CLI 	
	,PPE.PE_MOLESTO									AS TE_MOLESTO
	,PPE.PE_CARGABLE                				AS TE_CARGABLE
    ,PPE.PC_ELIMINADO	           					AS TC_ELIMINADO	
	,PPE.PE_DISPONIBLE_OK           				AS TE_DISPONIBLE_OK

	,CASE WHEN ENRH.PD_RUT IS NULL THEN 0 
		  ELSE 1 END 											AS TE_ENROLADO_360
	,COALESCE(ENRH.PE_HABILITADO,PPE.PE_HABILITADO_360)			AS TE_HABILITADO_360
	,COALESCE(ENRH.PE_ACTIVO_360,PPE.PE_ACTIVO_360)				AS TE_ACTIVO_360
	
	,COALESCE(HBT1.PE_ESTADO_MULTIPASS,PPE.PE_ESTADO_MULTIPASS) AS TE_ESTADO_MULTIPASS
	,COALESCE(HBT1.PE_MANDATO_CCL,PPE.PE_MANDATO_CCL)          	AS TE_MANDATO_CCL
	,COALESCE(HBT1.PE_SIN_APR,PPE.PE_SIN_APR)              		AS TE_SIN_APR
	,COALESCE(HBT1.PE_ART85,PPE.PE_ART85)                		AS TE_ART85

    ,CASE 
		WHEN HBT2.PD_RUT IS NULL THEN PPE.PE_FYP 	
		WHEN COALESCE(HBT2.PE_FYP_2,0)=1 AND COALESCE(HBT2.PE_FYP_52,0)=1 AND COALESCE(HBT2.PE_FYP_8,0)=1 THEN 1
		WHEN COALESCE(HBT2.PE_FYP_2,0)=1 AND COALESCE(HBT2.PE_FYP_53,0)=1 AND COALESCE(HBT2.PE_FYP_8,0)=1 THEN 1
		ELSE 0  END 							 	AS TE_FYP	

	,PPE.PE_READY_CCL               				AS TE_READY_CCL
	,PPE.PE_TOTAL_HABILITADORES     				AS TE_TOTAL_HABILITADORES

	,CASE WHEN HBT1.PD_RUT IS NULL THEN PPE.PC_FECHA_HAB 
		  ELSE CAST(HBT1.PF_fecha AS VARCHAR(100))	END	AS TC_FECHA_HAB

	,PPE.PE_CMP_MANDATO_CCL         				AS TE_CMP_MANDATO_CCL
	,PPE.PE_CMP_CTO_BEX             				AS TE_CMP_CTO_BEX
	,PPE.PE_CMP_MIGRACION           				AS TE_CMP_MIGRACION
	,PPE.PE_CMP_PROPENSO_MX         				AS TE_CMP_PROPENSO_MX
	,PPE.PE_CMP_FOGAPE_REACTIVA     				AS TE_CMP_FOGAPE_REACTIVA
	,PPE.PC_EJE_CAMP								AS TC_EJE_CAMP
	,PPE.PE_PRIORIDAD 								AS TE_PRIORIDAD
	,PPE.PE_MTO_CMP							 		AS TE_MTO_CMP
	,PPE.PE_IND_BANQUERO_SOLO_MX					AS TE_IND_BANQUERO_SOLO_MX	
	,PPE.PE_IND_CAMPANA 							AS TE_IND_CAMPANA		
FROM {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_FR  PPE
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADORES_MX HBT1
		ON PPE.PD_RUT = HBT1.PD_RUT
    LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADORES_MX HBT2
		ON PPE.PD_RUT = HBT2.PD_RUT		
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.P_HABILITADO_360_MX ENRH
		ON PPE.PD_RUT = ENRH.PD_RUT		
;
.IF ERRORCODE <> 0 THEN .QUIT 008;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_HAB_01;
.IF ERRORCODE <> 0 THEN .QUIT 009;

/***********************************************************************************************
    CREA TABLA PRE CALCULO DE DE PROPENSO HABILITADORES
************************************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_HAB;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_HAB
(
	 PD_RUT 							DECIMAL(8,0)
	,PC_RECOMENDACION_DE_CRUCE			VARCHAR(255) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PO_DEUDA						INTEGER
	,PE_CTACTE							INTEGER
	,PE_LCG_VIGENTE						INTEGER
	,PE_LME_VIGENTE 					INTEGER		
	,PE_DISPONIBLE_MX_NEW				BIGINT
	,PC_MACRO_BANCA     				VARCHAR(16) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_LCG_RENOV_SIN_DISP				INTEGER
	,PE_CURSE_ULT_3M					INTEGER
	,PE_FLG_EXCLUSION					INTEGER
	,PC_MOTIVO_EXCLUSION				VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO1							VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO2  						VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO3  						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_EN_PLANEAMIENTO					INTEGER 			
    ,PC_CALIFICACION_SBIF          		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,PF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,PD_PI_CLIENTE                		DECIMAL(25,10) 			
	,PC_CLASIFICACION_SBIF       		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,PE_FDR                      		INTEGER 			
	,PE_COS_CLI                 		INTEGER 			
	,PE_FILTROS_RIESGOS          		INTEGER 			
	,PC_PAR_CALIFICACION_SBIF    		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PD_PAR_PI_CLIENTE           		DECIMAL(25,10) 		
	,PE_PAR_FDR                  		INTEGER 			
	,PE_PAR_COS_CLI             		INTEGER 		
	,PE_MOLESTO               			INTEGER 			
	,PE_CARGABLE						INTEGER
	,PC_ELIMINADO						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_DISPONIBLE_OK               	INTEGER
	,PE_ENROLADO_360            		INTEGER
	,PE_HABILITADO_360           		INTEGER
	,PE_ACTIVO_360               		INTEGER
	,PE_ESTADO_MULTIPASS        		INTEGER
	,PE_MANDATO_CCL              		INTEGER
	,PE_SIN_APR                 		INTEGER
	,PE_ART85                     		INTEGER
	,PE_FYP                    			INTEGER
	,PE_READY_CCL              			INTEGER
	,PE_TOTAL_HABILITADORES       		INTEGER
	,PC_FECHA_HAB 						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC 	
	,PE_CMP_MANDATO_CCL					INTEGER
	,PE_CMP_CTO_BEX						INTEGER
	,PE_CMP_MIGRACION               	INTEGER
	,PE_CMP_PROPENSO_MX             	INTEGER
	,PE_CMP_FOGAPE_REACTIVA         	INTEGER
	,PC_EJE_CAMP						VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PRIORIDAD                   	INTEGER
	,PE_MTO_CMP    						BIGINT
	,PE_IND_BANQUERO_SOLO_MX			BYTEINT	
	,PE_IND_CAMPANA						BYTEINT
)PRIMARY INDEX (PD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 010;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_HAB
SELECT 
	 PPE.TD_RUT 									AS PD_RUT 					
	,PPE.TC_RECOMENDACION_DE_CRUCE					AS PC_RECOMENDACION_DE_CRUCE
	,PPE.TE_PO_DEUDA 								AS PE_PO_DEUDA
	,PPE.TE_CTACTE 									AS PE_CTACTE
	,PPE.TE_LCG_VIGENTE 							AS PE_LCG_VIGENTE
	,PPE.TE_LME_VIGENTE 							AS PE_LME_VIGENTE	
	,PPE.TE_DISPONIBLE_MX_NEW						AS PE_DISPONIBLE_MX_NEW
	,PPE.TC_MACRO_BANCA 							AS PC_MACRO_BANCA 		
	,PPE.TE_LCG_RENOV_SIN_DISP 						AS PE_LCG_RENOV_SIN_DISP
	,PPE.TE_CURSE_ULT_3M            				AS PE_CURSE_ULT_3M
	,PPE.TE_FLG_EXCLUSION           				AS PE_FLG_EXCLUSION
	,PPE.TC_MOTIVO_EXCLUSION        				AS PC_MOTIVO_EXCLUSION
	,PPE.TC_TEXTO1                  				AS PC_TEXTO1
	,PPE.TC_TEXTO2                  				AS PC_TEXTO2
	,PPE.TC_TEXTO3                  				AS PC_TEXTO3
	,PPE.TE_EN_PLANEAMIENTO         	        	AS PE_EN_PLANEAMIENTO
    ,PPE.TC_CALIFICACION_SBIF        				AS PC_CALIFICACION_SBIF
	,PPE.TF_PERIODO_CALIFICACION	          		AS PF_PERIODO_CALIFICACION 	
	,PPE.TD_PI_CLIENTE            					AS PD_PI_CLIENTE 
	,PPE.TC_CLASIFICACION_SBIF              		AS PC_CLASIFICACION_SBIF 	
	,PPE.TE_FDR                     				AS PE_FDR 
	,PPE.TE_COS_CLI									AS PE_COS_CLI
	,PPE.TE_FILTROS_RIESGOS         				AS PE_FILTROS_RIESGOS
	,PPE.TC_PAR_CALIFICACION_SBIF					AS PC_PAR_CALIFICACION_SBIF
	,PPE.TD_PAR_PI_CLIENTE				            AS PD_PAR_PI_CLIENTE 
	,PPE.TE_PAR_FDR		                         	AS PE_PAR_FDR 
	,PPE.TE_PAR_COS_CLI			                    AS PE_PAR_COS_CLI 	
	,PPE.TE_MOLESTO									AS PE_MOLESTO
	,PPE.TE_CARGABLE                				AS PE_CARGABLE
    ,PPE.TC_ELIMINADO	           					AS PC_ELIMINADO	

	,CASE WHEN COALESCE(PPE.TE_DISPONIBLE_MX_NEW,0) >= 30000000
		   AND PPE.TC_MACRO_BANCA = 'EMPRESAS' THEN 1
		  WHEN COALESCE(PPE.TE_DISPONIBLE_MX_NEW,0) >= 70000000
		   AND PPE.TC_MACRO_BANCA = 'GRANDES EMPRESAS' THEN 1
		  ELSE 0 END	            				AS PE_DISPONIBLE_OK

	,PPE.TE_ENROLADO_360            				AS PE_ENROLADO_360
	,PPE.TE_HABILITADO_360          				AS PE_HABILITADO_360
	,PPE.TE_ACTIVO_360              				AS PE_ACTIVO_360
	,PPE.TE_ESTADO_MULTIPASS        				AS PE_ESTADO_MULTIPASS
	,PPE.TE_MANDATO_CCL             				AS PE_MANDATO_CCL
	,PPE.TE_SIN_APR                 				AS PE_SIN_APR
	,PPE.TE_ART85                   				AS PE_ART85
	,PPE.TE_FYP                     				AS PE_FYP

	,CASE WHEN PPE.TE_ENROLADO_360 = 1 AND PPE.TE_HABILITADO_360 = 1 
		   AND PPE.TE_ACTIVO_360 = 1   AND PPE.TE_ESTADO_MULTIPASS  = 1  
		   AND PPE.TE_MANDATO_CCL = 1  AND PPE.TE_SIN_APR  = 1  
		   AND PPE.TE_ART85 = 1        AND PPE.TE_FYP = 1 THEN 1 
		   ELSE 0 END                				AS PE_READY_CCL

	,COALESCE(PPE.TE_SIN_APR,0) + COALESCE(PPE.TE_ART85,0) + COALESCE(PPE.TE_FYP,0) + 
	 COALESCE(PPE.TE_ESTADO_MULTIPASS,0) + COALESCE(PPE.TE_HABILITADO_360,0) +
	 COALESCE(PPE.TE_ENROLADO_360,0) + COALESCE(PPE.TE_MANDATO_CCL,0)
													AS PE_TOTAL_HABILITADORES

	,PPE.TC_FECHA_HAB								AS PC_FECHA_HAB

	,0         										AS PE_CMP_MANDATO_CCL
	,0             									AS PE_CMP_CTO_BEX
	,0           									AS PE_CMP_MIGRACION
	,0         										AS PE_CMP_PROPENSO_MX
	,0     											AS PE_CMP_FOGAPE_REACTIVA

	,PPE.TC_EJE_CAMP								AS PC_EJE_CAMP
	,PPE.TE_PRIORIDAD 								AS PE_PRIORIDAD
	,PPE.TE_MTO_CMP							 		AS PE_MTO_CMP
	,PPE.TE_IND_BANQUERO_SOLO_MX					AS PE_IND_BANQUERO_SOLO_MX		
	,PPE.TE_IND_CAMPANA 							AS PE_IND_CAMPANA			 		
FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_HAB_01 PPE
;
.IF ERRORCODE <> 0 THEN .QUIT 011;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( Pd_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_HAB;
.IF ERRORCODE <> 0 THEN .QUIT 012;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;

UPDATE - Ejemplo 20 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: REGLA DE NEGOCIO PARA CAMPANA MESA ACTIVAR BLINDAR CAPTAR				  	  **
--**                                                    				 				  **
--** AUTOR  : MICHELL CUAREZ                                                			  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 05/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN:                                                           				  **
--** AUTOR  :                                                           				  **
--** FECHA  : SSAAMMDD                                                  				  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS				  **
--**					EDM_DMSEGTO_VW.IN_SEGUIMIENTO_EMPRESA                             **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_EXCL_IQUIQUE                  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_MAE_LISTA_NEGRA_MESA_MES      **
--**            		{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES**
--**   	                MKT_JOURNEYBUILDER_TB.S_CMP_MACRO_BANCA						  **
--**                  	                     											  **
--** TABLA DE SALIDA:                 	                     							  **
--**                  	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES**
--**																					  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/************************************************************
--** CREA TABLA TEMPORAL CON PARAMETROS DE EJECUCION	     **  
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_PARAMETRO;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_PARAMETRO
(
	 TE_PERIODO_CMP	INTEGER
	,TF_FECHA_CMP	DATE FORMAT 'YYYY-MM-DD'
	,TF_FECHA_CRG	DATE FORMAT 'YYYY-MM-DD'
	,TE_PERIODO_INI	INTEGER
	,TE_PERIODO_FIN	INTEGER
)
PRIMARY INDEX (TE_PERIODO_CMP)
;
.IF ERRORCODE <> 0 THEN .QUIT 1;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_PARAMETRO
SELECT 
	 SE_PERIODO_CMP AS TE_PERIODO_CMP
	,SF_FECHA_REF_DIA		AS TF_FECHA_CMP
	,SF_FECHA_CARGA			AS TF_FECHA_CRG	
	,SE_PERIODO_MENOS_1M	AS TE_PERIODO_INI
	,SE_PERIODO_REF			AS TE_PERIODO_FIN
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS
;
.IF ERRORCODE <> 0 THEN .QUIT 2;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_PARAMETRO;
	
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/*************************************************************************
--** FILTROS DE NEGOCIOS  -CAMPAÑA ANTERIOR**  
--*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_EN_CMP_MESA;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_EN_CMP_MESA
(
	 TE_RUT 			INTEGER
    ,TC_GESTION 		VARCHAR(5) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CAMPANA			VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
)
PRIMARY INDEX (TE_RUT)
;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_EN_CMP_MESA
SELECT 
	 RUT  			AS TE_RUT 		
	,GESTION  		AS TC_GESTION 	
	,CAMPANA		AS TC_CAMPANA
FROM  
	EDM_DMSEGTO_VW.IN_SEGUIMIENTO_EMPRESA A 
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_PARAMETRO AS PAR  
		ON MES_INICIATIVA >= PAR.TE_PERIODO_INI
		AND MES_INICIATIVA <= PAR.TE_PERIODO_FIN
WHERE
	TIPO = 'M'
	AND PROD_FIN_ID = 'P20'
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_EN_CMP_MESA;
	
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/*******************************************************************
--** CREA TABLA TEMPORAL PARA NOMBRE DE CAMPAÑAS  		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA
(
	 TC_NOMBRE_CAMPANA  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_GRUPO			INTEGER 
	
)PRIMARY INDEX (TC_NOMBRE_CAMPANA)
;
.IF ERRORCODE <> 0 THEN .QUIT 6;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA VALUES('CAPTACION DE DIVISAS EMPRESARIOS',1);
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA VALUES('CAPTACION DE DIVISAS BANCO WHOLESALE',1);
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA VALUES('CAPTACION DE DIVISAS NO COMEX NO MESA EM',2);
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA VALUES('CAPT DE DIVISAS NO COMEX NO MESA BCO WSB',2);
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA VALUES('ACTIVACION CLIENTES MESA BANCO WHOLESALE',3);
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA VALUES('ACTIVACION CLIENTES MESA EMPRESARIOS',3);
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA VALUES('BLINDAR CLIENTES MESA BANCO WHOLESALE',4);
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA VALUES('BLINDAR CLIENTES MESA EMPRESARIOS',4);


.IF ERRORCODE <> 0 THEN .QUIT 7;
--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_NOMBRE_CAMPANA)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA;

.IF ERRORCODE <> 0 THEN .QUIT 8;

--/*******************************************************************
--** CREA TABLA TEMPORAL PARA AGRUPAR POR RUT A LOS CLIENTES 		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP1;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP1
(
	TE_RUT			INTEGER 
	
)PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 9;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP1 
SELECT 
	MESA.TE_RUT AS TE_RUT
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_EN_CMP_MESA AS MESA
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA AS NOMB
		ON MESA.TC_CAMPANA = NOMB.TC_NOMBRE_CAMPANA 
		AND NOMB.TE_GRUPO = 1
WHERE 
	NOT(COALESCE(MESA.TC_GESTION,'') = '')
	AND NOT(COALESCE(MESA.TC_GESTION,'') = 'CNU')
GROUP BY 
	MESA.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 10;
--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP1;

.IF ERRORCODE <> 0 THEN .QUIT 11;

--/*******************************************************************
--** CREA TABLA TEMPORAL PARA AGRUPAR POR RUT A LOS CLIENTES 		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP2;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP2
(
	TE_RUT			INTEGER 
	
)PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 12;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP2
SELECT 
	MESA.TE_RUT AS TE_RUT
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_EN_CMP_MESA AS MESA 
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA AS NOMB
		ON MESA.TC_CAMPANA = NOMB.TC_NOMBRE_CAMPANA 
		AND NOMB.TE_GRUPO =2
WHERE 
	NOT(COALESCE(MESA.TC_GESTION,'') = '')
	AND NOT(COALESCE(MESA.TC_GESTION,'') = 'CNU')
GROUP BY 
	MESA.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 13;
--/**********************************************************************
--**						SE APLICAN COLLECTS 					   **  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP2;

.IF ERRORCODE <> 0 THEN .QUIT 14;

--/*******************************************************************
--** CREA TABLA TEMPORAL PARA AGRUPAR POR RUT A LOS CLIENTES 		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP3;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP3
(
	TE_RUT			INTEGER 
	
)PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 15;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP3
SELECT 
	MESA.TE_RUT  AS TE_RUT
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_EN_CMP_MESA AS MESA
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA AS NOMB
		ON MESA.TC_CAMPANA = NOMB.TC_NOMBRE_CAMPANA 
		AND NOMB.TE_GRUPO = 3
WHERE 
	NOT(COALESCE(MESA.TC_GESTION,'') = '')
	AND NOT(COALESCE(MESA.TC_GESTION,'') = 'CNU')
GROUP BY 
	MESA.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 16;
--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP3;

.IF ERRORCODE <> 0 THEN .QUIT 17;

--/*******************************************************************
--** CREA TABLA TEMPORAL PARA AGRUPAR POR RUT A LOS CLIENTES 		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP4;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP4
(
	TE_RUT			INTEGER 
	
)PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 18;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP4
SELECT 
	MESA.TE_RUT AS TE_RUT
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_EN_CMP_MESA AS MESA
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA AS NOMB
		ON MESA.TC_CAMPANA = NOMB.TC_NOMBRE_CAMPANA 
		AND NOMB.TE_GRUPO = 4
WHERE 
	NOT(COALESCE(MESA.TC_GESTION,'') = '')
	AND NOT(COALESCE(MESA.TC_GESTION,'') = 'CNU')
GROUP BY 
	MESA.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 19;
--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP4;

.IF ERRORCODE <> 0 THEN .QUIT 20;

--/*******************************************************************
--** CREA TABLA TEMPORAL PARA AGRUPAR POR RUT A LOS CLIENTES IQUIQUE		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_RUT_IQUIQUE;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_RUT_IQUIQUE
(
	TE_RUT1			INTEGER 
	
)PRIMARY INDEX (TE_RUT1)
;
.IF ERRORCODE <> 0 THEN .QUIT 21;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_RUT_IQUIQUE
SELECT 
	SD_RUT AS TE_RUT1 
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_EXCL_IQUIQUE
GROUP BY 
	SD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 22;
--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT1)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_RUT_IQUIQUE;

.IF ERRORCODE <> 0 THEN .QUIT 23;

--/*******************************************************************
--** CREA TABLA TEMPORAL PARA AGRUPAR POR RUT A LOS CLIENTES LISTA NEGRA		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_LISTA_NEGRA_MESA;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_LISTA_NEGRA_MESA
(
	TE_RUT1			INTEGER 
	
)PRIMARY INDEX (TE_RUT1)
;
.IF ERRORCODE <> 0 THEN .QUIT 24;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_LISTA_NEGRA_MESA
SELECT 
	SE_RUT AS TE_RUT1
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_MAE_LISTA_NEGRA_MESA_MES
GROUP BY 
	SE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 25;
--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT1)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_LISTA_NEGRA_MESA;

.IF ERRORCODE <> 0 THEN .QUIT 26;

--/*******************************************************************
--** CREA TABLA TEMPORAL MACRO BANCA CORPORATIVA,MAYORISTA		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_MACRO_BANCA;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_MACRO_BANCA
(
	TC_MACRO_BANCA			VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC 
) PRIMARY INDEX (TC_MACRO_BANCA)
;
.IF ERRORCODE <> 0 THEN .QUIT 27;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_MACRO_BANCA VALUES ('CORPORATIVA');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_MACRO_BANCA VALUES ('MAYORISTA');

.IF ERRORCODE <> 0 THEN .QUIT 28;
--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_MACRO_BANCA)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_MACRO_BANCA;

.IF ERRORCODE <> 0 THEN .QUIT 29;
--/*******************************************************************
--** CREA TABLA TEMPORAL MACRO BANCA CORPORATIVA,MAYORISTA		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_CASO_TIPO_CMP;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_CASO_TIPO_CMP
(
	 TE_RUT					INTEGER
	,TE_CASO_CMP			INTEGER 
	
)PRIMARY INDEX (TE_RUT,TE_CASO_CMP)
;
.IF ERRORCODE <> 0 THEN .QUIT 30;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_CASO_TIPO_CMP 
SELECT 
	 PE_RUT 	AS TE_RUT
	,CASE 
		WHEN PC_TIPO_CMP = 'BLINDAR' 
			AND PE_CAMPANA_BLINDAR = 0 
		THEN 0 
		ELSE 1 
		END 							AS TE_CASO_CMP
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES

;
.IF ERRORCODE <> 0 THEN .QUIT 31;
--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT,TE_CASO_CMP)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_CASO_TIPO_CMP;

.IF ERRORCODE <> 0 THEN .QUIT 32;

--/***********************************************************************
--**		UPDATE						**  
--***********************************************************************/	
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES
SET 
	PE_YA_CAMPANADO=0	
;
.IF ERRORCODE <> 0 THEN .QUIT 33;
--/***********************************************************************
--**		UPDATE		--CAPTACION				**  
--***********************************************************************/	
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP1 AS GRP1
SET 
	PE_YA_CAMPANADO=1 
WHERE
	PE_RUT= GRP1.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 34;

--/***********************************************************************
--**		UPDATE		--CAPTACION	NO COMEX NO MESA			**  
--***********************************************************************/	
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP2 AS GRP2
SET 
	PE_YA_CAMPANADO=1 
WHERE
	PE_RUT= GRP2.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 35;

--/***********************************************************************
--**		UPDATE		--ACTIVACION 			**  
--***********************************************************************/	
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP3 AS GRP3
SET 
	PE_YA_CAMPANADO=1 
WHERE
	PE_RUT= GRP3.TE_RUT
;	
.IF ERRORCODE <> 0 THEN .QUIT 36;

--/***********************************************************************
--**		UPDATE		--BLINDAJE			**  
--***********************************************************************/	
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP4 AS GRP4
SET 
	PE_YA_CAMPANADO=1 
WHERE
	PE_RUT= GRP4.TE_RUT
;	
.IF ERRORCODE <> 0 THEN .QUIT 37;

--/***********************************************************************
--**		UPDATE		  -- IQUIQUE DESCARTAR		**  
--***********************************************************************/	
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_RUT_IQUIQUE AS IQU
SET 
	PE_IQUIQUE_DESCARTAR=1
WHERE
	PE_RUT = IQU.TE_RUT1
;	
.IF ERRORCODE <> 0 THEN .QUIT 38;

--/***********************************************************************
--**		UPDATE		  -- LISTA NEGRA MESA DINERO		**  
--***********************************************************************/	
UPDATE 	
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES 
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_LISTA_NEGRA_MESA AS NEG
SET 
	PE_EN_LISTA_NEGRA=1
WHERE 
	PE_RUT = NEG.TE_RUT1
;
.IF ERRORCODE <> 0 THEN .QUIT 39;


UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES
SET 
	PC_EJE_CMP = PC_EJE_COMEX
WHERE 
	PC_CANAL_ASIGNACION = 'EJE_COMEX'
;
.IF ERRORCODE <> 0 THEN .QUIT 40;


UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES
SET 
	PC_EJE_CMP = PC_EJE_MESA
WHERE 
	PC_CANAL_ASIGNACION = 'EJE_MESA'
;
.IF ERRORCODE <> 0 THEN .QUIT 41;

--/***********************************************************************
--**UPDATE	-- PARA CORPORATIVA EL FILTRO DE CTA CTE NO ES OBLIGATORIO	**  
--***********************************************************************/	
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_MACRO_BANCA AS BAN
SET 
	PE_CTA_CTE=1
WHERE 
	PC_MACRO_BANCA = BAN.TC_MACRO_BANCA 
	AND PE_CTA_CTE = 0
;
.IF ERRORCODE <> 0 THEN .QUIT 42;

--/***********************************************************************
--**UPDATE   -- REGLA DE AJUSTE PARA CLIENTES SEGUN SU POTENCIAL	**  
--***********************************************************************/	
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES
SET 
	PE_NO_CUMPLE_POTENCIAL = 
		CASE 
			WHEN PC_MACRO_BANCA IN ('CORPORATIVA','MAYORISTA') AND PE_POTENCIAL_MOVIL_PARA_EXCLUIR >= 10000000 THEN 0 
			WHEN PC_MACRO_BANCA IN ('GRANDES EMPRESAS','INMOBILIARIA') AND PE_POTENCIAL_MOVIL_PARA_EXCLUIR >= 1000000 THEN 0
			WHEN PC_MACRO_BANCA = 'EMPRESAS' AND PE_POTENCIAL_MOVIL_PARA_EXCLUIR >= 500000 THEN 0
			WHEN PC_MACRO_BANCA IN ('EMPRENDEDORES','EMPRESARIOS') AND PE_POTENCIAL_MOVIL_PARA_EXCLUIR >= 300000 THEN 0
		ELSE 1
		END
;
.IF ERRORCODE <> 0 THEN .QUIT 43;


--/***********************************************************************
--**UPDATE   -- CAMPAÑABLES	**  
--***********************************************************************/	
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES
SET 
	 PE_CARGABLE =0
	,PC_ELIMINADO = '' 
;
.IF ERRORCODE <> 0 THEN .QUIT 44;


	
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES
FROM
	 MKT_JOURNEYBUILDER_TB.S_CMP_MACRO_BANCA AS BAN
	,{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_CASO_TIPO_CMP AS TPO
SET 
	PE_CARGABLE = 1
WHERE
	PE_FILTROS_RIESGOS>0 
	AND PC_MACRO_BANCA = BAN.SC_MACRO_BANCA 
	AND PE_RUT = TPO.TE_RUT
	AND TPO.TE_CASO_CMP = 1
	AND PE_CTA_CTE = 1 
	AND PE_MOLESTO=0  
	AND PE_EN_LISTA_NEGRA=0 
	AND NOT(COALESCE(PC_EJE_CMP,'0') = '0')
	AND NOT(COALESCE(PC_EJE_CMP,'0') = 'IQUIQU')
	AND NOT(COALESCE(PC_REGIONAL,'0') = '0')
    AND PE_IQUIQUE_DESCARTAR = 0 
	AND PE_YA_CAMPANADO = 0 
	AND PE_FLG_EXCLUSION=0
	AND PE_NO_CUMPLE_POTENCIAL=0
;
.IF ERRORCODE <> 0 THEN .QUIT 45;

--/***********************************************************************
--**UPDATE  -- CASCADA	**  
--***********************************************************************/	

UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES
SET 
	PC_ELIMINADO =   
         CASE
		 	WHEN COALESCE(PE_FILTROS_RIESGOS,0) = 0					THEN '01.- FILTROS RIESGOS'
            WHEN PC_MACRO_BANCA NOT IN ('EMPRESARIOS','EMPRENDEDORES','EMPRESAS','GRANDES EMPRESAS','CORPORATIVA','MAYORISTA') THEN '02.- BANCA NO CORRESPONDE'
			WHEN PC_TIPO_CMP = 'BLINDAR' AND PE_CAMPANA_BLINDAR = 0 THEN '03.- BLINDAR SIN MARCA DE CMP EN INPUT ANALITYCS'
		    WHEN COALESCE(PE_CTA_CTE,0) = 0							THEN '04.- SIN CTA CTE'
            WHEN COALESCE(PE_MOLESTO,0) > 0							THEN '05.- MOLESTOS'
			WHEN COALESCE(PE_EN_LISTA_NEGRA,0) > 0					THEN '06.- EN LISTA NEGRA MESA'
			WHEN COALESCE(PC_EJE_CMP,'0') IN ('0','IQUIQU')			THEN '07.- SIN ESPECIALISTA PARA ASIGNAR EN CANAL '||RTRIM(PC_CANAL_ASIGNACION)
			WHEN COALESCE(PC_REGIONAL,'0') IN ('0','')				THEN '08.- SIN REGIONAL'
			WHEN COALESCE(PE_IQUIQUE_DESCARTAR,0)>0 				THEN '09.- CLIENTE CON MARCA ZONA FRANCA'			
			WHEN PE_YA_CAMPANADO = 1 								THEN '09.- CLIENTE CAMPAÑADO ULT 30/60 DIAS CON GESTION TERMINAL'
			WHEN COALESCE(PE_FLG_EXCLUSION,0) = 1					THEN '10.- EXCLUIR : '||RTRIM(PC_MOTIVO_EXCLUSION)
			WHEN COALESCE(PE_NO_CUMPLE_POTENCIAL,0) >0				THEN '11.- REGLA EXCLUSION POR POTENCIAL INFERIOR A REGLA'
         ELSE '' END
	WHERE PE_CARGABLE = 0
;
.IF ERRORCODE <> 0 THEN .QUIT 46;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP,PE_RUT)
	ON  {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES;
.IF ERRORCODE <> 0 THEN .QUIT 47;


SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 20 OK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: REGLA DE NEGOCIO PARA CAMPANA MESA ACTIVAR BLINDAR CAPTAR				  	  **
--**                                                    				 				  **
--** AUTOR  : MICHELL CUAREZ                                                			  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 05/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 12/2024			     	                                                  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:																	  **
--**	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS				  					  **
--**	EDM_DMSEGTO_VW.IN_SEGUIMIENTO_EMPRESA                         					  **
--**	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_EXCL_IQUIQUE                  					  **
--**	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_MAE_LISTA_NEGRA_MESA_MES      					  **
--**    {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES**
--**   	MKT_JOURNEYBUILDER_TB.S_CMP_MACRO_BANCA						  					  **
--**                  	                     											  **
--** TABLA DE SALIDA:                 	                     							  **
--**  	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES**
--**																					  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/************************************************************
--** CREA TABLA TEMPORAL CON PARAMETROS DE EJECUCION	     **  
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_PARAMETRO;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_PARAMETRO
(
	 TE_PERIODO_CMP	INTEGER
	,TF_FECHA_CMP	DATE FORMAT 'YYYY-MM-DD'
	,TF_FECHA_CRG	DATE FORMAT 'YYYY-MM-DD'
	,TE_PERIODO_INI	INTEGER
	,TE_PERIODO_FIN	INTEGER
)
UNIQUE PRIMARY INDEX (TE_PERIODO_CMP)
;
.IF ERRORCODE <> 0 THEN .QUIT 1;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_PARAMETRO
SELECT 
	 SE_PERIODO_CMP 		AS TE_PERIODO_CMP
	,SF_FECHA_REF_DIA		AS TF_FECHA_CMP
	,SF_FECHA_CARGA			AS TF_FECHA_CRG	
	,SE_PERIODO_MENOS_1M	AS TE_PERIODO_INI
	,SE_PERIODO_REF			AS TE_PERIODO_FIN
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS
;
.IF ERRORCODE <> 0 THEN .QUIT 2;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_PARAMETRO;
	
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/*************************************************************************
--** FILTROS DE NEGOCIOS  -CAMPAÑA ANTERIOR**  
--*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_EN_CMP_MESA;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_EN_CMP_MESA
(
	 TD_RUT 			DECIMAL(8,0)
    ,TC_GESTION 		VARCHAR(5) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CAMPANA			VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
)
UNIQUE PRIMARY INDEX (TD_RUT)
;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_EN_CMP_MESA
SELECT 
	 SGM.RUT  			AS TD_RUT 		
	,SGM.GESTION  		AS TC_GESTION 	
	,SGM.CAMPANA		AS TC_CAMPANA
FROM  
	EDM_DMSEGTO_VW.IN_SEGUIMIENTO_EMPRESA SGM 
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_PARAMETRO AS PAR  
		ON  MES_INICIATIVA >= PAR.TE_PERIODO_INI
		AND MES_INICIATIVA <= PAR.TE_PERIODO_FIN
WHERE
	TIPO = 'M'
	AND PROD_FIN_ID = 'P20'
QUALIFY ROW_NUMBER() OVER (PARTITION BY SGM.RUT ORDER BY SGM.RUT, SGM.FECHA_GESTION DESC) = 1	
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_EN_CMP_MESA;
	
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/*******************************************************************
--** CREA TABLA TEMPORAL PARA NOMBRE DE CAMPAÑAS  		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA
(
	 TC_NOMBRE_CAMPANA  VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_GRUPO			INTEGER 
	
)UNIQUE PRIMARY INDEX (TC_NOMBRE_CAMPANA)
;
.IF ERRORCODE <> 0 THEN .QUIT 6;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA VALUES('CAPTACION DE DIVISAS EMPRESARIOS',1);
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA VALUES('CAPTACION DE DIVISAS BANCO WHOLESALE',1);
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA VALUES('CAPTACION DE DIVISAS NO COMEX NO MESA EM',2);
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA VALUES('CAPT DE DIVISAS NO COMEX NO MESA BCO WSB',2);
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA VALUES('ACTIVACION CLIENTES MESA BANCO WHOLESALE',3);
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA VALUES('ACTIVACION CLIENTES MESA EMPRESARIOS',3);
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA VALUES('BLINDAR CLIENTES MESA BANCO WHOLESALE',4);
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA VALUES('BLINDAR CLIENTES MESA EMPRESARIOS',4);


.IF ERRORCODE <> 0 THEN .QUIT 7;
--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_NOMBRE_CAMPANA)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA;

.IF ERRORCODE <> 0 THEN .QUIT 8;

--/*******************************************************************
--** CREA TABLA TEMPORAL PARA AGRUPAR POR RUT A LOS CLIENTES 		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP1;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP1
(
	TD_RUT			DECIMAL(8,0) 
	
)UNIQUE PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 9;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP1 
SELECT 
	MESA.TD_RUT AS TD_RUT
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_EN_CMP_MESA AS MESA
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA AS NOMB
		ON MESA.TC_CAMPANA = NOMB.TC_NOMBRE_CAMPANA 
		AND NOMB.TE_GRUPO = 1
WHERE 
	NOT(COALESCE(MESA.TC_GESTION,'') = '')
	AND NOT(COALESCE(MESA.TC_GESTION,'') = 'CNU')
GROUP BY 
	MESA.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 10;
--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP1;

.IF ERRORCODE <> 0 THEN .QUIT 11;

--/*******************************************************************
--** CREA TABLA TEMPORAL PARA AGRUPAR POR RUT A LOS CLIENTES 		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP2;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP2
(
	TD_RUT			DECIMAL(8,0) 
	
)UNIQUE PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 12;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP2
SELECT 
	MESA.TD_RUT AS TD_RUT
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_EN_CMP_MESA AS MESA 
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA AS NOMB
		ON MESA.TC_CAMPANA = NOMB.TC_NOMBRE_CAMPANA 
		AND NOMB.TE_GRUPO =2
WHERE 
	NOT(COALESCE(MESA.TC_GESTION,'') = '')
	AND NOT(COALESCE(MESA.TC_GESTION,'') = 'CNU')
GROUP BY 
	MESA.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 13;
--/**********************************************************************
--**						SE APLICAN COLLECTS 					   **  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP2;

.IF ERRORCODE <> 0 THEN .QUIT 14;

--/*******************************************************************
--** CREA TABLA TEMPORAL PARA AGRUPAR POR RUT A LOS CLIENTES 		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP3;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP3
(
	TD_RUT			DECIMAL(8,0) 
	
)UNIQUE PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 15;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP3
SELECT 
	MESA.TD_RUT  AS TD_RUT
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_EN_CMP_MESA AS MESA
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA AS NOMB
		ON MESA.TC_CAMPANA = NOMB.TC_NOMBRE_CAMPANA 
		AND NOMB.TE_GRUPO = 3
WHERE 
	NOT(COALESCE(MESA.TC_GESTION,'') = '')
	AND NOT(COALESCE(MESA.TC_GESTION,'') = 'CNU')
GROUP BY 
	MESA.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 16;
--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP3;

.IF ERRORCODE <> 0 THEN .QUIT 17;

--/*******************************************************************
--** CREA TABLA TEMPORAL PARA AGRUPAR POR RUT A LOS CLIENTES 		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP4;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP4
(
	TD_RUT			DECIMAL(8,0) 
	
)UNIQUE PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 18;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP4
SELECT 
	MESA.TD_RUT AS TD_RUT
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_EN_CMP_MESA AS MESA
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_CAMPANA AS NOMB
		ON MESA.TC_CAMPANA = NOMB.TC_NOMBRE_CAMPANA 
		AND NOMB.TE_GRUPO = 4
WHERE 
	NOT(COALESCE(MESA.TC_GESTION,'') = '')
	AND NOT(COALESCE(MESA.TC_GESTION,'') = 'CNU')
GROUP BY 
	MESA.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 19;
--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP4;

.IF ERRORCODE <> 0 THEN .QUIT 20;

--/*******************************************************************
--** CREA TABLA TEMPORAL PARA AGRUPAR POR RUT A LOS CLIENTES IQUIQUE		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_RUT_IQUIQUE;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_RUT_IQUIQUE
(
	TD_RUT1			DECIMAL(8,0) 
	
)UNIQUE PRIMARY INDEX (TD_RUT1)
;
.IF ERRORCODE <> 0 THEN .QUIT 21;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_RUT_IQUIQUE
SELECT 
	SD_RUT AS TD_RUT1 
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_EXCL_IQUIQUE
GROUP BY 
	SD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 22;
--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT1)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_RUT_IQUIQUE;

.IF ERRORCODE <> 0 THEN .QUIT 23;

--/*******************************************************************
--** CREA TABLA TEMPORAL PARA AGRUPAR POR RUT A LOS CLIENTES LISTA NEGRA		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_LISTA_NEGRA_MESA;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_LISTA_NEGRA_MESA
(
	TD_RUT1			DECIMAL(8,0) 
	
)UNIQUE PRIMARY INDEX (TD_RUT1)
;
.IF ERRORCODE <> 0 THEN .QUIT 24;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_LISTA_NEGRA_MESA
SELECT 
	SE_RUT AS TD_RUT1
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_MAE_LISTA_NEGRA_MESA_MES
GROUP BY 
	SE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 25;
--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT1)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_LISTA_NEGRA_MESA;

.IF ERRORCODE <> 0 THEN .QUIT 26;

--/*******************************************************************
--** CREA TABLA TEMPORAL MACRO BANCA CORPORATIVA,MAYORISTA		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_MACRO_BANCA;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_MACRO_BANCA
(
	TC_MACRO_BANCA			VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC 
) UNIQUE PRIMARY INDEX (TC_MACRO_BANCA)
;
.IF ERRORCODE <> 0 THEN .QUIT 27;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_MACRO_BANCA VALUES ('CORPORATIVA');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_MACRO_BANCA VALUES ('MAYORISTA');

.IF ERRORCODE <> 0 THEN .QUIT 28;
--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_MACRO_BANCA)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_MACRO_BANCA;

.IF ERRORCODE <> 0 THEN .QUIT 29;
--/*******************************************************************
--** CREA TABLA TEMPORAL MACRO BANCA CORPORATIVA,MAYORISTA		**  
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_CASO_TIPO_CMP;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_CASO_TIPO_CMP
(
	 TD_RUT					DECIMAL(8,0)
	,TE_CASO_CMP			INTEGER 
	
)UNIQUE PRIMARY INDEX (TD_RUT,TE_CASO_CMP)
;
.IF ERRORCODE <> 0 THEN .QUIT 30;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_CASO_TIPO_CMP 
SELECT 
	 PD_RUT 	AS TD_RUT
	,CASE 
		WHEN PC_TIPO_CMP = 'BLINDAR' 
			AND PE_CAMPANA_BLINDAR = 0 
		THEN 0 
		ELSE 1 
		END 							AS TE_CASO_CMP
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES_FR

;
.IF ERRORCODE <> 0 THEN .QUIT 31;
--/**********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT,TE_CASO_CMP)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_CASO_TIPO_CMP;

.IF ERRORCODE <> 0 THEN .QUIT 32;


--/***********************************************************************
--**		ACTUALIZA CAMPO PE_YA_CAMPANADO								**  
--***********************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_01
(
	 TE_PERIODO_CMP							INTEGER
	,TC_TIPO_CMP							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CAMPANA_BLINDAR                   	INTEGER
    ,TC_CAUSA_BLINDAR                     	VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_RUT 							 	DECIMAL(8,0)	
	,TE_VALOR							 	BIGINT
	,TE_VALOR_FIJO  						BIGINT
	,TC_FUENTE_POTENCIAL					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_POTENCIAL_MOVIL_PARA_EXCLUIR		BIGINT
	,TE_OPERA_CHINA							INTEGER
	,TE_MTO_CHINA_USD						BIGINT
	,TE_YA_CAMPANADO						INTEGER
	,TC_MACRO_BANCA							VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_REGIONAL    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_CTA_CTE								INTEGER
	,TC_EJE_CMP								VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_COMEX    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_MESA    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC		
	,TE_IQUIQUE_DESCARTAR					INTEGER	
	,TE_EN_LISTA_NEGRA						INTEGER	
	,TC_TEXTO1 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3 								VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CALIFICACION_SBIF 					VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TF_PERIODO_CALIFICACION  				DATE FORMAT	'YYYY-MM-DD'
	,TD_PI_CLIENTE  						DECIMAL (25,10)
	,TC_CLASIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_FDR 								INTEGER
	,TE_COS_CLI         					INTEGER
	,TE_FILTROS_RIESGOS 					INTEGER
	,TC_PAR_CALIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE 						DECIMAL (25,10)
	,TE_PAR_FDR 							INTEGER
	,TE_PAR_COS_CLI   						INTEGER
	,TE_MOLESTO 							INTEGER
	,TE_CARGABLE							INTEGER
	,TC_ELIMINADO  							VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_NO_CUMPLE_POTENCIAL                 INTEGER
	,TE_EN_PLANEAMIENTO 					INTEGER
	,TC_RECOMENDACION_DE_CRUCE 				VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FLG_EXCLUSION						INTEGER
	,TC_MOTIVO_EXCLUSION					VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CANAL_ASIGNACION                    VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
) UNIQUE PRIMARY INDEX (TE_PERIODO_CMP,TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 33;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_01
SELECT 
	 WFR.PE_PERIODO_CMP							AS TE_PERIODO_CMP                 
	,WFR.PC_TIPO_CMP                            AS TC_TIPO_CMP                    
	,WFR.PE_CAMPANA_BLINDAR						AS TE_CAMPANA_BLINDAR             
	,WFR.PC_CAUSA_BLINDAR                       AS TC_CAUSA_BLINDAR               
	,WFR.PD_RUT                                 AS TD_RUT                         
	,WFR.PE_VALOR                               AS TE_VALOR                       
	,WFR.PE_VALOR_FIJO                          AS TE_VALOR_FIJO                  
	,WFR.PC_FUENTE_POTENCIAL                    AS TC_FUENTE_POTENCIAL            
	,WFR.PE_POTENCIAL_MOVIL_PARA_EXCLUIR        AS TE_POTENCIAL_MOVIL_PARA_EXCLUIR
	,WFR.PE_OPERA_CHINA                         AS TE_OPERA_CHINA                 
	,WFR.PE_MTO_CHINA_USD                       AS TE_MTO_CHINA_USD   

	,CASE WHEN GRP1.TD_RUT IS NOT NULL
		THEN 1
		ELSE 0 END 		                        AS TE_YA_CAMPANADO                

	,WFR.PC_MACRO_BANCA                         AS TC_MACRO_BANCA                 
	,WFR.PC_REGIONAL                            AS TC_REGIONAL                    
	,WFR.PE_CTA_CTE                             AS TE_CTA_CTE                     
	,WFR.PC_EJE_CMP                             AS TC_EJE_CMP    
	,WFR.PC_EJE_COMEX							AS TC_EJE_COMEX 
	,WFR.PC_EJE_MESA							AS TC_EJE_MESA   	                 
	,WFR.PE_IQUIQUE_DESCARTAR                   AS TE_IQUIQUE_DESCARTAR           
	,WFR.PE_EN_LISTA_NEGRA                      AS TE_EN_LISTA_NEGRA              
	,WFR.PC_TEXTO1                              AS TC_TEXTO1                      
	,WFR.PC_TEXTO2                              AS TC_TEXTO2                      
	,WFR.PC_TEXTO3                              AS TC_TEXTO3                              
	,WFR.PC_CALIFICACION_SBIF 					AS TC_CALIFICACION_SBIF 	
	,WFR.PF_PERIODO_CALIFICACION 				AS TF_PERIODO_CALIFICACION 	
	,WFR.PD_PI_CLIENTE 							AS TD_PI_CLIENTE 	
	,WFR.PC_CLASIFICACION_SBIF 					AS TC_CLASIFICACION_SBIF 	
    ,WFR.PE_FDR        							AS TE_FDR 
    ,WFR.PE_COS_CLI    							AS TE_COS_CLI 	
	,WFR.PE_FILTROS_RIESGOS                     AS TE_FILTROS_RIESGOS             
	,WFR.PC_PAR_CALIFICACION_SBIF				AS TC_PAR_CALIFICACION_SBIF 	
    ,WFR.PD_PAR_PI_CLIENTE 	       				AS TD_PAR_PI_CLIENTE  	
    ,WFR.PE_PAR_FDR 		       				AS TE_PAR_FDR 		
    ,WFR.PE_PAR_COS_CLI 		       			AS TE_PAR_COS_CLI             
	,WFR.PE_MOLESTO                             AS TE_MOLESTO                     
	,WFR.PE_CARGABLE                            AS TE_CARGABLE                    
	,WFR.PC_ELIMINADO                           AS TC_ELIMINADO                   
	,WFR.PE_NO_CUMPLE_POTENCIAL                 AS TE_NO_CUMPLE_POTENCIAL         
	,WFR.PE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO             
	,WFR.PC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE      
	,WFR.PE_FLG_EXCLUSION                       AS TE_FLG_EXCLUSION               
	,WFR.PC_MOTIVO_EXCLUSION                    AS TC_MOTIVO_EXCLUSION            
	,WFR.PC_CANAL_ASIGNACION                    AS TC_CANAL_ASIGNACION            
FROM {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES_FR WFR
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP1 AS GRP1
	ON WFR.PD_RUT= GRP1.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 34;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP,TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_01;
.IF ERRORCODE <> 0 THEN .QUIT 35;

--/***********************************************************************
--**		ACTUALIZA CAMPO PE_YA_CAMPANADO								**  
--***********************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_02;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_02
(
	 TE_PERIODO_CMP							INTEGER
	,TC_TIPO_CMP							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CAMPANA_BLINDAR                   	INTEGER
    ,TC_CAUSA_BLINDAR                     	VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_RUT 							 	DECIMAL(8,0)	
	,TE_VALOR							 	BIGINT
	,TE_VALOR_FIJO  						BIGINT
	,TC_FUENTE_POTENCIAL					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_POTENCIAL_MOVIL_PARA_EXCLUIR		BIGINT
	,TE_OPERA_CHINA							INTEGER
	,TE_MTO_CHINA_USD						BIGINT
	,TE_YA_CAMPANADO						INTEGER
	,TC_MACRO_BANCA							VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_REGIONAL    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_CTA_CTE								INTEGER
	,TC_EJE_CMP								VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_COMEX    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_MESA    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC		
	,TE_IQUIQUE_DESCARTAR					INTEGER	
	,TE_EN_LISTA_NEGRA						INTEGER	
	,TC_TEXTO1 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3 								VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CALIFICACION_SBIF 					VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TF_PERIODO_CALIFICACION  				DATE FORMAT	'YYYY-MM-DD'
	,TD_PI_CLIENTE  						DECIMAL (25,10)
	,TC_CLASIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_FDR 								INTEGER
	,TE_COS_CLI         					INTEGER
	,TE_FILTROS_RIESGOS 					INTEGER
	,TC_PAR_CALIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE 						DECIMAL (25,10)
	,TE_PAR_FDR 							INTEGER
	,TE_PAR_COS_CLI   						INTEGER
	,TE_MOLESTO 							INTEGER
	,TE_CARGABLE							INTEGER
	,TC_ELIMINADO  							VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_NO_CUMPLE_POTENCIAL                 INTEGER
	,TE_EN_PLANEAMIENTO 					INTEGER
	,TC_RECOMENDACION_DE_CRUCE 				VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FLG_EXCLUSION						INTEGER
	,TC_MOTIVO_EXCLUSION					VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CANAL_ASIGNACION                    VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
) UNIQUE PRIMARY INDEX (TE_PERIODO_CMP,TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 36;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_02
SELECT 
	 TRN.TE_PERIODO_CMP							AS TE_PERIODO_CMP                 
	,TRN.TC_TIPO_CMP                            AS TC_TIPO_CMP                    
	,TRN.TE_CAMPANA_BLINDAR						AS TE_CAMPANA_BLINDAR             
	,TRN.TC_CAUSA_BLINDAR                       AS TC_CAUSA_BLINDAR               
	,TRN.TD_RUT                                 AS TD_RUT                         
	,TRN.TE_VALOR                               AS TE_VALOR                       
	,TRN.TE_VALOR_FIJO                          AS TE_VALOR_FIJO                  
	,TRN.TC_FUENTE_POTENCIAL                    AS TC_FUENTE_POTENCIAL            
	,TRN.TE_POTENCIAL_MOVIL_PARA_EXCLUIR        AS TE_POTENCIAL_MOVIL_PARA_EXCLUIR
	,TRN.TE_OPERA_CHINA                         AS TE_OPERA_CHINA                 
	,TRN.TE_MTO_CHINA_USD                       AS TE_MTO_CHINA_USD   

	,CASE WHEN GRP2.TD_RUT IS NOT NULL
		THEN 1
		ELSE 0 END 		                        AS TE_YA_CAMPANADO                

	,TRN.TC_MACRO_BANCA                         AS TC_MACRO_BANCA                 
	,TRN.TC_REGIONAL                            AS TC_REGIONAL                    
	,TRN.TE_CTA_CTE                             AS TE_CTA_CTE                     
	,TRN.TC_EJE_CMP                             AS TC_EJE_CMP    
	,TRN.TC_EJE_COMEX							AS TC_EJE_COMEX 
	,TRN.TC_EJE_MESA							AS TC_EJE_MESA  	                 
	,TRN.TE_IQUIQUE_DESCARTAR                   AS TE_IQUIQUE_DESCARTAR           
	,TRN.TE_EN_LISTA_NEGRA                      AS TE_EN_LISTA_NEGRA              
	,TRN.TC_TEXTO1                              AS TC_TEXTO1                      
	,TRN.TC_TEXTO2                              AS TC_TEXTO2                      
	,TRN.TC_TEXTO3                              AS TC_TEXTO3                              
	,TRN.TC_CALIFICACION_SBIF 					AS TC_CALIFICACION_SBIF 	
	,TRN.TF_PERIODO_CALIFICACION 				AS TF_PERIODO_CALIFICACION 	
	,TRN.TD_PI_CLIENTE 							AS TD_PI_CLIENTE 	
	,TRN.TC_CLASIFICACION_SBIF 					AS TC_CLASIFICACION_SBIF 	
    ,TRN.TE_FDR        							AS TE_FDR 
    ,TRN.TE_COS_CLI    							AS TE_COS_CLI 	
	,TRN.TE_FILTROS_RIESGOS                     AS TE_FILTROS_RIESGOS             
	,TRN.TC_PAR_CALIFICACION_SBIF				AS TC_PAR_CALIFICACION_SBIF 	
    ,TRN.TD_PAR_PI_CLIENTE 	       				AS TD_PAR_PI_CLIENTE  	
    ,TRN.TE_PAR_FDR 		       				AS TE_PAR_FDR 		
    ,TRN.TE_PAR_COS_CLI 		       			AS TE_PAR_COS_CLI             
	,TRN.TE_MOLESTO                             AS TE_MOLESTO                     
	,TRN.TE_CARGABLE                            AS TE_CARGABLE                    
	,TRN.TC_ELIMINADO                           AS TC_ELIMINADO                   
	,TRN.TE_NO_CUMPLE_POTENCIAL                 AS TE_NO_CUMPLE_POTENCIAL         
	,TRN.TE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO             
	,TRN.TC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE      
	,TRN.TE_FLG_EXCLUSION                       AS TE_FLG_EXCLUSION               
	,TRN.TC_MOTIVO_EXCLUSION                    AS TC_MOTIVO_EXCLUSION            
	,TRN.TC_CANAL_ASIGNACION                    AS TC_CANAL_ASIGNACION            
FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_01 TRN
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP2 AS GRP2
	ON TRN.TD_RUT= GRP2.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 37;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP,TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_02;
.IF ERRORCODE <> 0 THEN .QUIT 38;

--/***********************************************************************
--**		ACTUALIZA CAMPO PE_YA_CAMPANADO								**  
--***********************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_03;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_03
(
	 TE_PERIODO_CMP							INTEGER
	,TC_TIPO_CMP							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CAMPANA_BLINDAR                   	INTEGER
    ,TC_CAUSA_BLINDAR                     	VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_RUT 							 	DECIMAL(8,0)	
	,TE_VALOR							 	BIGINT
	,TE_VALOR_FIJO  						BIGINT
	,TC_FUENTE_POTENCIAL					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_POTENCIAL_MOVIL_PARA_EXCLUIR		BIGINT
	,TE_OPERA_CHINA							INTEGER
	,TE_MTO_CHINA_USD						BIGINT
	,TE_YA_CAMPANADO						INTEGER
	,TC_MACRO_BANCA							VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_REGIONAL    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_CTA_CTE								INTEGER
	,TC_EJE_CMP								VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_COMEX    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_MESA    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC		
	,TE_IQUIQUE_DESCARTAR					INTEGER	
	,TE_EN_LISTA_NEGRA						INTEGER	
	,TC_TEXTO1 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3 								VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CALIFICACION_SBIF 					VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TF_PERIODO_CALIFICACION  				DATE FORMAT	'YYYY-MM-DD'
	,TD_PI_CLIENTE  						DECIMAL (25,10)
	,TC_CLASIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_FDR 								INTEGER
	,TE_COS_CLI         					INTEGER
	,TE_FILTROS_RIESGOS 					INTEGER
	,TC_PAR_CALIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE 						DECIMAL (25,10)
	,TE_PAR_FDR 							INTEGER
	,TE_PAR_COS_CLI   						INTEGER
	,TE_MOLESTO 							INTEGER
	,TE_CARGABLE							INTEGER
	,TC_ELIMINADO  							VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_NO_CUMPLE_POTENCIAL                 INTEGER
	,TE_EN_PLANEAMIENTO 					INTEGER
	,TC_RECOMENDACION_DE_CRUCE 				VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FLG_EXCLUSION						INTEGER
	,TC_MOTIVO_EXCLUSION					VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CANAL_ASIGNACION                    VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
) UNIQUE PRIMARY INDEX (TE_PERIODO_CMP,TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 39;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_03
SELECT 
	 TRN.TE_PERIODO_CMP							AS TE_PERIODO_CMP                 
	,TRN.TC_TIPO_CMP                            AS TC_TIPO_CMP                    
	,TRN.TE_CAMPANA_BLINDAR						AS TE_CAMPANA_BLINDAR             
	,TRN.TC_CAUSA_BLINDAR                       AS TC_CAUSA_BLINDAR               
	,TRN.TD_RUT                                 AS TD_RUT                         
	,TRN.TE_VALOR                               AS TE_VALOR                       
	,TRN.TE_VALOR_FIJO                          AS TE_VALOR_FIJO                  
	,TRN.TC_FUENTE_POTENCIAL                    AS TC_FUENTE_POTENCIAL            
	,TRN.TE_POTENCIAL_MOVIL_PARA_EXCLUIR        AS TE_POTENCIAL_MOVIL_PARA_EXCLUIR
	,TRN.TE_OPERA_CHINA                         AS TE_OPERA_CHINA                 
	,TRN.TE_MTO_CHINA_USD                       AS TE_MTO_CHINA_USD   

	,CASE WHEN GRP3.TD_RUT IS NOT NULL
		THEN 1
		ELSE 0 END 		                        AS TE_YA_CAMPANADO                

	,TRN.TC_MACRO_BANCA                         AS TC_MACRO_BANCA                 
	,TRN.TC_REGIONAL                            AS TC_REGIONAL   

	,CASE WHEN TRN.TC_MACRO_BANCA = BAN.TC_MACRO_BANCA  
		AND TRN.TE_CTA_CTE = 0
		THEN 1
		ELSE TRN.TE_CTA_CTE END  	    AS TE_CTA_CTE           

	,CASE WHEN TRN.TC_CANAL_ASIGNACION = 'EJE_COMEX' 
			THEN TRN.TC_EJE_COMEX
		WHEN TRN.TC_CANAL_ASIGNACION = 'EJE_MESA'
			THEN TRN.TC_EJE_MESA
		ELSE TRN.TC_EJE_CMP END                 AS TC_EJE_CMP     

	,TRN.TC_EJE_COMEX							AS TC_EJE_COMEX 
	,TRN.TC_EJE_MESA 							AS TC_EJE_MESA  	  		

	,CASE WHEN IQU.TD_RUT1 IS NOT NULL 
		THEN 1
		ELSE TRN.TE_IQUIQUE_DESCARTAR END  	    AS TE_IQUIQUE_DESCARTAR           
   
	,CASE WHEN NEG.TD_RUT1 IS NOT NULL 
		THEN 1
		ELSE TRN.TE_EN_LISTA_NEGRA END  	    AS TE_EN_LISTA_NEGRA    

	,TRN.TC_TEXTO1                              AS TC_TEXTO1                      
	,TRN.TC_TEXTO2                              AS TC_TEXTO2                      
	,TRN.TC_TEXTO3                              AS TC_TEXTO3                              
	,TRN.TC_CALIFICACION_SBIF 					AS TC_CALIFICACION_SBIF 	
	,TRN.TF_PERIODO_CALIFICACION 				AS TF_PERIODO_CALIFICACION 	
	,TRN.TD_PI_CLIENTE 							AS TD_PI_CLIENTE 	
	,TRN.TC_CLASIFICACION_SBIF 					AS TC_CLASIFICACION_SBIF 	
    ,TRN.TE_FDR        							AS TE_FDR 
    ,TRN.TE_COS_CLI    							AS TE_COS_CLI 	
	,TRN.TE_FILTROS_RIESGOS                     AS TE_FILTROS_RIESGOS             
	,TRN.TC_PAR_CALIFICACION_SBIF				AS TC_PAR_CALIFICACION_SBIF 	
    ,TRN.TD_PAR_PI_CLIENTE 	       				AS TD_PAR_PI_CLIENTE  	
    ,TRN.TE_PAR_FDR 		       				AS TE_PAR_FDR 		
    ,TRN.TE_PAR_COS_CLI 		       			AS TE_PAR_COS_CLI             
	,TRN.TE_MOLESTO                             AS TE_MOLESTO                     
	,TRN.TE_CARGABLE                            AS TE_CARGABLE                    
	,TRN.TC_ELIMINADO                           AS TC_ELIMINADO                   
	,TRN.TE_NO_CUMPLE_POTENCIAL                 AS TE_NO_CUMPLE_POTENCIAL         
	,TRN.TE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO             
	,TRN.TC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE      
	,TRN.TE_FLG_EXCLUSION                       AS TE_FLG_EXCLUSION               
	,TRN.TC_MOTIVO_EXCLUSION                    AS TC_MOTIVO_EXCLUSION            
	,TRN.TC_CANAL_ASIGNACION                    AS TC_CANAL_ASIGNACION            
FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_02 TRN
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP3 AS GRP3
	ON TRN.TD_RUT= GRP3.TD_RUT
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_RUT_IQUIQUE AS IQU
	ON TRN.TD_RUT = IQU.TD_RUT1
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_LISTA_NEGRA_MESA AS NEG
	ON TRN.TD_RUT = NEG.TD_RUT1
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_MACRO_BANCA AS BAN	
	ON  TRN.TC_MACRO_BANCA = BAN.TC_MACRO_BANCA 
;
.IF ERRORCODE <> 0 THEN .QUIT 40;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP,TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_03;
.IF ERRORCODE <> 0 THEN .QUIT 41;

--/***************************************************************************************
--** ACTUALIZA CAMPAÑABLES, BLINDAJE, REGLA DE AJUSTE PARA CLIENTES SEGUN SU POTENCIAL	**  
--***************************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_04;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_04
(
	 TE_PERIODO_CMP							INTEGER
	,TC_TIPO_CMP							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CAMPANA_BLINDAR                   	INTEGER
    ,TC_CAUSA_BLINDAR                     	VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_RUT 							 	DECIMAL(8,0)	
	,TE_VALOR							 	BIGINT
	,TE_VALOR_FIJO  						BIGINT
	,TC_FUENTE_POTENCIAL					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_POTENCIAL_MOVIL_PARA_EXCLUIR		BIGINT
	,TE_OPERA_CHINA							INTEGER
	,TE_MTO_CHINA_USD						BIGINT
	,TE_YA_CAMPANADO						INTEGER
	,TC_MACRO_BANCA							VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_REGIONAL    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_CTA_CTE								INTEGER
	,TC_EJE_CMP								VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_COMEX    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_MESA    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC		
	,TE_IQUIQUE_DESCARTAR					INTEGER	
	,TE_EN_LISTA_NEGRA						INTEGER	
	,TC_TEXTO1 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3 								VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CALIFICACION_SBIF 					VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TF_PERIODO_CALIFICACION  				DATE FORMAT	'YYYY-MM-DD'
	,TD_PI_CLIENTE  						DECIMAL (25,10)
	,TC_CLASIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_FDR 								INTEGER
	,TE_COS_CLI         					INTEGER
	,TE_FILTROS_RIESGOS 					INTEGER
	,TC_PAR_CALIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE 						DECIMAL (25,10)
	,TE_PAR_FDR 							INTEGER
	,TE_PAR_COS_CLI   						INTEGER
	,TE_MOLESTO 							INTEGER
	,TE_CARGABLE							INTEGER
	,TC_ELIMINADO  							VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_NO_CUMPLE_POTENCIAL                 INTEGER
	,TE_EN_PLANEAMIENTO 					INTEGER
	,TC_RECOMENDACION_DE_CRUCE 				VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FLG_EXCLUSION						INTEGER
	,TC_MOTIVO_EXCLUSION					VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CANAL_ASIGNACION                    VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
) UNIQUE PRIMARY INDEX (TE_PERIODO_CMP,TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 42;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_04
SELECT 
	 TRN.TE_PERIODO_CMP							AS TE_PERIODO_CMP                 
	,TRN.TC_TIPO_CMP                            AS TC_TIPO_CMP                    
	,TRN.TE_CAMPANA_BLINDAR						AS TE_CAMPANA_BLINDAR             
	,TRN.TC_CAUSA_BLINDAR                       AS TC_CAUSA_BLINDAR               
	,TRN.TD_RUT                                 AS TD_RUT                         
	,TRN.TE_VALOR                               AS TE_VALOR                       
	,TRN.TE_VALOR_FIJO                          AS TE_VALOR_FIJO                  
	,TRN.TC_FUENTE_POTENCIAL                    AS TC_FUENTE_POTENCIAL            
	,TRN.TE_POTENCIAL_MOVIL_PARA_EXCLUIR        AS TE_POTENCIAL_MOVIL_PARA_EXCLUIR
	,TRN.TE_OPERA_CHINA                         AS TE_OPERA_CHINA                 
	,TRN.TE_MTO_CHINA_USD                       AS TE_MTO_CHINA_USD   

	,CASE WHEN GRP4.TD_RUT IS NOT NULL
		THEN 1
		ELSE 0 END 		                        AS TE_YA_CAMPANADO                

	,TRN.TC_MACRO_BANCA                         AS TC_MACRO_BANCA                 
	,TRN.TC_REGIONAL                            AS TC_REGIONAL                    
	,TRN.TE_CTA_CTE                             AS TE_CTA_CTE                     
	,TRN.TC_EJE_CMP                             AS TC_EJE_CMP    
	,TRN.TC_EJE_COMEX							AS TC_EJE_COMEX 
	,TRN.TC_EJE_MESA							AS TC_EJE_MESA  	  	                 
	,TRN.TE_IQUIQUE_DESCARTAR                   AS TE_IQUIQUE_DESCARTAR           
	,TRN.TE_EN_LISTA_NEGRA                      AS TE_EN_LISTA_NEGRA              
	,TRN.TC_TEXTO1                              AS TC_TEXTO1                      
	,TRN.TC_TEXTO2                              AS TC_TEXTO2                      
	,TRN.TC_TEXTO3                              AS TC_TEXTO3                              
	,TRN.TC_CALIFICACION_SBIF 					AS TC_CALIFICACION_SBIF 	
	,TRN.TF_PERIODO_CALIFICACION 				AS TF_PERIODO_CALIFICACION 	
	,TRN.TD_PI_CLIENTE 							AS TD_PI_CLIENTE 	
	,TRN.TC_CLASIFICACION_SBIF 					AS TC_CLASIFICACION_SBIF 	
    ,TRN.TE_FDR        							AS TE_FDR 
    ,TRN.TE_COS_CLI    							AS TE_COS_CLI 	
	,TRN.TE_FILTROS_RIESGOS                     AS TE_FILTROS_RIESGOS             
	,TRN.TC_PAR_CALIFICACION_SBIF				AS TC_PAR_CALIFICACION_SBIF 	
    ,TRN.TD_PAR_PI_CLIENTE 	       				AS TD_PAR_PI_CLIENTE  	
    ,TRN.TE_PAR_FDR 		       				AS TE_PAR_FDR 		
    ,TRN.TE_PAR_COS_CLI 		       			AS TE_PAR_COS_CLI             
	,TRN.TE_MOLESTO                             AS TE_MOLESTO  

	,CASE WHEN TRN.TE_FILTROS_RIESGOS > 0 
		  AND TRN.TC_MACRO_BANCA = BAN.SC_MACRO_BANCA 
		  AND TRN.TD_RUT = TPO.TD_RUT
		  AND TPO.TE_CASO_CMP = 1
		  AND TRN.TE_CTA_CTE = 1 
		  AND TRN.TE_MOLESTO=0  
		  AND TRN.TE_EN_LISTA_NEGRA=0 
		  AND NOT(COALESCE(TRN.TC_EJE_CMP,'0')  = '0')
		  AND NOT(COALESCE(TRN.TC_EJE_CMP,'0')  = 'IQUIQU')
		  AND NOT(COALESCE(TRN.TC_REGIONAL,'0') = '0')
    	  AND TRN.TE_IQUIQUE_DESCARTAR = 0 
		  AND TRN.TE_YA_CAMPANADO = 0 
		  AND TRN.TE_FLG_EXCLUSION=0
		  AND TRN.TE_NO_CUMPLE_POTENCIAL=0
		  	THEN 1
			ELSE TRN.TE_CARGABLE END            AS TE_CARGABLE                    

	,TRN.TC_ELIMINADO                           AS TC_ELIMINADO                   

	,CASE 
		WHEN TRN.TC_MACRO_BANCA IN ('CORPORATIVA','MAYORISTA') 			AND TRN.TE_POTENCIAL_MOVIL_PARA_EXCLUIR >= 10000000 THEN 0 
		WHEN TRN.TC_MACRO_BANCA IN ('GRANDES EMPRESAS','INMOBILIARIA') 	AND TRN.TE_POTENCIAL_MOVIL_PARA_EXCLUIR >= 1000000 	THEN 0
		WHEN TRN.TC_MACRO_BANCA = 'EMPRESAS' 							AND TRN.TE_POTENCIAL_MOVIL_PARA_EXCLUIR >= 500000 	THEN 0
		WHEN TRN.TC_MACRO_BANCA IN ('EMPRENDEDORES','EMPRESARIOS') 		AND TRN.TE_POTENCIAL_MOVIL_PARA_EXCLUIR >= 300000 	THEN 0
		ELSE 1
	 END						                AS TE_NO_CUMPLE_POTENCIAL         

	,TRN.TE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO             
	,TRN.TC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE      
	,TRN.TE_FLG_EXCLUSION                       AS TE_FLG_EXCLUSION               
	,TRN.TC_MOTIVO_EXCLUSION                    AS TC_MOTIVO_EXCLUSION            
	,TRN.TC_CANAL_ASIGNACION                    AS TC_CANAL_ASIGNACION            
FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_03 TRN
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_NOMB_GRP3 AS GRP4
	ON TRN.TD_RUT= GRP4.TD_RUT
LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_MACRO_BANCA AS BAN
	ON TRN.TC_MACRO_BANCA = BAN.SC_MACRO_BANCA 
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_MESA_CASO_TIPO_CMP AS TPO	
	ON TRN.TD_RUT = TPO.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 43;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP,TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_04;
.IF ERRORCODE <> 0 THEN .QUIT 44;

--/***********************************************************************
--**		ACTUALIZA CAMPO PE_YA_CAMPANADO								**  
--***********************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES_RN;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES_RN
(
	 PE_PERIODO_CMP							INTEGER
	,PC_TIPO_CMP							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_CAMPANA_BLINDAR                   	INTEGER
    ,PC_CAUSA_BLINDAR                     	VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_RUT 							 	DECIMAL(8,0)	
	,PE_VALOR							 	BIGINT
	,PE_VALOR_FIJO  						BIGINT
	,PC_FUENTE_POTENCIAL					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_POTENCIAL_MOVIL_PARA_EXCLUIR		BIGINT
	,PE_OPERA_CHINA							INTEGER
	,PE_MTO_CHINA_USD						BIGINT
	,PE_YA_CAMPANADO						INTEGER
	,PC_MACRO_BANCA							VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_REGIONAL    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_CTA_CTE								INTEGER
	,PC_EJE_CMP								VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_EJE_COMEX    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_EJE_MESA    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC		
	,PE_IQUIQUE_DESCARTAR					INTEGER	
	,PE_EN_LISTA_NEGRA						INTEGER	
	,PC_TEXTO1 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO2 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO3 								VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_CALIFICACION_SBIF 					VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,PF_PERIODO_CALIFICACION  				DATE FORMAT	'YYYY-MM-DD'
	,PD_PI_CLIENTE  						DECIMAL (25,10)
	,PC_CLASIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_FDR 								INTEGER
	,PE_COS_CLI         					INTEGER
	,PE_FILTROS_RIESGOS 					INTEGER
	,PC_PAR_CALIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,PD_PAR_PI_CLIENTE 						DECIMAL (25,10)
	,PE_PAR_FDR 							INTEGER
	,PE_PAR_COS_CLI   						INTEGER
	,PE_MOLESTO 							INTEGER
	,PE_CARGABLE							INTEGER
	,PC_ELIMINADO  							VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC	
	,PE_NO_CUMPLE_POTENCIAL                 INTEGER
	,PE_EN_PLANEAMIENTO 					INTEGER
	,PC_RECOMENDACION_DE_CRUCE 				VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC	
	,PE_FLG_EXCLUSION						INTEGER
	,PC_MOTIVO_EXCLUSION					VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_CANAL_ASIGNACION                    VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
) UNIQUE PRIMARY INDEX (PE_PERIODO_CMP,PD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 45;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES_RN
SELECT 
	 TRN.TE_PERIODO_CMP							AS PE_PERIODO_CMP                 
	,TRN.TC_TIPO_CMP                            AS PC_TIPO_CMP                    
	,TRN.TE_CAMPANA_BLINDAR						AS PE_CAMPANA_BLINDAR             
	,TRN.TC_CAUSA_BLINDAR                       AS PC_CAUSA_BLINDAR               
	,TRN.TD_RUT                                 AS PD_RUT                         
	,TRN.TE_VALOR                               AS PE_VALOR                       
	,TRN.TE_VALOR_FIJO                          AS PE_VALOR_FIJO                  
	,TRN.TC_FUENTE_POTENCIAL                    AS PC_FUENTE_POTENCIAL            
	,TRN.TE_POTENCIAL_MOVIL_PARA_EXCLUIR        AS PE_POTENCIAL_MOVIL_PARA_EXCLUIR
	,TRN.TE_OPERA_CHINA                         AS PE_OPERA_CHINA                 
	,TRN.TE_MTO_CHINA_USD                       AS PE_MTO_CHINA_USD   
	,TRN.TE_YA_CAMPANADO                        AS PE_YA_CAMPANADO                
	,TRN.TC_MACRO_BANCA                         AS PC_MACRO_BANCA                 
	,TRN.TC_REGIONAL                            AS PC_REGIONAL                    
	,TRN.TE_CTA_CTE                             AS PE_CTA_CTE                     
	,TRN.TC_EJE_CMP                             AS PC_EJE_CMP      
	,TRN.TC_EJE_COMEX							AS PC_EJE_COMEX 
	,TRN.TC_EJE_MESA							AS PC_EJE_MESA  	  	               
	,TRN.TE_IQUIQUE_DESCARTAR                   AS PE_IQUIQUE_DESCARTAR           
	,TRN.TE_EN_LISTA_NEGRA                      AS PE_EN_LISTA_NEGRA              
	,TRN.TC_TEXTO1                              AS PC_TEXTO1                      
	,TRN.TC_TEXTO2                              AS PC_TEXTO2                      
	,TRN.TC_TEXTO3                              AS PC_TEXTO3                              
	,TRN.TC_CALIFICACION_SBIF 					AS PC_CALIFICACION_SBIF 	
	,TRN.TF_PERIODO_CALIFICACION 				AS PF_PERIODO_CALIFICACION 	
	,TRN.TD_PI_CLIENTE 							AS PD_PI_CLIENTE 	
	,TRN.TC_CLASIFICACION_SBIF 					AS PC_CLASIFICACION_SBIF 	
    ,TRN.TE_FDR        							AS PE_FDR 
    ,TRN.TE_COS_CLI    							AS PE_COS_CLI 	
	,TRN.TE_FILTROS_RIESGOS                     AS PE_FILTROS_RIESGOS             
	,TRN.TC_PAR_CALIFICACION_SBIF				AS PC_PAR_CALIFICACION_SBIF 	
    ,TRN.TD_PAR_PI_CLIENTE 	       				AS PD_PAR_PI_CLIENTE  	
    ,TRN.TE_PAR_FDR 		       				AS PE_PAR_FDR 		
    ,TRN.TE_PAR_COS_CLI 		       			AS PE_PAR_COS_CLI             
	,TRN.TE_MOLESTO                             AS PE_MOLESTO  
	,TRN.TE_CARGABLE				           	AS PE_CARGABLE  

	,CASE WHEN TRN.TE_CARGABLE = 0 
	  THEN 
	   CASE 
		WHEN COALESCE(TRN.TE_FILTROS_RIESGOS,0) = 0					THEN '01.- FILTROS RIESGOS'
        WHEN TRN.TC_MACRO_BANCA NOT IN ('EMPRESARIOS','EMPRENDEDORES','EMPRESAS','GRANDES EMPRESAS','CORPORATIVA','MAYORISTA') 
																	THEN '02.- BANCA NO CORRESPONDE'
		WHEN TRN.TC_TIPO_CMP = 'BLINDAR' AND PE_CAMPANA_BLINDAR = 0 THEN '03.- BLINDAR SIN MARCA DE CMP EN INPUT ANALITYCS'
		WHEN COALESCE(TRN.TE_CTA_CTE,0) = 0							THEN '04.- SIN CTA CTE'
        WHEN COALESCE(TRN.TE_MOLESTO,0) > 0							THEN '05.- MOLESTOS'
		WHEN COALESCE(TRN.TE_EN_LISTA_NEGRA,0) > 0					THEN '06.- EN LISTA NEGRA MESA'
		WHEN COALESCE(TRN.TC_EJE_CMP,'0') IN ('0','IQUIQU')			THEN '07.- SIN ESPECIALISTA PARA ASIGNAR EN CANAL '||RTRIM(TRN.TC_CANAL_ASIGNACION)
		WHEN COALESCE(TRN.TC_REGIONAL,'0') IN ('0','')				THEN '08.- SIN REGIONAL'
		WHEN COALESCE(TRN.TE_IQUIQUE_DESCARTAR,0)>0 				THEN '09.- CLIENTE CON MARCA ZONA FRANCA'			
		WHEN TRN.TE_YA_CAMPANADO = 1 								THEN '09.- CLIENTE CAMPAÑADO ULT 30/60 DIAS CON GESTION TERMINAL'
		WHEN COALESCE(TRN.TE_FLG_EXCLUSION,0) = 1					THEN '10.- EXCLUIR : '||RTRIM(TRN.TC_MOTIVO_EXCLUSION)
		WHEN COALESCE(TRN.TE_NO_CUMPLE_POTENCIAL,0) >0				THEN '11.- REGLA EXCLUSION POR POTENCIAL INFERIOR A REGLA'
        ELSE '' END
	   ELSE TRN.TC_ELIMINADO END                AS PC_ELIMINADO                   

	,TRN.TE_NO_CUMPLE_POTENCIAL	                AS PE_NO_CUMPLE_POTENCIAL         
	,TRN.TE_EN_PLANEAMIENTO                     AS PE_EN_PLANEAMIENTO             
	,TRN.TC_RECOMENDACION_DE_CRUCE              AS PC_RECOMENDACION_DE_CRUCE      
	,TRN.TE_FLG_EXCLUSION                       AS PE_FLG_EXCLUSION               
	,TRN.TC_MOTIVO_EXCLUSION                    AS PC_MOTIVO_EXCLUSION            
	,TRN.TC_CANAL_ASIGNACION                    AS PC_CANAL_ASIGNACION            
FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_RN_04 TRN
;
.IF ERRORCODE <> 0 THEN .QUIT 46;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP,PD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES_RN;
.IF ERRORCODE <> 0 THEN .QUIT 47;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 21 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: MODIFICA LITERALES DE CAMPANA MESA ACTIVAR BLINDAR CAPTAR LITERALES		  **
--**																			          **
--** AUTOR  : RODRIGO CASTILLO                                             				  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 05/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN:                                                           				  **
--** AUTOR  :                                                           				  **
--** FECHA  : SSAAMMDD                                                  				  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:																	  **
--**					{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES**
--** TABLA DE SALIDA: 										      						  **
--**					{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES**
--**																					  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/***********************************************************************
--**  						UPDATE LITERALES							**
--***********************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES 
SET 
	 PC_TEXTO1 = ''
	,PC_TEXTO2 = ''
	,PC_TEXTO3 = ''
;
.IF ERRORCODE <> 0 THEN .QUIT 1;

--/***********************************************************************
--**  						UPDATE LITERALES							**
--***********************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES
SET 
	PC_TEXTO1 = 
		CASE 
			WHEN PC_TIPO_CMP IN ('ACTIVAR','BLINDAR','BLINDAR ESTACIONALIDAD') 
					THEN 'Cliente tiene un potencial mesa fijo de : USD $'
					ELSE 'Cliente tiene un potencial mesa fijo de : USD $'
		END	|| OREPLACE(OREPLACE(OREPLACE(CAST(CAST(PE_VALOR_FIJO AS FORMAT 'ZZZ,ZZZ,ZZ9.99' ) AS VARCHAR(50)) ,',','q'),'.',','),'q','.')
			||'; (Fuente : '||COALESCE(OREPLACE(OREPLACE(RTRIM(PC_FUENTE_POTENCIAL),'Ordenes_Pago','Ordenes de Pago')
			,'colocaciones_comex','Colocaciones Comex'),'S/I')
			||').'
WHERE 
	PC_ELIMINADO = ''
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_PERIODO_CMP,PE_RUT )
	ON  {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES;
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/*******************************************************************
--** TABLA TEMPORAL TIPO_CMP										**
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_WSB_TIPO_CMP;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_WSB_TIPO_CMP
(
	TC_TIPO_CMP		VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC)
PRIMARY INDEX ( TC_TIPO_CMP )
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_WSB_TIPO_CMP VALUES('BLINDAR');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_WSB_TIPO_CMP VALUES('BLINDAR ESTACIONALIDAD');
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/* *********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TC_TIPO_CMP )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_WSB_TIPO_CMP;
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/***********************************************************************
--**  						UPDATE LITERALES							**
--***********************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_WSB_TIPO_CMP AS CMP
SET 
	PC_TEXTO1 = RTRIM(PC_TEXTO1)||
		CASE 
			WHEN PC_CAUSA_BLINDAR = 'ESTACIONALIDAD POSITIVA' 
					THEN ' Monto a Captar por Estacionalidad USD $'
					|| OREPLACE(OREPLACE(OREPLACE(CAST(CAST(PE_VALOR AS FORMAT 'ZZZ,ZZZ,ZZ9.99' ) AS VARCHAR(50)) ,',','q'),'.',','),'q','.')
			WHEN PC_CAUSA_BLINDAR = 'FUGA' 
					THEN ' Monto a Recuperar por Fuga USD $'
					||CAST(PE_VALOR AS VARCHAR(100))
			ELSE ''
		END||'.'
WHERE
	PC_TIPO_CMP = CMP.TC_TIPO_CMP 
	AND PC_ELIMINADO = ''
;
.IF ERRORCODE <> 0 THEN .QUIT 7;

--/***********************************************************************
--**  						UPDATE LITERALES							**
--***********************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES
SET 
	PC_TEXTO1 = RTRIM(PC_TEXTO1)
					||' Monto a Recuperar por Activacion USD $'
					|| OREPLACE(OREPLACE(OREPLACE(CAST(CAST(PE_VALOR AS FORMAT 'ZZZ,ZZZ,ZZ9.99' ) AS VARCHAR(50)) ,',','q'),'.',','),'q','.')
					||'.'
WHERE 
	PC_TIPO_CMP = ('ACTIVAR') 
	AND PC_ELIMINADO = ''	 
	AND COALESCE(PE_VALOR,0) > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/***********************************************************************
--**  						UPDATE LITERALES							**
--***********************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES
SET 
	PC_TEXTO2 = 'Cliente opera Comex con China por un monto de : USD $'
				||OREPLACE(OREPLACE(OREPLACE(CAST(CAST(PE_MTO_CHINA_USD AS FORMAT 'ZZZ,ZZZ,ZZ9.99' ) AS VARCHAR(50)) ,',','q'),'.',','),'q','.')
WHERE 
	PC_ELIMINADO = '' 
	AND PE_OPERA_CHINA > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/***********************************************************************
--**  						UPDATE LITERALES							**
--***********************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES
SET 
	PC_TEXTO3 = 'Causa Blindaje : '
				||PC_CAUSA_BLINDAR
WHERE 
	PC_ELIMINADO = '' 
	AND PE_CAMPANA_BLINDAR > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 10;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_PERIODO_CMP,PE_RUT )
	ON  {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES;
.IF ERRORCODE <> 0 THEN .QUIT 11;


SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 21 OK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: MODIFICA LITERALES DE CAMPANA MESA ACTIVAR BLINDAR CAPTAR LITERALES		  **
--**																			          **
--** AUTOR  : RODRIGO CASTILLO                                             				  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 05/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 12/2024			     	                                                  **
--*****************************************************************************************/
--**TABLA DE ENTRADA:																	  **
--**  {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES**
--**																					  **
--** TABLA DE SALIDA: 										      						  **
--**  {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES**
--**																					  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;


--/***********************************************************************
--**		ACTUALIZA LITERALES											**  
--***********************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_LT_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_LT_01
(
	 TE_PERIODO_CMP							INTEGER
	,TC_TIPO_CMP							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CAMPANA_BLINDAR                   	INTEGER
    ,TC_CAUSA_BLINDAR                     	VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_RUT 							 	DECIMAL(8,0)	
	,TE_VALOR							 	BIGINT
	,TE_VALOR_FIJO  						BIGINT
	,TC_FUENTE_POTENCIAL					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_POTENCIAL_MOVIL_PARA_EXCLUIR		BIGINT
	,TE_OPERA_CHINA							INTEGER
	,TE_MTO_CHINA_USD						BIGINT
	,TE_YA_CAMPANADO						INTEGER
	,TC_MACRO_BANCA							VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_REGIONAL    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_CTA_CTE								INTEGER
	,TC_EJE_CMP								VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_COMEX    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_MESA    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC		
	,TE_IQUIQUE_DESCARTAR					INTEGER	
	,TE_EN_LISTA_NEGRA						INTEGER	
	,TC_TEXTO1 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3 								VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CALIFICACION_SBIF 					VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TF_PERIODO_CALIFICACION  				DATE FORMAT	'YYYY-MM-DD'
	,TD_PI_CLIENTE  						DECIMAL (25,10)
	,TC_CLASIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_FDR 								INTEGER
	,TE_COS_CLI         					INTEGER
	,TE_FILTROS_RIESGOS 					INTEGER
	,TC_PAR_CALIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE 						DECIMAL (25,10)
	,TE_PAR_FDR 							INTEGER
	,TE_PAR_COS_CLI   						INTEGER
	,TE_MOLESTO 							INTEGER
	,TE_CARGABLE							INTEGER
	,TC_ELIMINADO  							VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_NO_CUMPLE_POTENCIAL                 INTEGER
	,TE_EN_PLANEAMIENTO 					INTEGER
	,TC_RECOMENDACION_DE_CRUCE 				VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FLG_EXCLUSION						INTEGER
	,TC_MOTIVO_EXCLUSION					VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CANAL_ASIGNACION                    VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
) UNIQUE PRIMARY INDEX (TE_PERIODO_CMP,TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 1;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_LT_01
SELECT 
	 TRN.PE_PERIODO_CMP							AS TE_PERIODO_CMP                 
	,TRN.PC_TIPO_CMP                            AS TC_TIPO_CMP                    
	,TRN.PE_CAMPANA_BLINDAR						AS TE_CAMPANA_BLINDAR             
	,TRN.PC_CAUSA_BLINDAR                       AS TC_CAUSA_BLINDAR               
	,TRN.PD_RUT                                 AS TD_RUT                         
	,TRN.PE_VALOR                               AS TE_VALOR                       
	,TRN.PE_VALOR_FIJO                          AS TE_VALOR_FIJO                  
	,TRN.PC_FUENTE_POTENCIAL                    AS TC_FUENTE_POTENCIAL            
	,TRN.PE_POTENCIAL_MOVIL_PARA_EXCLUIR        AS TE_POTENCIAL_MOVIL_PARA_EXCLUIR
	,TRN.PE_OPERA_CHINA                         AS TE_OPERA_CHINA                 
	,TRN.PE_MTO_CHINA_USD                       AS TE_MTO_CHINA_USD   
	,TRN.PE_YA_CAMPANADO                        AS TE_YA_CAMPANADO                
	,TRN.PC_MACRO_BANCA                         AS TC_MACRO_BANCA                 
	,TRN.PC_REGIONAL                            AS TC_REGIONAL                    
	,TRN.PE_CTA_CTE                             AS TE_CTA_CTE                     
	,TRN.PC_EJE_CMP                             AS TC_EJE_CMP      
	,TRN.PC_EJE_COMEX							AS TC_EJE_COMEX 
	,TRN.PC_EJE_MESA							AS TC_EJE_MESA  	  	               
	,TRN.PE_IQUIQUE_DESCARTAR                   AS TE_IQUIQUE_DESCARTAR           
	,TRN.PE_EN_LISTA_NEGRA                      AS TE_EN_LISTA_NEGRA        

	,CASE 
	  WHEN TRN.PC_ELIMINADO = '' THEN
		CASE 
			WHEN TRN.PC_TIPO_CMP IN ('ACTIVAR','BLINDAR','BLINDAR ESTACIONALIDAD') 
					THEN 'Cliente tiene un potencial mesa fijo de : USD $'
					ELSE 'Cliente tiene un potencial mesa fijo de : USD $'
		END	|| OREPLACE(OREPLACE(OREPLACE(CAST(CAST(TRN.PE_VALOR_FIJO AS FORMAT 'ZZZ,ZZZ,ZZ9.99' ) AS VARCHAR(50)) ,',','q'),'.',','),'q','.')
			||'; (Fuente : '||COALESCE(OREPLACE(OREPLACE(RTRIM(TRN.PC_FUENTE_POTENCIAL),'Ordenes_Pago','Ordenes de Pago')
			,'colocaciones_comex','Colocaciones Comex'),'S/I')
			||').'
	  ELSE '' END       			            AS TC_TEXTO1                      

	,''                              			AS TC_TEXTO2                      
	,''                          				AS TC_TEXTO3                              
	,TRN.PC_CALIFICACION_SBIF 					AS TC_CALIFICACION_SBIF 	
	,TRN.PF_PERIODO_CALIFICACION 				AS TF_PERIODO_CALIFICACION 	
	,TRN.PD_PI_CLIENTE 							AS TD_PI_CLIENTE 	
	,TRN.PC_CLASIFICACION_SBIF 					AS TC_CLASIFICACION_SBIF 	
    ,TRN.PE_FDR        							AS TE_FDR 
    ,TRN.PE_COS_CLI    							AS TE_COS_CLI 	
	,TRN.PE_FILTROS_RIESGOS                     AS TE_FILTROS_RIESGOS             
	,TRN.PC_PAR_CALIFICACION_SBIF				AS TC_PAR_CALIFICACION_SBIF 	
    ,TRN.PD_PAR_PI_CLIENTE 	       				AS TD_PAR_PI_CLIENTE  	
    ,TRN.PE_PAR_FDR 		       				AS TE_PAR_FDR 		
    ,TRN.PE_PAR_COS_CLI 		       			AS TE_PAR_COS_CLI             
	,TRN.PE_MOLESTO                             AS TE_MOLESTO  
	,TRN.PE_CARGABLE				           	AS TE_CARGABLE    
	,TRN.PC_ELIMINADO             				AS TC_ELIMINADO    	                   
	,TRN.PE_NO_CUMPLE_POTENCIAL	                AS TE_NO_CUMPLE_POTENCIAL         
	,TRN.PE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO             
	,TRN.PC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE      
	,TRN.PE_FLG_EXCLUSION                       AS TE_FLG_EXCLUSION               
	,TRN.PC_MOTIVO_EXCLUSION                    AS TC_MOTIVO_EXCLUSION            
	,TRN.PC_CANAL_ASIGNACION                    AS TC_CANAL_ASIGNACION            
FROM {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES_RN TRN
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP,TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_LT_01;
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/*******************************************************************
--** TABLA TEMPORAL TIPO_CMP										**
--*******************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_WSB_TIPO_CMP;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_WSB_TIPO_CMP
(
	TC_TIPO_CMP		VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC)
UNIQUE PRIMARY INDEX ( TC_TIPO_CMP )
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_WSB_TIPO_CMP VALUES('BLINDAR');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_WSB_TIPO_CMP VALUES('BLINDAR ESTACIONALIDAD');
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/* *********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TC_TIPO_CMP )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_WSB_TIPO_CMP;
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/***********************************************************************
--**		ACTUALIZA LITERALES											**  
--***********************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_LT_02;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_LT_02
(
	 TE_PERIODO_CMP							INTEGER
	,TC_TIPO_CMP							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_CAMPANA_BLINDAR                   	INTEGER
    ,TC_CAUSA_BLINDAR                     	VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_RUT 							 	DECIMAL(8,0)	
	,TE_VALOR							 	BIGINT
	,TE_VALOR_FIJO  						BIGINT
	,TC_FUENTE_POTENCIAL					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_POTENCIAL_MOVIL_PARA_EXCLUIR		BIGINT
	,TE_OPERA_CHINA							INTEGER
	,TE_MTO_CHINA_USD						BIGINT
	,TE_YA_CAMPANADO						INTEGER
	,TC_MACRO_BANCA							VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_REGIONAL    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_CTA_CTE								INTEGER
	,TC_EJE_CMP								VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_COMEX    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_MESA    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC		
	,TE_IQUIQUE_DESCARTAR					INTEGER	
	,TE_EN_LISTA_NEGRA						INTEGER	
	,TC_TEXTO1 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3 								VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CALIFICACION_SBIF 					VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TF_PERIODO_CALIFICACION  				DATE FORMAT	'YYYY-MM-DD'
	,TD_PI_CLIENTE  						DECIMAL (25,10)
	,TC_CLASIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_FDR 								INTEGER
	,TE_COS_CLI         					INTEGER
	,TE_FILTROS_RIESGOS 					INTEGER
	,TC_PAR_CALIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE 						DECIMAL (25,10)
	,TE_PAR_FDR 							INTEGER
	,TE_PAR_COS_CLI   						INTEGER
	,TE_MOLESTO 							INTEGER
	,TE_CARGABLE							INTEGER
	,TC_ELIMINADO  							VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_NO_CUMPLE_POTENCIAL                 INTEGER
	,TE_EN_PLANEAMIENTO 					INTEGER
	,TC_RECOMENDACION_DE_CRUCE 				VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FLG_EXCLUSION						INTEGER
	,TC_MOTIVO_EXCLUSION					VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CANAL_ASIGNACION                    VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
) UNIQUE PRIMARY INDEX (TE_PERIODO_CMP,TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 7;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_LT_02
SELECT 
	 TRN.TE_PERIODO_CMP							AS TE_PERIODO_CMP                 
	,TRN.TC_TIPO_CMP                            AS TC_TIPO_CMP                    
	,TRN.TE_CAMPANA_BLINDAR						AS TE_CAMPANA_BLINDAR             
	,TRN.TC_CAUSA_BLINDAR                       AS TC_CAUSA_BLINDAR               
	,TRN.TD_RUT                                 AS TD_RUT                         
	,TRN.TE_VALOR                               AS TE_VALOR                       
	,TRN.TE_VALOR_FIJO                          AS TE_VALOR_FIJO                  
	,TRN.TC_FUENTE_POTENCIAL                    AS TC_FUENTE_POTENCIAL            
	,TRN.TE_POTENCIAL_MOVIL_PARA_EXCLUIR        AS TE_POTENCIAL_MOVIL_PARA_EXCLUIR
	,TRN.TE_OPERA_CHINA                         AS TE_OPERA_CHINA                 
	,TRN.TE_MTO_CHINA_USD                       AS TE_MTO_CHINA_USD   
	,TRN.TE_YA_CAMPANADO                        AS TE_YA_CAMPANADO                
	,TRN.TC_MACRO_BANCA                         AS TC_MACRO_BANCA                 
	,TRN.TC_REGIONAL                            AS TC_REGIONAL                    
	,TRN.TE_CTA_CTE                             AS TE_CTA_CTE                     
	,TRN.TC_EJE_CMP                             AS TC_EJE_CMP      
	,TRN.TC_EJE_COMEX							AS TC_EJE_COMEX 
	,TRN.TC_EJE_MESA							AS TC_EJE_MESA  	  	               
	,TRN.TE_IQUIQUE_DESCARTAR                   AS TE_IQUIQUE_DESCARTAR           
	,TRN.TE_EN_LISTA_NEGRA                      AS TE_EN_LISTA_NEGRA        

	,CASE WHEN TRN.TC_TIPO_CMP = CMP.TC_TIPO_CMP AND TRN.TC_ELIMINADO = '' THEN
		RTRIM(TRN.TC_TEXTO1)||
		CASE 
			WHEN TRN.TC_CAUSA_BLINDAR = 'ESTACIONALIDAD POSITIVA' 
					THEN ' Monto a Captar por Estacionalidad USD $'
					|| OREPLACE(OREPLACE(OREPLACE(CAST(CAST(TRN.TE_VALOR AS FORMAT 'ZZZ,ZZZ,ZZ9.99' ) AS VARCHAR(50)) ,',','q'),'.',','),'q','.')
			WHEN TRN.TC_CAUSA_BLINDAR = 'FUGA' 
					THEN ' Monto a Recuperar por Fuga USD $'
					||CAST(TRN.TE_VALOR AS VARCHAR(100))
			ELSE ''
		END||'.'
	  ELSE TRN.TC_TEXTO1 END          			AS TC_TEXTO1                      

	,TRN.TC_TEXTO2                          	AS TC_TEXTO2                      
	,TRN.TC_TEXTO3                          	AS TC_TEXTO3                              
	,TRN.TC_CALIFICACION_SBIF 					AS TC_CALIFICACION_SBIF 	
	,TRN.TF_PERIODO_CALIFICACION 				AS TF_PERIODO_CALIFICACION 	
	,TRN.TD_PI_CLIENTE 							AS TD_PI_CLIENTE 	
	,TRN.TC_CLASIFICACION_SBIF 					AS TC_CLASIFICACION_SBIF 	
    ,TRN.TE_FDR        							AS TE_FDR 
    ,TRN.TE_COS_CLI    							AS TE_COS_CLI 	
	,TRN.TE_FILTROS_RIESGOS                     AS TE_FILTROS_RIESGOS             
	,TRN.TC_PAR_CALIFICACION_SBIF				AS TC_PAR_CALIFICACION_SBIF 	
    ,TRN.TD_PAR_PI_CLIENTE 	       				AS TD_PAR_PI_CLIENTE  	
    ,TRN.TE_PAR_FDR 		       				AS TE_PAR_FDR 		
    ,TRN.TE_PAR_COS_CLI 		       			AS TE_PAR_COS_CLI             
	,TRN.TE_MOLESTO                             AS TE_MOLESTO  
	,TRN.TE_CARGABLE				           	AS TE_CARGABLE    
	,TRN.TC_ELIMINADO             				AS TC_ELIMINADO    	                   
	,TRN.TE_NO_CUMPLE_POTENCIAL	                AS TE_NO_CUMPLE_POTENCIAL         
	,TRN.TE_EN_PLANEAMIENTO                     AS TE_EN_PLANEAMIENTO             
	,TRN.TC_RECOMENDACION_DE_CRUCE              AS TC_RECOMENDACION_DE_CRUCE      
	,TRN.TE_FLG_EXCLUSION                       AS TE_FLG_EXCLUSION               
	,TRN.TC_MOTIVO_EXCLUSION                    AS TC_MOTIVO_EXCLUSION            
	,TRN.TC_CANAL_ASIGNACION                    AS TC_CANAL_ASIGNACION            
FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_LT_01 TRN
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_WSB_TIPO_CMP AS CMP
	ON TRN.TC_TIPO_CMP = CMP.TC_TIPO_CMP
;
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP,TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_LT_02;
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/***********************************************************************
--**		ACTUALIZA CAMPO PE_YA_CAMPANADO								**  
--***********************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES_LIT;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES_LIT
(
	 PE_PERIODO_CMP							INTEGER
	,PC_TIPO_CMP							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PE_CAMPANA_BLINDAR                   	INTEGER
    ,PC_CAUSA_BLINDAR                     	VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,PD_RUT 							 	DECIMAL(8,0)	
	,PE_VALOR							 	BIGINT
	,PE_VALOR_FIJO  						BIGINT
	,PC_FUENTE_POTENCIAL					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_POTENCIAL_MOVIL_PARA_EXCLUIR		BIGINT
	,PE_OPERA_CHINA							INTEGER
	,PE_MTO_CHINA_USD						BIGINT
	,PE_YA_CAMPANADO						INTEGER
	,PC_MACRO_BANCA							VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_REGIONAL    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_CTA_CTE								INTEGER
	,PC_EJE_CMP								VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_EJE_COMEX    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_EJE_MESA    						VARCHAR(40)CHARACTER SET LATIN NOT CASESPECIFIC		
	,PE_IQUIQUE_DESCARTAR					INTEGER	
	,PE_EN_LISTA_NEGRA						INTEGER	
	,PC_TEXTO1 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO2 								VARCHAR(250)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO3 								VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_CALIFICACION_SBIF 					VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,PF_PERIODO_CALIFICACION  				DATE FORMAT	'YYYY-MM-DD'
	,PD_PI_CLIENTE  						DECIMAL (25,10)
	,PC_CLASIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_FDR 								INTEGER
	,PE_COS_CLI         					INTEGER
	,PE_FILTROS_RIESGOS 					INTEGER
	,PC_PAR_CALIFICACION_SBIF  				VARCHAR(200)CHARACTER SET LATIN NOT CASESPECIFIC
	,PD_PAR_PI_CLIENTE 						DECIMAL (25,10)
	,PE_PAR_FDR 							INTEGER
	,PE_PAR_COS_CLI   						INTEGER
	,PE_MOLESTO 							INTEGER
	,PE_CARGABLE							INTEGER
	,PC_ELIMINADO  							VARCHAR(100)CHARACTER SET LATIN NOT CASESPECIFIC	
	,PE_NO_CUMPLE_POTENCIAL                 INTEGER
	,PE_EN_PLANEAMIENTO 					INTEGER
	,PC_RECOMENDACION_DE_CRUCE 				VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC	
	,PE_FLG_EXCLUSION						INTEGER
	,PC_MOTIVO_EXCLUSION					VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_CANAL_ASIGNACION                    VARCHAR(1000)CHARACTER SET LATIN NOT CASESPECIFIC
) UNIQUE PRIMARY INDEX (PE_PERIODO_CMP,PD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 10;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES_LIT
SELECT 
	 TRN.TE_PERIODO_CMP							AS PE_PERIODO_CMP                 
	,TRN.TC_TIPO_CMP                            AS PC_TIPO_CMP                    
	,TRN.TE_CAMPANA_BLINDAR						AS PE_CAMPANA_BLINDAR             
	,TRN.TC_CAUSA_BLINDAR                       AS PC_CAUSA_BLINDAR               
	,TRN.TD_RUT                                 AS PD_RUT                         
	,TRN.TE_VALOR                               AS PE_VALOR                       
	,TRN.TE_VALOR_FIJO                          AS PE_VALOR_FIJO                  
	,TRN.TC_FUENTE_POTENCIAL                    AS PC_FUENTE_POTENCIAL            
	,TRN.TE_POTENCIAL_MOVIL_PARA_EXCLUIR        AS PE_POTENCIAL_MOVIL_PARA_EXCLUIR
	,TRN.TE_OPERA_CHINA                         AS PE_OPERA_CHINA                 
	,TRN.TE_MTO_CHINA_USD                       AS PE_MTO_CHINA_USD   
	,TRN.TE_YA_CAMPANADO                        AS PE_YA_CAMPANADO                
	,TRN.TC_MACRO_BANCA                         AS PC_MACRO_BANCA                 
	,TRN.TC_REGIONAL                            AS PC_REGIONAL                    
	,TRN.TE_CTA_CTE                             AS PE_CTA_CTE                     
	,TRN.TC_EJE_CMP                             AS PC_EJE_CMP      
	,TRN.TC_EJE_COMEX							AS PC_EJE_COMEX 
	,TRN.TC_EJE_MESA							AS PC_EJE_MESA  	  	               
	,TRN.TE_IQUIQUE_DESCARTAR                   AS PE_IQUIQUE_DESCARTAR           
	,TRN.TE_EN_LISTA_NEGRA                      AS PE_EN_LISTA_NEGRA    

	,CASE WHEN 	TRN.TC_TIPO_CMP = ('ACTIVAR') 
			AND TRN.TC_ELIMINADO = ''	 
			AND COALESCE(TRN.TE_VALOR,0) > 0 
			  THEN RTRIM(TRN.TC_TEXTO1)
					||' Monto a Recuperar por Activacion USD $'
					|| OREPLACE(OREPLACE(OREPLACE(CAST(CAST(TRN.TE_VALOR AS FORMAT 'ZZZ,ZZZ,ZZ9.99' ) AS VARCHAR(50)) ,',','q'),'.',','),'q','.')
					||'.'
		  ELSE TRN.TC_TEXTO1 END                AS PC_TEXTO1    

	,CASE WHEN 	TRN.TE_OPERA_CHINA > 0
			AND TRN.TC_ELIMINADO = ''	  
			  THEN 'Cliente opera Comex con China por un monto de : USD $'
				   ||OREPLACE(OREPLACE(OREPLACE(CAST(CAST(TRN.TE_MTO_CHINA_USD AS FORMAT 'ZZZ,ZZZ,ZZ9.99' ) AS VARCHAR(50)) ,',','q'),'.',','),'q','.')
		  ELSE TRN.TC_TEXTO2 END                AS PC_TEXTO2   

	,CASE WHEN 	TRN.TE_CAMPANA_BLINDAR > 0
			AND TRN.TC_ELIMINADO = ''	  
			  THEN 	'Causa Blindaje : '
					||TRN.TC_CAUSA_BLINDAR
		  ELSE TRN.TC_TEXTO3 END                AS PC_TEXTO3   

	,TRN.TC_CALIFICACION_SBIF 					AS PC_CALIFICACION_SBIF 	
	,TRN.TF_PERIODO_CALIFICACION 				AS PF_PERIODO_CALIFICACION 	
	,TRN.TD_PI_CLIENTE 							AS PD_PI_CLIENTE 	
	,TRN.TC_CLASIFICACION_SBIF 					AS PC_CLASIFICACION_SBIF 	
    ,TRN.TE_FDR        							AS PE_FDR 
    ,TRN.TE_COS_CLI    							AS PE_COS_CLI 	
	,TRN.TE_FILTROS_RIESGOS                     AS PE_FILTROS_RIESGOS             
	,TRN.TC_PAR_CALIFICACION_SBIF				AS PC_PAR_CALIFICACION_SBIF 	
    ,TRN.TD_PAR_PI_CLIENTE 	       				AS PD_PAR_PI_CLIENTE  	
    ,TRN.TE_PAR_FDR 		       				AS PE_PAR_FDR 		
    ,TRN.TE_PAR_COS_CLI 		       			AS PE_PAR_COS_CLI             
	,TRN.TE_MOLESTO                             AS PE_MOLESTO  
	,TRN.TE_CARGABLE				           	AS PE_CARGABLE  
	,TRN.TC_ELIMINADO             				AS PC_ELIMINADO                   
	,TRN.TE_NO_CUMPLE_POTENCIAL	                AS PE_NO_CUMPLE_POTENCIAL         
	,TRN.TE_EN_PLANEAMIENTO                     AS PE_EN_PLANEAMIENTO             
	,TRN.TC_RECOMENDACION_DE_CRUCE              AS PC_RECOMENDACION_DE_CRUCE      
	,TRN.TE_FLG_EXCLUSION                       AS PE_FLG_EXCLUSION               
	,TRN.TC_MOTIVO_EXCLUSION                    AS PC_MOTIVO_EXCLUSION            
	,TRN.TC_CANAL_ASIGNACION                    AS PC_CANAL_ASIGNACION            
FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_LT_02 TRN
;
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_PERIODO_CMP,PD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCVD001OB_CAMPANA_MESA_BLINDAR_ACTIVAR_CAPTAR_MES_RN;
.IF ERRORCODE <> 0 THEN .QUIT 12;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 3 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: REGLAS DE NEGOCIOS														  **
--**                                                    				 				  **
--** AUTOR  : FRANCISCO PINOCHET                                               	  		  **
--** EMPRESA: FACTORIT                                   				  				  **
--** FECHA  : 03/2024                                                   				  **
--/*****************************************************************************************
--/*****************************************************************************************
--** MANTNCN: 														                      **
--** AUTOR  : 				                                                           	  **
--** FECHA  : 			                                                  				  **
--/*****************************************************************************************
--/*****************************************************************************************
--**TABLA DE ENTRADA:	MKT_JOURNEYBUILDER_TB.P_CMP_MAE_CLIENTE_EJECUTIVO																  
--**																					  
--**TABLAS TEMPORALES:	
--**					{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_MACRO_BANCA_MX
--**
--** TABLA DE SALIDA:	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES	  	  
--**                                      												  
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/***************************************************************
--** CREA TABLA TEMPORAL MACRO BANCA							**  
--***************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_MACRO_BANCA_MX;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_MACRO_BANCA_MX
(
	TC_MACRO_BANCA		VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC)
PRIMARY INDEX ( TC_MACRO_BANCA )
;
.IF ERRORCODE <> 0 THEN .QUIT 001;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_MACRO_BANCA_MX VALUES ('EMPRESAS');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_MACRO_BANCA_MX VALUES ('GRANDES EMPRESAS');
.IF ERRORCODE <> 0 THEN .QUIT 002;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TC_MACRO_BANCA )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_MACRO_BANCA_MX;
.IF ERRORCODE <> 0 THEN .QUIT 003;

--/***********************************************************************
--**			UPDATE CAMPANABLES COLOCACIONES MX						**  
--***********************************************************************/
UPDATE -- REVISAR LAS NUEVAS REGLAS DE NEGOCIO CARGABLES
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_MACRO_BANCA_MX AS MBC
SET 
	PE_CARGABLE = 1
WHERE
	PC_MACRO_BANCA = MBC.TC_MACRO_BANCA
	AND PE_CTACTE>0 
	AND PE_PO_DEUDA>0 
	AND PE_LCG_VIGENTE>0  
	AND PE_LME_VIGENTE>0  
	AND PE_DISPONIBLE_OK>0 
	AND PE_FILTROS_RIESGOS>0 
	AND NOT (COALESCE(PC_EJE_CAMP,'0') = '0')
	AND PE_CMP_FOGAPE_REACTIVA >= 0  
	AND PE_MOLESTO>=0  
	AND PE_FLG_EXCLUSION=0
	AND PE_IND_CAMPANA = 1
;

.IF ERRORCODE <> 0 THEN .QUIT 004;

--/***********************************************************************
--**			UPDATE CAMPANABLES PROPENSOS MX							**  
--***********************************************************************/

UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_MACRO_BANCA_MX AS MBC
SET 
	PE_CARGABLE = 1
WHERE
	PC_MACRO_BANCA = MBC.TC_MACRO_BANCA
	AND PE_CTACTE>0 
	AND PE_PO_DEUDA>0 
	AND PE_LCG_VIGENTE>0  
	AND PE_LME_VIGENTE>0  
	AND PE_DISPONIBLE_OK>0 
	AND PE_FILTROS_RIESGOS>0 
	AND NOT (COALESCE(PC_EJE_CAMP,'0') = '0')
	AND PE_CMP_FOGAPE_REACTIVA >= 0  
	AND PE_MOLESTO>=0  
	AND PE_FLG_EXCLUSION=0
	AND PE_IND_CAMPANA = 2
;

.IF ERRORCODE <> 0 THEN .QUIT 005;


--/***********************************************************************
--** UPDATE SE PRIORIZO Y SUBE ACUERDO A NUEVAS REGLAS DE NEGOCIOS		**  
--** COLOCACIONES MX
--***********************************************************************/

UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
SET 
	 PE_PRIORIDAD = 1
WHERE 
	PE_CARGABLE = 1 
	AND PE_PRIORIDAD = 99
	AND PE_IND_CAMPANA = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 006;


--/***********************************************************************
--** 						UPDATE PROPENSOS MX							**  
--***********************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
SET 
	 PE_PRIORIDAD = 2
	,PE_MTO_CMP = PE_DISPONIBLE_MX_NEW
WHERE 
	PE_CARGABLE = 1 
	AND PE_PRIORIDAD = 99
	AND PE_IND_CAMPANA = 2
;
.IF ERRORCODE <> 0 THEN .QUIT 007;

--/***********************************************************************
--** 							UPDATE									**  
--***********************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_MACRO_BANCA_MX AS MBC
SET 
	 PE_PRIORIDAD = 3
	,PE_CARGABLE=1
	,PE_MTO_CMP = 0
WHERE
	PC_MACRO_BANCA = MBC.TC_MACRO_BANCA
	AND PE_CARGABLE=0 
	AND PE_PRIORIDAD = 99	
	AND PE_LCG_RENOV_SIN_DISP>0 
	AND PE_CURSE_ULT_3M=0 
	AND PE_FILTROS_RIESGOS>0
	AND PE_CTACTE>0 
	AND PE_FLG_EXCLUSION=0
	AND PE_IND_CAMPANA = 2
;
.IF ERRORCODE <> 0 THEN .QUIT 008;

--/***********************************************************************
--** 							UPDATE									**  
--***********************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
SET 
	PE_CARGABLE = 0
WHERE 
	PE_CARGABLE = 1 
	AND COALESCE(PC_EJE_CAMP,'0') = '0'
;
.IF ERRORCODE <> 0 THEN .QUIT 009;

--/***********************************************************************
--** 		UPDATE CASCADA - COLOCACIONES MX							**  
--***********************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
SET 
	PC_ELIMINADO = 
	CASE
		WHEN COALESCE(PC_MACRO_BANCA,'')  NOT IN ('EMPRESAS', 'GRANDES EMPRESAS')   
				THEN '01.- BANCA NO EM/EG'
		WHEN COALESCE(PE_CTACTE,0) = 0											   
				THEN '02.- SIN CTACTE'
		WHEN COALESCE(PE_PO_DEUDA,0) = 0											   
				THEN '03.- NO ES PO DEUDA'
		WHEN COALESCE(PE_LCG_VIGENTE,0) = 0										   
				THEN '04.- SIN LINEA VIGENTE'
		WHEN COALESCE(PE_DISPONIBLE_OK,0) = 0									   
				THEN '05.- SIN DISP MINIMO MM$70 EG y MM$=30 EM'
		WHEN COALESCE(PE_FILTROS_RIESGOS,0) = 0									   
				THEN '06.- FILTROS RIESGOS'
		WHEN COALESCE(PC_EJE_CAMP,'0') = '0'													
				THEN '11.- SIN EJECUTIVO ESPECIALISTA'
		WHEN COALESCE(PE_CMP_FOGAPE_REACTIVA,0) > 0										
				THEN '12.- EN CMP FOGAPE REACTIVA'
		WHEN COALESCE(PE_MOLESTO,0) = 1													
				THEN '13.- NO MOLESTAR'
		WHEN COALESCE(PE_FLG_EXCLUSION,0) = 1											
				THEN '14.- EXCLUIR : ' || RTRIM(PC_MOTIVO_EXCLUSION)				
		ELSE '15.- NO PERTENECE A PO RECUPERAR COLOCACIONES' -- GENERE ESTO COMO RESPUESTA DESCARTE ANTES LA EXCEPCION DEL RESTO DE LAS OPCIONES "REVISAR"
	 END
WHERE 
	PE_CARGABLE =0
	AND PE_IND_CAMPANA = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 010;


--/***********************************************************************
--** 			UPDATE CASCADA - PROPENSOS MX							**  
--***********************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
SET 
	PC_ELIMINADO = 
	CASE
		WHEN COALESCE(PC_MACRO_BANCA,'')  NOT IN ('EMPRESAS', 'GRANDES EMPRESAS')   
				THEN '01.- BANCA NO EM/EG'
		WHEN COALESCE(PE_CTACTE,0) = 0											   
				THEN '02.- SIN CTACTE'
		WHEN COALESCE(PE_PO_DEUDA,0) = 0											   
				THEN '03.- NO ES PO DEUDA'
		WHEN COALESCE(PE_LCG_VIGENTE,0) = 0										   
				THEN '04.- SIN LINEA VIGENTE'
		WHEN COALESCE(PE_DISPONIBLE_OK,0) = 0									   
				THEN '05.- SIN DISP MINIMO MM$70 EG y MM$=30 EM'
		WHEN COALESCE(PE_FILTROS_RIESGOS,0) = 0									   
				THEN '06.- FILTROS RIESGOS'
		WHEN COALESCE(PC_EJE_CAMP,'0') = '0'													
				THEN '11.- SIN EJECUTIVO ESPECIALISTA'
		WHEN COALESCE(PE_CMP_FOGAPE_REACTIVA,0) > 0										
				THEN '12.- EN CMP FOGAPE REACTIVA'
		WHEN COALESCE(PE_MOLESTO,0) = 1													
				THEN '13.- NO MOLESTAR'
		WHEN COALESCE(PE_FLG_EXCLUSION,0) = 1											
				THEN '14.- EXCLUIR : ' || RTRIM(PC_MOTIVO_EXCLUSION)
		ELSE '' 
	 END
WHERE 
	PE_CARGABLE =0
	AND PE_IND_CAMPANA = 2
;
.IF ERRORCODE <> 0 THEN .QUIT 011;

--/*************************************************************************
--** Se APLICAN FILTROS DE EMPRESAS NO DESEADAS A CARGAR 		 		  **  
--*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_MX;

CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_MX
(
 TD_RUT DECIMAL(8,0)
)PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 012;


INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_MX
SELECT PE_CLI_RUT AS TD_RUT
FROM MKT_JOURNEYBUILDER_TB.P_CMP_MAE_CLIENTE_EJECUTIVO
WHERE PC_NOM_CLI = 'EMPRESAS JUAN YARUR SPA'
;
.IF ERRORCODE <> 0 THEN .QUIT 013;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_MX
SELECT PE_CLI_RUT AS TD_RUT
FROM MKT_JOURNEYBUILDER_TB.P_CMP_MAE_CLIENTE_EJECUTIVO
WHERE PC_NOM_CLI = 'EMPRESAS JY S A'
;
.IF ERRORCODE <> 0 THEN .QUIT 014;

COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_MX;
	
.IF ERRORCODE <> 0 THEN .QUIT 015;


--/***********************************************************************
--** 							UPDATE NO DESEADO					    **  
--***********************************************************************/

UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_MAE_CEJ_FILTRO_EMP_CLIENTE_MX AS FLT

SET 
	 PE_CARGABLE = 0
	,PC_ELIMINADO ='CLIENTE EMPRESA YARUR'
WHERE
	PD_RUT = FLT.TD_RUT
;

.IF ERRORCODE <> 0 THEN .QUIT 016;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES;
.IF ERRORCODE <> 0 THEN .QUIT 017;


SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;

UPDATE - Ejemplo 3 OK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: REGLAS DE NEGOCIOS														  **
--**                                                    				 				  **
--** AUTOR  : FRANCISCO PINOCHET                                               	  		  **
--** EMPRESA: FACTORIT                                   				  				  **
--** FECHA  : 03/2024                                                   				  **
--/*****************************************************************************************
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 08/2024			     	                                                  **
--/*****************************************************************************************
--/*****************************************************************************************
--**TABLA DE ENTRADA:	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CLIENTE_EJECUTIVO		
--**                    {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_HAB      														  
--**																					  
--**TABLAS TEMPORALES:	
--**					{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_REGLAS_01
--**					{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_REGLAS_02
--**					{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_REGLAS_03
--**
--** TABLA DE SALIDA:	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_RN	  	  
--**                                      												  
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL 											  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_REGLAS_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_REGLAS_01
(
	 TD_RUT 							DECIMAL(8,0)
	,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PO_DEUDA						INTEGER
	,TE_CTACTE							INTEGER
	,TE_LCG_VIGENTE						INTEGER
	,TE_LME_VIGENTE 					INTEGER		
	,TE_DISPONIBLE_MX_NEW				BIGINT
	,TC_MACRO_BANCA     				VARCHAR(16) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_LCG_RENOV_SIN_DISP				INTEGER
	,TE_CURSE_ULT_3M					INTEGER
	,TE_FLG_EXCLUSION					INTEGER
	,TC_MOTIVO_EXCLUSION				VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO1							VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2  						VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3  						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_EN_PLANEAMIENTO					INTEGER 			
    ,TC_CALIFICACION_SBIF          		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,TF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,TD_PI_CLIENTE                		DECIMAL(25,10) 			
	,TC_CLASIFICACION_SBIF       		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FDR                      		INTEGER 			
	,TE_COS_CLI                 		INTEGER 			
	,TE_FILTROS_RIESGOS          		INTEGER 			
	,TC_PAR_CALIFICACION_SBIF    		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE           		DECIMAL(25,10) 		
	,TE_PAR_FDR                  		INTEGER 			
	,TE_PAR_COS_CLI             		INTEGER 		
	,TE_MOLESTO               			INTEGER 			
	,TE_CARGABLE						INTEGER
	,TC_ELIMINADO						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DISPONIBLE_OK               	INTEGER
	,TE_ENROLADO_360            		INTEGER
	,TE_HABILITADO_360           		INTEGER
	,TE_ACTIVO_360               		INTEGER
	,TE_ESTADO_MULTIPASS        		INTEGER
	,TE_MANDATO_CCL              		INTEGER
	,TE_SIN_APR                 		INTEGER
	,TE_ART85                     		INTEGER
	,TE_FYP                    			INTEGER
	,TE_READY_CCL              			INTEGER
	,TE_TOTAL_HABILITADORES       		INTEGER
	,TC_FECHA_HAB 						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC 	
	,TE_CMP_MANDATO_CCL					INTEGER
	,TE_CMP_CTO_BEX						INTEGER
	,TE_CMP_MIGRACION               	INTEGER
	,TE_CMP_PROPENSO_MX             	INTEGER
	,TE_CMP_FOGAPE_REACTIVA         	INTEGER
	,TC_EJE_CAMP						VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PRIORIDAD                   	INTEGER
	,TE_MTO_CMP    						BIGINT
	,TE_IND_BANQUERO_SOLO_MX			BYTEINT	
	,TE_IND_CAMPANA						BYTEINT
)PRIMARY INDEX (Td_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 001;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_REGLAS_01
SELECT 
	 PPE.PD_RUT 									AS TD_RUT 					
	,PPE.PC_RECOMENDACION_DE_CRUCE					AS TC_RECOMENDACION_DE_CRUCE
	,PPE.PE_PO_DEUDA 								AS TE_PO_DEUDA
	,PPE.PE_CTACTE 									AS TE_CTACTE
	,PPE.PE_LCG_VIGENTE 							AS TE_LCG_VIGENTE
	,PPE.PE_LME_VIGENTE 							AS TE_LME_VIGENTE	
	,PPE.PE_DISPONIBLE_MX_NEW						AS TE_DISPONIBLE_MX_NEW
	,PPE.PC_MACRO_BANCA 							AS TC_MACRO_BANCA 		
	,PPE.PE_LCG_RENOV_SIN_DISP 						AS TE_LCG_RENOV_SIN_DISP
	,PPE.PE_CURSE_ULT_3M            				AS TE_CURSE_ULT_3M
	,PPE.PE_FLG_EXCLUSION           				AS TE_FLG_EXCLUSION
	,PPE.PC_MOTIVO_EXCLUSION        				AS TC_MOTIVO_EXCLUSION
	,PPE.PC_TEXTO1                  				AS TC_TEXTO1
	,PPE.PC_TEXTO2                  				AS TC_TEXTO2
	,PPE.PC_TEXTO3                  				AS TC_TEXTO3
	,PPE.PE_EN_PLANEAMIENTO         	        	AS TE_EN_PLANEAMIENTO
    ,PPE.PC_CALIFICACION_SBIF        				AS TC_CALIFICACION_SBIF
	,PPE.PF_PERIODO_CALIFICACION	          		AS TF_PERIODO_CALIFICACION 	
	,PPE.PD_PI_CLIENTE            					AS TD_PI_CLIENTE 
	,PPE.PC_CLASIFICACION_SBIF              		AS TC_CLASIFICACION_SBIF 	
	,PPE.PE_FDR                     				AS TE_FDR 
	,PPE.PE_COS_CLI									AS TE_COS_CLI
	,PPE.PE_FILTROS_RIESGOS         				AS TE_FILTROS_RIESGOS
	,PPE.PC_PAR_CALIFICACION_SBIF					AS TC_PAR_CALIFICACION_SBIF
	,PPE.PD_PAR_PI_CLIENTE				            AS TD_PAR_PI_CLIENTE 
	,PPE.PE_PAR_FDR		                         	AS TE_PAR_FDR 
	,PPE.PE_PAR_COS_CLI			                    AS TE_PAR_COS_CLI 	
	,PPE.PE_MOLESTO									AS TE_MOLESTO

	,CASE WHEN
--/***********************************************************************
--**			ACTUALIZA CAMPANABLES COLOCACIONES MX					**  
--***********************************************************************/	
			PPE.PC_MACRO_BANCA IN ('EMPRESAS','GRANDES EMPRESAS')
			AND PPE.PE_CTACTE > 0 
			AND PPE.PE_PO_DEUDA > 0 
			AND PPE.PE_LCG_VIGENTE > 0  
			AND PPE.PE_LME_VIGENTE > 0  
			AND PPE.PE_DISPONIBLE_OK > 0 
			AND PPE.PE_FILTROS_RIESGOS > 0 
			AND NOT (COALESCE(PPE.PC_EJE_CAMP,'0') = '0')
			AND PPE.PE_CMP_FOGAPE_REACTIVA >= 0  
			AND PPE.PE_MOLESTO >= 0  
			AND PPE.PE_FLG_EXCLUSION = 0
			AND PE_IND_CAMPANA = 1	   THEN 1
		  WHEN
--/***********************************************************************
--**			ACTUALIZA CAMPANABLES PROPENSOS MX						**  
--***********************************************************************/		  
			PPE.PC_MACRO_BANCA IN ('EMPRESAS','GRANDES EMPRESAS')
			AND PPE.PE_CTACTE > 0 
			AND PPE.PE_PO_DEUDA > 0 
			AND PPE.PE_LCG_VIGENTE > 0  
			AND PPE.PE_LME_VIGENTE > 0  
			AND PPE.PE_DISPONIBLE_OK > 0 
			AND PPE.PE_FILTROS_RIESGOS > 0 
			AND NOT (COALESCE(PPE.PC_EJE_CAMP,'0') = '0')
			AND PPE.PE_CMP_FOGAPE_REACTIVA >= 0  
			AND PPE.PE_MOLESTO >= 0  
			AND PPE.PE_FLG_EXCLUSION = 0
			AND PPE.PE_IND_CAMPANA = 2 THEN 1
		  ELSE 0  END 								AS TE_CARGABLE

    ,PPE.PC_ELIMINADO	           					AS TC_ELIMINADO	
	,PPE.PE_DISPONIBLE_OK           				AS TE_DISPONIBLE_OK
	,PPE.PE_ENROLADO_360            				AS TE_ENROLADO_360
	,PPE.PE_HABILITADO_360          				AS TE_HABILITADO_360
	,PPE.PE_ACTIVO_360              				AS TE_ACTIVO_360
	,PPE.PE_ESTADO_MULTIPASS        				AS TE_ESTADO_MULTIPASS
	,PPE.PE_MANDATO_CCL             				AS TE_MANDATO_CCL
	,PPE.PE_SIN_APR                 				AS TE_SIN_APR
	,PPE.PE_ART85                   				AS TE_ART85
	,PPE.PE_FYP                     				AS TE_FYP
	,PPE.PE_READY_CCL               				AS TE_READY_CCL
	,PPE.PE_TOTAL_HABILITADORES     				AS TE_TOTAL_HABILITADORES
	,PPE.PC_FECHA_HAB 								AS TC_FECHA_HAB
	,PPE.PE_CMP_MANDATO_CCL         				AS TE_CMP_MANDATO_CCL
	,PPE.PE_CMP_CTO_BEX             				AS TE_CMP_CTO_BEX
	,PPE.PE_CMP_MIGRACION           				AS TE_CMP_MIGRACION
	,PPE.PE_CMP_PROPENSO_MX         				AS TE_CMP_PROPENSO_MX
	,PPE.PE_CMP_FOGAPE_REACTIVA     				AS TE_CMP_FOGAPE_REACTIVA
	,PPE.PC_EJE_CAMP								AS TC_EJE_CAMP
	,PPE.PE_PRIORIDAD 								AS TE_PRIORIDAD
	,PPE.PE_MTO_CMP							 		AS TE_MTO_CMP
	,PPE.PE_IND_BANQUERO_SOLO_MX					AS TE_IND_BANQUERO_SOLO_MX		
	,PPE.PE_IND_CAMPANA 							AS TE_IND_CAMPANA		 		
FROM {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_HAB  PPE
;
.IF ERRORCODE <> 0 THEN .QUIT 002;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_REGLAS_01;
.IF ERRORCODE <> 0 THEN .QUIT 003;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL 											  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_REGLAS_02;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_REGLAS_02
(
	 TD_RUT 							DECIMAL(8,0)
	,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PO_DEUDA						INTEGER
	,TE_CTACTE							INTEGER
	,TE_LCG_VIGENTE						INTEGER
	,TE_LME_VIGENTE 					INTEGER		
	,TE_DISPONIBLE_MX_NEW				BIGINT
	,TC_MACRO_BANCA     				VARCHAR(16) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_LCG_RENOV_SIN_DISP				INTEGER
	,TE_CURSE_ULT_3M					INTEGER
	,TE_FLG_EXCLUSION					INTEGER
	,TC_MOTIVO_EXCLUSION				VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO1							VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2  						VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3  						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_EN_PLANEAMIENTO					INTEGER 			
    ,TC_CALIFICACION_SBIF          		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,TF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,TD_PI_CLIENTE                		DECIMAL(25,10) 			
	,TC_CLASIFICACION_SBIF       		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FDR                      		INTEGER 			
	,TE_COS_CLI                 		INTEGER 			
	,TE_FILTROS_RIESGOS          		INTEGER 			
	,TC_PAR_CALIFICACION_SBIF    		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE           		DECIMAL(25,10) 		
	,TE_PAR_FDR                  		INTEGER 			
	,TE_PAR_COS_CLI             		INTEGER 		
	,TE_MOLESTO               			INTEGER 			
	,TE_CARGABLE						INTEGER
	,TC_ELIMINADO						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DISPONIBLE_OK               	INTEGER
	,TE_ENROLADO_360            		INTEGER
	,TE_HABILITADO_360           		INTEGER
	,TE_ACTIVO_360               		INTEGER
	,TE_ESTADO_MULTIPASS        		INTEGER
	,TE_MANDATO_CCL              		INTEGER
	,TE_SIN_APR                 		INTEGER
	,TE_ART85                     		INTEGER
	,TE_FYP                    			INTEGER
	,TE_READY_CCL              			INTEGER
	,TE_TOTAL_HABILITADORES       		INTEGER
	,TC_FECHA_HAB 						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC 	
	,TE_CMP_MANDATO_CCL					INTEGER
	,TE_CMP_CTO_BEX						INTEGER
	,TE_CMP_MIGRACION               	INTEGER
	,TE_CMP_PROPENSO_MX             	INTEGER
	,TE_CMP_FOGAPE_REACTIVA         	INTEGER
	,TC_EJE_CAMP						VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PRIORIDAD                   	INTEGER
	,TE_MTO_CMP    						BIGINT
	,TE_IND_BANQUERO_SOLO_MX			BYTEINT	
	,TE_IND_CAMPANA						BYTEINT
)PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 004;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_REGLAS_02
SELECT 
	 PPE.TD_RUT 									AS TD_RUT 					
	,PPE.TC_RECOMENDACION_DE_CRUCE					AS TC_RECOMENDACION_DE_CRUCE
	,PPE.TE_PO_DEUDA 								AS TE_PO_DEUDA
	,PPE.TE_CTACTE 									AS TE_CTACTE
	,PPE.TE_LCG_VIGENTE 							AS TE_LCG_VIGENTE
	,PPE.TE_LME_VIGENTE 							AS TE_LME_VIGENTE	
	,PPE.TE_DISPONIBLE_MX_NEW						AS TE_DISPONIBLE_MX_NEW
	,PPE.TC_MACRO_BANCA 							AS TC_MACRO_BANCA 		
	,PPE.TE_LCG_RENOV_SIN_DISP 						AS TE_LCG_RENOV_SIN_DISP
	,PPE.TE_CURSE_ULT_3M            				AS TE_CURSE_ULT_3M
	,PPE.TE_FLG_EXCLUSION           				AS TE_FLG_EXCLUSION
	,PPE.TC_MOTIVO_EXCLUSION        				AS TC_MOTIVO_EXCLUSION
	,PPE.TC_TEXTO1                  				AS TC_TEXTO1
	,PPE.TC_TEXTO2                  				AS TC_TEXTO2
	,PPE.TC_TEXTO3                  				AS TC_TEXTO3
	,PPE.TE_EN_PLANEAMIENTO         	        	AS TE_EN_PLANEAMIENTO
    ,PPE.TC_CALIFICACION_SBIF        				AS TC_CALIFICACION_SBIF
	,PPE.TF_PERIODO_CALIFICACION	          		AS TF_PERIODO_CALIFICACION 	
	,PPE.TD_PI_CLIENTE            					AS TD_PI_CLIENTE 
	,PPE.TC_CLASIFICACION_SBIF              		AS TC_CLASIFICACION_SBIF 	
	,PPE.TE_FDR                     				AS TE_FDR 
	,PPE.TE_COS_CLI									AS TE_COS_CLI
	,PPE.TE_FILTROS_RIESGOS         				AS TE_FILTROS_RIESGOS
	,PPE.TC_PAR_CALIFICACION_SBIF					AS TC_PAR_CALIFICACION_SBIF
	,PPE.TD_PAR_PI_CLIENTE				            AS TD_PAR_PI_CLIENTE 
	,PPE.TE_PAR_FDR		                         	AS TE_PAR_FDR 
	,PPE.TE_PAR_COS_CLI			                    AS TE_PAR_COS_CLI 	
	,PPE.TE_MOLESTO									AS TE_MOLESTO
	,PPE.TE_CARGABLE                				AS TE_CARGABLE
    ,PPE.TC_ELIMINADO	           					AS TC_ELIMINADO	
	,PPE.TE_DISPONIBLE_OK           				AS TE_DISPONIBLE_OK
	,PPE.TE_ENROLADO_360            				AS TE_ENROLADO_360
	,PPE.TE_HABILITADO_360          				AS TE_HABILITADO_360
	,PPE.TE_ACTIVO_360              				AS TE_ACTIVO_360
	,PPE.TE_ESTADO_MULTIPASS        				AS TE_ESTADO_MULTIPASS
	,PPE.TE_MANDATO_CCL             				AS TE_MANDATO_CCL
	,PPE.TE_SIN_APR                 				AS TE_SIN_APR
	,PPE.TE_ART85                   				AS TE_ART85
	,PPE.TE_FYP                     				AS TE_FYP
	,PPE.TE_READY_CCL               				AS TE_READY_CCL
	,PPE.TE_TOTAL_HABILITADORES     				AS TE_TOTAL_HABILITADORES
	,PPE.TC_FECHA_HAB 								AS TC_FECHA_HAB
	,PPE.TE_CMP_MANDATO_CCL         				AS TE_CMP_MANDATO_CCL
	,PPE.TE_CMP_CTO_BEX             				AS TE_CMP_CTO_BEX
	,PPE.TE_CMP_MIGRACION           				AS TE_CMP_MIGRACION
	,PPE.TE_CMP_PROPENSO_MX         				AS TE_CMP_PROPENSO_MX
	,PPE.TE_CMP_FOGAPE_REACTIVA     				AS TE_CMP_FOGAPE_REACTIVA
	,PPE.TC_EJE_CAMP								AS TC_EJE_CAMP

--/***********************************************************************
--** ACTUALIZACON: SE PRIORIZO Y SUBE ACUERDO A NUEVAS REGLAS DE NEGOCIOS	
--** COLOCACIONES MX
--***********************************************************************/
	,CASE WHEN 
			PPE.TE_CARGABLE = 1 
			AND PPE.TE_PRIORIDAD = 99
			AND PPE.TE_IND_CAMPANA = 1  THEN 1
		  WHEN
			PPE.TE_CARGABLE = 1 
			AND PPE.TE_PRIORIDAD = 99
			AND PPE.TE_IND_CAMPANA = 2  THEN 2		  
		  ELSE PPE.TE_PRIORIDAD END					AS TE_PRIORIDAD

	,CASE WHEN
			PPE.TE_CARGABLE = 1 
			AND PPE.TE_PRIORIDAD = 99
			AND PPE.TE_IND_CAMPANA = 2  THEN PPE.TE_DISPONIBLE_MX_NEW
		   ELSE PPE.TE_MTO_CMP END	 				AS TE_MTO_CMP

	,PPE.TE_IND_BANQUERO_SOLO_MX					AS TE_IND_BANQUERO_SOLO_MX
	,PPE.TE_IND_CAMPANA 							AS TE_IND_CAMPANA		 		
FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_REGLAS_01  PPE
;
.IF ERRORCODE <> 0 THEN .QUIT 005;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_REGLAS_02;
.IF ERRORCODE <> 0 THEN .QUIT 006;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL 											  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_REGLAS_03;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_REGLAS_03
(
	 TD_RUT 							DECIMAL(8,0)
	,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PO_DEUDA						INTEGER
	,TE_CTACTE							INTEGER
	,TE_LCG_VIGENTE						INTEGER
	,TE_LME_VIGENTE 					INTEGER		
	,TE_DISPONIBLE_MX_NEW				BIGINT
	,TC_MACRO_BANCA     				VARCHAR(16) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_LCG_RENOV_SIN_DISP				INTEGER
	,TE_CURSE_ULT_3M					INTEGER
	,TE_FLG_EXCLUSION					INTEGER
	,TC_MOTIVO_EXCLUSION				VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO1							VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2  						VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3  						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_EN_PLANEAMIENTO					INTEGER 			
    ,TC_CALIFICACION_SBIF          		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,TF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,TD_PI_CLIENTE                		DECIMAL(25,10) 			
	,TC_CLASIFICACION_SBIF       		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FDR                      		INTEGER 			
	,TE_COS_CLI                 		INTEGER 			
	,TE_FILTROS_RIESGOS          		INTEGER 			
	,TC_PAR_CALIFICACION_SBIF    		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE           		DECIMAL(25,10) 		
	,TE_PAR_FDR                  		INTEGER 			
	,TE_PAR_COS_CLI             		INTEGER 		
	,TE_MOLESTO               			INTEGER 			
	,TE_CARGABLE						INTEGER
	,TC_ELIMINADO						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DISPONIBLE_OK               	INTEGER
	,TE_ENROLADO_360            		INTEGER
	,TE_HABILITADO_360           		INTEGER
	,TE_ACTIVO_360               		INTEGER
	,TE_ESTADO_MULTIPASS        		INTEGER
	,TE_MANDATO_CCL              		INTEGER
	,TE_SIN_APR                 		INTEGER
	,TE_ART85                     		INTEGER
	,TE_FYP                    			INTEGER
	,TE_READY_CCL              			INTEGER
	,TE_TOTAL_HABILITADORES       		INTEGER
	,TC_FECHA_HAB 						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC 	
	,TE_CMP_MANDATO_CCL					INTEGER
	,TE_CMP_CTO_BEX						INTEGER
	,TE_CMP_MIGRACION               	INTEGER
	,TE_CMP_PROPENSO_MX             	INTEGER
	,TE_CMP_FOGAPE_REACTIVA         	INTEGER
	,TC_EJE_CAMP						VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PRIORIDAD                   	INTEGER
	,TE_MTO_CMP    						BIGINT
	,TE_IND_BANQUERO_SOLO_MX			BYTEINT	
	,TE_IND_CAMPANA						BYTEINT
)PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 007;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_REGLAS_03
SELECT 
	 PPE.TD_RUT 									AS TD_RUT 					
	,PPE.TC_RECOMENDACION_DE_CRUCE					AS TC_RECOMENDACION_DE_CRUCE
	,PPE.TE_PO_DEUDA 								AS TE_PO_DEUDA
	,PPE.TE_CTACTE 									AS TE_CTACTE
	,PPE.TE_LCG_VIGENTE 							AS TE_LCG_VIGENTE
	,PPE.TE_LME_VIGENTE 							AS TE_LME_VIGENTE	
	,PPE.TE_DISPONIBLE_MX_NEW						AS TE_DISPONIBLE_MX_NEW
	,PPE.TC_MACRO_BANCA 							AS TC_MACRO_BANCA 		
	,PPE.TE_LCG_RENOV_SIN_DISP 						AS TE_LCG_RENOV_SIN_DISP
	,PPE.TE_CURSE_ULT_3M            				AS TE_CURSE_ULT_3M
	,PPE.TE_FLG_EXCLUSION           				AS TE_FLG_EXCLUSION
	,PPE.TC_MOTIVO_EXCLUSION        				AS TC_MOTIVO_EXCLUSION
	,PPE.TC_TEXTO1                  				AS TC_TEXTO1
	,PPE.TC_TEXTO2                  				AS TC_TEXTO2
	,PPE.TC_TEXTO3                  				AS TC_TEXTO3
	,PPE.TE_EN_PLANEAMIENTO         	        	AS TE_EN_PLANEAMIENTO
    ,PPE.TC_CALIFICACION_SBIF        				AS TC_CALIFICACION_SBIF
	,PPE.TF_PERIODO_CALIFICACION	          		AS TF_PERIODO_CALIFICACION 	
	,PPE.TD_PI_CLIENTE            					AS TD_PI_CLIENTE 
	,PPE.TC_CLASIFICACION_SBIF              		AS TC_CLASIFICACION_SBIF 	
	,PPE.TE_FDR                     				AS TE_FDR 
	,PPE.TE_COS_CLI									AS TE_COS_CLI
	,PPE.TE_FILTROS_RIESGOS         				AS TE_FILTROS_RIESGOS
	,PPE.TC_PAR_CALIFICACION_SBIF					AS TC_PAR_CALIFICACION_SBIF
	,PPE.TD_PAR_PI_CLIENTE				            AS TD_PAR_PI_CLIENTE 
	,PPE.TE_PAR_FDR		                         	AS TE_PAR_FDR 
	,PPE.TE_PAR_COS_CLI			                    AS TE_PAR_COS_CLI 	
	,PPE.TE_MOLESTO									AS TE_MOLESTO

	,CASE WHEN
			PPE.TE_CARGABLE = 1 
			AND COALESCE(PPE.TC_EJE_CAMP,'0') = '0' THEN 0
		  WHEN
			PPE.TC_MACRO_BANCA IN ('EMPRESAS','GRANDES EMPRESAS')
			AND PPE.TE_CARGABLE = 0 
			AND PPE.TE_PRIORIDAD = 99	
			AND PPE.TE_LCG_RENOV_SIN_DISP > 0 
			AND PPE.TE_CURSE_ULT_3M = 0 
			AND PPE.TE_FILTROS_RIESGOS > 0
			AND PPE.TE_CTACTE > 0 
			AND PPE.TE_FLG_EXCLUSION = 0
			AND PPE.TE_IND_CAMPANA = 2	THEN 1
		  ELSE PPE.TE_CARGABLE END     				AS TE_CARGABLE	  

    ,PPE.TC_ELIMINADO	           					AS TC_ELIMINADO	
	,PPE.TE_DISPONIBLE_OK           				AS TE_DISPONIBLE_OK
	,PPE.TE_ENROLADO_360            				AS TE_ENROLADO_360
	,PPE.TE_HABILITADO_360          				AS TE_HABILITADO_360
	,PPE.TE_ACTIVO_360              				AS TE_ACTIVO_360
	,PPE.TE_ESTADO_MULTIPASS        				AS TE_ESTADO_MULTIPASS
	,PPE.TE_MANDATO_CCL             				AS TE_MANDATO_CCL
	,PPE.TE_SIN_APR                 				AS TE_SIN_APR
	,PPE.TE_ART85                   				AS TE_ART85
	,PPE.TE_FYP                     				AS TE_FYP
	,PPE.TE_READY_CCL               				AS TE_READY_CCL
	,PPE.TE_TOTAL_HABILITADORES     				AS TE_TOTAL_HABILITADORES
	,PPE.TC_FECHA_HAB 								AS TC_FECHA_HAB
	,PPE.TE_CMP_MANDATO_CCL         				AS TE_CMP_MANDATO_CCL
	,PPE.TE_CMP_CTO_BEX             				AS TE_CMP_CTO_BEX
	,PPE.TE_CMP_MIGRACION           				AS TE_CMP_MIGRACION
	,PPE.TE_CMP_PROPENSO_MX         				AS TE_CMP_PROPENSO_MX
	,PPE.TE_CMP_FOGAPE_REACTIVA     				AS TE_CMP_FOGAPE_REACTIVA
	,PPE.TC_EJE_CAMP								AS TC_EJE_CAMP

	,CASE WHEN
			PPE.TC_MACRO_BANCA IN ('EMPRESAS','GRANDES EMPRESAS')
			AND PPE.TE_CARGABLE = 0 
			AND PPE.TE_PRIORIDAD = 99	
			AND PPE.TE_LCG_RENOV_SIN_DISP > 0 
			AND PPE.TE_CURSE_ULT_3M = 0 
			AND PPE.TE_FILTROS_RIESGOS > 0
			AND PPE.TE_CTACTE > 0 
			AND PPE.TE_FLG_EXCLUSION = 0
			AND PPE.TE_IND_CAMPANA = 2	THEN 3
		  ELSE PPE.TE_PRIORIDAD END					AS TE_PRIORIDAD
	,CASE WHEN
			PPE.TC_MACRO_BANCA IN ('EMPRESAS','GRANDES EMPRESAS')
			AND PPE.TE_CARGABLE = 0 
			AND PPE.TE_PRIORIDAD = 99	
			AND PPE.TE_LCG_RENOV_SIN_DISP > 0 
			AND PPE.TE_CURSE_ULT_3M = 0 
			AND PPE.TE_FILTROS_RIESGOS > 0
			AND PPE.TE_CTACTE > 0 
			AND PPE.TE_FLG_EXCLUSION = 0
			AND PPE.TE_IND_CAMPANA = 2	THEN 0
		  ELSE PPE.TE_MTO_CMP END					AS TE_MTO_CMP

	,PPE.TE_IND_BANQUERO_SOLO_MX					AS TE_IND_BANQUERO_SOLO_MX
	,PPE.TE_IND_CAMPANA 							AS TE_IND_CAMPANA		 		
FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_REGLAS_02 PPE
;
.IF ERRORCODE <> 0 THEN .QUIT 008;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( Td_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_REGLAS_03;
.IF ERRORCODE <> 0 THEN .QUIT 009;

/***********************************************************************************************
    ELIMINA EN TABLA DE PROPENSO
************************************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_RN;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_RN
(
	 PD_RUT 							DECIMAL(8,0)
	,PC_RECOMENDACION_DE_CRUCE			VARCHAR(255) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PO_DEUDA						INTEGER
	,PE_CTACTE							INTEGER
	,PE_LCG_VIGENTE						INTEGER
	,PE_LME_VIGENTE 					INTEGER		
	,PE_DISPONIBLE_MX_NEW				BIGINT
	,PC_MACRO_BANCA     				VARCHAR(16) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_LCG_RENOV_SIN_DISP				INTEGER
	,PE_CURSE_ULT_3M					INTEGER
	,PE_FLG_EXCLUSION					INTEGER
	,PC_MOTIVO_EXCLUSION				VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO1							VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO2  						VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO3  						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_EN_PLANEAMIENTO					INTEGER 			
    ,PC_CALIFICACION_SBIF          		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,PF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,PD_PI_CLIENTE                		DECIMAL(25,10) 			
	,PC_CLASIFICACION_SBIF       		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,PE_FDR                      		INTEGER 			
	,PE_COS_CLI                 		INTEGER 			
	,PE_FILTROS_RIESGOS          		INTEGER 			
	,PC_PAR_CALIFICACION_SBIF    		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PD_PAR_PI_CLIENTE           		DECIMAL(25,10) 		
	,PE_PAR_FDR                  		INTEGER 			
	,PE_PAR_COS_CLI             		INTEGER 		
	,PE_MOLESTO               			INTEGER 			
	,PE_CARGABLE						INTEGER
	,PC_ELIMINADO						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_DISPONIBLE_OK               	INTEGER
	,PE_ENROLADO_360            		INTEGER
	,PE_HABILITADO_360           		INTEGER
	,PE_ACTIVO_360               		INTEGER
	,PE_ESTADO_MULTIPASS        		INTEGER
	,PE_MANDATO_CCL              		INTEGER
	,PE_SIN_APR                 		INTEGER
	,PE_ART85                     		INTEGER
	,PE_FYP                    			INTEGER
	,PE_READY_CCL              			INTEGER
	,PE_TOTAL_HABILITADORES       		INTEGER
	,PC_FECHA_HAB 						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC 	
	,PE_CMP_MANDATO_CCL					INTEGER
	,PE_CMP_CTO_BEX						INTEGER
	,PE_CMP_MIGRACION               	INTEGER
	,PE_CMP_PROPENSO_MX             	INTEGER
	,PE_CMP_FOGAPE_REACTIVA         	INTEGER
	,PC_EJE_CAMP						VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PRIORIDAD                   	INTEGER
	,PE_MTO_CMP    						BIGINT
	,PE_IND_BANQUERO_SOLO_MX			BYTEINT	
	,PE_IND_CAMPANA						BYTEINT
)PRIMARY INDEX (PD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 010;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_RN
SELECT 
	 PPE.TD_RUT 									AS PD_RUT 					
	,PPE.TC_RECOMENDACION_DE_CRUCE					AS PC_RECOMENDACION_DE_CRUCE
	,PPE.TE_PO_DEUDA 								AS PE_PO_DEUDA
	,PPE.TE_CTACTE 									AS PE_CTACTE
	,PPE.TE_LCG_VIGENTE 							AS PE_LCG_VIGENTE
	,PPE.TE_LME_VIGENTE 							AS PE_LME_VIGENTE	
	,PPE.TE_DISPONIBLE_MX_NEW						AS PE_DISPONIBLE_MX_NEW
	,PPE.TC_MACRO_BANCA 							AS PC_MACRO_BANCA 		
	,PPE.TE_LCG_RENOV_SIN_DISP 						AS PE_LCG_RENOV_SIN_DISP
	,PPE.TE_CURSE_ULT_3M            				AS PE_CURSE_ULT_3M
	,PPE.TE_FLG_EXCLUSION           				AS PE_FLG_EXCLUSION
	,PPE.TC_MOTIVO_EXCLUSION        				AS PC_MOTIVO_EXCLUSION
	,PPE.TC_TEXTO1                  				AS PC_TEXTO1
	,PPE.TC_TEXTO2                  				AS PC_TEXTO2
	,PPE.TC_TEXTO3                  				AS PC_TEXTO3
	,PPE.TE_EN_PLANEAMIENTO         	        	AS PE_EN_PLANEAMIENTO
    ,PPE.TC_CALIFICACION_SBIF        				AS PC_CALIFICACION_SBIF
	,PPE.TF_PERIODO_CALIFICACION	          		AS PF_PERIODO_CALIFICACION 	
	,PPE.TD_PI_CLIENTE            					AS PD_PI_CLIENTE 
	,PPE.TC_CLASIFICACION_SBIF              		AS PC_CLASIFICACION_SBIF 	
	,PPE.TE_FDR                     				AS PE_FDR 
	,PPE.TE_COS_CLI									AS PE_COS_CLI
	,PPE.TE_FILTROS_RIESGOS         				AS PE_FILTROS_RIESGOS
	,PPE.TC_PAR_CALIFICACION_SBIF					AS PC_PAR_CALIFICACION_SBIF
	,PPE.TD_PAR_PI_CLIENTE				            AS PD_PAR_PI_CLIENTE 
	,PPE.TE_PAR_FDR		                         	AS PE_PAR_FDR 
	,PPE.TE_PAR_COS_CLI			                    AS PE_PAR_COS_CLI 	
	,PPE.TE_MOLESTO									AS PE_MOLESTO

	,CASE  WHEN
		CLI.IE_CLI_RUT IS NOT NULL THEN 0
		ELSE PPE.TE_CARGABLE END 					AS PE_CARGABLE

    ,CASE WHEN            					
	   CLI.IE_CLI_RUT IS NOT NULL THEN 'CLIENTE EMPRESA YARUR'
	  WHEN
	   PPE.TE_CARGABLE = 0
	   AND PPE.TE_IND_CAMPANA = 1 THEN
		CASE
			WHEN COALESCE(PPE.TC_MACRO_BANCA,'')  NOT IN ('EMPRESAS', 'GRANDES EMPRESAS')   
					THEN '01.- BANCA NO EM/EG'
			WHEN COALESCE(PPE.TE_CTACTE,0) = 0											   
					THEN '02.- SIN CTACTE'
			WHEN COALESCE(PPE.TE_PO_DEUDA,0) = 0											   
					THEN '03.- NO ES PO DEUDA'
			WHEN COALESCE(PPE.TE_LCG_VIGENTE,0) = 0										   
					THEN '04.- SIN LINEA VIGENTE'
			WHEN COALESCE(PPE.TE_DISPONIBLE_OK,0) = 0									   
					THEN '05.- SIN DISP MINIMO MM$70 EG y MM$=30 EM'
			WHEN COALESCE(PPE.TE_FILTROS_RIESGOS,0) = 0									   
					THEN '06.- FILTROS RIESGOS'
			WHEN COALESCE(PPE.TC_EJE_CAMP,'0') = '0'													
					THEN '11.- SIN EJECUTIVO ESPECIALISTA'
			WHEN COALESCE(PPE.TE_CMP_FOGAPE_REACTIVA,0) > 0										
					THEN '12.- EN CMP FOGAPE REACTIVA'
			WHEN COALESCE(PPE.TE_MOLESTO,0) = 1													
					THEN '13.- NO MOLESTAR'
			WHEN COALESCE(PPE.TE_FLG_EXCLUSION,0) = 1											
					THEN '14.- EXCLUIR : ' || RTRIM(PPE.TC_MOTIVO_EXCLUSION)				
			ELSE '15.- NO PERTENECE A PO RECUPERAR COLOCACIONES' -- GENERE ESTO COMO RESPUESTA DESCARTE ANTES LA EXCEPCION DEL RESTO DE LAS OPCIONES "REVISAR"
		END
	WHEN 
	 PPE.TE_CARGABLE = 0
	 AND PPE.TE_IND_CAMPANA = 2 THEN 
	  CASE
		WHEN COALESCE(PPE.TC_MACRO_BANCA,'')  NOT IN ('EMPRESAS', 'GRANDES EMPRESAS')   
				THEN '01.- BANCA NO EM/EG'
		WHEN COALESCE(PPE.TE_CTACTE,0) = 0											   
				THEN '02.- SIN CTACTE'
		WHEN COALESCE(PPE.TE_PO_DEUDA,0) = 0											   
				THEN '03.- NO ES PO DEUDA'
		WHEN COALESCE(PPE.TE_LCG_VIGENTE,0) = 0										   
				THEN '04.- SIN LINEA VIGENTE'
		WHEN COALESCE(PPE.TE_DISPONIBLE_OK,0) = 0									   
				THEN '05.- SIN DISP MINIMO MM$70 EG y MM$=30 EM'
		WHEN COALESCE(PPE.TE_FILTROS_RIESGOS,0) = 0									   
				THEN '06.- FILTROS RIESGOS'
		WHEN COALESCE(PPE.TC_EJE_CAMP,'0') = '0'													
				THEN '11.- SIN EJECUTIVO ESPECIALISTA'
		WHEN COALESCE(PPE.TE_CMP_FOGAPE_REACTIVA,0) > 0										
				THEN '12.- EN CMP FOGAPE REACTIVA'
		WHEN COALESCE(PPE.TE_MOLESTO,0) = 1													
				THEN '13.- NO MOLESTAR'
		WHEN COALESCE(PPE.TE_FLG_EXCLUSION,0) = 1											
				THEN '14.- EXCLUIR : ' || RTRIM(PPE.TC_MOTIVO_EXCLUSION)
		ELSE '' 
	  END
	  ELSE PPE.TC_ELIMINADO
	 END 
													AS PC_ELIMINADO	

	,PPE.TE_DISPONIBLE_OK           				AS PE_DISPONIBLE_OK
	,PPE.TE_ENROLADO_360            				AS PE_ENROLADO_360
	,PPE.TE_HABILITADO_360          				AS PE_HABILITADO_360
	,PPE.TE_ACTIVO_360              				AS PE_ACTIVO_360
	,PPE.TE_ESTADO_MULTIPASS        				AS PE_ESTADO_MULTIPASS
	,PPE.TE_MANDATO_CCL             				AS PE_MANDATO_CCL
	,PPE.TE_SIN_APR                 				AS PE_SIN_APR
	,PPE.TE_ART85                   				AS PE_ART85
	,PPE.TE_FYP                     				AS PE_FYP
	,PPE.TE_READY_CCL               				AS PE_READY_CCL
	,PPE.TE_TOTAL_HABILITADORES     				AS PE_TOTAL_HABILITADORES
	,PPE.TC_FECHA_HAB 								AS PC_FECHA_HAB
	,PPE.TE_CMP_MANDATO_CCL         				AS PE_CMP_MANDATO_CCL
	,PPE.TE_CMP_CTO_BEX             				AS PE_CMP_CTO_BEX
	,PPE.TE_CMP_MIGRACION           				AS PE_CMP_MIGRACION
	,PPE.TE_CMP_PROPENSO_MX         				AS PE_CMP_PROPENSO_MX
	,PPE.TE_CMP_FOGAPE_REACTIVA     				AS PE_CMP_FOGAPE_REACTIVA
	,PPE.TC_EJE_CAMP								AS PC_EJE_CAMP
	,PPE.TE_PRIORIDAD 								AS PE_PRIORIDAD
	,PPE.TE_MTO_CMP							 		AS PE_MTO_CMP
	,PPE.TE_IND_BANQUERO_SOLO_MX					AS PE_IND_BANQUERO_SOLO_MX		
	,PPE.TE_IND_CAMPANA 							AS PE_IND_CAMPANA		 		
FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_REGLAS_03  PPE
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CLIENTE_EJECUTIVO CLI
		ON PPE.TD_RUT = CLI.IE_CLI_RUT AND 
		   CLI.IC_NOM_CLI IN ('EMPRESAS JUAN YARUR SPA', 'EMPRESAS JY S A')
;
.IF ERRORCODE <> 0 THEN .QUIT 011;		

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( Pd_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_RN;
.IF ERRORCODE <> 0 THEN .QUIT 012;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;

UPDATE - Ejemplo 4 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: LITERAL																	  **
--**                                                    				 				  **
--** AUTOR  : FRANCISCO PINOCHET                                               	  		  **
--** EMPRESA: FACTORIT                                   				  				  **
--** FECHA  : 03/2024                                                   				  **
--/*****************************************************************************************
--/*****************************************************************************************
--** MANTNCN: 														                      **
--** AUTOR  : 				                                                           	  **
--** FECHA  : 			                                                  				  **
--/*****************************************************************************************
--/*****************************************************************************************
--**TABLA DE ENTRADA:	                                            					  
--**					MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS
--**					EDM_DMSEGTO_VW.IN_SEGUIMIENTO_EMPRESA
--**				
--**TABLAS TEMPORALES:	
--**					{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_RETENER_COLO_MX_SIN_CURSE
--**																					  
--** TABLA DE SALIDA:	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES	  	  
--**                                      												  
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/***********************************************************************
--** 						UPDATE LITERALES							**  
--***********************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
SET 
	 PC_TEXTO1 = ''
	,PC_TEXTO2 = ''
	,PC_TEXTO3 = ''
;
.IF ERRORCODE <> 0 THEN .QUIT 001;


--/*******************************************************************************************************************************
--** clientes aceptados, agendados o sin gestion de la campaña Recuperar colocaciones MX que no han tenido curse, el mes anterior 
--********************************************************************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_RETENER_COLO_MX_SIN_CURSE;

CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_RETENER_COLO_MX_SIN_CURSE
(
 Td_Rut DECIMAL(8,0)
,Tc_Literal_Gestion VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
,Tc_Gestion VARCHAR(5) CHARACTER SET LATIN NOT CASESPECIFIC
,Te_Ind_No_Gestion BYTEINT
)
PRIMARY INDEX ( Td_Rut );

.IF ERRORCODE <> 0 THEN .QUIT 002;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_RETENER_COLO_MX_SIN_CURSE
 SELECT
  SEG.RUT AS Td_Rut
 ,COALESCE(SEG.LITERAL_GESTION,'Sin Descripcion') AS Tc_Literal_Gestion
 ,SEG.Gestion AS Tc_Gestion
 ,case when Tc_Gestion NOT IN ('RCH','NCA') then 0 else 1 end Te_Ind_No_Gestion
FROM EDM_DMSEGTO_vw.in_Seguimiento_empresa SEG
LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS PAR
ON 1 = 1
WHERE SEG.MES_INICIATIVA >= SE_PERIODO_REF
AND SEG.CANAL_CAMPANA = 'Ejecutivo_Comex'
AND SEG.CAMPANA = 'Recuperar Colocaciones MX'
AND SEG.INH = 0
AND Te_Ind_No_Gestion = 0
AND SEG.VENTA = 0
QUALIFY ROW_NUMBER() OVER (PARTITION BY RUT ORDER BY Td_Rut, SEG.FECHA_GESTION DESC) = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 003;

COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_RETENER_COLO_MX_SIN_CURSE;
.IF ERRORCODE <> 0 THEN .QUIT 004;

--/***********************************************************************
--** 			DESCRIPCION TEXTO 1, PARA PROPENSION MX					**  
--***********************************************************************/

--/***********************************************************************************************************************************
--** 			texto 1								
--** Todos los clientes que tengan el indicador de banquero, solo pueden operar con banquero idependiente de cualquier otra condicion
--** Los que no tenga esa condicion el texto dira que tiene que recuperar colocaciones
--** Por ultimo se revisa si alguno de esto excepto a los que operan con banquero esta sin curce del mes anterior
--************************************************************************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
SET 
	PC_TEXTO1 = CASE WHEN PE_IND_BANQUERO_SOLO_MX = 1 THEN 'Recuperar Colocaciones MX de clientes que aumentan o mantienen sus ODP' || '. Opera solo MX según Banquero'
	                 ELSE 'Recuperar Colocaciones MX de clientes que aumentan o mantienen sus ODP' END 
WHERE PE_IND_CAMPANA = 1
AND PE_PRIORIDAD = 1 
;

.IF ERRORCODE <> 0 THEN .QUIT 005;


UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_RETENER_COLO_MX_SIN_CURSE CUR
SET 
	PC_TEXTO1 = CASE WHEN PE_IND_BANQUERO_SOLO_MX = 1 THEN PC_TEXTO1
	            ELSE PC_TEXTO1 || CASE WHEN CUR.Tc_Gestion = 'ACP' THEN '. Cliente Acepta en campaña anterior de retener, pero no cursó operacion, revisar comentario de gestión en texto 3'
				 		               WHEN CUR.Tc_Gestion = 'AGN' THEN '. Cliente Agendado en campaña anterior de retener, pero no cursó operacion, revisar comentario de gestión en texto 3'
						               ELSE '' END
                END
WHERE PD_RUT = CUR.TD_RUT
AND PE_IND_CAMPANA = 1
AND PE_PRIORIDAD = 1 
;

.IF ERRORCODE <> 0 THEN .QUIT 006;


--/***********************************************************************
--** 			texto 3												**  
--***********************************************************************/

UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_RETENER_COLO_MX_SIN_CURSE CUR
SET 
	PC_TEXTO3 = CUR.Tc_Literal_Gestion

WHERE PD_RUT = CUR.TD_RUT
AND PE_IND_CAMPANA = 1
AND PE_PRIORIDAD = 1 
;

.IF ERRORCODE <> 0 THEN .QUIT 007;


--/***********************************************************************
--** 			DESCRIPCION TEXTO 1, PARA PROPENSION MX					
--**  Todos los clientes que tengan el indicador de banquero, solo pueden operar con banquero idependiente de cualquier otra condicion
--***********************************************************************/

UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES
SET 
	PC_TEXTO1 = 
		CASE 
		   WHEN PE_IND_BANQUERO_SOLO_MX = 1 AND PE_PRIORIDAD = 2 
		        THEN 'Opera solo MX según Banquero'
		   
		   WHEN PE_IND_BANQUERO_SOLO_MX = 1 AND PE_PRIORIDAD = 3 
		        THEN 'Opera solo MX según Banquero'
		
		   WHEN PE_PRIORIDAD = 2 
				THEN 'Cliente con LGC Vigente, Propenso en Credito Moneda Extranjera'

		   WHEN PE_PRIORIDAD = 3 
				THEN 'Cliente con Linea Creada En Campana Nuevas Lineas MX, Validar Disponible'
	    		ELSE ''
		END
WHERE PE_IND_CAMPANA = 2
;
.IF ERRORCODE <> 0 THEN .QUIT 008;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES;
.IF ERRORCODE <> 0 THEN .QUIT 009;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;

UPDATE - Ejemplo 4 OK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: LITERAL																	  **
--**                                                    				 				  **
--** AUTOR  : FRANCISCO PINOCHET                                               	  		  **
--** EMPRESA: FACTORIT                                   				  				  **
--** FECHA  : 03/2024                                                   				  **
--/*****************************************************************************************
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 08/2024			     	                                                  **
--/*****************************************************************************************
--/*****************************************************************************************
--**TABLA DE ENTRADA:	                                            					  
--**					MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS
--**					EDM_DMSEGTO_VW.IN_SEGUIMIENTO_EMPRESA
--** TABLA DE SALIDA:	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_RN
--**				
--**TABLAS TEMPORALES:	
--**					{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_RETENER_COLO_MX_SIN_CURSE
--**					{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_LIT_01
--**																					  
--** TABLA DE SALIDA:	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_LIT	  	  
--**                                      												  
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/*******************************************************************************************************************************
--** clientes aceptados, agendados o sin gestion de la campaña Recuperar colocaciones MX que no han tenido curse, el mes anterior 
--********************************************************************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_RETENER_COLO_MX_SIN_CURSE;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_RETENER_COLO_MX_SIN_CURSE
(
 Td_Rut 			DECIMAL(8,0)
,Tc_Literal_Gestion VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
,Tc_Gestion 		VARCHAR(5)   CHARACTER SET LATIN NOT CASESPECIFIC
,Te_Ind_No_Gestion 	BYTEINT
)
PRIMARY INDEX ( Td_Rut );

.IF ERRORCODE <> 0 THEN .QUIT 001;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_RETENER_COLO_MX_SIN_CURSE
 SELECT
  SEG.RUT 											AS Td_Rut
 ,COALESCE(SEG.LITERAL_GESTION,'Sin Descripcion') 	AS Tc_Literal_Gestion
 ,SEG.Gestion 										AS Tc_Gestion
 ,case when Tc_Gestion NOT IN ('RCH','NCA') then 0 
       else 1 end 									AS Te_Ind_No_Gestion
FROM EDM_DMSEGTO_vw.in_Seguimiento_empresa SEG
LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS PAR
	ON 1 = 1
WHERE SEG.MES_INICIATIVA >= PAR.SE_PERIODO_REF
AND SEG.CANAL_CAMPANA = 'Ejecutivo_Comex'
AND SEG.CAMPANA = 'Recuperar Colocaciones MX'
AND SEG.INH = 0
AND Te_Ind_No_Gestion = 0
AND SEG.VENTA = 0
QUALIFY ROW_NUMBER() OVER (PARTITION BY RUT ORDER BY Td_Rut, SEG.FECHA_GESTION DESC) = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 002;

COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_RETENER_COLO_MX_SIN_CURSE;
.IF ERRORCODE <> 0 THEN .QUIT 003;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL 											  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_LIT_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_LIT_01
(
	 TD_RUT 							DECIMAL(8,0)
	,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PO_DEUDA						INTEGER
	,TE_CTACTE							INTEGER
	,TE_LCG_VIGENTE						INTEGER
	,TE_LME_VIGENTE 					INTEGER		
	,TE_DISPONIBLE_MX_NEW				BIGINT
	,TC_MACRO_BANCA     				VARCHAR(16) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_LCG_RENOV_SIN_DISP				INTEGER
	,TE_CURSE_ULT_3M					INTEGER
	,TE_FLG_EXCLUSION					INTEGER
	,TC_MOTIVO_EXCLUSION				VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO1							VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2  						VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3  						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_EN_PLANEAMIENTO					INTEGER 			
    ,TC_CALIFICACION_SBIF          		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,TF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,TD_PI_CLIENTE                		DECIMAL(25,10) 			
	,TC_CLASIFICACION_SBIF       		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FDR                      		INTEGER 			
	,TE_COS_CLI                 		INTEGER 			
	,TE_FILTROS_RIESGOS          		INTEGER 			
	,TC_PAR_CALIFICACION_SBIF    		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE           		DECIMAL(25,10) 		
	,TE_PAR_FDR                  		INTEGER 			
	,TE_PAR_COS_CLI             		INTEGER 		
	,TE_MOLESTO               			INTEGER 			
	,TE_CARGABLE						INTEGER
	,TC_ELIMINADO						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DISPONIBLE_OK               	INTEGER
	,TE_ENROLADO_360            		INTEGER
	,TE_HABILITADO_360           		INTEGER
	,TE_ACTIVO_360               		INTEGER
	,TE_ESTADO_MULTIPASS        		INTEGER
	,TE_MANDATO_CCL              		INTEGER
	,TE_SIN_APR                 		INTEGER
	,TE_ART85                     		INTEGER
	,TE_FYP                    			INTEGER
	,TE_READY_CCL              			INTEGER
	,TE_TOTAL_HABILITADORES       		INTEGER
	,TC_FECHA_HAB 						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC 	
	,TE_CMP_MANDATO_CCL					INTEGER
	,TE_CMP_CTO_BEX						INTEGER
	,TE_CMP_MIGRACION               	INTEGER
	,TE_CMP_PROPENSO_MX             	INTEGER
	,TE_CMP_FOGAPE_REACTIVA         	INTEGER
	,TC_EJE_CAMP						VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PRIORIDAD                   	INTEGER
	,TE_MTO_CMP    						BIGINT
	,TE_IND_BANQUERO_SOLO_MX			BYTEINT	
	,TE_IND_CAMPANA						BYTEINT
)PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 004;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_LIT_01
SELECT 
	 PPE.PD_RUT 									AS TD_RUT 					
	,PPE.PC_RECOMENDACION_DE_CRUCE					AS TC_RECOMENDACION_DE_CRUCE
	,PPE.PE_PO_DEUDA 								AS TE_PO_DEUDA
	,PPE.PE_CTACTE 									AS TE_CTACTE
	,PPE.PE_LCG_VIGENTE 							AS TE_LCG_VIGENTE
	,PPE.PE_LME_VIGENTE 							AS TE_LME_VIGENTE	
	,PPE.PE_DISPONIBLE_MX_NEW						AS TE_DISPONIBLE_MX_NEW
	,PPE.PC_MACRO_BANCA 							AS TC_MACRO_BANCA 		
	,PPE.PE_LCG_RENOV_SIN_DISP 						AS TE_LCG_RENOV_SIN_DISP
	,PPE.PE_CURSE_ULT_3M            				AS TE_CURSE_ULT_3M
	,PPE.PE_FLG_EXCLUSION           				AS TE_FLG_EXCLUSION
	,PPE.PC_MOTIVO_EXCLUSION        				AS TC_MOTIVO_EXCLUSION
	,CASE 
--/***********************************************************************
--** 			DESCRIPCION TEXTO 1, PARA PROPENSION MX					**  
--***********************************************************************/	
--/***********************************************************************************************************************************
--** 			texto 1								
--** Todos los clientes que tengan el indicador de banquero, solo pueden operar con banquero idependiente de cualquier otra condicion
--** Los que no tenga esa condicion el texto dira que tiene que recuperar colocaciones
--** Por ultimo se revisa si alguno de esto excepto a los que operan con banquero esta sin curce del mes anterior
--************************************************************************************************************************************/
		WHEN PPE.PE_IND_CAMPANA = 1 AND PPE.PE_PRIORIDAD = 1 AND PPE.PE_IND_BANQUERO_SOLO_MX = 1 AND CUR.TD_RUT IS NULL 
			 THEN 'Recuperar Colocaciones MX de clientes que aumentan o mantienen sus ODP. Opera solo MX según Banquero'
		WHEN PPE.PE_IND_CAMPANA = 1 AND PPE.PE_PRIORIDAD = 1 AND PPE.PE_IND_BANQUERO_SOLO_MX = 0 AND CUR.TD_RUT IS NULL
			 THEN  'Recuperar Colocaciones MX de clientes que aumentan o mantienen sus ODP'			 
		WHEN PPE.PE_IND_CAMPANA = 1 AND PPE.PE_PRIORIDAD = 1 AND PPE.PE_IND_BANQUERO_SOLO_MX = 1 AND CUR.TD_RUT IS NOT NULL 
			 THEN PPE.PC_TEXTO1
		WHEN PPE.PE_IND_CAMPANA = 1 AND PPE.PE_PRIORIDAD = 1 AND PPE.PE_IND_BANQUERO_SOLO_MX = 0 AND CUR.TD_RUT IS NOT NULL 			 
			 THEN PPE.PC_TEXTO1 ||
				CASE 
				 WHEN CUR.Tc_Gestion = 'ACP' THEN '. Cliente Acepta en campaña anterior de retener, pero no cursó operacion, revisar comentario de gestión en texto 3'
				 WHEN CUR.Tc_Gestion = 'AGN' THEN '. Cliente Agendado en campaña anterior de retener, pero no cursó operacion, revisar comentario de gestión en texto 3'
				 ELSE '' 
			    END

--/***********************************************************************
--** 			DESCRIPCION TEXTO 1, PARA PROPENSION MX					
--**  Todos los clientes que tengan el indicador de banquero, solo pueden operar con banquero idependiente de cualquier otra condicion
--***********************************************************************/
		WHEN
			PPE.PE_IND_CAMPANA = 2 THEN
				CASE 
				   WHEN PPE.PE_IND_BANQUERO_SOLO_MX = 1 AND PPE.PE_PRIORIDAD = 2 
				        THEN 'Opera solo MX según Banquero'

				   WHEN PPE.PE_IND_BANQUERO_SOLO_MX = 1 AND PPE.PE_PRIORIDAD = 3 
				        THEN 'Opera solo MX según Banquero'

				   WHEN PPE.PE_PRIORIDAD = 2 
						THEN 'Cliente con LGC Vigente, Propenso en Credito Moneda Extranjera'

				   WHEN PPE.PE_PRIORIDAD = 3 
						THEN 'Cliente con Linea Creada En Campana Nuevas Lineas MX, Validar Disponible'
	    				ELSE ''
				END	
	  ELSE PPE.PC_TEXTO1				
	END				                  				AS TC_TEXTO1
	,PPE.PC_TEXTO2                  				AS TC_TEXTO2
	,CASE 
		WHEN  
			PPE.PE_IND_CAMPANA = 1 AND PPE.PE_PRIORIDAD = 1 AND CUR.TD_RUT IS NOT NULL 
				THEN CUR.Tc_Literal_Gestion		
				ELSE PPE.PC_TEXTO3 END				AS TC_TEXTO3

	,PPE.PE_EN_PLANEAMIENTO         	        	AS TE_EN_PLANEAMIENTO
    ,PPE.PC_CALIFICACION_SBIF        				AS TC_CALIFICACION_SBIF
	,PPE.PF_PERIODO_CALIFICACION	          		AS TF_PERIODO_CALIFICACION 	
	,PPE.PD_PI_CLIENTE            					AS TD_PI_CLIENTE 
	,PPE.PC_CLASIFICACION_SBIF              		AS TC_CLASIFICACION_SBIF 	
	,PPE.PE_FDR                     				AS TE_FDR 
	,PPE.PE_COS_CLI									AS TE_COS_CLI
	,PPE.PE_FILTROS_RIESGOS         				AS TE_FILTROS_RIESGOS
	,PPE.PC_PAR_CALIFICACION_SBIF					AS TC_PAR_CALIFICACION_SBIF
	,PPE.PD_PAR_PI_CLIENTE				            AS TD_PAR_PI_CLIENTE 
	,PPE.PE_PAR_FDR		                         	AS TE_PAR_FDR 
	,PPE.PE_PAR_COS_CLI			                    AS TE_PAR_COS_CLI 	
	,PPE.PE_MOLESTO									AS TE_MOLESTO
	,PPE.PE_CARGABLE                				AS TE_CARGABLE
    ,PPE.PC_ELIMINADO	           					AS TC_ELIMINADO	
	,PPE.PE_DISPONIBLE_OK           				AS TE_DISPONIBLE_OK
	,PPE.PE_ENROLADO_360            				AS TE_ENROLADO_360
	,PPE.PE_HABILITADO_360          				AS TE_HABILITADO_360
	,PPE.PE_ACTIVO_360              				AS TE_ACTIVO_360
	,PPE.PE_ESTADO_MULTIPASS        				AS TE_ESTADO_MULTIPASS
	,PPE.PE_MANDATO_CCL             				AS TE_MANDATO_CCL
	,PPE.PE_SIN_APR                 				AS TE_SIN_APR
	,PPE.PE_ART85                   				AS TE_ART85
	,PPE.PE_FYP                     				AS TE_FYP
	,PPE.PE_READY_CCL               				AS TE_READY_CCL
	,PPE.PE_TOTAL_HABILITADORES     				AS TE_TOTAL_HABILITADORES
	,PPE.PC_FECHA_HAB 								AS TC_FECHA_HAB
	,PPE.PE_CMP_MANDATO_CCL         				AS TE_CMP_MANDATO_CCL
	,PPE.PE_CMP_CTO_BEX             				AS TE_CMP_CTO_BEX
	,PPE.PE_CMP_MIGRACION           				AS TE_CMP_MIGRACION
	,PPE.PE_CMP_PROPENSO_MX         				AS TE_CMP_PROPENSO_MX
	,PPE.PE_CMP_FOGAPE_REACTIVA     				AS TE_CMP_FOGAPE_REACTIVA
	,PPE.PC_EJE_CAMP								AS TC_EJE_CAMP
	,PPE.PE_PRIORIDAD 								AS TE_PRIORIDAD
	,PPE.PE_MTO_CMP							 		AS TE_MTO_CMP
	,PPE.PE_IND_BANQUERO_SOLO_MX					AS TE_IND_BANQUERO_SOLO_MX		
	,PPE.PE_IND_CAMPANA 							AS TE_IND_CAMPANA			 		
FROM {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_RN  PPE
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_RETENER_COLO_MX_SIN_CURSE CUR
		ON PD_RUT = CUR.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 005;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( Td_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_LIT_01
;
.IF ERRORCODE <> 0 THEN .QUIT 006;

/***********************************************************************************************
    CREA TABLA PRE CALCULO LITERAL
************************************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_LIT;
CREATE MULTISET TABLE  {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_LIT
(
	 PD_RUT 							DECIMAL(8,0)
	,PC_RECOMENDACION_DE_CRUCE			VARCHAR(255) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PO_DEUDA						INTEGER
	,PE_CTACTE							INTEGER
	,PE_LCG_VIGENTE						INTEGER
	,PE_LME_VIGENTE 					INTEGER		
	,PE_DISPONIBLE_MX_NEW				BIGINT
	,PC_MACRO_BANCA     				VARCHAR(16) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_LCG_RENOV_SIN_DISP				INTEGER
	,PE_CURSE_ULT_3M					INTEGER
	,PE_FLG_EXCLUSION					INTEGER
	,PC_MOTIVO_EXCLUSION				VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO1							VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO2  						VARCHAR(250) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO3  						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_EN_PLANEAMIENTO					INTEGER 			
    ,PC_CALIFICACION_SBIF          		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,PF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,PD_PI_CLIENTE                		DECIMAL(25,10) 			
	,PC_CLASIFICACION_SBIF       		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC	
	,PE_FDR                      		INTEGER 			
	,PE_COS_CLI                 		INTEGER 			
	,PE_FILTROS_RIESGOS          		INTEGER 			
	,PC_PAR_CALIFICACION_SBIF    		VARCHAR(200) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PD_PAR_PI_CLIENTE           		DECIMAL(25,10) 		
	,PE_PAR_FDR                  		INTEGER 			
	,PE_PAR_COS_CLI             		INTEGER 		
	,PE_MOLESTO               			INTEGER 			
	,PE_CARGABLE						INTEGER
	,PC_ELIMINADO						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_DISPONIBLE_OK               	INTEGER
	,PE_ENROLADO_360            		INTEGER
	,PE_HABILITADO_360           		INTEGER
	,PE_ACTIVO_360               		INTEGER
	,PE_ESTADO_MULTIPASS        		INTEGER
	,PE_MANDATO_CCL              		INTEGER
	,PE_SIN_APR                 		INTEGER
	,PE_ART85                     		INTEGER
	,PE_FYP                    			INTEGER
	,PE_READY_CCL              			INTEGER
	,PE_TOTAL_HABILITADORES       		INTEGER
	,PC_FECHA_HAB 						VARCHAR(100) 	CHARACTER SET LATIN NOT CASESPECIFIC 	
	,PE_CMP_MANDATO_CCL					INTEGER
	,PE_CMP_CTO_BEX						INTEGER
	,PE_CMP_MIGRACION               	INTEGER
	,PE_CMP_PROPENSO_MX             	INTEGER
	,PE_CMP_FOGAPE_REACTIVA         	INTEGER
	,PC_EJE_CAMP						VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PRIORIDAD                   	INTEGER
	,PE_MTO_CMP    						BIGINT
	,PE_IND_BANQUERO_SOLO_MX			BYTEINT	
	,PE_IND_CAMPANA						BYTEINT
)PRIMARY INDEX (PD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 007;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_LIT
SELECT 
	 PPE.TD_RUT 									AS PD_RUT 					
	,PPE.TC_RECOMENDACION_DE_CRUCE					AS PC_RECOMENDACION_DE_CRUCE
	,PPE.TE_PO_DEUDA 								AS PE_PO_DEUDA
	,PPE.TE_CTACTE 									AS PE_CTACTE
	,PPE.TE_LCG_VIGENTE 							AS PE_LCG_VIGENTE
	,PPE.TE_LME_VIGENTE 							AS PE_LME_VIGENTE	
	,PPE.TE_DISPONIBLE_MX_NEW						AS PE_DISPONIBLE_MX_NEW
	,PPE.TC_MACRO_BANCA 							AS PC_MACRO_BANCA 		
	,PPE.TE_LCG_RENOV_SIN_DISP 						AS PE_LCG_RENOV_SIN_DISP
	,PPE.TE_CURSE_ULT_3M            				AS PE_CURSE_ULT_3M
	,PPE.TE_FLG_EXCLUSION           				AS PE_FLG_EXCLUSION
	,PPE.TC_MOTIVO_EXCLUSION        				AS PC_MOTIVO_EXCLUSION
	,PPE.TC_TEXTO1                  				AS PC_TEXTO1
	,PPE.TC_TEXTO2                  				AS PC_TEXTO2
	,PPE.TC_TEXTO3                  				AS PC_TEXTO3
	,PPE.TE_EN_PLANEAMIENTO         	        	AS PE_EN_PLANEAMIENTO
    ,PPE.TC_CALIFICACION_SBIF        				AS PC_CALIFICACION_SBIF
	,PPE.TF_PERIODO_CALIFICACION	          		AS PF_PERIODO_CALIFICACION 	
	,PPE.TD_PI_CLIENTE            					AS PD_PI_CLIENTE 
	,PPE.TC_CLASIFICACION_SBIF              		AS PC_CLASIFICACION_SBIF 	
	,PPE.TE_FDR                     				AS PE_FDR 
	,PPE.TE_COS_CLI									AS PE_COS_CLI
	,PPE.TE_FILTROS_RIESGOS         				AS PE_FILTROS_RIESGOS
	,PPE.TC_PAR_CALIFICACION_SBIF					AS PC_PAR_CALIFICACION_SBIF
	,PPE.TD_PAR_PI_CLIENTE				            AS PD_PAR_PI_CLIENTE 
	,PPE.TE_PAR_FDR		                         	AS PE_PAR_FDR 
	,PPE.TE_PAR_COS_CLI			                    AS PE_PAR_COS_CLI 	
	,PPE.TE_MOLESTO									AS PE_MOLESTO
	,PPE.TE_CARGABLE                				AS PE_CARGABLE
    ,PPE.TC_ELIMINADO	           					AS PC_ELIMINADO	
	,PPE.TE_DISPONIBLE_OK           				AS PE_DISPONIBLE_OK
	,PPE.TE_ENROLADO_360            				AS PE_ENROLADO_360
	,PPE.TE_HABILITADO_360          				AS PE_HABILITADO_360
	,PPE.TE_ACTIVO_360              				AS PE_ACTIVO_360
	,PPE.TE_ESTADO_MULTIPASS        				AS PE_ESTADO_MULTIPASS
	,PPE.TE_MANDATO_CCL             				AS PE_MANDATO_CCL
	,PPE.TE_SIN_APR                 				AS PE_SIN_APR
	,PPE.TE_ART85                   				AS PE_ART85
	,PPE.TE_FYP                     				AS PE_FYP
	,PPE.TE_READY_CCL               				AS PE_READY_CCL
	,PPE.TE_TOTAL_HABILITADORES     				AS PE_TOTAL_HABILITADORES
	,PPE.TC_FECHA_HAB 								AS PC_FECHA_HAB	
	,PPE.TE_CMP_MANDATO_CCL         				AS PE_CMP_MANDATO_CCL
	,PPE.TE_CMP_CTO_BEX             				AS PE_CMP_CTO_BEX
	,PPE.TE_CMP_MIGRACION           				AS PE_CMP_MIGRACION
	,PPE.TE_CMP_PROPENSO_MX         				AS PE_CMP_PROPENSO_MX
	,PPE.TE_CMP_FOGAPE_REACTIVA     				AS PE_CMP_FOGAPE_REACTIVA
	,PPE.TC_EJE_CAMP								AS PC_EJE_CAMP
	,PPE.TE_PRIORIDAD 								AS PE_PRIORIDAD
	,PPE.TE_MTO_CMP							 		AS PE_MTO_CMP
	,PPE.TE_IND_BANQUERO_SOLO_MX					AS PE_IND_BANQUERO_SOLO_MX		
	,PPE.TE_IND_CAMPANA 							AS PE_IND_CAMPANA	 		
FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMX001OB_LIT_01 PPE
;
.IF ERRORCODE <> 0 THEN .QUIT 008;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMX001OB_CAMPANA_PROPENSO_MX_NEW_MES_LIT;
.IF ERRORCODE <> 0 THEN .QUIT 009;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;

UPDATE - Ejemplo 5 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: SACA PUBLICO OBJETIVO PARA CAMPANA PROPENSOS MN PLAN PROYECTOS  	          **
--**                                                    				 				  **
--** AUTOR  : FRANCISCO PINOCHET                                               	  		  **
--** EMPRESA: FACTORIT                                   				  				  **
--** FECHA  : 03/2024                                                   				  **
--/*****************************************************************************************
--/*****************************************************************************************
--** MANTNCN: 														                      **
--** AUTOR  : 				                                                          	  **
--** FECHA  : 			                                                  				  **
--/*****************************************************************************************
--/*****************************************************************************************
--**TABLA DE ENTRADA:	  															      **
--**					MKT_EXPLORER_TB.PBI_WHOLESALE_APP_OPORTUNIDAD                     **
--**					EDM_DMSEGTO_VW.IN_SEGUIMIENTO_EMPRESA                             **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO                    	  **
--**					MKT_EXPLORER_TB.CRM_DATOS_DATAMART_HAB_PYME                       **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_EXCLUSIONES_PUNTUALES_MES     **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MARCA_CURSES_CREDITOS_COVID_VENCIMIENTO**
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CTAS_CTES_MN             	  	  **
--**					MKT_CRM_CMP_TB.TBL_LCG                                            **
--**					MKT_EXPLORER_TB.VENTA_DIARIA_COL                                  **
--**					EDW_VW.AGREEMENT                                                  **
--**					MKT_CRM_ANALYTICS_TB.P_WSL_MENSUAL_1A_MASIVA_CC                   **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS                  **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CLIENTE_EJECUTIVO        	  	  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_MATRIZ_VULNERABILIDAD         **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_PERSPECTIVAS_SECTORIALES	  **
--**					MKT_CRM_CMP_TB.CRM_BASE_BYPASS_SEGUIMIENTO_AIRFLOW				  **
--**             																		  **
--**TABLA DE SALIDA:    {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES**
--**                  														              **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/************************************************************
--** CREA TABLA TEMPORAL CON PARAMETROS DE EJECUCION	     **  
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO
(
	 TE_PERIODO_CMP			INTEGER
	,TF_FECHA_CMP			DATE FORMAT 'YYYY-MM-DD'
	,TF_FECHA_CRG			DATE FORMAT 'YYYY-MM-DD'
	,TF_VCTO_LINEA			DATE FORMAT 'YYYY-MM-DD'
	,TF_FECHA_INI			DATE FORMAT 'YYYY-MM-DD'
	,TF_FECHA_FIN			DATE FORMAT 'YYYY-MM-DD'
	,TE_PERIODO_INI			INTEGER
	,TE_PERIODO_FIN			INTEGER
	,TE_PERIODO_CMP_MAS_1	INTEGER
	,TF_FEC_MES_ATRAS_1M	DATE FORMAT 'YYYY-MM-DD'
	,TF_FEC_MES_ATRAS_3M	DATE FORMAT 'YYYY-MM-DD'
	,TF_FEC_MES_ATRAS_6M	DATE FORMAT 'YYYY-MM-DD'
	,TE_PER_MES_ATRAS_1M	INTEGER
	,TE_PER_MES_ATRAS_3M	INTEGER
	,TE_PER_MES_ATRAS_6M	INTEGER
)
PRIMARY INDEX ( TE_PERIODO_CMP )
;
.IF ERRORCODE <> 0 THEN .QUIT 1;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO
SELECT 
	 SE_PERIODO_CMP 					AS TE_PERIODO_CMP
	,SF_FECHA_REF_DIA 					AS TF_FECHA_CMP
	,SF_FECHA_CARGA 					AS TF_FECHA_CRG	
	,SF_VCTO_LINEA						AS TF_VCTO_LINEA
	,SF_FECHA_MENOS_3M					AS TF_FECHA_INI
	,SF_FECHA_REF_DIA_FIN				AS TF_FECHA_FIN
	,SE_PERIODO_CMP 					AS TE_PERIODO_INI
	,CAST(CAST(CAST(ADD_MONTHS(SF_FECHA_REF_DIA, 2) AS FORMAT 'YYYYMMDD') AS VARCHAR(6)) AS INTEGER) AS TE_PERIODO_FIN
	,SE_PERIODO_MAS_2M					AS TE_PERIODO_CMP_MAS_1
	,ADD_MONTHS(CAST((CAST(SE_PERIODO_CMP AS CHAR(6)) || '01') AS DATE FORMAT 'YYYYMMDD'),-1) AS TF_FEC_MES_ATRAS_1M
	,ADD_MONTHS(CAST((CAST(SE_PERIODO_CMP AS CHAR(6)) || '01') AS DATE FORMAT 'YYYYMMDD'),-3) AS TF_FEC_MES_ATRAS_3M
	,ADD_MONTHS(CAST((CAST(SE_PERIODO_CMP AS CHAR(6)) || '01') AS DATE FORMAT 'YYYYMMDD'),-6) AS TF_FEC_MES_ATRAS_6M
	,CAST(CAST(CAST(TF_FEC_MES_ATRAS_1M AS DATE FORMAT 'YYYYMMDD') AS CHAR(6)) AS INTEGER) AS TE_PER_MES_ATRAS_1M
	,CAST(CAST(CAST(TF_FEC_MES_ATRAS_3M AS DATE FORMAT 'YYYYMMDD') AS CHAR(6)) AS INTEGER) AS TE_PER_MES_ATRAS_3M
	,CAST(CAST(CAST(TF_FEC_MES_ATRAS_6M AS DATE FORMAT 'YYYYMMDD') AS CHAR(6)) AS INTEGER) AS TE_PER_MES_ATRAS_6M
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO;
	
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/************************************************************
--** CREA TABLA TEMPORAL SACO PROPENSION MODELO ANALITYCS    **  
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MOD_PROPENSION;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MOD_PROPENSION
(
	 TE_PERIODO_REF 							INTEGER
	,TE_MES_REF 								INTEGER
	,TE_RUT 									INTEGER
	,TE_MONTO_COMERCIAL 						INTEGER
	,TD_PROPENSION_CREDITO_COMERCIAL 			DECIMAL(25,10)
	,TD_PROBABILIDAD_REAL_CREDITO_COMERCIAL 	DECIMAL(6,5)
	,TD_MONTO_ESPERADO 							DECIMAL(15,5)
	,TE_RANKING									INTEGER
	,TE_DECIL									INTEGER
	
)PRIMARY INDEX ( TE_PERIODO_REF ,TE_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MOD_PROPENSION
SELECT 
	 MAC.PE_ANOMES_REF								AS	TE_PERIODO_REF							
	,MAC.PE_MES_REF 							    AS  TE_MES_REF 							
    ,MAC.PD_RUT 								    AS  TE_RUT 								
    ,MAC.PE_MONTO_COMERCIAL 					    AS  TE_MONTO_COMERCIAL 					
    ,MAC.PD_PROPENSION_CREDITO_COMERCIAL 		    AS  TD_PROPENSION_CREDITO_COMERCIAL 		
    ,MAC.PD_PROBABILIDAD_REAL_CREDITO_COMERCIAL     AS  TD_PROBABILIDAD_REAL_CREDITO_COMERCIAL 
	,MAC.PD_MONTO_ESPERADO                          AS  TD_MONTO_ESPERADO 
--	,(ROW_NUMBER() OVER (partition by MAC.PE_ANOMES_REF ORDER BY MAC.Pd_PROPENSION_CREDITO_COMERCIAL desc) - 1) AS TE_RANKING
--	,(ROW_NUMBER() OVER (partition by MAC.PE_ANOMES_REF ORDER BY MAC.Pd_PROPENSION_CREDITO_COMERCIAL desc) - 1) * 10 / COUNT(*) OVER(partition by MAC.PE_ANOMES_REF) +1 AS TE_DECIL		
	,(ROW_NUMBER() OVER (partition by MAC.PE_ANOMES_REF ORDER BY MAC.Pd_PROPENSION_CREDITO_COMERCIAL desc, MAC.PE_MONTO_COMERCIAL desc, MAC.PD_RUT) - 1) AS TE_RANKING
	,(ROW_NUMBER() OVER (partition by MAC.PE_ANOMES_REF ORDER BY MAC.Pd_PROPENSION_CREDITO_COMERCIAL desc, MAC.PE_MONTO_COMERCIAL desc, MAC.PD_RUT) - 1) * 10 / COUNT(*) OVER(partition by MAC.PE_ANOMES_REF) +1 AS TE_DECIL		
FROM  
	MKT_CRM_ANALYTICS_TB.P_WSL_MENSUAL_1A_MASIVA_CC AS MAC
;
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/***********************************************************************
--**                    SE APLICAN COLLECTS                             **
--***********************************************************************/
COLLECT STATS INDEX ( TE_PERIODO_REF ,TE_RUT  )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MOD_PROPENSION;
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/************************************************************
--** CREA TABLA TEMPORAL PARA CODIGOS TIPO VENTA             **  
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_TIPOS_VTA;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_TIPOS_VTA
(
	TC_COD_TPO_VTA		VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
)
PRIMARY INDEX ( TC_COD_TPO_VTA )
;
.IF ERRORCODE <> 0 THEN .QUIT 10;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_TIPOS_VTA VALUES ('COM');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_TIPOS_VTA VALUES ('AVC');
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/***********************************************************************
--**                    SE APLICAN COLLECTS                             **
--***********************************************************************/
COLLECT STATS INDEX ( TC_COD_TPO_VTA )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_TIPOS_VTA;
.IF ERRORCODE <> 0 THEN .QUIT 12;

--/************************************************************
--** CREA TABLA TEMPORAL PARA CURSES 3 MESES                 **  
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CURSES_3M;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CURSES_3M
(
	 TE_RUT 					INTEGER
	,TE_MTO_CREDITO_PESOS		BIGINT
)PRIMARY INDEX ( TE_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 13;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CURSES_3M
SELECT 
	 VTA.RUT									AS	TE_RUT
	,SUM(CAST(VTA.MTO_CREDITO_PESOS AS BIGINT))	AS	TE_MTO_CREDITO_PESOS
FROM
	MKT_EXPLORER_TB.VENTA_DIARIA_COL AS VTA
	INNER JOIN EDW_VW.AGREEMENT AS AGR
		ON AGR.ACCOUNT_NUM = VTA.OPERACION
			AND AGR.ACCOUNT_OPEN_DT = VTA.FECHA_ACTIVACION
			AND AGR.CONTRACT_EXPIRATION_DT = VTA.FECHA_MAX_VCTO
			AND VTA.ESTADO = 'A'
			AND AGR.ACCT_STATUS_TYPE_CD = 1
			AND VTA.CUOTA <= 12
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_TIPOS_VTA AS CTV
		ON VTA.TIPO = CTV.TC_COD_TPO_VTA
	INNER JOIN 	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO AS PAR
		ON TRUNC (VTA.FECHA_CUR_RE,'MON') BETWEEN PAR.TF_FECHA_INI AND PAR.TF_FECHA_FIN
GROUP BY
	 VTA.RUT	
;
.IF ERRORCODE <> 0 THEN .QUIT 14;

--/***********************************************************************
--**                    SE APLICAN COLLECTS                             **
--***********************************************************************/
COLLECT STATS INDEX ( TE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CURSES_3M;
.IF ERRORCODE <> 0 THEN .QUIT 15;

--/************************************************************
--**       CREA TABLA TEMPORAL PARA SACAR LINEAS			 **  
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_LINEAS;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_LINEAS
(
	 TF_FECHA_PROCESO 		DATE FORMAT 'YYYY-MM-DD'
    ,TE_RUT 				INTEGER
    ,TE_DCP 				BIGINT
    ,TE_LME 				BIGINT
    ,TF_FECHA_VCTO 			DATE FORMAT 'YYYY-MM-DD'
    ,TF_VCTO_LME 			DATE FORMAT 'YYYY-MM-DD'
    ,TF_VCTO_KT_MN 			DATE FORMAT 'YYYY-MM-DD'
    ,TF_VCTO_LBG 			DATE FORMAT 'YYYY-MM-DD')
PRIMARY INDEX ( TF_FECHA_PROCESO, TE_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 16;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_LINEAS
SELECT
	 FECHA_PROCESO		AS TF_FECHA_PROCESO 	
	,RUT                AS TE_RUT 			
	,DCP                AS TE_DCP 			
	,LME                AS TE_LME 			
	,FECHA_VCTO         AS TF_FECHA_VCTO 		
	,VCTO_LME           AS TF_VCTO_LME 		
	,VCTO_KT_MN         AS TF_VCTO_KT_MN 		
	,VCTO_LBG           AS TF_VCTO_LBG	
FROM 
	MKT_CRM_CMP_TB.TBL_LCG 
WHERE 
	RUT >= 50000000
;
.IF ERRORCODE <> 0 THEN .QUIT 17;

--/***********************************************************************
--**                    SE APLICAN COLLECTS                             **
--***********************************************************************/
COLLECT STATS INDEX ( TF_FECHA_PROCESO, TE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_LINEAS;
.IF ERRORCODE <> 0 THEN .QUIT 18;

--/***********************************************************************
--**	SE CREA TABLA TEMPO PARA MAXIMA FECHA DE LINEAS					**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MAX_FEC_LIN;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MAX_FEC_LIN
(
	 TF_FEC_MAX_LIN	DATE FORMAT 'YYYY-MM-DD'
)
PRIMARY INDEX ( TF_FEC_MAX_LIN )
;
.IF ERRORCODE <> 0 THEN .QUIT 19;

INSERT {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MAX_FEC_LIN
SELECT 
	MAX(TF_FECHA_PROCESO) 	AS TF_FEC_MAX_LIN
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_LINEAS
;
.IF ERRORCODE <> 0 THEN .QUIT 20;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TF_FEC_MAX_LIN)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MAX_FEC_LIN;
.IF ERRORCODE <> 0 THEN .QUIT 21;

--/*************************************************************************
--**SE CREA TABLA TEMPORAL QUE CONTABILIZA CANTIDAD DE CUENTAS CORRIENTES **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CANT_CCTE;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CANT_CCTE
(
	 TE_RUT 							INTEGER
)
PRIMARY INDEX ( TE_RUT );
.IF ERRORCODE <> 0 THEN .QUIT 22;

INSERT {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CANT_CCTE
SELECT
	 IE_RUT		AS TE_RUT
FROM
	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CTAS_CTES_MN
GROUP BY TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 23;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CANT_CCTE;
.IF ERRORCODE <> 0 THEN .QUIT 24;

--/***********************************************************************
--** SE CREA TABLA TEMPORAL QUE CONTABILIZA CURSES DE CREDITOS COVID	**  
--***********************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_COVID;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_COVID
(
	 TE_RUT 					INTEGER
	,TE_MTO_CREDITO_PESOS		BIGINT
)
PRIMARY INDEX ( TE_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 25;

INSERT {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_COVID
SELECT
	 MCC.IE_RUT		AS TE_RUT
	,SUM(CAST(MCC.IE_MTO_CREDITO_PESOS AS BIGINT))	AS	TE_MTO_CREDITO_PESOS
FROM 
	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MARCA_CURSES_CREDITOS_COVID_VENCIMIENTO AS MCC
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO AS PAR
		ON MCC.IE_PERIODO_VENCIMIENTO = PAR.TE_PERIODO_CMP
			AND MCC.IC_ETIQUETA_CREDITO = 'OTRO'
			AND MCC.IE_CUOTA <= 12
GROUP BY 
	TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 26;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_COVID;
.IF ERRORCODE <> 0 THEN .QUIT 27;

--/***********************************************************************
--**SE CREA TABLA TEMPORAL QUE 	REGISTRA EXCLUSIONES PUNTUALES MESES	**  
--***********************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_EXCLUSION;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_EXCLUSION
(
	 TE_RUT 					INTEGER
	,TC_MOTIVO					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
)
PRIMARY INDEX ( TE_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 28;

INSERT {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_EXCLUSION
SELECT
	 EXC.SE_RUT		AS TE_RUT
	,EXC.SC_MOTIVO	AS TC_MOTIVO
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_EXCLUSIONES_PUNTUALES_MES AS EXC
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO AS PAR
		ON EXC.SE_PERIODO_CMP = PAR.TE_PERIODO_CMP
			AND EXC.SC_MOTIVO = 'PLAN REGIONES AGRO' 
GROUP BY 
	 EXC.SE_RUT
	,EXC.SC_MOTIVO
;
.IF ERRORCODE <> 0 THEN .QUIT 29;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_EXCLUSION;
.IF ERRORCODE <> 0 THEN .QUIT 30;

--/***********************************************************************
--** SE CREA TABLA TEMPORAL PARA CODIGOS  CAMPANA PROPENSOS PARA BAQUERO    	**  
--***********************************************************************/
 DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CAMPANA;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CAMPANA
(
	TC_CAMPANA	VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
)
PRIMARY INDEX ( TC_CAMPANA )
;
.IF ERRORCODE <> 0 THEN .QUIT 37;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CAMPANA VALUES('Campana Clientes Propensos Mon Nacional');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CAMPANA VALUES('Campana Clientes Propensos Moneda Nacional');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CAMPANA VALUES('Campana Clientes Propensos Moneda Nacional Plan de Inversion');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CAMPANA VALUES('Campana Clientes con Potencial Deuda');
.IF ERRORCODE <> 0 THEN .QUIT 38;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
 COLLECT STATS INDEX ( TC_CAMPANA )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CAMPANA;
.IF ERRORCODE <> 0 THEN .QUIT 39;

--/***********************************************************************
--**	SE CREA TABLA TEMPORAL PARA DETECTAR A LOS CLIENTES QUE LLEVAN  **
--**    ACAMPAÑADOS 6 MESES  											**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_REPITENCIA;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_REPITENCIA
(
	TC_CAMPANA 				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_RUT					DECIMAL(8,0)
	,TE_VECES_CAMPANADO		INTEGER
	,TE_REPITENCIA			INTEGER
)
PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 40;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_REPITENCIA
SELECT
	EMP.CAMPANA 							AS TC_CAMPANA
	,EMP.RUT 								AS TD_RUT
	,COUNT(EMP.RUT) 						AS TE_VECES_CAMPANADO
	,CASE WHEN TE_VECES_CAMPANADO = 6 
		THEN 1 
		ELSE 0 
	END 									AS TE_REPITENCIA
FROM EDM_DMSEGTO_VW.IN_SEGUIMIENTO_EMPRESA EMP
INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CAMPANA CMP
	ON EMP.CAMPANA = CMP.TC_CAMPANA
INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO PAR
	ON EMP.MES_INICIATIVA >= PAR.TE_PER_MES_ATRAS_6M
WHERE EMP.ORIGEN = 'WHOLESALE'
	AND EMP.CANAL_CAMPANA = 'Ejecutivo_Comercial'
	GROUP BY EMP.CAMPANA,EMP.RUT 
HAVING TE_REPITENCIA = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 41;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
 COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_REPITENCIA;
.IF ERRORCODE <> 0 THEN .QUIT 42;


--/***********************************************************************
--** TOMA LOS RUT QUE SERAN RECHAZADOS EN MONEDA NACIONAL
--** DEBEN SER CLIENTES QUE FUERON GENTIONADOS LOS ULTIMOS 3 MESES
--** CON UN DECIL MAYOR A 3
--***********************************************************************/	

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_3M;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_3M

(
 TD_RUT DECIMAL(8,0)
,TE_IND_RCH_MN INTEGER
)
PRIMARY INDEX ( TD_RUT );
.IF ERRORCODE <> 0 THEN .QUIT 43;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_3M
SELECT EMP.RUT AS TD_RUT
     , SUM(CASE WHEN GESTION IN ('RCH','NCA') AND COALESCE(TE_DECIL,0) > 3 
	 			THEN 1 
				ELSE 0 
	   END) AS TE_IND_RCH_MN
FROM EDM_DMSEGTO_VW.IN_SEGUIMIENTO_EMPRESA EMP
INNER JOIN 	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO AS PAR
		ON EMP.MES_INICIATIVA < PAR.TE_PERIODO_CMP
		AND EMP.MES_INICIATIVA >= PAR.TE_PER_MES_ATRAS_3M
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MOD_PROPENSION DCL
	ON EMP.RUT = DCL.TE_RUT
GROUP BY TD_RUT
HAVING TE_IND_RCH_MN > 0 
;

.IF ERRORCODE <> 0 THEN .QUIT 44;

 COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_3M;
.IF ERRORCODE <> 0 THEN .QUIT 45;


--/***********************************************************************
--** TOMA LOS RUT QUE SERAN RECHAZADOS EN MONEDA EXTRANJERA
--** DONDE SU LITERAL SEA Opera solo MX
--***********************************************************************/	

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_MX;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_MX

(
 TD_RUT DECIMAL(8,0)
,TE_IND_RCH_MX INTEGER
)
PRIMARY INDEX ( TD_RUT );
.IF ERRORCODE <> 0 THEN .QUIT 46;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_MX
SELECT EMP.RUT AS TD_RUT
	  ,SUM(CASE WHEN POSITION ('Opera solo MX' IN LITERAL_GESTION) > 0
	  			THEN 1
				ELSE 0
		END) AS TE_IND_RCH_MX
FROM EDM_DMSEGTO_VW.IN_SEGUIMIENTO_EMPRESA EMP
INNER JOIN 	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO AS PAR
	ON EMP.MES_INICIATIVA = PAR.TE_PER_MES_ATRAS_1M
WHERE EMP.CAMPANA = 'Campana Clientes Propensos Moneda Nacional'
GROUP BY TD_RUT
HAVING TE_IND_RCH_MX > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 47;

 COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_MX;
.IF ERRORCODE <> 0 THEN .QUIT 48;


--/***********************************************************************
--**   SEGUIMIENTO DE EMPRESA								    		
--**   CON LAS GESTIONES DE LOS ULT 3 MESES,OPERA SOLO EN MX
--**   Y REPITENCIAL
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_SEG_EMPRESA;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_SEG_EMPRESA
(
	 TC_MES_INICIATIVA			INTEGER
	,TC_CAMPANA 				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_RUT 					INTEGER
    ,TC_BANCA 					VARCHAR(3) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GESTION 				VARCHAR(5) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_FECHA_GESTION 			DATE FORMAT 'YYYY-MM-DD'
	,TE_GEST_RCH_U3M 			INTEGER
	,TE_REPITENCIA				INTEGER
	,TE_RCHMX					INTEGER 
)
PRIMARY INDEX ( TE_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 49;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_SEG_EMPRESA
SELECT 
 	 EMP.MES_INICIATIVA															AS TC_MES_INICIATIVA
 	,EMP.CAMPANA																AS TC_CAMPANA 		
	,EMP.RUT                													AS TE_RUT 			
	,EMP.BANCA              													AS TC_BANCA 			
	,EMP.GESTION            													AS TC_GESTION 		
	,EMP.FECHA_GESTION      													AS TF_FECHA_GESTION 
	,CASE WHEN GMN.TD_RUT IS NOT NULL 
				THEN 1 
				ELSE 0 
	 END 																		AS TE_GEST_RCH_U3M 
	,CASE WHEN PMR.TD_RUT IS NOT NULL 
				THEN 1 
				ELSE 0 
	 END 																		AS TE_REPITENCIA  
	,CASE WHEN GMX.TD_RUT IS NOT NULL 
				THEN 1 
				ELSE 0 
	 END 	 																	AS TE_RCHMX
	 
FROM 
	EDM_DMSEGTO_VW.IN_SEGUIMIENTO_EMPRESA AS EMP
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CAMPANA AS CMP
		ON EMP.CAMPANA = CMP.TC_CAMPANA
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_3M GMN
		ON EMP.RUT = GMN.TD_RUT
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_MX GMX
		ON EMP.RUT = GMX.TD_RUT
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_REPITENCIA PMR
	ON EMP.RUT = PMR.TD_RUT
QUALIFY ROW_NUMBER () OVER ( PARTITION BY TE_RUT ORDER BY TC_MES_INICIATIVA DESC) =1
;

.IF ERRORCODE <> 0 THEN .QUIT 50;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_SEG_EMPRESA;
.IF ERRORCODE <> 0 THEN .QUIT 51;

--/***********************************************************************
--**         SE CREA TABLA TEMPORAL PARA PLAN_PROYECTOS                 **  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS
(
    TE_RUT					INTEGER
    ,TC_CAMPANA				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GESTION				VARCHAR(5) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCA				VARCHAR(3) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_FECHA_FIN			DATE FORMAT 'YYYY-MM-DD'
    ,TE_MES_OPORTUNIDAD		INTEGER
    ,TC_ESTADO        		VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NEGOCIO    			VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PRODUCTO 			VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MONTO            	BIGINT
    ,TC_EJE_CREADOR        	VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_VST_ID            	VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
)PRIMARY INDEX ( TE_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 52;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS
SELECT
	SEM.TE_RUT            	AS TE_RUT
	,SEM.TC_CAMPANA    		AS TC_CAMPANA
	,SEM.TC_GESTION    		AS TC_GESTION
	,SEM.TC_BANCA        	AS TC_BANCA
	,AOP.FECHA_FIN        	AS TF_FECHA_FIN
	,CAST(CAST(CAST(AOP.FECHA_FIN AS FORMAT 'YYYYMMDD') AS VARCHAR(6)) AS INTEGER)	AS TE_MES_OPORTUNIDAD
	,AOP.ESTADO            	AS TC_ESTADO
	,AOP.NEGOCIO            AS TC_NEGOCIO
	,AOP.PRODUCTO        	AS TC_PRODUCTO
	,AOP.MONTO              AS TE_MONTO
	,AOP.USR_ID_RESPONSABLE AS TC_EJE_CREADOR
	,AOP.VST_ID    			AS TC_VST_ID
FROM 
	MKT_EXPLORER_TB.PBI_WHOLESALE_APP_OPORTUNIDAD AS AOP
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_SEG_EMPRESA AS SEM
        ON AOP.RUT=SEM.TE_RUT
        AND AOP.FECHA_CREACION>=SEM.TF_FECHA_GESTION
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO AS PAR
		ON TE_MES_OPORTUNIDAD BETWEEN PAR.TE_PERIODO_INI AND PAR.TE_PERIODO_FIN
	WHERE
		TRIM(AOP.ESTADO)='ACTIVA'
		AND TRIM(AOP.NEGOCIO) = 'COLOCACIÓN'
;
.IF ERRORCODE <> 0 THEN .QUIT 53;
--/***********************************************************************
--**                        SE APLICAN COLLECTS                         **  
--***********************************************************************/    
COLLECT STATS INDEX ( TE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS;
.IF ERRORCODE <> 0 THEN .QUIT 54;

--/***********************************************************************
--**SE CREA TABLA PUBLICO OBJETIVO PARA PROPENSOS MN PLAN PROYECTOS MES	**  
--***********************************************************************/	

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
(
	 PE_RUT 							INTEGER
	,PD_DISPONIBLE_MN					DECIMAL(18,0)
	,PD_DISPONIBLE_MX					DECIMAL(18,0)
	,PC_VCTO_MN							VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_VCTO_MX							VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_CLUSTER							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TOQUE_4T						VARCHAR(21) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PROPENSO_MN						INTEGER
	,PE_PROPENSO_MX						INTEGER
	,PC_NOMBRE_SEGMENTO					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_CLUSTER_AGREGADO				VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_CLUSTER_DCP_MM					BIGINT
	,PE_POTENCIAL_VISTAS_MM				BIGINT
	,PE_POTENCIAL_VISTAS_MM_LP			INTEGER
	,PC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PO_DEUDA						INTEGER
	,PE_CTACTE							INTEGER
	,PF_FECHA_LINEAS					DATE FORMAT 'YYYY-MM-DD'
	,PF_VCTO_MN_NEW						DATE FORMAT 'YYYY-MM-DD'
	,PF_VCTO_MN_KT_NEW					DATE FORMAT 'YYYY-MM-DD'
	,PE_LCG_VIGENTE						INTEGER
	,PE_LPUNTUAL_VIGENTE				INTEGER
	,PE_DISPONIBLE_MN_NEW				BIGINT
	,PF_VCTO_MX_NEW				  		DATE FORMAT 'YYYY-MM-DD'
	,PE_DISPONIBLE_MX_NEW				BIGINT
	,PD_PROPENSION_MN					DECIMAL(25,10)
	,PC_BANCA	 						CHAR(3)  CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_NOM_CLI       					VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_MACRO_BANCA     				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_PLATAFORMA						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_REGIONAL						VARCHAR(60) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_EJE								CHAR(12) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_MATRIZ_VULNERABILIDAD			VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_SECTOR							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_MACRO_SECTOR_CORRECTO			VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_PERSPECTIVA_SECTORIAL			VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_PAR_VCTO_LINEA					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_CURSE_ULT_3M					INTEGER
	,PE_CLIENTE_CON_VCTO				INTEGER
	,PE_DDA_A_LIBERAR_MES 				BIGINT 
	,PE_MTO_CURSE_ULT_3M 				BIGINT
	,PE_FLG_EXCLUSION					INTEGER
	,PC_MOTIVO_EXCLUSION				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PLAN_PROYECTOS					INTEGER
	,PE_MONTO_PLAN_PROY					BIGINT
	,PF_FECHA_PLAN_PROY					DATE FORMAT 'YYYY-MM-DD'
	,PC_NEGOCIO							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_PRODUCTO 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_EJE_CREADOR 					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_VST_ID							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_YA_CAMPANADO_PLAN_PROY			INTEGER 
	,PC_TEXTO_PROY						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO1							VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO2  						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO3  						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_CAPACITY						INTEGER
	,PE_EN_PLANEAMIENTO					INTEGER 			
    ,PC_CALIFICACION_SBIF          		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,PF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,PD_PI_CLIENTE                		DECIMAL(25,10)			
	,PC_CLASIFICACION_SBIF       		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,PE_FDR                      		INTEGER 			
	,PE_COS_CLI                 		INTEGER 			
	,PE_FILTROS_RIESGOS          		INTEGER 			
	,PC_PAR_CALIFICACION_SBIF    		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
	,PD_PAR_PI_CLIENTE           		DECIMAL(25,10)		
	,PE_PAR_FDR                  		INTEGER 			
	,PE_PAR_COS_CLI             		INTEGER 			
	,PE_MOLESTO               			INTEGER 			
	,PE_CARGABLE						INTEGER
	,PC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_RANK							INTEGER
	,PE_DISPONIBLE_OK               	INTEGER
	,PE_RNK_ORDEN                 		INTEGER
	,PE_A_CARGAR                 		INTEGER
	,PE_DIPONIBLE_OK             		INTEGER
	,PE_CON_MANDATO             		INTEGER
	,PE_ENROLADO_360            		INTEGER
	,PE_HABILITADO_360           		INTEGER
	,PE_ACTIVO_360               		INTEGER
	,PE_ESTADO_MULTIPASS        		INTEGER
	,PE_MANDATO_CCL              		INTEGER
	,PE_SIN_APR                 		INTEGER
	,PE_ART85                     		INTEGER
	,PE_FYP                    			INTEGER
	,PE_READY_CCL              			INTEGER
	,PE_ACTIVAR_360              		INTEGER
	,PE_TOTAL_HABILITADORES       		INTEGER
	,PC_FECHA_HAB 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
	,PE_CMP_MANDATO_CCL					INTEGER
	,PE_CMP_CTO_BEX						INTEGER
	,PE_CMP_MIGRACION               	INTEGER
	,PE_CMP_PROPENSO_MX             	INTEGER
	,PE_CMP_FOGAPE_REACTIVA         	INTEGER
	,PE_PRIORIDAD                   	INTEGER
	,PE_MTO_CMP    						BIGINT
    ,PC_COD_CMP							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PERIODO_CMP						INTEGER
	,PF_FECHA_CARGA_CMP					DATE FORMAT 'YYYY-MM-DD'
	,PE_RANKING							INTEGER
	,PE_DECIL							INTEGER
	,PE_GEST_RCH_U3M					INTEGER
	,PE_REPITENCIA						INTEGER
	,PE_RCHMX							INTEGER
)PRIMARY INDEX ( PE_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 55;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
SELECT 
	 MPO.IE_RUT 										AS PE_RUT 					
	,MPO.ID_DISPONIBLE_MN								AS PD_DISPONIBLE_MN			
	,MPO.ID_DISPONIBLE_MX								AS PD_DISPONIBLE_MX			
	,MPO.IC_VCTO_MN										AS PC_VCTO_MN						
	,MPO.IC_VCTO_MX										AS PC_VCTO_MX					
	,MPO.IC_CLUSTER										AS PC_CLUSTER					
	,MPO.IC_TOQUE_4T									AS PC_TOQUE_4T				
	,MPO.IE_PROPENSO_MN									AS PE_PROPENSO_MN				
	,MPO.IE_PROPENSO_MX									AS PE_PROPENSO_MX				
	,MPO.IC_NOMBRE_SEGMENTO								AS PC_NOMBRE_SEGMENTO			
	,MPO.IC_CLUSTER_AGREGADO							AS PC_CLUSTER_AGREGADO		
	,MPO.IE_CLUSTER_DCP_MM								AS PE_CLUSTER_DCP_MM			
	,MPO.IE_POTENCIAL_VISTAS_MM							AS PE_POTENCIAL_VISTAS_MM		
	,MPO.IE_POTENCIAL_VISTAS_MM_LP						AS PE_POTENCIAL_VISTAS_MM_LP	
	,MPO.IC_RECOMENDACION_DE_CRUCE						AS PC_RECOMENDACION_DE_CRUCE	
	,CASE WHEN COALESCE(MPO.IC_NOMBRE_SEGMENTO, '') 
		IN (
		 '02 - DEUDA'
		,'06 - DEUDA/COMEX'
		,'06 - DEUDA/S&T-OP'
		,'07 - DEUDA/CASH'
		,'08 - DEUDA/FACTORING'
		,'13 - NO COMEX'
		,'13 - NO S&T-OP'
		,'14 - NO CONFIRMING'
		,'14 - NO FACTORING'
		,'15 - NO CASH'
		,'16 - MULTIPRODUCTO')
			THEN 1 
			ELSE 0 
	 END 											AS PE_PO_DEUDA
	,CASE WHEN CCT.TE_RUT IS NOT NULL
			THEN 1
			ELSE 0
	 END 											AS PE_CTACTE
	,MLN.TF_FEC_MAX_LIN 							AS PF_FECHA_LINEAS
	,LIN.TF_FECHA_VCTO 								AS PF_VCTO_MN_NEW
	,LIN.TF_VCTO_KT_MN 								AS PF_VCTO_MN_KT_NEW
	,CASE WHEN LIN.TF_FECHA_VCTO >= PAR.TF_VCTO_LINEA 
			THEN 1 
			ELSE 0 
	 END 											AS PE_LCG_VIGENTE
	,CASE WHEN LIN.TF_VCTO_KT_MN >= PAR.TF_VCTO_LINEA 
			THEN 1 
			ELSE 0 
	 END 											AS PE_LPUNTUAL_VIGENTE
	,COALESCE(LIN.TE_DCP, 0)						AS PE_DISPONIBLE_MN_NEW
	,LIN.TF_VCTO_LME								AS PF_VCTO_MX_NEW
	,COALESCE(LIN.TE_LME, 0) 						AS PE_DISPONIBLE_MX_NEW
	,COALESCE(PRP.TD_PROPENSION_CREDITO_COMERCIAL,0)	AS PD_PROPENSION_MN
	,CEJ.IC_BANCA 									AS PC_BANCA 		
	,CEJ.IC_NOM_CLI    								AS PC_NOM_CLI     
	,CEJ.IC_MACRO_BANCA								AS PC_MACRO_BANCA 
	,CEJ.IC_PLATAFORMA								AS PC_PLATAFORMA	
	,CEJ.IC_REGIONAL								AS PC_REGIONAL	
	,CEJ.IC_EJE										AS PC_EJE			
	,MVU.SC_GRUPO_MATRIZ_VULNERABILIDAD				AS PC_MATRIZ_VULNERABILIDAD
	,PPS.SC_SECTOR									AS PC_SECTOR				
	,PPS.SC_MACRO_SECTOR_CORRECTO					AS PC_MACRO_SECTOR_CORRECTO
	,UPPER(PPS.SC_PERSPECTIVA_SECTORIAL)			AS PC_PERSPECTIVA_SECTORIAL
	,PAR.TF_VCTO_LINEA								AS PC_PAR_VCTO_LINEA
	,CASE WHEN C3M.TE_RUT IS NULL 
			THEN 0 
			ELSE 1 
	 END 											AS PE_CURSE_ULT_3M
	,CASE WHEN COV.TE_RUT IS NULL 
			THEN 0 
			ELSE 1 
	 END 											AS PE_CLIENTE_CON_VCTO
	,COALESCE(COV.TE_MTO_CREDITO_PESOS,0)			AS PE_DDA_A_LIBERAR_MES
	,COALESCE(C3M.TE_MTO_CREDITO_PESOS,0)			AS PE_MTO_CURSE_ULT_3M
	,CASE WHEN EXC.TE_RUT IS NULL 
			THEN 0 
			ELSE 1 
	 END 											AS PE_FLG_EXCLUSION
	,COALESCE(EXC.TC_MOTIVO,'')						AS PC_MOTIVO_EXCLUSION
	,0 												AS PE_PLAN_PROYECTOS
	,0 												AS PE_MONTO_PLAN_PROY
	,NULL 											AS PF_FECHA_PLAN_PROY
	,NULL											AS PC_NEGOCIO
	,NULL 											AS PC_PRODUCTO
	,NULL 											AS PC_EJE_CREADOR
	,NULL											AS PC_VST_ID
	,0 												AS PE_YA_CAMPANADO_PLAN_PROY
	,'' 											AS PC_TEXTO_PROY
	,''												AS PC_TEXTO1
	,''												AS PC_TEXTO2
	,''												AS PC_TEXTO3
	,999											AS PE_CAPACITY
	,0				 								AS PE_EN_PLANEAMIENTO
    ,NULL  											AS PC_CALIFICACION_SBIF
	,NULL 											AS PF_PERIODO_CALIFICACION 
	,NULL 											AS PD_PI_CLIENTE 
	,NULL 											AS PC_CLASIFICACION_SBIF 
	,0  											AS PE_FDR 
	,0  											AS PE_COS_CLI 
	,0  											AS PE_FILTROS_RIESGOS
	,NULL 											AS PC_PAR_CALIFICACION_SBIF 
	,NULL 											AS PD_PAR_PI_CLIENTE 
	,NULL 											AS PE_PAR_FDR 
	,NULL 											AS PE_PAR_COS_CLI 
	,0  											AS PE_MOLESTO 
	,0 												AS PE_CARGABLE
    ,''												AS PC_ELIMINADO	
	,0 												AS PE_RANK
	,0 												AS PE_DISPONIBLE_OK
	,0 												AS PE_RNK_ORDEN
	,0 												AS PE_A_CARGAR
	,0 												AS PE_DIPONIBLE_OK
	,0 												AS PE_CON_MANDATO
	,0 												AS PE_ENROLADO_360
	,0 												AS PE_HABILITADO_360
	,0 												AS PE_ACTIVO_360
	,0 												AS PE_ESTADO_MULTIPASS
	,0 												AS PE_MANDATO_CCL
	,0 												AS PE_SIN_APR
	,0 												AS PE_ART85
	,0 												AS PE_FYP
	,0 												AS PE_READY_CCL
	,0 												AS PE_ACTIVAR_360
	,0 												AS PE_TOTAL_HABILITADORES
	,''												AS PC_FECHA_HAB
	,0 												AS PE_CMP_MANDATO_CCL
	,0 												AS PE_CMP_CTO_BEX
	,0 												AS PE_CMP_MIGRACION
	,0 												AS PE_CMP_PROPENSO_MX
	,0 												AS PE_CMP_FOGAPE_REACTIVA
	,99 											AS PE_PRIORIDAD
	,0							 					AS PE_MTO_CMP
	,''							  					AS PC_COD_CMP
	,PAR.TE_PERIODO_CMP								AS PE_PERIODO_CMP
	,PAR.TF_FECHA_CRG								AS PF_FECHA_CARGA_CMP
	,COALESCE(PRP.TE_RANKING,99999)					AS PE_RANKING
	,COALESCE(PRP.TE_DECIL,11)						AS PE_DECIL
	,COALESCE(SEG.TE_GEST_RCH_U3M,0)				AS PE_GEST_RCH_U3M
	,CASE 
		WHEN SEG.TE_REPITENCIA =1 
		THEN 1 ELSE 0 
	END   											AS PE_REPITENCIA
	,CASE 
		WHEN SEG.TE_RCHMX = 1 
		THEN 1 ELSE 0 
	END												AS PE_RCHMX
FROM
	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO AS MPO
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO AS PAR
		ON 1=1
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CANT_CCTE AS CCT
		ON MPO.IE_RUT = CCT.TE_RUT
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MOD_PROPENSION AS PRP
		ON MPO.IE_RUT = PRP.TE_RUT
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_LINEAS AS LIN
		ON MPO.IE_RUT = LIN.TE_RUT
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MAX_FEC_LIN AS MLN
		ON 1=1
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CLIENTE_EJECUTIVO AS CEJ
		ON MPO.IE_RUT = CEJ.IE_CLI_RUT
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_MATRIZ_VULNERABILIDAD AS MVU
		ON MPO.IE_RUT = MVU.SE_RUT
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_PERSPECTIVAS_SECTORIALES AS PPS
		ON MPO.IE_RUT = PPS.SE_RUT
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CURSES_3M AS C3M
		ON MPO.IE_RUT = C3M.TE_RUT
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_COVID AS COV
		ON MPO.IE_RUT = COV.TE_RUT
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_EXCLUSION AS EXC
		ON MPO.IE_RUT = EXC.TE_RUT
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_SEG_EMPRESA AS SEG
		ON MPO.IE_RUT = SEG.TE_RUT
		
	
;
.IF ERRORCODE <> 0 THEN .QUIT 56;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES;	
.IF ERRORCODE <> 0 THEN .QUIT 57;

--/***********************************************************************
--**        SE CREA TABLA TEMPORAL PARA RUT UNICOS                      **  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_RUT_UNICOS;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_RUT_UNICOS
(
     TE_RUT				INTEGER
    ,TC_ORD_NEGOCIO		VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ORD_ESTADO		VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MONTO			BIGINT
	,TF_FECHA_FIN		DATE FORMAT 'YYYY-MM-DD'
	,TC_NEGOCIO			VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_PRODUCTO 		VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_CREADOR 	VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_VST_ID			VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC	
)	
PRIMARY INDEX ( TE_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 58;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_RUT_UNICOS
SELECT
	 PPR.TE_RUT            		AS    TE_RUT
	,CASE
		WHEN PPR.TC_NEGOCIO='Colocación'
		THEN 'A'
		ELSE 'Z'
	END 						AS TC_ORD_NEGOCIO
	,CASE
		WHEN PPR.TC_ESTADO = 'Activa'
		THEN 'A'
		WHEN PPR.TC_ESTADO = 'Ganada'
		THEN 'B'
		WHEN PPR.TC_ESTADO = 'Cancelada'
		THEN 'C'
	END 						AS TC_ORD_ESTADO
	,PPR.TE_MONTO 				AS TE_MONTO	
	,PPR.TF_FECHA_FIN	        AS TF_FECHA_FIN	
	,PPR.TC_NEGOCIO		        AS TC_NEGOCIO		
	,PPR.TC_PRODUCTO 	        AS TC_PRODUCTO 	
	,PPR.TC_EJE_CREADOR         AS TC_EJE_CREADOR 
	,PPR.TC_VST_ID		        AS TC_VST_ID		
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS AS PPR
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO AS PAR 
	ON CAST(CAST(CAST(PPR.TF_FECHA_FIN AS FORMAT 'YYYYMMDD') AS CHAR(6)) AS INTEGER) BETWEEN PAR.TE_PERIODO_CMP AND PAR.TE_PERIODO_CMP_MAS_1
QUALIFY ROW_NUMBER() OVER (PARTITION BY PPR.TE_RUT ORDER BY PPR.TC_NEGOCIO, PPR.TC_ESTADO, TE_MONTO DESC)=1
;
.IF ERRORCODE <> 0 THEN .QUIT 59;

--/***********************************************************************
--**                        SE APLICAN COLLECTS                         **  
--***********************************************************************/    
COLLECT STATS INDEX ( TE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_RUT_UNICOS;
.IF ERRORCODE <> 0 THEN .QUIT 60;

--/***********************************************************************
--**        SE CREA TABLA TEMPORAL PLAN_PROY                      **  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_PLAN_PROY;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_PLAN_PROY
(
     TE_RUT				INTEGER
	,TC_GESTION 			VARCHAR(5) CHARACTER SET LATIN NOT CASESPECIFIC
)	
PRIMARY INDEX ( TE_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 61;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_PLAN_PROY
SELECT 
	 RUT			AS TE_RUT
	,GESTION 		AS TC_GESTION
FROM 
	EDM_DMSEGTO_VW.IN_SEGUIMIENTO_EMPRESA
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO AS PAR
	ON  TO_CHAR(FECHA_INICIO,'YYYYMM') BETWEEN TO_CHAR(PAR.TF_FECHA_CRG - INTERVAL '30' DAY,'YYYYMM') AND TO_CHAR(PAR.TF_FECHA_CRG - INTERVAL '1' DAY,'YYYYMM') 
WHERE 
	(POSITION ('PLAN' IN CAMPANA) > 0)
	AND (POSITION ('INVERSION' IN CAMPANA) > 0)
	AND ORIGEN = 'WHOLESALE'
QUALIFY ROW_NUMBER() OVER(PARTITION BY RUT ORDER BY FECHA_INICIO DESC)=1
;
.IF ERRORCODE <> 0 THEN .QUIT 62;

--/***********************************************************************
--**                        SE APLICAN COLLECTS                         **  
--***********************************************************************/    
COLLECT STATS INDEX ( TE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_PLAN_PROY;
.IF ERRORCODE <> 0 THEN .QUIT 63;


--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPO PLAN_PROYECTOS, MONTO_PLAN_PROY, FECHA_PLAN_PROY, NEGOCIO	  **
--** PRODUCTO, EJE_CREADOR, VST_ID                                        **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_RUT_UNICOS AS RUU
SET	
	 PE_PLAN_PROYECTOS = 1 
	,PE_MONTO_PLAN_PROY = RUU.TE_MONTO
	,PF_FECHA_PLAN_PROY = RUU.TF_FECHA_FIN
	,PC_NEGOCIO = RUU.TC_NEGOCIO
	,PC_PRODUCTO = RUU.TC_PRODUCTO
	,PC_EJE_CREADOR = RUU.TC_EJE_CREADOR
	,PC_VST_ID = RUU.TC_VST_ID
WHERE
	PE_RUT = RUU.TE_RUT 
;
.IF ERRORCODE <> 0 THEN .QUIT 64;
--/*************************************************************************
--** SE ACTUALIZA 	YA CAMPANADO PLAN PROYECTO	  **  
--**   **
--*************************************************************************/

UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
FROM	
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_PLAN_PROY AS PLN
SET 
	PE_YA_CAMPANADO_PLAN_PROY = 1 
WHERE 
	PE_RUT = PLN.TE_RUT
	AND NOT(COALESCE(PLN.TC_GESTION,'') = '')
	AND NOT(COALESCE(PLN.TC_GESTION,'') = 'AGN')
;
.IF ERRORCODE <> 0 THEN .QUIT 65;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES;	
.IF ERRORCODE <> 0 THEN .QUIT 66;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;

UPDATE - Ejemplo 5 OK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: SACA PUBLICO OBJETIVO PARA CAMPANA PROPENSOS MN PLAN PROYECTOS  	          **
--**                                                    				 				  **
--** AUTOR  : FRANCISCO PINOCHET                                               	  		  **
--** EMPRESA: FACTORIT                                   				  				  **
--** FECHA  : 03/2024                                                   				  **
--/*****************************************************************************************
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 08/2024			     	                                                  **
--/*****************************************************************************************
--/*****************************************************************************************
--**TABLA DE ENTRADA:	  															      **
--**					MKT_EXPLORER_TB.PBI_WHOLESALE_APP_OPORTUNIDAD                     **
--**					EDM_DMSEGTO_VW.IN_SEGUIMIENTO_EMPRESA                             **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO                    	  	  **
--**					MKT_EXPLORER_TB.CRM_DATOS_DATAMART_HAB_PYME                       **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_EXCLUSIONES_PUNTUALES_MES     	  **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MARCA_CURSES_CREDITOS_COVID_VENCIMIENTO**
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CTAS_CTES_MN             	  	  **
--**					MKT_CRM_CMP_TB.TBL_LCG                                            **
--**					MKT_EXPLORER_TB.VENTA_DIARIA_COL                                  **
--**					EDW_VW.AGREEMENT                                                  **
--**					MKT_CRM_ANALYTICS_TB.P_WSL_MENSUAL_1A_MASIVA_CC                   **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS                  	  **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CLIENTE_EJECUTIVO        	  	  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_MATRIZ_VULNERABILIDAD         	  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_PERSPECTIVAS_SECTORIALES	  	  **
--**					MKT_CRM_CMP_TB.CRM_BASE_BYPASS_SEGUIMIENTO_AIRFLOW				  **

--**TABLA TEMPORAL:
--**		 {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CAMPANA
--**		 {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CANT_CCTE
--**		 {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_COVID
--**		 {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_EXCLUSION
--**		 {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CURSES_3M
--**		 {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_3M
--**		 {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_MX
--**		 {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_LINEAS
--**		 {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MAX_FEC_LIN
--**		 {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MOD_PROPENSION
--**		 {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO
--**		 {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS
--**		 {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_REPITENCIA
--**		 {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_SEG_EMPRESA
--**		 {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_TIPOS_VTA
--**             																		  **
--**TABLA DE SALIDA:    
--**		{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_PO
--**                  														              **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/************************************************************
--** CREA TABLA TEMPORAL CON PARAMETROS DE EJECUCION	     **  
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO
(
	 TE_PERIODO_CMP			INTEGER
	,TF_FECHA_CMP			DATE FORMAT 'YYYY-MM-DD'
	,TF_FECHA_CRG			DATE FORMAT 'YYYY-MM-DD'
	,TF_VCTO_LINEA			DATE FORMAT 'YYYY-MM-DD'
	,TF_FECHA_INI			DATE FORMAT 'YYYY-MM-DD'
	,TF_FECHA_FIN			DATE FORMAT 'YYYY-MM-DD'
	,TE_PERIODO_INI			INTEGER
	,TE_PERIODO_FIN			INTEGER
	,TE_PERIODO_CMP_MAS_1	INTEGER
	,TF_FEC_MES_ATRAS_1M	DATE FORMAT 'YYYY-MM-DD'
	,TF_FEC_MES_ATRAS_3M	DATE FORMAT 'YYYY-MM-DD'
	,TF_FEC_MES_ATRAS_6M	DATE FORMAT 'YYYY-MM-DD'
	,TE_PER_MES_ATRAS_1M	INTEGER
	,TE_PER_MES_ATRAS_3M	INTEGER
	,TE_PER_MES_ATRAS_6M	INTEGER
)
PRIMARY INDEX ( TE_PERIODO_CMP )
;
.IF ERRORCODE <> 0 THEN .QUIT 1;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO
SELECT 
	 SE_PERIODO_CMP 					AS TE_PERIODO_CMP
	,SF_FECHA_REF_DIA 					AS TF_FECHA_CMP
	,SF_FECHA_CARGA 					AS TF_FECHA_CRG	
	,SF_VCTO_LINEA						AS TF_VCTO_LINEA
	,SF_FECHA_MENOS_3M					AS TF_FECHA_INI
	,SF_FECHA_REF_DIA_FIN				AS TF_FECHA_FIN
	,SE_PERIODO_CMP 					AS TE_PERIODO_INI
	,CAST(CAST(CAST(ADD_MONTHS(SF_FECHA_REF_DIA, 2) AS FORMAT 'YYYYMMDD') AS VARCHAR(6)) AS INTEGER) AS TE_PERIODO_FIN
	,SE_PERIODO_MAS_2M					AS TE_PERIODO_CMP_MAS_1
	,ADD_MONTHS(CAST((CAST(SE_PERIODO_CMP AS CHAR(6)) || '01') AS DATE FORMAT 'YYYYMMDD'),-1) AS TF_FEC_MES_ATRAS_1M
	,ADD_MONTHS(CAST((CAST(SE_PERIODO_CMP AS CHAR(6)) || '01') AS DATE FORMAT 'YYYYMMDD'),-3) AS TF_FEC_MES_ATRAS_3M
	,ADD_MONTHS(CAST((CAST(SE_PERIODO_CMP AS CHAR(6)) || '01') AS DATE FORMAT 'YYYYMMDD'),-6) AS TF_FEC_MES_ATRAS_6M
	,CAST(CAST(CAST(TF_FEC_MES_ATRAS_1M AS DATE FORMAT 'YYYYMMDD') AS CHAR(6)) AS INTEGER) AS TE_PER_MES_ATRAS_1M
	,CAST(CAST(CAST(TF_FEC_MES_ATRAS_3M AS DATE FORMAT 'YYYYMMDD') AS CHAR(6)) AS INTEGER) AS TE_PER_MES_ATRAS_3M
	,CAST(CAST(CAST(TF_FEC_MES_ATRAS_6M AS DATE FORMAT 'YYYYMMDD') AS CHAR(6)) AS INTEGER) AS TE_PER_MES_ATRAS_6M
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO;
	
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/************************************************************
--** CREA TABLA TEMPORAL SACO PROPENSION MODELO ANALITYCS    **  
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MOD_PROPENSION;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MOD_PROPENSION
(
	 TE_PERIODO_REF 							INTEGER
	,TE_MES_REF 								INTEGER
	,TD_RUT 									DECIMAL(8,0)
	,TE_MONTO_COMERCIAL 						INTEGER
	,TD_PROPENSION_CREDITO_COMERCIAL 			DECIMAL(25,10)
	,TD_PROBABILIDAD_REAL_CREDITO_COMERCIAL 	DECIMAL(6,5)
	,TD_MONTO_ESPERADO 							DECIMAL(15,5)
	,TE_RANKING									INTEGER
	,TE_DECIL									INTEGER
	
)PRIMARY INDEX ( TE_PERIODO_REF ,TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MOD_PROPENSION
SELECT 
	 MAC.PE_ANOMES_REF								AS	TE_PERIODO_REF							
	,MAC.PE_MES_REF 							    AS  TE_MES_REF 							
    ,MAC.PD_RUT 								    AS  TD_RUT 								
    ,MAC.PE_MONTO_COMERCIAL 					    AS  TE_MONTO_COMERCIAL 					
    ,MAC.PD_PROPENSION_CREDITO_COMERCIAL 		    AS  TD_PROPENSION_CREDITO_COMERCIAL 		
    ,MAC.PD_PROBABILIDAD_REAL_CREDITO_COMERCIAL     AS  TD_PROBABILIDAD_REAL_CREDITO_COMERCIAL 
	,MAC.PD_MONTO_ESPERADO                          AS  TD_MONTO_ESPERADO 
	,(ROW_NUMBER() OVER (partition by MAC.PE_ANOMES_REF ORDER BY MAC.Pd_PROPENSION_CREDITO_COMERCIAL desc, MAC.PE_MONTO_COMERCIAL desc, MAC.PD_RUT) - 1) AS TE_RANKING
	,(ROW_NUMBER() OVER (partition by MAC.PE_ANOMES_REF ORDER BY MAC.Pd_PROPENSION_CREDITO_COMERCIAL desc, MAC.PE_MONTO_COMERCIAL desc, MAC.PD_RUT) - 1) * 10 / COUNT(*) OVER(partition by MAC.PE_ANOMES_REF) +1 AS TE_DECIL		

FROM 
	MKT_CRM_ANALYTICS_TB.P_WSL_MENSUAL_1A_MASIVA_CC MAC
;
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/***********************************************************************
--**                    SE APLICAN COLLECTS                             **
--***********************************************************************/
COLLECT STATS INDEX ( TE_PERIODO_REF ,TD_RUT  )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MOD_PROPENSION;
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/************************************************************
--** CREA TABLA TEMPORAL PARA CODIGOS TIPO VENTA             **  
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_TIPOS_VTA;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_TIPOS_VTA
(
	TC_COD_TPO_VTA		VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
)
PRIMARY INDEX ( TC_COD_TPO_VTA )
;
.IF ERRORCODE <> 0 THEN .QUIT 7;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_TIPOS_VTA VALUES ('COM');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_TIPOS_VTA VALUES ('AVC');
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/***********************************************************************
--**                    SE APLICAN COLLECTS                             **
--***********************************************************************/
COLLECT STATS INDEX ( TC_COD_TPO_VTA )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_TIPOS_VTA;
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/************************************************************
--** CREA TABLA TEMPORAL PARA CURSES 3 MESES                 **  
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CURSES_3M;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CURSES_3M
(
	 TD_RUT 					DECIMAL(8,0)
	,TE_MTO_CREDITO_PESOS		BIGINT
)PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 10;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CURSES_3M
SELECT 
	 VTA.RUT									AS	TD_RUT
	,SUM(CAST(VTA.MTO_CREDITO_PESOS AS BIGINT))	AS	TE_MTO_CREDITO_PESOS
FROM
	MKT_EXPLORER_TB.VENTA_DIARIA_COL VTA
	INNER JOIN EDW_VW.AGREEMENT AGR
		ON AGR.ACCOUNT_NUM = VTA.OPERACION
			AND AGR.ACCOUNT_OPEN_DT = VTA.FECHA_ACTIVACION
			AND AGR.CONTRACT_EXPIRATION_DT = VTA.FECHA_MAX_VCTO
			AND VTA.ESTADO = 'A'
			AND AGR.ACCT_STATUS_TYPE_CD = 1
			AND VTA.CUOTA <= 12
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_TIPOS_VTA CTV
		ON VTA.TIPO = CTV.TC_COD_TPO_VTA
	INNER JOIN 	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO PAR
		ON TRUNC (VTA.FECHA_CUR_RE,'MON') BETWEEN PAR.TF_FECHA_INI AND PAR.TF_FECHA_FIN
GROUP BY
	 VTA.RUT	
;
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/***********************************************************************
--**                    SE APLICAN COLLECTS                             **
--***********************************************************************/
COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CURSES_3M;
.IF ERRORCODE <> 0 THEN .QUIT 12;

--/************************************************************
--**       CREA TABLA TEMPORAL PARA SACAR LINEAS			 **  
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_LINEAS;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_LINEAS
(
	 TF_FECHA_PROCESO 		DATE FORMAT 'YYYY-MM-DD'
    ,TD_RUT 				DECIMAL(8,0)
    ,TE_DCP 				BIGINT
    ,TE_LME 				BIGINT
    ,TF_FECHA_VCTO 			DATE FORMAT 'YYYY-MM-DD'
    ,TF_VCTO_LME 			DATE FORMAT 'YYYY-MM-DD'
    ,TF_VCTO_KT_MN 			DATE FORMAT 'YYYY-MM-DD'
    ,TF_VCTO_LBG 			DATE FORMAT 'YYYY-MM-DD')
PRIMARY INDEX ( TF_FECHA_PROCESO, TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 13;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_LINEAS
SELECT
	 FECHA_PROCESO		AS TF_FECHA_PROCESO 	
	,RUT                AS TD_RUT 			
	,DCP                AS TE_DCP 			
	,LME                AS TE_LME 			
	,FECHA_VCTO         AS TF_FECHA_VCTO 		
	,VCTO_LME           AS TF_VCTO_LME 		
	,VCTO_KT_MN         AS TF_VCTO_KT_MN 		
	,VCTO_LBG           AS TF_VCTO_LBG	
FROM 
	MKT_CRM_CMP_TB.TBL_LCG 
WHERE 
	RUT >= 50000000
;
.IF ERRORCODE <> 0 THEN .QUIT 14;

--/***********************************************************************
--**                    SE APLICAN COLLECTS                             **
--***********************************************************************/
COLLECT STATS INDEX ( TF_FECHA_PROCESO, TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_LINEAS;
.IF ERRORCODE <> 0 THEN .QUIT 15;

--/***********************************************************************
--**	SE CREA TABLA TEMPO PARA MAXIMA FECHA DE LINEAS					**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MAX_FEC_LIN;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MAX_FEC_LIN
(
	 TF_FEC_MAX_LIN	DATE FORMAT 'YYYY-MM-DD'
)
PRIMARY INDEX ( TF_FEC_MAX_LIN )
;
.IF ERRORCODE <> 0 THEN .QUIT 16;

INSERT {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MAX_FEC_LIN
SELECT 
	MAX(TF_FECHA_PROCESO) 	AS TF_FEC_MAX_LIN
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_LINEAS
;
.IF ERRORCODE <> 0 THEN .QUIT 17;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TF_FEC_MAX_LIN)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MAX_FEC_LIN;
.IF ERRORCODE <> 0 THEN .QUIT 18;

--/*************************************************************************
--**SE CREA TABLA TEMPORAL QUE CONTABILIZA CANTIDAD DE CUENTAS CORRIENTES **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CANT_CCTE;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CANT_CCTE
(
	 TD_RUT 							DECIMAL(8,0)
)
PRIMARY INDEX ( TD_RUT );
.IF ERRORCODE <> 0 THEN .QUIT 19;

INSERT {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CANT_CCTE
SELECT
	 IE_RUT		AS TD_RUT
FROM
	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CTAS_CTES_MN
GROUP BY TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 20;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CANT_CCTE;
.IF ERRORCODE <> 0 THEN .QUIT 21;

--/***********************************************************************
--** SE CREA TABLA TEMPORAL QUE CONTABILIZA CURSES DE CREDITOS COVID	**  
--***********************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_COVID;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_COVID
(
	 TD_RUT 					DECIMAL(8,0)
	,TE_MTO_CREDITO_PESOS		BIGINT
)
PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 22;

INSERT {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_COVID
SELECT
	 MCC.IE_RUT		AS TD_RUT
	,SUM(CAST(MCC.IE_MTO_CREDITO_PESOS AS BIGINT))	AS	TE_MTO_CREDITO_PESOS
FROM 
	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MARCA_CURSES_CREDITOS_COVID_VENCIMIENTO MCC
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO PAR
		ON MCC.IE_PERIODO_VENCIMIENTO = PAR.TE_PERIODO_CMP
			AND MCC.IC_ETIQUETA_CREDITO = 'OTRO'
			AND MCC.IE_CUOTA <= 12
GROUP BY 
	TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 23;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_COVID;
.IF ERRORCODE <> 0 THEN .QUIT 24;

--/***********************************************************************
--**SE CREA TABLA TEMPORAL QUE 	REGISTRA EXCLUSIONES PUNTUALES MESES	**  
--***********************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_EXCLUSION;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_EXCLUSION
(
	 TD_RUT 					DECIMAL(8,0)
	,TC_MOTIVO					VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
)
PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 25;

INSERT {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_EXCLUSION
SELECT
	 EXC.SE_RUT		AS TD_RUT
	,EXC.SC_MOTIVO	AS TC_MOTIVO
FROM 
	MKT_JOURNEYBUILDER_TB.S_CMP_EXT_EXCLUSIONES_PUNTUALES_MES EXC
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO PAR
		ON EXC.SE_PERIODO_CMP = PAR.TE_PERIODO_CMP
			AND EXC.SC_MOTIVO = 'PLAN REGIONES AGRO' 
GROUP BY 
	 EXC.SE_RUT
	,EXC.SC_MOTIVO
;
.IF ERRORCODE <> 0 THEN .QUIT 26;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_EXCLUSION;
.IF ERRORCODE <> 0 THEN .QUIT 27;

--/***********************************************************************
--** SE CREA TABLA TEMPORAL PARA CODIGOS  CAMPANA PROPENSOS PARA BAQUERO    	**  
--***********************************************************************/
 DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CAMPANA;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CAMPANA
(
	TC_CAMPANA	VARCHAR(100)  CHARACTER SET LATIN NOT CASESPECIFIC
)
PRIMARY INDEX ( TC_CAMPANA )
;
.IF ERRORCODE <> 0 THEN .QUIT 28;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CAMPANA VALUES('Campana Clientes Propensos Mon Nacional');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CAMPANA VALUES('Campana Clientes Propensos Moneda Nacional');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CAMPANA VALUES('Campana Clientes Propensos Moneda Nacional Plan de Inversion');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CAMPANA VALUES('Campana Clientes con Potencial Deuda');
.IF ERRORCODE <> 0 THEN .QUIT 29;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
 COLLECT STATS INDEX ( TC_CAMPANA )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CAMPANA;
.IF ERRORCODE <> 0 THEN .QUIT 30;

--/***********************************************************************
--**	SE CREA TABLA TEMPORAL PARA DETECTAR A LOS CLIENTES QUE LLEVAN  **
--**    ACAMPAÑADOS 6 MESES  											**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_REPITENCIA;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_REPITENCIA
(
	TC_CAMPANA 				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_RUT					DECIMAL(8,0)
	,TE_VECES_CAMPANADO		INTEGER
	,TE_REPITENCIA			INTEGER
)
PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 31;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_REPITENCIA
SELECT
	 EMP.CAMPANA 							AS TC_CAMPANA
	,EMP.RUT 								AS TD_RUT
	,COUNT(EMP.RUT) 						AS TE_VECES_CAMPANADO
	,CASE WHEN TE_VECES_CAMPANADO = 6 
		THEN 1 
		ELSE 0 
	END 									AS TE_REPITENCIA
FROM EDM_DMSEGTO_VW.IN_SEGUIMIENTO_EMPRESA EMP
INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CAMPANA CMP
	ON EMP.CAMPANA = CMP.TC_CAMPANA
INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO PAR
	ON EMP.MES_INICIATIVA >= PAR.TE_PER_MES_ATRAS_6M
WHERE EMP.ORIGEN = 'WHOLESALE'
	AND EMP.CANAL_CAMPANA = 'Ejecutivo_Comercial'
	GROUP BY EMP.CAMPANA,EMP.RUT 
HAVING TE_REPITENCIA = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 32;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
 COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_REPITENCIA;
.IF ERRORCODE <> 0 THEN .QUIT 33;


--/***********************************************************************
--** TOMA LOS RUT QUE SERAN RECHAZADOS EN MONEDA NACIONAL
--** DEBEN SER CLIENTES QUE FUERON GENTIONADOS LOS ULTIMOS 3 MESES
--** CON UN DECIL MAYOR A 3
--***********************************************************************/	

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_3M;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_3M

(
 TD_RUT DECIMAL(8,0)
,TE_IND_RCH_MN INTEGER
)
PRIMARY INDEX ( TD_RUT );
.IF ERRORCODE <> 0 THEN .QUIT 34;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_3M
SELECT EMP.RUT AS TD_RUT
     , SUM(CASE WHEN GESTION IN ('RCH','NCA') AND COALESCE(TE_DECIL,0) > 3 
	 			THEN 1 
				ELSE 0 
	   END) AS TE_IND_RCH_MN
FROM EDM_DMSEGTO_VW.IN_SEGUIMIENTO_EMPRESA EMP
INNER JOIN 	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO PAR
		ON EMP.MES_INICIATIVA < PAR.TE_PERIODO_CMP
		AND EMP.MES_INICIATIVA >= PAR.TE_PER_MES_ATRAS_3M
LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MOD_PROPENSION DCL
	ON EMP.RUT = DCL.TD_RUT
GROUP BY EMP.RUT
HAVING TE_IND_RCH_MN > 0 
;

.IF ERRORCODE <> 0 THEN .QUIT 35;

 COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_3M;
.IF ERRORCODE <> 0 THEN .QUIT 36;


--/***********************************************************************
--** TOMA LOS RUT QUE SERAN RECHAZADOS EN MONEDA EXTRANJERA
--** DONDE SU LITERAL SEA Opera solo MX
--***********************************************************************/	

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_MX;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_MX

(
 TD_RUT DECIMAL(8,0)
,TE_IND_RCH_MX INTEGER
)
PRIMARY INDEX ( TD_RUT );
.IF ERRORCODE <> 0 THEN .QUIT 37;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_MX
SELECT EMP.RUT AS TD_RUT
	  ,SUM(CASE WHEN POSITION ('Opera solo MX' IN LITERAL_GESTION) > 0
	  			THEN 1
				ELSE 0
		END) AS TE_IND_RCH_MX
FROM EDM_DMSEGTO_VW.IN_SEGUIMIENTO_EMPRESA EMP
INNER JOIN 	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO PAR
	ON EMP.MES_INICIATIVA = PAR.TE_PER_MES_ATRAS_1M
WHERE EMP.CAMPANA = 'Campana Clientes Propensos Moneda Nacional'
GROUP BY TD_RUT
HAVING TE_IND_RCH_MX > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 38;

 COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_MX;
.IF ERRORCODE <> 0 THEN .QUIT 39;


--/***********************************************************************
--**   SEGUIMIENTO DE EMPRESA								    		
--**   CON LAS GESTIONES DE LOS ULT 3 MESES,OPERA SOLO EN MX
--**   Y REPITENCIAL
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_SEG_EMPRESA;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_SEG_EMPRESA
(
	 TC_MES_INICIATIVA			INTEGER
	,TC_CAMPANA 				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TD_RUT 					DECIMAL(8,0)
    ,TC_BANCA 					VARCHAR(3) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GESTION 				VARCHAR(5) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_FECHA_GESTION 			DATE FORMAT 'YYYY-MM-DD'
	,TE_GEST_RCH_U3M 			INTEGER
	,TE_REPITENCIA				INTEGER
	,TE_RCHMX					INTEGER 
)
PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 40;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_SEG_EMPRESA 
SELECT 
 	 EMP.MES_INICIATIVA															AS TC_MES_INICIATIVA
 	,EMP.CAMPANA																AS TC_CAMPANA 		
	,EMP.RUT                													AS TD_RUT 			
	,EMP.BANCA              													AS TC_BANCA 			
	,EMP.GESTION            													AS TC_GESTION 		
	,EMP.FECHA_GESTION      													AS TF_FECHA_GESTION 
	,CASE WHEN GMN.TD_RUT IS NOT NULL 
				THEN 1 
				ELSE 0 
	 END 																		AS TE_GEST_RCH_U3M 
	,CASE WHEN PMR.TD_RUT IS NOT NULL 
				THEN 1 
				ELSE 0 
	 END 																		AS TE_REPITENCIA  
	,CASE WHEN GMX.TD_RUT IS NOT NULL 
				THEN 1 
				ELSE 0 
	 END 	 																	AS TE_RCHMX
	 
FROM 
	EDM_DMSEGTO_VW.IN_SEGUIMIENTO_EMPRESA EMP
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CAMPANA CMP
		ON EMP.CAMPANA = CMP.TC_CAMPANA
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_3M GMN
		ON EMP.RUT = GMN.TD_RUT
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_GEST_MX GMX
		ON EMP.RUT = GMX.TD_RUT
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_REPITENCIA PMR
	ON EMP.RUT = PMR.TD_RUT
QUALIFY ROW_NUMBER () OVER ( PARTITION BY EMP.RUT ORDER BY EMP.MES_INICIATIVA DESC) =1
;
.IF ERRORCODE <> 0 THEN .QUIT 41;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_SEG_EMPRESA;
.IF ERRORCODE <> 0 THEN .QUIT 42;

--/***********************************************************************
--**         SE CREA TABLA TEMPORAL PARA PLAN_PROYECTOS                 **  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS
(
    TD_RUT					DECIMAL(8,0)
    ,TC_CAMPANA				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_GESTION				VARCHAR(5) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_BANCA				VARCHAR(3) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TF_FECHA_FIN			DATE FORMAT 'YYYY-MM-DD'
    ,TE_MES_OPORTUNIDAD		INTEGER
    ,TC_ESTADO        		VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_NEGOCIO    			VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_PRODUCTO 			VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MONTO            	BIGINT
    ,TC_EJE_CREADOR        	VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_VST_ID            	VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
)PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 43;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS
SELECT
	SEM.TD_RUT            	AS TD_RUT
	,SEM.TC_CAMPANA    		AS TC_CAMPANA
	,SEM.TC_GESTION    		AS TC_GESTION
	,SEM.TC_BANCA        	AS TC_BANCA
	,AOP.FECHA_FIN        	AS TF_FECHA_FIN
	,CAST(CAST(CAST(AOP.FECHA_FIN AS FORMAT 'YYYYMMDD') AS VARCHAR(6)) AS INTEGER)	AS TE_MES_OPORTUNIDAD
	,AOP.ESTADO            	AS TC_ESTADO
	,AOP.NEGOCIO            AS TC_NEGOCIO
	,AOP.PRODUCTO        	AS TC_PRODUCTO
	,AOP.MONTO              AS TE_MONTO
	,AOP.USR_ID_RESPONSABLE AS TC_EJE_CREADOR
	,AOP.VST_ID    			AS TC_VST_ID
FROM 
	MKT_EXPLORER_TB.PBI_WHOLESALE_APP_OPORTUNIDAD AOP
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_SEG_EMPRESA SEM
        ON AOP.RUT=SEM.TD_RUT
        AND AOP.FECHA_CREACION>=SEM.TF_FECHA_GESTION
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO PAR
		ON TE_MES_OPORTUNIDAD BETWEEN PAR.TE_PERIODO_INI AND PAR.TE_PERIODO_FIN
	WHERE
		TRIM(AOP.ESTADO)='ACTIVA'
		AND TRIM(AOP.NEGOCIO) = 'COLOCACIÓN'
;
.IF ERRORCODE <> 0 THEN .QUIT 44;
--/***********************************************************************
--**                        SE APLICAN COLLECTS                         **  
--***********************************************************************/    
COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS;
.IF ERRORCODE <> 0 THEN .QUIT 45;

--/***********************************************************************
--**        SE CREA TABLA TEMPORAL PARA RUT UNICOS                      **  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_RUT_UNICOS;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_RUT_UNICOS
(
     TD_RUT				DECIMAL(8,0)
    ,TC_ORD_NEGOCIO		VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TC_ORD_ESTADO		VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
    ,TE_MONTO			BIGINT
	,TF_FECHA_FIN		DATE FORMAT 'YYYY-MM-DD'
	,TC_NEGOCIO			VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_PRODUCTO 		VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_CREADOR 	VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_VST_ID			VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC	
)	
PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 46;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_RUT_UNICOS
SELECT
	 PPR.TD_RUT            		AS    TD_RUT
	,CASE
		WHEN PPR.TC_NEGOCIO='Colocación'
		THEN 'A'
		ELSE 'Z'
	END 						AS TC_ORD_NEGOCIO
	,CASE
		WHEN PPR.TC_ESTADO = 'Activa'
		THEN 'A'
		WHEN PPR.TC_ESTADO = 'Ganada'
		THEN 'B'
		WHEN PPR.TC_ESTADO = 'Cancelada'
		THEN 'C'
	END 						AS TC_ORD_ESTADO
	,PPR.TE_MONTO 				AS TE_MONTO	
	,PPR.TF_FECHA_FIN	        AS TF_FECHA_FIN	
	,PPR.TC_NEGOCIO		        AS TC_NEGOCIO		
	,PPR.TC_PRODUCTO 	        AS TC_PRODUCTO 	
	,PPR.TC_EJE_CREADOR         AS TC_EJE_CREADOR 
	,PPR.TC_VST_ID		        AS TC_VST_ID		
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS PPR
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO PAR 
	ON CAST(CAST(CAST(PPR.TF_FECHA_FIN AS FORMAT 'YYYYMMDD') AS CHAR(6)) AS INTEGER) BETWEEN PAR.TE_PERIODO_CMP 
	   AND PAR.TE_PERIODO_CMP_MAS_1
QUALIFY ROW_NUMBER() OVER (PARTITION BY PPR.TD_RUT ORDER BY PPR.TC_NEGOCIO, PPR.TC_ESTADO, TE_MONTO DESC)=1
;
.IF ERRORCODE <> 0 THEN .QUIT 47;

--/***********************************************************************
--**                        SE APLICAN COLLECTS                         **  
--***********************************************************************/    
COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_RUT_UNICOS;
.IF ERRORCODE <> 0 THEN .QUIT 48;

--/***********************************************************************
--**        SE CREA TABLA TEMPORAL PLAN_PROY_01		                    **  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_PLAN_PROY_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_PLAN_PROY_01
(
     TD_RUT				DECIMAL(8,0)
	,TC_GESTION 		VARCHAR(5) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CAMPANA			VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
)	
PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 49;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_PLAN_PROY_01
SELECT 
	 SEG.RUT			AS TD_RUT
	,SEG.GESTION 		AS TC_GESTION
	,SEG.CAMPANA 		AS TC_CAMPANA
FROM 
	EDM_DMSEGTO_VW.IN_SEGUIMIENTO_EMPRESA SEG
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO PAR
	ON  TO_CHAR(FECHA_INICIO,'YYYYMM') BETWEEN TO_CHAR(PAR.TF_FECHA_CRG - INTERVAL '30' DAY,'YYYYMM') 
	AND TO_CHAR(PAR.TF_FECHA_CRG - INTERVAL '1' DAY,'YYYYMM') 
WHERE 
	ORIGEN = 'WHOLESALE'
QUALIFY ROW_NUMBER() OVER(PARTITION BY RUT ORDER BY FECHA_INICIO DESC)=1
;
.IF ERRORCODE <> 0 THEN .QUIT 50;

--/***********************************************************************
--**                        SE APLICAN COLLECTS                         **  
--***********************************************************************/    
COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_PLAN_PROY_01;
.IF ERRORCODE <> 0 THEN .QUIT 51;

--/***********************************************************************
--**        SE CREA TABLA TEMPORAL PLAN_PROY                      		**  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_PLAN_PROY;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_PLAN_PROY
(
     TD_RUT				DECIMAL(8,0)
	,TC_GESTION 		VARCHAR(5) CHARACTER SET LATIN NOT CASESPECIFIC
)	
PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 52;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_PLAN_PROY
SELECT 
	 TD_RUT				AS TD_RUT
	,TC_GESTION 		AS TC_GESTION
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_PLAN_PROY_01 P01
WHERE 
	(POSITION ('PLAN' IN P01.TC_CAMPANA) > 0)
	AND (POSITION ('INVERSION' IN P01.TC_CAMPANA) > 0)
;
.IF ERRORCODE <> 0 THEN .QUIT 53;

--/***********************************************************************
--**                        SE APLICAN COLLECTS                         **  
--***********************************************************************/    
COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_PLAN_PROY;
.IF ERRORCODE <> 0 THEN .QUIT 54;

--/***********************************************************************
--**SE CREA TABLA TEMPORAL CON LA ACTUALIZACIÓN DE ALGUNOS CAMPOS   
--***********************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_01
(
	 TD_RUT 							DECIMAL(8,0)
	,TE_CTACTE							INTEGER
	,TF_VCTO_MN_NEW						DATE FORMAT 'YYYY-MM-DD'
	,TF_VCTO_MN_KT_NEW					DATE FORMAT 'YYYY-MM-DD'
	,TE_LCG_VIGENTE						INTEGER
	,TE_LPUNTUAL_VIGENTE				INTEGER
	,TE_DISPONIBLE_MN_NEW				BIGINT
	,TF_VCTO_MX_NEW				  		DATE FORMAT 'YYYY-MM-DD'
	,TE_DISPONIBLE_MX_NEW				BIGINT
	,TD_PROPENSION_MN					DECIMAL(25,10)
	,TC_PAR_VCTO_LINEA					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PERIODO_CMP						INTEGER
	,TF_FECHA_CARGA_CMP					DATE FORMAT 'YYYY-MM-DD'
	,TE_RANKING							INTEGER
	,TE_DECIL							INTEGER
)PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 55;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_01
SELECT 
	 MPO.IE_RUT 									AS TD_RUT 					
	,CASE WHEN CCT.TD_RUT IS NOT NULL
			THEN 1
			ELSE 0
	 END 											AS TE_CTACTE
	,LIN.TF_FECHA_VCTO 								AS TF_VCTO_MN_NEW
	,LIN.TF_VCTO_KT_MN 								AS TF_VCTO_MN_KT_NEW
	,CASE WHEN LIN.TF_FECHA_VCTO >= PAR.TF_VCTO_LINEA 
			THEN 1 
			ELSE 0 
	 END 											AS TE_LCG_VIGENTE
	,CASE WHEN LIN.TF_VCTO_KT_MN >= PAR.TF_VCTO_LINEA 
			THEN 1 
			ELSE 0 
	 END 											AS TE_LPUNTUAL_VIGENTE
	,COALESCE(LIN.TE_DCP, 0)						AS TE_DISPONIBLE_MN_NEW
	,LIN.TF_VCTO_LME								AS TF_VCTO_MX_NEW
	,COALESCE(LIN.TE_LME, 0) 						AS TE_DISPONIBLE_MX_NEW
	,COALESCE(PRP.TD_PROPENSION_CREDITO_COMERCIAL,0) AS TD_PROPENSION_MN
	,PAR.TF_VCTO_LINEA								AS TC_PAR_VCTO_LINEA
	,PAR.TE_PERIODO_CMP								AS TE_PERIODO_CMP
	,PAR.TF_FECHA_CRG								AS TF_FECHA_CARGA_CMP
	,COALESCE(PRP.TE_RANKING,99999)					AS TE_RANKING
	,COALESCE(PRP.TE_DECIL,11)						AS TE_DECIL
FROM
	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO MPO
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO PAR
		ON 1=1
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CANT_CCTE CCT
		ON MPO.IE_RUT = CCT.TD_RUT
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MOD_PROPENSION PRP
		ON MPO.IE_RUT = PRP.TD_RUT
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_LINEAS LIN
		ON MPO.IE_RUT = LIN.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 56;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_01;	
.IF ERRORCODE <> 0 THEN .QUIT 57;


--/***********************************************************************
--**SE CREA TABLA TEMPORAL 02 CON LA ACTUALIZACIÓN DE CAMPOS   
--***********************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_02;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_02
(
	 TD_RUT 							DECIMAL(8,0)
	,TF_FECHA_LINEAS					DATE FORMAT 'YYYY-MM-DD'
	,TC_BANCA	 						CHAR(3)  CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_NOM_CLI       					VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_MACRO_BANCA     				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_PLATAFORMA						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_REGIONAL						VARCHAR(60) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE								CHAR(12) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_MATRIZ_VULNERABILIDAD			VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_SECTOR							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_MACRO_SECTOR_CORRECTO			VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_PERSPECTIVA_SECTORIAL			VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
)PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 58;


INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_02
SELECT 
	 MPO.IE_RUT 									AS TD_RUT 					
	,MLN.TF_FEC_MAX_LIN 							AS TF_FECHA_LINEAS
	,CEJ.IC_BANCA 									AS TC_BANCA 		
	,CEJ.IC_NOM_CLI    								AS TC_NOM_CLI     
	,CEJ.IC_MACRO_BANCA								AS TC_MACRO_BANCA 
	,CEJ.IC_PLATAFORMA								AS TC_PLATAFORMA	
	,CEJ.IC_REGIONAL								AS TC_REGIONAL	
	,CEJ.IC_EJE										AS TC_EJE		
	,MVU.SC_GRUPO_MATRIZ_VULNERABILIDAD				AS TC_MATRIZ_VULNERABILIDAD
	,PPS.SC_SECTOR									AS TC_SECTOR				
	,PPS.SC_MACRO_SECTOR_CORRECTO					AS TC_MACRO_SECTOR_CORRECTO
	,UPPER(PPS.SC_PERSPECTIVA_SECTORIAL)			AS TC_PERSPECTIVA_SECTORIAL

FROM
	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO MPO
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MAX_FEC_LIN MLN
		ON 1=1
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CLIENTE_EJECUTIVO CEJ
		ON MPO.IE_RUT = CEJ.IE_CLI_RUT
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_MATRIZ_VULNERABILIDAD MVU
		ON MPO.IE_RUT = MVU.SE_RUT
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_PERSPECTIVAS_SECTORIALES PPS
		ON MPO.IE_RUT = PPS.SE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 59;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_02;	
.IF ERRORCODE <> 0 THEN .QUIT 60;

--/***********************************************************************
--**SE CREA TABLA TEMPORAL 03 CON LA ACTUALIZACIÓN DE CAMPOS   
--***********************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_03;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_03
(
	 TD_RUT 							DECIMAL(8,0)
	,TE_CURSE_ULT_3M					INTEGER
	,TE_CLIENTE_CON_VCTO				INTEGER
	,TE_DDA_A_LIBERAR_MES 				BIGINT 
	,TE_MTO_CURSE_ULT_3M 				BIGINT
	,TE_FLG_EXCLUSION					INTEGER
	,TC_MOTIVO_EXCLUSION				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_GEST_RCH_U3M					INTEGER
	,TE_REPITENCIA						INTEGER
	,TE_RCHMX							INTEGER
)PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 61;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_03
SELECT 
	 MPO.IE_RUT 									AS TD_RUT 					
	,CASE WHEN C3M.TD_RUT IS NULL 
			THEN 0 
			ELSE 1 
	 END 											AS TE_CURSE_ULT_3M
	,CASE WHEN COV.TD_RUT IS NULL 
			THEN 0 
			ELSE 1 
	 END 											AS TE_CLIENTE_CON_VCTO
	,COALESCE(COV.TE_MTO_CREDITO_PESOS,0)			AS TE_DDA_A_LIBERAR_MES
	,COALESCE(C3M.TE_MTO_CREDITO_PESOS,0)			AS TE_MTO_CURSE_ULT_3M
	,CASE WHEN EXC.TD_RUT IS NULL 
			THEN 0 
			ELSE 1 
	 END 											AS TE_FLG_EXCLUSION
	,COALESCE(EXC.TC_MOTIVO,'')						AS TC_MOTIVO_EXCLUSION

	,COALESCE(SEG.TE_GEST_RCH_U3M,0)				AS TE_GEST_RCH_U3M
	,CASE 
		WHEN SEG.TE_REPITENCIA =1 
		THEN 1 ELSE 0 
	END   											AS TE_REPITENCIA
	,CASE 
		WHEN SEG.TE_RCHMX = 1 
		THEN 1 ELSE 0 
	END												AS TE_RCHMX
FROM
	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO MPO
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_CURSES_3M C3M
		ON MPO.IE_RUT = C3M.TD_RUT
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_COVID COV
		ON MPO.IE_RUT = COV.TD_RUT
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_COM_EXCLUSION EXC
		ON MPO.IE_RUT = EXC.TD_RUT
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_SEG_EMPRESA SEG
		ON MPO.IE_RUT = SEG.TD_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 62;


--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_03;	
.IF ERRORCODE <> 0 THEN .QUIT 63;


--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPO PLAN_PROYECTOS, MONTO_PLAN_PROY, FECHA_PLAN_PROY, NEGOCIO	  **
--** PRODUCTO, EJE_CREADOR, VST_ID                                        **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_04;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_04
(
	 TD_RUT 							DECIMAL(8,0)
	,TE_PLAN_PROYECTOS					INTEGER
	,TE_MONTO_PLAN_PROY					BIGINT
	,TF_FECHA_PLAN_PROY					DATE FORMAT 'YYYY-MM-DD'
	,TC_NEGOCIO							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_PRODUCTO 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE_CREADOR 					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_VST_ID							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_YA_CAMPANADO_PLAN_PROY			INTEGER 
)PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 64;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_04
SELECT
 MPO.IE_RUT 		        	AS TD_RUT 			
,CASE WHEN RUU.TD_RUT IS NOT NULL THEN 1
     ELSE 0 END					AS TE_PLAN_PROYECTOS			 

,CASE WHEN RUU.TD_RUT IS NOT NULL THEN RUU.TE_MONTO
     ELSE 0 END 				AS TE_MONTO_PLAN_PROY		 

,CASE WHEN RUU.TD_RUT IS NOT NULL THEN RUU.TF_FECHA_FIN	 
     ELSE NULL END 					AS TF_FECHA_PLAN_PROY		 

,CASE WHEN RUU.TD_RUT IS NOT NULL THEN RUU.TC_NEGOCIO
     ELSE NULL END					AS TC_NEGOCIO		 

,CASE WHEN RUU.TD_RUT IS NOT NULL THEN RUU.TC_PRODUCTO
     ELSE NULL END					AS TC_PRODUCTO		 

,CASE WHEN RUU.TD_RUT IS NOT NULL THEN RUU.TC_EJE_CREADOR	
     ELSE NULL END					AS TC_EJE_CREADOR			 
		
,CASE WHEN RUU.TD_RUT IS NOT NULL THEN RUU.TC_VST_ID
     ELSE NULL END					AS TC_VST_ID		 

,CASE WHEN PLN.TD_RUT IS NOT NULL THEN 1
      ELSE 0 END					AS TE_YA_CAMPANADO_PLAN_PROY	
FROM
	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO MPO
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_RUT_UNICOS RUU
		ON MPO.IE_RUT = RUU.TD_RUT 
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROYECTOS_PLAN_PROY PLN		
		ON MPO.IE_RUT = PLN.TD_RUT
			AND NOT(COALESCE(PLN.TC_GESTION,'') = '')
			AND NOT(COALESCE(PLN.TC_GESTION,'') = 'AGN')
;
.IF ERRORCODE <> 0 THEN .QUIT 65;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_04;	
.IF ERRORCODE <> 0 THEN .QUIT 66;


--/***********************************************************************
--**SE CREA TABLA PUBLICO OBJETIVO PARA PROPENSOS MN PLAN PROYECTOS MES	**  
--***********************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_PO;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_PO
(
	 PD_RUT 							DECIMAL(8,0)
	,PD_DISPONIBLE_MN					DECIMAL(18,0)
	,PD_DISPONIBLE_MX					DECIMAL(18,0)
	,PC_VCTO_MN							VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_VCTO_MX							VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_CLUSTER							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TOQUE_4T						VARCHAR(21) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PROPENSO_MN						INTEGER
	,PE_PROPENSO_MX						INTEGER
	,PC_NOMBRE_SEGMENTO					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_CLUSTER_AGREGADO				VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_CLUSTER_DCP_MM					BIGINT
	,PE_POTENCIAL_VISTAS_MM				BIGINT
	,PE_POTENCIAL_VISTAS_MM_LP			INTEGER
	,PC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PO_DEUDA						INTEGER
	,PE_CTACTE							INTEGER
	,PF_FECHA_LINEAS					DATE FORMAT 'YYYY-MM-DD'
	,PF_VCTO_MN_NEW						DATE FORMAT 'YYYY-MM-DD'
	,PF_VCTO_MN_KT_NEW					DATE FORMAT 'YYYY-MM-DD'
	,PE_LCG_VIGENTE						INTEGER
	,PE_LPUNTUAL_VIGENTE				INTEGER
	,PE_DISPONIBLE_MN_NEW				BIGINT
	,PF_VCTO_MX_NEW				  		DATE FORMAT 'YYYY-MM-DD'
	,PE_DISPONIBLE_MX_NEW				BIGINT
	,PD_PROPENSION_MN					DECIMAL(25,10)
	,PC_BANCA	 						CHAR(3)  CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_NOM_CLI       					VARCHAR(77) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_MACRO_BANCA     				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_PLATAFORMA						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_REGIONAL						VARCHAR(60) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_EJE								CHAR(12) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_MATRIZ_VULNERABILIDAD			VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_SECTOR							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_MACRO_SECTOR_CORRECTO			VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_PERSPECTIVA_SECTORIAL			VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_PAR_VCTO_LINEA					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_CURSE_ULT_3M					INTEGER
	,PE_CLIENTE_CON_VCTO				INTEGER
	,PE_DDA_A_LIBERAR_MES 				BIGINT 
	,PE_MTO_CURSE_ULT_3M 				BIGINT
	,PE_FLG_EXCLUSION					INTEGER
	,PC_MOTIVO_EXCLUSION				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PLAN_PROYECTOS					INTEGER
	,PE_MONTO_PLAN_PROY					BIGINT
	,PF_FECHA_PLAN_PROY					DATE FORMAT 'YYYY-MM-DD'
	,PC_NEGOCIO							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_PRODUCTO 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_EJE_CREADOR 					VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_VST_ID							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_YA_CAMPANADO_PLAN_PROY			INTEGER 
	,PC_TEXTO_PROY						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO1							VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO2  						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO3  						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_CAPACITY						INTEGER
	,PE_EN_PLANEAMIENTO					INTEGER 			
    ,PC_CALIFICACION_SBIF          		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,PF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,PD_PI_CLIENTE                		DECIMAL(25,10)			
	,PC_CLASIFICACION_SBIF       		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,PE_FDR                      		INTEGER 			
	,PE_COS_CLI                 		INTEGER 			
	,PE_FILTROS_RIESGOS          		INTEGER 			
	,PC_PAR_CALIFICACION_SBIF    		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
	,PD_PAR_PI_CLIENTE           		DECIMAL(25,10)		
	,PE_PAR_FDR                  		INTEGER 			
	,PE_PAR_COS_CLI             		INTEGER 			
	,PE_MOLESTO               			INTEGER 			
	,PE_CARGABLE						INTEGER
	,PC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_RANK							INTEGER
	,PE_DISPONIBLE_OK               	INTEGER
	,PE_RNK_ORDEN                 		INTEGER
	,PE_A_CARGAR                 		INTEGER
	,PE_DISPONIBLE	             		INTEGER
	,PE_CON_MANDATO             		INTEGER
	,PE_ENROLADO_360            		INTEGER
	,PE_HABILITADO_360           		INTEGER
	,PE_ACTIVO_360               		INTEGER
	,PE_ESTADO_MULTIPASS        		INTEGER
	,PE_MANDATO_CCL              		INTEGER
	,PE_SIN_APR                 		INTEGER
	,PE_ART85                     		INTEGER
	,PE_FYP                    			INTEGER
	,PE_READY_CCL              			INTEGER
	,PE_ACTIVAR_360              		INTEGER
	,PE_TOTAL_HABILITADORES       		INTEGER
	,PC_FECHA_HAB 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
	,PE_CMP_MANDATO_CCL					INTEGER
	,PE_CMP_CTO_BEX						INTEGER
	,PE_CMP_MIGRACION               	INTEGER
	,PE_CMP_PROPENSO_MX             	INTEGER
	,PE_CMP_FOGAPE_REACTIVA         	INTEGER
	,PE_PRIORIDAD                   	INTEGER
	,PE_MTO_CMP    						BIGINT
    ,PC_COD_CMP							VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PERIODO_CMP						INTEGER
	,PF_FECHA_CARGA_CMP					DATE FORMAT 'YYYY-MM-DD'
	,PE_RANKING							INTEGER
	,PE_DECIL							INTEGER
	,PE_GEST_RCH_U3M					INTEGER
	,PE_REPITENCIA						INTEGER
	,PE_RCHMX							INTEGER
)PRIMARY INDEX ( PD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 67;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_PO
SELECT 
	 MPO.IE_RUT 										AS PD_RUT 		
	,MPO.ID_DISPONIBLE_MN								AS PD_DISPONIBLE_MN			
	,MPO.ID_DISPONIBLE_MX								AS PD_DISPONIBLE_MX			
	,MPO.IC_VCTO_MN										AS PC_VCTO_MN						
	,MPO.IC_VCTO_MX										AS PC_VCTO_MX					
	,MPO.IC_CLUSTER										AS PC_CLUSTER					
	,MPO.IC_TOQUE_4T									AS PC_TOQUE_4T				
	,MPO.IE_PROPENSO_MN									AS PE_PROPENSO_MN				
	,MPO.IE_PROPENSO_MX									AS PE_PROPENSO_MX				
	,MPO.IC_NOMBRE_SEGMENTO								AS PC_NOMBRE_SEGMENTO			
	,MPO.IC_CLUSTER_AGREGADO							AS PC_CLUSTER_AGREGADO		
	,MPO.IE_CLUSTER_DCP_MM								AS PE_CLUSTER_DCP_MM			
	,MPO.IE_POTENCIAL_VISTAS_MM							AS PE_POTENCIAL_VISTAS_MM		
	,MPO.IE_POTENCIAL_VISTAS_MM_LP						AS PE_POTENCIAL_VISTAS_MM_LP	
	,MPO.IC_RECOMENDACION_DE_CRUCE						AS PC_RECOMENDACION_DE_CRUCE	 
	,CASE WHEN COALESCE(MPO.IC_NOMBRE_SEGMENTO, '') 
		IN (
		 '02 - DEUDA'
		,'06 - DEUDA/COMEX'
		,'06 - DEUDA/S&T-OP'
		,'07 - DEUDA/CASH'
		,'08 - DEUDA/FACTORING'
		,'13 - NO COMEX'
		,'13 - NO S&T-OP'
		,'14 - NO CONFIRMING'
		,'14 - NO FACTORING'
		,'15 - NO CASH'
		,'16 - MULTIPRODUCTO')
			THEN 1 
			ELSE 0 
	 END 											AS PE_PO_DEUDA
	,T01.TE_CTACTE 									AS PE_CTACTE
	,T02.TF_FECHA_LINEAS 							AS PF_FECHA_LINEAS
	,T01.TF_VCTO_MN_NEW 							AS PF_VCTO_MN_NEW
	,T01.TF_VCTO_MN_KT_NEW 							AS PF_VCTO_MN_KT_NEW
	,T01.TE_LCG_VIGENTE								AS PE_LCG_VIGENTE
	,T01.TE_LPUNTUAL_VIGENTE						AS PE_LPUNTUAL_VIGENTE
	,T01.TE_DISPONIBLE_MN_NEW						AS PE_DISPONIBLE_MN_NEW
	,T01.TF_VCTO_MX_NEW								AS PF_VCTO_MX_NEW
	,T01.TE_DISPONIBLE_MX_NEW 						AS PE_DISPONIBLE_MX_NEW
	,T01.TD_PROPENSION_MN							AS PD_PROPENSION_MN
	,T02.TC_BANCA 									AS PC_BANCA 		
	,T02.TC_NOM_CLI    								AS PC_NOM_CLI     
	,T02.TC_MACRO_BANCA								AS PC_MACRO_BANCA 
	,T02.TC_PLATAFORMA								AS PC_PLATAFORMA	
	,T02.TC_REGIONAL								AS PC_REGIONAL	
	,T02.TC_EJE										AS PC_EJE			
	,T02.TC_MATRIZ_VULNERABILIDAD					AS PC_MATRIZ_VULNERABILIDAD
	,T02.TC_SECTOR									AS PC_SECTOR				
	,T02.TC_MACRO_SECTOR_CORRECTO					AS PC_MACRO_SECTOR_CORRECTO
	,T02.TC_PERSPECTIVA_SECTORIAL					AS PC_PERSPECTIVA_SECTORIAL
	,T01.TC_PAR_VCTO_LINEA							AS PC_PAR_VCTO_LINEA
	,T03.TE_CURSE_ULT_3M							AS PE_CURSE_ULT_3M
	,T03.TE_CLIENTE_CON_VCTO						AS PE_CLIENTE_CON_VCTO
	,T03.TE_DDA_A_LIBERAR_MES						AS PE_DDA_A_LIBERAR_MES
	,T03.TE_MTO_CURSE_ULT_3M						AS PE_MTO_CURSE_ULT_3M
	,T03.TE_FLG_EXCLUSION							AS PE_FLG_EXCLUSION
	,T03.TC_MOTIVO_EXCLUSION						AS PC_MOTIVO_EXCLUSION
	,T04.TE_PLAN_PROYECTOS							AS PE_PLAN_PROYECTOS
	,T04.TE_MONTO_PLAN_PROY							AS PE_MONTO_PLAN_PROY
	,T04.TF_FECHA_PLAN_PROY							AS PF_FECHA_PLAN_PROY
	,T04.TC_NEGOCIO									AS PC_NEGOCIO
	,T04.TC_PRODUCTO								AS PC_PRODUCTO
	,T04.TC_EJE_CREADOR								AS PC_EJE_CREADOR
	,T04.TC_VST_ID									AS PC_VST_ID
	,T04.TE_YA_CAMPANADO_PLAN_PROY					AS PE_YA_CAMPANADO_PLAN_PROY
	,'' 											AS PC_TEXTO_PROY
	,''												AS PC_TEXTO1
	,''												AS PC_TEXTO2
	,''												AS PC_TEXTO3
	,999											AS PE_CAPACITY
	,0				 								AS PE_EN_PLANEAMIENTO
    ,NULL  											AS PC_CALIFICACION_SBIF
	,NULL 											AS PF_PERIODO_CALIFICACION 
	,NULL 											AS PD_PI_CLIENTE 
	,NULL 											AS PC_CLASIFICACION_SBIF 
	,0  											AS PE_FDR 
	,0  											AS PE_COS_CLI 
	,0  											AS PE_FILTROS_RIESGOS
	,NULL 											AS PC_PAR_CALIFICACION_SBIF 
	,NULL 											AS PD_PAR_PI_CLIENTE 
	,NULL 											AS PE_PAR_FDR 
	,NULL 											AS PE_PAR_COS_CLI 
	,0  											AS PE_MOLESTO 
	,0 												AS PE_CARGABLE
    ,''												AS PC_ELIMINADO	
	,0 												AS PE_RANK
	,0 												AS PE_DISPONIBLE_OK
	,0 												AS PE_RNK_ORDEN
	,0 												AS PE_A_CARGAR
	,0 												AS PE_DISPONIBLE
	,0 												AS PE_CON_MANDATO
	,0 												AS PE_ENROLADO_360
	,0 												AS PE_HABILITADO_360
	,0 												AS PE_ACTIVO_360
	,0 												AS PE_ESTADO_MULTIPASS
	,0 												AS PE_MANDATO_CCL
	,0 												AS PE_SIN_APR
	,0 												AS PE_ART85
	,0 												AS PE_FYP
	,0 												AS PE_READY_CCL
	,0 												AS PE_ACTIVAR_360
	,0 												AS PE_TOTAL_HABILITADORES
	,''												AS PC_FECHA_HAB
	,0 												AS PE_CMP_MANDATO_CCL
	,0 												AS PE_CMP_CTO_BEX
	,0 												AS PE_CMP_MIGRACION
	,0 												AS PE_CMP_PROPENSO_MX
	,0 												AS PE_CMP_FOGAPE_REACTIVA
	,99 											AS PE_PRIORIDAD
	,0							 					AS PE_MTO_CMP
	,''							  					AS PC_COD_CMP
	,T01.TE_PERIODO_CMP								AS PE_PERIODO_CMP
	,T01.TF_FECHA_CARGA_CMP							AS PF_FECHA_CARGA_CMP
	,T01.TE_RANKING									AS PE_RANKING
	,T01.TE_DECIL									AS PE_DECIL
	,T03.TE_GEST_RCH_U3M							AS PE_GEST_RCH_U3M
	,T03.TE_REPITENCIA								AS PE_REPITENCIA
	,T03.TE_RCHMX									AS PE_RCHMX
FROM
	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO MPO
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_01 T01
		ON MPO.IE_RUT = T01.TD_RUT	
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_02 T02
		ON MPO.IE_RUT = T02.TD_RUT
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_03 T03
		ON MPO.IE_RUT = T03.TD_RUT
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_04 T04
		ON MPO.IE_RUT = T04.TD_RUT		
;
.IF ERRORCODE <> 0 THEN .QUIT 68;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_PO;	
.IF ERRORCODE <> 0 THEN .QUIT 69;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;

UPDATE - Ejemplo 6 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: CAMBIA LOS FILTROS DE RIESGO PARA EL PO DE PROPENSOS MN PLAN PROYECTOS	  **
--**                                                    				 				  **
--** AUTOR  : CESAR ROMERO MUNOZ                                          			  	  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 07/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN:                                                           				  **
--** AUTOR  :                                                           				  **
--** FECHA  : SSAAMMDD                                                  				  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	 																  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP                 **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CALIF_SBIF               	  **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_FDR		              		  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP			          **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_NO_CONTACTAR			  	  **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO				      	  **
--**																					  **                 
--**TABLA DE SALIDA:    							                	                  **
--**                  	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES**
--**																					  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARAMETROS									  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PARAMETRO;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PARAMETRO
(
	 TC_CALIFICACION		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CALIFICACIONM		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PI					DECIMAL(18,8)
	,TE_FDR					INTEGER
	,TE_COS					INTEGER
) PRIMARY INDEX (TC_CALIFICACION)
;
.IF ERRORCODE <> 0 THEN .QUIT 1;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PARAMETRO
SELECT 
	 SC_CALIFICACION	AS TC_CALIFICACION	
	,SC_CALIFICACIONM	AS TC_CALIFICACIONM	
	,SD_PI				AS TD_PI				
	,SE_FDR				AS TE_FDR				
	,SE_COS				AS TE_COS				
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP
WHERE
	SC_CAMPANA = 'PROPENSOS_PLAN'
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_CALIFICACION)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PARAMETRO;
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE PROPENSOS MN PLAN PROYECTOS                    **
--** P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES	                          **  
--** CAMPOS PAR_CALIFICACION_SBIF, PAR_PI_CLIENTE, PAR_FDR Y PAR_COS_CLI  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES 
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PARAMETRO AS PAR
SET 
	 PC_PAR_CALIFICACION_SBIF = 
		CASE WHEN PAR.TC_CALIFICACIONM IS NULL 
				THEN 'NULL' 
				ELSE TC_CALIFICACIONM
		END
	,PD_PAR_PI_CLIENTE = PAR.TD_PI
	,PE_PAR_FDR 		 = PAR.TE_FDR
	,PE_PAR_COS_CLI 	 = PAR.TE_COS
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL CON PO CRUZADA CON CALIFICACIONES SBIF, SI LA **
--** CALIFICACION ES NULA, SE CAMBIA POR 0.								  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_CALIF;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_CALIF
(
	 TE_RUT				INTEGER
	,TC_CALIFICACION	VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TF_PERIODO			DATE FORMAT 'YYYY-MM-DD'
	,TC_CLASIFICACION	VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PI				DECIMAL(18,8)
) PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 5;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_CALIF
SELECT
	 PPP.PE_RUT							AS TE_RUT
	,COALESCE(CAL.IC_CALIFICACION_SBIF,'0')	AS TC_CALIFICACION
	,CAL.IF_PERIODO_CALIFICACION_SBIF		AS TF_PERIODO
	,CAL.IC_CLASIFICACION_SBIF				AS TC_CLASIFICACION
	,COALESCE(CAL.ID_PI_CLIENTE,0)			AS TD_PI
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES AS PPP
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CALIF_SBIF AS CAL
		ON PPP.PE_RUT = CAL.IE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_CALIF;
.IF ERRORCODE <> 0 THEN .QUIT 7;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE PROPENSOS MN PLAN PROYECTOS                    **
--** P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES 	                          **  
--** CAMPOS CALIFICACION_SBIF, PERIODO_CALIFICACION, CLASIFICACION_SBIF Y **
--** PI_CLIENTE															  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES 
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_CALIF AS CAL
SET 
	PC_CALIFICACION_SBIF 	= CAL.TC_CALIFICACION
  , PF_PERIODO_CALIFICACION = CAL.TF_PERIODO
  , PC_CLASIFICACION_SBIF 	= CAL.TC_CLASIFICACION
  , PD_PI_CLIENTE 			= CAL.TD_PI
WHERE
	PE_RUT = CAL.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE PROPENSOS MN PLAN PROYECTOS	                  **  
--** P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES CAMPO FDR		    		  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES 
FROM
	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_FDR AS MFR
SET 
	PE_FDR = MFR.IE_FDR 
WHERE
	PE_RUT = MFR.IE_CLI_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA CCEE_Y_RIP CRUZADA CON PO PARA SACAR	  **  
--** INDICADOR COS_CLI													  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_COS_CLI;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_COS_CLI
(
	 TE_RUT			INTEGER
	,TE_COS_CLI		INTEGER
) PRIMARY INDEX (TE_RUT, TE_COS_CLI)
;
.IF ERRORCODE <> 0 THEN .QUIT 10;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_COS_CLI
SELECT
	PPM.PE_RUT	AS TE_RUT
	,CASE WHEN RIP.SE_CLIENTE_RUT IS NULL 
			THEN 0 
			ELSE 1 
	END				AS TE_COS_CLI
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES AS PPM
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP AS RIP
		ON PPM.PE_RUT = RIP.SE_CLIENTE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT, TE_COS_CLI)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_COS_CLI;
.IF ERRORCODE <> 0 THEN .QUIT 12;
	
--/*************************************************************************
--** SE ACTUALIZA TABLA DE PROPENSOS MN PLAN PROYECTOS                    **
--** P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES                             **  
--** CAMPO COS_CLI														  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES 
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_COS_CLI AS FCC
SET 
	PE_COS_CLI = FCC.TE_COS_CLI
WHERE
	PE_RUT = FCC.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 13;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL CON RUT UNICOS DE PO, DONDE ELLOS CUMPLAN     **
--** LAS CONDICIONES DE LOS FILTROS DE RIESGO. SE UTILIZA FILTRO DE		  **  
--** **CALIFICACION_SBIF**												  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_RUT;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_RUT
(
	 TE_RUT			INTEGER
) PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 14;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_RUT
SELECT
	PMN.PE_RUT	AS TE_RUT
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES AS PMN
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PARAMETRO AS PAR
		ON POSITION(PMN.PC_CALIFICACION_SBIF IN PAR.TC_CALIFICACION) > 0
			AND PMN.PD_PI_CLIENTE  <= PAR.TD_PI
			AND PMN.PE_FDR >= PAR.TE_FDR
			AND PMN.PE_COS_CLI = PAR.TE_COS
;
.IF ERRORCODE <> 0 THEN .QUIT 15;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_RUT;
.IF ERRORCODE <> 0 THEN .QUIT 16;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE PROPENSOS MN PLAN PROYECTOS              	  **  
--** P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES  CAMPO FILTROS_RIESGOS.	  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES 
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_RUT AS POR
SET 
	PE_FILTROS_RIESGOS = 1
WHERE
	PE_RUT = POR.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 17;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA CLIENTES PO NO_CONTACTAR, REGISTRANDO 	  **  
--** INDICADOR MOLESTO													  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_MOL;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_MOL
(
	 TE_RUT			INTEGER
	,TE_MOLESTO		INTEGER
) PRIMARY INDEX (TE_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 18;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_MOL
SELECT
	PRN.PE_RUT	AS TE_RUT
	,CASE WHEN MOL.IE_RUT IS NULL 
			THEN 0 
			ELSE 1 
	END				AS TE_MOLESTO
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES AS PRN
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_NO_CONTACTAR AS MOL
		ON PRN.PE_RUT = MOL.IE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 19;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_MOL;
.IF ERRORCODE <> 0 THEN .QUIT 20;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE PROPENSOS MN PLAN PROYECTOS              	  **  
--** P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES CAMPO MOLESTO.														  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES 
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_MOL AS MOL
SET
	PE_MOLESTO = MOL.TE_MOLESTO
WHERE
	PE_RUT = MOL.TE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 21;
	
--/*************************************************************************
--** SE ACTUALIZA TABLA DE PROPENSOS MN PLAN PROYECTOS              	  **  
--** P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES CAMPO EN_PLANEAMIENTO.	  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES 
FROM
	MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO AS MMP
SET
	 PE_EN_PLANEAMIENTO = 1
	,PC_RECOMENDACION_DE_CRUCE = MMP.IC_RECOMENDACION_DE_CRUCE
WHERE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES.PE_RUT = MMP.IE_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 22;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (PE_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES;
.IF ERRORCODE <> 0 THEN .QUIT 23;


SELECT DATE, TIME; 

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 6 OK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: CAMBIA LOS FILTROS DE RIESGO PARA EL PO DE PROPENSOS MN PLAN PROYECTOS	  **
--**                                                    				 				  **
--** AUTOR  : CESAR ROMERO MUNOZ                                          			  	  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 07/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 08/2024			     	                                                  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	 																  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP                 	  **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CALIF_SBIF               	  	  **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_FDR		              		  	  **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP			          	  **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_NO_CONTACTAR			  	  	  **
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO				      	  	  **
--**    {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_PO**
--**																					  **
--**TABLAS TEMPORALES:																	  **
--**	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PARAMETRO **                 
--**	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_CALIF  **                 
--**	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_01			  **                 
--**																					  **                 
--**																					  **                 
--**TABLA DE SALIDA:    							                	                  **
--**    {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_FR**
--**																					  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME; 

--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARAMETROS									  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PARAMETRO;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PARAMETRO
(
	 TC_CALIFICACION		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_CALIFICACIONM		VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PI					DECIMAL(18,8)
	,TE_FDR					INTEGER
	,TE_COS					INTEGER
) PRIMARY INDEX (TC_CALIFICACION)
;
.IF ERRORCODE <> 0 THEN .QUIT 1;
	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PARAMETRO
SELECT 
	 SC_CALIFICACION	AS TC_CALIFICACION	
	,SC_CALIFICACIONM	AS TC_CALIFICACIONM	
	,SD_PI				AS TD_PI				
	,SE_FDR				AS TE_FDR				
	,SE_COS				AS TE_COS				
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FDR_CMP
WHERE
	SC_CAMPANA = 'PROPENSOS_PLAN'
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TC_CALIFICACION)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PARAMETRO;
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL CON PO CRUZADA CON CALIFICACIONES SBIF, SI LA **
--** CALIFICACION ES NULA, SE CAMBIA POR 0.								  **  
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_CALIF;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_CALIF
(
	 TD_RUT				DECIMAL(8,0)
	,TC_CALIFICACION	VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TF_PERIODO			DATE FORMAT 'YYYY-MM-DD'
	,TC_CLASIFICACION	VARCHAR(100)	CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PI				DECIMAL(18,8)
) PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 4;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_CALIF
SELECT
	 PPP.PD_RUT								AS TD_RUT
	,COALESCE(CAL.IC_CALIFICACION_SBIF,'0')	AS TC_CALIFICACION
	,CAL.IF_PERIODO_CALIFICACION_SBIF		AS TF_PERIODO
	,CAL.IC_CLASIFICACION_SBIF				AS TC_CLASIFICACION
	,COALESCE(CAL.ID_PI_CLIENTE,0)			AS TD_PI
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_PO PPP
	INNER JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CALIF_SBIF CAL
		ON PPP.PD_RUT = CAL.IE_RUT 
;
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_CALIF;
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/*************************************************************************
--** SE ACTUALIZA TABLA DE PROPENSOS MN PLAN PROYECTOS                    **
--** P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES	                          **  
--** CAMPOS PAR_CALIFICACION_SBIF, PAR_PI_CLIENTE, PAR_FDR Y PAR_COS_CLI  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_01
(
	 TD_RUT 							DECIMAL(8,0)
	,TC_CLUSTER							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PO_DEUDA						INTEGER
	,TE_CTACTE							INTEGER
	,TE_LCG_VIGENTE						INTEGER
	,TE_DISPONIBLE_MN_NEW				BIGINT
	,TD_PROPENSION_MN					DECIMAL(25,10)
	,TC_MACRO_BANCA     				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE								CHAR(12) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DDA_A_LIBERAR_MES 				BIGINT 
	,TE_FLG_EXCLUSION					INTEGER
	,TC_MOTIVO_EXCLUSION				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TC_TEXTO1							VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2  						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3  						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_EN_PLANEAMIENTO					INTEGER 			
    ,TC_CALIFICACION_SBIF          		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,TD_PI_CLIENTE                		DECIMAL(25,10)			
	,TC_CLASIFICACION_SBIF       		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FDR                      		INTEGER 			
	,TE_COS_CLI                 		INTEGER 			
	,TE_FILTROS_RIESGOS          		INTEGER 			
	,TC_PAR_CALIFICACION_SBIF    		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE           		DECIMAL(25,10)		
	,TE_PAR_FDR                  		INTEGER 			
	,TE_PAR_COS_CLI             		INTEGER 			
	,TE_MOLESTO               			INTEGER 			
	,TE_CARGABLE						INTEGER
	,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DISPONIBLE_OK               	INTEGER
	,TE_CON_MANDATO             		INTEGER
	,TE_ENROLADO_360            		INTEGER
	,TE_HABILITADO_360           		INTEGER
	,TE_ACTIVO_360               		INTEGER
	,TE_ESTADO_MULTIPASS        		INTEGER
	,TE_MANDATO_CCL              		INTEGER
	,TE_SIN_APR                 		INTEGER
	,TE_ART85                     		INTEGER
	,TE_FYP                    			INTEGER
	,TE_READY_CCL              			INTEGER
	,TE_ACTIVAR_360              		INTEGER
	,TE_TOTAL_HABILITADORES       		INTEGER
	,TC_FECHA_HAB 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
	,TE_CMP_MANDATO_CCL					INTEGER
	,TE_CMP_CTO_BEX						INTEGER
	,TE_CMP_MIGRACION               	INTEGER
	,TE_CMP_PROPENSO_MX             	INTEGER
	,TE_CMP_FOGAPE_REACTIVA         	INTEGER
	,TE_PRIORIDAD                   	INTEGER
	,TE_MTO_CMP    						BIGINT
	,TE_DECIL							INTEGER
	,TE_GEST_RCH_U3M					INTEGER
	,TE_REPITENCIA						INTEGER
	,TE_RCHMX							INTEGER
	
)PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 7;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_01
SELECT
 PPN.PD_RUT 		        		AS TD_RUT 			
,PPN.PC_CLUSTER									AS TC_CLUSTER	
,PPN.PC_RECOMENDACION_DE_CRUCE					AS TC_RECOMENDACION_DE_CRUCE	
,PPN.PE_PO_DEUDA 								AS TE_PO_DEUDA
,PPN.PE_CTACTE 									AS TE_CTACTE
,PPN.PE_LCG_VIGENTE								AS TE_LCG_VIGENTE
,PPN.PE_DISPONIBLE_MN_NEW						AS TE_DISPONIBLE_MN_NEW
,PPN.PD_PROPENSION_MN							AS TD_PROPENSION_MN
,PPN.PC_MACRO_BANCA								AS TC_MACRO_BANCA 
,PPN.PC_EJE										AS TC_EJE	
,PPN.PE_DDA_A_LIBERAR_MES						AS TE_DDA_A_LIBERAR_MES
,PPN.PE_FLG_EXCLUSION							AS TE_FLG_EXCLUSION
,PPN.PC_MOTIVO_EXCLUSION						AS TC_MOTIVO_EXCLUSION
,PPN.PC_TEXTO1									AS TC_TEXTO1
,PPN.PC_TEXTO2									AS TC_TEXTO2
,PPN.PC_TEXTO3									AS TC_TEXTO3
,PPN.PE_EN_PLANEAMIENTO							AS TE_EN_PLANEAMIENTO

,CASE WHEN CAL.IE_RUT IS NOT NULL
	 	THEN COALESCE(CAL.IC_CALIFICACION_SBIF,'0') 
		ELSE '0'  END 
									AS TC_CALIFICACION_SBIF         
,CASE WHEN CAL.IE_RUT IS NOT NULL
	 	THEN CAL.IF_PERIODO_CALIFICACION_SBIF 
		ELSE NULL END 
									AS TF_PERIODO_CALIFICACION    	
,CASE WHEN CAL.IE_RUT IS NOT NULL
	 	THEN COALESCE(CAL.ID_PI_CLIENTE,0) 
		ELSE 0 END 
									AS TD_PI_CLIENTE      																			
,CASE WHEN CAL.IE_RUT IS NOT NULL
	 	THEN CAL.IC_CLASIFICACION_SBIF 
		ELSE NULL END 
									AS TC_CLASIFICACION_SBIF    

,CASE WHEN MFR.IE_CLI_RUT IS NOT NULL
	 	THEN MFR.IE_FDR 
		ELSE 0 END 
			                    	AS TE_FDR    

,CASE WHEN RIP.SE_CLIENTE_RUT IS NULL 
		THEN 0 
		ELSE 1 END
					               	AS TE_COS_CLI  

,PPN.PE_FILTROS_RIESGOS				AS TE_FILTROS_RIESGOS

,CASE WHEN PAR.TC_CALIFICACIONM IS NULL 
		THEN 'NULL' 
		ELSE  PAR.TC_CALIFICACIONM END
							   		AS TC_PAR_CALIFICACION_SBIF    	
,PAR.TD_PI           				AS TD_PAR_PI_CLIENTE           	
,PAR.TE_FDR                  		AS TE_PAR_FDR       
,PAR.TE_COS           				AS TE_PAR_COS_CLI   
,PPN.PE_MOLESTO               		AS TE_MOLESTO 
,PPN.PE_CARGABLE              		AS TE_CARGABLE
,PPN.PC_ELIMINADO	         		AS TC_ELIMINADO	
,PPN.PE_DISPONIBLE_OK         		AS TE_DISPONIBLE_OK
,PPN.PE_CON_MANDATO           		AS TE_CON_MANDATO
,PPN.PE_ENROLADO_360          		AS TE_ENROLADO_360
,PPN.PE_HABILITADO_360        		AS TE_HABILITADO_360
,PPN.PE_ACTIVO_360            		AS TE_ACTIVO_360
,PPN.PE_ESTADO_MULTIPASS      		AS TE_ESTADO_MULTIPASS
,PPN.PE_MANDATO_CCL           		AS TE_MANDATO_CCL
,PPN.PE_SIN_APR               		AS TE_SIN_APR
,PPN.PE_ART85                 		AS TE_ART85
,PPN.PE_FYP                   		AS TE_FYP
,PPN.PE_READY_CCL             		AS TE_READY_CCL
,PPN.PE_ACTIVAR_360           		AS TE_ACTIVAR_360
,PPN.PE_TOTAL_HABILITADORES   		AS TE_TOTAL_HABILITADORES
,PPN.PC_FECHA_HAB             		AS TC_FECHA_HAB
,PPN.PE_CMP_MANDATO_CCL       		AS TE_CMP_MANDATO_CCL
,PPN.PE_CMP_CTO_BEX           		AS TE_CMP_CTO_BEX
,PPN.PE_CMP_MIGRACION         		AS TE_CMP_MIGRACION
,PPN.PE_CMP_PROPENSO_MX       		AS TE_CMP_PROPENSO_MX
,PPN.PE_CMP_FOGAPE_REACTIVA   		AS TE_CMP_FOGAPE_REACTIVA
,PPN.PE_PRIORIDAD 					AS TE_PRIORIDAD
,PPN.PE_MTO_CMP						AS TE_MTO_CMP
,PPN.PE_DECIL						AS TE_DECIL
,PPN.PE_GEST_RCH_U3M				AS TE_GEST_RCH_U3M
,PPN.PE_REPITENCIA					AS TE_REPITENCIA
,PPN.PE_RCHMX						AS TE_RCHMX	
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_PO  PPN
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PARAMETRO PAR
		ON 1=1
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CALIF_SBIF CAL
		ON PPN.PD_RUT = CAL.IE_RUT		
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_FDR MFR
		ON PPN.PD_RUT = MFR.IE_CLI_RUT
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_EXT_CCEE_RIP RIP
		ON PPN.PD_RUT = RIP.SE_CLIENTE_RUT	
;
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_01;
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/*************************************************************************
--** SE CREA TABLA TEMPORAL CON RUT UNICOS DE PO, DONDE ELLOS CUMPLAN     **
--** LAS CONDICIONES DE LOS FILTROS DE RIESGO. SE UTILIZA FILTRO DE		  **  
--** **CALIFICACION_SBIF**												  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_RUT;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_RUT
(
	 TD_RUT			DECIMAL(8,0)
) PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 10;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_RUT
SELECT
	PMN.TD_RUT	AS TD_RUT
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_01 PMN
	INNER JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PARAMETRO PAR
		ON POSITION(PMN.TC_CALIFICACION_SBIF IN PAR.TC_CALIFICACION) > 0
			AND PMN.TD_PI_CLIENTE  <= PAR.TD_PI
			AND PMN.TE_FDR >= PAR.TE_FDR
			AND PMN.TE_COS_CLI = PAR.TE_COS
;
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_RUT;
.IF ERRORCODE <> 0 THEN .QUIT 12;


--/*************************************************************************
--** SE CREA TABLA TEMPORAL PARA CLIENTES PO NO_CONTACTAR, REGISTRANDO 	  **  
--** INDICADOR MOLESTO													  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_MOL;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_MOL
(
	 TD_RUT			DECIMAL(8,0)
) PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 13;
 
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_MOL
SELECT
	MOL.IE_RUT	AS TD_RUT
FROM MKT_JOURNEYBUILDER_TB.I_CMP_MAE_NO_CONTACTAR AS MOL
WHERE MOL.IE_RUT < 100000000
GROUP BY 1
;
.IF ERRORCODE <> 0 THEN .QUIT 14;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_MOL;
.IF ERRORCODE <> 0 THEN .QUIT 15;

/***********************************************************************************************
    CREA TABLA DE PRE CALCULO DE FILTROS DE RIESGO
************************************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_FR;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_FR
(
	 PD_RUT 							DECIMAL(8,0)
	,PC_CLUSTER							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PO_DEUDA						INTEGER
	,PE_CTACTE							INTEGER
	,PE_LCG_VIGENTE						INTEGER
	,PE_DISPONIBLE_MN_NEW				BIGINT
	,PD_PROPENSION_MN					DECIMAL(25,10)
	,PC_MACRO_BANCA     				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_EJE								CHAR(12) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_DDA_A_LIBERAR_MES 				BIGINT 
	,PE_FLG_EXCLUSION					INTEGER
	,PC_MOTIVO_EXCLUSION				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
	,PC_TEXTO1							VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO2  						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO3  						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_EN_PLANEAMIENTO					INTEGER 			
    ,PC_CALIFICACION_SBIF          		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,PF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,PD_PI_CLIENTE                		DECIMAL(25,10)			
	,PC_CLASIFICACION_SBIF       		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,PE_FDR                      		INTEGER 			
	,PE_COS_CLI                 		INTEGER 			
	,PE_FILTROS_RIESGOS          		INTEGER 			
	,PC_PAR_CALIFICACION_SBIF    		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
	,PD_PAR_PI_CLIENTE           		DECIMAL(25,10)		
	,PE_PAR_FDR                  		INTEGER 			
	,PE_PAR_COS_CLI             		INTEGER 			
	,PE_MOLESTO               			INTEGER 			
	,PE_CARGABLE						INTEGER
	,PC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_DISPONIBLE_OK               	INTEGER
	,PE_CON_MANDATO             		INTEGER
	,PE_ENROLADO_360            		INTEGER
	,PE_HABILITADO_360           		INTEGER
	,PE_ACTIVO_360               		INTEGER
	,PE_ESTADO_MULTIPASS        		INTEGER
	,PE_MANDATO_CCL              		INTEGER
	,PE_SIN_APR                 		INTEGER
	,PE_ART85                     		INTEGER
	,PE_FYP                    			INTEGER
	,PE_READY_CCL              			INTEGER
	,PE_ACTIVAR_360              		INTEGER
	,PE_TOTAL_HABILITADORES       		INTEGER
	,PC_FECHA_HAB 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
	,PE_CMP_MANDATO_CCL					INTEGER
	,PE_CMP_CTO_BEX						INTEGER
	,PE_CMP_MIGRACION               	INTEGER
	,PE_CMP_PROPENSO_MX             	INTEGER
	,PE_CMP_FOGAPE_REACTIVA         	INTEGER
	,PE_PRIORIDAD                   	INTEGER
	,PE_MTO_CMP    						BIGINT
	,PE_DECIL							INTEGER
	,PE_GEST_RCH_U3M					INTEGER
	,PE_REPITENCIA						INTEGER
	,PE_RCHMX							INTEGER 
)PRIMARY INDEX ( PD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 16;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_FR
SELECT
 PPN.TD_RUT 		        		AS PD_RUT 			
,PPN.TC_CLUSTER						AS PC_CLUSTER	

,PPN.TC_RECOMENDACION_DE_CRUCE		AS PC_RECOMENDACION_DE_CRUCE	

,PPN.TE_PO_DEUDA 					AS PE_PO_DEUDA
,PPN.TE_CTACTE 						AS PE_CTACTE
,PPN.TE_LCG_VIGENTE					AS PE_LCG_VIGENTE
,PPN.TE_DISPONIBLE_MN_NEW			AS PE_DISPONIBLE_MN_NEW
,PPN.TD_PROPENSION_MN				AS PD_PROPENSION_MN
,PPN.TC_MACRO_BANCA					AS PC_MACRO_BANCA 
,PPN.TC_EJE							AS PC_EJE	
,PPN.TE_DDA_A_LIBERAR_MES			AS PE_DDA_A_LIBERAR_MES
,PPN.TE_FLG_EXCLUSION				AS PE_FLG_EXCLUSION
,PPN.TC_MOTIVO_EXCLUSION			AS PC_MOTIVO_EXCLUSION
,PPN.TC_TEXTO1						AS PC_TEXTO1
,PPN.TC_TEXTO2						AS PC_TEXTO2
,PPN.TC_TEXTO3						AS PC_TEXTO3

,CASE WHEN MMP.IE_RUT IS NOT NULL
	THEN 1
	ELSE NULL END
									AS PE_EN_PLANEAMIENTO	

,PPN.TC_CALIFICACION_SBIF			AS PC_CALIFICACION_SBIF         
,PPN.TF_PERIODO_CALIFICACION		AS PF_PERIODO_CALIFICACION    	
,PPN.TD_PI_CLIENTE 					AS PD_PI_CLIENTE      		
,PPN.TC_CLASIFICACION_SBIF			AS PC_CLASIFICACION_SBIF    
,PPN.TE_FDR            				AS PE_FDR    
,PPN.TE_COS_CLI            			AS PE_COS_CLI  

,CASE WHEN POR.TD_RUT IS NOT NULL 
		THEN 1
		ELSE 0 END
									AS PE_FILTROS_RIESGOS 

,PPN.TC_PAR_CALIFICACION_SBIF		AS PC_PAR_CALIFICACION_SBIF    	
,PPN.TD_PAR_PI_CLIENTE 				AS PD_PAR_PI_CLIENTE           	
,PPN.TE_PAR_FDR                		AS PE_PAR_FDR       
,PPN.TE_PAR_COS_CLI    				AS PE_PAR_COS_CLI   

,CASE WHEN MOL.TD_RUT IS NULL 
			THEN 0 
			ELSE 1 END				AS PE_MOLESTO

,PPN.TE_CARGABLE              		AS PE_CARGABLE
,PPN.TC_ELIMINADO	         		AS PC_ELIMINADO	
,PPN.TE_DISPONIBLE_OK         		AS PE_DISPONIBLE_OK
,PPN.TE_CON_MANDATO           		AS PE_CON_MANDATO
,PPN.TE_ENROLADO_360          		AS PE_ENROLADO_360
,PPN.TE_HABILITADO_360        		AS PE_HABILITADO_360
,PPN.TE_ACTIVO_360            		AS PE_ACTIVO_360
,PPN.TE_ESTADO_MULTIPASS      		AS PE_ESTADO_MULTIPASS
,PPN.TE_MANDATO_CCL           		AS PE_MANDATO_CCL
,PPN.TE_SIN_APR               		AS PE_SIN_APR
,PPN.TE_ART85                 		AS PE_ART85
,PPN.TE_FYP                   		AS PE_FYP
,PPN.TE_READY_CCL             		AS PE_READY_CCL
,PPN.TE_ACTIVAR_360           		AS PE_ACTIVAR_360
,PPN.TE_TOTAL_HABILITADORES   		AS PE_TOTAL_HABILITADORES
,PPN.TC_FECHA_HAB             		AS PC_FECHA_HAB
,PPN.TE_CMP_MANDATO_CCL       		AS PE_CMP_MANDATO_CCL
,PPN.TE_CMP_CTO_BEX           		AS PE_CMP_CTO_BEX
,PPN.TE_CMP_MIGRACION         		AS PE_CMP_MIGRACION
,PPN.TE_CMP_PROPENSO_MX       		AS PE_CMP_PROPENSO_MX
,PPN.TE_CMP_FOGAPE_REACTIVA   		AS PE_CMP_FOGAPE_REACTIVA
,PPN.TE_PRIORIDAD 					AS PE_PRIORIDAD
,PPN.TE_MTO_CMP						AS PE_MTO_CMP
,PPN.TE_DECIL						AS PE_DECIL
,PPN.TE_GEST_RCH_U3M				AS PE_GEST_RCH_U3M
,PPN.TE_REPITENCIA					AS PE_REPITENCIA
,PPN.TE_RCHMX						AS PE_RCHMX	
FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_01  PPN
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_PO_RUT POR
		ON PPN.TD_RUT = POR.TD_RUT		
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PLAN_PROY_FDR_MOL MOL
		ON PPN.TD_RUT = MOL.TD_RUT		
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_MAPEO MMP
		ON PPN.TD_RUT = MMP.IE_RUT			
;	
.IF ERRORCODE <> 0 THEN .QUIT 17;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_FR;	
.IF ERRORCODE <> 0 THEN .QUIT 18;


SELECT DATE, TIME; 

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 7 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: SACA REGLA DE HABILITADOR PARA CAMPANA PROPENSOS MN PLAN PROYECTOS		  **
--**                                                    				 				  **
--** AUTOR  : HARVIN VILCHEZ SANJINEZ                                                	  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 06/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN:                                                           				  **
--** AUTOR  :                                                           				  **
--** FECHA  : SSAAMMDD                                                  				  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS				  **
--**					MKT_JOURNEY_TB.WHOLESALE_HABILITADORES							  **
--**					MKT_EXPLORER_TB.WHOLESALE_ENROLADOS_360_HIST				      **
--**																	    			  **
--**																					  **
--** TABLA DE SALIDA:	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES**
--**					{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADORES   **
--**					{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADO_360  **
--**																			 	  	  **
--******************************************************************************************
--*****************************************************************************************/
 .SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/************************************************************
--** CREA TABLA TEMPORAL CON PARAMETROS DE EJECUCION	    **  
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO
(
	 TE_PERIODO_CMP			INTEGER
	,TF_FECHA_CMP			DATE FORMAT 'YYYY-MM-DD'
)
PRIMARY INDEX ( TE_PERIODO_CMP )
;
.IF ERRORCODE <> 0 THEN .QUIT 1;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO
SELECT 
	 SE_PERIODO_CMP 		AS TE_PERIODO_CMP
	,SF_FECHA_REF_DIA 		AS TF_FECHA_CMP

FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO;
.IF ERRORCODE <> 0 THEN .QUIT 3;


--/***********************************************************************
--**CREA TABLA DE SALIDA PARA CAMPANA HABILITADORES 				    **  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADORES;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADORES
(
	 PF_FECHA 				DATE FORMAT 'YYYY-MM-DD'
	,PE_RUT_HBL 			INTEGER
	,PE_ART85 				INTEGER
	,PE_SIN_APR 			INTEGER
	,PE_MANDATO_CCL 		INTEGER
	,PE_ESTADO_MULTIPASS 	INTEGER
	,PE_FYP_2 				INTEGER
	,PE_FYP_52 				INTEGER
	,PE_FYP_53 				INTEGER
	,PE_FYP_8 				INTEGER)
PRIMARY INDEX ( PE_RUT_HBL )
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADORES
SELECT
	 HBL.FECHA				AS PF_FECHA
	,HBL.RUT 				AS PE_RUT_HBL 				
    ,HBL.ART85 			    AS PE_ART85 			
    ,HBL.SIN_APR 		    AS PE_SIN_APR 		
    ,HBL.MANDATO_CCL 	    AS PE_MANDATO_CCL 	
    ,HBL.ESTADO_MULTIPASS   AS PE_ESTADO_MULTIPASS
    ,HBL.FYP_2 			    AS PE_FYP_2 			
    ,HBL.FYP_52 			AS PE_FYP_52 			
    ,HBL.FYP_53 			AS PE_FYP_53 			
    ,HBL.FYP_8              AS PE_FYP_8 			
FROM 
	MKT_JOURNEY_TB.WHOLESALE_HABILITADORES AS HBL
	INNER JOIN MKT_JOURNEYBUILDER_TB.S_CMP_PERIODO_CAMPANA AS PAR
		ON HBL.FECHA = PAR.SF_FECHA_REF_HB
GROUP BY
	 HBL.FECHA
	,HBL.RUT 			
    ,HBL.ART85 			
    ,HBL.SIN_APR 		
    ,HBL.MANDATO_CCL 	
    ,HBL.ESTADO_MULTIPASS
    ,HBL.FYP_2 			
    ,HBL.FYP_52 			
    ,HBL.FYP_53 			
    ,HBL.FYP_8
;
.IF ERRORCODE <> 0 THEN .QUIT 5;
	
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_RUT_HBL )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADORES;
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES          **  
--** CAMPOS ESTADO_MULTIPASS, MANDATO_CCL, SIN_APR, ART85, FECHA_HAB      ** 
--** CRUZANDO CON TABLA P_HABILITADORES  								  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADORES AS HBT
SET 
	 PE_ESTADO_MULTIPASS = HBT.PE_ESTADO_MULTIPASS
	,PE_MANDATO_CCL = HBT.PE_MANDATO_CCL
	,PE_SIN_APR = HBT.PE_SIN_APR
	,PE_ART85 = HBT.PE_ART85
	,PC_FECHA_HAB = CAST(HBT.PF_fecha AS VARCHAR(100))
WHERE
	PE_RUT = HBT.PE_RUT_HBL
;
.IF ERRORCODE <> 0 THEN .QUIT 7;

--/************************************************************
--** CREA TABLA TEMPORAL AGRUPAR RUT DE LOS HABILITADORES    **  
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_HABILITADORES_01;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_HABILITADORES_01
(
	 TE_RUT 			INTEGER
	,TE_IND_HAB			INTEGER)
PRIMARY INDEX ( TE_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 8;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_HABILITADORES_01
SELECT 
	 PE_RUT_HBL AS TE_RUT
	,CASE 
			WHEN PE_FYP_2=1 AND PE_FYP_52=1 AND PE_FYP_8=1 THEN 1
			WHEN PE_FYP_2=1 AND PE_FYP_53=1 AND PE_FYP_8=1 THEN 1
		ELSE 0 
	 END 	AS TE_IND_HAB
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADORES
;
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_HABILITADORES_01;
.IF ERRORCODE <> 0 THEN .QUIT 10;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES          **  
--** CAMPO FYP CRUZANDO CON TABLA T_JNY_WSBCCMN002OB_PROP_MN_HABILITADORES_01  ** 
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_HABILITADORES_01 AS HBL
SET
	PE_FYP = 1
WHERE
	PE_RUT = HBL.TE_RUT
	AND HBL.TE_IND_HAB = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 11;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES;
.IF ERRORCODE <> 0 THEN .QUIT 12;

--/***************************************************************
--** CREA TABLA DE SALIDA PARA HABILITADORES 360	     		**  
--***************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADO_360;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADO_360
(
	 PE_RUT_360 			INTEGER
    ,PE_HABILITADO 			INTEGER
    ,PE_ACTIVO_360 			INTEGER)
PRIMARY INDEX ( PE_RUT_360 )
;
.IF ERRORCODE <> 0 THEN .QUIT 13;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADO_360
SELECT 
	 ENRH.EMP_NUM_RUT 	AS PE_RUT_360 		
	,MAX(ENRH.EMP_HAB) 	AS PE_HABILITADO
	,MAX(ENRH.EMP_ACT) 	AS PE_ACTIVO_360
FROM 
	MKT_EXPLORER_TB.WHOLESALE_ENROLADOS_360_HIST AS ENRH
	INNER JOIN MKT_JOURNEYBUILDER_TB.S_CMP_PERIODO_CAMPANA AS PAR
		ON ENRH.FECHA = PAR.SF_FECHA_REF_ENR_360
GROUP BY 
	ENRH.EMP_NUM_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 14;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_RUT_360 )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADO_360;
.IF ERRORCODE <> 0 THEN .QUIT 15;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES          **  
--** CAMPOS HABILITADO_360, ACTIVO_360, ENROLADO_360 CRUZANDO CON         **  
--** TABLA P_HABILITADO_360                                               ** 
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADO_360 AS HBL
SET
	 PE_HABILITADO_360 = HBL.PE_HABILITADO
	,PE_ACTIVO_360 = HBL.PE_ACTIVO_360
	,PE_ENROLADO_360=1
WHERE
	PE_RUT = HBL.PE_RUT_360
;
.IF ERRORCODE <> 0 THEN .QUIT 16;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPO TOTAL_HABILITADORES  DONDE SIN_APR > 0                         **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES	
SET 
	PE_TOTAL_HABILITADORES = PE_TOTAL_HABILITADORES +1
WHERE 
	PE_SIN_APR > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 17;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPO TOTAL_HABILITADORES  DONDE ART85 > 0                           **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
SET 
	PE_TOTAL_HABILITADORES = PE_TOTAL_HABILITADORES +1
WHERE 
	PE_ART85 > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 18;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPO TOTAL_HABILITADORES  DONDE STADO_MULTIPASS > 0                 **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
SET 
	PE_TOTAL_HABILITADORES = PE_TOTAL_HABILITADORES +1
WHERE 
	PE_FYP > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 19;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPO TOTAL_HABILITADORES  DONDE FYP > 0                             **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
SET 
	PE_TOTAL_HABILITADORES = PE_TOTAL_HABILITADORES +1
WHERE 
	PE_ESTADO_MULTIPASS > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 20;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPO TOTAL_HABILITADORES  DONDE HABILITADO_360 > 0                  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
SET 
	PE_TOTAL_HABILITADORES = PE_TOTAL_HABILITADORES +1
WHERE 
	PE_HABILITADO_360 > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 21;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPO TOTAL_HABILITADORES  DONDE ENROLADO_360 > 0                    **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
SET 
	PE_TOTAL_HABILITADORES = PE_TOTAL_HABILITADORES +1
WHERE 
	PE_ENROLADO_360 > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 22;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPO TOTAL_HABILITADORES  DONDE MANDATO_CCL > 0                    **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
SET 
	PE_TOTAL_HABILITADORES = PE_TOTAL_HABILITADORES +1
WHERE 
	PE_MANDATO_CCL > 0
;
.IF ERRORCODE <> 0 THEN .QUIT 23;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPO READY_CCL                                                      **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
SET 
	PE_READY_CCL=1
WHERE 
	PE_ENROLADO_360 = 1 
	AND  PE_HABILITADO_360 = 1 
	AND PE_ACTIVO_360 = 1 
	AND PE_ESTADO_MULTIPASS  = 1  
	AND PE_MANDATO_CCL = 1  
	AND PE_SIN_APR  = 1  
	AND PE_ART85 = 1  
	AND PE_FYP = 1
;
.IF ERRORCODE <> 0 THEN .QUIT 24;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPO DISPONIBLE_OK                                                  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
SET 
	PE_DISPONIBLE_OK = 1
WHERE 
	COALESCE(PE_DISPONIBLE_MN_NEW,0) >= 30000000
	AND PC_MACRO_BANCA = 'EMPRESAS'
;
.IF ERRORCODE <> 0 THEN .QUIT 25;

UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
SET 
	PE_DISPONIBLE_OK = 1
WHERE 
	COALESCE(PE_DISPONIBLE_MN_NEW,0) >= 70000000
	AND PC_MACRO_BANCA = 'GRANDES EMPRESAS'
;
.IF ERRORCODE <> 0 THEN .QUIT 26;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPOS CMP_MANDATO_CCL, CMP_CTO_BEX, CMP_PROPENSO_MX, CMP_MIGRACION  **
--** CMP_FOGAPE_REACTIVA                                                  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
SET 
	 PE_CMP_MANDATO_CCL = 0
	,PE_CMP_CTO_BEX = 0
	,PE_CMP_PROPENSO_MX = 0
	,PE_CMP_MIGRACION = 0
	,PE_CMP_FOGAPE_REACTIVA = 0
;
.IF ERRORCODE <> 0 THEN .QUIT 27;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES;
.IF ERRORCODE <> 0 THEN .QUIT 28;


SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 7 OK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: SACA REGLA DE HABILITADOR PARA CAMPANA PROPENSOS MN PLAN PROYECTOS		  **
--**                                                    				 				  **
--** AUTOR  : HARVIN VILCHEZ SANJINEZ                                                	  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 06/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 08/2024			     	                                                  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS				      **
--**					MKT_JOURNEYBUILDER_TB.S_CMP_PERIODO_CAMPANA                       **
--**					MKT_JOURNEY_TB.WHOLESALE_HABILITADORES							  **
--**					MKT_EXPLORER_TB.WHOLESALE_ENROLADOS_360_HIST				      **
--**    {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_FR**
--**																	    			  **
--**TABLAS TEMPORALES:																	  **
--**	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO				  **     
--**	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADORES   				  **
--**	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADO_360  				  **
--**    {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_HAB_01	  **
--**																					  **
--** TABLA DE SALIDA:																	  **
--**    {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_HAB**
--**																			 	  	  **
--******************************************************************************************
--*****************************************************************************************/
 .SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/************************************************************
--** CREA TABLA TEMPORAL CON PARAMETROS DE EJECUCION	    **  
--************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO
(
	 TE_PERIODO_CMP			INTEGER
	,TF_FECHA_CMP			DATE FORMAT 'YYYY-MM-DD'
)
PRIMARY INDEX ( TE_PERIODO_CMP )
;
.IF ERRORCODE <> 0 THEN .QUIT 1;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO
SELECT 
	 SE_PERIODO_CMP 		AS TE_PERIODO_CMP
	,SF_FECHA_REF_DIA 		AS TF_FECHA_CMP

FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_PARAMETRO_FECHAS
;
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TE_PERIODO_CMP)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_PARAMETRO;
.IF ERRORCODE <> 0 THEN .QUIT 3;


--/***********************************************************************
--**CREA TABLA DE SALIDA PARA CAMPANA HABILITADORES 				    **  
--***********************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADORES;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADORES
(
	 PF_FECHA 				DATE FORMAT 'YYYY-MM-DD'
	,PE_RUT_HBL 			INTEGER
	,PE_ART85 				INTEGER
	,PE_SIN_APR 			INTEGER
	,PE_MANDATO_CCL 		INTEGER
	,PE_ESTADO_MULTIPASS 	INTEGER
	,PE_FYP_2 				INTEGER
	,PE_FYP_52 				INTEGER
	,PE_FYP_53 				INTEGER
	,PE_FYP_8 				INTEGER)
PRIMARY INDEX ( PE_RUT_HBL )
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADORES
SELECT
	 HBL.FECHA				AS PF_FECHA
	,HBL.RUT 				AS PE_RUT_HBL 				
    ,HBL.ART85 			    AS PE_ART85 			
    ,HBL.SIN_APR 		    AS PE_SIN_APR 		
    ,HBL.MANDATO_CCL 	    AS PE_MANDATO_CCL 	
    ,HBL.ESTADO_MULTIPASS   AS PE_ESTADO_MULTIPASS
    ,HBL.FYP_2 			    AS PE_FYP_2 			
    ,HBL.FYP_52 			AS PE_FYP_52 			
    ,HBL.FYP_53 			AS PE_FYP_53 			
    ,HBL.FYP_8              AS PE_FYP_8 			
FROM 
	MKT_JOURNEY_TB.WHOLESALE_HABILITADORES HBL
	INNER JOIN MKT_JOURNEYBUILDER_TB.S_CMP_PERIODO_CAMPANA PAR
		ON HBL.FECHA = PAR.SF_FECHA_REF_HB
GROUP BY
	 HBL.FECHA
	,HBL.RUT 			
    ,HBL.ART85 			
    ,HBL.SIN_APR 		
    ,HBL.MANDATO_CCL 	
    ,HBL.ESTADO_MULTIPASS
    ,HBL.FYP_2 			
    ,HBL.FYP_52 			
    ,HBL.FYP_53 			
    ,HBL.FYP_8
;
.IF ERRORCODE <> 0 THEN .QUIT 5;
	
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_RUT_HBL )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADORES;
.IF ERRORCODE <> 0 THEN .QUIT 6;


--/***************************************************************
--** CREA TABLA DE SALIDA PARA HABILITADORES 360	     		**  
--***************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADO_360;
CREATE TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADO_360
(
	 PE_RUT_360 			INTEGER
    ,PE_HABILITADO 			INTEGER
    ,PE_ACTIVO_360 			INTEGER)
PRIMARY INDEX ( PE_RUT_360 )
;
.IF ERRORCODE <> 0 THEN .QUIT 7;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADO_360
SELECT 
	 ENRH.EMP_NUM_RUT 	AS PE_RUT_360 		
	,MAX(ENRH.EMP_HAB) 	AS PE_HABILITADO
	,MAX(ENRH.EMP_ACT) 	AS PE_ACTIVO_360
FROM 
	MKT_EXPLORER_TB.WHOLESALE_ENROLADOS_360_HIST ENRH
	INNER JOIN MKT_JOURNEYBUILDER_TB.S_CMP_PERIODO_CAMPANA PAR
		ON ENRH.FECHA = PAR.SF_FECHA_REF_ENR_360
GROUP BY 
	ENRH.EMP_NUM_RUT
;
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_RUT_360 )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADO_360;
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/******************************************************************************************
--** SE CREA TABLA TEMPORAL														           **  
--** ALGUNOS CAMPO CRUZANDO CON TABLAS DE HABILITADORES         	                       ** 
--******************************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_HAB_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_HAB_01
(
	 TD_RUT 							DECIMAL(8,0)
	,TC_CLUSTER							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PO_DEUDA						INTEGER
	,TE_CTACTE							INTEGER
	,TE_LCG_VIGENTE						INTEGER
	,TE_DISPONIBLE_MN_NEW				BIGINT
	,TD_PROPENSION_MN					DECIMAL(25,10)
	,TC_MACRO_BANCA     				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE								CHAR(12) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DDA_A_LIBERAR_MES 				BIGINT 
	,TE_FLG_EXCLUSION					INTEGER
	,TC_MOTIVO_EXCLUSION				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TC_TEXTO1							VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2  						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3  						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_EN_PLANEAMIENTO					INTEGER 			
    ,TC_CALIFICACION_SBIF          		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,TD_PI_CLIENTE                		DECIMAL(25,10)			
	,TC_CLASIFICACION_SBIF       		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FDR                      		INTEGER 			
	,TE_COS_CLI                 		INTEGER 			
	,TE_FILTROS_RIESGOS          		INTEGER 			
	,TC_PAR_CALIFICACION_SBIF    		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE           		DECIMAL(25,10)		
	,TE_PAR_FDR                  		INTEGER 			
	,TE_PAR_COS_CLI             		INTEGER 			
	,TE_MOLESTO               			INTEGER 			
	,TE_CARGABLE						INTEGER
	,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DISPONIBLE_OK               	INTEGER
	,TE_CON_MANDATO             		INTEGER
	,TE_ENROLADO_360            		INTEGER
	,TE_HABILITADO_360           		INTEGER
	,TE_ACTIVO_360               		INTEGER
	,TE_ESTADO_MULTIPASS        		INTEGER
	,TE_MANDATO_CCL              		INTEGER
	,TE_SIN_APR                 		INTEGER
	,TE_ART85                     		INTEGER
	,TE_FYP                    			INTEGER
	,TE_READY_CCL              			INTEGER
	,TE_ACTIVAR_360              		INTEGER
	,TE_TOTAL_HABILITADORES       		INTEGER
	,TC_FECHA_HAB 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
	,TE_CMP_MANDATO_CCL					INTEGER
	,TE_CMP_CTO_BEX						INTEGER
	,TE_CMP_MIGRACION               	INTEGER
	,TE_CMP_PROPENSO_MX             	INTEGER
	,TE_CMP_FOGAPE_REACTIVA         	INTEGER
	,TE_PRIORIDAD                   	INTEGER
	,TE_MTO_CMP    						BIGINT
	,TE_DECIL							INTEGER
	,TE_GEST_RCH_U3M					INTEGER
	,TE_REPITENCIA						INTEGER
	,TE_RCHMX							INTEGER 
)PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 10;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_HAB_01
SELECT
 PPN.PD_RUT 		        		AS TD_RUT 			
,PPN.PC_CLUSTER						AS TC_CLUSTER	
,PPN.PC_RECOMENDACION_DE_CRUCE		AS TC_RECOMENDACION_DE_CRUCE	
,PPN.PE_PO_DEUDA 					AS TE_PO_DEUDA
,PPN.PE_CTACTE 						AS TE_CTACTE
,PPN.PE_LCG_VIGENTE					AS TE_LCG_VIGENTE
,PPN.PE_DISPONIBLE_MN_NEW			AS TE_DISPONIBLE_MN_NEW
,PPN.PD_PROPENSION_MN				AS TD_PROPENSION_MN
,PPN.PC_MACRO_BANCA					AS TC_MACRO_BANCA 
,PPN.PC_EJE							AS TC_EJE	
,PPN.PE_DDA_A_LIBERAR_MES			AS TE_DDA_A_LIBERAR_MES
,PPN.PE_FLG_EXCLUSION				AS TE_FLG_EXCLUSION
,PPN.PC_MOTIVO_EXCLUSION			AS TC_MOTIVO_EXCLUSION
,PPN.PC_TEXTO1						AS TC_TEXTO1
,PPN.PC_TEXTO2						AS TC_TEXTO2
,PPN.PC_TEXTO3						AS TC_TEXTO3
,PPN.PE_EN_PLANEAMIENTO				AS TE_EN_PLANEAMIENTO
,PPN.PC_CALIFICACION_SBIF			AS TC_CALIFICACION_SBIF         
,PPN.PF_PERIODO_CALIFICACION		AS TF_PERIODO_CALIFICACION    	
,PPN.PD_PI_CLIENTE 					AS TD_PI_CLIENTE      		
,PPN.PC_CLASIFICACION_SBIF			AS TC_CLASIFICACION_SBIF    
,PPN.PE_FDR            				AS TE_FDR    
,PPN.PE_COS_CLI            			AS TE_COS_CLI  
,PPN.PE_FILTROS_RIESGOS				AS TE_FILTROS_RIESGOS
,PPN.PC_PAR_CALIFICACION_SBIF		AS TC_PAR_CALIFICACION_SBIF    	
,PPN.PD_PAR_PI_CLIENTE 				AS TD_PAR_PI_CLIENTE           	
,PPN.PE_PAR_FDR                		AS TE_PAR_FDR       
,PPN.PE_PAR_COS_CLI    				AS TE_PAR_COS_CLI  
,PPN.PE_MOLESTO               		AS TE_MOLESTO 
,PPN.PE_CARGABLE              		AS TE_CARGABLE
,PPN.PC_ELIMINADO	         		AS TC_ELIMINADO	
,PPN.PE_DISPONIBLE_OK         		AS TE_DISPONIBLE_OK
,PPN.PE_CON_MANDATO           		AS TE_CON_MANDATO

,CASE WHEN HB3.PE_RUT_360 IS NOT NULL 
	THEN 1
	ELSE 0 END   					AS TE_ENROLADO_360   

,CASE WHEN HB3.PE_RUT_360 IS NOT NULL 
	THEN HB3.PE_HABILITADO
	ELSE 0 END  					AS TE_HABILITADO_360   

,CASE WHEN HB3.PE_RUT_360 IS NOT NULL 
	THEN HB3.PE_ACTIVO_360
	ELSE 0 END  					AS TE_ACTIVO_360        

,CASE WHEN HBT.PE_RUT_HBL IS NOT NULL 
	THEN HBT.PE_ESTADO_MULTIPASS
	ELSE 0 END 						AS TE_ESTADO_MULTIPASS    

,CASE WHEN HBT.PE_RUT_HBL IS NOT NULL 
	THEN HBT.PE_MANDATO_CCL
	ELSE 0 END 						AS TE_MANDATO_CCL 

,CASE WHEN HBT.PE_RUT_HBL IS NOT NULL 
	THEN HBT.PE_SIN_APR
	ELSE 0 END 						AS TE_SIN_APR 

,CASE WHEN HBT.PE_RUT_HBL IS NOT NULL 
	THEN HBT.PE_ART85
	ELSE 0 END 						AS TE_ART85 

,CASE 
	WHEN HBT.PE_FYP_2=1 AND HBT.PE_FYP_52=1 AND HBT.PE_FYP_8=1 THEN 1
	WHEN HBT.PE_FYP_2=1 AND HBT.PE_FYP_53=1 AND HBT.PE_FYP_8=1 THEN 1
	ELSE 0 END	 	        		AS TE_FYP   

,PPN.PE_READY_CCL             		AS TE_READY_CCL
,PPN.PE_ACTIVAR_360           		AS TE_ACTIVAR_360
,PPN.PE_TOTAL_HABILITADORES   		AS TE_TOTAL_HABILITADORES

,CASE WHEN HBT.PE_RUT_HBL IS NOT NULL 
	THEN CAST(HBT.PF_fecha AS VARCHAR(100))
	ELSE PPN.PC_FECHA_HAB END 		AS TC_FECHA_HAB 	

,PPN.PE_CMP_MANDATO_CCL       		AS TE_CMP_MANDATO_CCL
,PPN.PE_CMP_CTO_BEX           		AS TE_CMP_CTO_BEX
,PPN.PE_CMP_MIGRACION         		AS TE_CMP_MIGRACION
,PPN.PE_CMP_PROPENSO_MX       		AS TE_CMP_PROPENSO_MX
,PPN.PE_CMP_FOGAPE_REACTIVA   		AS TE_CMP_FOGAPE_REACTIVA
,PPN.PE_PRIORIDAD 					AS TE_PRIORIDAD
,PPN.PE_MTO_CMP						AS TE_MTO_CMP
,PPN.PE_DECIL						AS TE_DECIL
,PPN.PE_GEST_RCH_U3M				AS TE_GEST_RCH_U3M
,PPN.PE_REPITENCIA					AS TE_REPITENCIA
,PPN.PE_RCHMX						AS TE_RCHMX	
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_FR  PPN
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADORES HBT	
		ON PPN.PD_RUT = HBT.PE_RUT_HBL
	LEFT JOIN {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_HABILITADO_360 HB3
		ON PPN.PD_RUT = HB3.PE_RUT_360	
;
.IF ERRORCODE <> 0 THEN .QUIT 11;	

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_HAB_01;
.IF ERRORCODE <> 0 THEN .QUIT 12;

/***********************************************************************************************
    CREA TABLA PRE CALCULO
************************************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_HAB;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_HAB
(
	 PD_RUT 							DECIMAL(8,0)
	,PC_CLUSTER							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PO_DEUDA						INTEGER
	,PE_CTACTE							INTEGER
	,PE_LCG_VIGENTE						INTEGER
	,PE_DISPONIBLE_MN_NEW				BIGINT
	,PD_PROPENSION_MN					DECIMAL(25,10)
	,PC_MACRO_BANCA     				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_EJE								CHAR(12) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_DDA_A_LIBERAR_MES 				BIGINT 
	,PE_FLG_EXCLUSION					INTEGER
	,PC_MOTIVO_EXCLUSION				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
	,PC_TEXTO1							VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO2  						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO3  						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_EN_PLANEAMIENTO					INTEGER 			
    ,PC_CALIFICACION_SBIF          		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,PF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,PD_PI_CLIENTE                		DECIMAL(25,10)			
	,PC_CLASIFICACION_SBIF       		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,PE_FDR                      		INTEGER 			
	,PE_COS_CLI                 		INTEGER 			
	,PE_FILTROS_RIESGOS          		INTEGER 			
	,PC_PAR_CALIFICACION_SBIF    		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
	,PD_PAR_PI_CLIENTE           		DECIMAL(25,10)		
	,PE_PAR_FDR                  		INTEGER 			
	,PE_PAR_COS_CLI             		INTEGER 			
	,PE_MOLESTO               			INTEGER 			
	,PE_CARGABLE						INTEGER
	,PC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_DISPONIBLE_OK               	INTEGER
	,PE_CON_MANDATO             		INTEGER
	,PE_ENROLADO_360            		INTEGER
	,PE_HABILITADO_360           		INTEGER
	,PE_ACTIVO_360               		INTEGER
	,PE_ESTADO_MULTIPASS        		INTEGER
	,PE_MANDATO_CCL              		INTEGER
	,PE_SIN_APR                 		INTEGER
	,PE_ART85                     		INTEGER
	,PE_FYP                    			INTEGER
	,PE_READY_CCL              			INTEGER
	,PE_ACTIVAR_360              		INTEGER
	,PE_TOTAL_HABILITADORES       		INTEGER
	,PC_FECHA_HAB 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
	,PE_CMP_MANDATO_CCL					INTEGER
	,PE_CMP_CTO_BEX						INTEGER
	,PE_CMP_MIGRACION               	INTEGER
	,PE_CMP_PROPENSO_MX             	INTEGER
	,PE_CMP_FOGAPE_REACTIVA         	INTEGER
	,PE_PRIORIDAD                   	INTEGER
	,PE_MTO_CMP    						BIGINT
	,PE_DECIL							INTEGER
	,PE_GEST_RCH_U3M					INTEGER
	,PE_REPITENCIA						INTEGER
	,PE_RCHMX							INTEGER 
)PRIMARY INDEX ( PD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 10;

/***********************************************************************************************
    INSERTA TABBLA PROPENSO
************************************************************************************************/
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_HAB
SELECT
 PPN.TD_RUT 		        		AS PD_RUT 			
,PPN.TC_CLUSTER						AS PC_CLUSTER	
,PPN.TC_RECOMENDACION_DE_CRUCE		AS PC_RECOMENDACION_DE_CRUCE	
,PPN.TE_PO_DEUDA 					AS PE_PO_DEUDA
,PPN.TE_CTACTE 						AS PE_CTACTE
,PPN.TE_LCG_VIGENTE					AS PE_LCG_VIGENTE
,PPN.TE_DISPONIBLE_MN_NEW			AS PE_DISPONIBLE_MN_NEW
,PPN.TD_PROPENSION_MN				AS PD_PROPENSION_MN
,PPN.TC_MACRO_BANCA					AS PC_MACRO_BANCA 
,PPN.TC_EJE							AS PC_EJE	
,PPN.TE_DDA_A_LIBERAR_MES			AS PE_DDA_A_LIBERAR_MES
,PPN.TE_FLG_EXCLUSION				AS PE_FLG_EXCLUSION
,PPN.TC_MOTIVO_EXCLUSION			AS PC_MOTIVO_EXCLUSION
,PPN.TC_TEXTO1						AS PC_TEXTO1
,PPN.TC_TEXTO2						AS PC_TEXTO2
,PPN.TC_TEXTO3						AS PC_TEXTO3
,PPN.TE_EN_PLANEAMIENTO				AS PE_EN_PLANEAMIENTO
,PPN.TC_CALIFICACION_SBIF			AS PC_CALIFICACION_SBIF         
,PPN.TF_PERIODO_CALIFICACION		AS PF_PERIODO_CALIFICACION    	
,PPN.TD_PI_CLIENTE 					AS PD_PI_CLIENTE      		
,PPN.TC_CLASIFICACION_SBIF			AS PC_CLASIFICACION_SBIF    
,PPN.TE_FDR            				AS PE_FDR    
,PPN.TE_COS_CLI            			AS PE_COS_CLI  
,PPN.TE_FILTROS_RIESGOS				AS PE_FILTROS_RIESGOS
,PPN.TC_PAR_CALIFICACION_SBIF		AS PC_PAR_CALIFICACION_SBIF    	

,PPN.TD_PAR_PI_CLIENTE 				AS PD_PAR_PI_CLIENTE           	
,PPN.TE_PAR_FDR                		AS PE_PAR_FDR       
,PPN.TE_PAR_COS_CLI    				AS PE_PAR_COS_CLI  
  
,PPN.TE_MOLESTO               		AS PE_MOLESTO 
,PPN.TE_CARGABLE              		AS PE_CARGABLE
,PPN.TC_ELIMINADO	         		AS PC_ELIMINADO	

,CASE 
	WHEN COALESCE(PPN.TE_DISPONIBLE_MN_NEW,0) >= 30000000 AND PPN.TC_MACRO_BANCA = 'EMPRESAS' 			THEN 1
	WHEN COALESCE(PPN.TE_DISPONIBLE_MN_NEW,0) >= 70000000 AND PPN.TC_MACRO_BANCA = 'GRANDES EMPRESAS'	THEN 1
	ELSE 0 END
						          	AS PE_DISPONIBLE_OK   

,0					             	AS PE_CON_MANDATO  
,PPN.TE_ENROLADO_360          		AS PE_ENROLADO_360
,PPN.TE_HABILITADO_360        		AS PE_HABILITADO_360
,PPN.TE_ACTIVO_360            		AS PE_ACTIVO_360
,PPN.TE_ESTADO_MULTIPASS      		AS PE_ESTADO_MULTIPASS
,PPN.TE_MANDATO_CCL           		AS PE_MANDATO_CCL
,PPN.TE_SIN_APR               		AS PE_SIN_APR
,PPN.TE_ART85                 		AS PE_ART85
,PPN.TE_FYP                   		AS PE_FYP

,CASE  
	WHEN COALESCE(PPN.TE_ENROLADO_360,0) = 1 AND COALESCE(PPN.TE_HABILITADO_360,0) = 1 
	AND  COALESCE(PPN.TE_ACTIVO_360,0) = 1 	 AND COALESCE(PPN.TE_ESTADO_MULTIPASS,0)  = 1  
	AND  COALESCE(PPN.TE_MANDATO_CCL,0) = 1  AND COALESCE(PPN.TE_SIN_APR,0)  = 1  
	AND  COALESCE(PPN.TE_ART85,0) = 1  		 AND COALESCE(PPN.TE_FYP,0) = 1
	THEN 1
	ELSE 0 END      				AS PE_READY_CCL 

,PPN.TE_ACTIVAR_360           		AS PE_ACTIVAR_360

,COALESCE(PPN.TE_SIN_APR,0)          + COALESCE(PPN.TE_ART85,0)          + COALESCE(PPN.TE_FYP,0) + 
 COALESCE(PPN.TE_ESTADO_MULTIPASS,0) + COALESCE(PPN.TE_HABILITADO_360,0) + 
 COALESCE(PPN.TE_ENROLADO_360,0)     + COALESCE(PPN.TE_MANDATO_CCL,0)   	
									AS PE_TOTAL_HABILITADORES    

,PPN.TC_FECHA_HAB             		AS PC_FECHA_HAB
,PPN.TE_CMP_MANDATO_CCL       		AS PE_CMP_MANDATO_CCL

,0									AS PE_CMP_CTO_BEX		
,0						       		AS PE_CMP_MIGRACION            
,0						            AS PE_CMP_PROPENSO_MX          
,0							        AS PE_CMP_FOGAPE_REACTIVA  

,PPN.TE_PRIORIDAD 					AS PE_PRIORIDAD
,PPN.TE_MTO_CMP						AS PE_MTO_CMP
,PPN.TE_DECIL						AS PE_DECIL
,PPN.TE_GEST_RCH_U3M				AS PE_GEST_RCH_U3M
,PPN.TE_REPITENCIA					AS PE_REPITENCIA
,PPN.TE_RCHMX						AS PE_RCHMX	
FROM {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_HAB_01 PPN
;	
.IF ERRORCODE <> 0 THEN .QUIT 14;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_HAB;
.IF ERRORCODE <> 0 THEN .QUIT 15;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 8 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN:	SACA REGLA DE NEGOCIO PARA CAMPANA PROPENSOS MN PLAN PROYECTOS 			  **
--**                                                    				 				  **
--** AUTOR  : HARVIN VILCHEZ SANJINEZ                                                	  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 06/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN: Se agrega como regla prioridad 6                                            **
--** AUTOR  : Ignacio Lagos                                                          	  **
--** FECHA  : 17/11/2023                                                 				  **
--/*****************************************************************************************
--** MANTNCN: FILTRO CLIENTE NO DESEADOS Y SE ADICIONA NUEVO FILTRO DE RECHAZO MX         **
--** AUTOR  : IGNACIO LAGOS                                                          	  **
--** FECHA  : 02/2024                                                  				      **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES**
--**					MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CLIENTE_EJECUTIVO			  **
--**																					  **
--** TABLA DE SALIDA:	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES**
--**                                      												  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/***************************************************************
--** CREA TABLA TEMPORAL PARA CODIGOS MACRO BANCA			    **
--***************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MACRO_BANCA;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MACRO_BANCA
(
	TC_MACRO_BANCA		VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC)
PRIMARY INDEX ( TC_MACRO_BANCA )
;
.IF ERRORCODE <> 0 THEN .QUIT 1;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MACRO_BANCA VALUES ('EMPRESAS');
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MACRO_BANCA VALUES ('GRANDES EMPRESAS');
.IF ERRORCODE <> 0 THEN .QUIT 2;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TC_MACRO_BANCA )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MACRO_BANCA;
.IF ERRORCODE <> 0 THEN .QUIT 3;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES          **  
--** CAMPO CARGABLE CON REGLAS DE NEGOCIO CLINETES PASAN RIESGO, DEL      **
--** DECIL 1 AL 5 CON DISPONIBLE OK Y SIN RECHAZOS LOS ULTIMOS 3 MESES
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
--FROM 
--	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MACRO_BANCA AS MBC
SET 
	PE_CARGABLE = 1
WHERE
--	PC_MACRO_BANCA = MBC.TC_MACRO_BANCA
	PC_MACRO_BANCA IN (SELECT TC_MACRO_BANCA FROM EDW_TEMPUSU.T_JNY_WSBCCMN002OB_PROP_MN_MACRO_BANCA)
	AND PE_CTACTE > 0 
	AND PE_DECIL BETWEEN 1 AND 5
	AND PE_LCG_VIGENTE > 0  
	AND PE_DISPONIBLE_OK > 0 
	AND PE_FILTROS_RIESGOS > 0 
	AND NOT(COALESCE(PC_EJE,'0') = '0')
	AND PE_MOLESTO >= 0  
	AND PE_FLG_EXCLUSION = 0
	AND PE_GEST_RCH_U3M = 0
	AND PE_RCHMX = 0
	AND PE_REPITENCIA = 0
	
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPOS PRIORIDAD, MTO_CMP DONDE CARGABLE = 0 Y PRIORIDAD = 99        **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
SET 
	 PE_PRIORIDAD = 1
	,PE_MTO_CMP = PE_DISPONIBLE_MN_NEW
WHERE 
	PE_CARGABLE = 1 
	AND PE_PRIORIDAD = 99
	AND PE_REPITENCIA = 0
;
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES          **  
--** CLIENTES PASAN RIESGO QUE SON DEL DECIL 1 AL 5 Y QUE TIENEN LÍNEA    **
--** VIGENTE Y SIN RHC LOS 3 ULT MESES
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
--FROM 
--	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MACRO_BANCA AS MBC
SET 
	 PE_PRIORIDAD = 2
	,PE_CARGABLE = 1
	,PE_MTO_CMP = 0
WHERE
	--PC_MACRO_BANCA = MBC.TC_MACRO_BANCA
	PC_MACRO_BANCA IN (SELECT TC_MACRO_BANCA FROM EDW_TEMPUSU.T_JNY_WSBCCMN002OB_PROP_MN_MACRO_BANCA)
	AND PE_CARGABLE = 0 
	AND PE_PRIORIDAD = 99	
	AND PE_FILTROS_RIESGOS > 0
	AND PE_CTACTE > 0 
	AND PE_FLG_EXCLUSION = 0
	AND PE_DECIL BETWEEN 1 AND 5
	AND PE_LCG_VIGENTE > 0 
	AND PE_GEST_RCH_U3M = 0
	AND PE_RCHMX = 0
	AND PE_REPITENCIA = 0
;
.IF ERRORCODE <> 0 THEN .QUIT 6;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES          **  
--** CLIENTES PASAN RIESGO QUE SON DEL DECIL 1 AL 2, SIN RCH LOS   		  ** 
--** 3 ULTIMOS MESES					  								  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
--FROM 
--	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MACRO_BANCA AS MBC
SET 
	 PE_PRIORIDAD = 3
	,PE_CARGABLE = 1
	
WHERE
	--PC_MACRO_BANCA = MBC.TC_MACRO_BANCA
	PC_MACRO_BANCA IN (SELECT TC_MACRO_BANCA FROM EDW_TEMPUSU.T_JNY_WSBCCMN002OB_PROP_MN_MACRO_BANCA)
	AND PE_CARGABLE = 0 
	AND PE_PRIORIDAD = 99	
	AND PE_FILTROS_RIESGOS > 0
	AND PE_CTACTE > 0 
	AND PE_FLG_EXCLUSION = 0
	AND PE_DECIL BETWEEN 1 AND 2
	AND PE_GEST_RCH_U3M = 0
	AND PE_RCHMX = 0
	AND PE_REPITENCIA = 0
;
.IF ERRORCODE <> 0 THEN .QUIT 7;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** DE CLIENTES A CAMPAÑA DIGITAL                       **
--*************************************************************************/

UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
--FROM 
--	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_PROP_MN_MACRO_BANCA AS MBC
SET
	PE_PRIORIDAD = 6
	,PE_CARGABLE = 1
	
WHERE 
	--PC_MACRO_BANCA = MBC.TC_MACRO_BANCA
	PC_MACRO_BANCA IN (SELECT TC_MACRO_BANCA FROM EDW_TEMPUSU.T_JNY_WSBCCMN002OB_PROP_MN_MACRO_BANCA)
	AND PE_FILTROS_RIESGOS > 0
	AND PE_CTACTE > 0 
	AND PE_FLG_EXCLUSION = 0
	AND PE_GEST_RCH_U3M = 0
	AND PE_RCHMX = 0
	AND PE_LCG_VIGENTE > 0  
	AND PE_REPITENCIA = 1
	AND PE_DECIL >= 3
;
		
--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPOS CARGABLE DONDE CARGABLE = 1 Y EJE = '0'                       **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
SET 
	PE_CARGABLE = 0
WHERE 
	PE_CARGABLE = 1 
	AND COALESCE(PC_EJE,'0') = '0'
;
.IF ERRORCODE <> 0 THEN .QUIT 8;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPOS ELIMINADO 							                          **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
SET 
	PC_ELIMINADO = 
	CASE
		WHEN COALESCE(PC_MACRO_BANCA,'')  NOT IN ('EMPRESAS', 'GRANDES EMPRESAS')   
				THEN '01.- BANCA NO EM/EG'
		WHEN COALESCE(PE_CTACTE,0) = 0											   
				THEN '02.- SIN CTACTE'
		WHEN COALESCE(PE_PO_DEUDA,0) = 0											   
				THEN '03.- NO ES PO DEUDA'
		WHEN COALESCE(PE_LCG_VIGENTE,0) = 0										   
				THEN '04.- SIN LINEA VIGENTE'
		WHEN COALESCE(PE_DISPONIBLE_OK,0) = 0									   
				THEN '05.- SIN DISP MINIMO MM$70 EG y MM$=30 EM'
		WHEN COALESCE(PE_FILTROS_RIESGOS,0) = 0
				THEN '06.- FILTROS RIESGOS'
		WHEN PC_CLUSTER NOT IN ('INACTIVO','READY','TOPADO')							
				THEN '09.- CLUSTER DISTINTO A INACTIVO,READY,TOPADO'
		WHEN PD_PROPENSION_MN < 0.059
				THEN '10.- PROPENSION < 6%'
		WHEN COALESCE(PC_EJE,'0') = '0'											
				THEN '11.- SIN EJECUTIVO'
		WHEN COALESCE(PE_CMP_FOGAPE_REACTIVA,0) > 0
				THEN '12.- EN CMP FOGAPE REACTIVA'
		WHEN COALESCE(PE_MOLESTO,0) = 1
				THEN '13.- NO MOLESTAR'
		WHEN COALESCE(PE_FLG_EXCLUSION,0) = 1					
				THEN '14.- EXCLUIR : ' || RTRIM(PC_MOTIVO_EXCLUSION)
		WHEN COALESCE(PE_GEST_RCH_U3M,0) = 1
				THEN '15.- RECHAZO EN LOS 3 ULT MESES'	
		WHEN COALESCE(PE_RCHMX,0) = 1
				THEN '16.- RECHAZO OPERA MX'			
		ELSE ''
	 END
WHERE 
	PE_CARGABLE =0
;
.IF ERRORCODE <> 0 THEN .QUIT 9;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES;
.IF ERRORCODE <> 0 THEN .QUIT 10;

--/*************************************************************************
--** Se APLICAN FILTROS DE EMPRESAS NO DESEADAS A CARGAR 		 		  **  
--*************************************************************************/

DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_MAE_CEJ_FILTRO_EMP_CLIENTE_PL;

CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_MAE_CEJ_FILTRO_EMP_CLIENTE_PL
(
 TD_RUT DECIMAL(8,0)
)PRIMARY INDEX (TD_RUT)
;
.IF ERRORCODE <> 0 THEN .QUIT 11;


INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_MAE_CEJ_FILTRO_EMP_CLIENTE_PL
SELECT IE_CLI_RUT AS TD_RUT
FROM MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CLIENTE_EJECUTIVO
WHERE IC_NOM_CLI = 'EMPRESAS JUAN YARUR SPA'
;
.IF ERRORCODE <> 0 THEN .QUIT 12;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_MAE_CEJ_FILTRO_EMP_CLIENTE_PL
SELECT IE_CLI_RUT AS TD_RUT
FROM MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CLIENTE_EJECUTIVO
WHERE IC_NOM_CLI = 'EMPRESAS JY S A'
;
.IF ERRORCODE <> 0 THEN .QUIT 13;

COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_MAE_CEJ_FILTRO_EMP_CLIENTE_PL;
	
.IF ERRORCODE <> 0 THEN .QUIT 14;


--/***********************************************************************
--** 							UPDATE NO DESEADO					    **  
--***********************************************************************/

UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
FROM 
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_MAE_CEJ_FILTRO_EMP_CLIENTE_PL AS FLT

SET 
	 PE_CARGABLE = 0
	,PC_ELIMINADO ='CLIENTE EMPRESA YARUR'
WHERE
	PE_RUT = FLT.TD_RUT
;

.IF ERRORCODE <> 0 THEN .QUIT 15;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;

UPDATE - Ejemplo 8 OK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN:	SACA REGLA DE NEGOCIO PARA CAMPANA PROPENSOS MN PLAN PROYECTOS 			  **
--**                                                    				 				  **
--** AUTOR  : HARVIN VILCHEZ SANJINEZ                                                	  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 06/2022                                                   				  ** 
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN: Se agrega como regla prioridad 6                                            **
--** AUTOR  : Ignacio Lagos                                                          	  **
--** FECHA  : 17/11/2023                                                 				  **
--/*****************************************************************************************
--** MANTNCN: FILTRO CLIENTE NO DESEADOS Y SE ADICIONA NUEVO FILTRO DE RECHAZO MX         **
--** AUTOR  : IGNACIO LAGOS                                                          	  **
--** FECHA  : 02/2024                                                  				      **
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 08/2024			     	                                                  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:																	  **
--**    {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_HAB
--**    MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CLIENTE_EJECUTIVO
--**
--**TABLA TEMPORAL:
--**	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_01
--**	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_02
--**	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_03
--**	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_04
--**																					  **
--** TABLA DE SALIDA:																	  **
--**    {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_RN
--**                                      												  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8'; 
SELECT DATE, TIME;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES          **  
--** CAMPO CARGABLE CON REGLAS DE NEGOCIO CLINETES PASAN RIESGO, DEL      **
--** DECIL 1 AL 5 CON DISPONIBLE OK Y SIN RECHAZOS LOS ULTIMOS 3 MESES
--*************************************************************************/
--/*************************************************************************
--** CAMPOS PRIORIDAD, MTO_CMP DONDE CARGABLE = 0 Y PRIORIDAD = 99        **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_01
(
	 TD_RUT 							DECIMAL(8,0)
	,TC_CLUSTER							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PO_DEUDA						INTEGER
	,TE_CTACTE							INTEGER
	,TE_LCG_VIGENTE						INTEGER
	,TE_DISPONIBLE_MN_NEW				BIGINT
	,TD_PROPENSION_MN					DECIMAL(25,10)
	,TC_MACRO_BANCA     				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE								CHAR(12) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DDA_A_LIBERAR_MES 				BIGINT 
	,TE_FLG_EXCLUSION					INTEGER
	,TC_MOTIVO_EXCLUSION				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TC_TEXTO1							VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2  						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3  						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_EN_PLANEAMIENTO					INTEGER 			
    ,TC_CALIFICACION_SBIF          		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,TD_PI_CLIENTE                		DECIMAL(25,10)			
	,TC_CLASIFICACION_SBIF       		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FDR                      		INTEGER 			
	,TE_COS_CLI                 		INTEGER 			
	,TE_FILTROS_RIESGOS          		INTEGER 			
	,TC_PAR_CALIFICACION_SBIF    		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE           		DECIMAL(25,10)		
	,TE_PAR_FDR                  		INTEGER 			
	,TE_PAR_COS_CLI             		INTEGER 			
	,TE_MOLESTO               			INTEGER 			
	,TE_CARGABLE						INTEGER
	,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DISPONIBLE_OK               	INTEGER
	,TE_CON_MANDATO             		INTEGER
	,TE_ENROLADO_360            		INTEGER
	,TE_HABILITADO_360           		INTEGER
	,TE_ACTIVO_360               		INTEGER
	,TE_ESTADO_MULTIPASS        		INTEGER
	,TE_MANDATO_CCL              		INTEGER
	,TE_SIN_APR                 		INTEGER
	,TE_ART85                     		INTEGER
	,TE_FYP                    			INTEGER
	,TE_READY_CCL              			INTEGER
	,TE_ACTIVAR_360              		INTEGER
	,TE_TOTAL_HABILITADORES       		INTEGER
	,TC_FECHA_HAB 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
	,TE_CMP_MANDATO_CCL					INTEGER
	,TE_CMP_CTO_BEX						INTEGER
	,TE_CMP_MIGRACION               	INTEGER
	,TE_CMP_PROPENSO_MX             	INTEGER
	,TE_CMP_FOGAPE_REACTIVA         	INTEGER
	,TE_PRIORIDAD                   	INTEGER
	,TE_MTO_CMP    						BIGINT
	,TE_DECIL							INTEGER
	,TE_GEST_RCH_U3M					INTEGER
	,TE_REPITENCIA						INTEGER
	,TE_RCHMX							INTEGER 
)PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 01;


INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_01
SELECT
 PPN.PD_RUT 		        		AS TD_RUT 			
,PPN.PC_CLUSTER						AS TC_CLUSTER	
,PPN.PC_RECOMENDACION_DE_CRUCE		AS TC_RECOMENDACION_DE_CRUCE	
,PPN.PE_PO_DEUDA 					AS TE_PO_DEUDA
,PPN.PE_CTACTE 						AS TE_CTACTE
,PPN.PE_LCG_VIGENTE					AS TE_LCG_VIGENTE
,PPN.PE_DISPONIBLE_MN_NEW			AS TE_DISPONIBLE_MN_NEW
,PPN.PD_PROPENSION_MN				AS TD_PROPENSION_MN
,PPN.PC_MACRO_BANCA					AS TC_MACRO_BANCA 
,PPN.PC_EJE							AS TC_EJE	
,PPN.PE_DDA_A_LIBERAR_MES			AS TE_DDA_A_LIBERAR_MES
,PPN.PE_FLG_EXCLUSION				AS TE_FLG_EXCLUSION
,PPN.PC_MOTIVO_EXCLUSION			AS TC_MOTIVO_EXCLUSION
,PPN.PC_TEXTO1						AS TC_TEXTO1
,PPN.PC_TEXTO2						AS TC_TEXTO2
,PPN.PC_TEXTO3						AS TC_TEXTO3
,PPN.PE_EN_PLANEAMIENTO				AS TE_EN_PLANEAMIENTO
,PPN.PC_CALIFICACION_SBIF			AS TC_CALIFICACION_SBIF         
,PPN.PF_PERIODO_CALIFICACION		AS TF_PERIODO_CALIFICACION    	
,PPN.PD_PI_CLIENTE 					AS TD_PI_CLIENTE      		
,PPN.PC_CLASIFICACION_SBIF			AS TC_CLASIFICACION_SBIF    
,PPN.PE_FDR            				AS TE_FDR    
,PPN.PE_COS_CLI            			AS TE_COS_CLI  
,PPN.PE_FILTROS_RIESGOS				AS TE_FILTROS_RIESGOS
,PPN.PC_PAR_CALIFICACION_SBIF		AS TC_PAR_CALIFICACION_SBIF    	
,PPN.PD_PAR_PI_CLIENTE 				AS TD_PAR_PI_CLIENTE           	
,PPN.PE_PAR_FDR                		AS TE_PAR_FDR       
,PPN.PE_PAR_COS_CLI    				AS TE_PAR_COS_CLI  
,PPN.PE_MOLESTO               		AS TE_MOLESTO 

,CASE WHEN PPN.PC_MACRO_BANCA IN ('EMPRESAS','GRANDES EMPRESAS')	
	AND PPN.PE_CTACTE > 0 
	AND PPN.PE_DECIL BETWEEN 1 AND 5
	AND PPN.PE_LCG_VIGENTE > 0  
	AND PPN.PE_DISPONIBLE_OK > 0 
	AND PPN.PE_FILTROS_RIESGOS > 0 
	AND NOT(COALESCE(PPN.PC_EJE,'0') = '0') 
	AND PPN.PE_MOLESTO >= 0  
	AND PPN.PE_FLG_EXCLUSION = 0
	AND PPN.PE_GEST_RCH_U3M = 0
	AND PPN.PE_RCHMX = 0
	AND PPN.PE_REPITENCIA = 0
		THEN 1						
		ELSE PPN.PE_CARGABLE END	AS TE_CARGABLE		

,PPN.PC_ELIMINADO	         		AS TC_ELIMINADO	
,PPN.PE_DISPONIBLE_OK         		AS TE_DISPONIBLE_OK
,PPN.PE_CON_MANDATO           		AS TE_CON_MANDATO
,PPN.PE_ENROLADO_360          		AS TE_ENROLADO_360
,PPN.PE_HABILITADO_360        		AS TE_HABILITADO_360
,PPN.PE_ACTIVO_360            		AS TE_ACTIVO_360
,PPN.PE_ESTADO_MULTIPASS      		AS TE_ESTADO_MULTIPASS
,PPN.PE_MANDATO_CCL           		AS TE_MANDATO_CCL
,PPN.PE_SIN_APR               		AS TE_SIN_APR
,PPN.PE_ART85                 		AS TE_ART85
,PPN.PE_FYP                   		AS TE_FYP
,PPN.PE_READY_CCL             		AS TE_READY_CCL
,PPN.PE_ACTIVAR_360           		AS TE_ACTIVAR_360
,PPN.PE_TOTAL_HABILITADORES   		AS TE_TOTAL_HABILITADORES
,PPN.PC_FECHA_HAB             		AS TC_FECHA_HAB
,PPN.PE_CMP_MANDATO_CCL       		AS TE_CMP_MANDATO_CCL
,PPN.PE_CMP_CTO_BEX           		AS TE_CMP_CTO_BEX
,PPN.PE_CMP_MIGRACION         		AS TE_CMP_MIGRACION
,PPN.PE_CMP_PROPENSO_MX       		AS TE_CMP_PROPENSO_MX
,PPN.PE_CMP_FOGAPE_REACTIVA   		AS TE_CMP_FOGAPE_REACTIVA
,PPN.PE_PRIORIDAD 					AS TE_PRIORIDAD
,PPN.PE_MTO_CMP						AS TE_MTO_CMP
,PPN.PE_DECIL						AS TE_DECIL
,PPN.PE_GEST_RCH_U3M				AS TE_GEST_RCH_U3M
,PPN.PE_REPITENCIA					AS TE_REPITENCIA
,PPN.PE_RCHMX						AS TE_RCHMX	
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_HAB  PPN
;
.IF ERRORCODE <> 0 THEN .QUIT 02;	

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_01;	
.IF ERRORCODE <> 0 THEN .QUIT 03;


--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES          **  
--** CAMPO CARGABLE CON REGLAS DE NEGOCIO CLINETES PASAN RIESGO, DEL      **
--** DECIL 1 AL 5 CON DISPONIBLE OK Y SIN RECHAZOS LOS ULTIMOS 3 MESES
--*************************************************************************/
--/*************************************************************************
--** CAMPOS PRIORIDAD, MTO_CMP DONDE CARGABLE = 0 Y PRIORIDAD = 99        **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_02;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_02
(
	 TD_RUT 							DECIMAL(8,0)
	,TC_CLUSTER							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PO_DEUDA						INTEGER
	,TE_CTACTE							INTEGER
	,TE_LCG_VIGENTE						INTEGER
	,TE_DISPONIBLE_MN_NEW				BIGINT
	,TD_PROPENSION_MN					DECIMAL(25,10)
	,TC_MACRO_BANCA     				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE								CHAR(12) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DDA_A_LIBERAR_MES 				BIGINT 
	,TE_FLG_EXCLUSION					INTEGER
	,TC_MOTIVO_EXCLUSION				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TC_TEXTO1							VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2  						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3  						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_EN_PLANEAMIENTO					INTEGER 			
    ,TC_CALIFICACION_SBIF          		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,TD_PI_CLIENTE                		DECIMAL(25,10)			
	,TC_CLASIFICACION_SBIF       		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FDR                      		INTEGER 			
	,TE_COS_CLI                 		INTEGER 			
	,TE_FILTROS_RIESGOS          		INTEGER 			
	,TC_PAR_CALIFICACION_SBIF    		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE           		DECIMAL(25,10)		
	,TE_PAR_FDR                  		INTEGER 			
	,TE_PAR_COS_CLI             		INTEGER 			
	,TE_MOLESTO               			INTEGER 			
	,TE_CARGABLE						INTEGER
	,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DISPONIBLE_OK               	INTEGER
	,TE_CON_MANDATO             		INTEGER
	,TE_ENROLADO_360            		INTEGER
	,TE_HABILITADO_360           		INTEGER
	,TE_ACTIVO_360               		INTEGER
	,TE_ESTADO_MULTIPASS        		INTEGER
	,TE_MANDATO_CCL              		INTEGER
	,TE_SIN_APR                 		INTEGER
	,TE_ART85                     		INTEGER
	,TE_FYP                    			INTEGER
	,TE_READY_CCL              			INTEGER
	,TE_ACTIVAR_360              		INTEGER
	,TE_TOTAL_HABILITADORES       		INTEGER
	,TC_FECHA_HAB 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
	,TE_CMP_MANDATO_CCL					INTEGER
	,TE_CMP_CTO_BEX						INTEGER
	,TE_CMP_MIGRACION               	INTEGER
	,TE_CMP_PROPENSO_MX             	INTEGER
	,TE_CMP_FOGAPE_REACTIVA         	INTEGER
	,TE_PRIORIDAD                   	INTEGER
	,TE_MTO_CMP    						BIGINT
	,TE_DECIL							INTEGER
	,TE_GEST_RCH_U3M					INTEGER
	,TE_REPITENCIA						INTEGER
	,TE_RCHMX							INTEGER 
)PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 04;

	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_02
SELECT
 PPN.TD_RUT 		        		AS TD_RUT 			
,PPN.TC_CLUSTER						AS TC_CLUSTER	
,PPN.TC_RECOMENDACION_DE_CRUCE		AS TC_RECOMENDACION_DE_CRUCE	
,PPN.TE_PO_DEUDA 					AS TE_PO_DEUDA
,PPN.TE_CTACTE 						AS TE_CTACTE
,PPN.TE_LCG_VIGENTE					AS TE_LCG_VIGENTE
,PPN.TE_DISPONIBLE_MN_NEW			AS TE_DISPONIBLE_MN_NEW
,PPN.TD_PROPENSION_MN				AS TD_PROPENSION_MN
,PPN.TC_MACRO_BANCA					AS TC_MACRO_BANCA 
,PPN.TC_EJE							AS TC_EJE	
,PPN.TE_DDA_A_LIBERAR_MES			AS TE_DDA_A_LIBERAR_MES
,PPN.TE_FLG_EXCLUSION				AS TE_FLG_EXCLUSION
,PPN.TC_MOTIVO_EXCLUSION			AS TC_MOTIVO_EXCLUSION
,PPN.TC_TEXTO1						AS TC_TEXTO1
,PPN.TC_TEXTO2						AS TC_TEXTO2
,PPN.TC_TEXTO3						AS TC_TEXTO3
,PPN.TE_EN_PLANEAMIENTO				AS TE_EN_PLANEAMIENTO
,PPN.TC_CALIFICACION_SBIF			AS TC_CALIFICACION_SBIF         
,PPN.TF_PERIODO_CALIFICACION		AS TF_PERIODO_CALIFICACION    	
,PPN.TD_PI_CLIENTE 					AS TD_PI_CLIENTE      		
,PPN.TC_CLASIFICACION_SBIF			AS TC_CLASIFICACION_SBIF    
,PPN.TE_FDR            				AS TE_FDR    
,PPN.TE_COS_CLI            			AS TE_COS_CLI  
,PPN.TE_FILTROS_RIESGOS				AS TE_FILTROS_RIESGOS
,PPN.TC_PAR_CALIFICACION_SBIF		AS TC_PAR_CALIFICACION_SBIF    	
,PPN.TD_PAR_PI_CLIENTE 				AS TD_PAR_PI_CLIENTE           	
,PPN.TE_PAR_FDR                		AS TE_PAR_FDR       
,PPN.TE_PAR_COS_CLI    				AS TE_PAR_COS_CLI  
,PPN.TE_MOLESTO               		AS TE_MOLESTO 
,PPN.TE_CARGABLE              		AS TE_CARGABLE
,PPN.TC_ELIMINADO	         		AS TC_ELIMINADO	
,PPN.TE_DISPONIBLE_OK         		AS TE_DISPONIBLE_OK
,PPN.TE_CON_MANDATO           		AS TE_CON_MANDATO
,PPN.TE_ENROLADO_360          		AS TE_ENROLADO_360
,PPN.TE_HABILITADO_360        		AS TE_HABILITADO_360
,PPN.TE_ACTIVO_360            		AS TE_ACTIVO_360
,PPN.TE_ESTADO_MULTIPASS      		AS TE_ESTADO_MULTIPASS
,PPN.TE_MANDATO_CCL           		AS TE_MANDATO_CCL
,PPN.TE_SIN_APR               		AS TE_SIN_APR
,PPN.TE_ART85                 		AS TE_ART85
,PPN.TE_FYP                   		AS TE_FYP
,PPN.TE_READY_CCL             		AS TE_READY_CCL
,PPN.TE_ACTIVAR_360           		AS TE_ACTIVAR_360
,PPN.TE_TOTAL_HABILITADORES   		AS TE_TOTAL_HABILITADORES
,PPN.TC_FECHA_HAB             		AS TC_FECHA_HAB
,PPN.TE_CMP_MANDATO_CCL       		AS TE_CMP_MANDATO_CCL
,PPN.TE_CMP_CTO_BEX           		AS TE_CMP_CTO_BEX
,PPN.TE_CMP_MIGRACION         		AS TE_CMP_MIGRACION
,PPN.TE_CMP_PROPENSO_MX       		AS TE_CMP_PROPENSO_MX
,PPN.TE_CMP_FOGAPE_REACTIVA   		AS TE_CMP_FOGAPE_REACTIVA

,CASE WHEN  
		PPN.TE_CARGABLE = 1 
		AND PPN.TE_PRIORIDAD = 99
		AND PPN.TE_REPITENCIA = 0
		 THEN 1 
		 ELSE PPN.TE_PRIORIDAD END
				                    AS TE_PRIORIDAD                
,CASE WHEN  
		PPN.TE_CARGABLE = 1 
		AND PPN.TE_PRIORIDAD = 99
		AND PPN.TE_REPITENCIA = 0
		 THEN PPN.TE_DISPONIBLE_MN_NEW
		 ELSE PPN.TE_MTO_CMP END
		 		 					AS TE_MTO_CMP   

,PPN.TE_DECIL						AS TE_DECIL
,PPN.TE_GEST_RCH_U3M				AS TE_GEST_RCH_U3M
,PPN.TE_REPITENCIA					AS TE_REPITENCIA
,PPN.TE_RCHMX						AS TE_RCHMX	
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_01  PPN
;
.IF ERRORCODE <> 0 THEN .QUIT 05;	

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_02;	
.IF ERRORCODE <> 0 THEN .QUIT 06;


--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES          **  
--** CLIENTES PASAN RIESGO 											      **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_03;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_03
(
	 TD_RUT 							DECIMAL(8,0)
	,TC_CLUSTER							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PO_DEUDA						INTEGER
	,TE_CTACTE							INTEGER
	,TE_LCG_VIGENTE						INTEGER
	,TE_DISPONIBLE_MN_NEW				BIGINT
	,TD_PROPENSION_MN					DECIMAL(25,10)
	,TC_MACRO_BANCA     				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE								CHAR(12) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DDA_A_LIBERAR_MES 				BIGINT 
	,TE_FLG_EXCLUSION					INTEGER
	,TC_MOTIVO_EXCLUSION				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TC_TEXTO1							VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2  						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3  						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_EN_PLANEAMIENTO					INTEGER 			
    ,TC_CALIFICACION_SBIF          		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,TD_PI_CLIENTE                		DECIMAL(25,10)			
	,TC_CLASIFICACION_SBIF       		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FDR                      		INTEGER 			
	,TE_COS_CLI                 		INTEGER 			
	,TE_FILTROS_RIESGOS          		INTEGER 			
	,TC_PAR_CALIFICACION_SBIF    		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE           		DECIMAL(25,10)		
	,TE_PAR_FDR                  		INTEGER 			
	,TE_PAR_COS_CLI             		INTEGER 			
	,TE_MOLESTO               			INTEGER 			
	,TE_CARGABLE						INTEGER
	,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DISPONIBLE_OK               	INTEGER
	,TE_CON_MANDATO             		INTEGER
	,TE_ENROLADO_360            		INTEGER
	,TE_HABILITADO_360           		INTEGER
	,TE_ACTIVO_360               		INTEGER
	,TE_ESTADO_MULTIPASS        		INTEGER
	,TE_MANDATO_CCL              		INTEGER
	,TE_SIN_APR                 		INTEGER
	,TE_ART85                     		INTEGER
	,TE_FYP                    			INTEGER
	,TE_READY_CCL              			INTEGER
	,TE_ACTIVAR_360              		INTEGER
	,TE_TOTAL_HABILITADORES       		INTEGER
	,TC_FECHA_HAB 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
	,TE_CMP_MANDATO_CCL					INTEGER
	,TE_CMP_CTO_BEX						INTEGER
	,TE_CMP_MIGRACION               	INTEGER
	,TE_CMP_PROPENSO_MX             	INTEGER
	,TE_CMP_FOGAPE_REACTIVA         	INTEGER
	,TE_PRIORIDAD                   	INTEGER
	,TE_MTO_CMP    						BIGINT
	,TE_DECIL							INTEGER
	,TE_GEST_RCH_U3M					INTEGER
	,TE_REPITENCIA						INTEGER
	,TE_RCHMX							INTEGER 
)PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 07;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES          **  
--** CLIENTES PASAN RIESGO QUE SON DEL DECIL 1 AL 5 Y QUE TIENEN LÍNEA    **
--** VIGENTE Y SIN RHC LOS 3 ULT MESES
--*************************************************************************/
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_03
SELECT
 PPN.TD_RUT 		        		AS TD_RUT 			
,PPN.TC_CLUSTER						AS TC_CLUSTER	
,PPN.TC_RECOMENDACION_DE_CRUCE		AS TC_RECOMENDACION_DE_CRUCE	
,PPN.TE_PO_DEUDA 					AS TE_PO_DEUDA
,PPN.TE_CTACTE 						AS TE_CTACTE
,PPN.TE_LCG_VIGENTE					AS TE_LCG_VIGENTE
,PPN.TE_DISPONIBLE_MN_NEW			AS TE_DISPONIBLE_MN_NEW
,PPN.TD_PROPENSION_MN				AS TD_PROPENSION_MN
,PPN.TC_MACRO_BANCA					AS TC_MACRO_BANCA 
,PPN.TC_EJE							AS TC_EJE	
,PPN.TE_DDA_A_LIBERAR_MES			AS TE_DDA_A_LIBERAR_MES
,PPN.TE_FLG_EXCLUSION				AS TE_FLG_EXCLUSION
,PPN.TC_MOTIVO_EXCLUSION			AS TC_MOTIVO_EXCLUSION
,PPN.TC_TEXTO1						AS TC_TEXTO1
,PPN.TC_TEXTO2						AS TC_TEXTO2
,PPN.TC_TEXTO3						AS TC_TEXTO3
,PPN.TE_EN_PLANEAMIENTO				AS TE_EN_PLANEAMIENTO
,PPN.TC_CALIFICACION_SBIF			AS TC_CALIFICACION_SBIF         
,PPN.TF_PERIODO_CALIFICACION		AS TF_PERIODO_CALIFICACION    	
,PPN.TD_PI_CLIENTE 					AS TD_PI_CLIENTE      		
,PPN.TC_CLASIFICACION_SBIF			AS TC_CLASIFICACION_SBIF    
,PPN.TE_FDR            				AS TE_FDR    
,PPN.TE_COS_CLI            			AS TE_COS_CLI  
,PPN.TE_FILTROS_RIESGOS				AS TE_FILTROS_RIESGOS
,PPN.TC_PAR_CALIFICACION_SBIF		AS TC_PAR_CALIFICACION_SBIF    	
,PPN.TD_PAR_PI_CLIENTE 				AS TD_PAR_PI_CLIENTE           	
,PPN.TE_PAR_FDR                		AS TE_PAR_FDR       
,PPN.TE_PAR_COS_CLI    				AS TE_PAR_COS_CLI  
,PPN.TE_MOLESTO               		AS TE_MOLESTO 

,CASE WHEN 
	PPN.TC_MACRO_BANCA IN ('EMPRESAS','GRANDES EMPRESAS')
	AND PPN.TE_CARGABLE = 0 
	AND PPN.TE_PRIORIDAD = 99	
	AND PPN.TE_FILTROS_RIESGOS > 0
	AND PPN.TE_CTACTE > 0 
	AND PPN.TE_FLG_EXCLUSION = 0
	AND PPN.TE_DECIL BETWEEN 1 AND 5
	AND PPN.TE_LCG_VIGENTE > 0 
	AND PPN.TE_GEST_RCH_U3M = 0
	AND PPN.TE_RCHMX = 0
	AND PPN.TE_REPITENCIA = 0
	 THEN 1 
	 ELSE PPN.TE_CARGABLE END
									AS TE_CARGABLE		

,PPN.TC_ELIMINADO	         		AS TC_ELIMINADO	
,PPN.TE_DISPONIBLE_OK         		AS TE_DISPONIBLE_OK
,PPN.TE_CON_MANDATO           		AS TE_CON_MANDATO
,PPN.TE_ENROLADO_360          		AS TE_ENROLADO_360
,PPN.TE_HABILITADO_360        		AS TE_HABILITADO_360
,PPN.TE_ACTIVO_360            		AS TE_ACTIVO_360
,PPN.TE_ESTADO_MULTIPASS      		AS TE_ESTADO_MULTIPASS
,PPN.TE_MANDATO_CCL           		AS TE_MANDATO_CCL
,PPN.TE_SIN_APR               		AS TE_SIN_APR
,PPN.TE_ART85                 		AS TE_ART85
,PPN.TE_FYP                   		AS TE_FYP
,PPN.TE_READY_CCL             		AS TE_READY_CCL
,PPN.TE_ACTIVAR_360           		AS TE_ACTIVAR_360
,PPN.TE_TOTAL_HABILITADORES   		AS TE_TOTAL_HABILITADORES
,PPN.TC_FECHA_HAB             		AS TC_FECHA_HAB
,PPN.TE_CMP_MANDATO_CCL       		AS TE_CMP_MANDATO_CCL
,PPN.TE_CMP_CTO_BEX           		AS TE_CMP_CTO_BEX
,PPN.TE_CMP_MIGRACION         		AS TE_CMP_MIGRACION
,PPN.TE_CMP_PROPENSO_MX       		AS TE_CMP_PROPENSO_MX
,PPN.TE_CMP_FOGAPE_REACTIVA   		AS TE_CMP_FOGAPE_REACTIVA


,CASE WHEN 
	PPN.TC_MACRO_BANCA IN ('EMPRESAS','GRANDES EMPRESAS')
	AND PPN.TE_CARGABLE = 0 
	AND PPN.TE_PRIORIDAD = 99	
	AND PPN.TE_FILTROS_RIESGOS > 0
	AND PPN.TE_CTACTE > 0 
	AND PPN.TE_FLG_EXCLUSION = 0
	AND PPN.TE_DECIL BETWEEN 1 AND 5
	AND PPN.TE_LCG_VIGENTE > 0 
	AND PPN.TE_GEST_RCH_U3M = 0
	AND PPN.TE_RCHMX = 0
	AND PPN.TE_REPITENCIA = 0
	 THEN 2 
	 ELSE PPN.TE_PRIORIDAD END    	AS TE_PRIORIDAD      

,CASE WHEN 
	PPN.TC_MACRO_BANCA IN ('EMPRESAS','GRANDES EMPRESAS')
	AND PPN.TE_CARGABLE = 0 
	AND PPN.TE_PRIORIDAD = 99	
	AND PPN.TE_FILTROS_RIESGOS > 0
	AND PPN.TE_CTACTE > 0 
	AND PPN.TE_FLG_EXCLUSION = 0
	AND PPN.TE_DECIL BETWEEN 1 AND 5
	AND PPN.TE_LCG_VIGENTE > 0 
	AND PPN.TE_GEST_RCH_U3M = 0
	AND PPN.TE_RCHMX = 0
	AND PPN.TE_REPITENCIA = 0
	 THEN 0
	 ELSE PPN.TE_MTO_CMP END  		AS TE_MTO_CMP    		

,PPN.TE_DECIL						AS TE_DECIL
,PPN.TE_GEST_RCH_U3M				AS TE_GEST_RCH_U3M
,PPN.TE_REPITENCIA					AS TE_REPITENCIA
,PPN.TE_RCHMX						AS TE_RCHMX	
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_02  PPN
;
.IF ERRORCODE <> 0 THEN .QUIT 08;	

COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_03;	
.IF ERRORCODE <> 0 THEN .QUIT 09;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES          **  
--** CLIENTES PASAN RIESGO QUE SON DEL DECIL 1 AL 2, SIN RCH LOS   		  ** 
--** 3 ULTIMOS MESES					  								  **
--*************************************************************************/	
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_04;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_04
(
	 TD_RUT 							DECIMAL(8,0)
	,TC_CLUSTER							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PO_DEUDA						INTEGER
	,TE_CTACTE							INTEGER
	,TE_LCG_VIGENTE						INTEGER
	,TE_DISPONIBLE_MN_NEW				BIGINT
	,TD_PROPENSION_MN					DECIMAL(25,10)
	,TC_MACRO_BANCA     				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE								CHAR(12) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DDA_A_LIBERAR_MES 				BIGINT 
	,TE_FLG_EXCLUSION					INTEGER
	,TC_MOTIVO_EXCLUSION				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TC_TEXTO1							VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2  						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3  						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_EN_PLANEAMIENTO					INTEGER 			
    ,TC_CALIFICACION_SBIF          		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,TD_PI_CLIENTE                		DECIMAL(25,10)			
	,TC_CLASIFICACION_SBIF       		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FDR                      		INTEGER 			
	,TE_COS_CLI                 		INTEGER 			
	,TE_FILTROS_RIESGOS          		INTEGER 			
	,TC_PAR_CALIFICACION_SBIF    		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE           		DECIMAL(25,10)		
	,TE_PAR_FDR                  		INTEGER 			
	,TE_PAR_COS_CLI             		INTEGER 			
	,TE_MOLESTO               			INTEGER 			
	,TE_CARGABLE						INTEGER
	,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DISPONIBLE_OK               	INTEGER
	,TE_CON_MANDATO             		INTEGER
	,TE_ENROLADO_360            		INTEGER
	,TE_HABILITADO_360           		INTEGER
	,TE_ACTIVO_360               		INTEGER
	,TE_ESTADO_MULTIPASS        		INTEGER
	,TE_MANDATO_CCL              		INTEGER
	,TE_SIN_APR                 		INTEGER
	,TE_ART85                     		INTEGER
	,TE_FYP                    			INTEGER
	,TE_READY_CCL              			INTEGER
	,TE_ACTIVAR_360              		INTEGER
	,TE_TOTAL_HABILITADORES       		INTEGER
	,TC_FECHA_HAB 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
	,TE_CMP_MANDATO_CCL					INTEGER
	,TE_CMP_CTO_BEX						INTEGER
	,TE_CMP_MIGRACION               	INTEGER
	,TE_CMP_PROPENSO_MX             	INTEGER
	,TE_CMP_FOGAPE_REACTIVA         	INTEGER
	,TE_PRIORIDAD                   	INTEGER
	,TE_MTO_CMP    						BIGINT
	,TE_DECIL							INTEGER
	,TE_GEST_RCH_U3M					INTEGER
	,TE_REPITENCIA						INTEGER
	,TE_RCHMX							INTEGER 
)PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 10;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES          **  
--** CLIENTES PASAN RIESGO QUE SON DEL DECIL 1 AL 2, SIN RCH LOS   		  ** 
--** 3 ULTIMOS MESES					  								  **
--*************************************************************************/	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_04
SELECT
 PPN.TD_RUT 		        		AS TD_RUT 			
,PPN.TC_CLUSTER						AS TC_CLUSTER	
,PPN.TC_RECOMENDACION_DE_CRUCE		AS TC_RECOMENDACION_DE_CRUCE	
,PPN.TE_PO_DEUDA 					AS TE_PO_DEUDA
,PPN.TE_CTACTE 						AS TE_CTACTE
,PPN.TE_LCG_VIGENTE					AS TE_LCG_VIGENTE
,PPN.TE_DISPONIBLE_MN_NEW			AS TE_DISPONIBLE_MN_NEW
,PPN.TD_PROPENSION_MN				AS TD_PROPENSION_MN
,PPN.TC_MACRO_BANCA					AS TC_MACRO_BANCA 
,PPN.TC_EJE							AS TC_EJE	
,PPN.TE_DDA_A_LIBERAR_MES			AS TE_DDA_A_LIBERAR_MES
,PPN.TE_FLG_EXCLUSION				AS TE_FLG_EXCLUSION
,PPN.TC_MOTIVO_EXCLUSION			AS TC_MOTIVO_EXCLUSION
,PPN.TC_TEXTO1						AS TC_TEXTO1
,PPN.TC_TEXTO2						AS TC_TEXTO2
,PPN.TC_TEXTO3						AS TC_TEXTO3
,PPN.TE_EN_PLANEAMIENTO				AS TE_EN_PLANEAMIENTO
,PPN.TC_CALIFICACION_SBIF			AS TC_CALIFICACION_SBIF         
,PPN.TF_PERIODO_CALIFICACION		AS TF_PERIODO_CALIFICACION    	
,PPN.TD_PI_CLIENTE 					AS TD_PI_CLIENTE      		
,PPN.TC_CLASIFICACION_SBIF			AS TC_CLASIFICACION_SBIF    
,PPN.TE_FDR            				AS TE_FDR    
,PPN.TE_COS_CLI            			AS TE_COS_CLI  
,PPN.TE_FILTROS_RIESGOS				AS TE_FILTROS_RIESGOS
,PPN.TC_PAR_CALIFICACION_SBIF		AS TC_PAR_CALIFICACION_SBIF    	
,PPN.TD_PAR_PI_CLIENTE 				AS TD_PAR_PI_CLIENTE           	
,PPN.TE_PAR_FDR                		AS TE_PAR_FDR       
,PPN.TE_PAR_COS_CLI    				AS TE_PAR_COS_CLI  
,PPN.TE_MOLESTO               		AS TE_MOLESTO 

,CASE WHEN 
	PPN.TC_MACRO_BANCA IN ('EMPRESAS','GRANDES EMPRESAS')
	AND PPN.TE_CARGABLE = 0 
	AND PPN.TE_PRIORIDAD = 99	
	AND PPN.TE_FILTROS_RIESGOS > 0
	AND PPN.TE_CTACTE > 0 
	AND PPN.TE_FLG_EXCLUSION = 0
	AND PPN.TE_DECIL BETWEEN 1 AND 2
	AND PPN.TE_GEST_RCH_U3M = 0
	AND PPN.TE_RCHMX = 0
	AND PPN.TE_REPITENCIA = 0
	 THEN 1
	 ELSE PPN.TE_CARGABLE END		AS TE_CARGABLE			

,PPN.TC_ELIMINADO	         		AS TC_ELIMINADO	
,PPN.TE_DISPONIBLE_OK         		AS TE_DISPONIBLE_OK
,PPN.TE_CON_MANDATO           		AS TE_CON_MANDATO
,PPN.TE_ENROLADO_360          		AS TE_ENROLADO_360
,PPN.TE_HABILITADO_360        		AS TE_HABILITADO_360
,PPN.TE_ACTIVO_360            		AS TE_ACTIVO_360
,PPN.TE_ESTADO_MULTIPASS      		AS TE_ESTADO_MULTIPASS
,PPN.TE_MANDATO_CCL           		AS TE_MANDATO_CCL
,PPN.TE_SIN_APR               		AS TE_SIN_APR
,PPN.TE_ART85                 		AS TE_ART85
,PPN.TE_FYP                   		AS TE_FYP
,PPN.TE_READY_CCL             		AS TE_READY_CCL
,PPN.TE_ACTIVAR_360           		AS TE_ACTIVAR_360
,PPN.TE_TOTAL_HABILITADORES   		AS TE_TOTAL_HABILITADORES
,PPN.TC_FECHA_HAB             		AS TC_FECHA_HAB
,PPN.TE_CMP_MANDATO_CCL       		AS TE_CMP_MANDATO_CCL
,PPN.TE_CMP_CTO_BEX           		AS TE_CMP_CTO_BEX
,PPN.TE_CMP_MIGRACION         		AS TE_CMP_MIGRACION
,PPN.TE_CMP_PROPENSO_MX       		AS TE_CMP_PROPENSO_MX
,PPN.TE_CMP_FOGAPE_REACTIVA   		AS TE_CMP_FOGAPE_REACTIVA

,CASE WHEN 
	PPN.TC_MACRO_BANCA IN ('EMPRESAS','GRANDES EMPRESAS')
	AND PPN.TE_CARGABLE = 0 
	AND PPN.TE_PRIORIDAD = 99	
	AND PPN.TE_FILTROS_RIESGOS > 0
	AND PPN.TE_CTACTE > 0 
	AND PPN.TE_FLG_EXCLUSION = 0
	AND PPN.TE_DECIL BETWEEN 1 AND 2
	AND PPN.TE_GEST_RCH_U3M = 0
	AND PPN.TE_RCHMX = 0
	AND PPN.TE_REPITENCIA = 0
	 THEN 3
	 ELSE PPN.TE_PRIORIDAD END      AS TE_PRIORIDAD      

,PPN.TE_MTO_CMP						AS TE_MTO_CMP
,PPN.TE_DECIL						AS TE_DECIL
,PPN.TE_GEST_RCH_U3M				AS TE_GEST_RCH_U3M
,PPN.TE_REPITENCIA					AS TE_REPITENCIA
,PPN.TE_RCHMX						AS TE_RCHMX		
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_03  PPN
;
.IF ERRORCODE <> 0 THEN .QUIT 11;

COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_04;	
.IF ERRORCODE <> 0 THEN .QUIT 12;


--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** DE CLIENTES A CAMPAÑA DIGITAL                       **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_05;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_05
(
	 TD_RUT 							DECIMAL(8,0)
	,TC_CLUSTER							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PO_DEUDA						INTEGER
	,TE_CTACTE							INTEGER
	,TE_LCG_VIGENTE						INTEGER
	,TE_DISPONIBLE_MN_NEW				BIGINT
	,TD_PROPENSION_MN					DECIMAL(25,10)
	,TC_MACRO_BANCA     				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE								CHAR(12) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DDA_A_LIBERAR_MES 				BIGINT 
	,TE_FLG_EXCLUSION					INTEGER
	,TC_MOTIVO_EXCLUSION				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TC_TEXTO1							VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2  						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3  						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_EN_PLANEAMIENTO					INTEGER 			
    ,TC_CALIFICACION_SBIF          		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,TD_PI_CLIENTE                		DECIMAL(25,10)			
	,TC_CLASIFICACION_SBIF       		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FDR                      		INTEGER 			
	,TE_COS_CLI                 		INTEGER 			
	,TE_FILTROS_RIESGOS          		INTEGER 			
	,TC_PAR_CALIFICACION_SBIF    		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE           		DECIMAL(25,10)		
	,TE_PAR_FDR                  		INTEGER 			
	,TE_PAR_COS_CLI             		INTEGER 			
	,TE_MOLESTO               			INTEGER 			
	,TE_CARGABLE						INTEGER
	,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DISPONIBLE_OK               	INTEGER
	,TE_CON_MANDATO             		INTEGER
	,TE_ENROLADO_360            		INTEGER
	,TE_HABILITADO_360           		INTEGER
	,TE_ACTIVO_360               		INTEGER
	,TE_ESTADO_MULTIPASS        		INTEGER
	,TE_MANDATO_CCL              		INTEGER
	,TE_SIN_APR                 		INTEGER
	,TE_ART85                     		INTEGER
	,TE_FYP                    			INTEGER
	,TE_READY_CCL              			INTEGER
	,TE_ACTIVAR_360              		INTEGER
	,TE_TOTAL_HABILITADORES       		INTEGER
	,TC_FECHA_HAB 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
	,TE_CMP_MANDATO_CCL					INTEGER
	,TE_CMP_CTO_BEX						INTEGER
	,TE_CMP_MIGRACION               	INTEGER
	,TE_CMP_PROPENSO_MX             	INTEGER
	,TE_CMP_FOGAPE_REACTIVA         	INTEGER
	,TE_PRIORIDAD                   	INTEGER
	,TE_MTO_CMP    						BIGINT
	,TE_DECIL							INTEGER
	,TE_GEST_RCH_U3M					INTEGER
	,TE_REPITENCIA						INTEGER
	,TE_RCHMX							INTEGER 
)PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 13;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPOS CARGABLE DONDE CARGABLE = 1 Y EJE = '0'                       **
--*************************************************************************/
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_05
SELECT
 PPN.TD_RUT 		        		AS TD_RUT 			
,PPN.TC_CLUSTER						AS TC_CLUSTER	
,PPN.TC_RECOMENDACION_DE_CRUCE		AS TC_RECOMENDACION_DE_CRUCE	
,PPN.TE_PO_DEUDA 					AS TE_PO_DEUDA
,PPN.TE_CTACTE 						AS TE_CTACTE
,PPN.TE_LCG_VIGENTE					AS TE_LCG_VIGENTE
,PPN.TE_DISPONIBLE_MN_NEW			AS TE_DISPONIBLE_MN_NEW
,PPN.TD_PROPENSION_MN				AS TD_PROPENSION_MN
,PPN.TC_MACRO_BANCA					AS TC_MACRO_BANCA 
,PPN.TC_EJE							AS TC_EJE	
,PPN.TE_DDA_A_LIBERAR_MES			AS TE_DDA_A_LIBERAR_MES
,PPN.TE_FLG_EXCLUSION				AS TE_FLG_EXCLUSION
,PPN.TC_MOTIVO_EXCLUSION			AS TC_MOTIVO_EXCLUSION
,PPN.TC_TEXTO1						AS TC_TEXTO1
,PPN.TC_TEXTO2						AS TC_TEXTO2
,PPN.TC_TEXTO3						AS TC_TEXTO3
,PPN.TE_EN_PLANEAMIENTO				AS TE_EN_PLANEAMIENTO
,PPN.TC_CALIFICACION_SBIF			AS TC_CALIFICACION_SBIF         
,PPN.TF_PERIODO_CALIFICACION		AS TF_PERIODO_CALIFICACION    	
,PPN.TD_PI_CLIENTE 					AS TD_PI_CLIENTE      		
,PPN.TC_CLASIFICACION_SBIF			AS TC_CLASIFICACION_SBIF    
,PPN.TE_FDR            				AS TE_FDR    
,PPN.TE_COS_CLI            			AS TE_COS_CLI  
,PPN.TE_FILTROS_RIESGOS				AS TE_FILTROS_RIESGOS
,PPN.TC_PAR_CALIFICACION_SBIF		AS TC_PAR_CALIFICACION_SBIF    	
,PPN.TD_PAR_PI_CLIENTE 				AS TD_PAR_PI_CLIENTE           	
,PPN.TE_PAR_FDR                		AS TE_PAR_FDR       
,PPN.TE_PAR_COS_CLI    				AS TE_PAR_COS_CLI  
,PPN.TE_MOLESTO               		AS TE_MOLESTO 

,CASE WHEN 
		PPN.TC_MACRO_BANCA IN ('EMPRESAS','GRANDES EMPRESAS')
		AND PPN.TE_FILTROS_RIESGOS > 0
		AND PPN.TE_CTACTE > 0 
		AND PPN.TE_FLG_EXCLUSION = 0
		AND PPN.TE_GEST_RCH_U3M = 0
		AND PPN.TE_RCHMX = 0
		AND PPN.TE_LCG_VIGENTE > 0  
		AND PPN.TE_REPITENCIA = 1
		AND PPN.TE_DECIL >= 3
	 	  THEN 1 
	 	  ELSE PPN.TE_CARGABLE END 	AS TE_CARGABLE		

,PPN.TC_ELIMINADO	         		AS TC_ELIMINADO	
,PPN.TE_DISPONIBLE_OK         		AS TE_DISPONIBLE_OK
,PPN.TE_CON_MANDATO           		AS TE_CON_MANDATO
,PPN.TE_ENROLADO_360          		AS TE_ENROLADO_360
,PPN.TE_HABILITADO_360        		AS TE_HABILITADO_360
,PPN.TE_ACTIVO_360            		AS TE_ACTIVO_360
,PPN.TE_ESTADO_MULTIPASS      		AS TE_ESTADO_MULTIPASS
,PPN.TE_MANDATO_CCL           		AS TE_MANDATO_CCL
,PPN.TE_SIN_APR               		AS TE_SIN_APR
,PPN.TE_ART85                 		AS TE_ART85
,PPN.TE_FYP                   		AS TE_FYP
,PPN.TE_READY_CCL             		AS TE_READY_CCL
,PPN.TE_ACTIVAR_360           		AS TE_ACTIVAR_360
,PPN.TE_TOTAL_HABILITADORES   		AS TE_TOTAL_HABILITADORES
,PPN.TC_FECHA_HAB             		AS TC_FECHA_HAB
,PPN.TE_CMP_MANDATO_CCL       		AS TE_CMP_MANDATO_CCL
,PPN.TE_CMP_CTO_BEX           		AS TE_CMP_CTO_BEX
,PPN.TE_CMP_MIGRACION         		AS TE_CMP_MIGRACION
,PPN.TE_CMP_PROPENSO_MX       		AS TE_CMP_PROPENSO_MX
,PPN.TE_CMP_FOGAPE_REACTIVA   		AS TE_CMP_FOGAPE_REACTIVA

,CASE WHEN 
	PPN.TC_MACRO_BANCA IN ('EMPRESAS','GRANDES EMPRESAS')
	AND PPN.TE_FILTROS_RIESGOS > 0
	AND PPN.TE_CTACTE > 0 
	AND PPN.TE_FLG_EXCLUSION = 0
	AND PPN.TE_GEST_RCH_U3M = 0
	AND PPN.TE_RCHMX = 0
	AND PPN.TE_LCG_VIGENTE > 0  
	AND PPN.TE_REPITENCIA = 1
	AND PPN.TE_DECIL >= 3
	 THEN 6
	 ELSE PPN.TE_PRIORIDAD END      AS TE_PRIORIDAD        

,PPN.TE_MTO_CMP						AS TE_MTO_CMP
,PPN.TE_DECIL						AS TE_DECIL
,PPN.TE_GEST_RCH_U3M				AS TE_GEST_RCH_U3M
,PPN.TE_REPITENCIA					AS TE_REPITENCIA
,PPN.TE_RCHMX						AS TE_RCHMX	
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_04  PPN
;
.IF ERRORCODE <> 0 THEN .QUIT 14;

COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_05;	
.IF ERRORCODE <> 0 THEN .QUIT 15;

--/*************************************************************************
--** SE ACTUALIZA PARA NO CONSIDERAR "CLIENTE EMPRESA YARUR"			  **  
--** CAMPOS TE_CARGABLE Y TC_ELIMINADO	                                  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_06;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_06
(
	 TD_RUT 							DECIMAL(8,0)
	,TC_CLUSTER							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PO_DEUDA						INTEGER
	,TE_CTACTE							INTEGER
	,TE_LCG_VIGENTE						INTEGER
	,TE_DISPONIBLE_MN_NEW				BIGINT
	,TD_PROPENSION_MN					DECIMAL(25,10)
	,TC_MACRO_BANCA     				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE								CHAR(12) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DDA_A_LIBERAR_MES 				BIGINT 
	,TE_FLG_EXCLUSION					INTEGER
	,TC_MOTIVO_EXCLUSION				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TC_TEXTO1							VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2  						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3  						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_EN_PLANEAMIENTO					INTEGER 			
    ,TC_CALIFICACION_SBIF          		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,TD_PI_CLIENTE                		DECIMAL(25,10)			
	,TC_CLASIFICACION_SBIF       		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FDR                      		INTEGER 			
	,TE_COS_CLI                 		INTEGER 			
	,TE_FILTROS_RIESGOS          		INTEGER 			
	,TC_PAR_CALIFICACION_SBIF    		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE           		DECIMAL(25,10)		
	,TE_PAR_FDR                  		INTEGER 			
	,TE_PAR_COS_CLI             		INTEGER 			
	,TE_MOLESTO               			INTEGER 			
	,TE_CARGABLE						INTEGER
	,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DISPONIBLE_OK               	INTEGER
	,TE_CON_MANDATO             		INTEGER
	,TE_ENROLADO_360            		INTEGER
	,TE_HABILITADO_360           		INTEGER
	,TE_ACTIVO_360               		INTEGER
	,TE_ESTADO_MULTIPASS        		INTEGER
	,TE_MANDATO_CCL              		INTEGER
	,TE_SIN_APR                 		INTEGER
	,TE_ART85                     		INTEGER
	,TE_FYP                    			INTEGER
	,TE_READY_CCL              			INTEGER
	,TE_ACTIVAR_360              		INTEGER
	,TE_TOTAL_HABILITADORES       		INTEGER
	,TC_FECHA_HAB 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
	,TE_CMP_MANDATO_CCL					INTEGER
	,TE_CMP_CTO_BEX						INTEGER
	,TE_CMP_MIGRACION               	INTEGER
	,TE_CMP_PROPENSO_MX             	INTEGER
	,TE_CMP_FOGAPE_REACTIVA         	INTEGER
	,TE_PRIORIDAD                   	INTEGER
	,TE_MTO_CMP    						BIGINT
	,TE_DECIL							INTEGER
	,TE_GEST_RCH_U3M					INTEGER
	,TE_REPITENCIA						INTEGER
	,TE_RCHMX							INTEGER 
)PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 16;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_06
SELECT
 PPN.TD_RUT 		        		AS TD_RUT 			
,PPN.TC_CLUSTER						AS TC_CLUSTER	
,PPN.TC_RECOMENDACION_DE_CRUCE		AS TC_RECOMENDACION_DE_CRUCE	
,PPN.TE_PO_DEUDA 					AS TE_PO_DEUDA
,PPN.TE_CTACTE 						AS TE_CTACTE
,PPN.TE_LCG_VIGENTE					AS TE_LCG_VIGENTE
,PPN.TE_DISPONIBLE_MN_NEW			AS TE_DISPONIBLE_MN_NEW
,PPN.TD_PROPENSION_MN				AS TD_PROPENSION_MN
,PPN.TC_MACRO_BANCA					AS TC_MACRO_BANCA 
,PPN.TC_EJE							AS TC_EJE	
,PPN.TE_DDA_A_LIBERAR_MES			AS TE_DDA_A_LIBERAR_MES
,PPN.TE_FLG_EXCLUSION				AS TE_FLG_EXCLUSION
,PPN.TC_MOTIVO_EXCLUSION			AS TC_MOTIVO_EXCLUSION
,PPN.TC_TEXTO1						AS TC_TEXTO1
,PPN.TC_TEXTO2						AS TC_TEXTO2
,PPN.TC_TEXTO3						AS TC_TEXTO3
,PPN.TE_EN_PLANEAMIENTO				AS TE_EN_PLANEAMIENTO
,PPN.TC_CALIFICACION_SBIF			AS TC_CALIFICACION_SBIF         
,PPN.TF_PERIODO_CALIFICACION		AS TF_PERIODO_CALIFICACION    	
,PPN.TD_PI_CLIENTE 					AS TD_PI_CLIENTE      		
,PPN.TC_CLASIFICACION_SBIF			AS TC_CLASIFICACION_SBIF    
,PPN.TE_FDR            				AS TE_FDR    
,PPN.TE_COS_CLI            			AS TE_COS_CLI  
,PPN.TE_FILTROS_RIESGOS				AS TE_FILTROS_RIESGOS
,PPN.TC_PAR_CALIFICACION_SBIF		AS TC_PAR_CALIFICACION_SBIF    	
,PPN.TD_PAR_PI_CLIENTE 				AS TD_PAR_PI_CLIENTE           	
,PPN.TE_PAR_FDR                		AS TE_PAR_FDR       
,PPN.TE_PAR_COS_CLI    				AS TE_PAR_COS_CLI  
,PPN.TE_MOLESTO               		AS TE_MOLESTO 

,CASE WHEN 
		PPN.TE_CARGABLE = 1 
		AND COALESCE(PPN.TC_EJE,'0') = '0'
	 	  THEN 0 
	 	  ELSE PPN.TE_CARGABLE END 	AS TE_CARGABLE	

,PPN.TC_ELIMINADO	         		AS TC_ELIMINADO	
,PPN.TE_DISPONIBLE_OK         		AS TE_DISPONIBLE_OK
,PPN.TE_CON_MANDATO           		AS TE_CON_MANDATO
,PPN.TE_ENROLADO_360          		AS TE_ENROLADO_360
,PPN.TE_HABILITADO_360        		AS TE_HABILITADO_360
,PPN.TE_ACTIVO_360            		AS TE_ACTIVO_360
,PPN.TE_ESTADO_MULTIPASS      		AS TE_ESTADO_MULTIPASS
,PPN.TE_MANDATO_CCL           		AS TE_MANDATO_CCL
,PPN.TE_SIN_APR               		AS TE_SIN_APR
,PPN.TE_ART85                 		AS TE_ART85
,PPN.TE_FYP                   		AS TE_FYP
,PPN.TE_READY_CCL             		AS TE_READY_CCL
,PPN.TE_ACTIVAR_360           		AS TE_ACTIVAR_360
,PPN.TE_TOTAL_HABILITADORES   		AS TE_TOTAL_HABILITADORES
,PPN.TC_FECHA_HAB             		AS TC_FECHA_HAB
,PPN.TE_CMP_MANDATO_CCL       		AS TE_CMP_MANDATO_CCL
,PPN.TE_CMP_CTO_BEX           		AS TE_CMP_CTO_BEX
,PPN.TE_CMP_MIGRACION         		AS TE_CMP_MIGRACION
,PPN.TE_CMP_PROPENSO_MX       		AS TE_CMP_PROPENSO_MX
,PPN.TE_CMP_FOGAPE_REACTIVA   		AS TE_CMP_FOGAPE_REACTIVA
,PPN.TE_PRIORIDAD 					AS TE_PRIORIDAD
,PPN.TE_MTO_CMP						AS TE_MTO_CMP
,PPN.TE_DECIL						AS TE_DECIL
,PPN.TE_GEST_RCH_U3M				AS TE_GEST_RCH_U3M
,PPN.TE_REPITENCIA					AS TE_REPITENCIA
,PPN.TE_RCHMX						AS TE_RCHMX	
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_05  PPN
	LEFT JOIN MKT_JOURNEYBUILDER_TB.I_CMP_MAE_CLIENTE_EJECUTIVO CLI
		ON PPN.TD_RUT = CLI.IE_CLI_RUT AND 
		   CLI.IC_NOM_CLI IN ('EMPRESAS JUAN YARUR SPA', 'EMPRESAS JY S A')		
;
.IF ERRORCODE <> 0 THEN .QUIT 17;

COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_06;	
.IF ERRORCODE <> 0 THEN .QUIT 18;

--/*************************************************************************
--** SE ACTUALIZA PARA NO CONSIDERAR "CLIENTE EMPRESA YARUR"			  **  
--** CAMPOS TE_CARGABLE Y TC_ELIMINADO	                                  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_07;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_07
(
	 TD_RUT 							DECIMAL(8,0)
	,TC_CLUSTER							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PO_DEUDA						INTEGER
	,TE_CTACTE							INTEGER
	,TE_LCG_VIGENTE						INTEGER
	,TE_DISPONIBLE_MN_NEW				BIGINT
	,TD_PROPENSION_MN					DECIMAL(25,10)
	,TC_MACRO_BANCA     				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE								CHAR(12) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DDA_A_LIBERAR_MES 				BIGINT 
	,TE_FLG_EXCLUSION					INTEGER
	,TC_MOTIVO_EXCLUSION				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TC_TEXTO1							VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2  						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3  						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_EN_PLANEAMIENTO					INTEGER 			
    ,TC_CALIFICACION_SBIF          		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,TD_PI_CLIENTE                		DECIMAL(25,10)			
	,TC_CLASIFICACION_SBIF       		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FDR                      		INTEGER 			
	,TE_COS_CLI                 		INTEGER 			
	,TE_FILTROS_RIESGOS          		INTEGER 			
	,TC_PAR_CALIFICACION_SBIF    		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE           		DECIMAL(25,10)		
	,TE_PAR_FDR                  		INTEGER 			
	,TE_PAR_COS_CLI             		INTEGER 			
	,TE_MOLESTO               			INTEGER 			
	,TE_CARGABLE						INTEGER
	,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DISPONIBLE_OK               	INTEGER
	,TE_CON_MANDATO             		INTEGER
	,TE_ENROLADO_360            		INTEGER
	,TE_HABILITADO_360           		INTEGER
	,TE_ACTIVO_360               		INTEGER
	,TE_ESTADO_MULTIPASS        		INTEGER
	,TE_MANDATO_CCL              		INTEGER
	,TE_SIN_APR                 		INTEGER
	,TE_ART85                     		INTEGER
	,TE_FYP                    			INTEGER
	,TE_READY_CCL              			INTEGER
	,TE_ACTIVAR_360              		INTEGER
	,TE_TOTAL_HABILITADORES       		INTEGER
	,TC_FECHA_HAB 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
	,TE_CMP_MANDATO_CCL					INTEGER
	,TE_CMP_CTO_BEX						INTEGER
	,TE_CMP_MIGRACION               	INTEGER
	,TE_CMP_PROPENSO_MX             	INTEGER
	,TE_CMP_FOGAPE_REACTIVA         	INTEGER
	,TE_PRIORIDAD                   	INTEGER
	,TE_MTO_CMP    						BIGINT
	,TE_DECIL							INTEGER
	,TE_GEST_RCH_U3M					INTEGER
	,TE_REPITENCIA						INTEGER
	,TE_RCHMX							INTEGER 
)PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 19;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_07
SELECT
 PPN.TD_RUT 		        		AS TD_RUT 			
,PPN.TC_CLUSTER						AS TC_CLUSTER	
,PPN.TC_RECOMENDACION_DE_CRUCE		AS TC_RECOMENDACION_DE_CRUCE	
,PPN.TE_PO_DEUDA 					AS TE_PO_DEUDA
,PPN.TE_CTACTE 						AS TE_CTACTE
,PPN.TE_LCG_VIGENTE					AS TE_LCG_VIGENTE
,PPN.TE_DISPONIBLE_MN_NEW			AS TE_DISPONIBLE_MN_NEW
,PPN.TD_PROPENSION_MN				AS TD_PROPENSION_MN
,PPN.TC_MACRO_BANCA					AS TC_MACRO_BANCA 
,PPN.TC_EJE							AS TC_EJE	
,PPN.TE_DDA_A_LIBERAR_MES			AS TE_DDA_A_LIBERAR_MES
,PPN.TE_FLG_EXCLUSION				AS TE_FLG_EXCLUSION
,PPN.TC_MOTIVO_EXCLUSION			AS TC_MOTIVO_EXCLUSION
,PPN.TC_TEXTO1						AS TC_TEXTO1
,PPN.TC_TEXTO2						AS TC_TEXTO2
,PPN.TC_TEXTO3						AS TC_TEXTO3
,PPN.TE_EN_PLANEAMIENTO				AS TE_EN_PLANEAMIENTO
,PPN.TC_CALIFICACION_SBIF			AS TC_CALIFICACION_SBIF         
,PPN.TF_PERIODO_CALIFICACION		AS TF_PERIODO_CALIFICACION    	
,PPN.TD_PI_CLIENTE 					AS TD_PI_CLIENTE      		
,PPN.TC_CLASIFICACION_SBIF			AS TC_CLASIFICACION_SBIF    
,PPN.TE_FDR            				AS TE_FDR    
,PPN.TE_COS_CLI            			AS TE_COS_CLI  
,PPN.TE_FILTROS_RIESGOS				AS TE_FILTROS_RIESGOS
,PPN.TC_PAR_CALIFICACION_SBIF		AS TC_PAR_CALIFICACION_SBIF    	
,PPN.TD_PAR_PI_CLIENTE 				AS TD_PAR_PI_CLIENTE           	
,PPN.TE_PAR_FDR                		AS TE_PAR_FDR       
,PPN.TE_PAR_COS_CLI    				AS TE_PAR_COS_CLI  
,PPN.TE_MOLESTO               		AS TE_MOLESTO 
,PPN.TE_CARGABLE              		AS TE_CARGABLE

,CASE WHEN 
	 PPN.TE_CARGABLE = 0 THEN
	 CASE
		WHEN COALESCE(PPN.TC_MACRO_BANCA,'')  NOT IN ('EMPRESAS', 'GRANDES EMPRESAS')   
				THEN '01.- BANCA NO EM/EG'
		WHEN COALESCE(PPN.TE_CTACTE,0) = 0											   
				THEN '02.- SIN CTACTE'
		WHEN COALESCE(PPN.TE_PO_DEUDA,0) = 0											   
				THEN '03.- NO ES PO DEUDA'
		WHEN COALESCE(PPN.TE_LCG_VIGENTE,0) = 0										   
				THEN '04.- SIN LINEA VIGENTE'
		WHEN COALESCE(PPN.TE_DISPONIBLE_OK,0) = 0									   
				THEN '05.- SIN DISP MINIMO MM$70 EG y MM$=30 EM'
		WHEN COALESCE(PPN.TE_FILTROS_RIESGOS,0) = 0
				THEN '06.- FILTROS RIESGOS'
		WHEN PPN.TC_CLUSTER NOT IN ('INACTIVO','READY','TOPADO')							
				THEN '09.- CLUSTER DISTINTO A INACTIVO,READY,TOPADO'
		WHEN PPN.TD_PROPENSION_MN < 0.059
				THEN '10.- PROPENSION < 6%'
		WHEN COALESCE(PPN.TC_EJE,'0') = '0'											
				THEN '11.- SIN EJECUTIVO'
		WHEN COALESCE(PPN.TE_CMP_FOGAPE_REACTIVA,0) > 0
				THEN '12.- EN CMP FOGAPE REACTIVA'
		WHEN COALESCE(PPN.TE_MOLESTO,0) = 1
				THEN '13.- NO MOLESTAR'
		WHEN COALESCE(PPN.TE_FLG_EXCLUSION,0) = 1					
				THEN '14.- EXCLUIR : ' || RTRIM(PPN.TC_MOTIVO_EXCLUSION)
		WHEN COALESCE(PPN.TE_GEST_RCH_U3M,0) = 1
				THEN '15.- RECHAZO EN LOS 3 ULT MESES'	
		WHEN COALESCE(PPN.TE_RCHMX,0) = 1
				THEN '16.- RECHAZO OPERA MX'			
		ELSE ''
	 END
  ELSE PPN.TC_ELIMINADO
 END	 							AS TC_ELIMINADO		

,PPN.TE_DISPONIBLE_OK         		AS TE_DISPONIBLE_OK
,PPN.TE_CON_MANDATO           		AS TE_CON_MANDATO
,PPN.TE_ENROLADO_360          		AS TE_ENROLADO_360
,PPN.TE_HABILITADO_360        		AS TE_HABILITADO_360
,PPN.TE_ACTIVO_360            		AS TE_ACTIVO_360
,PPN.TE_ESTADO_MULTIPASS      		AS TE_ESTADO_MULTIPASS
,PPN.TE_MANDATO_CCL           		AS TE_MANDATO_CCL
,PPN.TE_SIN_APR               		AS TE_SIN_APR
,PPN.TE_ART85                 		AS TE_ART85
,PPN.TE_FYP                   		AS TE_FYP
,PPN.TE_READY_CCL             		AS TE_READY_CCL
,PPN.TE_ACTIVAR_360           		AS TE_ACTIVAR_360
,PPN.TE_TOTAL_HABILITADORES   		AS TE_TOTAL_HABILITADORES
,PPN.TC_FECHA_HAB             		AS TC_FECHA_HAB
,PPN.TE_CMP_MANDATO_CCL       		AS TE_CMP_MANDATO_CCL
,PPN.TE_CMP_CTO_BEX           		AS TE_CMP_CTO_BEX
,PPN.TE_CMP_MIGRACION         		AS TE_CMP_MIGRACION
,PPN.TE_CMP_PROPENSO_MX       		AS TE_CMP_PROPENSO_MX
,PPN.TE_CMP_FOGAPE_REACTIVA   		AS TE_CMP_FOGAPE_REACTIVA
,PPN.TE_PRIORIDAD 					AS TE_PRIORIDAD
,PPN.TE_MTO_CMP						AS TE_MTO_CMP
,PPN.TE_DECIL						AS TE_DECIL
,PPN.TE_GEST_RCH_U3M				AS TE_GEST_RCH_U3M
,PPN.TE_REPITENCIA					AS TE_REPITENCIA
,PPN.TE_RCHMX						AS TE_RCHMX	
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_06  PPN
;
.IF ERRORCODE <> 0 THEN .QUIT 20;

COLLECT STATS INDEX ( TD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_07;	
.IF ERRORCODE <> 0 THEN .QUIT 21;

/***********************************************************************************************
    CREA TABLA PRE CALCULO
************************************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_RN;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_RN
(
	 PD_RUT 							DECIMAL(8,0)
	,PC_CLUSTER							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PO_DEUDA						INTEGER
	,PE_CTACTE							INTEGER
	,PE_LCG_VIGENTE						INTEGER
	,PE_DISPONIBLE_MN_NEW				BIGINT
	,PD_PROPENSION_MN					DECIMAL(25,10)
	,PC_MACRO_BANCA     				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_EJE								CHAR(12) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_DDA_A_LIBERAR_MES 				BIGINT 
	,PE_FLG_EXCLUSION					INTEGER
	,PC_MOTIVO_EXCLUSION				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC	
	,PC_TEXTO1							VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO2  						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO3  						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_EN_PLANEAMIENTO					INTEGER 			
    ,PC_CALIFICACION_SBIF          		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,PF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,PD_PI_CLIENTE                		DECIMAL(25,10)			
	,PC_CLASIFICACION_SBIF       		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,PE_FDR                      		INTEGER 			
	,PE_COS_CLI                 		INTEGER 			
	,PE_FILTROS_RIESGOS          		INTEGER 			
	,PC_PAR_CALIFICACION_SBIF    		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
	,PD_PAR_PI_CLIENTE           		DECIMAL(25,10)		
	,PE_PAR_FDR                  		INTEGER 			
	,PE_PAR_COS_CLI             		INTEGER 			
	,PE_MOLESTO               			INTEGER 			
	,PE_CARGABLE						INTEGER
	,PC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_DISPONIBLE_OK               	INTEGER
	,PE_CON_MANDATO             		INTEGER
	,PE_ENROLADO_360            		INTEGER
	,PE_HABILITADO_360           		INTEGER
	,PE_ACTIVO_360               		INTEGER
	,PE_ESTADO_MULTIPASS        		INTEGER
	,PE_MANDATO_CCL              		INTEGER
	,PE_SIN_APR                 		INTEGER
	,PE_ART85                     		INTEGER
	,PE_FYP                    			INTEGER
	,PE_READY_CCL              			INTEGER
	,PE_ACTIVAR_360              		INTEGER
	,PE_TOTAL_HABILITADORES       		INTEGER
	,PC_FECHA_HAB 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
	,PE_CMP_MANDATO_CCL					INTEGER
	,PE_CMP_CTO_BEX						INTEGER
	,PE_CMP_MIGRACION               	INTEGER
	,PE_CMP_PROPENSO_MX             	INTEGER
	,PE_CMP_FOGAPE_REACTIVA         	INTEGER
	,PE_PRIORIDAD                   	INTEGER
	,PE_MTO_CMP    						BIGINT
	,PE_DECIL							INTEGER
	,PE_GEST_RCH_U3M					INTEGER
	,PE_REPITENCIA						INTEGER
	,PE_RCHMX							INTEGER 
)PRIMARY INDEX ( PD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 22;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPOS ELIMINADO 							                          **
--*************************************************************************/
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_RN
SELECT
 PPN.TD_RUT 		        		AS PD_RUT 			
,PPN.TC_CLUSTER						AS PC_CLUSTER	
,PPN.TC_RECOMENDACION_DE_CRUCE		AS PC_RECOMENDACION_DE_CRUCE	
,PPN.TE_PO_DEUDA 					AS PE_PO_DEUDA
,PPN.TE_CTACTE 						AS PE_CTACTE
,PPN.TE_LCG_VIGENTE					AS PE_LCG_VIGENTE
,PPN.TE_DISPONIBLE_MN_NEW			AS PE_DISPONIBLE_MN_NEW
,PPN.TD_PROPENSION_MN				AS PD_PROPENSION_MN
,PPN.TC_MACRO_BANCA					AS PC_MACRO_BANCA 
,PPN.TC_EJE							AS PC_EJE	
,PPN.TE_DDA_A_LIBERAR_MES			AS PE_DDA_A_LIBERAR_MES
,PPN.TE_FLG_EXCLUSION				AS PE_FLG_EXCLUSION
,PPN.TC_MOTIVO_EXCLUSION			AS PC_MOTIVO_EXCLUSION
,PPN.TC_TEXTO1						AS PC_TEXTO1
,PPN.TC_TEXTO2						AS PC_TEXTO2
,PPN.TC_TEXTO3						AS PC_TEXTO3
,PPN.TE_EN_PLANEAMIENTO				AS PE_EN_PLANEAMIENTO
,PPN.TC_CALIFICACION_SBIF			AS PC_CALIFICACION_SBIF         
,PPN.TF_PERIODO_CALIFICACION		AS PF_PERIODO_CALIFICACION    	
,PPN.TD_PI_CLIENTE 					AS PD_PI_CLIENTE      		
,PPN.TC_CLASIFICACION_SBIF			AS PC_CLASIFICACION_SBIF    
,PPN.TE_FDR            				AS PE_FDR    
,PPN.TE_COS_CLI            			AS PE_COS_CLI  
,PPN.TE_FILTROS_RIESGOS				AS PE_FILTROS_RIESGOS
,PPN.TC_PAR_CALIFICACION_SBIF		AS PC_PAR_CALIFICACION_SBIF    	
,PPN.TD_PAR_PI_CLIENTE 				AS PD_PAR_PI_CLIENTE           	
,PPN.TE_PAR_FDR                		AS PE_PAR_FDR       
,PPN.TE_PAR_COS_CLI    				AS PE_PAR_COS_CLI  
,PPN.TE_MOLESTO               		AS PE_MOLESTO 

,CASE  WHEN
	CLI.IE_CLI_RUT IS NOT NULL THEN 0
	ELSE PPN.TE_CARGABLE END 		AS TE_CARGABLE
		
,CASE  WHEN
	CLI.IE_CLI_RUT IS NOT NULL 
	   THEN 'CLIENTE EMPRESA YARUR'
	   ELSE PPN.TC_ELIMINADO END 	AS TC_ELIMINADO

,PPN.TE_DISPONIBLE_OK         		AS PE_DISPONIBLE_OK
,PPN.TE_CON_MANDATO           		AS PE_CON_MANDATO
,PPN.TE_ENROLADO_360          		AS PE_ENROLADO_360
,PPN.TE_HABILITADO_360        		AS PE_HABILITADO_360
,PPN.TE_ACTIVO_360            		AS PE_ACTIVO_360
,PPN.TE_ESTADO_MULTIPASS      		AS PE_ESTADO_MULTIPASS
,PPN.TE_MANDATO_CCL           		AS PE_MANDATO_CCL
,PPN.TE_SIN_APR               		AS PE_SIN_APR
,PPN.TE_ART85                 		AS PE_ART85
,PPN.TE_FYP                   		AS PE_FYP
,PPN.TE_READY_CCL             		AS PE_READY_CCL
,PPN.TE_ACTIVAR_360           		AS PE_ACTIVAR_360
,PPN.TE_TOTAL_HABILITADORES   		AS PE_TOTAL_HABILITADORES
,PPN.TC_FECHA_HAB             		AS PC_FECHA_HAB
,PPN.TE_CMP_MANDATO_CCL       		AS PE_CMP_MANDATO_CCL
,PPN.TE_CMP_CTO_BEX           		AS PE_CMP_CTO_BEX
,PPN.TE_CMP_MIGRACION         		AS PE_CMP_MIGRACION
,PPN.TE_CMP_PROPENSO_MX       		AS PE_CMP_PROPENSO_MX
,PPN.TE_CMP_FOGAPE_REACTIVA   		AS PE_CMP_FOGAPE_REACTIVA
,PPN.TE_PRIORIDAD 					AS PE_PRIORIDAD
,PPN.TE_MTO_CMP						AS PE_MTO_CMP
,PPN.TE_DECIL						AS PE_DECIL
,PPN.TE_GEST_RCH_U3M				AS PE_GEST_RCH_U3M
,PPN.TE_REPITENCIA					AS PE_REPITENCIA
,PPN.TE_RCHMX						AS PE_RCHMX	
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_RGLNEG_07 PPN
	LEFT JOIN {{ var.value.BD_JOURNEY}}.I_CMP_MAE_CLIENTE_EJECUTIVO CLI
		ON PPN.TD_RUT = CLI.IE_CLI_RUT AND
		   CLI.IC_NOM_CLI IN ('EMPRESAS JUAN YARUR SPA', 'EMPRESAS JY S A')		
;
.IF ERRORCODE <> 0 THEN .QUIT 23;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_RN;
.IF ERRORCODE <> 0 THEN .QUIT 24;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;

UPDATE - Ejemplo 9 NOK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: SACA REGLA DE LITERAL PARA CAMPANA PROPENSOS MN PLAN PROYECTOS			  **
--**                                                    				 				  **
--** AUTOR  : HARVIN VILCHEZ SANJINEZ                                                	  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 06/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN:                                                           				  **
--** AUTOR  :                                                           				  **
--** FECHA  : SSAAMMDD                                                  				  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES**
--**					MKT_JOURNEYBUILDER_TB.S_CMP_MES_TEXTO						  **
--**																					  **
--** TABLA DE SALIDA:	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES**
--**                                      												  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPOS TEXTO1, TEXTO2, TEXTO3        					 			  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
SET 
	 PC_TEXTO1 = ''
	,PC_TEXTO2 = ''
	,PC_TEXTO3 = ''  
;
.IF ERRORCODE <> 0 THEN .QUIT 1;


--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPO  TEXTO1        					 			                  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
SET 
	PC_TEXTO1 = 
		CASE 
			WHEN PE_PRIORIDAD = 1 
				THEN 'Cliente con propensión de curse para credito MN, con LGC Vigente, con disponible para curse,Propenso en Credito Moneda Nacional'
			WHEN PE_PRIORIDAD = 2 
				THEN 'Cliente con propensión de curse para crédito MN,con LGC Vigente, validar disponible, Propenso en Credito Moneda Nacional'
			WHEN PE_PRIORIDAD = 3 
				THEN 'Cliente con propensión de curse para crédito MN, validar líneas de crédito global de cliente y habilitadores documentales'
			ELSE ''
		END
WHERE 
	PE_PRIORIDAD BETWEEN 1 AND 3 
;
.IF ERRORCODE <> 0 THEN .QUIT 2;
 
--/*************************************************************************
--** SE ACTUALIZA TEXTO1 CON LA GLOSA QUE TRAE LA QUERY ANTERIOR MAS	  **  
--**  EL TEXTO DE PROYECTO      					 			          **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
SET 
	PC_TEXTO1 = SUBSTRING(RTRIM(PC_TEXTO1)||
				CASE 
					WHEN PE_PRIORIDAD = 2 AND PE_DDA_A_LIBERAR_MES > 0 THEN '. Con operación por vencer por: MM$ '
					|| COALESCE(TRIM(TRIM(OREPLACE(OREPLACE(OREPLACE(CAST(CAST(PE_DDA_A_LIBERAR_MES/1000000 AS FORMAT 'ZZZ,ZZZ,ZZ9' ) AS VARCHAR(50)) ,',','q'),'.',','),'q','.'))	),'')
				ELSE '' END,1,250)
WHERE 
	PE_PRIORIDAD = 2  
;
.IF ERRORCODE <> 0 THEN .QUIT 3;
--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES          **  
--** CAMPOS TEXTO2 CRUZANDO CON TABLA S_CMP_MES_TEXTO        			  **
--*************************************************************************/
UPDATE 
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
FROM
	MKT_JOURNEYBUILDER_TB.S_CMP_MES_TEXTO AS MTE
SET 
	PC_TEXTO2 = 
		 'Al '|| TRIM(DAYOFMONTH(CASE WHEN PC_FECHA_HAB= '' THEN '1900-01-01' ELSE PC_FECHA_HAB END)) || ' ' || MTE.SC_MES || ' Tiene: '
		||PE_TOTAL_HABILITADORES||' Hab. - Faltan:'||
		CASE WHEN PE_MANDATO_CCL = 0
				then ' Mandato CCL +' 
				ELSE ''
		END ||
		CASE WHEN PE_SIN_APR = 0 
				then ' APR +' 
				ELSE '' 
		END ||
		CASE WHEN PE_ART85 = 0 
				then ' Art85 +' 
				ELSE '' 
		END ||
		CASE WHEN PE_FYP = 0 
				then ' FyP +' 
				ELSE '' 
		END ||
		CASE WHEN PE_ESTADO_MULTIPASS = 0 
				then ' Multipass +' 
				ELSE '' 
		END ||
		CASE WHEN PE_HABILITADO_360 = 0 
				then ' Habilitar +' 
				ELSE '' 
		END ||
		CASE WHEN PE_ACTIVAR_360 = 0 
				then ' Activar 360 +' 
				ELSE '' 
		END
WHERE
	MTE.SE_MES = MONTH(CASE WHEN PC_FECHA_HAB= '' THEN '1900-01-01' ELSE PC_FECHA_HAB END)
;
.IF ERRORCODE <> 0 THEN .QUIT 4;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPO  TEXTO3        					 			                  **
--*************************************************************************/
UPDATE
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES
SET 
	 PC_TEXTO3 = ''  
;
.IF ERRORCODE <> 0 THEN .QUIT 5;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PE_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES;
.IF ERRORCODE <> 0 THEN .QUIT 6;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;


UPDATE - Ejemplo 9 OK.sql

--/*****************************************************************************************
--******************************************************************************************
--** DSCRPCN: SACA REGLA DE LITERAL PARA CAMPANA PROPENSOS MN PLAN PROYECTOS			  **
--**                                                    				 				  **
--** AUTOR  : HARVIN VILCHEZ SANJINEZ                                                	  **
--** EMPRESA: LASTRA CONSULTING GROUP                                   				  **
--** FECHA  : 06/2022                                                   				  **
--*****************************************************************************************/
--/*****************************************************************************************
--** MANTNCN: NORMALIZACION JOURNEY WHOLESALE							                  **
--** AUTOR  : JOSE LUIS APPELGREN			                                   	          **
--** FECHA  : 08/2024			     	                                                  **
--/*****************************************************************************************
--**TABLA DE ENTRADA:
--**	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_RN**
--**	MKT_JOURNEYBUILDER_TB.S_CMP_MES_TEXTO						  					  **
--**																					  **
--**TABLA TEMPORAL:																		  **
--**	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_LIT_01	  **
--**																					  **
--**TABLA DE SALIDA:																	  **
--** 	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_LIT**
--**                                      												  **
--******************************************************************************************
--*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPO  TEXTO1 y TEXTO2       			 			                  **
--*************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_LIT_01;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_LIT_01
(
	 TD_RUT 							DECIMAL(8,0)
	,TC_CLUSTER							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_PO_DEUDA						INTEGER
	,TE_CTACTE							INTEGER
	,TE_LCG_VIGENTE						INTEGER
	,TE_DISPONIBLE_MN_NEW				BIGINT
	,TD_PROPENSION_MN					DECIMAL(25,10)
	,TC_MACRO_BANCA     				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_EJE								CHAR(12) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DDA_A_LIBERAR_MES 				BIGINT 
	,TE_FLG_EXCLUSION					INTEGER
	,TC_MOTIVO_EXCLUSION				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,TC_TEXTO1							VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO2  						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,TC_TEXTO3  						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_EN_PLANEAMIENTO					INTEGER 			
    ,TC_CALIFICACION_SBIF          		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,TD_PI_CLIENTE                		DECIMAL(25,10)			
	,TC_CLASIFICACION_SBIF       		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,TE_FDR                      		INTEGER 			
	,TE_COS_CLI                 		INTEGER 			
	,TE_FILTROS_RIESGOS          		INTEGER 			
	,TC_PAR_CALIFICACION_SBIF    		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
	,TD_PAR_PI_CLIENTE           		DECIMAL(25,10)		
	,TE_PAR_FDR                  		INTEGER 			
	,TE_PAR_COS_CLI             		INTEGER 			
	,TE_MOLESTO               			INTEGER 			
	,TE_CARGABLE						INTEGER
	,TC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,TE_DISPONIBLE_OK               	INTEGER
	,TE_CON_MANDATO             		INTEGER
	,TE_ENROLADO_360            		INTEGER
	,TE_HABILITADO_360           		INTEGER
	,TE_ACTIVO_360               		INTEGER
	,TE_ESTADO_MULTIPASS        		INTEGER
	,TE_MANDATO_CCL              		INTEGER
	,TE_SIN_APR                 		INTEGER
	,TE_ART85                     		INTEGER
	,TE_FYP                    			INTEGER
	,TE_READY_CCL              			INTEGER
	,TE_ACTIVAR_360              		INTEGER
	,TE_TOTAL_HABILITADORES       		INTEGER
	,TC_FECHA_HAB 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
	,TE_CMP_MANDATO_CCL					INTEGER
	,TE_CMP_CTO_BEX						INTEGER
	,TE_CMP_MIGRACION               	INTEGER
	,TE_CMP_PROPENSO_MX             	INTEGER
	,TE_CMP_FOGAPE_REACTIVA         	INTEGER
	,TE_PRIORIDAD                   	INTEGER
	,TE_MTO_CMP    						BIGINT
	,TE_DECIL							INTEGER
	,TE_GEST_RCH_U3M					INTEGER
	,TE_REPITENCIA						INTEGER
	,TE_RCHMX							INTEGER 
)PRIMARY INDEX ( TD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 01;

INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_LIT_01
SELECT
 PPN.PD_RUT 		        		AS TD_RUT 			
,PPN.PC_CLUSTER						AS TC_CLUSTER	
,PPN.PC_RECOMENDACION_DE_CRUCE		AS TC_RECOMENDACION_DE_CRUCE	
,PPN.PE_PO_DEUDA 					AS TE_PO_DEUDA
,PPN.PE_CTACTE 						AS TE_CTACTE
,PPN.PE_LCG_VIGENTE					AS TE_LCG_VIGENTE
,PPN.PE_DISPONIBLE_MN_NEW			AS TE_DISPONIBLE_MN_NEW
,PPN.PD_PROPENSION_MN				AS TD_PROPENSION_MN
,PPN.PC_MACRO_BANCA					AS TC_MACRO_BANCA 
,PPN.PC_EJE							AS TC_EJE	
,PPN.PE_DDA_A_LIBERAR_MES			AS TE_DDA_A_LIBERAR_MES
,PPN.PE_FLG_EXCLUSION				AS TE_FLG_EXCLUSION
,PPN.PC_MOTIVO_EXCLUSION			AS TC_MOTIVO_EXCLUSION

,CASE WHEN	PPN.PE_PRIORIDAD BETWEEN 1 AND 3 
	THEN CASE
			WHEN PPN.PE_PRIORIDAD = 1 
				THEN 'Cliente con propensión de curse para credito MN, con LGC Vigente, con disponible para curse,Propenso en Credito Moneda Nacional'
			WHEN PPN.PE_PRIORIDAD = 2 
				THEN 'Cliente con propensión de curse para crédito MN,con LGC Vigente, validar disponible, Propenso en Credito Moneda Nacional'
			WHEN PPN.PE_PRIORIDAD = 3 
				THEN 'Cliente con propensión de curse para crédito MN, validar líneas de crédito global de cliente y habilitadores documentales'
			ELSE ''
		 END
	ELSE PPN.PC_TEXTO1
 END								AS TC_TEXTO1	 

,''  								AS TC_TEXTO2  	 	
,''  								AS TC_TEXTO3  	

,PPN.PE_EN_PLANEAMIENTO				AS TE_EN_PLANEAMIENTO
,PPN.PC_CALIFICACION_SBIF			AS TC_CALIFICACION_SBIF         
,PPN.PF_PERIODO_CALIFICACION		AS TF_PERIODO_CALIFICACION    	
,PPN.PD_PI_CLIENTE 					AS TD_PI_CLIENTE      		
,PPN.PC_CLASIFICACION_SBIF			AS TC_CLASIFICACION_SBIF    
,PPN.PE_FDR            				AS TE_FDR    
,PPN.PE_COS_CLI            			AS TE_COS_CLI  
,PPN.PE_FILTROS_RIESGOS				AS TE_FILTROS_RIESGOS
,PPN.PC_PAR_CALIFICACION_SBIF		AS TC_PAR_CALIFICACION_SBIF    	
,PPN.PD_PAR_PI_CLIENTE 				AS TD_PAR_PI_CLIENTE           	
,PPN.PE_PAR_FDR                		AS TE_PAR_FDR       
,PPN.PE_PAR_COS_CLI    				AS TE_PAR_COS_CLI  
,PPN.PE_MOLESTO               		AS TE_MOLESTO 
,PPN.PE_CARGABLE              		AS TE_CARGABLE
,PPN.PC_ELIMINADO	         		AS TC_ELIMINADO	
,PPN.PE_DISPONIBLE_OK         		AS TE_DISPONIBLE_OK
,PPN.PE_CON_MANDATO           		AS TE_CON_MANDATO
,PPN.PE_ENROLADO_360          		AS TE_ENROLADO_360
,PPN.PE_HABILITADO_360        		AS TE_HABILITADO_360
,PPN.PE_ACTIVO_360            		AS TE_ACTIVO_360
,PPN.PE_ESTADO_MULTIPASS      		AS TE_ESTADO_MULTIPASS
,PPN.PE_MANDATO_CCL           		AS TE_MANDATO_CCL
,PPN.PE_SIN_APR               		AS TE_SIN_APR
,PPN.PE_ART85                 		AS TE_ART85
,PPN.PE_FYP                   		AS TE_FYP
,PPN.PE_READY_CCL             		AS TE_READY_CCL
,PPN.PE_ACTIVAR_360           		AS TE_ACTIVAR_360
,PPN.PE_TOTAL_HABILITADORES   		AS TE_TOTAL_HABILITADORES
,PPN.PC_FECHA_HAB             		AS TC_FECHA_HAB
,PPN.PE_CMP_MANDATO_CCL       		AS TE_CMP_MANDATO_CCL
,PPN.PE_CMP_CTO_BEX           		AS TE_CMP_CTO_BEX
,PPN.PE_CMP_MIGRACION         		AS TE_CMP_MIGRACION
,PPN.PE_CMP_PROPENSO_MX       		AS TE_CMP_PROPENSO_MX
,PPN.PE_CMP_FOGAPE_REACTIVA   		AS TE_CMP_FOGAPE_REACTIVA
,PPN.PE_PRIORIDAD 					AS TE_PRIORIDAD
,PPN.PE_MTO_CMP						AS TE_MTO_CMP
,PPN.PE_DECIL						AS TE_DECIL
,PPN.PE_GEST_RCH_U3M				AS TE_GEST_RCH_U3M
,PPN.PE_REPITENCIA					AS TE_REPITENCIA
,PPN.PE_RCHMX						AS TE_RCHMX	
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_RN  PPN
;
.IF ERRORCODE <> 0 THEN .QUIT 02;

--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX (TD_RUT)
	ON {{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_LIT_01;
.IF ERRORCODE <> 0 THEN .QUIT 03;
 
/***********************************************************************************************
    CREA TABLA DE PRE CALCULO
************************************************************************************************/
DROP TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_LIT;
CREATE MULTISET TABLE {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_LIT
(
	 PD_RUT 							DECIMAL(8,0)
	,PC_CLUSTER							VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_RECOMENDACION_DE_CRUCE			VARCHAR(255) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_PO_DEUDA						INTEGER
	,PE_CTACTE							INTEGER
	,PE_LCG_VIGENTE						INTEGER
	,PE_DISPONIBLE_MN_NEW				BIGINT
	,PD_PROPENSION_MN					DECIMAL(25,10)
	,PC_MACRO_BANCA     				VARCHAR(16) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_EJE								CHAR(12) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_DDA_A_LIBERAR_MES 				BIGINT 
	,PE_FLG_EXCLUSION					INTEGER
	,PC_MOTIVO_EXCLUSION				VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC		
	,PC_TEXTO1							VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO2  						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	,PC_TEXTO3  						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_EN_PLANEAMIENTO					INTEGER 			
    ,PC_CALIFICACION_SBIF          		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,PF_PERIODO_CALIFICACION      		DATE FORMAT 'YYYY-MM-DD'	
	,PD_PI_CLIENTE                		DECIMAL(25,10)			
	,PC_CLASIFICACION_SBIF       		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC	
	,PE_FDR                      		INTEGER 			
	,PE_COS_CLI                 		INTEGER 			
	,PE_FILTROS_RIESGOS          		INTEGER 			
	,PC_PAR_CALIFICACION_SBIF    		VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC
	,PD_PAR_PI_CLIENTE           		DECIMAL(25,10)		
	,PE_PAR_FDR                  		INTEGER 			
	,PE_PAR_COS_CLI             		INTEGER 			
	,PE_MOLESTO               			INTEGER 			
	,PE_CARGABLE						INTEGER
	,PC_ELIMINADO						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC
	,PE_DISPONIBLE_OK               	INTEGER
	,PE_CON_MANDATO             		INTEGER
	,PE_ENROLADO_360            		INTEGER
	,PE_HABILITADO_360           		INTEGER
	,PE_ACTIVO_360               		INTEGER
	,PE_ESTADO_MULTIPASS        		INTEGER
	,PE_MANDATO_CCL              		INTEGER
	,PE_SIN_APR                 		INTEGER
	,PE_ART85                     		INTEGER
	,PE_FYP                    			INTEGER
	,PE_READY_CCL              			INTEGER
	,PE_ACTIVAR_360              		INTEGER
	,PE_TOTAL_HABILITADORES       		INTEGER
	,PC_FECHA_HAB 						VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC 
	,PE_CMP_MANDATO_CCL					INTEGER
	,PE_CMP_CTO_BEX						INTEGER
	,PE_CMP_MIGRACION               	INTEGER
	,PE_CMP_PROPENSO_MX             	INTEGER
	,PE_CMP_FOGAPE_REACTIVA         	INTEGER
	,PE_PRIORIDAD                   	INTEGER
	,PE_MTO_CMP    						BIGINT
	,PE_DECIL							INTEGER
	,PE_GEST_RCH_U3M					INTEGER
	,PE_REPITENCIA						INTEGER
	,PE_RCHMX							INTEGER 
)PRIMARY INDEX ( PD_RUT )
;
.IF ERRORCODE <> 0 THEN .QUIT 04;

--/*************************************************************************
--** SE ACTUALIZA TABLA P_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES		  **  
--** CAMPO  TEXTO1 			       			 			                  **
--*************************************************************************/	
INSERT INTO {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_LIT
SELECT
 PPN.TD_RUT 		        		AS PD_RUT 			
,PPN.TC_CLUSTER						AS PC_CLUSTER	
,PPN.TC_RECOMENDACION_DE_CRUCE		AS PC_RECOMENDACION_DE_CRUCE	
,PPN.TE_PO_DEUDA 					AS PE_PO_DEUDA
,PPN.TE_CTACTE 						AS PE_CTACTE
,PPN.TE_LCG_VIGENTE					AS PE_LCG_VIGENTE
,PPN.TE_DISPONIBLE_MN_NEW			AS PE_DISPONIBLE_MN_NEW
,PPN.TD_PROPENSION_MN				AS PD_PROPENSION_MN
,PPN.TC_MACRO_BANCA					AS PC_MACRO_BANCA 
,PPN.TC_EJE							AS PC_EJE	
,PPN.TE_DDA_A_LIBERAR_MES			AS PE_DDA_A_LIBERAR_MES
,PPN.TE_FLG_EXCLUSION				AS PE_FLG_EXCLUSION
,PPN.TC_MOTIVO_EXCLUSION			AS PC_MOTIVO_EXCLUSION

,CASE WHEN PPN.TE_PRIORIDAD = 2 
	THEN SUBSTRING(RTRIM(PPN.TC_TEXTO1)||
	 CASE 
	 	WHEN PPN.TE_PRIORIDAD = 2 AND PPN.TE_DDA_A_LIBERAR_MES > 0 THEN '. Con operación por vencer por: MM$ '
	 	|| COALESCE(TRIM(TRIM(OREPLACE(OREPLACE(OREPLACE(CAST(CAST(PPN.TE_DDA_A_LIBERAR_MES/1000000 AS FORMAT 'ZZZ,ZZZ,ZZ9' ) AS VARCHAR(50)) ,',','q'),'.',','),'q','.'))	),'')
	 ELSE '' END,1,250)
 ELSE PPN.TC_TEXTO1 END 			AS PC_TEXTO1	

,'Al ' || TRIM(DAYOFMONTH(CASE WHEN PPN.TC_FECHA_HAB = '' THEN '1900-01-01' ELSE PPN.TC_FECHA_HAB END)) || ' ' || MTE.SC_MES || ' Tiene: ' ||
 PPN.TE_TOTAL_HABILITADORES || ' Hab. - Faltan:' ||
 CASE WHEN PPN.TE_MANDATO_CCL = 0 		THEN ' Mandato CCL +' 	ELSE '' END ||
 CASE WHEN PPN.TE_SIN_APR = 0 			THEN ' APR +' 			ELSE '' END ||
 CASE WHEN PPN.TE_ART85 = 0 			THEN ' Art85 +' 		ELSE '' END ||
 CASE WHEN PPN.TE_FYP = 0 				THEN ' FyP +' 			ELSE '' END ||
 CASE WHEN PPN.TE_ESTADO_MULTIPASS = 0 	THEN ' Multipass +' 	ELSE '' END ||
 CASE WHEN PPN.TE_HABILITADO_360 = 0 	THEN ' Habilitar +' 	ELSE '' END ||
 CASE WHEN PPN.TE_ACTIVAR_360 = 0 		THEN ' Activar 360 +' 	ELSE '' END
									AS PC_TEXTO2  	

,PPN.TC_TEXTO3						AS PC_TEXTO3
,PPN.TE_EN_PLANEAMIENTO				AS PE_EN_PLANEAMIENTO
,PPN.TC_CALIFICACION_SBIF			AS PC_CALIFICACION_SBIF         
,PPN.TF_PERIODO_CALIFICACION		AS PF_PERIODO_CALIFICACION    	
,PPN.TD_PI_CLIENTE 					AS PD_PI_CLIENTE      		
,PPN.TC_CLASIFICACION_SBIF			AS PC_CLASIFICACION_SBIF    
,PPN.TE_FDR            				AS PE_FDR    
,PPN.TE_COS_CLI            			AS PE_COS_CLI  
,PPN.TE_FILTROS_RIESGOS				AS PE_FILTROS_RIESGOS
,PPN.TC_PAR_CALIFICACION_SBIF		AS PC_PAR_CALIFICACION_SBIF    	
,PPN.TD_PAR_PI_CLIENTE 				AS PD_PAR_PI_CLIENTE           	
,PPN.TE_PAR_FDR                		AS PE_PAR_FDR       
,PPN.TE_PAR_COS_CLI    				AS PE_PAR_COS_CLI  
,PPN.TE_MOLESTO               		AS PE_MOLESTO 
,PPN.TE_CARGABLE              		AS PE_CARGABLE
,PPN.TC_ELIMINADO	         		AS PC_ELIMINADO	
,PPN.TE_DISPONIBLE_OK         		AS PE_DISPONIBLE_OK
,PPN.TE_CON_MANDATO           		AS PE_CON_MANDATO
,PPN.TE_ENROLADO_360          		AS PE_ENROLADO_360
,PPN.TE_HABILITADO_360        		AS PE_HABILITADO_360
,PPN.TE_ACTIVO_360            		AS PE_ACTIVO_360
,PPN.TE_ESTADO_MULTIPASS      		AS PE_ESTADO_MULTIPASS
,PPN.TE_MANDATO_CCL           		AS PE_MANDATO_CCL
,PPN.TE_SIN_APR               		AS PE_SIN_APR
,PPN.TE_ART85                 		AS PE_ART85
,PPN.TE_FYP                   		AS PE_FYP
,PPN.TE_READY_CCL             		AS PE_READY_CCL
,PPN.TE_ACTIVAR_360           		AS PE_ACTIVAR_360
,PPN.TE_TOTAL_HABILITADORES   		AS PE_TOTAL_HABILITADORES
,PPN.TC_FECHA_HAB             		AS PC_FECHA_HAB
,PPN.TE_CMP_MANDATO_CCL       		AS PE_CMP_MANDATO_CCL
,PPN.TE_CMP_CTO_BEX           		AS PE_CMP_CTO_BEX
,PPN.TE_CMP_MIGRACION         		AS PE_CMP_MIGRACION
,PPN.TE_CMP_PROPENSO_MX       		AS PE_CMP_PROPENSO_MX
,PPN.TE_CMP_FOGAPE_REACTIVA   		AS PE_CMP_FOGAPE_REACTIVA
,PPN.TE_PRIORIDAD 					AS PE_PRIORIDAD
,PPN.TE_MTO_CMP						AS PE_MTO_CMP
,PPN.TE_DECIL						AS PE_DECIL
,PPN.TE_GEST_RCH_U3M				AS PE_GEST_RCH_U3M
,PPN.TE_REPITENCIA					AS PE_REPITENCIA
,PPN.TE_RCHMX						AS PE_RCHMX	
FROM
	{{ var.value.BD_TEMP_JOURNEY}}.T_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_LIT_01  PPN
	LEFT JOIN MKT_JOURNEYBUILDER_TB.S_CMP_MES_TEXTO MTE	
    ON MTE.SE_MES = MONTH(CASE WHEN PPN.TC_FECHA_HAB = '' THEN '1900-01-01' ELSE PPN.TC_FECHA_HAB END)		
;
.IF ERRORCODE <> 0 THEN .QUIT 05;
--/***********************************************************************
--**						SE APLICAN COLLECTS 						**  
--***********************************************************************/	
COLLECT STATS INDEX ( PD_RUT )
	ON {{ var.value.BD_TEMP_JOURNEY}}.P_JNY_WSBCCMN002OB_CAMPANA_PROPENSO_MN_PLAN_PROYECTOS_MES_LIT;
.IF ERRORCODE <> 0 THEN .QUIT 06;

SELECT DATE, TIME;

.LOGOFF;
.QUIT 0;


