CREATE_UPDATE - Ejemplo 1 NOK.sql

/*
REALIZADO POR	: LEONARDO PEZOA
FECHA			: 25/08/2020
PROVIENE SCRIPT	: TERADATA_SCRIPT_CCL_PRORROGA.SQL
OBBETIVO 		: GENERA TABLA CON MARGENES DIARIOS DE WSB
PERIODO EJEC.	: DIARIA
TAB. SALIDA		: MKT_CRM_CMP_TB.TBL_LCG
*/

------------------------------------------------------------------
-------------------- CREO LCG  ---------------------------
------------------------------------------------------------------

SELECT 1 FROM dbc.TablesV WHERE databasename = 'MKT_CRM_CMP_TB' AND TABLENAME = 'TMP_CLF';
.IF ACTIVITYCOUNT = 0 THEN GOTO CMP_TRABAJAR
DROP TABLE MKT_CRM_CMP_TB.TMP_CLF;
.LABEL CMP_TRABAJAR

--CREATE TABLE MKT_CRM_CMP_TB.TMP_CLF  AS (
--SELECT B.ACCOUNT_NUM AS NUM_CUENTA
--,B.Acct_Status_Type_Cd AS ESTADO
--,B.Credit_Limit_Amt AS CUPO_MAXIMO_ASIGNADO
--,B.Currency_Cd AS MONEDA
--,A.PARTY_ID AS PARTY_ID
--,B.Account_Type_Cd AS CLASE_OPERACION
--,B.Related_Account_Num AS CLF_RENOVADA
--,B.Account_Open_Dt AS FECHA_APERTURA
--,B.Account_Close_Dt AS FECHA_CIERRE
--,B.Acct_Status_Reason_Cd AS RAZON_CIERRE
--,B.Margen_Vcto_Dt AS FECHA_VCTO
--,B.End_Review_Margen_Dt AS FECHA_ULTIMA_REVISION
--FROM Edw_Vw.BCI_RCO_CLF A
--INNER JOIN  Edw_Vw.BCI_CLF B ON A.ACCOUNT_NUM=B.ACCOUNT_NUM
--WHERE B.Acct_Status_Type_Cd='A'
--)WITH DATA PRIMARY INDEX (NUM_CUENTA);

CREATE MULTISET TABLE MKT_CRM_CMP_TB.TMP_CLF
(
NUM_CUENTA             VARCHAR(30)
,ESTADO                 VARCHAR(10)
,CUPO_MAXIMO_ASIGNADO   DECIMAL(20,2)
,MONEDA                 VARCHAR(50)
,PARTY_ID               INTEGER
,CLASE_OPERACION        VARCHAR(10)
,CLF_RENOVADA           VARCHAR(30)
,FECHA_APERTURA         DATE FORMAT 'YYYYMM'
,FECHA_CIERRE           DATE FORMAT 'YYYYMM'
,RAZON_CIERRE           VARCHAR(50)
,FECHA_VCTO             DATE FORMAT 'YYYYMM'
,FECHA_ULTIMA_REVISION  DATE FORMAT 'YYYYMM'
) PRIMARY INDEX (NUM_CUENTA);

INSERT INTO MKT_CRM_CMP_TB.TMP_CLF
SELECT B.ACCOUNT_NUM 			AS NUM_CUENTA
,B.Acct_Status_Type_Cd			AS ESTADO
,B.Credit_Limit_Amt				AS CUPO_MAXIMO_ASIGNADO
,B.Currency_Cd					AS MONEDA
,A.PARTY_ID						AS PARTY_ID		
,B.Account_Type_Cd				AS CLASE_OPERACION
,B.Related_Account_Num			AS CLF_RENOVADA
,B.Account_Open_Dt				AS FECHA_APERTURA
,B.Account_Close_Dt				AS FECHA_CIERRE
,B.Acct_Status_Reason_Cd		AS RAZON_CIERRE
,B.Margen_Vcto_Dt				AS FECHA_VCTO
,B.End_Review_Margen_Dt			AS FECHA_ULTIMA_REVISION
FROM Edw_Vw.BCI_RCO_CLF A
INNER JOIN Edw_Vw.BCI_CLF B ON A.ACCOUNT_NUM=B.ACCOUNT_NUM
WHERE B.Acct_Status_Type_Cd='A';

.IF ERRORCODE <> 0 THEN .QUIT 1;

------------------------------------------------------------------
-------------------- CREO DETALLE LCG  -----------
------------------------------------------------------------------
SELECT 1 FROM dbc.TablesV WHERE databasename = 'MKT_CRM_CMP_TB' AND TABLENAME = 'TMP_LDC_CLF';
.IF ACTIVITYCOUNT = 0 THEN GOTO CMP_TRABAJAR
DROP TABLE MKT_CRM_CMP_TB.TMP_LDC_CLF;
.LABEL CMP_TRABAJAR

--CREATE TABLE MKT_CRM_CMP_TB.TMP_LDC_CLF   (
--PARTY_ID INT,
--NUM_CUENTA VARCHAR(250),
--CODIGO_LINEA VARCHAR(250),
--LINEA VARCHAR(250),
--CUPO_MAXIMO_ASIGNADO  BIGINT,
--MONEDA  VARCHAR(250),
--CUPO_CONTRATADO BIGINT,
--MULTIPLE_GARANTIA  VARCHAR(250),
--FECHA_INICIO DATE,
--FECHA_VCTO DATE,
--DISPONIBLE BIGINT,
--UTILIZADO BIGINT
--) ;
--
--

CREATE MULTISET TABLE MKT_CRM_CMP_TB.TMP_LDC_CLF
(
PARTY_ID 				INTEGER
,NUM_CUENTA 			VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
,CODIGO_LINEA 			INTEGER
,LINEA 					VARCHAR(15) CHARACTER SET LATIN NOT CASESPECIFIC
,CUPO_MAXIMO_ASIGNADO 	BIGINT
,MONEDA 				VARCHAR(15) CHARACTER SET LATIN NOT CASESPECIFIC
,CUPO_CONTRATADO		BIGINT
,MULTIPLE_GARANTIA 		VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
,FECHA_INICIO 			DATE FORMAT 'YYYYMM'
,FECHA_VCTO 			DATE FORMAT 'YYYYMM'
,DISPONIBLE 			BIGINT
,UTILIZADO 				BIGINT
);

INSERT INTO  MKT_CRM_CMP_TB.TMP_LDC_CLF
select a.PARTY_ID
,B.Account_Num AS NUM_CUENTA
,B.Account_Modifier_Num AS CODIGO_LINEA
,B.Line_Type_Cd AS LINEA
,cast(B.Max_Capacity_Assigned AS BIGINT) Cupo_Maximo_Asignado
,B.Currency_Cd AS MONEDA
,CAST(B.Capacity_Contracted AS BIGINT)AS CUPO_CONTRATADO
,B.Multiple_Indicator_Warranty AS MULTIPLE_GARANTIA
,B.Account_Open_Dt AS FECHA_INICIO
,B.Contract_Expiration_Dt AS FECHA_VCTO
,cast(C.Available_Capacity_Amt as BIGINT)  AS DISPONIBLE
,cast(C.Used_Capacity_Amt as BIGINT)  AS UTILIZADO
FROM MKT_CRM_CMP_TB.TMP_CLF A
INNER JOIN Edw_Vw.BCI_LDC_CLF B ON A.NUM_CUENTA=B.ACCOUNT_NUM
LEFT JOIN Edw_Vw.BCI_DISP_UTI_LDC_CLF C ON cast(trim(B.Account_Num) as char(12)) = cast(trim(C.Account_Num) as char(12)) and cast(trim(B.Account_Modifier_Num) as char(2)) = cast(trim(C.Account_Modifier_Num) as char(2));

.IF ERRORCODE <> 0 THEN .QUIT 1;

---------------------------------------------------------------------------------


------------------------------------------------------------------
-------------------- ACTUALIZO EN BASE A MONEDA
------------------------------------------------------------------
update a
from MKT_CRM_CMP_TB.TMP_CLF   a,
EDW_VW.CURRENCY_TRANSLATION_RATE_HIST b
set CUPO_MAXIMO_ASIGNADO      = cast(ZEROIFNULL(case when MONEDA='0999' THEN   CUPO_MAXIMO_ASIGNADO
when (MONEDA='0998' and b.Global_Currency_Cd='0998')   OR
(MONEDA='1013' and b.Global_Currency_Cd='131301') OR
    (MONEDA='1142' and b.Global_Currency_Cd='114201')
THEN CUPO_MAXIMO_ASIGNADO * cast(b.Global_To_Source_Currency_Rate as bigint)
      end) As bigint)
where b.Currency_Trans_Start_Dt =CURRENT_DATE
AND b.Source_Currency_Cd = '0999'
AND b.Global_Currency_Cd = '0998'
AND b.Currency_Rate_Type_Cd = '001';

.IF ERRORCODE <> 0 THEN .QUIT 1;

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

update a
from MKT_CRM_CMP_TB.TMP_LDC_CLF   a,
EDW_VW.CURRENCY_TRANSLATION_RATE_HIST b
set CUPO_MAXIMO_ASIGNADO      = cast(ZEROIFNULL(case when MONEDA='0999' THEN   CUPO_MAXIMO_ASIGNADO
when (MONEDA='0998' and b.Global_Currency_Cd='0998')   OR
(MONEDA='1013' and b.Global_Currency_Cd='131301') OR
    (MONEDA='1142' and b.Global_Currency_Cd='114201')
THEN CUPO_MAXIMO_ASIGNADO * cast(b.Global_To_Source_Currency_Rate as bigint)
      end) As bigint)
where b.Currency_Trans_Start_Dt =CURRENT_DATE
AND b.Source_Currency_Cd = '0999'
AND b.Global_Currency_Cd = '0998'
AND b.Currency_Rate_Type_Cd = '001';

.IF ERRORCODE <> 0 THEN .QUIT 1;

update a
from MKT_CRM_CMP_TB.TMP_LDC_CLF   a,
EDW_VW.CURRENCY_TRANSLATION_RATE_HIST b
set CUPO_CONTRATADO      = cast(ZEROIFNULL(case when MONEDA='0999' THEN   CUPO_CONTRATADO
when (MONEDA='0998' and b.Global_Currency_Cd='0998')   OR
(MONEDA='1013' and b.Global_Currency_Cd='131301') OR
    (MONEDA='1142' and b.Global_Currency_Cd='114201')
THEN CUPO_CONTRATADO * cast(b.Global_To_Source_Currency_Rate as bigint)
      end) As bigint)
where b.Currency_Trans_Start_Dt =CURRENT_DATE
AND b.Source_Currency_Cd = '0999'
AND b.Global_Currency_Cd = '0998'
AND b.Currency_Rate_Type_Cd = '001';

.IF ERRORCODE <> 0 THEN .QUIT 1;

update a
from MKT_CRM_CMP_TB.TMP_LDC_CLF   a,
EDW_VW.CURRENCY_TRANSLATION_RATE_HIST b
set DISPONIBLE      = cast(ZEROIFNULL(DISPONIBLE * cast(b.Global_To_Source_Currency_Rate as bigint)) As bigint)
where b.Currency_Trans_Start_Dt =CURRENT_DATE
AND b.Global_Currency_Cd = '0998';

.IF ERRORCODE <> 0 THEN .QUIT 1;

update a
from MKT_CRM_CMP_TB.TMP_LDC_CLF   a,
EDW_VW.CURRENCY_TRANSLATION_RATE_HIST b
set UTILIZADO      = cast(ZEROIFNULL(UTILIZADO * cast(b.Global_To_Source_Currency_Rate as bigint)) As bigint)
where b.Currency_Trans_Start_Dt =CURRENT_DATE
AND b.Global_Currency_Cd = '0998';

.IF ERRORCODE <> 0 THEN .QUIT 1;

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------
-------------------- TBL_DETALLE LCG
------------------------------------------------------------------

SELECT 1 FROM dbc.TablesV WHERE databasename = 'MKT_CRM_CMP_TB' AND TABLENAME = 'TBL_DETALLE_LCG';
.IF ACTIVITYCOUNT = 0 THEN GOTO CMP_TRABAJAR
DROP TABLE MKT_CRM_CMP_TB.TBL_DETALLE_LCG;
.LABEL CMP_TRABAJAR


--CREATE TABLE MKT_CRM_CMP_TB.TBL_DETALLE_LCG AS (
--SELECT B.CLI_RUT RUT,
--NUM_CUENTA,
--CODIGO_LINEA,
--LINEA,
--CAST(CUPO_MAXIMO_ASIGNADO AS BIGINT) AS CUPO_MAXIMO,
--CAST(CUPO_CONTRATADO AS BIGINT) AS CUPO_CONTRATADO,
--MULTIPLE_GARANTIA,
--FECHA_INICIO,
--CAST(FECHA_VCTO AS DATE) AS FECHA_VCTO,
--CAST(DISPONIBLE AS BIGINT) AS DISPONIBLE, 
--CAST(UTILIZADO AS BIGINT) AS UTILIZADO
--FROM MKT_CRM_CMP_TB.TMP_LDC_CLF A
--INNER JOIN EDW_SEMLAY_VW.CLI B ON A.PARTY_ID=B.PARTY_ID  
--) WITH DATA PRIMARY INDEX (NUM_CUENTA,CODIGO_LINEA);

CREATE MULTISET TABLE MKT_CRM_CMP_TB.TBL_DETALLE_LCG
(
RUT 				VARCHAR(15) CHARACTER SET LATIN NOT CASESPECIFIC
,NUM_CUENTA			VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
,CODIGO_LINEA 		INTEGER
,LINEA 				VARCHAR(10) CHARACTER SET LATIN NOT CASESPECIFIC
,CUPO_MAXIMO 		BIGINT
,CUPO_CONTRATADO 	BIGINT
,MULTIPLE_GARANTIA 	VARCHAR(5)
,FECHA_INICIO 		DATE FORMAT 'YYYYMM'
,FECHA_VCTO 		DATE FORMAT 'YYYYMM'
,DISPONIBLE 		BIGINT
,UTILIZADO 			BIGINT
) PRIMARY INDEX (NUM_CUENTA, CODIGO_LINEA);

INSERT INTO MKT_CRM_CMP_TB.TBL_DETALLE_LCG
SELECT B.CLI_RUT AS RUT
,NUM_CUENTA
,CODIGO_LINEA
,LINEA
,CAST(CUPO_MAXIMO_ASIGNADO AS BIGINT) AS CUPO_MAXIMO
,CAST(CUPO_CONTRATADO AS BIGINT)
,MULTIPLE_GARANTIA
,FECHA_INICIO
,CAST(FECHA_VCTO AS DATE)
,CAST(DISPONIBLE AS BIGINT)
,CAST(UTILIZADO AS BIGINT)
FROM MKT_CRM_CMP_TB.TMP_LDC_CLF A
INNER JOIN EDW_SEMLAY_VW.CLI B ON A.PARTY_ID=B.PARTY_ID;

.IF ERRORCODE <> 0 THEN .QUIT 1;

------------------------------------------------------------------
--------------------  CALCULO DISPONIBLE CP, LP Y ROTATIVO
------------------------------------------------------------------

SELECT 1 FROM dbc.TablesV WHERE databasename = 'MKT_CRM_CMP_TB' AND TABLENAME = 'TMP_DISPONIBLE_WSB';
.IF ACTIVITYCOUNT = 0 THEN GOTO CMP_TRABAJAR
DROP TABLE MKT_CRM_CMP_TB.TMP_DISPONIBLE_WSB;
.LABEL CMP_TRABAJAR

--CREATE TABLE MKT_CRM_CMP_TB.TMP_DISPONIBLE_WSB  (
--RUT INT,
--NUM_CUENTA VARCHAR(250),
--KT_MN BIGINT,
--VCTO_KT_MN DATE,
--FCT BIGINT,
--VCTO_FCT DATE,
--LEA BIGINT,
--VCTO_LEA DATE,
--LBG BIGINT,
--VCTO_LBG DATE ,
--OTRO_LBG BIGINT,
--VCTO_OTRO_LBG DATE,
--LEM BIGINT,
--VCTO_LEM DATE,
--LME BIGINT,
--VCTO_LME DATE,
--LSG BIGINT,
--VCTO_LSG DATE,
--TCR BIGINT,
--VCTO_TCR DATE,
--BEM BIGINT,
--VCTO_BEM DATE,
--CCA BIGINT,
--VCTO_CCA DATE,
--CHIP BIGINT,
--VCTO_CHIP DATE,
--DER BIGINT,
--VCTO_DER DATE,
--FUT BIGINT,
--VCTO_FUT DATE,
--INC BIGINT,
--VCTO_INC DATE,
--LCB BIGINT,
--VCTO_LCB DATE,
--LP_MN BIGINT,
--VCTO_LP_MN DATE,
--MLT BIGINT,
--VCTO_MLT DATE,
--OPS BIGINT,
--VCTO_OPS DATE,
--OTRO_LP BIGINT,
--VCTO_OTRO_LP DATE,
--PCT BIGINT,
--VCTO_PCT DATE,
--SPT BIGINT,
--VCTO_SPT DATE,
--OTRO_LME BIGINT,
--VCTO_OTRO_LME DATE,
--WXO BIGINT,
--VCT_WXO DATE,
--WUO BIGINT,
--VCT_WUO DATE,
--WCO BIGINT,
--VCT_WCO DATE,
--WBO BIGINT,
--VCT_WBO DATE,
--WSO BIGINT,
--VCT_WSO DATE,
--WTC BIGINT,
--VCT_WTC DATE,
--WLS BIGINT,
--VCT_WLS DATE,
--WLM BIGINT,
--VCT_WLM DATE,
--WXP BIGINT,
--VCT_WXP DATE,
--WUP BIGINT,
--VCT_WUP DATE,
--WCP BIGINT,
--VCT_WCP DATE,
--WBP BIGINT,
--VCT_WBP DATE,
--WSB BIGINT,
--VCT_WSB DATE,
--WLI BIGINT,
--VCT_WLI DATE,
--WHV BIGINT,
--VCT_WHV DATE,
--WFG BIGINT,
--VCT_WFG DATE,
--WLO BIGINT,
--VCT_WLO DATE,
--WFO BIGINT,
--VCT_WFO DATE,
--WDO BIGINT,
--VCT_WDO DATE,
--WMM BIGINT,
--VCT_WMM DATE,
--WSP BIGINT,
--VCT_WSP DATE,
--WBN BIGINT,
--VCT_WBN DATE,
--WPP BIGINT,
--VCT_WPP DATE,
--WFB BIGINT,
--VCT_WFB DATE
--);


CREATE MULTISET TABLE MKT_CRM_CMP_TB.TMP_DISPONIBLE_WSB
(
RUT 				VARCHAR(20) CHARACTER SET LATIN NOT CASESPECIFIC
,NUM_CUENTA 		VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
,KT_MN 				BIGINT
,VCTO_KT_MN 		DATE FORMAT 'YYYYMM'
,FCT 				BIGINT
,VCTO_FCT 			DATE FORMAT 'YYYYMM'
,LEA 				BIGINT
,VCTO_LEA 			DATE FORMAT 'YYYYMM'
,LBG 				BIGINT
,VCTO_LBG 			DATE FORMAT 'YYYYMM' 
,OTRO_LBG 			BIGINT
,VCTO_OTRO_LBG 		DATE FORMAT 'YYYYMM'
,LEM 				BIGINT
,VCTO_LEM 			DATE FORMAT 'YYYYMM'
,LME 				BIGINT
,VCTO_LME 			DATE FORMAT 'YYYYMM'
,LSG 				BIGINT
,VCTO_LSG 			DATE FORMAT 'YYYYMM'
,TCR 				BIGINT
,VCTO_TCR 			DATE FORMAT 'YYYYMM'
,BEM 				BIGINT
,VCTO_BEM 			DATE FORMAT 'YYYYMM'
,CCA 				BIGINT
,VCTO_CCA 			DATE FORMAT 'YYYYMM'
,CHIP 				BIGINT
,VCTO_CHIP 			DATE FORMAT 'YYYYMM'
,DER 				BIGINT
,VCTO_DER 			DATE FORMAT 'YYYYMM'
,FUT 				BIGINT
,VCTO_FUT 			DATE FORMAT 'YYYYMM'
,INC 				BIGINT
,VCTO_INC 			DATE FORMAT 'YYYYMM'
,LCB 				BIGINT
,VCTO_LCB 			DATE FORMAT 'YYYYMM'
,LP_MN 				BIGINT
,VCTO_LP_MN 		DATE FORMAT 'YYYYMM'
,MLT 				BIGINT
,VCTO_MLT 			DATE FORMAT 'YYYYMM'
,OPS 				BIGINT
,VCTO_OPS 			DATE FORMAT 'YYYYMM'
,OTRO_LP 			BIGINT
,VCTO_OTRO_LP 		DATE FORMAT 'YYYYMM'
,PCT 				BIGINT
,VCTO_PCT 			DATE FORMAT 'YYYYMM'
,SPT 				BIGINT
,VCTO_SPT 			DATE FORMAT 'YYYYMM'
,OTRO_LME 			BIGINT
,VCTO_OTRO_LME 		DATE FORMAT 'YYYYMM'
,WXO 				BIGINT
,VCT_WXO 			DATE FORMAT 'YYYYMM'
,WUO 				BIGINT
,VCT_WUO 			DATE FORMAT 'YYYYMM'
,WCO 				BIGINT
,VCT_WCO 			DATE FORMAT 'YYYYMM'
,WBO 				BIGINT
,VCT_WBO 			DATE FORMAT 'YYYYMM'
,WSO 				BIGINT
,VCT_WSO 			DATE FORMAT 'YYYYMM'
,WTC 				BIGINT
,VCT_WTC 			DATE FORMAT 'YYYYMM'
,WLS 				BIGINT
,VCT_WLS 			DATE FORMAT 'YYYYMM'
,WLM 				BIGINT
,VCT_WLM 			DATE FORMAT 'YYYYMM'
,WXP 				BIGINT
,VCT_WXP 			DATE FORMAT 'YYYYMM'
,WUP 				BIGINT
,VCT_WUP 			DATE FORMAT 'YYYYMM'
,WCP 				BIGINT
,VCT_WCP 			DATE FORMAT 'YYYYMM'
,WBP 				BIGINT
,VCT_WBP 			DATE FORMAT 'YYYYMM'
,WSB 				BIGINT
,VCT_WSB 			DATE FORMAT 'YYYYMM'
,WLI 				BIGINT
,VCT_WLI 			DATE FORMAT 'YYYYMM'
,WHV 				BIGINT
,VCT_WHV 			DATE FORMAT 'YYYYMM'
,WFG 				BIGINT
,VCT_WFG 			DATE FORMAT 'YYYYMM'
,WLO 				BIGINT
,VCT_WLO 			DATE FORMAT 'YYYYMM'
,WFO 				BIGINT
,VCT_WFO 			DATE FORMAT 'YYYYMM'
,WDO 				BIGINT
,VCT_WDO 			DATE FORMAT 'YYYYMM'
,WMM 				BIGINT
,VCT_WMM 			DATE FORMAT 'YYYYMM'
,WSP 				BIGINT
,VCT_WSP 			DATE FORMAT 'YYYYMM'
,WBN 				BIGINT
,VCT_WBN 			DATE FORMAT 'YYYYMM'
,WPP 				BIGINT
,VCT_WPP			DATE FORMAT 'YYYYMM'
,WFB 				BIGINT
,VCT_WFB 			DATE FORMAT 'YYYYMM'
);


INSERT INTO MKT_CRM_CMP_TB.TMP_DISPONIBLE_WSB
SELECT RUT,
NUM_CUENTA,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('L01') THEN DISPONIBLE END )) AS KT_MN,
MAX(CASE WHEN LINEA IN ('L01') THEN CAST(FECHA_VCTO AS DATE FORMAT 'YYYY-MM-DD') END ) AS VCTO_KT_MN,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('FCE','FCT','FCF','FPP','L2A','FCI') THEN DISPONIBLE END )) AS FCT,
MAX(CASE WHEN LINEA IN ('FCE','FCT','FCF','FPP','L2A','FCI') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_FCT,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('LEA','LPU','LEI') THEN DISPONIBLE END )) AS LEA,
MAX(CASE WHEN LINEA IN ('LEA','LPU','LEI') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_LEA,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('LBG') THEN DISPONIBLE END )) AS LBG ,
MAX(CASE WHEN LINEA IN ('LBG') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_LBG ,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('LBP') THEN DISPONIBLE END )) AS OTROS_LBG ,
MAX(CASE WHEN LINEA IN ('LBP') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_OTROS_LBG ,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('LEP','LEM') THEN DISPONIBLE END )) AS LEM,
MAX(CASE WHEN LINEA IN ('LEP','LEM') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_LEM,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('LME') THEN DISPONIBLE END )) AS LME,
MAX(CASE WHEN LINEA IN ('LME') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_LME,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('LSB','LSO','LSE','LSP','BAS') THEN DISPONIBLE END )) AS LSG,
MAX(CASE WHEN LINEA IN ('LSB','LSO','LSE','LSP','BAS') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_LSG,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('LTP','LTC','TCP') THEN DISPONIBLE END )) AS TCR,
MAX(CASE WHEN LINEA IN ('LTP','LTC','TCP') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_TCR,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('BEM','BCE','YBO','SET') THEN DISPONIBLE END )) AS BEM,
MAX(CASE WHEN LINEA IN ('BEM','BCE','YBO','SET') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_BEM,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('CCA','CRP') THEN DISPONIBLE END )) AS CCA ,
MAX(CASE WHEN LINEA IN ('CCA','CRP') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_CCA ,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('HFG','LPH','CHP') THEN DISPONIBLE END )) AS CHIP,
MAX(CASE WHEN LINEA IN ('HFG','LPH','CHP') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_CHIP,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('DCP','DLP','MMD') THEN DISPONIBLE END )) AS DER,
MAX(CASE WHEN LINEA IN ('DCP','DLP','MMD') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_DER,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('LFU') THEN DISPONIBLE END )) AS FUT,
MAX(CASE WHEN LINEA IN ('LFU') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_FUT,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('INC') THEN DISPONIBLE END )) AS INC,
MAX(CASE WHEN LINEA IN ('INC') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_INC,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('LCB') THEN DISPONIBLE END )) AS LCB,
MAX(CASE WHEN LINEA IN ('LCB') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_LCB,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('L09','BUL') THEN DISPONIBLE END )) AS LP_MN,
MAX(CASE WHEN LINEA IN ('L09','BUL') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_LP_MN,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('MLT') THEN DISPONIBLE END )) AS MLT,
MAX(CASE WHEN LINEA IN ('MLT') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_MLT,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('OPS') THEN DISPONIBLE END )) AS OPS,
MAX(CASE WHEN LINEA IN ('OPS') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_OPS,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('CPP','PYM','CDP','CPC','LOP','MLI','CRL','LEX') THEN DISPONIBLE END )) AS OTRO_LP,
MAX(CASE WHEN LINEA IN ('CPP','PYM','CDP','CPC','LOP','MLI','CRL','LEX') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_OTRO_LP,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('LCP') THEN DISPONIBLE END )) AS PCT,
MAX(CASE WHEN LINEA IN ('LCP') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_PCT,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('CHS') THEN DISPONIBLE END )) AS SPT,
MAX(CASE WHEN LINEA IN ('CHS') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_SPT,
ZEROIFNULL(MAX(CASE WHEN LINEA IN ('LCX','CRC','FEM','CHC','CCC','CCL') THEN DISPONIBLE END )) AS OTRO_LME,
MAX(CASE WHEN LINEA IN ('LCX','CRC','FEM','CHC','CCC','CCL') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_OTRO_LME,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WXO') THEN DISPONIBLE END )) AS WXO,
MAX(CASE WHEN LINEA IN ('WXO') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WXO,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WUO') THEN DISPONIBLE END )) AS WUO,
MAX(CASE WHEN LINEA IN ('WUO') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WUO,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WCO') THEN DISPONIBLE END )) AS WCO,
MAX(CASE WHEN LINEA IN ('WCO') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WCO,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WBO') THEN DISPONIBLE END )) AS WBO,
MAX(CASE WHEN LINEA IN ('WBO') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WBO,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WSO') THEN DISPONIBLE END )) AS WSO,
MAX(CASE WHEN LINEA IN ('WSO') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WSO,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WTC') THEN DISPONIBLE END )) AS WTC,
MAX(CASE WHEN LINEA IN ('WTC') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WTC,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WLS') THEN DISPONIBLE END )) AS WLS,
MAX(CASE WHEN LINEA IN ('WLS') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WLS,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WLM') THEN DISPONIBLE END )) AS WLM,
MAX(CASE WHEN LINEA IN ('WLM') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WLM,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WXP') THEN DISPONIBLE END )) AS WXP,
MAX(CASE WHEN LINEA IN ('WXP') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WXP,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WUP') THEN DISPONIBLE END )) AS WUP,
MAX(CASE WHEN LINEA IN ('WUP') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WUP,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WCP') THEN DISPONIBLE END )) AS WCP,
MAX(CASE WHEN LINEA IN ('WCP') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WCP,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WBP') THEN DISPONIBLE END )) AS WBP,
MAX(CASE WHEN LINEA IN ('WBP') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WBP,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WSB') THEN DISPONIBLE END )) AS WSB,
MAX(CASE WHEN LINEA IN ('WSB') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WSB,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WLI') THEN DISPONIBLE END )) AS WLI,
MAX(CASE WHEN LINEA IN ('WLI') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WLI,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WHV') THEN DISPONIBLE END )) AS WHV,
MAX(CASE WHEN LINEA IN ('WHV') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WHV,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WFG') THEN DISPONIBLE END )) AS WFG,
MAX(CASE WHEN LINEA IN ('WFG') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WFG,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WLO') THEN DISPONIBLE END )) AS WLO,
MAX(CASE WHEN LINEA IN ('WLO') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WLO,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WFO') THEN DISPONIBLE END )) AS WFO,
MAX(CASE WHEN LINEA IN ('WFO') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WFO,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WDO') THEN DISPONIBLE END )) AS WDO,
MAX(CASE WHEN LINEA IN ('WDO') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WDO,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WMM') THEN DISPONIBLE END )) AS WMM,
MAX(CASE WHEN LINEA IN ('WMM') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WMM,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WSP') THEN DISPONIBLE END )) AS WSP,
MAX(CASE WHEN LINEA IN ('WSP') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WSP,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WBN') THEN DISPONIBLE END )) AS WBN,
MAX(CASE WHEN LINEA IN ('WBN') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WBN,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WPP') THEN DISPONIBLE END )) AS WPP,
MAX(CASE WHEN LINEA IN ('WPP') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WPP,

ZEROIFNULL(MAX(CASE WHEN LINEA IN ('WFB') THEN DISPONIBLE END )) AS WFB,
MAX(CASE WHEN LINEA IN ('WFB') THEN CAST(FECHA_VCTO AS DATE FORMAT 'yyyy-mm-dd') END ) AS VCTO_WFB

FROM MKT_CRM_CMP_TB.TBL_DETALLE_LCG
WHERE FECHA_VCTO>CURRENT_DATE
GROUP BY RUT,NUM_CUENTA;

.IF ERRORCODE <> 0 THEN .QUIT 1;
------------------------------------------------------------------
-------------------- TBL_LCG
------------------------------------------------------------------
SELECT 1 FROM dbc.TablesV WHERE databasename = 'MKT_CRM_CMP_TB' AND TABLENAME = 'TBL_LCG_1';
.IF ACTIVITYCOUNT = 0 THEN GOTO CMP_TRABAJAR
DROP TABLE MKT_CRM_CMP_TB.TBL_LCG_1;
.LABEL CMP_TRABAJAR

--CREATE TABLE 	MKT_CRM_CMP_TB.TBL_LCG_1 AS (
--SELECT current_date (FORMAT 'YYYYMM') (varchar(80)) AS PERIODO
--,B.CLI_RUT RUT
--,A.NUM_CUENTA
--,CAST(A.CUPO_MAXIMO_ASIGNADO AS BIGINT) AS CUPO
--,A.FECHA_APERTURA
--,A.FECHA_VCTO
--,CASE
--WHEN (KT_MN >LBG AND KT_MN>LEM) THEN KT_MN
--WHEN (LBG>KT_MN AND LBG>LEM) THEN LBG
--WHEN (LEM>KT_MN AND LEM>LBG) THEN LEM
--WHEN (KT_MN=LBG AND KT_MN>LEM) THEN KT_MN
--WHEN (KT_MN=LEM AND KT_MN>LBG) THEN KT_MN
--WHEN (LEM=LBG AND LEM>KT_MN) THEN LEM
--END AS DCP
--,KT_MN
--,VCTO_KT_MN
--,LEM
--,VCTO_LEM
--,LBG
--,VCTO_LBG
--,FCT
--,VCTO_FCT
--,LEA
--,VCTO_LEA
--,LME
--,VCTO_LME
--,LSG
--,VCTO_LSG
--,TCR
--,VCTO_TCR
--,BEM
--,VCTO_BEM
--,CCA
--,VCTO_CCA
--,CHIP
--,VCTO_CHIP
--,DER
--,VCTO_DER
--,FUT
--,VCTO_FUT
--,INC
--,VCTO_INC
--,LCB
--,VCTO_LCB
--,LP_MN
--,VCTO_LP_MN
--,MLT
--,VCTO_MLT
--,OPS
--,VCTO_OPS
--,PCT
--,VCTO_PCT
--,SPT
--,VCTO_SPT
--,OTRO_LME
--,VCTO_OTRO_LME
--,OTRO_LP
--,VCTO_OTRO_LP
--,A.CLASE_OPERACION
--,A.CLF_RENOVADA AS LINEA_ANTERIOR
--,A.FECHA_CIERRE
--,A.RAZON_CIERRE
--,A.FECHA_ULTIMA_REVISION
--
--FROM MKT_CRM_CMP_TB.TMP_CLF A
--INNER JOIN EDW_SEMLAY_VW.CLI B ON A.PARTY_ID=B.PARTY_ID
--LEFT JOIN MKT_CRM_CMP_TB.TMP_DISPONIBLE_WSB  C ON B.CLI_RUT=C.RUT AND A.NUM_CUENTA=C.NUM_CUENTA
--) WITH DATA PRIMARY INDEX (RUT,NUM_CUENTA);

CREATE MULTISET TABLE MKT_CRM_CMP_TB.TBL_LCG_1
(
PERIODO VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
,RUT VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
,NUM_CUENTA VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
,CUPO BIGINT
,FECHA_APERTURA DATE FORMAT 'YYYYMM'
,FECHA_VCTO DATE FORMAT 'YYYYMM'
,DCP BIGINT
,KT_MN BIGINT
,VCTO_KT_MN DATE FORMAT 'YYYYMM'
,LEM BIGINT
,VCTO_LEM DATE FORMAT 'YYYYMM'
,LBG BIGINT
,VCTO_LBG DATE FORMAT 'YYYYMM'
,FCT BIGINT
,VCTO_FCT DATE FORMAT 'YYYYMM'
,LEA BIGINT
,VCTO_LEA DATE FORMAT 'YYYYMM'
,LME BIGINT
,VCTO_LME DATE FORMAT 'YYYYMM'
,LSG BIGINT
,VCTO_LSG DATE FORMAT 'YYYYMM'
,TCR BIGINT
,VCTO_TCR DATE FORMAT 'YYYYMM'
,BEM BIGINT
,VCTO_BEM DATE FORMAT 'YYYYMM'
,CCA BIGINT
,VCTO_CCA DATE FORMAT 'YYYYMM'
,CHIP BIGINT
,VCTO_CHIP DATE FORMAT 'YYYYMM'
,DER BIGINT
,VCTO_DER DATE FORMAT 'YYYYMM'
,FUT BIGINT
,VCTO_FUT DATE FORMAT 'YYYYMM'
,INC BIGINT
,VCTO_INC DATE FORMAT 'YYYYMM'
,LCB BIGINT
,VCTO_LCB DATE FORMAT 'YYYYMM'
,LP_MN BIGINT
,VCTO_LP_MN DATE FORMAT 'YYYYMM'
,MLT BIGINT
,VCTO_MLT DATE FORMAT 'YYYYMM'
,OPS BIGINT
,VCTO_OPS DATE FORMAT 'YYYYMM'
,PCT BIGINT
,VCTO_PCT DATE FORMAT 'YYYYMM'
,SPT BIGINT
,VCTO_SPT DATE FORMAT 'YYYYMM'
,OTRO_LME BIGINT
,VCTO_OTRO_LME DATE FORMAT 'YYYYMM'
,OTRO_LP BIGINT
,VCTO_OTRO_LP DATE FORMAT 'YYYYMM'
,CLASE_OPERACION VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
,LINEA_ANTERIOR VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
,FECHA_CIERRE DATE FORMAT 'YYYYMM'
,RAZON_CIERRE VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
,FECHA_ULTIMA_REVISION DATE FORMAT 'YYYYMM'
) PRIMARY INDEX (RUT, NUM_CUENTA);

INSERT INTO MKT_CRM_CMP_TB.TBL_LCG_1
SELECT CURRENT_DATE (FORMAT 'YYYYMM') (VARCHAR(80)) AS PERIODO,
B.CLI_RUT AS RUT,
A.NUM_CUENTA,
CAST(A.CUPO_MAXIMO_ASIGNADO AS BIGINT) AS CUPO,
A.FECHA_APERTURA,
A.FECHA_VCTO,
CASE
WHEN (KT_MN > LBG AND KT_MN > LEM) THEN KT_MN
WHEN (LBG > KT_MN AND LBG > LEM) THEN LBG
WHEN (LEM > KT_MN AND LEM > LBG) THEN LEM
WHEN (KT_MN = LBG AND KT_MN > LEM) THEN KT_MN
WHEN (KT_MN = LEM AND KT_MN > LBG) THEN KT_MN
WHEN (LEM = LBG AND LEM > KT_MN) THEN LEM
END AS DCP,
KT_MN,
VCTO_KT_MN,
LEM,
VCTO_LEM,
LBG,
VCTO_LBG,
FCT,
VCTO_FCT,
LEA,
VCTO_LEA,
LME,
VCTO_LME,
LSG,
VCTO_LSG,
TCR,
VCTO_TCR,
BEM,
VCTO_BEM,
CCA,
VCTO_CCA,
CHIP,
VCTO_CHIP,
DER,
VCTO_DER,
FUT,
VCTO_FUT,
INC,
VCTO_INC,
LCB,
VCTO_LCB,
LP_MN,
VCTO_LP_MN,
MLT,
VCTO_MLT,
OPS,
VCTO_OPS,
PCT,
VCTO_PCT,
SPT,
VCTO_SPT,
OTRO_LME,
VCTO_OTRO_LME,
OTRO_LP,
VCTO_OTRO_LP,
A.CLASE_OPERACION,
A.CLF_RENOVADA AS LINEA_ANTERIOR,
A.FECHA_CIERRE,
A.RAZON_CIERRE,
A.FECHA_ULTIMA_REVISION
FROM MKT_CRM_CMP_TB.TMP_CLF A
INNER JOIN EDW_SEMLAY_VW.CLI B ON A.PARTY_ID = B.PARTY_ID
LEFT JOIN MKT_CRM_CMP_TB.TMP_DISPONIBLE_WSB C ON B.CLI_RUT = C.RUT AND A.NUM_CUENTA = C.NUM_CUENTA;

.IF ERRORCODE <> 0 THEN .QUIT 1;

SELECT 1 FROM dbc.TablesV WHERE databasename = 'MKT_CRM_CMP_TB' AND TABLENAME = 'TBL_LCG_2';
.IF ACTIVITYCOUNT = 0 THEN GOTO CMP_TRABAJAR
DROP TABLE MKT_CRM_CMP_TB.TBL_LCG_2;
.LABEL CMP_TRABAJAR


--CREATE TABLE MKT_CRM_CMP_TB.TBL_LCG_2 AS (
--SELECT current_date (FORMAT 'YYYYMM') (varchar(80)) AS PERIODO
--,B.CLI_RUT RUT
--,A.NUM_CUENTA
--,WXO
--,VCT_WXO
--,WUO
--,VCT_WUO
--,WCO
--,VCT_WCO
--,WBO
--,VCT_WBO
--,WSO
--,VCT_WSO
--,WTC
--,VCT_WTC
--,WLS
--,VCT_WLS
--,WLM
--,VCT_WLM
--,WXP
--,VCT_WXP
--,WUP
--,VCT_WUP
--,WCP
--,VCT_WCP
--,WBP
--,VCT_WBP
--,WSB
--,VCT_WSB
--,WLI
--,VCT_WLI
--,WHV
--,VCT_WHV
--,WFG
--,VCT_WFG
--,WLO
--,VCT_WLO
--,WFO
--,VCT_WFO
--,WDO
--,VCT_WDO
--,WMM
--,VCT_WMM
--,WSP
--,VCT_WSP
--,WBN
--,VCT_WBN
--,WPP
--,VCT_WPP
--,WFB
--,VCT_WFB
--
--
--FROM MKT_CRM_CMP_TB.TMP_CLF A
--INNER JOIN EDW_SEMLAY_VW.CLI B ON A.PARTY_ID=B.PARTY_ID
--LEFT JOIN MKT_CRM_CMP_TB.TMP_DISPONIBLE_WSB  C ON B.CLI_RUT=C.RUT AND A.NUM_CUENTA=C.NUM_CUENTA
--) WITH DATA PRIMARY INDEX (RUT,NUM_CUENTA);

CREATE MULTISET TABLE MKT_CRM_CMP_TB.TBL_LCG_2
(
PERIODO VARCHAR(20) CHARACTER SET LATIN NOT CASESPECIFIC
,RUT VARCHAR(20) CHARACTER SET LATIN NOT CASESPECIFIC
,NUM_CUENTA VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
,WXO BIGINT
,VCT_WXO DATE FORMAT 'YYYYMM'
,WUO BIGINT
,VCT_WUO DATE FORMAT 'YYYYMM'
,WCO BIGINT
,VCT_WCO DATE FORMAT 'YYYYMM'
,WBO BIGINT
,VCT_WBO DATE FORMAT 'YYYYMM'
,WSO BIGINT
,VCT_WSO DATE FORMAT 'YYYYMM'
,WTC BIGINT
,VCT_WTC DATE FORMAT 'YYYYMM'
,WLS BIGINT
,VCT_WLS DATE FORMAT 'YYYYMM'
,WLM BIGINT
,VCT_WLM DATE FORMAT 'YYYYMM'
,WXP BIGINT
,VCT_WXP DATE FORMAT 'YYYYMM'
,WUP BIGINT
,VCT_WUP DATE FORMAT 'YYYYMM'
,WCP BIGINT
,VCT_WCP DATE FORMAT 'YYYYMM'
,WBP BIGINT
,VCT_WBP DATE FORMAT 'YYYYMM'
,WSB BIGINT
,VCT_WSB DATE FORMAT 'YYYYMM'
,WLI BIGINT
,VCT_WLI DATE FORMAT 'YYYYMM'
,WHV BIGINT
,VCT_WHV DATE FORMAT 'YYYYMM'
,WFG BIGINT
,VCT_WFG DATE FORMAT 'YYYYMM'
,WLO BIGINT
,VCT_WLO DATE FORMAT 'YYYYMM'
,WFO BIGINT
,VCT_WFO DATE FORMAT 'YYYYMM'
,WDO BIGINT
,VCT_WDO DATE FORMAT 'YYYYMM'
,WMM BIGINT
,VCT_WMM DATE FORMAT 'YYYYMM'
,WSP BIGINT
,VCT_WSP DATE FORMAT 'YYYYMM'
,WBN BIGINT
,VCT_WBN DATE FORMAT 'YYYYMM'
,WPP BIGINT
,VCT_WPP DATE FORMAT 'YYYYMM'
,WFB BIGINT
,VCT_WFB DATE FORMAT 'YYYYMM'
) PRIMARY INDEX (RUT, NUM_CUENTA);

INSERT INTO MKT_CRM_CMP_TB.TBL_LCG_2
SELECT CURRENT_DATE (FORMAT 'YYYYMM') (VARCHAR(80)) AS PERIODO,
B.CLI_RUT AS RUT,
A.NUM_CUENTA,
WXO,
VCT_WXO,
WUO,
VCT_WUO,
WCO,
VCT_WCO,
WBO,
VCT_WBO,
WSO,
VCT_WSO,
WTC,
VCT_WTC,
WLS,
VCT_WLS,
WLM,
VCT_WLM,
WXP,
VCT_WXP,
WUP,
VCT_WUP,
WCP,
VCT_WCP,
WBP,
VCT_WBP,
WSB,
VCT_WSB,
WLI,
VCT_WLI,
WHV,
VCT_WHV,
WFG,
VCT_WFG,
WLO,
VCT_WLO,
WFO,
VCT_WFO,
WDO,
VCT_WDO,
WMM,
VCT_WMM,
WSP,
VCT_WSP,
WBN,
VCT_WBN,
WPP,
VCT_WPP,
WFB,
VCT_WFB
FROM MKT_CRM_CMP_TB.TMP_CLF A
INNER JOIN EDW_SEMLAY_VW.CLI B ON A.PARTY_ID = B.PARTY_ID
LEFT JOIN MKT_CRM_CMP_TB.TMP_DISPONIBLE_WSB C ON B.CLI_RUT = C.RUT AND A.NUM_CUENTA = C.NUM_CUENTA;

.IF ERRORCODE <> 0 THEN .QUIT 1;

---CREACION NUEVA TABLA LCG----------

SELECT 1 FROM dbc.TablesV WHERE databasename = 'MKT_CRM_CMP_TB' AND TABLENAME = 'TBL_LCG';
.IF ACTIVITYCOUNT = 0 THEN GOTO CMP_TRABAJAR
DROP TABLE MKT_CRM_CMP_TB.TBL_LCG;
.LABEL CMP_TRABAJAR

--create table MKT_CRM_CMP_TB.TBL_LCG AS (
--select 
--				current_date FECHA_PROCESO
--				,a.*
--				, b.WXO
--				, b.VCT_WXO
--				, b.WUO
--				, b.VCT_WUO
--				, b.WCO
--				, b.VCT_WCO
--				, b.WBO
--				, b.VCT_WBO
--				, b.WSO
--				, b.VCT_WSO
--				, b.WTC
--				, b.VCT_WTC
--				, b.WLS
--				, b.VCT_WLS
--				, b.WLM
--				, b.VCT_WLM
--				, b.WXP
--				, b.VCT_WXP
--				, b.WUP
--				, b.VCT_WUP
--				, b.WCP
--				, b.VCT_WCP
--				, b.WBP
--				, b.VCT_WBP
--				, b.WSB
--				, b.VCT_WSB
--				, b.WLI
--				, b.VCT_WLI
--				, b.WHV
--				, b.VCT_WHV
--				, b.WFG
--				, b.VCT_WFG
--				, b.WLO
--				, b.VCT_WLO
--				, b.WFO
--				, b.VCT_WFO
--				, b.WDO
--				, b.VCT_WDO
--				, b.WMM
--				, b.VCT_WMM
--				, b.WSP
--				, b.VCT_WSP
--				, b.WBN
--				, b.VCT_WBN
--				, b.WPP
--				, b.VCT_WPP
--				, b.WFB
--				, b.VCT_WFB
--
--from MKT_CRM_CMP_TB.TBL_LCG_1 as a
--inner join MKT_CRM_CMP_TB.TBL_LCG_2 as b on a.RUT=b.RUT AND a.NUM_CUENTA=b.NUM_CUENTA
--) WITH DATA PRIMARY INDEX (RUT,NUM_CUENTA);

CREATE MULTISET TABLE MKT_CRM_CMP_TB.TBL_LCG
(
FECHA_PROCESO DATE FORMAT 'YYYYMM'
,PERIODO VARCHAR(20) CHARACTER SET LATIN NOT CASESPECIFIC
,RUT VARCHAR(20) CHARACTER SET LATIN NOT CASESPECIFIC
,NUM_CUENTA VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
,CUPO BIGINT
,FECHA_APERTURA DATE FORMAT 'YYYYMM'
,FECHA_VCTO DATE FORMAT 'YYYYMM'
,DCP BIGINT
,KT_MN BIGINT
,VCTO_KT_MN DATE FORMAT 'YYYYMM'
,LEM BIGINT
,VCTO_LEM DATE FORMAT 'YYYYMM'
,LBG BIGINT
,VCTO_LBG DATE FORMAT 'YYYYMM'
,FCT BIGINT
,VCTO_FCT DATE FORMAT 'YYYYMM'
,LEA BIGINT
,VCTO_LEA DATE FORMAT 'YYYYMM'
,LME BIGINT
,VCTO_LME DATE FORMAT 'YYYYMM'
,LSG BIGINT
,VCTO_LSG DATE FORMAT 'YYYYMM'
,TCR BIGINT
,VCTO_TCR DATE FORMAT 'YYYYMM'
,BEM BIGINT
,VCTO_BEM DATE FORMAT 'YYYYMM'
,CCA BIGINT
,VCTO_CCA DATE FORMAT 'YYYYMM'
,CHIP BIGINT
,VCTO_CHIP DATE FORMAT 'YYYYMM'
,DER BIGINT
,VCTO_DER DATE FORMAT 'YYYYMM'
,FUT BIGINT
,VCTO_FUT DATE FORMAT 'YYYYMM'
,INC BIGINT
,VCTO_INC DATE FORMAT 'YYYYMM'
,LCB BIGINT
,VCTO_LCB DATE FORMAT 'YYYYMM'
,LP_MN BIGINT
,VCTO_LP_MN DATE FORMAT 'YYYYMM'
,MLT BIGINT
,VCTO_MLT DATE FORMAT 'YYYYMM'
,OPS BIGINT
,VCTO_OPS DATE FORMAT 'YYYYMM'
,PCT BIGINT
,VCTO_PCT DATE FORMAT 'YYYYMM'
,SPT BIGINT
,VCTO_SPT DATE FORMAT 'YYYYMM'
,OTRO_LME BIGINT
,VCTO_OTRO_LME DATE FORMAT 'YYYYMM'
,OTRO_LP BIGINT
,VCTO_OTRO_LP DATE FORMAT 'YYYYMM'
,CLASE_OPERACION VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
,LINEA_ANTERIOR VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
,FECHA_CIERRE DATE FORMAT 'YYYYMM'
,RAZON_CIERRE VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC
,FECHA_ULTIMA_REVISION DATE FORMAT 'YYYYMM'
,WXO BIGINT
,VCT_WXO DATE FORMAT 'YYYYMM'
,WUO BIGINT
,VCT_WUO DATE FORMAT 'YYYYMM'
,WCO BIGINT
,VCT_WCO DATE FORMAT 'YYYYMM'
,WBO BIGINT
,VCT_WBO DATE FORMAT 'YYYYMM'
,WSO BIGINT
,VCT_WSO DATE FORMAT 'YYYYMM'
,WTC BIGINT
,VCT_WTC DATE FORMAT 'YYYYMM'
,WLS BIGINT
,VCT_WLS DATE FORMAT 'YYYYMM'
,WLM BIGINT
,VCT_WLM DATE FORMAT 'YYYYMM'
,WXP BIGINT
,VCT_WXP DATE FORMAT 'YYYYMM'
,WUP BIGINT
,VCT_WUP DATE FORMAT 'YYYYMM'
,WCP BIGINT
,VCT_WCP DATE FORMAT 'YYYYMM'
,WBP BIGINT
,VCT_WBP DATE FORMAT 'YYYYMM'
,WSB BIGINT
,VCT_WSB DATE FORMAT 'YYYYMM'
,WLI BIGINT
,VCT_WLI DATE FORMAT 'YYYYMM'
,WHV BIGINT
,VCT_WHV DATE FORMAT 'YYYYMM'
,WFG BIGINT
,VCT_WFG DATE FORMAT 'YYYYMM'
,WLO BIGINT
,VCT_WLO DATE FORMAT 'YYYYMM'
,WFO BIGINT
,VCT_WFO DATE FORMAT 'YYYYMM'
,WDO BIGINT
,VCT_WDO DATE FORMAT 'YYYYMM'
,WMM BIGINT
,VCT_WMM DATE FORMAT 'YYYYMM'
,WSP BIGINT
,VCT_WSP DATE FORMAT 'YYYYMM'
,WBN BIGINT
,VCT_WBN DATE FORMAT 'YYYYMM'
,WPP BIGINT
,VCT_WPP DATE FORMAT 'YYYYMM'
,WFB BIGINT
,VCT_WFB DATE FORMAT 'YYYYMM'
) PRIMARY INDEX (RUT, NUM_CUENTA);

INSERT INTO MKT_CRM_CMP_TB.TBL_LCG
SELECT current_date AS FECHA_PROCESO
,a.PERIODO
,a.RUT
,a.NUM_CUENTA
,a.CUPO
,a.FECHA_APERTURA
,a.FECHA_VCTO
,a.DCP
,a.KT_MN
,a.VCTO_KT_MN
,a.LEM
,a.VCTO_LEM
,a.LBG
,a.VCTO_LBG
,a.FCT
,a.VCTO_FCT
,a.LEA
,a.VCTO_LEA
,a.LME
,a.VCTO_LME
,a.LSG
,a.VCTO_LSG
,a.TCR
,a.VCTO_TCR
,a.BEM
,a.VCTO_BEM
,a.CCA
,a.VCTO_CCA
,a.CHIP
,a.VCTO_CHIP
,a.DER
,a.VCTO_DER
,a.FUT
,a.VCTO_FUT
,a.INC
,a.VCTO_INC
,a.LCB
,a.VCTO_LCB
,a.LP_MN
,a.VCTO_LP_MN
,a.MLT
,a.VCTO_MLT
,a.OPS
,a.VCTO_OPS
,a.PCT
,a.VCTO_PCT
,a.SPT
,a.VCTO_SPT
,a.OTRO_LME
,a.VCTO_OTRO_LME
,a.OTRO_LP
,a.VCTO_OTRO_LP
,a.CLASE_OPERACION
,a.LINEA_ANTERIOR
,a.FECHA_CIERRE
,a.RAZON_CIERRE
,a.FECHA_ULTIMA_REVISION
,b.WXO
,b.VCT_WXO
,b.WUO
,b.VCT_WUO
,b.WCO
,b.VCT_WCO
,b.WBO
,b.VCT_WBO
,b.WSO
,b.VCT_WSO
,b.WTC
,b.VCT_WTC
,b.WLS
,b.VCT_WLS
,b.WLM
,b.VCT_WLM
,b.WXP
,b.VCT_WXP
,b.WUP
,b.VCT_WUP
,b.WCP
,b.VCT_WCP
,b.WBP
,b.VCT_WBP
,b.WSB
,b.VCT_WSB
,b.WLI
,b.VCT_WLI
,b.WHV
,b.VCT_WHV
,b.WFG
,b.VCT_WFG
,b.WLO
,b.VCT_WLO
,b.WFO
,b.VCT_WFO
,b.WDO
,b.VCT_WDO
,b.WMM
,b.VCT_WMM
,b.WSP
,b.VCT_WSP
,b.WBN
,b.VCT_WBN
,b.WPP
,b.VCT_WPP
,b.WFB
,b.VCT_WFB
FROM MKT_CRM_CMP_TB.TBL_LCG_1 as a
INNER JOIN MKT_CRM_CMP_TB.TBL_LCG_2 as b ON a.RUT = b.RUT AND a.NUM_CUENTA = b.NUM_CUENTA;

.IF ERRORCODE <> 0 THEN .QUIT 1;

---BORRA TABLAS
--DROP TABLE MKT_CRM_CMP_TB.TMP_CLF;
--DROP TABLE MKT_CRM_CMP_TB.TMP_LDC_CLF;
--DROP TABLE MKT_CRM_CMP_TB.TBL_DETALLE_LCG;
--DROP TABLE MKT_CRM_CMP_TB.TMP_DISPONIBLE_WSB;
--DROP TABLE MKT_CRM_CMP_TB.TBL_LCG_1;
--DROP TABLE MKT_CRM_CMP_TB.TBL_LCG_2;

.QUIT

CREATE_UPDATE - Ejemplo 1 OK.sql

/*****************************************************************************************
******************************************************************************************
** DSCRPCN: CREA TABLA PARA EXTRAER INFORMACION DE CUENTA DIGITAL PYME		  	        **
**                                                    				 				    **
** AUTOR  : VERONICA JOPIA					                                            **
** EMPRESA: DOMINIO BCI                                   				  				**
** FECHA  : 06/2024                                                   				  	**
******************************************************************************************
******************************************************************************************
** MANTNCN:                                                           				    **
** AUTOR  :                                                           				    **
** FECHA  : SSAAMMDD                                                  				    **
******************************************************************************************
**TABLA DE ENTRADA: 													                **
** 					Edw_Vw.BCI_RCO_CLF													**					
** 					Edw_Vw.BCI_LDC_CLF													**					
** 					Edw_Vw.BCI_CLF														**				
** 					Edw_Vw.BCI_DISP_UTI_LDC_CLF											**							
** 					EDW_VW.CURRENCY_TRANSLATION_RATE_HIST								**										
** 					EDW_SEMLAY_VW.CLI 													**					
**TABLA DE SALIDA:                                                                      **
**       {{ var.value.BD_STG_DOMBCI}}.T_JNY_Margenes_Lineas_WSB_TBL_LCG_{{ ds_nodash }} **		
**                 														                **
******************************************************************************************
*****************************************************************************************/
.SET SESSION CHARSET 'UTF8';
SELECT DATE, TIME;

------------------------------------------------------------------
-------------------- CREO LCG  ---------------------------
------------------------------------------------------------------

DROP TABLE {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_CLF;
CREATE MULTISET TABLE {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_CLF 
(
	Pc_Num_Cuenta 					VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC
   	, Pc_Estado 					VARCHAR(1) CHARACTER SET LATIN NOT CASESPECIFIC
    , Pd_Cupo_Maximo_Asignado 		DECIMAL(18,4)
    , Pc_Moneda 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    , Pe_Party_Id 					INTEGER
    , Pc_Clase_Operacion 			VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    , Pc_CLF_Renovada 				VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC
    , Pf_Fecha_Apertura 			DATE FORMAT 'YYYY-MM-DD'
    , Pf_Fecha_Cierre 				DATE FORMAT 'YYYY-MM-DD'
    , Pc_Razon_Cierre 				VARCHAR(1) CHARACTER SET LATIN NOT CASESPECIFIC
    , Pf_Fecha_Vcto 				DATE FORMAT 'YYYY-MM-DD'
    , Pf_Fecha_Ultima_Revision 		DATE FORMAT 'YYYY-MM-DD'
 )
 PRIMARY INDEX (Pc_Num_Cuenta);
 
 .IF ERRORCODE <> 0 THEN .QUIT 1;
 
INSERT INTO {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_CLF 
SELECT 
	CLF.ACCOUNT_NUM 				AS Pc_Num_Cuenta
	, CLF.Acct_Status_Type_Cd		AS Pc_Estado
	, CLF.Credit_Limit_Amt			AS Pd_Cupo_Maximo_Asignado
	, CLF.Currency_Cd				AS Pc_Moneda
	, RCO.Party_Id					AS Pe_Party_Id
	, CLF.Account_Type_Cd			AS Pc_Clase_Operacion
	, CLF.Related_Account_Num		AS Pc_CLF_Renovada
	, CLF.Account_Open_Dt			AS Pf_Fecha_Apertura
	, CLF.Account_Close_Dt			AS Pf_Fecha_Cierre
	, CLF.Acct_Status_Reason_Cd		AS Pc_Razon_Cierre
	, CLF.Margen_Vcto_Dt			AS Pf_Fecha_Vcto
	, CLF.End_Review_Margen_Dt		AS Pf_Fecha_Ultima_Revision
FROM Edw_Vw.BCI_RCO_CLF AS RCO
INNER JOIN  Edw_Vw.BCI_CLF AS CLF 
	ON RCO.ACCOUNT_NUM=CLF.ACCOUNT_NUM
WHERE CLF.Acct_Status_Type_Cd='A'
;

.IF ERRORCODE <> 0 THEN .QUIT 2;

COLLECT STATS INDEX (Pc_Num_Cuenta) ON {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_CLF;

.IF ERRORCODE <> 0 THEN .QUIT 3;

------------------------------------------------------------------
-------------------- CREO DETALLE LCG  -----------
------------------------------------------------------------------

DROP TABLE {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_LDC_CLF;
CREATE MULTISET TABLE {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_LDC_CLF
(
	Pe_Party_Id						INTEGER
	, Pc_Num_Cuenta					VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
	, Pc_Codigo_Linea				VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
	, Pc_Linea						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	, Pd_Cupo_Maximo_Asignado		BIGINT
	, Pc_Moneda						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	, Pe_Cupo_Contratado			BIGINT
	, Pc_Multiple_Garantia			VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	, Pf_Fecha_Inicio				DATE FORMAT 'YYYY-MM-DD'
	, Pf_Fecha_Vcto					DATE FORMAT 'YYYY-MM-DD'
	, Pe_Disponible					BIGINT
	, Pe_Utilizado					BIGINT
)
 PRIMARY INDEX (Pc_Num_Cuenta);

.IF ERRORCODE <> 0 THEN .QUIT 4;

INSERT INTO  {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_LDC_CLF
SELECT 
	CLF.Pe_Party_Id									AS Pe_Party_Id
	, LDC.Account_Num 								AS Pc_Num_Cuenta
	, LDC.Account_Modifier_Num 						AS Pc_Codigo_Linea
	, LDC.Line_Type_Cd 								AS Pc_Linea
	, CAST(LDC.Max_Capacity_Assigned AS BIGINT) 	AS Pd_Cupo_Maximo_Asignado
	, LDC.Currency_Cd 								AS Pc_Moneda
	, CAST(LDC.Capacity_Contracted AS BIGINT)		AS Pe_Cupo_Contratado
	, LDC.Multiple_Indicator_Warranty 				AS Pc_Multiple_Garantia
	, LDC.Account_Open_Dt 							AS Pf_Fecha_Inicio
	, LDC.Contract_Expiration_Dt 					AS Pf_Fecha_Vcto
	, CAST(UTI.Available_Capacity_Amt as BIGINT)  	AS Pe_Disponible
	, CAST(UTI.Used_Capacity_Amt as BIGINT)  		AS Pe_Utilizado
FROM {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_CLF CLF
INNER JOIN Edw_Vw.BCI_LDC_CLF LDC 
	ON CLF.Pc_Num_Cuenta=LDC.ACCOUNT_NUM
LEFT JOIN Edw_Vw.BCI_DISP_UTI_LDC_CLF UTI 
	ON CAST(trim(LDC.Account_Num) as VARCHAR(12)) = CAST(trim(UTI.Account_Num) as VARCHAR(12))
	AND CAST(trim(LDC.Account_Modifier_Num) as VARCHAR(2)) = CAST(trim(UTI.Account_Modifier_Num) as VARCHAR(2))
;

.IF ERRORCODE <> 0 THEN .QUIT 5;

COLLECT STATS INDEX (Pc_Num_Cuenta) ON {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_LDC_CLF;

.IF ERRORCODE <> 0 THEN .QUIT 6;

------------------------------------------------------------------
-------------------- ACTUALIZO EN BASE A Pc_Moneda
------------------------------------------------------------------


DROP TABLE {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_CLF_UPD;
CREATE MULTISET TABLE {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_CLF_UPD 
(
	Pc_Num_Cuenta 					VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC
   	, Pc_Estado 					VARCHAR(1) CHARACTER SET LATIN NOT CASESPECIFIC
    , Pd_Cupo_Maximo_Asignado 		DECIMAL(18,4)
    , Pc_Moneda 					VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    , Pe_Party_Id 					INTEGER
    , Pc_Clase_Operacion 			VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    , Pc_CLF_Renovada 				VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC
    , Pf_Fecha_Apertura 			DATE FORMAT 'YYYY-MM-DD'
    , Pf_Fecha_Cierre 				DATE FORMAT 'YYYY-MM-DD'
    , Pc_Razon_Cierre 				VARCHAR(1) CHARACTER SET LATIN NOT CASESPECIFIC
    , Pf_Fecha_Vcto 				DATE FORMAT 'YYYY-MM-DD'
    , Pf_Fecha_Ultima_Revision 		DATE FORMAT 'YYYY-MM-DD'
 )
 PRIMARY INDEX (Pc_Num_Cuenta);
 
 .IF ERRORCODE <> 0 THEN .QUIT 7;
 
INSERT INTO {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_CLF_UPD
SELECT 
	Pc_Num_Cuenta 					AS Pc_Num_Cuenta
	, Pc_Estado 					AS Pc_Estado
	, CASE 	WHEN Pc_Moneda='0999' THEN Pd_Cupo_Maximo_Asignado
					WHEN Pc_Moneda='0998' AND RAT.Global_Currency_Cd='0998' THEN Pd_Cupo_Maximo_Asignado * CAST(RAT.Global_To_Source_Currency_Rate as bigint) 
					WHEN Pc_Moneda='1013' AND RAT.Global_Currency_Cd='131301' THEN Pd_Cupo_Maximo_Asignado * CAST(RAT.Global_To_Source_Currency_Rate as bigint) 
					WHEN Pc_Moneda='1142' AND RAT.Global_Currency_Cd='114201' THEN Pd_Cupo_Maximo_Asignado * CAST(RAT.Global_To_Source_Currency_Rate as bigint) 
					ELSE 0
	END AS Pd_Cupo_Maximo_Asignado
	, Pc_Moneda 					AS Pc_Moneda
	, Pe_Party_Id 					AS Pe_Party_Id
	, Pc_Clase_Operacion 			AS Pc_Clase_Operacion
	, Pc_CLF_Renovada 				AS Pc_CLF_Renovada
	, Pf_Fecha_Apertura 			AS Pf_Fecha_Apertura
	, Pf_Fecha_Cierre 				AS Pf_Fecha_Cierre
	, Pc_Razon_Cierre 				AS Pc_Razon_Cierre
	, Pf_Fecha_Vcto 				AS Pf_Fecha_Vcto
	, Pf_Fecha_Ultima_Revision		AS Pf_Fecha_Ultima_Revision
FROM {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_CLF AS CLF
CROSS JOIN  EDW_VW.CURRENCY_TRANSLATION_RATE_HIST AS RAT
where RAT.Currency_Trans_Start_Dt = CAST('{{ ds }}' AS DATE)
AND RAT.Source_Currency_Cd = '0999'
AND RAT.Global_Currency_Cd = '0998'
AND RAT.Currency_Rate_Type_Cd = '001'
;

.IF ERRORCODE <> 0 THEN .QUIT 8;

COLLECT STATS INDEX (Pc_Num_Cuenta) ON {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_CLF_UPD;

.IF ERRORCODE <> 0 THEN .QUIT 9;

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


DROP TABLE {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_LDC_CLF_UPD;
CREATE MULTISET TABLE {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_LDC_CLF_UPD
(
	Pe_Party_Id						INTEGER
	, Pc_Num_Cuenta					VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
	, Pc_Codigo_Linea				VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
	, Pc_Linea						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	, Pd_Cupo_Maximo_Asignado		BIGINT
	, Pc_Moneda						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	, Pe_Cupo_Contratado			BIGINT
	, Pc_Multiple_Garantia			VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	, Pf_Fecha_Inicio				DATE FORMAT 'YYYY-MM-DD'
	, Pf_Fecha_Vcto					DATE FORMAT 'YYYY-MM-DD'
	, Pe_Disponible					BIGINT
	, Pe_Utilizado					BIGINT
)
 PRIMARY INDEX (Pc_Num_Cuenta);
 
.IF ERRORCODE <> 0 THEN .QUIT 10;

INSERT INTO {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_LDC_CLF_UPD
SELECT 
	Pe_Party_Id						AS Pe_Party_Id			
	, Pc_Num_Cuenta					AS Pc_Num_Cuenta
	, Pc_Codigo_Linea				AS Pc_Codigo_Linea
	, Pc_Linea						AS Pc_Linea
	, CASE 	WHEN Pc_Moneda='0999' THEN Pd_Cupo_Maximo_Asignado
					WHEN Pc_Moneda='0998' AND RAT.Global_Currency_Cd='0998' THEN Pd_Cupo_Maximo_Asignado * CAST(RAT.Global_To_Source_Currency_Rate as bigint) 
					WHEN Pc_Moneda='1013' AND RAT.Global_Currency_Cd='131301' THEN Pd_Cupo_Maximo_Asignado * CAST(RAT.Global_To_Source_Currency_Rate as bigint) --?
					WHEN Pc_Moneda='1142' AND RAT.Global_Currency_Cd='114201' THEN Pd_Cupo_Maximo_Asignado * CAST(RAT.Global_To_Source_Currency_Rate as bigint) --?
					ELSE 0
	END AS Pd_Cupo_Maximo_Asignado
	, Pc_Moneda						AS Pc_Moneda
	, CASE 	WHEN Pc_Moneda='0999' THEN   Pe_Cupo_Contratado
					WHEN Pc_Moneda='0998' AND RAT.Global_Currency_Cd='0998' THEN Pe_Cupo_Contratado * CAST(RAT.Global_To_Source_Currency_Rate as bigint)
					WHEN Pc_Moneda='1013' AND RAT.Global_Currency_Cd='131301' THEN Pe_Cupo_Contratado * CAST(RAT.Global_To_Source_Currency_Rate as bigint) --?
					WHEN Pc_Moneda='1142' AND RAT.Global_Currency_Cd='114201' THEN Pe_Cupo_Contratado * CAST(RAT.Global_To_Source_Currency_Rate as bigint) --?
      END	AS Pe_Cupo_Contratado
	, Pc_Multiple_Garantia			AS Pc_Multiple_Garantia
	, Pf_Fecha_Inicio				AS Pf_Fecha_Inicio
	, Pf_Fecha_Vcto					AS Pf_Fecha_Vcto
	, Pe_Disponible					AS Pe_Disponible
	, Pe_Utilizado					AS Pe_Utilizado
FROM {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_LDC_CLF AS CLF
CROSS JOIN  EDW_VW.CURRENCY_TRANSLATION_RATE_HIST AS RAT
where RAT.Currency_Trans_Start_Dt =CAST('{{ ds }}' AS DATE)
AND RAT.Source_Currency_Cd = '0999'
AND RAT.Global_Currency_Cd = '0998'
AND RAT.Currency_Rate_Type_Cd = '001'
;

.IF ERRORCODE <> 0 THEN .QUIT 11;

COLLECT STATS INDEX (Pc_Num_Cuenta) ON {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_LDC_CLF_UPD;

.IF ERRORCODE <> 0 THEN .QUIT 12;


DROP TABLE {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_LDC_CLF_UPD_01;
CREATE MULTISET TABLE {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_LDC_CLF_UPD_01
(
	Pe_Party_Id						INTEGER
	, Pc_Num_Cuenta					VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
	, Pc_Codigo_Linea				VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
	, Pc_Linea						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	, Pd_Cupo_Maximo_Asignado		BIGINT
	, Pc_Moneda						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	, Pe_Cupo_Contratado			BIGINT
	, Pc_Multiple_Garantia			VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	, Pf_Fecha_Inicio				DATE FORMAT 'YYYY-MM-DD'
	, Pf_Fecha_Vcto					DATE FORMAT 'YYYY-MM-DD'
	, Pe_Disponible					BIGINT
	, Pe_Utilizado					BIGINT
)
 PRIMARY INDEX (Pc_Num_Cuenta);

.IF ERRORCODE <> 0 THEN .QUIT 13;

INSERT INTO {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_LDC_CLF_UPD_01
SELECT 
	Pe_Party_Id						AS Pe_Party_Id			
	, Pc_Num_Cuenta					AS Pc_Num_Cuenta
	, Pc_Codigo_Linea				AS Pc_Codigo_Linea
	, Pc_Linea						AS Pc_Linea
	, Pd_Cupo_Maximo_Asignado AS Pd_Cupo_Maximo_Asignado
	, Pc_Moneda						AS Pc_Moneda
	 ,Pd_Cupo_Maximo_Asignado	AS Pe_Cupo_Contratado
	, Pc_Multiple_Garantia			AS Pc_Multiple_Garantia
	, Pf_Fecha_Inicio				AS Pf_Fecha_Inicio
	, Pf_Fecha_Vcto					AS Pf_Fecha_Vcto
	, ZEROIFNULL(Pe_Disponible* CAST(RAT.Global_To_Source_Currency_Rate as bigint))					AS Pe_Disponible
	, ZEROIFNULL(Pe_Utilizado* CAST(RAT.Global_To_Source_Currency_Rate as bigint))					AS Pe_Utilizado
FROM {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_LDC_CLF_UPD AS CLF
CROSS JOIN  EDW_VW.CURRENCY_TRANSLATION_RATE_HIST AS RAT
where RAT.Currency_Trans_Start_Dt = CAST('{{ ds }}' AS DATE)
AND RAT.Global_Currency_Cd = '0998'
;

.IF ERRORCODE <> 0 THEN .QUIT 14;

COLLECT STATS INDEX (Pc_Num_Cuenta) ON {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_LDC_CLF_UPD_01;

.IF ERRORCODE <> 0 THEN .QUIT 15;

------------------------------------------------------------------
-------------------- TBL_DETALLE LCG
------------------------------------------------------------------


DROP TABLE {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_Detalle_LCG;
CREATE MULTISET TABLE {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_Detalle_LCG 
(
	Pd_Rut				DECIMAL(8,0)
	, Pc_Num_Cuenta					VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
	, Pc_Codigo_Linea				VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
	, Pc_Linea						VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	, Pd_Cupo_Maximo_Asignado		BIGINT
	, Pe_Cupo_Contratado			BIGINT
	, Pc_Multiple_Garantia			VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	, Pf_Fecha_Inicio				DATE FORMAT 'YYYY-MM-DD'
	, Pf_Fecha_Vcto					DATE FORMAT 'YYYY-MM-DD'
	, Pe_Disponible					BIGINT
	, Pe_Utilizado					BIGINT
)PRIMARY INDEX (Pc_Num_Cuenta,Pc_Codigo_Linea);

.IF ERRORCODE <> 0 THEN .QUIT 16;

INSERT INTO {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_Detalle_LCG 
SELECT 
	CLI.CLI_RUT AS Pd_Rut
	, Pc_Num_Cuenta AS Pc_Num_Cuenta
	, Pc_Codigo_Linea AS Pc_Codigo_Linea
	, Pc_Linea	AS Pc_Linea
	, Pd_Cupo_Maximo_Asignado	AS Pd_Cupo_Maximo_Asignado
	, Pe_Cupo_Contratado 		AS Pe_Cupo_Contratado
	, Pc_Multiple_Garantia			AS Pc_Multiple_Garantia
	, Pf_Fecha_Inicio				AS Pf_Fecha_Inicio
	, Pf_Fecha_Vcto					AS Pf_Fecha_Vcto
	, Pe_Disponible AS Pe_Disponible
	, Pe_Utilizado AS Pe_Utilizado
FROM {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_LDC_CLF_UPD_01 LDC
INNER JOIN EDW_SEMLAY_VW.CLI CLI ON LDC.Pe_Party_Id=CLI.Party_Id
;

.IF ERRORCODE <> 0 THEN .QUIT 17;

COLLECT STATS INDEX (Pc_Num_Cuenta,Pc_Codigo_Linea) ON {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_Detalle_LCG;

.IF ERRORCODE <> 0 THEN .QUIT 18;

------------------------------------------------------------------
--------------------  CALCULO DISPONIBLE CP, LP Y ROTATIVO
------------------------------------------------------------------

DROP TABLE {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_DISPONIBLE_WSB;
CREATE MULTISET TABLE {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_DISPONIBLE_WSB  (
	Pd_Rut DECIMAL(8,0)
	, Pc_num_cuenta VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC
	, Pe_kt_mn BIGINT
	, Pf_vcto_kt_mn DATE FORMAT 'YYYY-MM-DD'
	, Pe_fct BIGINT
	, Pf_vcto_fct DATE FORMAT 'YYYY-MM-DD'
	, Pe_lea BIGINT
	, Pf_vcto_lea DATE FORMAT 'YYYY-MM-DD'
	, Pe_lbg BIGINT
	, Pf_vcto_lbg DATE FORMAT 'YYYY-MM-DD' 
	, Pe_otro_lbg BIGINT
	, Pf_vcto_otro_lbg DATE FORMAT 'YYYY-MM-DD'
	, Pe_lem BIGINT
	, Pf_vcto_lem DATE FORMAT 'YYYY-MM-DD'
	, Pe_lme BIGINT
	, Pf_vcto_lme DATE FORMAT 'YYYY-MM-DD'
	, Pe_lsg BIGINT
	, Pf_vcto_lsg DATE FORMAT 'YYYY-MM-DD'
	, Pe_tcr BIGINT
	, Pf_vcto_tcr DATE FORMAT 'YYYY-MM-DD'
	, Pe_bem BIGINT
	, Pf_vcto_bem DATE FORMAT 'YYYY-MM-DD'
	, Pe_cca BIGINT
	, Pf_vcto_cca DATE FORMAT 'YYYY-MM-DD'
	, Pe_chip BIGINT
	, Pf_vcto_chip DATE FORMAT 'YYYY-MM-DD'
	, Pe_der BIGINT
	, Pf_vcto_der DATE FORMAT 'YYYY-MM-DD'
	, Pe_fut BIGINT
	, Pf_vcto_fut DATE FORMAT 'YYYY-MM-DD'
	, Pe_inc BIGINT
	, Pf_vcto_inc DATE FORMAT 'YYYY-MM-DD'
	, Pe_lcb BIGINT
	, Pf_vcto_lcb DATE FORMAT 'YYYY-MM-DD'
	, Pe_lp_mn BIGINT
	, Pf_vcto_lp_mn DATE FORMAT 'YYYY-MM-DD'
	, Pe_mlt BIGINT
	, Pf_vcto_mlt DATE FORMAT 'YYYY-MM-DD'
	, Pe_ops BIGINT
	, Pf_vcto_ops DATE FORMAT 'YYYY-MM-DD'
	, Pe_otro_lp BIGINT
	, Pf_vcto_otro_lp DATE FORMAT 'YYYY-MM-DD'
	, Pe_pct BIGINT
	, Pf_vcto_pct DATE FORMAT 'YYYY-MM-DD'
	, Pe_spt BIGINT
	, Pf_vcto_spt DATE FORMAT 'YYYY-MM-DD'
	, Pe_otro_lme BIGINT
	, Pf_vcto_otro_lme DATE FORMAT 'YYYY-MM-DD'
	, Pe_wxo BIGINT
	, Pf_vct_wxo DATE FORMAT 'YYYY-MM-DD'
	, Pe_wuo BIGINT
	, Pf_vct_wuo DATE FORMAT 'YYYY-MM-DD'
	, Pe_wco BIGINT
	, Pf_vct_wco DATE FORMAT 'YYYY-MM-DD'
	, Pe_wbo BIGINT
	, Pf_vct_wbo DATE FORMAT 'YYYY-MM-DD'
	, Pe_wso BIGINT
	, Pf_vct_wso DATE FORMAT 'YYYY-MM-DD'
	, Pe_wtc BIGINT
	, Pf_vct_wtc DATE FORMAT 'YYYY-MM-DD'
	, Pe_wls BIGINT
	, Pf_vct_wls DATE FORMAT 'YYYY-MM-DD'
	, Pe_wlm BIGINT
	, Pf_vct_wlm DATE FORMAT 'YYYY-MM-DD'
	, Pe_wxp BIGINT
	, Pf_vct_wxp DATE FORMAT 'YYYY-MM-DD'
	, Pe_wup BIGINT
	, Pf_vct_wup DATE FORMAT 'YYYY-MM-DD'
	, Pe_wcp BIGINT
	, Pf_vct_wcp DATE FORMAT 'YYYY-MM-DD'
	, Pe_wbp BIGINT
	, Pf_vct_wbp DATE FORMAT 'YYYY-MM-DD'
	, Pe_wsb BIGINT
	, Pf_vct_wsb DATE FORMAT 'YYYY-MM-DD'
	, Pe_wli BIGINT
	, Pf_vct_wli DATE FORMAT 'YYYY-MM-DD'
	, Pe_whv BIGINT
	, Pf_vct_whv DATE FORMAT 'YYYY-MM-DD'
	, Pe_wfg BIGINT
	, Pf_vct_wfg DATE FORMAT 'YYYY-MM-DD'
	, Pe_wlo BIGINT
	, Pf_vct_wlo DATE FORMAT 'YYYY-MM-DD'
	, Pe_wfo BIGINT
	, Pf_vct_wfo DATE FORMAT 'YYYY-MM-DD'
	, Pe_wdo BIGINT
	, Pf_vct_wdo DATE FORMAT 'YYYY-MM-DD'
	, Pe_wmm BIGINT
	, Pf_vct_wmm DATE FORMAT 'YYYY-MM-DD'
	, Pe_wsp BIGINT
	, Pf_vct_wsp DATE FORMAT 'YYYY-MM-DD'
	, Pe_wbn BIGINT
	, Pf_vct_wbn DATE FORMAT 'YYYY-MM-DD'
	, Pe_wpp BIGINT
	, Pf_vct_wpp DATE FORMAT 'YYYY-MM-DD'
	, Pe_wfb BIGINT
	, Pf_vct_wfb DATE FORMAT 'YYYY-MM-DD'
)PRIMARY INDEX (Pc_num_cuenta);

.IF ERRORCODE <> 0 THEN .QUIT 19;

INSERT INTO {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_DISPONIBLE_WSB
SELECT 
    Pd_Rut
    , Pc_num_cuenta
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('L01') THEN Pe_Disponible END )) AS Pe_kt_mn
    , MAX(CASE WHEN Pc_Linea IN ('L01') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_kt_mn
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('FCE','FCT','FCF','FPP','L2A','FCI') THEN Pe_Disponible END )) AS Pe_fct
    , MAX(CASE WHEN Pc_Linea IN ('FCE','FCT','FCF','FPP','L2A','FCI') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_fct
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('LEA','LPU','LEI') THEN Pe_Disponible END )) AS Pe_lea
    , MAX(CASE WHEN Pc_Linea IN ('LEA','LPU','LEI') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_lea
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('LBG') THEN Pe_Disponible END )) AS Pe_lbg
    , MAX(CASE WHEN Pc_Linea IN ('LBG') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_lbg
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('LBP') THEN Pe_Disponible END )) AS Pe_otro_lbg
    , MAX(CASE WHEN Pc_Linea IN ('LBP') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_otro_lbg
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('LEP','LEM') THEN Pe_Disponible END )) AS Pe_lem
    , MAX(CASE WHEN Pc_Linea IN ('LEP','LEM') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_lem
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('LME') THEN Pe_Disponible END )) AS Pe_lme
    , MAX(CASE WHEN Pc_Linea IN ('LME') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_lme
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('LSB','LSO','LSE','LSP','BAS') THEN Pe_Disponible END )) AS Pe_lsg
    , MAX(CASE WHEN Pc_Linea IN ('LSB','LSO','LSE','LSP','BAS') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_lsg
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('LTP','LTC','TCP') THEN Pe_Disponible END )) AS Pe_tcr
    , MAX(CASE WHEN Pc_Linea IN ('LTP','LTC','TCP') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_tcr
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('BEM','BCE','YBO','SET') THEN Pe_Disponible END )) AS Pe_bem
    , MAX(CASE WHEN Pc_Linea IN ('BEM','BCE','YBO','SET') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_bem
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('CCA','CRP') THEN Pe_Disponible END )) AS Pe_cca
    , MAX(CASE WHEN Pc_Linea IN ('CCA','CRP') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_cca
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('HFG','LPH','CHP') THEN Pe_Disponible END )) AS Pe_chip
    , MAX(CASE WHEN Pc_Linea IN ('HFG','LPH','CHP') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_chip
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('DCP','DLP','MMD') THEN Pe_Disponible END )) AS Pe_der
    , MAX(CASE WHEN Pc_Linea IN ('DCP','DLP','MMD') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_der
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('LFU') THEN Pe_Disponible END )) AS Pe_fut
    , MAX(CASE WHEN Pc_Linea IN ('LFU') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_fut
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('INC') THEN Pe_Disponible END )) AS Pe_inc
    , MAX(CASE WHEN Pc_Linea IN ('INC') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_inc
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('LCB') THEN Pe_Disponible END )) AS Pe_lcb
    , MAX(CASE WHEN Pc_Linea IN ('LCB') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_lcb
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('L09','BUL') THEN Pe_Disponible END )) AS Pe_lp_mn
    , MAX(CASE WHEN Pc_Linea IN ('L09','BUL') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_lp_mn
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('MLT') THEN Pe_Disponible END )) AS Pe_mlt
    , MAX(CASE WHEN Pc_Linea IN ('MLT') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_mlt
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('OPS') THEN Pe_Disponible END )) AS Pe_ops
    , MAX(CASE WHEN Pc_Linea IN ('OPS') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_ops
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('CPP','PYM','CDP','CPC','LOP','MLI','CRL','LEX') THEN Pe_Disponible END )) AS Pe_otro_lp
    , MAX(CASE WHEN Pc_Linea IN ('CPP','PYM','CDP','CPC','LOP','MLI','CRL','LEX') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_otro_lp
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('LCP') THEN Pe_Disponible END )) AS Pe_pct
    , MAX(CASE WHEN Pc_Linea IN ('LCP') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_pct
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('CHS') THEN Pe_Disponible END )) AS Pe_spt
    , MAX(CASE WHEN Pc_Linea IN ('CHS') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_spt
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('LCX','CRC','FEM','CHC','CCC','CCL') THEN Pe_Disponible END )) AS Pe_otro_lme
    , MAX(CASE WHEN Pc_Linea IN ('LCX','CRC','FEM','CHC','CCC','CCL') THEN Pf_Fecha_Vcto END ) AS Pf_vcto_otro_lme
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WXO') THEN Pe_Disponible END )) AS Pe_wxo
    , MAX(CASE WHEN Pc_Linea IN ('WXO') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wxo
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WUO') THEN Pe_Disponible END )) AS Pe_wuo
    , MAX(CASE WHEN Pc_Linea IN ('WUO') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wuo
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WCO') THEN Pe_Disponible END )) AS Pe_wco
    , MAX(CASE WHEN Pc_Linea IN ('WCO') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wco
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WBO') THEN Pe_Disponible END )) AS Pe_wbo
    , MAX(CASE WHEN Pc_Linea IN ('WBO') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wbo
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WSO') THEN Pe_Disponible END )) AS Pe_wso
    , MAX(CASE WHEN Pc_Linea IN ('WSO') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wso
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WTC') THEN Pe_Disponible END )) AS Pe_wtc
    , MAX(CASE WHEN Pc_Linea IN ('WTC') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wtc
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WLS') THEN Pe_Disponible END )) AS Pe_wls
    , MAX(CASE WHEN Pc_Linea IN ('WLS') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wls
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WLM') THEN Pe_Disponible END )) AS Pe_wlm
    , MAX(CASE WHEN Pc_Linea IN ('WLM') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wlm
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WXP') THEN Pe_Disponible END )) AS Pe_wxp
    , MAX(CASE WHEN Pc_Linea IN ('WXP') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wxp
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WUP') THEN Pe_Disponible END )) AS Pe_wup
    , MAX(CASE WHEN Pc_Linea IN ('WUP') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wup
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WCP') THEN Pe_Disponible END )) AS Pe_wcp
    , MAX(CASE WHEN Pc_Linea IN ('WCP') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wcp
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WBP') THEN Pe_Disponible END )) AS Pe_wbp
    , MAX(CASE WHEN Pc_Linea IN ('WBP') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wbp
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WSB') THEN Pe_Disponible END )) AS Pe_wsb
    , MAX(CASE WHEN Pc_Linea IN ('WSB') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wsb
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WLI') THEN Pe_Disponible END )) AS Pe_wli
    , MAX(CASE WHEN Pc_Linea IN ('WLI') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wli
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WHV') THEN Pe_Disponible END )) AS Pe_whv
    , MAX(CASE WHEN Pc_Linea IN ('WHV') THEN Pf_Fecha_Vcto END ) AS Pf_vct_whv
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WFG') THEN Pe_Disponible END )) AS Pe_wfg
    , MAX(CASE WHEN Pc_Linea IN ('WFG') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wfg
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WLO') THEN Pe_Disponible END )) AS Pe_wlo
    , MAX(CASE WHEN Pc_Linea IN ('WLO') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wlo
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WFO') THEN Pe_Disponible END )) AS Pe_wfo
    , MAX(CASE WHEN Pc_Linea IN ('WFO') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wfo
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WDO') THEN Pe_Disponible END )) AS Pe_wdo
    , MAX(CASE WHEN Pc_Linea IN ('WDO') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wdo
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WMM') THEN Pe_Disponible END )) AS Pe_wmm
    , MAX(CASE WHEN Pc_Linea IN ('WMM') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wmm
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WSP') THEN Pe_Disponible END )) AS Pe_wsp
    , MAX(CASE WHEN Pc_Linea IN ('WSP') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wsp
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WBN') THEN Pe_Disponible END )) AS Pe_wbn
    , MAX(CASE WHEN Pc_Linea IN ('WBN') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wbn
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WPP') THEN Pe_Disponible END )) AS Pe_wpp
    , MAX(CASE WHEN Pc_Linea IN ('WPP') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wpp
    , ZEROIFNULL(MAX(CASE WHEN Pc_Linea IN ('WFB') THEN Pe_Disponible END )) AS Pe_wfb
    , MAX(CASE WHEN Pc_Linea IN ('WFB') THEN Pf_Fecha_Vcto END ) AS Pf_vct_wfb
FROM {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_Detalle_LCG
WHERE Pf_Fecha_Vcto > CAST('{{ ds }}' AS DATE)
GROUP BY Pd_Rut, Pc_num_cuenta;

.IF ERRORCODE <> 0 THEN .QUIT 20;

COLLECT STATS INDEX (Pc_num_cuenta) ON {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_DISPONIBLE_WSB;

.IF ERRORCODE <> 0 THEN .QUIT 21;

------------------------------------------------------------------
-------------------- TBL_LCG
------------------------------------------------------------------
DROP TABLE {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TBL_LCG_1;
CREATE MULTISET TABLE {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TBL_LCG_1 
(
	Pf_Periodo  VARCHAR(6)  CHARACTER SET LATIN NOT CASESPECIFIC
	, Pd_Rut				DECIMAL(8,0)
	, Pc_Num_Cuenta					VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
	, Pd_Cupo 		BIGINT
	, Pf_Fecha_Apertura 			DATE FORMAT 'YYYY-MM-DD'
    , Pf_Fecha_Vcto 				DATE FORMAT 'YYYY-MM-DD'
    , Pe_DCP		 BIGINT
    , Pe_KT_MN		 BIGINT
	, Pf_vcto_kt_mn DATE FORMAT 'YYYY-MM-DD'
	, Pe_lem BIGINT
	, Pf_vcto_lem DATE FORMAT 'YYYY-MM-DD'
	, Pe_lbg BIGINT
	, Pf_vcto_lbg DATE FORMAT 'YYYY-MM-DD'
	, Pe_fct BIGINT
	, Pf_vcto_fct DATE FORMAT 'YYYY-MM-DD'
	, Pe_lea BIGINT
	, Pf_vcto_lea DATE FORMAT 'YYYY-MM-DD'
	, Pe_lme BIGINT
	, Pf_vcto_lme DATE FORMAT 'YYYY-MM-DD'
	, Pe_lsg BIGINT
	, Pf_vcto_lsg DATE FORMAT 'YYYY-MM-DD'
	, Pe_tcr BIGINT
	, Pf_vcto_tcr DATE FORMAT 'YYYY-MM-DD'
	, Pe_bem BIGINT
	, Pf_vcto_bem DATE FORMAT 'YYYY-MM-DD'
	, Pe_cca BIGINT
	, Pf_vcto_cca DATE FORMAT 'YYYY-MM-DD'
	, Pe_chip BIGINT
	, Pf_vcto_chip DATE FORMAT 'YYYY-MM-DD'
	, Pe_der BIGINT
	, Pf_vcto_der DATE FORMAT 'YYYY-MM-DD'
	, Pe_fut BIGINT
	, Pf_vcto_fut DATE FORMAT 'YYYY-MM-DD'
	, Pe_inc BIGINT
	, Pf_vcto_inc DATE FORMAT 'YYYY-MM-DD'
	, Pe_lcb BIGINT
	, Pf_vcto_lcb DATE FORMAT 'YYYY-MM-DD'
	, Pe_lp_mn BIGINT
	, Pf_vcto_lp_mn DATE FORMAT 'YYYY-MM-DD'
	, Pe_mlt BIGINT
	, Pf_vcto_mlt DATE FORMAT 'YYYY-MM-DD'
	, Pe_ops BIGINT
	, Pf_vcto_ops DATE FORMAT 'YYYY-MM-DD'
	, Pe_pct BIGINT
	, Pf_vcto_pct DATE FORMAT 'YYYY-MM-DD'
	, Pe_spt BIGINT
	, Pf_vcto_spt DATE FORMAT 'YYYY-MM-DD'
	, Pe_otro_lme BIGINT
	, Pf_vcto_otro_lme DATE FORMAT 'YYYY-MM-DD'
	, Pe_otro_lp BIGINT
	, Pf_vcto_otro_lp DATE FORMAT 'YYYY-MM-DD'
	, Pc_Clase_Operacion 			VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    , Pc_Linea_Anterior 				VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC
    , Pf_Fecha_Cierre 				DATE FORMAT 'YYYY-MM-DD'
    , Pc_Razon_Cierre 				VARCHAR(1) CHARACTER SET LATIN NOT CASESPECIFIC
    , Pf_Fecha_Ultima_Revision 		DATE FORMAT 'YYYY-MM-DD'
) PRIMARY INDEX (Pd_Rut,Pc_Num_Cuenta);

.IF ERRORCODE <> 0 THEN .QUIT 22;


INSERT INTO {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TBL_LCG_1
SELECT 
CAST(LEFT('{{ds_nodash}}',6) AS DATE FORMAT 'YYYYMM') AS Pf_Periodo
, CLI.CLI_RUT                  AS Pd_Rut
, CLF.Pc_Num_Cuenta                   AS Pc_Num_Cuenta
, CLF.Pd_Cupo_Maximo_Asignado                 AS Pd_Cupo
, CLF.Pf_Fecha_Apertura                   AS Pf_Fecha_Apertura
, CLF.Pf_Fecha_Vcto                   AS Pf_Fecha_Vcto
,CASE
    WHEN (Pe_kt_mn >Pe_lbg AND Pe_kt_mn>Pe_lem) THEN Pe_kt_mn
    WHEN (Pe_lbg>Pe_kt_mn AND Pe_lbg>Pe_lem) THEN Pe_lbg
    WHEN (Pe_lem>Pe_kt_mn AND Pe_lem>Pe_lbg) THEN Pe_lem
    WHEN (Pe_kt_mn=Pe_lbg AND Pe_kt_mn>Pe_lem) THEN Pe_kt_mn
    WHEN (Pe_kt_mn=Pe_lem AND Pe_kt_mn>Pe_lbg) THEN Pe_kt_mn
    WHEN (Pe_lem=Pe_lbg AND Pe_lem>Pe_kt_mn) THEN Pe_lem
END AS Pe_DCP
, Pe_KT_MN                  AS Pe_KT_MN
, Pf_vcto_kt_mn                 AS Pf_vcto_kt_mn
, Pe_lem                    AS Pe_lem
, Pf_vcto_lem                   AS Pf_vcto_lem
, Pe_lbg                    AS Pe_lbg
, Pf_vcto_lbg                   AS Pf_vcto_lbg
, Pe_fct                    AS Pe_fct
, Pf_vcto_fct                   AS Pf_vcto_fct
, Pe_lea                    AS Pe_lea
, Pf_vcto_lea                   AS Pf_vcto_lea
, Pe_lme                    AS Pe_lme
, Pf_vcto_lme                   AS Pf_vcto_lme
, Pe_lsg                    AS Pe_lsg
, Pf_vcto_lsg                   AS Pf_vcto_lsg
, Pe_tcr                    AS Pe_tcr
, Pf_vcto_tcr                   AS Pf_vcto_tcr
, Pe_bem                    AS Pe_bem
, Pf_vcto_bem                   AS Pf_vcto_bem
, Pe_cca                    AS Pe_cca
, Pf_vcto_cca                   AS Pf_vcto_cca
, Pe_chip                   AS Pe_chip
, Pf_vcto_chip                  AS Pf_vcto_chip
, Pe_der                    AS Pe_der
, Pf_vcto_der                   AS Pf_vcto_der
, Pe_fut                    AS Pe_fut
, Pf_vcto_fut                   AS Pf_vcto_fut
, Pe_inc                    AS Pe_inc
, Pf_vcto_inc                   AS Pf_vcto_inc
, Pe_lcb                    AS Pe_lcb
, Pf_vcto_lcb                   AS Pf_vcto_lcb
, Pe_lp_mn                  AS Pe_lp_mn
, Pf_vcto_lp_mn                 AS Pf_vcto_lp_mn
, Pe_mlt                    AS Pe_mlt
, Pf_vcto_mlt                   AS Pf_vcto_mlt
, Pe_ops                    AS Pe_ops
, Pf_vcto_ops                   AS Pf_vcto_ops
, Pe_pct                    AS Pe_pct
, Pf_vcto_pct                   AS Pf_vcto_pct
, Pe_spt                    AS Pe_spt
, Pf_vcto_spt                   AS Pf_vcto_spt
, Pe_otro_lme                   AS Pe_otro_lme
, Pf_vcto_otro_lme                  AS Pf_vcto_otro_lme
, Pe_otro_lp                    AS Pe_otro_lp
, Pf_vcto_otro_lp                   AS Pf_vcto_otro_lp
, CLF.Pc_Clase_Operacion                  AS Pc_Clase_Operacion
, CLF.Pc_CLF_Renovada                     AS Pc_Linea_Anterior
, CLF.Pf_Fecha_Cierre                 AS Pf_Fecha_Cierre
, CLF.Pc_Razon_Cierre                 AS Pc_Razon_Cierre
, CLF.Pf_Fecha_Ultima_Revision                    AS Pf_Fecha_Ultima_Revision
FROM {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_CLF_UPD CLF
INNER JOIN EDW_SEMLAY_VW.CLI CLI ON CLF.Pe_Party_Id=CLI.PARTY_ID
LEFT JOIN {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_DISPONIBLE_WSB  DIS ON CLI.CLI_RUT=DIS.Pd_Rut AND CLF.Pc_Num_Cuenta=DIS.Pc_num_cuenta;

.IF ERRORCODE <> 0 THEN .QUIT 23;

COLLECT STATS INDEX (Pd_Rut,Pc_Num_Cuenta) ON {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TBL_LCG_1;

.IF ERRORCODE <> 0 THEN .QUIT 24;


DROP TABLE {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TBL_LCG_2;
CREATE MULTISET TABLE {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TBL_LCG_2
(
	Pf_Periodo  VARCHAR(6)  CHARACTER SET LATIN NOT CASESPECIFIC
	, Pd_Rut				DECIMAL(8,0)
	, Pc_Num_Cuenta					VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
	, Pe_wxo BIGINT
	, Pf_vct_wxo DATE FORMAT 'YYYY-MM-DD'
	, Pe_wuo BIGINT
	, Pf_vct_wuo DATE FORMAT 'YYYY-MM-DD'
	, Pe_wco BIGINT
	, Pf_vct_wco DATE FORMAT 'YYYY-MM-DD'
	, Pe_wbo BIGINT
	, Pf_vct_wbo DATE FORMAT 'YYYY-MM-DD'
	, Pe_wso BIGINT
	, Pf_vct_wso DATE FORMAT 'YYYY-MM-DD'
	, Pe_wtc BIGINT
	, Pf_vct_wtc DATE FORMAT 'YYYY-MM-DD'
	, Pe_wls BIGINT
	, Pf_vct_wls DATE FORMAT 'YYYY-MM-DD'
	, Pe_wlm BIGINT
	, Pf_vct_wlm DATE FORMAT 'YYYY-MM-DD'
	, Pe_wxp BIGINT
	, Pf_vct_wxp DATE FORMAT 'YYYY-MM-DD'
	, Pe_wup BIGINT
	, Pf_vct_wup DATE FORMAT 'YYYY-MM-DD'
	, Pe_wcp BIGINT
	, Pf_vct_wcp DATE FORMAT 'YYYY-MM-DD'
	, Pe_wbp BIGINT
	, Pf_vct_wbp DATE FORMAT 'YYYY-MM-DD'
	, Pe_wsb BIGINT
	, Pf_vct_wsb DATE FORMAT 'YYYY-MM-DD'
	, Pe_wli BIGINT
	, Pf_vct_wli DATE FORMAT 'YYYY-MM-DD'
	, Pe_whv BIGINT
	, Pf_vct_whv DATE FORMAT 'YYYY-MM-DD'
	, Pe_wfg BIGINT
	, Pf_vct_wfg DATE FORMAT 'YYYY-MM-DD'
	, Pe_wlo BIGINT
	, Pf_vct_wlo DATE FORMAT 'YYYY-MM-DD'
	, Pe_wfo BIGINT
	, Pf_vct_wfo DATE FORMAT 'YYYY-MM-DD'
	, Pe_wdo BIGINT
	, Pf_vct_wdo DATE FORMAT 'YYYY-MM-DD'
	, Pe_wmm BIGINT
	, Pf_vct_wmm DATE FORMAT 'YYYY-MM-DD'
	, Pe_wsp BIGINT
	, Pf_vct_wsp DATE FORMAT 'YYYY-MM-DD'
	, Pe_wbn BIGINT
	, Pf_vct_wbn DATE FORMAT 'YYYY-MM-DD'
	, Pe_wpp BIGINT
	, Pf_vct_wpp DATE FORMAT 'YYYY-MM-DD'
	, Pe_wfb BIGINT
	, Pf_vct_wfb DATE FORMAT 'YYYY-MM-DD'
) PRIMARY INDEX (Pd_Rut,Pc_Num_Cuenta);

.IF ERRORCODE <> 0 THEN .QUIT 25;

INSERT INTO  {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TBL_LCG_2
SELECT
 	CAST(LEFT('{{ds_nodash}}',6) AS DATE FORMAT 'YYYYMM') AS Pf_Periodo
 	, CLI.CLI_RUT                  AS Pd_Rut
	, CLF.Pc_Num_Cuenta                   AS Pc_Num_Cuenta
	, Pe_wxo AS Pe_wxo
	, Pf_vct_wxo AS Pf_vct_wxo
	, Pe_wuo AS Pe_wuo
	, Pf_vct_wuo AS Pf_vct_wuo
	, Pe_wco AS Pe_wco
	, Pf_vct_wco AS Pf_vct_wco
	, Pe_wbo AS Pe_wbo
	, Pf_vct_wbo AS Pf_vct_wbo
	, Pe_wso AS Pe_wso
	, Pf_vct_wso AS Pf_vct_wso
	, Pe_wtc AS Pe_wtc
	, Pf_vct_wtc AS Pf_vct_wtc
	, Pe_wls AS Pe_wls
	, Pf_vct_wls AS Pf_vct_wls
	, Pe_wlm AS Pe_wlm
	, Pf_vct_wlm AS Pf_vct_wlm
	, Pe_wxp AS Pe_wxp
	, Pf_vct_wxp AS Pf_vct_wxp
	, Pe_wup AS Pe_wup
	, Pf_vct_wup AS Pf_vct_wup
	, Pe_wcp AS Pe_wcp
	, Pf_vct_wcp AS Pf_vct_wcp
	, Pe_wbp AS Pe_wbp
	, Pf_vct_wbp AS Pf_vct_wbp
	, Pe_wsb AS Pe_wsb
	, Pf_vct_wsb AS Pf_vct_wsb
	, Pe_wli AS Pe_wli
	, Pf_vct_wli AS Pf_vct_wli
	, Pe_whv AS Pe_whv
	, Pf_vct_whv AS Pf_vct_whv
	, Pe_wfg AS Pe_wfg
	, Pf_vct_wfg AS Pf_vct_wfg
	, Pe_wlo AS Pe_wlo
	, Pf_vct_wlo AS Pf_vct_wlo
	, Pe_wfo AS Pe_wfo
	, Pf_vct_wfo AS Pf_vct_wfo
	, Pe_wdo AS Pe_wdo
	, Pf_vct_wdo AS Pf_vct_wdo
	, Pe_wmm AS Pe_wmm
	, Pf_vct_wmm AS Pf_vct_wmm
	, Pe_wsp AS Pe_wsp
	, Pf_vct_wsp AS Pf_vct_wsp
	, Pe_wbn AS Pe_wbn
	, Pf_vct_wbn AS Pf_vct_wbn
	, Pe_wpp AS Pe_wpp
	, Pf_vct_wpp AS Pf_vct_wpp
	, Pe_wfb AS Pe_wfb
	, Pf_vct_wfb AS Pf_vct_wfb
FROM {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_CLF_UPD CLF
INNER JOIN EDW_SEMLAY_VW.CLI CLI ON CLF.Pe_Party_Id=CLI.PARTY_ID
LEFT JOIN {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TMP_DISPONIBLE_WSB WSB ON CLI.CLI_RUT=WSB.Pd_Rut AND CLF.Pc_Num_Cuenta=WSB.Pc_num_cuenta
;

.IF ERRORCODE <> 0 THEN .QUIT 26;

COLLECT STATS INDEX (Pd_Rut,Pc_Num_Cuenta) ON {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TBL_LCG_2;

.IF ERRORCODE <> 0 THEN .QUIT 27;

/***************************************************************
** SE CREAT TABLA TEMPORAL PARA SER EXPORTADO A ARCHIVO CSV   **  
****************************************************************/
DROP TABLE {{ var.value.BD_STG_DOMBCI}}.T_JNY_Margenes_Lineas_WSB_TBL_LCG;
CREATE MULTISET TABLE {{ var.value.BD_STG_DOMBCI}}.T_JNY_Margenes_Lineas_WSB_TBL_LCG
(
     Tf_Fecha_Proceso 		    DATE FORMAT 'YYYY-MM-DD'
	, Tf_Periodo                VARCHAR(6)  CHARACTER SET LATIN NOT CASESPECIFIC
	, Td_Rut				    DECIMAL(8,0)
	, Tc_Num_Cuenta				VARCHAR(250)  CHARACTER SET LATIN NOT CASESPECIFIC
	, Td_Cupo 		            BIGINT
	, Tf_Fecha_Apertura 		DATE FORMAT 'YYYY-MM-DD'
    , Tf_Fecha_Vcto 			DATE FORMAT 'YYYY-MM-DD'
    , Te_DCP		            BIGINT
    , Te_KT_MN		            BIGINT
	, Tf_vcto_kt_mn             DATE FORMAT 'YYYY-MM-DD'
	, Te_lem                    BIGINT
	, Tf_vcto_lem               DATE FORMAT 'YYYY-MM-DD'
	, Te_lbg                    BIGINT
	, Tf_vcto_lbg               DATE FORMAT 'YYYY-MM-DD'
	, Te_fct                    BIGINT
	, Tf_vcto_fct               DATE FORMAT 'YYYY-MM-DD'
	, Te_lea                    BIGINT
	, Tf_vcto_lea               DATE FORMAT 'YYYY-MM-DD'
	, Te_lme                    BIGINT
	, Tf_vcto_lme               DATE FORMAT 'YYYY-MM-DD'
	, Te_lsg                    BIGINT
	, Tf_vcto_lsg               DATE FORMAT 'YYYY-MM-DD'
	, Te_tcr                    BIGINT
	, Tf_vcto_tcr               DATE FORMAT 'YYYY-MM-DD'
	, Te_bem                    BIGINT
	, Tf_vcto_bem               DATE FORMAT 'YYYY-MM-DD'
	, Te_cca                    BIGINT
	, Tf_vcto_cca               DATE FORMAT 'YYYY-MM-DD'
	, Te_chip                   BIGINT
	, Tf_vcto_chip              DATE FORMAT 'YYYY-MM-DD'
	, Te_der                    BIGINT
	, Tf_vcto_der               DATE FORMAT 'YYYY-MM-DD'
	, Te_fut                    BIGINT
	, Tf_vcto_fut               DATE FORMAT 'YYYY-MM-DD'
	, Te_inc                    BIGINT
	, Tf_vcto_inc               DATE FORMAT 'YYYY-MM-DD'
	, Te_lcb                    BIGINT
	, Tf_vcto_lcb               DATE FORMAT 'YYYY-MM-DD'
	, Te_lp_mn                  BIGINT
	, Tf_vcto_lp_mn             DATE FORMAT 'YYYY-MM-DD'
	, Te_mlt                    BIGINT
	, Tf_vcto_mlt               DATE FORMAT 'YYYY-MM-DD'
	, Te_ops                    BIGINT
	, Tf_vcto_ops               DATE FORMAT 'YYYY-MM-DD'
	, Te_pct                    BIGINT
	, Tf_vcto_pct               DATE FORMAT 'YYYY-MM-DD'
	, Te_spt                    BIGINT
	, Tf_vcto_spt               DATE FORMAT 'YYYY-MM-DD'
	, Te_otro_lme               BIGINT
	, Tf_vcto_otro_lme          DATE FORMAT 'YYYY-MM-DD'
	, Te_otro_lp                BIGINT
	, Tf_vcto_otro_lp           DATE FORMAT 'YYYY-MM-DD'
	, Tc_Clase_Operacion 		VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC
    , Tc_Linea_Anterior 		VARCHAR(18) CHARACTER SET LATIN NOT CASESPECIFIC
    , Tf_Fecha_Cierre 			DATE FORMAT 'YYYY-MM-DD'
    , Tc_Razon_Cierre 			VARCHAR(1) CHARACTER SET LATIN NOT CASESPECIFIC
    , Tf_Fecha_Ultima_Revision 	DATE FORMAT 'YYYY-MM-DD'
    , Te_wxo                    BIGINT
	, Tf_vct_wxo                DATE FORMAT 'YYYY-MM-DD'
	, Te_wuo                    BIGINT
	, Tf_vct_wuo                DATE FORMAT 'YYYY-MM-DD'
	, Te_wco                    BIGINT
	, Tf_vct_wco                DATE FORMAT 'YYYY-MM-DD'
	, Te_wbo                    BIGINT
	, Tf_vct_wbo                DATE FORMAT 'YYYY-MM-DD'
	, Te_wso                    BIGINT
	, Tf_vct_wso                DATE FORMAT 'YYYY-MM-DD'
	, Te_wtc                    BIGINT
	, Tf_vct_wtc                DATE FORMAT 'YYYY-MM-DD'
	, Te_wls                    BIGINT
	, Tf_vct_wls                DATE FORMAT 'YYYY-MM-DD'
	, Te_wlm                    BIGINT
	, Tf_vct_wlm                DATE FORMAT 'YYYY-MM-DD'
	, Te_wxp                    BIGINT
	, Tf_vct_wxp                DATE FORMAT 'YYYY-MM-DD'
	, Te_wup                    BIGINT
	, Tf_vct_wup                DATE FORMAT 'YYYY-MM-DD'
	, Te_wcp                    BIGINT
	, Tf_vct_wcp                DATE FORMAT 'YYYY-MM-DD'
	, Te_wbp                    BIGINT
	, Tf_vct_wbp                DATE FORMAT 'YYYY-MM-DD'
	, Te_wsb                    BIGINT
	, Tf_vct_wsb                DATE FORMAT 'YYYY-MM-DD'
	, Te_wli                    BIGINT
	, Tf_vct_wli                DATE FORMAT 'YYYY-MM-DD'
	, Te_whv                    BIGINT
	, Tf_vct_whv                DATE FORMAT 'YYYY-MM-DD'
	, Te_wfg                    BIGINT
	, Tf_vct_wfg                DATE FORMAT 'YYYY-MM-DD'
	, Te_wlo                    BIGINT
	, Tf_vct_wlo                DATE FORMAT 'YYYY-MM-DD'
	, Te_wfo                    BIGINT
	, Tf_vct_wfo                DATE FORMAT 'YYYY-MM-DD'
	, Te_wdo                    BIGINT
	, Tf_vct_wdo                DATE FORMAT 'YYYY-MM-DD'
	, Te_wmm                    BIGINT
	, Tf_vct_wmm                DATE FORMAT 'YYYY-MM-DD'
	, Te_wsp                    BIGINT
	, Tf_vct_wsp                DATE FORMAT 'YYYY-MM-DD'
	, Te_wbn                    BIGINT
	, Tf_vct_wbn                DATE FORMAT 'YYYY-MM-DD'
	, Te_wpp                    BIGINT
	, Tf_vct_wpp                DATE FORMAT 'YYYY-MM-DD'
	, Te_wfb                    BIGINT
	, Tf_vct_wfb                DATE FORMAT 'YYYY-MM-DD'
) PRIMARY INDEX (Td_Rut,Tc_Num_Cuenta);

.IF ERRORCODE <> 0 THEN .QUIT 28;

INSERT INTO {{ var.value.BD_STG_DOMBCI}}.T_JNY_Margenes_Lineas_WSB_TBL_LCG
SELECT
	CAST(LEFT('{{ds_nodash}}',6) AS DATE FORMAT 'YYYYMM')	AS Tf_Fecha_Proceso
	, LCG1.Pf_Periodo						AS Tf_Periodo
	, LCG1.Pd_Rut							AS Td_Rut
	, LCG1.Pc_Num_Cuenta					AS Tc_Num_Cuenta
	, LCG1.Pd_Cupo							AS Td_Cupo
	, LCG1.Pf_Fecha_Apertura				AS Tf_Fecha_Apertura
	, LCG1.Pf_Fecha_Vcto					AS Tf_Fecha_Vcto
	, LCG1.Pe_DCP							AS Te_DCP
	, LCG1.Pe_KT_MN							AS Te_KT_MN
	, LCG1.Pf_vcto_kt_mn					AS Tf_vcto_kt_mn
	, LCG1.Pe_lem							AS Te_lem
	, LCG1.Pf_vcto_lem						AS Tf_vcto_lem
	, LCG1.Pe_lbg							AS Te_lbg
	, LCG1.Pf_vcto_lbg						AS Tf_vcto_lbg
	, LCG1.Pe_fct							AS Te_fct
	, LCG1.Pf_vcto_fct						AS Tf_vcto_fct
	, LCG1.Pe_lea							AS Te_lea
	, LCG1.Pf_vcto_lea						AS Tf_vcto_lea
	, LCG1.Pe_lme							AS Te_lme
	, LCG1.Pf_vcto_lme						AS Tf_vcto_lme
	, LCG1.Pe_lsg							AS Te_lsg
	, LCG1.Pf_vcto_lsg						AS Tf_vcto_lsg
	, LCG1.Pe_tcr							AS Te_tcr
	, LCG1.Pf_vcto_tcr						AS Tf_vcto_tcr
	, LCG1.Pe_bem							AS Te_bem
	, LCG1.Pf_vcto_bem						AS Tf_vcto_bem
	, LCG1.Pe_cca							AS Te_cca
	, LCG1.Pf_vcto_cca						AS Tf_vcto_cca
	, LCG1.Pe_chip							AS Te_chip
	, LCG1.Pf_vcto_chip						AS Tf_vcto_chip
	, LCG1.Pe_der							AS Te_der
	, LCG1.Pf_vcto_der						AS Tf_vcto_der
	, LCG1.Pe_fut							AS Te_fut
	, LCG1.Pf_vcto_fut						AS Tf_vcto_fut
	, LCG1.Pe_inc							AS Te_inc
	, LCG1.Pf_vcto_inc						AS Tf_vcto_inc
	, LCG1.Pe_lcb							AS Te_lcb
	, LCG1.Pf_vcto_lcb						AS Tf_vcto_lcb
	, LCG1.Pe_lp_mn							AS Te_lp_mn
	, LCG1.Pf_vcto_lp_mn					AS Tf_vcto_lp_mn
	, LCG1.Pe_mlt							AS Te_mlt
	, LCG1.Pf_vcto_mlt						AS Tf_vcto_mlt
	, LCG1.Pe_ops							AS Te_ops
	, LCG1.Pf_vcto_ops						AS Tf_vcto_ops
	, LCG1.Pe_pct							AS Te_pct
	, LCG1.Pf_vcto_pct						AS Tf_vcto_pct
	, LCG1.Pe_spt							AS Te_spt
	, LCG1.Pf_vcto_spt						AS Tf_vcto_spt
	, LCG1.Pe_otro_lme						AS Te_otro_lme
	, LCG1.Pf_vcto_otro_lme					AS Tf_vcto_otro_lme
	, LCG1.Pe_otro_lp						AS Te_otro_lp
	, LCG1.Pf_vcto_otro_lp					AS Tf_vcto_otro_lp
	, LCG1.Pc_Clase_Operacion				AS Tc_Clase_Operacion
	, LCG1.Pc_Linea_Anterior				AS Tc_Linea_Anterior
	, LCG1.Pf_Fecha_Cierre					AS Tf_Fecha_Cierre
	, LCG1.Pc_Razon_Cierre					AS Tc_Razon_Cierre
	, LCG1.Pf_Fecha_Ultima_Revision			AS Tf_Fecha_Ultima_Revision
	, LCG2.Pe_wxo							AS Te_wxo
	, LCG2.Pf_vct_wxo						AS Tf_vct_wxo
	, LCG2.Pe_wuo							AS Te_wuo
	, LCG2.Pf_vct_wuo						AS Tf_vct_wuo
	, LCG2.Pe_wco							AS Te_wco
	, LCG2.Pf_vct_wco						AS Tf_vct_wco
	, LCG2.Pe_wbo							AS Te_wbo
	, LCG2.Pf_vct_wbo						AS Tf_vct_wbo
	, LCG2.Pe_wso							AS Te_wso
	, LCG2.Pf_vct_wso						AS Tf_vct_wso
	, LCG2.Pe_wtc							AS Te_wtc
	, LCG2.Pf_vct_wtc						AS Tf_vct_wtc
	, LCG2.Pe_wls							AS Te_wls
	, LCG2.Pf_vct_wls						AS Tf_vct_wls
	, LCG2.Pe_wlm							AS Te_wlm
	, LCG2.Pf_vct_wlm						AS Tf_vct_wlm
	, LCG2.Pe_wxp							AS Te_wxp
	, LCG2.Pf_vct_wxp						AS Tf_vct_wxp
	, LCG2.Pe_wup							AS Te_wup
	, LCG2.Pf_vct_wup						AS Tf_vct_wup
	, LCG2.Pe_wcp							AS Te_wcp
	, LCG2.Pf_vct_wcp						AS Tf_vct_wcp
	, LCG2.Pe_wbp							AS Te_wbp
	, LCG2.Pf_vct_wbp						AS Tf_vct_wbp
	, LCG2.Pe_wsb							AS Te_wsb
	, LCG2.Pf_vct_wsb						AS Tf_vct_wsb
	, LCG2.Pe_wli							AS Te_wli
	, LCG2.Pf_vct_wli						AS Tf_vct_wli
	, LCG2.Pe_whv							AS Te_whv
	, LCG2.Pf_vct_whv						AS Tf_vct_whv
	, LCG2.Pe_wfg							AS Te_wfg
	, LCG2.Pf_vct_wfg						AS Tf_vct_wfg
	, LCG2.Pe_wlo							AS Te_wlo
	, LCG2.Pf_vct_wlo						AS Tf_vct_wlo
	, LCG2.Pe_wfo							AS Te_wfo
	, LCG2.Pf_vct_wfo						AS Tf_vct_wfo
	, LCG2.Pe_wdo							AS Te_wdo
	, LCG2.Pf_vct_wdo						AS Tf_vct_wdo
	, LCG2.Pe_wmm							AS Te_wmm
	, LCG2.Pf_vct_wmm						AS Tf_vct_wmm
	, LCG2.Pe_wsp							AS Te_wsp
	, LCG2.Pf_vct_wsp						AS Tf_vct_wsp
	, LCG2.Pe_wbn							AS Te_wbn
	, LCG2.Pf_vct_wbn						AS Tf_vct_wbn
	, LCG2.Pe_wpp							AS Te_wpp
	, LCG2.Pf_vct_wpp						AS Tf_vct_wpp
	, LCG2.Pe_wfb							AS Te_wfb
	, LCG2.Pf_vct_wfb						AS Tf_vct_wfb
FROM {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TBL_LCG_1 as LCG1
INNER JOIN {{ var.value.BD_STG_DOMBCI}}.P_JNY_Margenes_Lineas_WSB_TBL_LCG_2 as LCG2 on LCG1.Pd_Rut=LCG2.Pd_Rut AND LCG1.Pc_Num_Cuenta=LCG2.Pc_Num_Cuenta
;

.IF ERRORCODE <> 0 THEN .QUIT 29;

COLLECT STATS INDEX (Td_Rut,Tc_Num_Cuenta) ON {{ var.value.BD_STG_DOMBCI}}.T_JNY_Margenes_Lineas_WSB_TBL_LCG;

.IF ERRORCODE <> 0 THEN .QUIT 30;


SELECT DATE, TIME;
.LOGOFF;
.QUIT 0;



